<!DOCTYPE html>
<html lang="es" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Especificación de cifrado ECIES-X25519-AEAD-Ratchet (mecanismo de trinquete criptográfico) | I2P - El Proyecto Internet Invisible</title>

    <meta name="description" content="Esquema de cifrado integrado de curva elíptica para I2P (X25519 &#43; AEAD)">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="Especificación de cifrado ECIES-X25519-AEAD-Ratchet (mecanismo de trinquete criptográfico) | I2P - El Proyecto Internet Invisible">
    <meta property="og:description" content="Esquema de cifrado integrado de curva elíptica para I2P (X25519 &#43; AEAD)">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/es/docs/specs/ecies/">

    
    <link rel="icon" type="image/svg+xml" href="../../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">Sitio Beta I2P Ahora Activo - Reportar problemas por correo a stormycloud@mail.i2p</span>
            
        </div>
        
        <form method="GET" action="../../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="Cerrar banner" title="Cerrar banner">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../../es/" class="logo-link">
                    <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../../es/about/" class="">Acerca de</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../es/about/">Resumen</a></li>
                            <li><a href="../../../../es/papers/">Artículos de Investigación</a></li>
                            <li><a href="../../../../es/about/media/">Prensa</a></li>
                            <li><a href="../../../../es/contact/">Contáctanos</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../../es/docs/" class="active">Documentos</a></li>
                    <li><a href="../../../../es/downloads/" class="">Descargas</a></li>
                    <li><a href="../../../../es/blog/" class="">Blog</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../../es/get-involved/" class="">Participa</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../es/get-involved/">Resumen</a></li>
                            <li><a href="../../../../es/feedback/">Sugerencias de Funciones</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">es</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../en/docs/specs/ecies/"
                                class="lang-option">Inglés</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../es/docs/specs/ecies/"
                                class="lang-option active">Español</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ko/docs/specs/ecies/"
                                class="lang-option">Coreano</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../zh/docs/specs/ecies/"
                                class="lang-option">Chino</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ru/docs/specs/ecies/"
                                class="lang-option">Ruso</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../cs/docs/specs/ecies/"
                                class="lang-option">Checo</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../de/docs/specs/ecies/"
                                class="lang-option">Alemán</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../fr/docs/specs/ecies/"
                                class="lang-option">Francés</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../tr/docs/specs/ecies/"
                                class="lang-option">Turco</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../vi/docs/specs/ecies/"
                                class="lang-option">Vietnamita</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../hi/docs/specs/ecies/"
                                class="lang-option">Hindi</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ar/docs/specs/ecies/"
                                class="lang-option">Árabe</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../pt/docs/specs/ecies/"
                                class="lang-option">Portugués</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../../es/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../../es/downloads/" class="btn btn-primary">Obtener I2P</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        




<div class="docs-page">
    <div class="container">
        
        <div class="docs-layout docs-layout--with-toc">
            
            
            <aside class="docs-toc-sidebar">
                <nav class="toc-nav">
                    <div class="toc-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        On This Page
                    </div>
                    <div class="toc-content">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#descripción-general">Descripción general</a>
      <ul>
        <li><a href="#propósito">Propósito</a></li>
        <li><a href="#mejoras-principales-con-respecto-a-elgamalaessessiontags">Mejoras principales con respecto a ElGamal/AES+SessionTags</a></li>
        <li><a href="#estado-de-despliegue">Estado de despliegue</a></li>
        <li><a href="#estado-de-la-implementación">Estado de la implementación</a></li>
      </ul>
    </li>
    <li><a href="#fundamentos-del-protocolo">Fundamentos del protocolo</a>
      <ul>
        <li><a href="#marco-del-protocolo-noise">Marco del protocolo Noise</a></li>
        <li><a href="#identificador-del-protocolo-noise">Identificador del protocolo Noise</a></li>
        <li><a href="#patrón-de-negociación-de-noise">Patrón de negociación de Noise</a></li>
        <li><a href="#propiedades-de-seguridad-de-noise">Propiedades de seguridad de Noise</a></li>
        <li><a href="#diferencias-entre-ik-y-xk">Diferencias entre IK y XK</a></li>
        <li><a href="#conceptos-del-signal-double-ratchet-algoritmo-de-doble-trinquete">Conceptos del Signal Double Ratchet (algoritmo de doble trinquete)</a></li>
        <li><a href="#extensiones-de-i2p-para-noise-marco-de-protocolos-criptográficos">Extensiones de I2P para Noise (marco de protocolos criptográficos)</a></li>
      </ul>
    </li>
    <li><a href="#primitivas-criptográficas">Primitivas criptográficas</a>
      <ul>
        <li><a href="#x25519-diffie-hellman">X25519 Diffie-Hellman</a></li>
        <li><a href="#x25519-generate_private">X25519 GENERATE_PRIVATE()</a></li>
        <li><a href="#x25519-derive_publicprivkey">X25519 DERIVE_PUBLIC(privkey)</a></li>
        <li><a href="#x25519-dhprivkey-pubkey">X25519 DH(privkey, pubkey)</a></li>
        <li><a href="#chacha20-poly1305-aead-cifrado-autenticado-con-datos-asociados">ChaCha20-Poly1305 AEAD (cifrado autenticado con datos asociados)</a></li>
        <li><a href="#chacha20-poly1305-encryptk-n-plaintext-ad">ChaCha20-Poly1305 ENCRYPT(k, n, plaintext, ad)</a></li>
        <li><a href="#chacha20-poly1305-descifrark-n-ciphertext-ad">ChaCha20-Poly1305 DESCIFRAR(k, n, ciphertext, ad)</a></li>
        <li><a href="#función-hash-sha-256">Función hash SHA-256</a></li>
        <li><a href="#sha-256-hp-d">SHA-256 H(p, d)</a></li>
        <li><a href="#sha-256-mixhashd-función-de-mezcla-de-hash">SHA-256 MixHash(d) (función de mezcla de hash)</a></li>
        <li><a href="#derivación-de-claves-con-hkdf">Derivación de claves con HKDF</a></li>
        <li><a href="#codificación-elligator2-método-criptográfico-para-representar-claves-públicas-como-datos-indistinguibles-de-datos-aleatorios">Codificación Elligator2 (método criptográfico para representar claves públicas como datos indistinguibles de datos aleatorios)</a></li>
        <li><a href="#elligator2-generate_private_elg2">Elligator2 GENERATE_PRIVATE_ELG2()</a></li>
        <li><a href="#elligator2-encode_elg2pubkey">Elligator2 ENCODE_ELG2(pubkey)</a></li>
        <li><a href="#elligator2-decode_elg2encodedkey">Elligator2 DECODE_ELG2(encodedKey)</a></li>
      </ul>
    </li>
    <li><a href="#formatos-de-mensajes">Formatos de mensajes</a>
      <ul>
        <li><a href="#descripción-general-1">Descripción general</a></li>
        <li><a href="#contenedor-de-mensajes-garlic-de-i2np">Contenedor de mensajes Garlic de I2NP</a></li>
        <li><a href="#mensaje-de-nueva-sesión-ns">Mensaje de Nueva Sesión (NS)</a></li>
        <li><a href="#mensaje-ns-con-vinculación-tipo-1b">Mensaje NS con vinculación (Tipo 1b)</a></li>
        <li><a href="#ns-message-mensaje-ns-sin-vinculación-tipo-1c">NS Message (mensaje NS) sin vinculación (Tipo 1c)</a></li>
        <li><a href="#ns-mensaje-de-un-solo-uso-tipo-1d">NS Mensaje de un solo uso (Tipo 1d)</a></li>
        <li><a href="#mensaje-de-respuesta-de-nueva-sesión-nsr">Mensaje de respuesta de nueva sesión (NSR)</a></li>
        <li><a href="#mensaje-de-sesión-existente-es">Mensaje de Sesión Existente (ES)</a></li>
      </ul>
    </li>
    <li><a href="#funciones-de-derivación-de-claves">Funciones de derivación de claves</a>
      <ul>
        <li><a href="#notación-y-constantes">Notación y constantes</a></li>
        <li><a href="#funciones-de-derivación-de-claves-para-mensajes-ns">Funciones de derivación de claves para mensajes NS</a></li>
        <li><a href="#kdf-1-clave-de-cadena-inicial">KDF 1: Clave de cadena inicial</a></li>
        <li><a href="#kdf-2-función-de-derivación-de-claves-mezcla-de-clave-estática-de-bob">KDF 2 (función de derivación de claves): Mezcla de clave estática de Bob</a></li>
        <li><a href="#kdf-3-generación-de-clave-efímera-de-alice">KDF 3: Generación de clave efímera de Alice</a></li>
        <li><a href="#kdf-4-sección-de-clave-estática-de-ns-es-dh">KDF 4: Sección de clave estática de NS (es DH)</a></li>
        <li><a href="#kdf-5-sección-de-carga-útil-de-ns-ss-dh-solo-vinculada">KDF 5: Sección de carga útil de NS (ss DH, solo vinculada)</a></li>
        <li><a href="#nsr-reply-tagset-kdf-función-de-derivación-de-claves-del-conjunto-de-etiquetas-de-respuesta-de-nsr">NSR Reply Tagset KDF (función de derivación de claves del conjunto de etiquetas de respuesta de NSR)</a></li>
        <li><a href="#funciones-de-derivación-de-claves-del-mensaje-nsr">Funciones de derivación de claves del mensaje NSR</a></li>
        <li><a href="#kdf-6-generación-de-claves-efímeras-de-nsr">KDF 6: Generación de claves efímeras de NSR</a></li>
        <li><a href="#kdf-7-sección-de-claves-de-nsr-ee-efímero-efímero-y-se-estático-efímero-dh">KDF 7: Sección de claves de NSR (ee (efímero-efímero) y se (estático-efímero) DH)</a></li>
        <li><a href="#kdf-8-sección-de-carga-útil-de-nsr">KDF 8: Sección de carga útil de NSR</a></li>
        <li><a href="#kdfs-de-mensajes-de-es">KDFs de mensajes de ES</a></li>
        <li><a href="#función-dh_initialize">Función DH_INITIALIZE</a></li>
      </ul>
    </li>
    <li><a href="#mecanismos-de-trinquete">Mecanismos de trinquete</a>
      <ul>
        <li><a href="#descripción-general-de-ratchet-mecanismo-de-trinquete">Descripción general de Ratchet (mecanismo de trinquete)</a></li>
        <li><a href="#dh-ratchet-mecanismo-de-avance-de-claves-diffie-hellman">DH Ratchet (mecanismo de avance de claves Diffie-Hellman)</a></li>
        <li><a href="#frecuencia-del-dh-ratchet-mecanismo-de-trinquete-diffiehellman">Frecuencia del DH Ratchet (mecanismo de trinquete Diffie‑Hellman)</a></li>
        <li><a href="#identificadores-de-etiquetas-y-de-claves-del-dh-ratchet-mecanismo-de-avance-diffie-hellman">Identificadores de etiquetas y de claves del DH Ratchet (mecanismo de avance Diffie-Hellman)</a></li>
        <li><a href="#flujo-de-mensajes-de-dh-ratchet-mecanismo-de-avance-criptográfico-diffie-hellman">Flujo de mensajes de DH Ratchet (mecanismo de avance criptográfico Diffie-Hellman)</a></li>
        <li><a href="#formato-del-bloque-nextkey-siguiente-clave">Formato del bloque NextKey (siguiente clave)</a></li>
        <li><a href="#kdf-función-de-derivación-de-claves-del-dh-ratchet-mecanismo-de-trinquete">KDF (función de derivación de claves) del DH Ratchet (mecanismo de trinquete)</a></li>
        <li><a href="#gestión-del-estado-de-dh-ratchet-mecanismo-de-avance-de-diffie-hellman">Gestión del estado de DH Ratchet (mecanismo de avance de Diffie-Hellman)</a></li>
        <li><a href="#ratchet-de-etiquetas-de-sesión-mecanismo-de-avance-criptográfico">Ratchet de etiquetas de sesión (mecanismo de avance criptográfico)</a></li>
        <li><a href="#propósito-del-session-tag-ratchet-mecanismo-de-avance-criptográfico-para-etiquetas-de-sesión">Propósito del Session Tag Ratchet (mecanismo de avance criptográfico para etiquetas de sesión)</a></li>
        <li><a href="#fórmula-del-ratchet-mecanismo-de-avance-tipo-trinquete-de-etiquetas-de-sesión">Fórmula del ratchet (mecanismo de avance tipo trinquete) de etiquetas de sesión</a></li>
        <li><a href="#implementación-del-emisor-de-session-tag-ratchet-mecanismo-de-avance-criptográfico-de-etiquetas-de-sesión">Implementación del emisor de Session Tag Ratchet (mecanismo de avance criptográfico de etiquetas de sesión)</a></li>
        <li><a href="#implementación-del-receptor-de-session-tag-ratchet">Implementación del receptor de Session Tag Ratchet</a></li>
        <li><a href="#estrategia-de-anticipación-de-etiquetas-de-sesión">Estrategia de anticipación de etiquetas de sesión</a></li>
        <li><a href="#manejo-de-etiquetas-de-sesión-fuera-de-orden">Manejo de etiquetas de sesión fuera de orden</a></li>
        <li><a href="#ratchet-de-clave-simétrica-mecanismo-de-rotación-progresiva-de-claves-simétricas">Ratchet de clave simétrica (mecanismo de rotación progresiva de claves simétricas)</a></li>
        <li><a href="#propósito-del-symmetric-key-ratchet-mecanismo-de-avance-de-clave-simétrica">Propósito del Symmetric Key Ratchet (mecanismo de avance de clave simétrica)</a></li>
        <li><a href="#fórmula-del-symmetric-key-ratchet-mecanismo-de-trinquete-de-clave-simétrica">Fórmula del Symmetric Key Ratchet (mecanismo de trinquete de clave simétrica)</a></li>
        <li><a href="#implementación-del-emisor-de-symmetric-key-ratchet-trinquete-de-clave-simétrica">Implementación del emisor de Symmetric Key Ratchet (trinquete de clave simétrica)</a></li>
        <li><a href="#implementación-del-receptor-del-symmetric-key-ratchet-mecanismo-de-avance-de-clave-simétrica">Implementación del receptor del Symmetric Key Ratchet (mecanismo de avance de clave simétrica)</a></li>
        <li><a href="#sincronización-del-ratchet-mecanismo-de-avance-criptográfico-simétrico-con-etiquetas-de-sesión">Sincronización del Ratchet (mecanismo de avance criptográfico) simétrico con etiquetas de sesión</a></li>
        <li><a href="#construcción-del-nonce-del-trinquete-simétrico">Construcción del nonce del trinquete simétrico</a></li>
      </ul>
    </li>
    <li><a href="#gestión-de-sesiones">Gestión de sesiones</a>
      <ul>
        <li><a href="#contexto-de-sesión">Contexto de sesión</a></li>
        <li><a href="#vinculación-de-sesión">Vinculación de sesión</a></li>
        <li><a href="#sesiones-vinculadas">Sesiones vinculadas</a></li>
        <li><a href="#sesiones-no-vinculadas">Sesiones no vinculadas</a></li>
        <li><a href="#emparejamiento-de-sesiones">Emparejamiento de sesiones</a></li>
        <li><a href="#creación-de-sesiones-emparejadas">Creación de sesiones emparejadas</a></li>
        <li><a href="#beneficios-del-emparejamiento-de-sesiones">Beneficios del emparejamiento de sesiones</a></li>
        <li><a href="#reglas-de-emparejamiento-de-sesiones">Reglas de emparejamiento de sesiones</a></li>
        <li><a href="#ciclo-de-vida-de-la-sesión">Ciclo de vida de la sesión</a></li>
        <li><a href="#ciclo-de-vida-de-la-sesión-fase-de-creación">Ciclo de vida de la sesión: fase de creación</a></li>
        <li><a href="#ciclo-de-vida-de-la-sesión-fase-activa">Ciclo de vida de la sesión: Fase activa</a></li>
        <li><a href="#ciclo-de-vida-de-la-sesión-fase-de-expiración">Ciclo de vida de la sesión: fase de expiración</a></li>
        <li><a href="#múltiples-mensajes-ns">Múltiples mensajes NS</a></li>
        <li><a href="#múltiples-mensajes-nsr">Múltiples mensajes NSR</a></li>
        <li><a href="#máquina-de-estados-de-la-sesión">Máquina de estados de la sesión</a></li>
      </ul>
    </li>
    <li><a href="#formato-de-carga-útil">Formato de carga útil</a>
      <ul>
        <li><a href="#estructura-de-bloques">Estructura de bloques</a></li>
        <li><a href="#tipos-de-bloques">Tipos de bloques</a></li>
        <li><a href="#reglas-de-ordenamiento-de-bloques">Reglas de ordenamiento de bloques</a></li>
        <li><a href="#orden-de-mensajes-ns">Orden de mensajes NS</a></li>
        <li><a href="#orden-de-mensajes-de-nsr">Orden de mensajes de NSR</a></li>
        <li><a href="#orden-de-mensajes-de-es">Orden de mensajes de ES</a></li>
        <li><a href="#bloque-datetime-tipo-0">Bloque DateTime (Tipo 0)</a></li>
        <li><a href="#bloque-garlic-clove-sub-bloque-en-garlic-encryption-tipo-11">Bloque Garlic Clove (sub-bloque en garlic encryption) (Tipo 11)</a></li>
        <li><a href="#bloque-nextkey-tipo-7">Bloque NextKey (Tipo 7)</a></li>
        <li><a href="#bloque-ack-tipo-8">Bloque ACK (Tipo 8)</a></li>
        <li><a href="#bloque-de-solicitud-de-ack-tipo-9">Bloque de solicitud de ACK (Tipo 9)</a></li>
        <li><a href="#bloque-de-terminación-tipo-4">Bloque de Terminación (Tipo 4)</a></li>
        <li><a href="#bloque-de-opciones-tipo-5">Bloque de opciones (Tipo 5)</a></li>
        <li><a href="#bloque-messagenumbers-tipo-6">Bloque MessageNumbers (Tipo 6)</a></li>
        <li><a href="#bloque-de-relleno-tipo-254">Bloque de relleno (Tipo 254)</a></li>
      </ul>
    </li>
    <li><a href="#guía-de-implementación">Guía de implementación</a>
      <ul>
        <li><a href="#requisitos-previos">Requisitos previos</a></li>
        <li><a href="#orden-recomendado-de-implementación">Orden recomendado de implementación</a></li>
        <li><a href="#implementación-del-emisor">Implementación del emisor</a></li>
        <li><a href="#implementación-del-receptor">Implementación del receptor</a></li>
        <li><a href="#clasificación-de-mensajes">Clasificación de mensajes</a></li>
        <li><a href="#mejores-prácticas-de-gestión-de-sesiones">Mejores prácticas de gestión de sesiones</a></li>
        <li><a href="#estrategias-de-prueba">Estrategias de prueba</a></li>
        <li><a href="#consideraciones-de-rendimiento">Consideraciones de rendimiento</a></li>
      </ul>
    </li>
    <li><a href="#consideraciones-de-seguridad">Consideraciones de seguridad</a>
      <ul>
        <li><a href="#modelo-de-amenazas">Modelo de amenazas</a></li>
        <li><a href="#supuestos-criptográficos">Supuestos criptográficos</a></li>
        <li><a href="#gestión-de-claves">Gestión de claves</a></li>
        <li><a href="#mitigaciones-de-ataques">Mitigaciones de ataques</a></li>
        <li><a href="#mitigaciones-contra-ataques-de-repetición">Mitigaciones contra ataques de repetición</a></li>
        <li><a href="#mitigaciones-contra-la-suplantación-por-compromiso-de-clave-kci">Mitigaciones contra la suplantación por compromiso de clave (KCI)</a></li>
        <li><a href="#medidas-de-mitigación-contra-la-denegación-de-servicio">Medidas de mitigación contra la denegación de servicio</a></li>
        <li><a href="#resistencia-al-análisis-de-tráfico">Resistencia al análisis de tráfico</a></li>
        <li><a href="#escollos-de-implementación">Escollos de implementación</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#security-audits">Security Audits</a></li>
      </ul>
    </li>
    <li><a href="#configuration-and-deployment">Configuration and Deployment</a>
      <ul>
        <li><a href="#i2cp-configuration">I2CP Configuration</a></li>
        <li><a href="#java-i2p-configuration">Java I2P Configuration</a></li>
        <li><a href="#i2pd-configuration">i2pd Configuration</a></li>
        <li><a href="#compatibility-matrix">Compatibility Matrix</a></li>
        <li><a href="#migration-guide">Migration Guide</a></li>
        <li><a href="#performance-tuning">Performance Tuning</a></li>
        <li><a href="#monitoring-and-debugging">Monitoring and Debugging</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a>
      <ul>
        <li><a href="#specifications">Specifications</a></li>
        <li><a href="#cryptographic-standards">Cryptographic Standards</a></li>
        <li><a href="#implementation-resources">Implementation Resources</a></li>
        <li><a href="#additional-information">Additional Information</a></li>
      </ul>
    </li>
    <li><a href="#appendix-a-kdf-summary">Appendix A: KDF Summary</a></li>
    <li><a href="#appendix-b-message-size-calculator">Appendix B: Message Size Calculator</a></li>
    <li><a href="#appendix-c-glossary">Appendix C: Glossary</a></li>
  </ul>
</nav>
                    </div>
                </nav>
            </aside>
            

            
            <div class="docs-main">
                
                <nav class="breadcrumbs">
                    <a href="../../../../es/">Home</a>
                    <span class="separator">/</span>
                    <a href="../../../../es/docs/">Docs</a>
                    
                        
                            <span class="separator">/</span>
                            <a href="../../../../es/docs/specs/">Specifications</a>
                        
                    
                    <span class="separator">/</span>
                    <span class="current">Especificación de cifrado ECIES-X25519-AEAD-Ratchet (mecanismo de trinquete criptográfico)</span>
                </nav>

                
<div class="translation-disclaimer" role="note">
    <span class="disclaimer-message">Esta traducción fue generada mediante aprendizaje automático y puede no ser 100% precisa.</span>
    
    
    <a href="../../../../en/docs/specs/ecies/" class="disclaimer-link">Ver versión en inglés</a>
    
</div>



                
                <header class="article-header">
                    <h1 class="article-title">Especificación de cifrado ECIES-X25519-AEAD-Ratchet (mecanismo de trinquete criptográfico)</h1>
                    
                        <p class="article-description">Esquema de cifrado integrado de curva elíptica para I2P (X25519 &#43; AEAD)</p>
                    
                    <div class="article-meta">
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                Updated: 2025-10
                            </span>
                        
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Accurate for: 2.10.0
                            </span>
                        
                    </div>
                </header>

                
                <article class="article-content">
                    <h2 id="descripción-general">Descripción general</h2>
<h3 id="propósito">Propósito</h3>
<p>ECIES-X25519-AEAD-Ratchet es el protocolo moderno de cifrado de extremo a extremo de I2P, que reemplaza el sistema heredado ElGamal/AES+SessionTags. Proporciona secreto perfecto hacia adelante, cifrado autenticado y mejoras significativas en rendimiento y seguridad.</p>
<h3 id="mejoras-principales-con-respecto-a-elgamalaessessiontags">Mejoras principales con respecto a ElGamal/AES+SessionTags</h3>
<ul>
<li><strong>Claves más pequeñas</strong>: Claves de 32 bytes frente a claves públicas ElGamal de 256 bytes (reducción del 87,5 %)</li>
<li><strong>Secreto hacia adelante</strong>: Logrado mediante DH ratcheting (mecanismo de avance escalonado) (no disponible en el protocolo heredado)</li>
<li><strong>Criptografía moderna</strong>: X25519 DH, ChaCha20-Poly1305 AEAD (cifrado autenticado con datos asociados), SHA-256</li>
<li><strong>Cifrado autenticado</strong>: Autenticación integrada mediante construcción AEAD</li>
<li><strong>Protocolo bidireccional</strong>: Sesiones de entrada/salida emparejadas frente al protocolo heredado unidireccional</li>
<li><strong>Etiquetas eficientes</strong>: Etiquetas de sesión de 8 bytes frente a etiquetas de 32 bytes (reducción del 75 %)</li>
<li><strong>Ofuscación del tráfico</strong>: La codificación Elligator2 (técnica de ofuscación de curvas elípticas) hace que los intercambios iniciales sean indistinguibles de datos aleatorios</li>
</ul>
<h3 id="estado-de-despliegue">Estado de despliegue</h3>
<ul>
<li><strong>Lanzamiento inicial</strong>: Versión 0.9.46 (25 de mayo de 2020)</li>
<li><strong>Despliegue de la red</strong>: Completo desde 2020</li>
<li><strong>Estado actual</strong>: Maduro, ampliamente desplegado (más de 5 años en producción)</li>
<li><strong>Compatibilidad del router</strong>: Se requiere la versión 0.9.46 o superior</li>
<li><strong>Requisitos de Floodfill</strong>: Adopción cercana al 100% para consultas cifradas</li>
</ul>
<h3 id="estado-de-la-implementación">Estado de la implementación</h3>
<p><strong>Completamente implementado:</strong> - mensajes New Session (NS) con vinculación - mensajes New Session Reply (NSR) - mensajes Existing Session (ES) - mecanismo de ratchet DH (mecanismo de avance escalonado) - ratchets de etiquetas de sesión y de claves simétricas - bloques DateTime, NextKey, ACK, ACK Request, Garlic Clove y Padding</p>
<p><strong>No implementado (a partir de la versión 0.9.50):</strong> - bloque MessageNumbers (tipo 6) - bloque de opciones (tipo 5) - bloque de terminación (tipo 4) - respuestas automáticas a nivel de protocolo - modo de clave estática cero - sesiones multicast</p>
<p><strong>Nota</strong>: El estado de implementación para las versiones desde la 1.5.0 hasta la 2.10.0 (2021-2025) requiere verificación, ya que es posible que se hayan añadido nuevas características.</p>
<hr>
<h2 id="fundamentos-del-protocolo">Fundamentos del protocolo</h2>
<h3 id="marco-del-protocolo-noise">Marco del protocolo Noise</h3>
<p>ECIES-X25519-AEAD-Ratchet se basa en el <a href="https://noiseprotocol.org/">Noise Protocol Framework</a>
 (marco del protocolo Noise) (Revisión 34, 2018-07-11), específicamente en el patrón de negociación <strong>IK</strong> (Interactivo, clave estática remota conocida) con extensiones específicas de I2P.</p>
<h3 id="identificador-del-protocolo-noise">Identificador del protocolo Noise</h3>
<pre tabindex="0"><code>Noise_IKelg2+hs2_25519_ChaChaPoly_SHA256
</code></pre><p><strong>Componentes del identificador:</strong> - <code>Noise</code> - Marco base - <code>IK</code> - Patrón de saludo interactivo con clave estática remota conocida - <code>elg2</code> - Codificación Elligator2 para claves efímeras (extensión de I2P) - <code>+hs2</code> - MixHash invocado antes del segundo mensaje para mezclar la etiqueta (extensión de I2P) - <code>25519</code> - Función Diffie-Hellman X25519 - <code>ChaChaPoly</code> - Cifrado AEAD ChaCha20-Poly1305 - <code>SHA256</code> - Función hash SHA-256</p>
<h3 id="patrón-de-negociación-de-noise">Patrón de negociación de Noise</h3>
<p><strong>Notación del patrón IK:</strong></p>
<pre tabindex="0"><code>&lt;- s                    (Bob&#39;s static key known to Alice)
...
-&gt; e, es, s, ss         (Alice sends ephemeral, DH es, static key, DH ss)
&lt;- e, ee, se            (Bob sends ephemeral, DH ee, DH se)
</code></pre><p><strong>Significados de los tokens:</strong> - <code>e</code> - Transmisión de clave efímera - <code>s</code> - Transmisión de clave estática - <code>es</code> - DH entre la clave efímera de Alice y la clave estática de Bob - <code>ss</code> - DH entre la clave estática de Alice y la clave estática de Bob - <code>ee</code> - DH entre la clave efímera de Alice y la clave efímera de Bob - <code>se</code> - DH entre la clave estática de Bob y la clave efímera de Alice</p>
<h3 id="propiedades-de-seguridad-de-noise">Propiedades de seguridad de Noise</h3>
<p>Usando la terminología de Noise, el patrón IK proporciona:</p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Message</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Authentication Level</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Confidentiality Level</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Message&nbsp;1 (NS)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;1 (sender auth, KCI vulnerable)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;2 (weak forward secrecy)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Message&nbsp;2 (NSR)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;2 (mutual auth)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;4 (weak forward secrecy)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Transport (ES)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;2 (mutual auth)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;5 (strong forward secrecy)</td>
    </tr>
  </tbody>
</table>
**Niveles de autenticación:** - **Nivel 1**: La carga útil está autenticada como perteneciente al propietario de la clave estática del remitente, pero es vulnerable a Key Compromise Impersonation (suplantación por compromiso de clave, KCI) - **Nivel 2**: Resistente a ataques KCI después de NSR
<p><strong>Niveles de confidencialidad:</strong> - <strong>Nivel 2</strong>: Secreto hacia adelante si la clave estática del remitente se ve comprometida posteriormente - <strong>Nivel 4</strong>: Secreto hacia adelante si la clave efímera del remitente se ve comprometida posteriormente - <strong>Nivel 5</strong>: Secreto hacia adelante completo después de que ambas claves efímeras se eliminen</p>
<h3 id="diferencias-entre-ik-y-xk">Diferencias entre IK y XK</h3>
<p>El patrón IK difiere del patrón XK utilizado en NTCP2 y SSU2:</p>
<ol>
<li><strong>Cuatro operaciones DH</strong>: IK usa 4 operaciones DH (es, ss, ee, se) frente a 3 para XK</li>
<li><strong>Autenticación inmediata</strong>: Alice queda autenticada en el primer mensaje (Nivel de Autenticación 1)</li>
<li><strong>Secreto hacia adelante más rápido</strong>: Se logra secreto hacia adelante completo (Nivel 5) después del segundo mensaje (1-RTT, una ida y vuelta)</li>
<li><strong>Compensación</strong>: La carga útil del primer mensaje no tiene secreto hacia adelante (frente a XK, donde todas las cargas útiles tienen secreto hacia adelante)</li>
</ol>
<p><strong>Resumen</strong>: IK permite la entrega en 1-RTT de la respuesta de Bob con pleno secreto perfecto hacia adelante, a costa de que la solicitud inicial no tenga secreto perfecto hacia adelante.</p>
<h3 id="conceptos-del-signal-double-ratchet-algoritmo-de-doble-trinquete">Conceptos del Signal Double Ratchet (algoritmo de doble trinquete)</h3>
<p>ECIES incorpora conceptos del <a href="https://signal.org/docs/specifications/doubleratchet/">Signal Double Ratchet Algorithm</a>
 (algoritmo de doble trinquete de Signal):</p>
<ul>
<li><strong>DH Ratchet</strong> (mecanismo de avance criptográfico): Proporciona secreto hacia adelante al intercambiar periódicamente nuevas claves DH</li>
<li><strong>Symmetric Key Ratchet</strong>: Deriva nuevas claves de sesión para cada mensaje</li>
<li><strong>Session Tag Ratchet</strong>: Genera etiquetas de sesión de un solo uso de forma determinista</li>
</ul>
<p><strong>Diferencias clave con Signal:</strong> - <strong>Ratcheting menos frecuente</strong> (mecanismo de actualización progresiva de claves): I2P solo hace ratcheting cuando es necesario (cerca del agotamiento de etiquetas o por política) - <strong>Etiquetas de sesión en lugar de cifrado de encabezados</strong>: Usa etiquetas deterministas en lugar de encabezados cifrados - <strong>ACKs explícitos</strong>: Usa bloques de ACK en banda en lugar de depender únicamente del tráfico de retorno - <strong>Ratchets de etiquetas y de claves separados</strong>: Más eficiente para el receptor (puede posponer el cálculo de la clave)</p>
<h3 id="extensiones-de-i2p-para-noise-marco-de-protocolos-criptográficos">Extensiones de I2P para Noise (marco de protocolos criptográficos)</h3>
<ol>
<li><strong>Codificación Elligator2</strong> (técnica para hacer que las claves en curvas elípticas parezcan aleatorias): Claves efímeras codificadas para ser indistinguibles de lo aleatorio</li>
<li><strong>Etiqueta antepuesta a NSR</strong>: Etiqueta de sesión agregada antes del mensaje NSR para permitir la correlación</li>
<li><strong>Formato de carga útil definido</strong>: Estructura de carga útil basada en bloques para todos los tipos de mensajes</li>
<li><strong>Encapsulación I2NP</strong>: Todos los mensajes envueltos en cabeceras I2NP Garlic Message</li>
<li><strong>Fase de datos separada</strong>: Los mensajes de transporte (ES) difieren de la fase de datos estándar de Noise (marco de protocolos criptográficos)</li>
</ol>
<hr>
<h2 id="primitivas-criptográficas">Primitivas criptográficas</h2>
<h3 id="x25519-diffie-hellman">X25519 Diffie-Hellman</h3>
<p><strong>Especificación</strong>: <a href="https://tools.ietf.org/html/rfc7748">RFC 7748</a>
</p>
<p><strong>Propiedades principales:</strong> - <strong>Tamaño de la clave privada</strong>: 32 bytes - <strong>Tamaño de la clave pública</strong>: 32 bytes - <strong>Tamaño del secreto compartido</strong>: 32 bytes - <strong>Orden de bytes</strong>: Little-endian (menos significativo primero) - <strong>Curva</strong>: Curve25519</p>
<p><strong>Operaciones:</strong></p>
<h3 id="x25519-generate_private">X25519 GENERATE_PRIVATE()</h3>
<p>Genera una clave privada aleatoria de 32 bytes:</p>
<pre tabindex="0"><code>privkey = CSRNG(32)
</code></pre><h3 id="x25519-derive_publicprivkey">X25519 DERIVE_PUBLIC(privkey)</h3>
<p>Deriva la clave pública correspondiente:</p>
<pre tabindex="0"><code>pubkey = curve25519_scalarmult_base(privkey)
</code></pre><p>Devuelve una clave pública de 32 bytes en formato little-endian (byte menos significativo primero).</p>
<h3 id="x25519-dhprivkey-pubkey">X25519 DH(privkey, pubkey)</h3>
<p>Realiza el acuerdo de claves Diffie-Hellman:</p>
<pre tabindex="0"><code>sharedSecret = curve25519_scalarmult(privkey, pubkey)
</code></pre><p>Devuelve un secreto compartido de 32 bytes.</p>
<p><strong>Nota de seguridad</strong>: Los implementadores deben validar que el secreto compartido no consista únicamente en ceros (clave débil). Rechace y aborte el handshake (negociación) si esto ocurre.</p>
<h3 id="chacha20-poly1305-aead-cifrado-autenticado-con-datos-asociados">ChaCha20-Poly1305 AEAD (cifrado autenticado con datos asociados)</h3>
<p><strong>Especificación</strong>: <a href="https://tools.ietf.org/html/rfc7539">RFC 7539</a>
 sección 2.8</p>
<p><strong>Parámetros:</strong> - <strong>Tamaño de clave</strong>: 32 bytes (256 bits) - <strong>Tamaño de nonce (número usado una vez)</strong>: 12 bytes (96 bits) - <strong>Tamaño de MAC</strong>: 16 bytes (128 bits) - <strong>Tamaño de bloque</strong>: 64 bytes (interno)</p>
<p><strong>Formato del nonce (número aleatorio de un solo uso):</strong></p>
<pre tabindex="0"><code>Byte 0-3:   0x00 0x00 0x00 0x00  (always zero)
Byte 4-11:  Little-endian counter (message number N)
</code></pre><p><strong>Construcción de AEAD:</strong></p>
<p>AEAD (cifrado autenticado con datos asociados) combina el cifrado en flujo ChaCha20 con el MAC Poly1305:</p>
<ol>
<li>Generar el flujo de claves de ChaCha20 a partir de la clave y el nonce (número único de uso único)</li>
<li>Cifrar el texto plano mediante XOR con el flujo de claves</li>
<li>Calcular el MAC Poly1305 sobre (datos asociados || texto cifrado)</li>
<li>Adjuntar el MAC de 16 bytes al texto cifrado</li>
</ol>
<h3 id="chacha20-poly1305-encryptk-n-plaintext-ad">ChaCha20-Poly1305 ENCRYPT(k, n, plaintext, ad)</h3>
<p>Cifra el texto plano con autenticación:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Inputs</span>
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span><span style="color:#f92672">-</span>byte cipher key
</span></span><span style="display:flex;"><span>n <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span><span style="color:#f92672">-</span>byte nonce (first <span style="color:#ae81ff">4</span> bytes zero, last <span style="color:#ae81ff">8</span> bytes <span style="color:#f92672">=</span> message number)
</span></span><span style="display:flex;"><span>plaintext <span style="color:#f92672">=</span> data to encrypt (<span style="color:#ae81ff">0</span> to <span style="color:#ae81ff">65519</span> bytes)
</span></span><span style="display:flex;"><span>ad <span style="color:#f92672">=</span> associated data (optional, used <span style="color:#f92672">in</span> MAC calculation)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Output</span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> chacha20_encrypt(k, n, plaintext)
</span></span><span style="display:flex;"><span>mac <span style="color:#f92672">=</span> poly1305(ad <span style="color:#f92672">||</span> ciphertext, poly1305_key_gen(k, n))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> ciphertext <span style="color:#f92672">||</span> mac  <span style="color:#75715e"># Total length = len(plaintext) + 16</span>
</span></span></code></pre></div><p><strong>Propiedades:</strong> - El texto cifrado tiene la misma longitud que el texto en claro (cifrado de flujo) - La salida es plaintext_length + 16 bytes (incluye el MAC) - Toda la salida es indistinguible de datos aleatorios si la clave es secreta - El MAC autentica tanto los datos asociados como el texto cifrado</p>
<h3 id="chacha20-poly1305-descifrark-n-ciphertext-ad">ChaCha20-Poly1305 DESCIFRAR(k, n, ciphertext, ad)</h3>
<p>Descifra y verifica la autenticación:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Split ciphertext and MAC</span>
</span></span><span style="display:flex;"><span>ct_without_mac <span style="color:#f92672">=</span> ciphertext[<span style="color:#ae81ff">0</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>received_mac <span style="color:#f92672">=</span> ciphertext[<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Verify MAC</span>
</span></span><span style="display:flex;"><span>expected_mac <span style="color:#f92672">=</span> poly1305(ad <span style="color:#f92672">||</span> ct_without_mac, poly1305_key_gen(k, n))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> constant_time_compare(received_mac, expected_mac):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> AuthenticationError(<span style="color:#e6db74">&#34;MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Decrypt</span>
</span></span><span style="display:flex;"><span>plaintext <span style="color:#f92672">=</span> chacha20_decrypt(k, n, ct_without_mac)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> plaintext
</span></span></code></pre></div><p><strong>Requisitos críticos de seguridad:</strong> - Los nonces (valores únicos de un solo uso) DEBEN ser únicos para cada mensaje con la misma clave - Los nonces NO DEBEN reutilizarse (fallo catastrófico si se reutilizan) - La verificación del MAC DEBE usar comparación en tiempo constante para evitar ataques de temporización - Una verificación de MAC fallida DEBE resultar en el rechazo completo del mensaje (sin descifrado parcial)</p>
<h3 id="función-hash-sha-256">Función hash SHA-256</h3>
<p><strong>Especificación</strong>: NIST FIPS 180-4</p>
<p><strong>Propiedades:</strong> - <strong>Tamaño de salida</strong>: 32 bytes (256 bits) - <strong>Tamaño de bloque</strong>: 64 bytes (512 bits) - <strong>Nivel de seguridad</strong>: 128 bits (resistencia a colisiones)</p>
<p><strong>Operaciones:</strong></p>
<h3 id="sha-256-hp-d">SHA-256 H(p, d)</h3>
<p>Hash SHA-256 con cadena de personalización:</p>
<pre tabindex="0"><code>H(p, d) := SHA256(p || d)
</code></pre><p>Donde <code>||</code> denota concatenación, <code>p</code> es la cadena de personalización, <code>d</code> son los datos.</p>
<h3 id="sha-256-mixhashd-función-de-mezcla-de-hash">SHA-256 MixHash(d) (función de mezcla de hash)</h3>
<p>Actualiza el hash incremental con nuevos datos:</p>
<pre tabindex="0"><code>h = SHA256(h || d)
</code></pre><p>Se utiliza durante todo el handshake de Noise para mantener el hash de la transcripción.</p>
<h3 id="derivación-de-claves-con-hkdf">Derivación de claves con HKDF</h3>
<p><strong>Especificación</strong>: <a href="https://tools.ietf.org/html/rfc5869">RFC 5869</a>
</p>
<p><strong>Descripción</strong>: Función de derivación de claves basada en HMAC usando SHA-256</p>
<p><strong>Parámetros:</strong> - <strong>Función hash</strong>: HMAC-SHA256 - <strong>Longitud de la sal</strong>: Hasta 32 bytes (tamaño de salida de SHA-256) - <strong>Longitud de salida</strong>: Variable (hasta 255 * 32 bytes)</p>
<p><strong>Función HKDF:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">HKDF</span>(salt, ikm, info, length):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        salt: Salt value (32 bytes max for SHA-256)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ikm: Input key material (any length)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        info: Context-specific info string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        length: Desired output length in bytes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        output: Derived key material (length bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract phase</span>
</span></span><span style="display:flex;"><span>    prk <span style="color:#f92672">=</span> HMAC<span style="color:#f92672">-</span>SHA256(salt, ikm)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Expand phase</span>
</span></span><span style="display:flex;"><span>    n <span style="color:#f92672">=</span> ceil(length <span style="color:#f92672">/</span> <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    okm <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, n <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> HMAC<span style="color:#f92672">-</span>SHA256(prk, t <span style="color:#f92672">||</span> info <span style="color:#f92672">||</span> byte(i))
</span></span><span style="display:flex;"><span>        okm <span style="color:#f92672">=</span> okm <span style="color:#f92672">||</span> t
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> okm[<span style="color:#ae81ff">0</span>:length]
</span></span></code></pre></div><p><strong>Patrones de uso comunes:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate two keys (64 bytes total)</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret, <span style="color:#e6db74">&#34;KDFDHRatchetStep&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>nextRootKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate session tag (8 bytes)</span>
</span></span><span style="display:flex;"><span>tagdata <span style="color:#f92672">=</span> HKDF(chainKey, CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>nextChainKey <span style="color:#f92672">=</span> tagdata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>sessionTag <span style="color:#f92672">=</span> tagdata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate symmetric key (32 bytes)</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>nextChainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>sessionKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span></code></pre></div><p><strong>Cadenas de información utilizadas en ECIES:</strong> - <code>&quot;KDFDHRatchetStep&quot;</code> - derivación de la clave del ratchet DH (mecanismo de avance criptográfico) - <code>&quot;TagAndKeyGenKeys&quot;</code> - inicializar las claves de etiquetas y de la cadena de claves - <code>&quot;STInitialization&quot;</code> - inicialización del ratchet de etiqueta de sesión - <code>&quot;SessionTagKeyGen&quot;</code> - generación de etiquetas de sesión - <code>&quot;SymmetricRatchet&quot;</code> - generación de claves simétricas - <code>&quot;XDHRatchetTagSet&quot;</code> - clave del conjunto de etiquetas del ratchet DH - <code>&quot;SessionReplyTags&quot;</code> - generación del conjunto de etiquetas NSR - <code>&quot;AttachPayloadKDF&quot;</code> - derivación de la clave de la carga útil NSR</p>
<h3 id="codificación-elligator2-método-criptográfico-para-representar-claves-públicas-como-datos-indistinguibles-de-datos-aleatorios">Codificación Elligator2 (método criptográfico para representar claves públicas como datos indistinguibles de datos aleatorios)</h3>
<p><strong>Propósito</strong>: Codificar claves públicas X25519 de modo que sean indistinguibles de cadenas aleatorias uniformes de 32 bytes.</p>
<p><strong>Especificación</strong>: <a href="https://elligator.cr.yp.to/elligator-20130828.pdf">Artículo sobre Elligator2</a>
</p>
<p><strong>Problema</strong>: Las claves públicas X25519 estándar tienen una estructura reconocible. Un observador puede identificar los mensajes de handshake (negociación) detectando estas claves, incluso si el contenido está cifrado.</p>
<p><strong>Solución</strong>: Elligator2 proporciona una aplicación biyectiva entre ~50% de las claves públicas X25519 válidas y cadenas de 254 bits de aspecto aleatorio.</p>
<p><strong>Generación de claves con Elligator2:</strong></p>
<h3 id="elligator2-generate_private_elg2">Elligator2 GENERATE_PRIVATE_ELG2()</h3>
<p>Genera una clave privada que se corresponde con una clave pública codificable mediante Elligator2 (técnica que permite codificar claves públicas de forma indistinguible de datos aleatorios):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>    privkey <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    pubkey <span style="color:#f92672">=</span> DERIVE_PUBLIC(privkey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Test if public key is Elligator2-encodable</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        encoded <span style="color:#f92672">=</span> ENCODE_ELG2(pubkey)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Success - this key pair is suitable</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> privkey
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> NotEncodableError:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Try again with new random key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>
</span></span></code></pre></div><p><strong>Importante</strong>: Aproximadamente el 50% de las claves privadas generadas aleatoriamente producirán claves públicas no codificables. Deben descartarse y debe intentarse la regeneración.</p>
<p><strong>Optimización del rendimiento</strong>: Genera claves por adelantado en un hilo en segundo plano para mantener una reserva de pares de claves adecuados, evitando demoras durante el handshake (negociación inicial).</p>
<h3 id="elligator2-encode_elg2pubkey">Elligator2 ENCODE_ELG2(pubkey)</h3>
<p>Codifica una clave pública en 32 bytes con apariencia aleatoria:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ENCODE_ELG2</span>(pubkey):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Encodes X25519 public key using Elligator2.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pubkey: 32-byte X25519 public key (little-endian)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        encoded: 32-byte encoded key indistinguishable from random
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Raises:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        NotEncodableError: If pubkey cannot be encoded
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform Elligator2 representative calculation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Returns 254-bit value (31.75 bytes)</span>
</span></span><span style="display:flex;"><span>    encodedKey <span style="color:#f92672">=</span> elligator2_encode(pubkey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Add 2 random bits to MSB to make full 32 bytes</span>
</span></span><span style="display:flex;"><span>    randomByte <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    encodedKey[<span style="color:#ae81ff">31</span>] <span style="color:#f92672">|=</span> (randomByte <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xc0</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> encodedKey
</span></span></code></pre></div><p><strong>Detalles de codificación:</strong> - Elligator2 (técnica de mapeo criptográfico) produce 254 bits (no los 256 completos) - Los 2 bits más significativos del byte 31 son relleno aleatorio - El resultado se distribuye uniformemente en todo el espacio de 32 bytes - Codifica con éxito aproximadamente el 50% de las claves públicas X25519 válidas</p>
<h3 id="elligator2-decode_elg2encodedkey">Elligator2 DECODE_ELG2(encodedKey)</h3>
<p>Se decodifica de vuelta a la clave pública original:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">DECODE_ELG2</span>(encodedKey):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Decodes Elligator2-encoded key back to X25519 public key.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        encodedKey: 32-byte encoded key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pubkey: 32-byte X25519 public key (little-endian)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Mask out 2 random padding bits from MSB</span>
</span></span><span style="display:flex;"><span>    encodedKey[<span style="color:#ae81ff">31</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0x3f</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform Elligator2 representative inversion</span>
</span></span><span style="display:flex;"><span>    pubkey <span style="color:#f92672">=</span> elligator2_decode(encodedKey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pubkey
</span></span></code></pre></div><p><strong>Propiedades de seguridad:</strong> - Las claves codificadas son indistinguibles computacionalmente de bytes aleatorios - Ninguna prueba estadística puede detectar de forma fiable claves codificadas con Elligator2 - La decodificación es determinista (la misma clave codificada siempre produce la misma clave pública) - La codificación es biyectiva para el ~50% de las claves del subconjunto codificable</p>
<p><strong>Notas de implementación:</strong> - Almacenar las claves codificadas en la fase de generación para evitar volver a codificarlas durante la negociación inicial - Las claves no aptas de la generación con Elligator2 (mapeo criptográfico para ofuscar claves) pueden usarse para NTCP2 (que no requiere Elligator2) - La generación de claves en segundo plano es esencial para el rendimiento - El tiempo medio de generación se duplica debido a una tasa de rechazo del 50%</p>
<hr>
<h2 id="formatos-de-mensajes">Formatos de mensajes</h2>
<h3 id="descripción-general-1">Descripción general</h3>
<p>ECIES define tres tipos de mensaje:</p>
<ol>
<li><strong>New Session (NS)</strong> (nueva sesión): Mensaje de negociación inicial de Alice a Bob</li>
<li><strong>New Session Reply (NSR)</strong> (respuesta a nueva sesión): Respuesta de negociación de Bob a Alice</li>
<li><strong>Existing Session (ES)</strong> (sesión existente): Todos los mensajes posteriores en ambas direcciones</li>
</ol>
<p>Todos los mensajes están encapsulados en el formato I2NP Garlic Message con capas adicionales de cifrado.</p>
<h3 id="contenedor-de-mensajes-garlic-de-i2np">Contenedor de mensajes Garlic de I2NP</h3>
<p>Todos los mensajes ECIES se encapsulan en encabezados estándar de I2NP Garlic Message (mensaje Garlic):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|type|      msg_id       |  expiration   |
+----+----+----+----+----+----+----+----+
                         |  size   |chks|
+----+----+----+----+----+----+----+----+
|      length       |                   |
+----+----+----+----+                   +
|          encrypted data               |
~                                       ~
</code></pre><p><strong>Campos:</strong> - <code>type</code>: 0x26 (Garlic Message) - <code>msg_id</code>: ID de mensaje I2NP de 4 bytes - <code>expiration</code>: marca de tiempo Unix de 8 bytes (milisegundos) - <code>size</code>: tamaño de la carga útil de 2 bytes - <code>chks</code>: suma de verificación de 1 byte - <code>length</code>: longitud de los datos cifrados de 4 bytes - <code>encrypted data</code>: carga útil cifrada con ECIES</p>
<p><strong>Propósito</strong>: Proporciona identificación y enrutamiento de mensajes en la capa I2NP. El campo <code>length</code> permite a los receptores conocer el tamaño total de la carga útil cifrada.</p>
<h3 id="mensaje-de-nueva-sesión-ns">Mensaje de Nueva Sesión (NS)</h3>
<p>El mensaje de nueva sesión inicia una nueva sesión desde Alice hacia Bob. Se presenta en tres variantes:</p>
<ol>
<li><strong>Con vinculación</strong> (1b): Incluye la clave estática de Alice para comunicación bidireccional</li>
<li><strong>Sin vinculación</strong> (1c): Omite la clave estática para comunicación unidireccional</li>
<li><strong>De un solo uso</strong> (1d): Modo de un solo mensaje sin establecimiento de sesión</li>
</ol>
<h3 id="mensaje-ns-con-vinculación-tipo-1b">Mensaje NS con vinculación (Tipo 1b)</h3>
<p><strong>Caso de uso</strong>: Transmisión en continuo, datagramas a los que se puede responder, cualquier protocolo que requiera respuestas</p>
<p><strong>Longitud total</strong>: 96 + payload_length bytes</p>
<p><strong>Formato</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+                                       +
|   New Session Ephemeral Public Key    |
+             32 bytes                  +
|     Encoded with Elligator2           |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+         Static Key Section            +
|       ChaCha20 encrypted data         |
+            32 bytes                   +
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+    (MAC) for Static Key Section       +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for Payload Section     +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Detalles del campo:</strong></p>
<p><strong>Clave pública efímera</strong> (32 bytes, sin cifrar): - Clave pública X25519 de un solo uso de Alice - Codificada con Elligator2 (indistinguible de datos aleatorios) - Se genera nueva para cada mensaje NS (nunca se reutiliza) - Formato little-endian</p>
<p><strong>Sección de clave estática</strong> (32 bytes cifrados, 48 bytes con MAC): - Contiene la clave pública estática X25519 de Alice (32 bytes) - Cifrado con ChaCha20 - Autenticado con MAC Poly1305 (16 bytes) - Usado por Bob para vincular la sesión al destino de Alice</p>
<p><strong>Payload Section</strong> (cifrado de longitud variable, +16 bytes de MAC): - Contiene garlic cloves (subbloques de garlic encryption; &ldquo;dientes de ajo&rdquo; en la terminología de I2P) y otros bloques - Debe incluir el bloque DateTime como primer bloque - Suele incluir bloques Garlic Clove con datos de la aplicación - Puede incluir el bloque NextKey para ratchet inmediato (mecanismo de avance criptográfico) - Cifrado con ChaCha20 - Autenticado con MAC Poly1305 (16 bytes)</p>
<p><strong>Propiedades de seguridad:</strong> - La clave efímera proporciona el componente de secreto perfecto hacia adelante - La clave estática autentica a Alice (vinculándola al destino) - Ambas secciones tienen MAC independientes para separación de dominios - El handshake completo realiza 2 operaciones DH (es, ss)</p>
<h3 id="ns-message-mensaje-ns-sin-vinculación-tipo-1c">NS Message (mensaje NS) sin vinculación (Tipo 1c)</h3>
<p><strong>Caso de uso</strong>: Datagramas sin procesar en los que no se espera ni se desea respuesta</p>
<p><strong>Longitud total</strong>: 96 + payload_length bytes</p>
<p><strong>Formato</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+                                       +
|   New Session Ephemeral Public Key    |
+             32 bytes                  +
|     Encoded with Elligator2           |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+           Flags Section               +
|       ChaCha20 encrypted data         |
+            32 bytes                   +
|           All zeros                   |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for above section       +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for Payload Section     +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Diferencia clave</strong>: La Flags Section (sección de banderas) contiene 32 bytes de ceros en lugar de una clave estática.</p>
<p><strong>Detección</strong>: Bob determina el tipo de mensaje descifrando la sección de 32 bytes y verificando si todos los bytes son cero: - Todos en cero → sesión no vinculada (tipo 1c) - Algún byte distinto de cero → sesión vinculada con clave estática (tipo 1b)</p>
<p><strong>Propiedades:</strong> - No tener una clave estática significa que no hay vinculación con el destino de Alice - Bob no puede enviar respuestas (no se conoce el destino) - Realiza solo 1 operación DH (Diffie-Hellman) (es) - Sigue el patrón &ldquo;N&rdquo; de Noise en lugar de &ldquo;IK&rdquo; - Más eficiente cuando nunca se necesitan respuestas</p>
<p><strong>Sección de indicadores</strong> (reservada para uso futuro): Actualmente, todo son ceros. Podría utilizarse para la negociación de características en versiones futuras.</p>
<h3 id="ns-mensaje-de-un-solo-uso-tipo-1d">NS Mensaje de un solo uso (Tipo 1d)</h3>
<p><strong>Caso de uso</strong>: Mensaje anónimo único, sin sesión ni respuesta esperada</p>
<p><strong>Longitud total</strong>: 96 + payload_length bytes</p>
<p><strong>Formato</strong>: Idéntico a NS sin vinculación (tipo 1c)</p>
<p><strong>Distinción</strong>:  - Tipo 1c puede enviar múltiples mensajes en la misma sesión (los mensajes ES siguen) - Tipo 1d envía exactamente un mensaje sin establecimiento de sesión - En la práctica, las implementaciones pueden tratar ambos de forma idéntica inicialmente</p>
<p><strong>Propiedades:</strong> - Anonimato máximo (sin clave estática, sin sesión) - Ninguna de las partes conserva estado de sesión - Sigue el patrón &ldquo;N&rdquo; de Noise (marco de protocolos criptográficos) - Una única operación DH (es)</p>
<h3 id="mensaje-de-respuesta-de-nueva-sesión-nsr">Mensaje de respuesta de nueva sesión (NSR)</h3>
<p>Bob envía uno o más mensajes NSR en respuesta al mensaje NS de Alice. NSR completa el handshake Noise IK y establece una sesión bidireccional.</p>
<p><strong>Longitud total</strong>: 72 + payload_length bytes</p>
<p><strong>Formato</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|       Session Tag   8 bytes           |
+----+----+----+----+----+----+----+----+
|                                       |
+        Ephemeral Public Key           +
|                                       |
+            32 bytes                   +
|     Encoded with Elligator2           |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+  (MAC) for Key Section (empty)        +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for Payload Section     +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Detalles del campo:</strong></p>
<p><strong>Etiqueta de sesión</strong> (8 bytes, en claro): - Generada a partir del conjunto de etiquetas de NSR (véanse las secciones de KDF) - Correlaciona esta respuesta con el mensaje NS de Alice - Permite a Alice identificar a qué NS responde este NSR - Uso único (nunca se reutiliza)</p>
<p><strong>Clave pública efímera</strong> (32 bytes, en claro): - La clave pública X25519 de un solo uso de Bob - Codificada con Elligator2 - Generada de nuevo para cada mensaje NSR - Debe ser diferente para cada NSR enviado</p>
<p><strong>MAC de la sección de clave</strong> (16 bytes): - Autentica datos vacíos (ZEROLEN) - Parte del protocolo Noise IK (se pattern; patrón estático-efímero) - Utiliza el hash de la transcripción como datos asociados - Crítico para vincular NSR a NS</p>
<p><strong>Sección de carga útil</strong> (longitud variable): - Contiene garlic cloves (submensajes en el esquema garlic encryption) y bloques - Suele incluir respuestas de la capa de aplicación - Puede estar vacía (NSR solo con ACK) - Tamaño máximo: 65519 bytes (65535 - MAC de 16 bytes)</p>
<p><strong>Múltiples mensajes NSR:</strong></p>
<p>Bob puede enviar varios mensajes NSR en respuesta a un NS: - Cada NSR tiene una clave efímera única - Cada NSR tiene una etiqueta de sesión única - Alice usa el primer NSR recibido para completar el intercambio inicial - Los otros NSR son redundancia (en caso de pérdida de paquetes)</p>
<p><strong>Temporización crítica:</strong> - Alice debe recibir un NSR antes de enviar mensajes ES - Bob debe recibir un mensaje ES antes de enviar mensajes ES - NSR establece claves de sesión bidireccionales mediante la operación split()</p>
<p><strong>Propiedades de seguridad:</strong> - Completa el apretón de manos Noise IK - Realiza 2 operaciones DH adicionales (ee, se) - Total de 4 operaciones DH entre NS+NSR - Logra autenticación mutua (Nivel 2) - Proporciona secreto hacia adelante débil (Nivel 4) para la carga útil de NSR</p>
<h3 id="mensaje-de-sesión-existente-es">Mensaje de Sesión Existente (ES)</h3>
<p>Todos los mensajes posteriores a la negociación NS/NSR usan el formato Existing Session (formato de sesión existente). Los mensajes ES se utilizan de forma bidireccional tanto por Alice como por Bob.</p>
<p><strong>Longitud total</strong>: 8 + payload_length + 16 bytes (mínimo 24 bytes)</p>
<p><strong>Formato</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|       Session Tag   8 bytes           |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+              (MAC)                    +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Detalles del campo:</strong></p>
<p><strong>Etiqueta de sesión</strong> (8 bytes, en claro): - Generada a partir del conjunto de etiquetas de salida actual - Identifica la sesión y el número de mensaje - El receptor busca la etiqueta para encontrar la clave de sesión y el nonce (número único de uso) - Uso único (cada etiqueta se usa exactamente una vez) - Formato: primeros 8 bytes de la salida de HKDF</p>
<p><strong>Sección de carga útil</strong> (longitud variable): - Contiene garlic cloves (unidades individuales de Garlic Encryption) y bloques - Sin bloques obligatorios (puede estar vacía) - Bloques comunes: Garlic Clove, NextKey, ACK, ACK Request, Padding - Tamaño máximo: 65519 bytes (65535 - MAC de 16 bytes)</p>
<p><strong>MAC</strong> (16 bytes): - Etiqueta de autenticación Poly1305 - Se calcula sobre toda la carga útil - Datos asociados: la etiqueta de sesión de 8 bytes - Debe verificarse correctamente o el mensaje será rechazado</p>
<p><strong>Proceso de búsqueda de etiquetas:</strong></p>
<ol>
<li>El receptor extrae una etiqueta de 8 bytes</li>
<li>Busca la etiqueta en todos los conjuntos de etiquetas entrantes actuales</li>
<li>Recupera la clave de sesión asociada y el número de mensaje N</li>
<li>Construye el nonce (número único de uso): <code>[0x00, 0x00, 0x00, 0x00, N (8 bytes little-endian)]</code></li>
<li>Descifra la carga útil usando AEAD con la etiqueta como datos asociados</li>
<li>Elimina la etiqueta del conjunto de etiquetas (de un solo uso)</li>
<li>Procesa los bloques descifrados</li>
</ol>
<p><strong>Etiqueta de sesión no encontrada:</strong></p>
<p>Si la etiqueta no se encuentra en ningún conjunto de etiquetas: - Puede ser un mensaje NS (tipo de mensaje de I2P) → intentar el descifrado NS - Puede ser un mensaje NSR (tipo de mensaje de I2P) → intentar el descifrado NSR - Puede ser un ES (esquema ElGamal+SessionTags en I2P) fuera de orden → esperar brevemente la actualización del conjunto de etiquetas - Puede ser un ataque de repetición → rechazar - Puede tratarse de datos corruptos → rechazar</p>
<p><strong>Carga útil vacía:</strong></p>
<p>Los mensajes ES pueden tener cargas útiles vacías (0 bytes): - Sirven como un ACK (acuse de recibo) explícito cuando se recibió una solicitud de ACK - Proporcionan una respuesta a nivel de protocolo sin datos de aplicación - Aún consumen una etiqueta de sesión - Son útiles cuando la capa superior no tiene datos inmediatos para enviar</p>
<p><strong>Propiedades de seguridad:</strong> - Secreto perfecto hacia adelante completo (Nivel 5) después de recibir NSR - Cifrado autenticado mediante AEAD (cifrado autenticado con datos asociados) - La etiqueta actúa como datos asociados adicionales - Máximo de 65535 mensajes por tagset (conjunto de etiquetas) antes de que sea necesario un ratchet (mecanismo de derivación incremental de claves)</p>
<hr>
<h2 id="funciones-de-derivación-de-claves">Funciones de derivación de claves</h2>
<p>Esta sección documenta todas las operaciones KDF (función de derivación de claves) utilizadas en ECIES, mostrando las derivaciones criptográficas completas.</p>
<h3 id="notación-y-constantes">Notación y constantes</h3>
<p><strong>Constantes:</strong> - <code>ZEROLEN</code> - Matriz de bytes de longitud cero (cadena vacía) - <code>||</code> - Operador de concatenación</p>
<p><strong>Variables:</strong> - <code>h</code> - Hash acumulado de la transcripción (32 bytes) - <code>chainKey</code> - Clave de encadenamiento para HKDF (32 bytes) - <code>k</code> - Clave de cifrado simétrico (32 bytes) - <code>n</code> - Nonce / número de mensaje</p>
<p><strong>Claves:</strong> - <code>ask</code> / <code>apk</code> - clave privada/pública estática de Alice - <code>aesk</code> / <code>aepk</code> - clave privada/pública efímera de Alice - <code>bsk</code> / <code>bpk</code> - clave privada/pública estática de Bob - <code>besk</code> / <code>bepk</code> - clave privada/pública efímera de Bob</p>
<h3 id="funciones-de-derivación-de-claves-para-mensajes-ns">Funciones de derivación de claves para mensajes NS</h3>
<h3 id="kdf-1-clave-de-cadena-inicial">KDF 1: Clave de cadena inicial</h3>
<p>Se realiza una vez durante la inicialización del protocolo (puede precalcularse):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Protocol name (40 bytes, ASCII, no null termination)</span>
</span></span><span style="display:flex;"><span>protocol_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Noise_IKelg2+hs2_25519_ChaChaPoly_SHA256&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(protocol_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize chaining key</span>
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># MixHash with empty prologue</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: chainKey and h initialized</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Can be precalculated for all outbound sessions</span>
</span></span></code></pre></div><p><strong>Resultado:</strong> - <code>chainKey</code> = clave de encadenamiento inicial para todas las KDF posteriores (funciones de derivación de claves) - <code>h</code> = hash inicial de la transcripción</p>
<h3 id="kdf-2-función-de-derivación-de-claves-mezcla-de-clave-estática-de-bob">KDF 2 (función de derivación de claves): Mezcla de clave estática de Bob</h3>
<p>Bob realiza esto una vez (puede precalcularse para todas las sesiones entrantes):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Bob&#39;s static keys (published in LeaseSet)</span>
</span></span><span style="display:flex;"><span>bsk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>bpk <span style="color:#f92672">=</span> DERIVE_PUBLIC(bsk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix Bob&#39;s public key into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bpk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: h updated with Bob&#39;s identity</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Can be precalculated by Bob for all inbound sessions</span>
</span></span></code></pre></div><h3 id="kdf-3-generación-de-clave-efímera-de-alice">KDF 3: Generación de clave efímera de Alice</h3>
<p>Alice genera claves nuevas para cada NS message (mensaje NS):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate ephemeral key pair suitable for Elligator2</span>
</span></span><span style="display:flex;"><span>aesk <span style="color:#f92672">=</span> GENERATE_PRIVATE_ELG2()
</span></span><span style="display:flex;"><span>aepk <span style="color:#f92672">=</span> DERIVE_PUBLIC(aesk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ephemeral public key into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> aepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Elligator2 encode for transmission</span>
</span></span><span style="display:flex;"><span>elg2_aepk <span style="color:#f92672">=</span> ENCODE_ELG2(aepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: h updated with Alice&#39;s ephemeral key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send elg2_aepk as first 32 bytes of NS message</span>
</span></span></code></pre></div><h3 id="kdf-4-sección-de-clave-estática-de-ns-es-dh">KDF 4: Sección de clave estática de NS (es DH)</h3>
<p>Deriva claves para cifrar la clave estática de Alice:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Perform first DH (ephemeral-static)</span>
</span></span><span style="display:flex;"><span>sharedSecret <span style="color:#f92672">=</span> DH(aesk, bpk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Equivalent: sharedSecret = DH(bsk, aepk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive cipher key from shared secret</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD encryption parameters</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> h  <span style="color:#75715e"># Current hash transcript</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt static key section</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> binding_requested:
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> apk  <span style="color:#75715e"># Alice&#39;s static public key (32 bytes)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> bytes(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># All zeros for unbound</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, plaintext, associated_data)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ciphertext = 32 bytes encrypted + 16 bytes MAC = 48 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ciphertext into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> ciphertext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Static key section encrypted, h updated</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext (48 bytes) as next part of NS message</span>
</span></span></code></pre></div><h3 id="kdf-5-sección-de-carga-útil-de-ns-ss-dh-solo-vinculada">KDF 5: Sección de carga útil de NS (ss DH, solo vinculada)</h3>
<p>Para sesiones vinculadas, realiza un segundo DH (intercambio de claves Diffie-Hellman) para cifrar la carga útil:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> binding_requested:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice&#39;s static keys</span>
</span></span><span style="display:flex;"><span>    ask <span style="color:#f92672">=</span> GENERATE_PRIVATE()  <span style="color:#75715e"># Alice&#39;s long-term key</span>
</span></span><span style="display:flex;"><span>    apk <span style="color:#f92672">=</span> DERIVE_PUBLIC(ask)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform second DH (static-static)</span>
</span></span><span style="display:flex;"><span>    sharedSecret <span style="color:#f92672">=</span> DH(ask, bpk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Equivalent: sharedSecret = DH(bsk, apk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive cipher key</span>
</span></span><span style="display:flex;"><span>    keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>    k <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    associated_data <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Unbound: reuse keys from static key section</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># chainKey and k unchanged</span>
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># Increment nonce (reusing same key)</span>
</span></span><span style="display:flex;"><span>    associated_data <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt payload</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> build_payload()  <span style="color:#75715e"># DateTime + Garlic Cloves + etc.</span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, payload, associated_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ciphertext into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> ciphertext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Payload encrypted, h contains complete NS transcript</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Save chainKey and h for NSR processing</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext as final part of NS message</span>
</span></span></code></pre></div><p><strong>Notas importantes:</strong></p>
<ol>
<li>
<p><strong>Bound (vinculado) vs Unbound (no vinculado)</strong>:</p>
<ul>
<li>Bound realiza 2 operaciones DH (Diffie–Hellman) (es + ss)</li>
<li>Unbound realiza 1 operación DH (solo es)</li>
<li>Unbound incrementa el nonce (número usado una vez) en lugar de derivar una clave nueva</li>
</ul>
</li>
<li>
<p><strong>Seguridad frente a la reutilización de claves</strong>:</p>
<ul>
<li>Nonces (valor único de un solo uso) diferentes (0 vs 1) evitan la reutilización de clave/nonce</li>
<li>Datos asociados diferentes (h es diferente) proporcionan separación de dominios</li>
</ul>
</li>
<li>
<p><strong>Transcripción del hash</strong>:</p>
<ul>
<li><code>h</code> ahora contiene: protocol_name, prólogo vacío, bpk, aepk, static_key_ciphertext, payload_ciphertext</li>
<li>Esta transcripción vincula todas las partes del mensaje NS entre sí</li>
</ul>
</li>
</ol>
<h3 id="nsr-reply-tagset-kdf-función-de-derivación-de-claves-del-conjunto-de-etiquetas-de-respuesta-de-nsr">NSR Reply Tagset KDF (función de derivación de claves del conjunto de etiquetas de respuesta de NSR)</h3>
<p>Bob genera etiquetas para los mensajes NSR:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Chain key from NS payload section</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># chainKey = final chainKey from NS KDF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate tagset key</span>
</span></span><span style="display:flex;"><span>tagsetKey <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SessionReplyTags&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize NSR tagset (see DH_INITIALIZE below)</span>
</span></span><span style="display:flex;"><span>tagset_nsr <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, tagsetKey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get tag for this NSR</span>
</span></span><span style="display:flex;"><span>tagsetEntry <span style="color:#f92672">=</span> tagset_nsr<span style="color:#f92672">.</span>GET_NEXT_ENTRY()
</span></span><span style="display:flex;"><span>tag <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_TAG  <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: tag available for NSR message</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send tag as first 8 bytes of NSR</span>
</span></span></code></pre></div><h3 id="funciones-de-derivación-de-claves-del-mensaje-nsr">Funciones de derivación de claves del mensaje NSR</h3>
<h3 id="kdf-6-generación-de-claves-efímeras-de-nsr">KDF 6: Generación de claves efímeras de NSR</h3>
<p>Bob genera una clave efímera nueva para cada NSR (solicitud de sesión de Noise):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Mix tag into hash (I2P extension to Noise)</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> tag)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate ephemeral key pair</span>
</span></span><span style="display:flex;"><span>besk <span style="color:#f92672">=</span> GENERATE_PRIVATE_ELG2()
</span></span><span style="display:flex;"><span>bepk <span style="color:#f92672">=</span> DERIVE_PUBLIC(besk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ephemeral public key into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Elligator2 encode for transmission</span>
</span></span><span style="display:flex;"><span>elg2_bepk <span style="color:#f92672">=</span> ENCODE_ELG2(bepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: h updated with tag and Bob&#39;s ephemeral key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send elg2_bepk as bytes 9-40 of NSR message</span>
</span></span></code></pre></div><h3 id="kdf-7-sección-de-claves-de-nsr-ee-efímero-efímero-y-se-estático-efímero-dh">KDF 7: Sección de claves de NSR (ee (efímero-efímero) y se (estático-efímero) DH)</h3>
<p>Deriva claves para la sección de claves de NSR:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Perform third DH (ephemeral-ephemeral)</span>
</span></span><span style="display:flex;"><span>sharedSecret_ee <span style="color:#f92672">=</span> DH(aesk, bepk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Equivalent: sharedSecret_ee = DH(besk, aepk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ee into chain</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret_ee, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Perform fourth DH (static-ephemeral)</span>
</span></span><span style="display:flex;"><span>sharedSecret_se <span style="color:#f92672">=</span> DH(ask, bepk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Equivalent: sharedSecret_se = DH(besk, apk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive cipher key from se</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret_se, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD encryption of empty data (key section has no payload)</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, ZEROLEN, associated_data)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ciphertext = 16 bytes (MAC only, no plaintext)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ciphertext into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> ciphertext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Key section encrypted, chainKey contains all 4 DH results</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext (16 bytes MAC) as bytes 41-56 of NSR</span>
</span></span></code></pre></div><p><strong>Crítico</strong>: Esto completa el handshake Noise IK (intercambio inicial del protocolo Noise IK). <code>chainKey</code> ahora contiene contribuciones de las 4 operaciones DH (es, ss, ee, se).</p>
<h3 id="kdf-8-sección-de-carga-útil-de-nsr">KDF 8: Sección de carga útil de NSR</h3>
<p>Deriva claves para el cifrado de la carga útil de NSR:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Split chainKey into bidirectional keys</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>k_ab <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]   <span style="color:#75715e"># Alice → Bob key</span>
</span></span><span style="display:flex;"><span>k_ba <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Bob → Alice key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize ES tagsets for both directions</span>
</span></span><span style="display:flex;"><span>tagset_ab <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ab)  <span style="color:#75715e"># Alice → Bob</span>
</span></span><span style="display:flex;"><span>tagset_ba <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ba)  <span style="color:#75715e"># Bob → Alice</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive NSR payload key (Bob → Alice)</span>
</span></span><span style="display:flex;"><span>k_nsr <span style="color:#f92672">=</span> HKDF(k_ba, ZEROLEN, <span style="color:#e6db74">&#34;AttachPayloadKDF&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt NSR payload</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> h  <span style="color:#75715e"># Binds payload to entire NSR</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> build_payload()  <span style="color:#75715e"># Usually application reply</span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_nsr, nonce, payload, associated_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Bidirectional ES sessions established</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tagset_ab and tagset_ba ready for ES messages</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext as bytes 57+ of NSR message</span>
</span></span></code></pre></div><p><strong>Notas importantes:</strong></p>
<ol>
<li>
<p><strong>Operación de división</strong>:</p>
<ul>
<li>Crea claves independientes para cada dirección</li>
<li>Evita la reutilización de claves entre Alice→Bob y Bob→Alice</li>
</ul>
</li>
<li>
<p><strong>Vinculación de la carga útil NSR</strong>:</p>
<ul>
<li>Usa <code>h</code> como datos asociados para vincular la carga útil al handshake (proceso de establecimiento de conexión)</li>
<li>Una KDF (función de derivación de claves) independiente (&ldquo;AttachPayloadKDF&rdquo;) proporciona separación de dominios</li>
</ul>
</li>
<li>
<p><strong>Preparación para ES</strong>:</p>
<ul>
<li>Después de NSR, ambas partes pueden enviar mensajes ES</li>
<li>Alice debe recibir NSR antes de enviar ES</li>
<li>Bob debe recibir ES antes de enviar ES</li>
</ul>
</li>
</ol>
<h3 id="kdfs-de-mensajes-de-es">KDFs de mensajes de ES</h3>
<p>Los mensajes ES usan claves de sesión generadas previamente a partir de los tagsets (conjuntos de etiquetas):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Sender gets next tag and key</span>
</span></span><span style="display:flex;"><span>tagsetEntry <span style="color:#f92672">=</span> outbound_tagset<span style="color:#f92672">.</span>GET_NEXT_ENTRY()
</span></span><span style="display:flex;"><span>tag <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_TAG     <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_KEY       <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>N <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>INDEX             <span style="color:#75715e"># Message number</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Construct nonce (12 bytes)</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>] <span style="color:#f92672">+</span> little_endian_8_bytes(N)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD encryption</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> tag  <span style="color:#75715e"># Tag is associated data</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> build_payload()
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, payload, associated_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send: tag || ciphertext (8 + len(ciphertext) bytes)</span>
</span></span></code></pre></div><p><strong>Proceso del receptor:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Extract tag</span>
</span></span><span style="display:flex;"><span>tag <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Look up tag in inbound tagsets</span>
</span></span><span style="display:flex;"><span>tagsetEntry <span style="color:#f92672">=</span> inbound_tagset<span style="color:#f92672">.</span>GET_SESSION_KEY(tag)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> tagsetEntry <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Not an ES message, try NS/NSR decryption</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> try_handshake_decryption(message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_KEY
</span></span><span style="display:flex;"><span>N <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>INDEX
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Construct nonce</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>] <span style="color:#f92672">+</span> little_endian_8_bytes(N)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD decryption</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> tag
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">8</span>:]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> DECRYPT(k, nonce, ciphertext, associated_data)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># MAC verification failed, reject message</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> reject_message()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Process payload blocks</span>
</span></span><span style="display:flex;"><span>process_payload(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remove tag from tagset (one-time use)</span>
</span></span><span style="display:flex;"><span>inbound_tagset<span style="color:#f92672">.</span>remove(tag)
</span></span></code></pre></div><h3 id="función-dh_initialize">Función DH_INITIALIZE</h3>
<p>Crea un tagset (conjunto de etiquetas) para un único sentido:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">DH_INITIALIZE</span>(rootKey, k):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Initializes a tagset with session tag and symmetric key ratchets.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rootKey: Chain key from previous DH ratchet (32 bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k: Key material from split() or DH ratchet (32 bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        tagset: Initialized tagset object
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive next root key and chain key</span>
</span></span><span style="display:flex;"><span>    keydata <span style="color:#f92672">=</span> HKDF(rootKey, k, <span style="color:#e6db74">&#34;KDFDHRatchetStep&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    nextRootKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>    chainKey_tagset <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive separate chain keys for tags and keys</span>
</span></span><span style="display:flex;"><span>    keydata <span style="color:#f92672">=</span> HKDF(chainKey_tagset, ZEROLEN, <span style="color:#e6db74">&#34;TagAndKeyGenKeys&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    sessTag_ck <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]   <span style="color:#75715e"># Session tag chain key</span>
</span></span><span style="display:flex;"><span>    symmKey_ck <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Symmetric key chain key</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create tagset object</span>
</span></span><span style="display:flex;"><span>    tagset <span style="color:#f92672">=</span> Tagset()
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>nextRootKey <span style="color:#f92672">=</span> nextRootKey
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>sessTag_chainKey <span style="color:#f92672">=</span> sessTag_ck
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>symmKey_chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>lastIndex <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tagset
</span></span></code></pre></div><p><strong>Contextos de uso:</strong></p>
<ol>
<li><strong>Conjunto de etiquetas NSR</strong>: <code>DH_INITIALIZE(chainKey_from_NS, tagsetKey_NSR)</code></li>
<li><strong>Conjuntos de etiquetas ES</strong>: <code>DH_INITIALIZE(chainKey_from_NSR, k_ab or k_ba)</code></li>
<li><strong>Conjuntos de etiquetas con ratchet (mecanismo criptográfico de avance)</strong>: <code>DH_INITIALIZE(nextRootKey_from_previous, tagsetKey_from_DH)</code></li>
</ol>
<hr>
<h2 id="mecanismos-de-trinquete">Mecanismos de trinquete</h2>
<p>ECIES (esquema de cifrado integrado sobre curvas elípticas) utiliza tres mecanismos de ratchet (mecanismo de avance criptográfico) sincronizados para proporcionar secreto hacia adelante y una gestión eficiente de sesiones.</p>
<h3 id="descripción-general-de-ratchet-mecanismo-de-trinquete">Descripción general de Ratchet (mecanismo de trinquete)</h3>
<p><strong>Tres tipos de Ratchet (mecanismo de avance escalonado):</strong></p>
<ol>
<li><strong>DH Ratchet</strong> (mecanismo de avance criptográfico): Realiza intercambios de claves Diffie-Hellman para generar nuevas claves raíz</li>
<li><strong>Session Tag Ratchet</strong>: Deriva etiquetas de sesión de un solo uso de forma determinista</li>
<li><strong>Symmetric Key Ratchet</strong>: Deriva claves de sesión para el cifrado de mensajes</li>
</ol>
<p><strong>Relación:</strong></p>
<pre tabindex="0"><code>DH Ratchet (periodic)
    ↓
Creates new tagset
    ↓
Session Tag Ratchet (per message) ← synchronized → Symmetric Key Ratchet (per message)
    ↓                                                      ↓
Session Tags (8 bytes each)                      Session Keys (32 bytes each)
</code></pre><p><strong>Propiedades clave:</strong></p>
<ul>
<li><strong>Remitente</strong>: Genera etiquetas y claves bajo demanda (no se necesita almacenamiento)</li>
<li><strong>Receptor</strong>: Pre-genera etiquetas para una ventana de anticipación (se requiere almacenamiento)</li>
<li><strong>Sincronización</strong>: El índice de la etiqueta determina el índice de la clave (N_tag = N_key)</li>
<li><strong>Secreto hacia adelante</strong>: Logrado mediante un DH ratchet (mecanismo de avance Diffie–Hellman) periódico</li>
<li><strong>Eficiencia</strong>: El receptor puede aplazar el cálculo de la clave hasta que se reciba la etiqueta</li>
</ul>
<h3 id="dh-ratchet-mecanismo-de-avance-de-claves-diffie-hellman">DH Ratchet (mecanismo de avance de claves Diffie-Hellman)</h3>
<p>El DH ratchet (mecanismo de avance de Diffie-Hellman) proporciona secreto hacia adelante al intercambiar periódicamente nuevas claves efímeras.</p>
<h3 id="frecuencia-del-dh-ratchet-mecanismo-de-trinquete-diffiehellman">Frecuencia del DH Ratchet (mecanismo de trinquete Diffie‑Hellman)</h3>
<p><strong>Condiciones requeridas del Ratchet (mecanismo de avance criptográfico):</strong> - Conjunto de etiquetas próximo al agotamiento (la etiqueta 65535 es el máximo) - Políticas específicas de la implementación:   - Umbral de cantidad de mensajes (p. ej., cada 4096 mensajes)   - Umbral de tiempo (p. ej., cada 10 minutos)   - Umbral de volumen de datos (p. ej., cada 100 MB)</p>
<p><strong>Primer Ratchet recomendado</strong> (mecanismo de avance criptográfico): Alrededor del número de etiqueta 4096 para evitar alcanzar el límite</p>
<p><strong>Valores máximos:</strong> - <strong>ID máximo del conjunto de etiquetas</strong>: 65535 - <strong>ID máximo de clave</strong>: 32767 - <strong>Máximo de mensajes por conjunto de etiquetas</strong>: 65535 - <strong>Máximo teórico de datos por sesión</strong>: ~6.9 TB (64K conjuntos de etiquetas × 64K mensajes × 1730 bytes promedio)</p>
<h3 id="identificadores-de-etiquetas-y-de-claves-del-dh-ratchet-mecanismo-de-avance-diffie-hellman">Identificadores de etiquetas y de claves del DH Ratchet (mecanismo de avance Diffie-Hellman)</h3>
<p><strong>Conjunto de etiquetas inicial</strong> (tras el handshake): - ID del conjunto de etiquetas: 0 - Aún no se han enviado bloques NextKey (siguiente clave) - No se han asignado IDs de clave</p>
<p><strong>Después del primer Ratchet (mecanismo de trinquete criptográfico)</strong>: - ID del conjunto de etiquetas: 1 = (1 + ID de clave de Alice + ID de clave de Bob) = (1 + 0 + 0) - Alice envía NextKey con ID de clave 0 - Bob responde con NextKey con ID de clave 0</p>
<p><strong>Conjuntos de etiquetas posteriores</strong>: - ID del conjunto de etiquetas = 1 + ID de la clave del emisor + ID de la clave del receptor - Ejemplo: Conjunto de etiquetas 5 = (1 + sender_key_2 + receiver_key_2)</p>
<p><strong>Tabla de progresión del conjunto de etiquetas:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Tag Set ID</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Sender Key ID</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Receiver Key ID</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">n/a</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">n/a</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial tag set (post-NSR)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">First ratchet (both generate new keys)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Sender generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">3</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Receiver generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">4</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Sender generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">5</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Receiver generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">...</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">...</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">...</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Pattern repeats</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">65534</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32767 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32766</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Second-to-last tag set</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">65535</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32767</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32767 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Final tag set</td>
    </tr>
  </tbody>
</table>
\* = Nueva clave generada en este ratchet (mecanismo de actualización de claves criptográficas)
<p><strong>Reglas del ID de clave:</strong> - Los ID son secuenciales a partir de 0 - Los ID se incrementan solo cuando se genera una nueva clave - El ID de clave máximo es 32767 (15 bits) - Después del ID de clave 32767, se requiere una nueva sesión</p>
<h3 id="flujo-de-mensajes-de-dh-ratchet-mecanismo-de-avance-criptográfico-diffie-hellman">Flujo de mensajes de DH Ratchet (mecanismo de avance criptográfico Diffie-Hellman)</h3>
<p><strong>Roles:</strong> - <strong>Remitente de etiquetas</strong>: Posee el conjunto de etiquetas de salida, envía mensajes - <strong>Receptor de etiquetas</strong>: Posee el conjunto de etiquetas de entrada, recibe mensajes</p>
<p><strong>Patrón:</strong> El emisor de etiquetas inicia el ratchet (mecanismo de avance criptográfico) cuando el conjunto de etiquetas está a punto de agotarse.</p>
<p><strong>Diagrama de flujo de mensajes:</strong></p>
<pre tabindex="0"><code>Tag Sender                         Tag Receiver

       ... using tag set #0 ...

(Tag set #0 approaching exhaustion)
(Generate new key #0)

NextKey forward, request reverse, with key #0  --------&gt;
(Repeat until NextKey ACK received)
                                   (Generate new key #0)
                                   (Perform DH: sender_key_0 × receiver_key_0)
                                   (Create inbound tag set #1)

        &lt;---------------           NextKey reverse, with key #0
                                   (Repeat until tag from tag set #1 received)

(Receive NextKey with key #0)
(Perform DH: sender_key_0 × receiver_key_0)
(Create outbound tag set #1)


       ... using tag set #1 ...


(Tag set #1 approaching exhaustion)
(Generate new key #1)

NextKey forward, with key #1        --------&gt;
(Repeat until NextKey ACK received)
                                   (Reuse existing key #0)
                                   (Perform DH: sender_key_1 × receiver_key_0)
                                   (Create inbound tag set #2)

        &lt;--------------            NextKey reverse, id 0 (ACK)
                                   (Repeat until tag from tag set #2 received)

(Receive NextKey with id 0)
(Perform DH: sender_key_1 × receiver_key_0)
(Create outbound tag set #2)


       ... using tag set #2 ...


(Tag set #2 approaching exhaustion)
(Reuse existing key #1)

NextKey forward, request reverse, id 1  --------&gt;
(Repeat until NextKey received)
                                   (Generate new key #1)
                                   (Perform DH: sender_key_1 × receiver_key_1)
                                   (Create inbound tag set #3)

        &lt;--------------            NextKey reverse, with key #1

(Receive NextKey with key #1)
(Perform DH: sender_key_1 × receiver_key_1)
(Create outbound tag set #3)


       ... using tag set #3 ...

       (Pattern repeats: even-numbered tag sets
        use forward key, odd-numbered use reverse key)
</code></pre><p><strong>Patrones de Ratchet (mecanismo de trinquete):</strong></p>
<p><strong>Creación de Tag Sets (conjuntos de etiquetas) de número par</strong> (2, 4, 6, &hellip;): 1. El emisor genera una nueva clave 2. El emisor envía un NextKey block (bloque NextKey) con la nueva clave 3. El receptor envía un NextKey block con el ID de la clave antigua (ACK, acuse de recibo) 4. Ambos realizan DH (Diffie-Hellman) con (nueva clave del emisor × clave antigua del receptor)</p>
<p><strong>Creación de conjuntos de etiquetas con numeración impar</strong> (3, 5, 7, &hellip;): 1. El remitente solicita la clave inversa (envía NextKey (siguiente clave) con el indicador de solicitud) 2. El receptor genera una nueva clave 3. El receptor envía un bloque NextKey con la nueva clave 4. Ambos realizan Diffie-Hellman (DH) con (clave antigua del remitente × clave nueva del receptor)</p>
<h3 id="formato-del-bloque-nextkey-siguiente-clave">Formato del bloque NextKey (siguiente clave)</h3>
<p>Consulte la sección Formato de la carga útil para obtener la especificación detallada del bloque NextKey (siguiente clave).</p>
<p><strong>Elementos clave:</strong> - <strong>Byte de indicadores</strong>:   - Bit 0: Clave presente (1) o solo ID (0)   - Bit 1: Clave inversa (1) o clave directa (0)   - Bit 2: Solicitar clave inversa (1) o sin solicitud (0) - <strong>ID de clave</strong>: 2 bytes, big-endian (0-32767) - <strong>Clave pública</strong>: 32 bytes X25519 (si el bit 0 = 1)</p>
<p><strong>Ejemplos de bloques NextKey (siguiente clave):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Sender initiates ratchet with new key (key ID 0, tag set 1)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, pubkey<span style="color:#f92672">=</span>sender_key_0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver replies with new key (key ID 0, tag set 1)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, pubkey<span style="color:#f92672">=</span>receiver_key_0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sender ratchets again with new key (key ID 1, tag set 2)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, pubkey<span style="color:#f92672">=</span>sender_key_1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver ACKs with old key ID (tag set 2)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x02</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sender requests reverse key (tag set 3)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x04</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver sends new reverse key (key ID 1, tag set 3)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, pubkey<span style="color:#f92672">=</span>receiver_key_1)
</span></span></code></pre></div><h3 id="kdf-función-de-derivación-de-claves-del-dh-ratchet-mecanismo-de-trinquete">KDF (función de derivación de claves) del DH Ratchet (mecanismo de trinquete)</h3>
<p>Cuando se intercambian nuevas claves:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Tag sender generates or reuses key</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> generating_new:
</span></span><span style="display:flex;"><span>    sender_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    sender_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(sender_sk)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Reuse existing key pair</span>
</span></span><span style="display:flex;"><span>    sender_pk <span style="color:#f92672">=</span> existing_sender_pk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag receiver generates or reuses key</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> generating_new:
</span></span><span style="display:flex;"><span>    receiver_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    receiver_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(receiver_sk)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Reuse existing key pair</span>
</span></span><span style="display:flex;"><span>    receiver_pk <span style="color:#f92672">=</span> existing_receiver_pk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Both parties perform DH</span>
</span></span><span style="display:flex;"><span>sharedSecret <span style="color:#f92672">=</span> DH(sender_sk, receiver_pk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive tagset key</span>
</span></span><span style="display:flex;"><span>tagsetKey <span style="color:#f92672">=</span> HKDF(sharedSecret, ZEROLEN, <span style="color:#e6db74">&#34;XDHRatchetTagSet&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get next root key from previous tagset</span>
</span></span><span style="display:flex;"><span>rootKey <span style="color:#f92672">=</span> previous_tagset<span style="color:#f92672">.</span>nextRootKey
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize new tagset</span>
</span></span><span style="display:flex;"><span>new_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(rootKey, tagsetKey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag sender: outbound tagset</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag receiver: inbound tagset</span>
</span></span></code></pre></div><p><strong>Temporización crítica:</strong></p>
<p><strong>Remitente de etiquetas:</strong> - Crea un nuevo conjunto de etiquetas salientes de inmediato - Comienza a usar las nuevas etiquetas de inmediato - Elimina el conjunto de etiquetas salientes antiguo</p>
<p><strong>Receptor de etiquetas:</strong> - Crea un nuevo conjunto de etiquetas entrantes - Conserva el conjunto de etiquetas entrantes anterior durante el período de gracia (3 minutos) - Acepta etiquetas de ambos conjuntos, el antiguo y el nuevo, durante el período de gracia - Elimina el conjunto de etiquetas entrantes anterior tras el período de gracia</p>
<h3 id="gestión-del-estado-de-dh-ratchet-mecanismo-de-avance-de-diffie-hellman">Gestión del estado de DH Ratchet (mecanismo de avance de Diffie-Hellman)</h3>
<p><strong>Estado del remitente:</strong> - Conjunto de etiquetas salientes actual - ID del conjunto de etiquetas e IDs de claves - Siguiente clave raíz (para el próximo ratchet (mecanismo de avance criptográfico)) - Número de mensajes en el conjunto de etiquetas actual</p>
<p><strong>Estado del receptor:</strong> - Conjunto(s) actual(es) de etiquetas entrantes (puede haber 2 durante el período de gracia) - Números de mensajes anteriores (PN) para la detección de huecos - Ventana de anticipación de etiquetas pre-generadas - Siguiente clave raíz (para el siguiente ratchet, mecanismo de avance criptográfico)</p>
<p><strong>Reglas de transición de estado:</strong></p>
<ol>
<li>
<p><strong>Antes del primer Ratchet (mecanismo de avance criptográfico)</strong>:</p>
<ul>
<li>Usando el conjunto de etiquetas 0 (de NSR)</li>
<li>No hay identificadores de clave asignados</li>
</ul>
</li>
<li>
<p><strong>Iniciando Ratchet (mecanismo de avance criptográfico)</strong>:</p>
<ul>
<li>Generar nueva clave (si en esta ronda le toca generar al remitente)</li>
<li>Enviar el bloque NextKey en el mensaje ES</li>
<li>Esperar la respuesta de NextKey antes de crear un nuevo conjunto de etiquetas de salida</li>
</ul>
</li>
<li>
<p><strong>Recepción de una solicitud de Ratchet (mecanismo de avance criptográfico)</strong>:</p>
<ul>
<li>Generar una nueva clave (si el receptor está generando en esta ronda)</li>
<li>Realizar DH (Diffie-Hellman) con la clave recibida</li>
<li>Crear un nuevo conjunto de etiquetas de entrada</li>
<li>Enviar NextKey reply (respuesta NextKey)</li>
<li>Conservar el conjunto de etiquetas de entrada anterior durante un período de gracia</li>
</ul>
</li>
<li>
<p><strong>Completar Ratchet (mecanismo de actualización de claves)</strong>:</p>
<ul>
<li>Recibir la respuesta NextKey</li>
<li>Realizar DH</li>
<li>Crear un nuevo conjunto de etiquetas de salida</li>
<li>Comenzar a usar las nuevas etiquetas</li>
</ul>
</li>
</ol>
<h3 id="ratchet-de-etiquetas-de-sesión-mecanismo-de-avance-criptográfico">Ratchet de etiquetas de sesión (mecanismo de avance criptográfico)</h3>
<p>El session tag ratchet (mecanismo de avance criptográfico para etiquetas de sesión) genera session tags de 8 bytes de un solo uso de forma determinista.</p>
<h3 id="propósito-del-session-tag-ratchet-mecanismo-de-avance-criptográfico-para-etiquetas-de-sesión">Propósito del Session Tag Ratchet (mecanismo de avance criptográfico para etiquetas de sesión)</h3>
<ul>
<li>Sustituye la transmisión explícita de etiquetas (ElGamal enviaba etiquetas de 32 bytes)</li>
<li>Permite al receptor pre-generar etiquetas para una ventana de anticipación</li>
<li>El emisor las genera bajo demanda (no requiere almacenamiento)</li>
<li>Se sincroniza con el ratchet (mecanismo de avance) de clave simétrica mediante un índice</li>
</ul>
<h3 id="fórmula-del-ratchet-mecanismo-de-avance-tipo-trinquete-de-etiquetas-de-sesión">Fórmula del ratchet (mecanismo de avance tipo trinquete) de etiquetas de sesión</h3>
<p><strong>Inicialización:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># From DH_INITIALIZE</span>
</span></span><span style="display:flex;"><span>sessTag_ck <span style="color:#f92672">=</span> initial_chain_key  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize session tag ratchet</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(sessTag_ck, ZEROLEN, <span style="color:#e6db74">&#34;STInitialization&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># First chain key</span>
</span></span><span style="display:flex;"><span>SESSTAG_CONSTANT <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]   <span style="color:#75715e"># Constant for all tags in this tagset</span>
</span></span></code></pre></div><p><strong>Generación de etiqueta (para la etiqueta N):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate tag N</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(sessTag_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Chain key for next tag</span>
</span></span><span style="display:flex;"><span>tag_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]              <span style="color:#75715e"># Session tag (8 bytes)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Chain continues for each tag</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tag_0, tag_1, tag_2, ..., tag_65535</span>
</span></span></code></pre></div><p><strong>Secuencia completa:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Tag 0</span>
</span></span><span style="display:flex;"><span>keydata_0 <span style="color:#f92672">=</span> HKDF(sessTag_chainKey, SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>tag_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag 1</span>
</span></span><span style="display:flex;"><span>keydata_1 <span style="color:#f92672">=</span> HKDF(sessTag_chainKey_0, SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>tag_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag N</span>
</span></span><span style="display:flex;"><span>keydata_N <span style="color:#f92672">=</span> HKDF(sessTag_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>tag_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span></code></pre></div><h3 id="implementación-del-emisor-de-session-tag-ratchet-mecanismo-de-avance-criptográfico-de-etiquetas-de-sesión">Implementación del emisor de Session Tag Ratchet (mecanismo de avance criptográfico de etiquetas de sesión)</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundTagset</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, sessTag_ck):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(sessTag_ck, ZEROLEN, <span style="color:#e6db74">&#34;STInitialization&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>constant <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_next_tag</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Increment index</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">65535</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> TagsetExhausted(<span style="color:#e6db74">&#34;Ratchet required&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate tag</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, self<span style="color:#f92672">.</span>constant, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (tag, self<span style="color:#f92672">.</span>index)
</span></span></code></pre></div><p><strong>Proceso del emisor:</strong> 1. Llamar a <code>get_next_tag()</code> para cada mensaje 2. Usar la etiqueta devuelta en el mensaje ES 3. Almacenar el índice N para un posible seguimiento de ACK (confirmación de recepción) 4. No es necesario almacenar la etiqueta (se genera bajo demanda)</p>
<h3 id="implementación-del-receptor-de-session-tag-ratchet">Implementación del receptor de Session Tag Ratchet</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundTagset</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, sessTag_ck, look_ahead<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(sessTag_ck, ZEROLEN, <span style="color:#e6db74">&#34;STInitialization&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>constant <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">=</span> look_ahead
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tags <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Dictionary: tag -&gt; index</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Pre-generate initial tags</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>extend(look_ahead)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extend</span>(self, count):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Generate &#39;count&#39; more tags&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(count):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">65535</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>  <span style="color:#75715e"># Cannot exceed maximum</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Generate tag</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, self<span style="color:#f92672">.</span>constant, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            tag <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Store tag</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>tags[tag] <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>index
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lookup_tag</span>(self, tag):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Look up tag and return index&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> tag <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>tags:
</span></span><span style="display:flex;"><span>            index <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>tags[tag]
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Remove tag (one-time use)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>tags[tag]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> index
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_and_extend</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Extend if tag count is low&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        current_count <span style="color:#f92672">=</span> len(self<span style="color:#f92672">.</span>tags)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> current_count <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Extend to restore window</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>extend(self<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">-</span> current_count)
</span></span></code></pre></div><p><strong>Proceso del receptor:</strong> 1. Pre-generar etiquetas para la ventana de anticipación (p. ej., 32 etiquetas) 2. Almacenar las etiquetas en una tabla hash o diccionario 3. Cuando llegue el mensaje, consultar la etiqueta para obtener el índice N 4. Eliminar la etiqueta del almacenamiento (uso único) 5. Ampliar la ventana si el recuento de etiquetas cae por debajo del umbral</p>
<h3 id="estrategia-de-anticipación-de-etiquetas-de-sesión">Estrategia de anticipación de etiquetas de sesión</h3>
<p><strong>Propósito</strong>: Equilibrar el uso de memoria frente al manejo de mensajes fuera de orden</p>
<p><strong>Tamaños de anticipación recomendados:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Tagset Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Initial Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Maximum Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">12</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">12</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Short-lived</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">24</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">160</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial ES tagset</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 1+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">160</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">160</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Ratcheted tagsets</td>
    </tr>
  </tbody>
</table>
**Anticipación adaptativa:**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Dynamic look-ahead based on highest tag received</span>
</span></span><span style="display:flex;"><span>look_ahead <span style="color:#f92672">=</span> min(tsmax, tsmin <span style="color:#f92672">+</span> N <span style="color:#f92672">//</span> <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Example:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tsmin = 24, tsmax = 160</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 0:   look_ahead = min(160, 24 + 0/4) = 24</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 100: look_ahead = min(160, 24 + 100/4) = 49</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 500: look_ahead = min(160, 24 + 500/4) = 149</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 544: look_ahead = min(160, 24 + 544/4) = 160</span>
</span></span></code></pre></div><p><strong>Recortar por detrás:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Trim tags far behind highest received</span>
</span></span><span style="display:flex;"><span>trim_behind <span style="color:#f92672">=</span> look_ahead <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If highest received tag is N=100, trim tags below N=50</span>
</span></span></code></pre></div><p><strong>Cálculo de memoria:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Per tag: 8 bytes (tag) + 2 bytes (index) + overhead ≈ 16 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Look-ahead of 160 tags ≈ 2.5 KB per inbound tagset</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># With multiple sessions:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 100 inbound sessions × 2.5 KB = 250 KB total</span>
</span></span></code></pre></div><h3 id="manejo-de-etiquetas-de-sesión-fuera-de-orden">Manejo de etiquetas de sesión fuera de orden</h3>
<p><strong>Escenario</strong>: Los mensajes llegan fuera de orden</p>
<pre tabindex="0"><code>Expected: tag_5, tag_6, tag_7, tag_8
Received: tag_5, tag_7, tag_6, tag_8
</code></pre><p><strong>Comportamiento del receptor:</strong></p>
<ol>
<li>
<p>Recibir tag_5:</p>
<ul>
<li>Buscar: encontrado en el índice 5</li>
<li>Procesar mensaje</li>
<li>Eliminar tag_5</li>
<li>Máximo recibido: 5</li>
</ul>
</li>
<li>
<p>Se recibe tag_7 (fuera de orden):</p>
<ul>
<li>Búsqueda: encontrado en el índice 7</li>
<li>Procesar el mensaje</li>
<li>Eliminar tag_7</li>
<li>Máximo recibido: 7</li>
<li>Nota: tag_6 sigue en almacenamiento (aún no se ha recibido)</li>
</ul>
</li>
<li>
<p>Recibir tag_6 (retrasado):</p>
<ul>
<li>Buscar: encontrado en el índice 6</li>
<li>Procesar mensaje</li>
<li>Eliminar tag_6</li>
<li>Máximo recibido: 7 (sin cambios)</li>
</ul>
</li>
<li>
<p>Recibir tag_8:</p>
<ul>
<li>Buscar: encontrado en el índice 8</li>
<li>Procesar mensaje</li>
<li>Eliminar tag_8</li>
<li>Máximo recibido: 8</li>
</ul>
</li>
</ol>
<p><strong>Mantenimiento de la ventana:</strong> - Llevar un registro del índice más alto recibido - Mantener una lista de índices faltantes (gaps, huecos) - Ampliar la ventana en función del índice más alto - Opcional: Expirar los huecos antiguos tras un tiempo de espera</p>
<h3 id="ratchet-de-clave-simétrica-mecanismo-de-rotación-progresiva-de-claves-simétricas">Ratchet de clave simétrica (mecanismo de rotación progresiva de claves simétricas)</h3>
<p>El symmetric key ratchet (mecanismo de avance de clave simétrica) genera claves de cifrado de 32 bytes sincronizadas con etiquetas de sesión.</p>
<h3 id="propósito-del-symmetric-key-ratchet-mecanismo-de-avance-de-clave-simétrica">Propósito del Symmetric Key Ratchet (mecanismo de avance de clave simétrica)</h3>
<ul>
<li>Proporciona una clave de cifrado única para cada mensaje</li>
<li>Sincronizado con session tag ratchet (mecanismo de avance de etiquetas de sesión) (mismo índice)</li>
<li>El emisor puede generarla bajo demanda</li>
<li>El receptor puede aplazar la generación hasta que se reciba la etiqueta</li>
</ul>
<h3 id="fórmula-del-symmetric-key-ratchet-mecanismo-de-trinquete-de-clave-simétrica">Fórmula del Symmetric Key Ratchet (mecanismo de trinquete de clave simétrica)</h3>
<p><strong>Inicialización:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># From DH_INITIALIZE</span>
</span></span><span style="display:flex;"><span>symmKey_ck <span style="color:#f92672">=</span> initial_chain_key  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># No additional initialization needed</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Unlike session tag ratchet, no constant is derived</span>
</span></span></code></pre></div><p><strong>Generación de la clave (para la clave N):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate key N</span>
</span></span><span style="display:flex;"><span>SYMMKEY_CONSTANT <span style="color:#f92672">=</span> ZEROLEN  <span style="color:#75715e"># Empty string</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(symmKey_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), SYMMKEY_CONSTANT, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Chain key for next key</span>
</span></span><span style="display:flex;"><span>key_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]              <span style="color:#75715e"># Session key (32 bytes)</span>
</span></span></code></pre></div><p><strong>Secuencia completa:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Key 0</span>
</span></span><span style="display:flex;"><span>keydata_0 <span style="color:#f92672">=</span> HKDF(symmKey_ck, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>key_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Key 1</span>
</span></span><span style="display:flex;"><span>keydata_1 <span style="color:#f92672">=</span> HKDF(symmKey_chainKey_0, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>key_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Key N</span>
</span></span><span style="display:flex;"><span>keydata_N <span style="color:#f92672">=</span> HKDF(symmKey_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>key_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span></code></pre></div><h3 id="implementación-del-emisor-de-symmetric-key-ratchet-trinquete-de-clave-simétrica">Implementación del emisor de Symmetric Key Ratchet (trinquete de clave simétrica)</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Generate key for specific index&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Fast-forward to desired index if needed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&lt;</span> index:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">==</span> index:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Should not reach here if called correctly</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Key already generated&#34;</span>)
</span></span></code></pre></div><p><strong>Proceso del emisor:</strong> 1. Obtener la siguiente etiqueta y su índice N 2. Generar la clave para el índice N 3. Usar la clave para cifrar el mensaje 4. No se requiere almacenamiento de claves</p>
<h3 id="implementación-del-receptor-del-symmetric-key-ratchet-mecanismo-de-avance-de-clave-simétrica">Implementación del receptor del Symmetric Key Ratchet (mecanismo de avance de clave simétrica)</h3>
<p><strong>Estrategia 1: Generación diferida (Recomendado)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cache <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Optional: cache recently used keys</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Generate key for specific index&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check cache first (optional optimization)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>cache:
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cache[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>cache[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> key
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Fast-forward to desired index</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&lt;</span> index:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">==</span> index:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Index already passed&#34;</span>)
</span></span></code></pre></div><p><strong>Proceso de generación diferida:</strong> 1. Recibir ES message (mensaje ES) con etiqueta 2. Consultar la etiqueta para obtener el índice N 3. Generar las claves de 0 a N (si aún no se han generado) 4. Usar la clave N para descifrar el mensaje 5. La clave de cadena ahora se encuentra en el índice N</p>
<p><strong>Ventajas:</strong> - Uso mínimo de memoria - Claves generadas solo cuando se necesitan - Implementación simple</p>
<p><strong>Desventajas:</strong> - Debe generar todas las claves de 0 a N la primera vez que se use - No puede procesar mensajes fuera de orden sin almacenamiento en caché</p>
<p><strong>Estrategia 2: Pregeneración con ventana de etiquetas (Alternativa)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>keys <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Dictionary: index -&gt; key</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extend</span>(self, count):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Pre-generate &#39;count&#39; more keys&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(count):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>keys[self<span style="color:#f92672">.</span>index] <span style="color:#f92672">=</span> key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Retrieve pre-generated key&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>keys:
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>keys[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>keys[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> key
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><p><strong>Proceso de pre-generación:</strong> 1. Pre-generar claves que coincidan con la ventana de etiquetas (p. ej., 32 claves) 2. Almacenar las claves indexadas por número de mensaje 3. Cuando se reciba la etiqueta, buscar la clave correspondiente 4. Ampliar la ventana a medida que se utilicen las etiquetas</p>
<p><strong>Ventajas:</strong> - Maneja mensajes fuera de orden de forma natural - Recuperación rápida de claves (sin demora de generación)</p>
<p><strong>Desventajas:</strong> - Mayor uso de memoria (32 bytes por clave frente a 8 bytes por etiqueta) - Es necesario mantener las claves sincronizadas con las etiquetas</p>
<p><strong>Comparación de memoria:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Look-ahead of 160:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags only:  160 × 16 bytes = 2.5 KB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags+Keys:  160 × (16 + 32) bytes = 7.5 KB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For 100 sessions:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags only:  250 KB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags+Keys:  750 KB</span>
</span></span></code></pre></div><h3 id="sincronización-del-ratchet-mecanismo-de-avance-criptográfico-simétrico-con-etiquetas-de-sesión">Sincronización del Ratchet (mecanismo de avance criptográfico) simétrico con etiquetas de sesión</h3>
<p><strong>Requisito crítico</strong>: El índice de etiqueta de sesión DEBE ser igual al índice de clave simétrica</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Sender</span>
</span></span><span style="display:flex;"><span>tag, index <span style="color:#f92672">=</span> outbound_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> outbound_keyratchet<span style="color:#f92672">.</span>get_key(index)  <span style="color:#75715e"># Same index</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, payload, tag)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> inbound_tagset<span style="color:#f92672">.</span>lookup_tag(tag)
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> inbound_keyratchet<span style="color:#f92672">.</span>get_key(index)  <span style="color:#75715e"># Same index</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>plaintext <span style="color:#f92672">=</span> DECRYPT(key, nonce, ciphertext, tag)
</span></span></code></pre></div><p><strong>Modos de fallo:</strong></p>
<p>Si falla la sincronización: - Clave incorrecta utilizada para el descifrado - La verificación de MAC falla - Mensaje rechazado</p>
<p><strong>Prevención:</strong> - Usa siempre el mismo índice para la etiqueta y la clave - Nunca omitas índices en ninguno de los ratchets (mecanismo de actualización criptográfica) - Gestiona con cuidado los mensajes fuera de orden</p>
<h3 id="construcción-del-nonce-del-trinquete-simétrico">Construcción del nonce del trinquete simétrico</h3>
<p>El Nonce (número aleatorio de un solo uso) se deriva del número de mensaje:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">construct_nonce</span>(index):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Construct 12-byte nonce for ChaCha20-Poly1305
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        index: Message number (0-65535)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        nonce: 12-byte nonce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># First 4 bytes are always zero</span>
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> bytearray(<span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>    nonce[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00\x00\x00\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Last 8 bytes are little-endian message number</span>
</span></span><span style="display:flex;"><span>    nonce[<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> index<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">8</span>, byteorder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> bytes(nonce)
</span></span></code></pre></div><p><strong>Ejemplos:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>:     nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> <span style="color:#ae81ff">0000000000000000</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>:     nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> <span style="color:#ae81ff">0100000000000000</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>:   nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> FF00000000000000
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span>:   nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> <span style="color:#ae81ff">0001000000000000</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">65535</span>: nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> FFFF000000000000
</span></span></code></pre></div><p><strong>Propiedades importantes:</strong> - Los Nonces (valores únicos usados una vez) son únicos para cada mensaje en un conjunto de etiquetas - Los Nonces nunca se repiten (las etiquetas de un solo uso lo garantizan) - El contador de 8 bytes permite 2^64 mensajes (solo usamos 2^16) - El formato del Nonce coincide con la construcción basada en contador de la RFC 7539</p>
<hr>
<h2 id="gestión-de-sesiones">Gestión de sesiones</h2>
<h3 id="contexto-de-sesión">Contexto de sesión</h3>
<p>Todas las sesiones entrantes y salientes deben pertenecer a un contexto específico:</p>
<ol>
<li><strong>Contexto del router</strong>: Sesiones para el propio router</li>
<li><strong>Contexto de destino</strong>: Sesiones para un destino local específico (aplicación cliente)</li>
</ol>
<p><strong>Regla crítica</strong>: Las sesiones NO DEBEN compartirse entre contextos para evitar ataques de correlación.</p>
<p><strong>Implementación:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SessionKeyManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Context for managing sessions (router or destination)&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, context_id):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>context_id <span style="color:#f92672">=</span> context_id
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions <span style="color:#f92672">=</span> {}   <span style="color:#75715e"># far_end_dest -&gt; [sessions]</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_sessions <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># far_end_dest -&gt; session</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>static_keypair <span style="color:#f92672">=</span> generate_keypair()  <span style="color:#75715e"># Context&#39;s identity</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_outbound_session</span>(self, destination):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get or create outbound session to destination&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> destination <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>outbound_sessions:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>outbound_sessions[destination] <span style="color:#f92672">=</span> create_outbound_session(destination)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>outbound_sessions[destination]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_inbound_session</span>(self, session, destination<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Add inbound session, optionally bound to destination&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> destination:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> destination <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>inbound_sessions:
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>inbound_sessions[destination] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>inbound_sessions[destination]<span style="color:#f92672">.</span>append(session)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Unbound session</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>inbound_sessions[<span style="color:#66d9ef">None</span>]<span style="color:#f92672">.</span>append(session)
</span></span></code></pre></div><p><strong>Implementación de I2P en Java:</strong></p>
<p>En Java I2P, la clase <code>SessionKeyManager</code> (gestor de claves de sesión) proporciona esta funcionalidad: - Un <code>SessionKeyManager</code> por router - Un <code>SessionKeyManager</code> por destino local - Gestión separada de las sesiones ECIES y ElGamal dentro de cada contexto</p>
<h3 id="vinculación-de-sesión">Vinculación de sesión</h3>
<p><strong>Vinculación</strong> asocia una sesión con un destino remoto específico.</p>
<h3 id="sesiones-vinculadas">Sesiones vinculadas</h3>
<p><strong>Características:</strong> - Incluir la clave estática del remitente en el mensaje NS - El destinatario puede identificar el destino del remitente - Permite comunicación bidireccional - Una sola sesión saliente por destino - Puede tener varias sesiones entrantes (durante transiciones)</p>
<p><strong>Casos de uso:</strong> - Conexiones de streaming (similar a TCP) - Datagramas con posibilidad de respuesta - Cualquier protocolo que requiera solicitud/respuesta</p>
<p><strong>Proceso de vinculación:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Alice creates bound outbound session</span>
</span></span><span style="display:flex;"><span>outbound_session <span style="color:#f92672">=</span> OutboundSession(
</span></span><span style="display:flex;"><span>    destination<span style="color:#f92672">=</span>bob_destination,
</span></span><span style="display:flex;"><span>    static_key<span style="color:#f92672">=</span>alice_static_key,
</span></span><span style="display:flex;"><span>    bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Alice sends NS with static key</span>
</span></span><span style="display:flex;"><span>ns_message <span style="color:#f92672">=</span> build_ns_message(
</span></span><span style="display:flex;"><span>    ephemeral_key<span style="color:#f92672">=</span>alice_ephemeral_key,
</span></span><span style="display:flex;"><span>    static_key<span style="color:#f92672">=</span>alice_static_key,  <span style="color:#75715e"># Included for binding</span>
</span></span><span style="display:flex;"><span>    payload<span style="color:#f92672">=</span>data
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob receives NS</span>
</span></span><span style="display:flex;"><span>bob_receives_ns(ns_message)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob extracts Alice&#39;s static key</span>
</span></span><span style="display:flex;"><span>alice_static_key <span style="color:#f92672">=</span> decrypt_static_key_section(ns_message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob looks up Alice&#39;s destination (from bundled LeaseSet)</span>
</span></span><span style="display:flex;"><span>alice_destination <span style="color:#f92672">=</span> lookup_destination_by_static_key(alice_static_key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob creates bound inbound session</span>
</span></span><span style="display:flex;"><span>inbound_session <span style="color:#f92672">=</span> InboundSession(
</span></span><span style="display:flex;"><span>    destination<span style="color:#f92672">=</span>alice_destination,
</span></span><span style="display:flex;"><span>    bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob pairs with outbound session</span>
</span></span><span style="display:flex;"><span>outbound_session <span style="color:#f92672">=</span> OutboundSession(
</span></span><span style="display:flex;"><span>    destination<span style="color:#f92672">=</span>alice_destination,
</span></span><span style="display:flex;"><span>    bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>Beneficios:</strong> 1. <strong>Ephemeral-Ephemeral DH</strong> (Diffie-Hellman efímero-efímero): La respuesta usa ee DH (secreto perfecto hacia adelante) 2. <strong>Continuidad de sesión</strong>: Ratchets (mecanismos de avance criptográfico) mantienen la vinculación con el mismo destino 3. <strong>Seguridad</strong>: Evita el secuestro de sesión (autenticado por clave estática) 4. <strong>Eficiencia</strong>: Una sola sesión por destino (sin duplicación)</p>
<h3 id="sesiones-no-vinculadas">Sesiones no vinculadas</h3>
<p><strong>Características:</strong> - No hay clave estática en el mensaje NS (la sección de indicadores está compuesta únicamente por ceros) - El destinatario no puede identificar al remitente - Comunicación unidireccional únicamente - Se permiten múltiples sesiones hacia el mismo destino</p>
<p><strong>Casos de uso:</strong> - Datagramas sin formato (enviar y olvidar) - Publicación anónima - Mensajería estilo broadcast (difusión a todos los destinatarios)</p>
<p><strong>Propiedades:</strong> - Más anónimo (sin identificación del remitente) - Más eficiente (1 DH (Diffie-Hellman) vs 2 DH en el handshake) - No es posible responder (el destinatario no sabe dónde responder) - Sin session ratcheting (uso único o limitado)</p>
<h3 id="emparejamiento-de-sesiones">Emparejamiento de sesiones</h3>
<p><strong>Emparejamiento</strong> conecta una sesión entrante con una sesión saliente para comunicación bidireccional.</p>
<h3 id="creación-de-sesiones-emparejadas">Creación de sesiones emparejadas</h3>
<p><strong>Perspectiva de Alice (iniciadora):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Create outbound session to Bob</span>
</span></span><span style="display:flex;"><span>outbound_session <span style="color:#f92672">=</span> create_outbound_session(bob_destination)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create paired inbound session</span>
</span></span><span style="display:flex;"><span>inbound_session <span style="color:#f92672">=</span> create_inbound_session(
</span></span><span style="display:flex;"><span>    paired_with<span style="color:#f92672">=</span>outbound_session,
</span></span><span style="display:flex;"><span>    bound_to<span style="color:#f92672">=</span>bob_destination
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Link them</span>
</span></span><span style="display:flex;"><span>outbound_session<span style="color:#f92672">.</span>paired_inbound <span style="color:#f92672">=</span> inbound_session
</span></span><span style="display:flex;"><span>inbound_session<span style="color:#f92672">.</span>paired_outbound <span style="color:#f92672">=</span> outbound_session
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send NS message</span>
</span></span><span style="display:flex;"><span>send_ns_message(outbound_session, payload)
</span></span></code></pre></div><p><strong>Perspectiva de Bob (receptor):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Receive NS message</span>
</span></span><span style="display:flex;"><span>ns_message <span style="color:#f92672">=</span> receive_ns_message()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create inbound session</span>
</span></span><span style="display:flex;"><span>inbound_session <span style="color:#f92672">=</span> create_inbound_session_from_ns(ns_message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If NS contains static key (bound):</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ns_message<span style="color:#f92672">.</span>has_static_key():
</span></span><span style="display:flex;"><span>    alice_destination <span style="color:#f92672">=</span> extract_destination(ns_message)
</span></span><span style="display:flex;"><span>    inbound_session<span style="color:#f92672">.</span>bind_to(alice_destination)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create paired outbound session</span>
</span></span><span style="display:flex;"><span>    outbound_session <span style="color:#f92672">=</span> create_outbound_session(alice_destination)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Link them</span>
</span></span><span style="display:flex;"><span>    outbound_session<span style="color:#f92672">.</span>paired_inbound <span style="color:#f92672">=</span> inbound_session
</span></span><span style="display:flex;"><span>    inbound_session<span style="color:#f92672">.</span>paired_outbound <span style="color:#f92672">=</span> outbound_session
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send NSR</span>
</span></span><span style="display:flex;"><span>send_nsr_message(inbound_session, outbound_session, payload)
</span></span></code></pre></div><h3 id="beneficios-del-emparejamiento-de-sesiones">Beneficios del emparejamiento de sesiones</h3>
<ol>
<li><strong>ACKs en banda</strong>: Se pueden confirmar mensajes sin un clove separado (clove: submensaje encapsulado)</li>
<li><strong>Ratcheting eficiente (mecanismo criptográfico de avance &ldquo;ratchet&rdquo;)</strong>: Ambas direcciones avanzan el ratchet conjuntamente</li>
<li><strong>Control de flujo</strong>: Se puede implementar contrapresión a través de sesiones emparejadas</li>
<li><strong>Consistencia del estado</strong>: Más fácil mantener el estado sincronizado</li>
</ol>
<h3 id="reglas-de-emparejamiento-de-sesiones">Reglas de emparejamiento de sesiones</h3>
<ul>
<li>La sesión saliente puede estar no emparejada (NS no vinculado)</li>
<li>La sesión entrante para un NS vinculado debería estar emparejada</li>
<li>El emparejamiento ocurre al crear la sesión, no después</li>
<li>Las sesiones emparejadas tienen la misma vinculación de destino</li>
<li>Los ratchets (mecanismos de avance criptográfico) ocurren de forma independiente pero están coordinados</li>
</ul>
<h3 id="ciclo-de-vida-de-la-sesión">Ciclo de vida de la sesión</h3>
<h3 id="ciclo-de-vida-de-la-sesión-fase-de-creación">Ciclo de vida de la sesión: fase de creación</h3>
<p><strong>Creación de sesión saliente (Alice):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_outbound_session</span>(destination, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> OutboundSession()
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> destination
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> bound
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>NEW
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate keys for NS message</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> bound:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>static_key <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Will be populated after NSR received</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> session
</span></span></code></pre></div><p><strong>Creación de sesión entrante (Bob):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_inbound_session_from_ns</span>(ns_message):
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> InboundSession()
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract from NS</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>remote_ephemeral_key <span style="color:#f92672">=</span> ns_message<span style="color:#f92672">.</span>ephemeral_key
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>remote_static_key <span style="color:#f92672">=</span> ns_message<span style="color:#f92672">.</span>static_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>remote_static_key:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> lookup_destination(session<span style="color:#f92672">.</span>remote_static_key)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate keys for NSR</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create tagsets from KDF</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> create_tagset_from_nsr()
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> create_tagset_from_nsr()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> session
</span></span></code></pre></div><h3 id="ciclo-de-vida-de-la-sesión-fase-activa">Ciclo de vida de la sesión: Fase activa</h3>
<p><strong>Transiciones de estado:</strong></p>
<pre tabindex="0"><code>NEW (outbound only)
  ↓
  NS sent
  ↓
PENDING_REPLY (outbound only)
  ↓
  NSR received
  ↓
ESTABLISHED
  ↓
  ES messages exchanged
  ↓
ESTABLISHED (ongoing)
  ↓
  (optional) RATCHETING
  ↓
ESTABLISHED
</code></pre><p><strong>Mantenimiento activo de la sesión:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">maintain_active_session</span>(session):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Update last activity time</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for ratchet needed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>needs_ratchet():
</span></span><span style="display:flex;"><span>        initiate_ratchet(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for incoming ratchet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> received_nextkey_block():
</span></span><span style="display:flex;"><span>        process_ratchet(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Trim old tags from inbound tagset</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>expire_old_tags()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check session health</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time() <span style="color:#f92672">&gt;</span> SESSION_TIMEOUT:
</span></span><span style="display:flex;"><span>        mark_session_idle(session)
</span></span></code></pre></div><h3 id="ciclo-de-vida-de-la-sesión-fase-de-expiración">Ciclo de vida de la sesión: fase de expiración</h3>
<p><strong>Valores de tiempo de espera de la sesión:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Session Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Sender Timeout</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Receiver Timeout</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Short-lived</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">8 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">10 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 1+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">8 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">10 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Ratcheted</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Old tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">After ratchet</td>
    </tr>
  </tbody>
</table>
**Lógica de expiración:**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_session_expiration</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> active_sessions:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Outbound session expiration (sender)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>is_outbound():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:  <span style="color:#75715e"># 8 minutes</span>
</span></span><span style="display:flex;"><span>                expire_outbound_session(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Inbound session expiration (receiver)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:  <span style="color:#75715e"># 10 minutes</span>
</span></span><span style="display:flex;"><span>                expire_inbound_session(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Old tagsets (after ratchet)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tagset <span style="color:#f92672">in</span> old_tagsets:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> tagset<span style="color:#f92672">.</span>age() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:  <span style="color:#75715e"># 3 minutes</span>
</span></span><span style="display:flex;"><span>            delete_tagset(tagset)
</span></span></code></pre></div><p><strong>Regla crítica</strong>: Las sesiones salientes DEBEN expirar antes que las sesiones entrantes para evitar la desincronización.</p>
<p><strong>Terminación ordenada:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">terminate_session</span>(session, reason<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send Termination block (if implemented)</span>
</span></span><span style="display:flex;"><span>    send_termination_block(session, reason)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Mark session for deletion</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>TERMINATED
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Keep session briefly for final messages</span>
</span></span><span style="display:flex;"><span>    schedule_deletion(session, delay<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>)  <span style="color:#75715e"># 30 seconds</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Notify paired session</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>paired_session:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>paired_session<span style="color:#f92672">.</span>mark_remote_terminated()
</span></span></code></pre></div><h3 id="múltiples-mensajes-ns">Múltiples mensajes NS</h3>
<p><strong>Escenario</strong>: El mensaje NS de Alice se pierde o se pierde la respuesta NSR.</p>
<p><strong>Comportamiento de Alice:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_messages_sent <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_ns_attempts <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_ns_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate new ephemeral key for each NS</span>
</span></span><span style="display:flex;"><span>        ephemeral_key <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        ns_message <span style="color:#f92672">=</span> build_ns_message(
</span></span><span style="display:flex;"><span>            ephemeral_key<span style="color:#f92672">=</span>ephemeral_key,
</span></span><span style="display:flex;"><span>            static_key<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>static_key,
</span></span><span style="display:flex;"><span>            payload<span style="color:#f92672">=</span>payload
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Store state for this NS</span>
</span></span><span style="display:flex;"><span>        ns_state <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;ephemeral_key&#39;</span>: ephemeral_key,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;chainkey&#39;</span>: compute_chainkey(ns_message),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;hash&#39;</span>: compute_hash(ns_message),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;tagset&#39;</span>: derive_nsr_tagset(ns_message),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;sent_time&#39;</span>: now()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_messages_sent<span style="color:#f92672">.</span>append(ns_state)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send message</span>
</span></span><span style="display:flex;"><span>        send_message(ns_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Set timer for retry</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>ns_timer:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> set_timer(<span style="color:#ae81ff">1.0</span>, self<span style="color:#f92672">.</span>on_ns_timeout)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_ns_timeout</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(self<span style="color:#f92672">.</span>ns_messages_sent) <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_ns_attempts:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Give up</span>
</span></span><span style="display:flex;"><span>            fail_session(<span style="color:#e6db74">&#34;No NSR received after </span><span style="color:#e6db74">{self.max_ns_attempts}</span><span style="color:#e6db74"> attempts&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Retry with new NS message</span>
</span></span><span style="display:flex;"><span>        send_ns_message(self<span style="color:#f92672">.</span>payload)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_nsr_received</span>(self, nsr_message):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Cancel timer</span>
</span></span><span style="display:flex;"><span>        cancel_timer(self<span style="color:#f92672">.</span>ns_timer)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Find which NS this NSR responds to</span>
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> nsr_message<span style="color:#f92672">.</span>tag
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> ns_state <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>ns_messages_sent:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tag <span style="color:#f92672">in</span> ns_state[<span style="color:#e6db74">&#39;tagset&#39;</span>]:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># This NSR corresponds to this NS</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>active_ns_state <span style="color:#f92672">=</span> ns_state
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process NSR and complete handshake</span>
</span></span><span style="display:flex;"><span>        complete_handshake(nsr_message, self<span style="color:#f92672">.</span>active_ns_state)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Discard other NS states</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_messages_sent <span style="color:#f92672">=</span> []
</span></span></code></pre></div><p><strong>Propiedades importantes:</strong></p>
<ol>
<li><strong>Claves efímeras únicas</strong>: Cada NS usa una clave efímera diferente</li>
<li><strong>Negociaciones independientes</strong>: Cada NS crea un estado de negociación por separado</li>
<li><strong>Correlación de NSR</strong>: La etiqueta NSR identifica a qué NS responde</li>
<li><strong>Limpieza de estado</strong>: Los estados de NS no utilizados se descartan tras una NSR satisfactoria</li>
</ol>
<p><strong>Prevención de ataques:</strong></p>
<p>Para evitar el agotamiento de recursos:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Limit NS sending rate</span>
</span></span><span style="display:flex;"><span>max_ns_rate <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> per <span style="color:#ae81ff">10</span> seconds per destination
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Limit total NS attempts</span>
</span></span><span style="display:flex;"><span>max_ns_attempts <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Limit total pending NS states</span>
</span></span><span style="display:flex;"><span>max_pending_ns <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> per context
</span></span></code></pre></div><h3 id="múltiples-mensajes-nsr">Múltiples mensajes NSR</h3>
<p><strong>Escenario</strong>: Bob envía múltiples NSRs (p. ej., datos de respuesta divididos en varios mensajes).</p>
<p><strong>Comportamiento de Bob:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_nsr_replies</span>(self, payload_chunks):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># One NS received, multiple NSRs to send</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> chunk <span style="color:#f92672">in</span> payload_chunks:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Generate new ephemeral key for each NSR</span>
</span></span><span style="display:flex;"><span>            ephemeral_key <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Get next tag from NSR tagset</span>
</span></span><span style="display:flex;"><span>            tag <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>nsr_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            nsr_message <span style="color:#f92672">=</span> build_nsr_message(
</span></span><span style="display:flex;"><span>                tag<span style="color:#f92672">=</span>tag,
</span></span><span style="display:flex;"><span>                ephemeral_key<span style="color:#f92672">=</span>ephemeral_key,
</span></span><span style="display:flex;"><span>                payload<span style="color:#f92672">=</span>chunk
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            send_message(nsr_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Wait for ES message from Alice</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>AWAITING_ES
</span></span></code></pre></div><p><strong>Comportamiento de Alice:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_nsr_received</span>(self, nsr_message):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>PENDING_REPLY:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># First NSR received</span>
</span></span><span style="display:flex;"><span>            complete_handshake(nsr_message)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Create ES sessions</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>es_outbound_tagset <span style="color:#f92672">=</span> derive_es_outbound_tagset()
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>es_inbound_tagset <span style="color:#f92672">=</span> derive_es_inbound_tagset()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Send ES message (ACK)</span>
</span></span><span style="display:flex;"><span>            send_es_message(empty_payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Additional NSR received</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Decrypt and process payload</span>
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> decrypt_nsr_payload(nsr_message)
</span></span><span style="display:flex;"><span>            process_payload(payload)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># These NSRs are from other NS attempts, ignore handshake</span>
</span></span></code></pre></div><p><strong>Limpieza de Bob:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_es_received</span>(self, es_message):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># First ES received from Alice</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># This confirms which NSR Alice used</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Clean up other handshake states</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> other_ns_state <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>pending_ns_states:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> other_ns_state <span style="color:#f92672">!=</span> self<span style="color:#f92672">.</span>active_ns_state:
</span></span><span style="display:flex;"><span>                delete_ns_state(other_ns_state)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Delete unused NSR tagsets</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> tagset <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>nsr_tagsets:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tagset <span style="color:#f92672">!=</span> self<span style="color:#f92672">.</span>active_nsr_tagset:
</span></span><span style="display:flex;"><span>                delete_tagset(tagset)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span></code></pre></div><p><strong>Propiedades importantes:</strong></p>
<ol>
<li><strong>Se permiten múltiples NSRs (solicitudes de sesión Noise)</strong>: Bob puede enviar múltiples NSRs por cada NS (sesión Noise)</li>
<li><strong>Claves efímeras diferentes</strong>: Cada NSR debe usar una clave efímera única</li>
<li><strong>Mismo conjunto de etiquetas de NSR</strong>: Todas las NSRs para una NS usan el mismo conjunto de etiquetas</li>
<li><strong>Gana el primer ES (patrón Ephemeral-Static de Noise)</strong>: El primer ES de Alice determina cuál NSR tuvo éxito</li>
<li><strong>Limpieza después del ES</strong>: Bob descarta los estados no utilizados tras recibir el ES</li>
</ol>
<h3 id="máquina-de-estados-de-la-sesión">Máquina de estados de la sesión</h3>
<p><strong>Diagrama de estados completo:</strong></p>
<pre tabindex="0"><code>                    Outbound Session                    Inbound Session

                         NEW
                          |
                     send NS
                          |
                   PENDING_REPLY -------------------- receive NS ---&gt; ESTABLISHED
                          |                                                |
                   receive NSR                                        send NSR
                          |                                                |
                    ESTABLISHED &lt;---------- receive ES ------------- AWAITING_ES
                          |                     |                          |
                    ┌─────┴─────┐               |                    receive ES
                    |           |               |                          |
              send ES      receive ES           |                    ESTABLISHED
                    |           |               |                          |
                    └─────┬─────┘               |                ┌─────────┴─────────┐
                          |                     |                |                   |
                          |                     |          send ES              receive ES
                          |                     |                |                   |
                          |                     |                └─────────┬─────────┘
                          |                     |                          |
                          └─────────────────────┴──────────────────────────┘
                                              ACTIVE
                                                |
                                         idle timeout
                                                |
                                             EXPIRED
</code></pre><p><strong>Descripciones de estado:</strong></p>
<ul>
<li><strong>NEW</strong>: Sesión saliente creada, aún no se ha enviado ningún NS</li>
<li><strong>PENDING_REPLY</strong>: NS enviado, esperando NSR</li>
<li><strong>AWAITING_ES</strong>: NSR enviado, esperando el primer ES de Alice</li>
<li><strong>ESTABLISHED</strong>: Negociación completada, puede enviar/recibir ES</li>
<li><strong>ACTIVE</strong>: Intercambiando mensajes ES activamente</li>
<li><strong>RATCHETING</strong>: DH ratchet (mecanismo de avance criptográfico de Diffie-Hellman) en progreso (subconjunto de ACTIVE)</li>
<li><strong>EXPIRED</strong>: Sesión caducada por tiempo de espera, pendiente de eliminación</li>
<li><strong>TERMINATED</strong>: Sesión terminada explícitamente</li>
</ul>
<hr>
<h2 id="formato-de-carga-útil">Formato de carga útil</h2>
<p>La sección de carga útil de todos los mensajes ECIES (esquema de cifrado integrado con curvas elípticas) (NS, NSR, ES) utiliza un formato basado en bloques similar a NTCP2.</p>
<h3 id="estructura-de-bloques">Estructura de bloques</h3>
<p><strong>Formato general:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|blk |  size   |       data             |
+----+----+----+                        +
|                                       |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
|blk |  size   |       data             |
+----+----+----+                        +
|                                       |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Campos:</strong></p>
<ul>
<li><code>blk</code>: 1 byte - Número de tipo de bloque</li>
<li><code>size</code>: 2 bytes - Tamaño del campo de datos en big-endian (0-65516)</li>
<li><code>data</code>: Longitud variable - Datos específicos del bloque</li>
</ul>
<p><strong>Restricciones:</strong></p>
<ul>
<li>Tamaño máximo de la trama ChaChaPoly: 65535 bytes</li>
<li>MAC Poly1305: 16 bytes</li>
<li>Tamaño máximo total de bloques: 65519 bytes (65535 - 16)</li>
<li>Tamaño máximo de un bloque: 65519 bytes (incluye encabezado de 3 bytes)</li>
<li>Tamaño máximo de datos de un bloque: 65516 bytes</li>
</ul>
<h3 id="tipos-de-bloques">Tipos de bloques</h3>
<p><strong>Tipos de bloques definidos:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Name</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Status</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Usage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DateTime</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">7 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Required in NS</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1-3</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future use</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Termination</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">9+ bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Unimplemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session termination</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">5</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Options</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">21+ bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Unimplemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session options</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">6</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">MessageNumbers</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">5 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Unimplemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">PN value</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">7</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NextKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">3 or 35 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DH ratchet</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">8</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ACK</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">4+ bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Message acknowledgment</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">9</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ACK Request</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">3 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Request ACK</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">10</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future use</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">11</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Garlic Clove</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Variable</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Application data</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">12-223</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future use</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">224-253</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Experimental</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Variable</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Testing features</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">254</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Padding</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Variable</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Traffic shaping</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">255</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future extension</td>
    </tr>
  </tbody>
</table>
**Manejo de bloques desconocidos:**
<p>Las implementaciones DEBEN ignorar los bloques con números de tipo desconocido y tratarlos como relleno. Esto garantiza la compatibilidad con futuras versiones.</p>
<h3 id="reglas-de-ordenamiento-de-bloques">Reglas de ordenamiento de bloques</h3>
<h3 id="orden-de-mensajes-ns">Orden de mensajes NS</h3>
<p><strong>Obligatorio:</strong> - El bloque DateTime DEBE ser el primero</p>
<p><strong>Permitidos:</strong> - Garlic Clove (submensaje &ldquo;clove&rdquo; de I2P) (tipo 11) - Opciones (tipo 5) - si está implementado - Relleno (tipo 254)</p>
<p><strong>Prohibido:</strong> - NextKey, ACK, ACK Request, Termination, MessageNumbers</p>
<p><strong>Ejemplo de carga útil NS válida:</strong></p>
<pre tabindex="0"><code>DateTime (0) | Garlic Clove (11) | Garlic Clove (11) | Padding (254)
</code></pre><h3 id="orden-de-mensajes-de-nsr">Orden de mensajes de NSR</h3>
<p><strong>Obligatorio:</strong> - Ninguno (la carga útil puede estar vacía)</p>
<p><strong>Permitidos:</strong> - Garlic Clove (submensaje de garlic encryption) (tipo 11) - Opciones (tipo 5) - si está implementado - Relleno (tipo 254)</p>
<p><strong>Prohibido:</strong> - DateTime, NextKey, ACK, ACK Request, Termination, MessageNumbers</p>
<p><strong>Ejemplo de carga útil NSR válida:</strong></p>
<pre tabindex="0"><code>Garlic Clove (11) | Garlic Clove (11) | Padding (254)
</code></pre><p>o</p>
<pre tabindex="0"><code>(empty - ACK only)
</code></pre><h3 id="orden-de-mensajes-de-es">Orden de mensajes de ES</h3>
<p><strong>Obligatorio:</strong> - Ninguno (la carga útil puede estar vacía)</p>
<p><strong>Permitidos (en cualquier orden):</strong> - Garlic Clove (tipo 11) - NextKey (tipo 7) - ACK (tipo 8) - ACK Request (tipo 9) - Termination (tipo 4) - si se implementa - MessageNumbers (tipo 6) - si se implementa - Options (tipo 5) - si se implementa - Padding (tipo 254)</p>
<p><strong>Reglas especiales:</strong> - Termination DEBE ser el último bloque (excepto Padding) - Padding DEBE ser el último bloque - Se permiten múltiples Garlic Cloves (submensajes dentro de un mensaje de garlic encryption) - Se permiten hasta 2 bloques NextKey (directo e inverso) - NO se permiten múltiples bloques de Padding</p>
<p><strong>Ejemplos de cargas útiles ES válidas:</strong></p>
<pre tabindex="0"><code>Garlic Clove (11) | ACK (8) | Padding (254)
</code></pre><pre tabindex="0"><code>NextKey (7) | Garlic Clove (11) | Garlic Clove (11)
</code></pre><pre tabindex="0"><code>NextKey (7) forward | NextKey (7) reverse | Garlic Clove (11)
</code></pre><pre tabindex="0"><code>ACK Request (9) | Garlic Clove (11) | Termination (4) | Padding (254)
</code></pre><h3 id="bloque-datetime-tipo-0">Bloque DateTime (Tipo 0)</h3>
<p><strong>Propósito</strong>: Marca de tiempo para la prevención de ataques de repetición y la validación del desfase del reloj</p>
<p><strong>Tamaño</strong>: 7 bytes (cabecera de 3 bytes + datos de 4 bytes)</p>
<p><strong>Formato:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+
| 0  |    4    |     timestamp     |
+----+----+----+----+----+----+----+
</code></pre><p><strong>Campos:</strong></p>
<ul>
<li><code>blk</code>: 0</li>
<li><code>size</code>: 4 (big-endian, orden de bytes más significativo primero)</li>
<li><code>timestamp</code>: 4 bytes - marca de tiempo Unix en segundos (sin signo, big-endian)</li>
</ul>
<p><strong>Formato de marca de tiempo:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>timestamp <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())  <span style="color:#75715e"># Seconds since 1970-01-01 00:00:00 UTC</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wraps around in year 2106 (4-byte unsigned maximum)</span>
</span></span></code></pre></div><p><strong>Reglas de validación:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>MAX_CLOCK_SKEW_PAST <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>      <span style="color:#75715e"># 5 minutes</span>
</span></span><span style="display:flex;"><span>MAX_CLOCK_SKEW_FUTURE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>    <span style="color:#75715e"># 2 minutes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_datetime</span>(timestamp):
</span></span><span style="display:flex;"><span>    now <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span>    age <span style="color:#f92672">=</span> now <span style="color:#f92672">-</span> timestamp
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span>MAX_CLOCK_SKEW_FUTURE:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Too far in future</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&gt;</span> MAX_CLOCK_SKEW_PAST:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Too old</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><p><strong>Prevención de ataques de repetición:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReplayFilter</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, duration<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>duration <span style="color:#f92672">=</span> duration  <span style="color:#75715e"># 5 minutes</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>seen_messages <span style="color:#f92672">=</span> BloomFilter(size<span style="color:#f92672">=</span><span style="color:#ae81ff">100000</span>, false_positive_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cleanup_timer <span style="color:#f92672">=</span> RepeatTimer(<span style="color:#ae81ff">60</span>, self<span style="color:#f92672">.</span>cleanup)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_replay</span>(self, ephemeral_key, timestamp):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check timestamp validity</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> validate_datetime(timestamp):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if ephemeral key seen recently</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ephemeral_key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>seen_messages:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Replay attack</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add to seen messages</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>seen_messages<span style="color:#f92672">.</span>add(ephemeral_key)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cleanup</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire old entries (Bloom filter automatically ages out)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p><strong>Notas de implementación:</strong></p>
<ol>
<li><strong>Mensajes NS</strong>: DateTime DEBE ser el primer bloque</li>
<li><strong>Mensajes NSR/ES</strong>: DateTime normalmente no se incluye</li>
<li><strong>Ventana de repetición</strong>: 5 minutos es el mínimo recomendado</li>
<li><strong>Filtro de Bloom</strong>: Recomendado para una detección eficiente de repeticiones</li>
<li><strong>Desfase del reloj</strong>: Permitir 5 minutos hacia el pasado, 2 minutos hacia el futuro</li>
</ol>
<h3 id="bloque-garlic-clove-sub-bloque-en-garlic-encryption-tipo-11">Bloque Garlic Clove (sub-bloque en garlic encryption) (Tipo 11)</h3>
<p><strong>Propósito</strong>: Encapsula mensajes I2NP para su entrega</p>
<p><strong>Formato:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 11 |  size   |                        |
+----+----+----+                        +
|      Delivery Instructions            |
~                                       ~
|                                       |
+----+----+----+----+----+----+----+----+
|type|  Message_ID       | Expiration  |
+----+----+----+----+----+----+----+----+
     |      I2NP Message body           |
+----+                                  +
~                                       ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Campos:</strong></p>
<ul>
<li><code>blk</code>: 11</li>
<li><code>size</code>: Tamaño total de clove (submensaje dentro de un garlic message) (variable)</li>
<li><code>Delivery Instructions</code>: Como se especifica en la especificación de I2NP</li>
<li><code>type</code>: Tipo de mensaje I2NP (1 byte)</li>
<li><code>Message_ID</code>: ID de mensaje I2NP (4 bytes)</li>
<li><code>Expiration</code>: Marca de tiempo Unix en segundos (4 bytes)</li>
<li><code>I2NP Message body</code>: Datos de mensaje de longitud variable</li>
</ul>
<p><strong>Formatos de instrucciones de entrega:</strong></p>
<p><strong>Entrega local</strong> (1 byte):</p>
<pre tabindex="0"><code>+----+
|0x00|
+----+
</code></pre><p><strong>Entrega al destino</strong> (33 bytes):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|0x01|                                  |
+----+        Destination Hash         +
|              32 bytes                 |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Entrega al router</strong> (33 bytes):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|0x02|                                  |
+----+         Router Hash              +
|              32 bytes                 |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Entrega vía Tunnel</strong> (37 bytes):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|0x03|         Tunnel ID                |
+----+----+----+----+----+              +
|           Router Hash                 |
+              32 bytes                 +
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Encabezado de mensaje de I2NP</strong> (9 bytes en total):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|type|      msg_id       |  expiration   |
+----+----+----+----+----+----+----+----+
     |                                   |
</code></pre><ul>
<li><code>type</code>: Tipo de mensaje I2NP (Database Store, Database Lookup, Data, etc.)</li>
<li><code>msg_id</code>: identificador de mensaje de 4 bytes</li>
<li><code>expiration</code>: marca de tiempo Unix de 4 bytes (segundos)</li>
</ul>
<p><strong>Diferencias importantes con respecto al formato Clove (submensaje en I2P) de ElGamal:</strong></p>
<ol>
<li><strong>Sin certificado</strong>: Se omite el campo de certificado (no se utiliza en ElGamal)</li>
<li><strong>Sin Clove ID</strong>: Se omite el Clove ID (siempre era 0)</li>
<li><strong>Sin expiración de Clove</strong>: En su lugar, se utiliza la expiración del mensaje I2NP</li>
<li><strong>Encabezado compacto</strong>: Encabezado I2NP de 9 bytes frente al formato ElGamal más grande</li>
<li><strong>Cada Clove (submensaje dentro de garlic encryption) es un bloque separado</strong>: No hay estructura CloveSet</li>
</ol>
<p><strong>Múltiples Cloves (submensajes dentro de un mensaje garlic):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Multiple Garlic Cloves in one message</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    build_datetime_block(),
</span></span><span style="display:flex;"><span>    build_garlic_clove(i2np_message_1),
</span></span><span style="display:flex;"><span>    build_garlic_clove(i2np_message_2),
</span></span><span style="display:flex;"><span>    build_garlic_clove(i2np_message_3),
</span></span><span style="display:flex;"><span>    build_padding_block()
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>Tipos comunes de mensajes I2NP en Cloves (submensajes dentro de garlic encryption):</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Name</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Usage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DatabaseStore</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Publishing LeaseSet</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DatabaseLookup</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Requesting LeaseSet</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">5</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DeliveryStatus</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ACK (legacy, avoid in ECIES)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">20</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Streaming data</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">21</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Garlic</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Nested garlic messages</td>
    </tr>
  </tbody>
</table>
**Procesamiento de Clove (diente de ajo):**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_garlic_clove</span>(clove_data):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Parse delivery instructions</span>
</span></span><span style="display:flex;"><span>    delivery_type <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x00</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Local delivery</span>
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x01</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Destination delivery</span>
</span></span><span style="display:flex;"><span>        dest_hash <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">33</span>]
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x02</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Router delivery</span>
</span></span><span style="display:flex;"><span>        router_hash <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">33</span>]
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x03</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Tunnel delivery</span>
</span></span><span style="display:flex;"><span>        tunnel_id <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;I&#39;</span>, clove_data[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">5</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        router_hash <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">37</span>]
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">37</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Parse I2NP header</span>
</span></span><span style="display:flex;"><span>    i2np_type <span style="color:#f92672">=</span> clove_data[offset]
</span></span><span style="display:flex;"><span>    msg_id <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;I&#39;</span>, clove_data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">5</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    expiration <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;I&#39;</span>, clove_data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">5</span>:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract I2NP body</span>
</span></span><span style="display:flex;"><span>    i2np_body <span style="color:#f92672">=</span> clove_data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span>:]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Process message</span>
</span></span><span style="display:flex;"><span>    process_i2np_message(i2np_type, msg_id, expiration, i2np_body)
</span></span></code></pre></div><h3 id="bloque-nextkey-tipo-7">Bloque NextKey (Tipo 7)</h3>
<p><strong>Propósito</strong>: intercambio de claves mediante DH ratchet (mecanismo de avance de Diffie-Hellman)</p>
<p><strong>Formato (Clave presente - 38 bytes):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 7  |   35    |flag|  key ID |         |
+----+----+----+----+----+----+         +
|                                       |
+     Next DH Ratchet Public Key        +
|              32 bytes                 |
+                                       +
|                                       |
+                             +----+----+
|                             |
+----+----+----+----+----+----+
</code></pre><p><strong>Formato (solo ID de clave - 6 bytes):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+
| 7  |    3    |flag|  key ID |
+----+----+----+----+----+----+
</code></pre><p><strong>Campos:</strong></p>
<ul>
<li><code>blk</code>: 7</li>
<li><code>size</code>: 3 (solo ID) o 35 (con clave)</li>
<li><code>flag</code>: 1 byte - Bits de bandera</li>
<li><code>key ID</code>: 2 bytes - Identificador de clave Big-endian (byte más significativo primero) (0-32767)</li>
<li><code>Public Key</code>: 32 bytes - Clave pública X25519 (little-endian; byte menos significativo primero), si el bit 0 de la bandera = 1</li>
</ul>
<p><strong>Bits de bandera:</strong></p>
<pre tabindex="0"><code>Bit 7 6 5 4 3 2 1 0
    | | | | | | | |
    | | | | | | | +-- Bit 0: Key present (1) or ID only (0)
    | | | | | | +---- Bit 1: Reverse key (1) or forward key (0)
    | | | | | +------ Bit 2: Request reverse key (1) or no request (0)
    | | | | |
    +-+-+-+-+-------- Bits 3-7: Reserved (set to 0)
</code></pre><p><strong>Ejemplos de banderas:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Forward key present</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x01</span>  <span style="color:#75715e"># Binary: 00000001</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Reverse key present</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x03</span>  <span style="color:#75715e"># Binary: 00000011</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Forward key ID only (ACK)</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00</span>  <span style="color:#75715e"># Binary: 00000000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Reverse key ID only (ACK)</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x02</span>  <span style="color:#75715e"># Binary: 00000010</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Forward key ID with reverse request</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x04</span>  <span style="color:#75715e"># Binary: 00000100</span>
</span></span></code></pre></div><p><strong>Reglas del identificador de clave:</strong></p>
<ul>
<li>Los ID son secuenciales: 0, 1, 2, &hellip;, 32767</li>
<li>El ID solo se incrementa cuando se genera una nueva clave</li>
<li>Se usa el mismo ID para varios mensajes hasta el próximo ratchet (mecanismo de trinquete)</li>
<li>El ID máximo es 32767 (después hay que iniciar una sesión nueva)</li>
</ul>
<p><strong>Ejemplos de uso:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Initiating ratchet (sender generates new key)</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>,           <span style="color:#75715e"># Key present, forward</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    public_key<span style="color:#f92672">=</span>sender_new_pk
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Replying to ratchet (receiver generates new key)</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>,           <span style="color:#75715e"># Key present, reverse</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    public_key<span style="color:#f92672">=</span>receiver_new_pk
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Acknowledging ratchet (no new key from sender)</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x02</span>,           <span style="color:#75715e"># ID only, reverse</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Requesting reverse ratchet</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x04</span>,           <span style="color:#75715e"># Request reverse, forward ID</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>Lógica de procesamiento:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_nextkey_block</span>(block):
</span></span><span style="display:flex;"><span>    flags <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>flags
</span></span><span style="display:flex;"><span>    key_id <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>key_id
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    key_present <span style="color:#f92672">=</span> (flags <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x01</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    is_reverse <span style="color:#f92672">=</span> (flags <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x02</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    request_reverse <span style="color:#f92672">=</span> (flags <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x04</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> key_present:
</span></span><span style="display:flex;"><span>        public_key <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_reverse:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Reverse key received</span>
</span></span><span style="display:flex;"><span>            perform_dh_ratchet(receiver_key<span style="color:#f92672">=</span>public_key, key_id<span style="color:#f92672">=</span>key_id)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Sender should ACK with own key ID</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Forward key received</span>
</span></span><span style="display:flex;"><span>            perform_dh_ratchet(sender_key<span style="color:#f92672">=</span>public_key, key_id<span style="color:#f92672">=</span>key_id)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Receiver should reply with reverse key</span>
</span></span><span style="display:flex;"><span>            send_reverse_key(generate_new_key())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Key ID only (ACK)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_reverse:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Reverse key ACK</span>
</span></span><span style="display:flex;"><span>            confirm_reverse_ratchet(key_id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Forward key ACK</span>
</span></span><span style="display:flex;"><span>            confirm_forward_ratchet(key_id)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request_reverse:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Sender requests receiver to generate new key</span>
</span></span><span style="display:flex;"><span>        send_reverse_key(generate_new_key())
</span></span></code></pre></div><p><strong>Múltiples NextKey Blocks (bloques NextKey):</strong></p>
<p>Un único mensaje ES puede contener hasta 2 bloques NextKey cuando ambas direcciones están realizando ratcheting (avance de claves tipo “ratchet”) simultáneamente:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Both directions ratcheting</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    NextKeyBlock(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, public_key<span style="color:#f92672">=</span>forward_key),  <span style="color:#75715e"># Forward</span>
</span></span><span style="display:flex;"><span>    NextKeyBlock(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, public_key<span style="color:#f92672">=</span>reverse_key),  <span style="color:#75715e"># Reverse</span>
</span></span><span style="display:flex;"><span>    build_garlic_clove(data)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><h3 id="bloque-ack-tipo-8">Bloque ACK (Tipo 8)</h3>
<p><strong>Propósito</strong>: Confirmar la recepción de mensajes en banda</p>
<p><strong>Formato (ACK único - 7 bytes):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+
| 8  |    4    |tagsetid |   N     |
+----+----+----+----+----+----+----+
</code></pre><p><strong>Formato (Múltiples ACKs):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 8  |  size   |tagsetid |   N     |    |
+----+----+----+----+----+----+----+    +
|            more ACKs                  |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Campos:</strong></p>
<ul>
<li><code>blk</code>: 8</li>
<li><code>size</code>: 4 * número de ACKs (confirmaciones) (mínimo 4)</li>
<li>Para cada ACK:
<ul>
<li><code>tagsetid</code>: 2 bytes - ID del conjunto de etiquetas en Big-endian (0-65535)</li>
<li><code>N</code>: 2 bytes - número de mensaje en Big-endian (0-65535)</li>
</ul>
</li>
</ul>
<p><strong>Determinación del ID del conjunto de etiquetas:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Tag set 0 (initial, after NSR)</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># After first ratchet (tag set 1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Both Alice and Bob sent key ID 0</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># After second ratchet (tag set 2)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Alice sent key ID 1, Bob still using key ID 0</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># After third ratchet (tag set 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Alice still using key ID 1, Bob sent key ID 1</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span></code></pre></div><p><strong>Ejemplo de ACK único:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ACK message from tag set 5, message number 127</span>
</span></span><span style="display:flex;"><span>ack_block <span style="color:#f92672">=</span> ACKBlock(
</span></span><span style="display:flex;"><span>    tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>    message_number<span style="color:#f92672">=</span><span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wire format (7 bytes):</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 08 00 04 00 05 00 7F</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  |  |  |  |</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  |  |  |  +-- N (127)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  |  +--------- N high byte</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  +------------ tagset_id (5)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  +--------------- tagset_id high byte</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  +------------------ size (4)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># +--------------------- type (8)</span>
</span></span></code></pre></div><p><strong>Ejemplo de múltiples ACK (confirmaciones):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ACK three messages</span>
</span></span><span style="display:flex;"><span>ack_block <span style="color:#f92672">=</span> ACKBlock([
</span></span><span style="display:flex;"><span>    (tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, N<span style="color:#f92672">=</span><span style="color:#ae81ff">42</span>),
</span></span><span style="display:flex;"><span>    (tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, N<span style="color:#f92672">=</span><span style="color:#ae81ff">43</span>),
</span></span><span style="display:flex;"><span>    (tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>, N<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wire format (15 bytes):</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 08 00 0C 00 03 00 2A 00 03 00 2B 00 04 00 00</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#                (ts=3, N=42) (ts=3, N=43) (ts=4, N=0)</span>
</span></span></code></pre></div><p><strong>Procesamiento:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_ack_block</span>(block):
</span></span><span style="display:flex;"><span>    num_acks <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>size <span style="color:#f92672">//</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_acks):
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> i <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>        tagset_id <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;H&#39;</span>, block<span style="color:#f92672">.</span>data[offset:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        message_num <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;H&#39;</span>, block<span style="color:#f92672">.</span>data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mark message as acknowledged</span>
</span></span><span style="display:flex;"><span>        mark_acked(tagset_id, message_num)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># May trigger retransmission timeout cancellation</span>
</span></span><span style="display:flex;"><span>        cancel_retransmit_timer(tagset_id, message_num)
</span></span></code></pre></div><p><strong>Cuándo enviar acuses de recibo:</strong></p>
<ol>
<li><strong>ACK Request explícita</strong>: Responda siempre al bloque ACK Request (ACK: acuse de recibo)</li>
<li><strong>Entrega de LeaseSet</strong>: Cuando el remitente incluye el LeaseSet en el mensaje</li>
<li><strong>Establecimiento de sesión</strong>: Puede enviar un ACK a NS/NSR (aunque el protocolo prefiere un ACK implícito vía ES)</li>
<li><strong>Confirmación de ratchet (mecanismo de avance criptográfico)</strong>: Puede enviar ACK al recibir NextKey</li>
<li><strong>Capa de aplicación</strong>: Según lo requiera el protocolo de capa superior (p. ej., Streaming)</li>
</ol>
<p><strong>Temporización de ACK:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ACKManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pending_acks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ack_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">request_ack</span>(self, tagset_id, message_num):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pending_acks<span style="color:#f92672">.</span>append((tagset_id, message_num))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>ack_timer:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Delay ACK briefly to allow higher layer to respond</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>ack_timer <span style="color:#f92672">=</span> set_timer(<span style="color:#ae81ff">0.1</span>, self<span style="color:#f92672">.</span>send_acks)  <span style="color:#75715e"># 100ms</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_acks</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>pending_acks <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> has_outbound_data():
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># No higher layer data, send explicit ACK</span>
</span></span><span style="display:flex;"><span>            send_es_message(build_ack_block(self<span style="color:#f92672">.</span>pending_acks))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Otherwise, ACK will piggyback on next ES message</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pending_acks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ack_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><h3 id="bloque-de-solicitud-de-ack-tipo-9">Bloque de solicitud de ACK (Tipo 9)</h3>
<p><strong>Propósito</strong>: Solicitar acuse de recibo en banda del mensaje actual</p>
<p><strong>Formato:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+
| 9  |    1    |flg |
+----+----+----+----+
</code></pre><p><strong>Campos:</strong></p>
<ul>
<li><code>blk</code>: 9</li>
<li><code>size</code>: 1</li>
<li><code>flg</code>: 1 byte - Indicadores (todos los bits actualmente sin uso, establecidos en 0)</li>
</ul>
<p><strong>Uso:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Request ACK for this message</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    build_ack_request_block(),
</span></span><span style="display:flex;"><span>    build_garlic_clove(important_data)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>Respuesta del receptor:</strong></p>
<p>Cuando se recibe ACK Request (petición de acuse de recibo):</p>
<ol>
<li><strong>Con Immediate Data (datos inmediatos)</strong>: Incluir el bloque ACK en la respuesta inmediata</li>
<li><strong>Sin Immediate Data</strong>: Iniciar un temporizador (p. ej., 100 ms) y enviar un ES vacío con ACK si el temporizador expira</li>
<li><strong>Tag Set ID (ID del conjunto de etiquetas)</strong>: Usar el ID de tagset entrante actual</li>
<li><strong>Número de mensaje</strong>: Usar el número de mensaje asociado con la session tag (etiqueta de sesión) recibida</li>
</ol>
<p><strong>Procesamiento:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_ack_request</span>(message):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract message identification</span>
</span></span><span style="display:flex;"><span>    tagset_id <span style="color:#f92672">=</span> message<span style="color:#f92672">.</span>tagset_id
</span></span><span style="display:flex;"><span>    message_num <span style="color:#f92672">=</span> message<span style="color:#f92672">.</span>message_num
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Schedule ACK</span>
</span></span><span style="display:flex;"><span>    schedule_ack(tagset_id, message_num)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># If no data to send immediately, start timer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> has_pending_data():
</span></span><span style="display:flex;"><span>        set_timer(<span style="color:#ae81ff">0.1</span>, <span style="color:#66d9ef">lambda</span>: send_ack_only(tagset_id, message_num))
</span></span></code></pre></div><p><strong>Cuándo usar ACK Request (solicitud de acuse de recibo):</strong></p>
<ol>
<li><strong>Mensajes críticos</strong>: Mensajes que requieren acuse de recibo</li>
<li><strong>Entrega de LeaseSet</strong>: Al incluir un LeaseSet</li>
<li><strong>Session Ratchet</strong> (mecanismo de avance de claves de sesión): Después de enviar el NextKey block (bloque para la siguiente clave)</li>
<li><strong>Fin de la transmisión</strong>: Cuando el emisor no tiene más datos que enviar pero quiere confirmación</li>
</ol>
<p><strong>Cuándo NO usarlo:</strong></p>
<ol>
<li><strong>Protocolo de streaming</strong>: La capa de streaming gestiona los ACKs (confirmaciones de recepción)</li>
<li><strong>Mensajes de alta frecuencia</strong>: Evite la solicitud de ACK en cada mensaje (sobrecarga)</li>
<li><strong>Datagramas no importantes</strong>: Los datagramas sin formato por lo general no necesitan ACKs</li>
</ol>
<h3 id="bloque-de-terminación-tipo-4">Bloque de Terminación (Tipo 4)</h3>
<p><strong>Estado</strong>: SIN IMPLEMENTAR</p>
<p><strong>Propósito</strong>: Finalizar la sesión de forma ordenada</p>
<p><strong>Formato:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 4  |  size   | rsn|     addl data     |
+----+----+----+----+                   +
~               ...                     ~
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Campos:</strong></p>
<ul>
<li><code>blk</code>: 4</li>
<li><code>size</code>: 1 o más bytes</li>
<li><code>rsn</code>: 1 byte - Código de motivo</li>
<li><code>addl data</code>: Datos adicionales opcionales (el formato depende del motivo)</li>
</ul>
<p><strong>Códigos de motivo:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Code</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Meaning</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Additional Data</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Normal close / unspecified</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Termination received</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Idle timeout</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None (implementation-specific)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Resource exhaustion</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None (implementation-specific)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implementation-specific</td>
    </tr>
  </tbody>
</table>
**Uso (cuando se implemente):**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Normal session close</span>
</span></span><span style="display:flex;"><span>termination <span style="color:#f92672">=</span> TerminationBlock(
</span></span><span style="display:flex;"><span>    reason<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    additional_data<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Session termination due to received termination</span>
</span></span><span style="display:flex;"><span>termination <span style="color:#f92672">=</span> TerminationBlock(
</span></span><span style="display:flex;"><span>    reason<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    additional_data<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>Reglas:</strong></p>
<ul>
<li>DEBE ser el último bloque excepto Padding (relleno)</li>
<li>Padding DEBE seguir a Termination (terminación) si está presente</li>
<li>No permitido en mensajes NS o NSR</li>
<li>Solo permitido en mensajes ES</li>
</ul>
<h3 id="bloque-de-opciones-tipo-5">Bloque de opciones (Tipo 5)</h3>
<p><strong>Estado</strong>: SIN IMPLEMENTAR</p>
<p><strong>Propósito</strong>: Negociar parámetros de sesión</p>
<p><strong>Formato:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 5  |  size   |ver |flg |STL |STimeout |
+----+----+----+----+----+----+----+----+
|  SOTW   |  RITW   |tmin|tmax|rmin|rmax|
+----+----+----+----+----+----+----+----+
|  tdmy   |  rdmy   |  tdelay |  rdelay |
+----+----+----+----+----+----+----+----+
|              more_options             |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Campos:</strong></p>
<ul>
<li><code>blk</code>: 5</li>
<li><code>size</code>: 21 bytes o más</li>
<li><code>ver</code>: 1 byte - Versión del protocolo (debe ser 0)</li>
<li><code>flg</code>: 1 byte - Indicadores (todos los bits actualmente sin usar)</li>
<li><code>STL</code>: 1 byte - Longitud de la etiqueta de sesión (debe ser 8)</li>
<li><code>STimeout</code>: 2 bytes - Tiempo de espera de inactividad de la sesión en segundos (big-endian)</li>
<li><code>SOTW</code>: 2 bytes - Ventana de etiquetas salientes del remitente (big-endian)</li>
<li><code>RITW</code>: 2 bytes - Ventana de etiquetas entrantes del receptor (big-endian)</li>
<li><code>tmin</code>, <code>tmax</code>, <code>rmin</code>, <code>rmax</code>: 1 byte cada uno - Parámetros de relleno (punto fijo 4.4)</li>
<li><code>tdmy</code>: 2 bytes - Tráfico de relleno máximo que está dispuesto a enviar (bytes/s, big-endian)</li>
<li><code>rdmy</code>: 2 bytes - Tráfico de relleno solicitado (bytes/s, big-endian)</li>
<li><code>tdelay</code>: 2 bytes - Retraso intra-mensaje máximo que está dispuesto a insertar (ms, big-endian)</li>
<li><code>rdelay</code>: 2 bytes - Retraso intra-mensaje solicitado (ms, big-endian)</li>
<li><code>more_options</code>: Variable - Extensiones futuras</li>
</ul>
<p><strong>Parámetros de relleno (formato de punto fijo 4.4):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encode_padding_ratio</span>(ratio):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Encode padding ratio as 4.4 fixed-point
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ratio: 0.0 to 15.9375
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    returns: 0x00 to 0xFF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> int(ratio <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decode_padding_ratio</span>(encoded):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Decode 4.4 fixed-point to ratio
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    encoded: 0x00 to 0xFF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    returns: 0.0 to 15.9375
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> encoded <span style="color:#f92672">/</span> <span style="color:#ae81ff">16.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Examples:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x00 = 0.0 (no padding)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x01 = 0.0625 (6.25% padding)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x10 = 1.0 (100% padding - double traffic)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x80 = 8.0 (800% padding - 9x traffic)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0xFF = 15.9375 (1593.75% padding)</span>
</span></span></code></pre></div><p><strong>Negociación de la ventana de etiquetas:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># SOTW: Sender&#39;s recommendation for receiver&#39;s inbound window</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RITW: Sender&#39;s declaration of own inbound window</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver calculates actual inbound window:</span>
</span></span><span style="display:flex;"><span>inbound_window <span style="color:#f92672">=</span> calculate_window(
</span></span><span style="display:flex;"><span>    sender_suggestion<span style="color:#f92672">=</span>SOTW,
</span></span><span style="display:flex;"><span>    own_constraints<span style="color:#f92672">=</span>MAX_INBOUND_TAGS,
</span></span><span style="display:flex;"><span>    own_resources<span style="color:#f92672">=</span>available_memory()
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sender uses:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - RITW to know how far ahead receiver will accept</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Own SOTW to hint optimal window size</span>
</span></span></code></pre></div><p><strong>Valores predeterminados (cuando no se negocian opciones):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>DEFAULT_OPTIONS <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;version&#39;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;session_tag_length&#39;</span>: <span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">600</span>,  <span style="color:#75715e"># 10 minutes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;sender_outbound_tag_window&#39;</span>: <span style="color:#ae81ff">160</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;receiver_inbound_tag_window&#39;</span>: <span style="color:#ae81ff">160</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tmin&#39;</span>: <span style="color:#ae81ff">0x00</span>,  <span style="color:#75715e"># No minimum padding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tmax&#39;</span>: <span style="color:#ae81ff">0x10</span>,  <span style="color:#75715e"># Up to 100% padding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rmin&#39;</span>: <span style="color:#ae81ff">0x00</span>,  <span style="color:#75715e"># No minimum requested</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rmax&#39;</span>: <span style="color:#ae81ff">0x10</span>,  <span style="color:#75715e"># Up to 100% requested</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tdmy&#39;</span>: <span style="color:#ae81ff">0</span>,     <span style="color:#75715e"># No dummy traffic</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rdmy&#39;</span>: <span style="color:#ae81ff">0</span>,     <span style="color:#75715e"># No dummy traffic requested</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tdelay&#39;</span>: <span style="color:#ae81ff">0</span>,   <span style="color:#75715e"># No delay</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rdelay&#39;</span>: <span style="color:#ae81ff">0</span>    <span style="color:#75715e"># No delay requested</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="bloque-messagenumbers-tipo-6">Bloque MessageNumbers (Tipo 6)</h3>
<p><strong>Estado</strong>: NO IMPLEMENTADO</p>
<p><strong>Propósito</strong>: Indicar el último mensaje enviado en el conjunto de etiquetas anterior (permite la detección de huecos)</p>
<p><strong>Formato:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+
| 6  |    2    |  PN    |
+----+----+----+----+----+
</code></pre><p><strong>Campos:</strong></p>
<ul>
<li><code>blk</code>: 6</li>
<li><code>size</code>: 2</li>
<li><code>PN</code>: 2 bytes - Número del último mensaje del conjunto de etiquetas anterior (big-endian (orden de bytes de mayor a menor significancia), 0-65535)</li>
</ul>
<p><strong>Definición de PN (Número anterior):</strong></p>
<p>PN es el índice de la última etiqueta enviada en el conjunto de etiquetas anterior.</p>
<p><strong>Uso (cuando esté implementado):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># After ratcheting to new tag set</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Old tag set: sent messages 0-4095</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># New tag set: sending first message</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    MessageNumbersBlock(PN<span style="color:#f92672">=</span><span style="color:#ae81ff">4095</span>),
</span></span><span style="display:flex;"><span>    build_garlic_clove(data)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>Beneficios para el receptor:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_message_numbers</span>(pn_value):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Receiver can now:</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1. Determine if any messages were skipped</span>
</span></span><span style="display:flex;"><span>    highest_received_in_old_tagset <span style="color:#f92672">=</span> <span style="color:#ae81ff">4090</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> pn_value <span style="color:#f92672">&gt;</span> highest_received_in_old_tagset:
</span></span><span style="display:flex;"><span>        missing_count <span style="color:#f92672">=</span> pn_value <span style="color:#f92672">-</span> highest_received_in_old_tagset
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 5 messages were never received</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 2. Delete tags higher than PN from old tagset</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tag_index <span style="color:#f92672">in</span> range(pn_value <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, MAX_TAG_INDEX):
</span></span><span style="display:flex;"><span>        delete_tag(old_tagset, tag_index)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 3. Expire tags ≤ PN after grace period (e.g., 2 minutes)</span>
</span></span><span style="display:flex;"><span>    schedule_deletion(old_tagset, delay<span style="color:#f92672">=</span><span style="color:#ae81ff">120</span>)
</span></span></code></pre></div><p><strong>Reglas:</strong></p>
<ul>
<li>NO DEBE enviarse en el conjunto de etiquetas 0 (no hay conjunto de etiquetas previo)</li>
<li>Solo se envía en mensajes ES</li>
<li>Solo se envía en el/los primer(os) mensaje(s) de un nuevo conjunto de etiquetas</li>
<li>El valor PN es desde la perspectiva del remitente (última etiqueta que envió el remitente)</li>
</ul>
<p><strong>Relación con Signal:</strong></p>
<p>En Signal Double Ratchet (protocolo de doble trinquete de Signal), PN está en la cabecera del mensaje. En ECIES, está en la carga útil cifrada y es opcional.</p>
<h3 id="bloque-de-relleno-tipo-254">Bloque de relleno (Tipo 254)</h3>
<p><strong>Propósito</strong>: Resistencia al análisis de tráfico y ofuscación del tamaño de los mensajes</p>
<p><strong>Formato:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|254 |  size   |      padding           |
+----+----+----+                        +
|                                       |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Campos:</strong></p>
<ul>
<li><code>blk</code>: 254</li>
<li><code>size</code>: 0-65516 bytes (big-endian, más significativo primero)</li>
<li><code>padding</code>: Datos aleatorios o ceros</li>
</ul>
<p><strong>Reglas:</strong></p>
<ul>
<li>DEBE ser el último bloque del mensaje</li>
<li>NO se permiten múltiples bloques de relleno</li>
<li>Puede tener longitud cero (solo encabezado de 3 bytes)</li>
<li>Los datos de relleno pueden ser ceros o bytes aleatorios</li>
</ul>
<p><strong>Relleno predeterminado:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>DEFAULT_PADDING_MIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>DEFAULT_PADDING_MAX <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_default_padding</span>():
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(DEFAULT_PADDING_MIN, DEFAULT_PADDING_MAX)
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>bytes(size)  <span style="color:#75715e"># or zeros</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> PaddingBlock(size, data)
</span></span></code></pre></div><p><strong>Estrategias de resistencia al análisis de tráfico:</strong></p>
<p><strong>Estrategia 1: Tamaño aleatorio (predeterminado)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Add 0-15 bytes random padding to each message</span>
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">15</span>)
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>Estrategia 2: Redondear a un múltiplo</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Round total message size to next multiple of 64</span>
</span></span><span style="display:flex;"><span>target_size <span style="color:#f92672">=</span> ((message_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">63</span>) <span style="color:#f92672">//</span> <span style="color:#ae81ff">64</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> target_size <span style="color:#f92672">-</span> message_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>  <span style="color:#75715e"># -3 for block header</span>
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>Estrategia 3: Tamaños de mensajes fijos</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Always send 1KB messages</span>
</span></span><span style="display:flex;"><span>TARGET_MESSAGE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> TARGET_MESSAGE_SIZE <span style="color:#f92672">-</span> message_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>Estrategia 4: Relleno negociado (Options block)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Calculate padding based on negotiated parameters</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tmin, tmax from Options block</span>
</span></span><span style="display:flex;"><span>min_padding <span style="color:#f92672">=</span> int(payload_size <span style="color:#f92672">*</span> tmin_ratio)
</span></span><span style="display:flex;"><span>max_padding <span style="color:#f92672">=</span> int(payload_size <span style="color:#f92672">*</span> tmax_ratio)
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(min_padding, max_padding)
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>Mensajes solo de relleno:</strong></p>
<p>Los mensajes pueden consistir completamente en relleno (sin datos de la aplicación):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Dummy traffic message</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    PaddingBlock(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">500</span>), random<span style="color:#f92672">.</span>bytes(<span style="color:#f92672">...</span>))
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>Notas de implementación:</strong></p>
<ol>
<li><strong>Relleno de ceros</strong>: Aceptable (será cifrado por ChaCha20)</li>
<li><strong>Relleno aleatorio</strong>: No aporta seguridad adicional tras el cifrado, pero consume más entropía</li>
<li><strong>Rendimiento</strong>: La generación de relleno aleatorio puede ser costosa; considere usar ceros</li>
<li><strong>Memoria</strong>: Los bloques de relleno grandes consumen ancho de banda; tenga cuidado con el tamaño máximo</li>
</ol>
<hr>
<h2 id="guía-de-implementación">Guía de implementación</h2>
<h3 id="requisitos-previos">Requisitos previos</h3>
<p><strong>Bibliotecas criptográficas:</strong></p>
<ul>
<li><strong>X25519</strong> (intercambio de claves de curva elíptica): libsodium, NaCl o Bouncy Castle</li>
<li><strong>ChaCha20-Poly1305</strong> (algoritmo AEAD: cifrado ChaCha20 con autenticación Poly1305): libsodium, OpenSSL 1.1.0+ o Bouncy Castle</li>
<li><strong>SHA-256</strong> (función hash criptográfica de 256 bits): OpenSSL, Bouncy Castle o soporte integrado en el lenguaje</li>
<li><strong>Elligator2</strong> (técnica de ofuscación de puntos en curvas elípticas): Soporte limitado en bibliotecas; puede requerir una implementación personalizada</li>
</ul>
<p><strong>Implementación de Elligator2 (método de mapeo uniforme a curvas elípticas para ofuscación):</strong></p>
<p>Elligator2 (técnica criptográfica para ocultar claves públicas) no está ampliamente implementado. Opciones:</p>
<ol>
<li><strong>OBFS4</strong>: El pluggable transport (mecanismo de transporte modular) obfs4 de Tor incluye una implementación de Elligator2</li>
<li><strong>Implementación personalizada</strong>: Basada en <a href="https://elligator.cr.yp.to/elligator-20130828.pdf">Elligator2 paper</a>
</li>
<li><strong>kleshni/Elligator</strong>: Implementación de referencia en GitHub</li>
</ol>
<p><strong>Nota sobre Java I2P:</strong> Java I2P usa la biblioteca net.i2p.crypto.eddsa con extensiones personalizadas de Elligator2 (técnica criptográfica para camuflar claves públicas).</p>
<h3 id="orden-recomendado-de-implementación">Orden recomendado de implementación</h3>
<p><strong>Fase 1: Criptografía fundamental</strong> 1. Generación e intercambio de claves DH X25519 2. Cifrado/descifrado con AEAD ChaCha20-Poly1305 3. Cálculo de hash SHA-256 y MixHash 4. Derivación de claves mediante HKDF 5. Codificación/decodificación Elligator2 (se pueden usar vectores de prueba inicialmente)</p>
<p><strong>Fase 2: Formatos de mensajes</strong> 1. mensaje NS (no vinculado) - formato más simple 2. mensaje NS (vinculado) - añade clave estática 3. mensaje NSR 4. mensaje ES 5. Análisis y generación de bloques</p>
<p><strong>Fase 3: Gestión de sesión</strong> 1. Creación y almacenamiento de sesión 2. Gestión del conjunto de etiquetas (emisor y receptor) 3. Ratchet (mecanismo de avance) de etiquetas de sesión 4. Ratchet de clave simétrica 5. Búsqueda de etiquetas y gestión de la ventana</p>
<p><strong>Fase 4: DH Ratcheting (avance de claves con Diffie-Hellman)</strong> 1. Gestión del bloque NextKey 2. Función de derivación de claves (KDF) de DH ratchet 3. Creación del conjunto de etiquetas después del ratchet 4. Gestión de múltiples conjuntos de etiquetas</p>
<p><strong>Fase 5: Lógica del protocolo</strong> 1. Máquina de estados NS/NSR/ES 2. Prevención de ataques de repetición (DateTime, filtro de Bloom) 3. Lógica de retransmisión (múltiples NS/NSR) 4. Gestión de ACK (acuse de recibo)</p>
<p><strong>Fase 6: Integración</strong> 1. Procesamiento de I2NP Garlic Clove (unidad individual dentro de un mensaje de garlic encryption) 2. Agrupación de LeaseSet 3. Integración del protocolo de streaming 4. Integración del protocolo de datagramas</p>
<h3 id="implementación-del-emisor">Implementación del emisor</h3>
<p><strong>Ciclo de vida de la sesión saliente:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, destination, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> destination
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> bound
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>NEW
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Keys for NS message</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> bound:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>static_key <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>static_keypair
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Will be populated after NSR</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_keyratchet <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_keyratchet <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Timing</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Retransmission</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_attempts <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_initial_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Send NS message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build NS message</span>
</span></span><span style="display:flex;"><span>        ns_message <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>build_ns_message(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send</span>
</span></span><span style="display:flex;"><span>        send_to_network(self<span style="color:#f92672">.</span>destination, ns_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Track for retransmission</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_attempts<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;message&#39;</span>: ns_message,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;time&#39;</span>: now(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;ephemeral_key&#39;</span>: self<span style="color:#f92672">.</span>ephemeral_keypair,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;kdf_state&#39;</span>: self<span style="color:#f92672">.</span>save_kdf_state()
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Start timer</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> set_timer(<span style="color:#ae81ff">1.0</span>, self<span style="color:#f92672">.</span>on_ns_timeout)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>PENDING_REPLY
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_ns_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Construct NS message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># KDF initialization</span>
</span></span><span style="display:flex;"><span>        chainKey, h <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>initialize_kdf()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Ephemeral key section</span>
</span></span><span style="display:flex;"><span>        elg2_ephemeral <span style="color:#f92672">=</span> ENCODE_ELG2(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> self<span style="color:#f92672">.</span>destination<span style="color:#f92672">.</span>static_key)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># es DH</span>
</span></span><span style="display:flex;"><span>        es_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                       self<span style="color:#f92672">.</span>destination<span style="color:#f92672">.</span>static_key)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, es_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_static <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt static key section</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>bound:
</span></span><span style="display:flex;"><span>            static_section <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>static_key<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            static_section <span style="color:#f92672">=</span> bytes(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        static_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_static, <span style="color:#ae81ff">0</span>, static_section, h)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> static_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ss DH (if bound)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>bound:
</span></span><span style="display:flex;"><span>            ss_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>static_key<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                          self<span style="color:#f92672">.</span>destination<span style="color:#f92672">.</span>static_key)
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(chainKey, ss_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> k_static
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build payload blocks</span>
</span></span><span style="display:flex;"><span>        payload_data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>build_ns_payload(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt payload</span>
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_payload, nonce, payload_data, h)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> payload_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Save KDF state for NSR processing</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_chainkey <span style="color:#f92672">=</span> chainKey
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_hash <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Assemble message</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> elg2_ephemeral <span style="color:#f92672">+</span> static_ciphertext <span style="color:#f92672">+</span> payload_ciphertext
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_ns_payload</span>(self, application_data):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Build NS payload blocks&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        blocks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># DateTime block (required, first)</span>
</span></span><span style="display:flex;"><span>        blocks<span style="color:#f92672">.</span>append(build_datetime_block())
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Garlic Clove(s) with application data</span>
</span></span><span style="display:flex;"><span>        blocks<span style="color:#f92672">.</span>append(build_garlic_clove(application_data))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Optionally bundle LeaseSet</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> should_send_leaseset():
</span></span><span style="display:flex;"><span>            blocks<span style="color:#f92672">.</span>append(build_garlic_clove(build_leaseset_store()))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Padding</span>
</span></span><span style="display:flex;"><span>        blocks<span style="color:#f92672">.</span>append(build_padding_block(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">15</span>)))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> encode_blocks(blocks)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_nsr_received</span>(self, nsr_message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Process NSR and establish ES session&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Cancel retransmission timer</span>
</span></span><span style="display:flex;"><span>        cancel_timer(self<span style="color:#f92672">.</span>ns_timer)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Parse NSR</span>
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>        elg2_bob_ephemeral <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">40</span>]
</span></span><span style="display:flex;"><span>        key_section_mac <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">40</span>:<span style="color:#ae81ff">56</span>]
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">56</span>:]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Find corresponding NS attempt</span>
</span></span><span style="display:flex;"><span>        ns_state <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>find_ns_by_tag(tag)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> ns_state:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;NSR tag doesn&#39;t match any NS&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Restore KDF state</span>
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> ns_state[<span style="color:#e6db74">&#39;chainkey&#39;</span>]
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> ns_state[<span style="color:#e6db74">&#39;hash&#39;</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decode Bob&#39;s ephemeral key</span>
</span></span><span style="display:flex;"><span>        bob_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(elg2_bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix tag and Bob&#39;s ephemeral into hash</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> tag)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ee DH</span>
</span></span><span style="display:flex;"><span>        ee_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>private_key, bob_ephemeral)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ee_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># se DH</span>
</span></span><span style="display:flex;"><span>        se_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>static_key<span style="color:#f92672">.</span>private_key, bob_ephemeral)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, se_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_key_section <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify key section MAC</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            DECRYPT(k_key_section, <span style="color:#ae81ff">0</span>, key_section_mac, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;NSR key section MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> key_section_mac)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Split for bidirectional ES</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        k_ab <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Alice → Bob</span>
</span></span><span style="display:flex;"><span>        k_ba <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Bob → Alice</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize ES tagsets</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ab)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ba)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt NSR payload</span>
</span></span><span style="display:flex;"><span>        k_nsr <span style="color:#f92672">=</span> HKDF(k_ba, ZEROLEN, <span style="color:#e6db74">&#34;AttachPayloadKDF&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> DECRYPT(k_nsr, <span style="color:#ae81ff">0</span>, payload_ciphertext, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;NSR payload MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process NSR payload blocks</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>process_payload_blocks(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Session established</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send ES message (implicit ACK)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>send_es_ack()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_es_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Send ES message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">!=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Session not established&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get next tag and key</span>
</span></span><span style="display:flex;"><span>        tag, index <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>outbound_keyratchet<span style="color:#f92672">.</span>get_key(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Construct nonce</span>
</span></span><span style="display:flex;"><span>        nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build payload blocks</span>
</span></span><span style="display:flex;"><span>        payload_data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>build_es_payload(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># AEAD encryption</span>
</span></span><span style="display:flex;"><span>        ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, payload_data, tag)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Assemble message</span>
</span></span><span style="display:flex;"><span>        es_message <span style="color:#f92672">=</span> tag <span style="color:#f92672">+</span> ciphertext
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send</span>
</span></span><span style="display:flex;"><span>        send_to_network(self<span style="color:#f92672">.</span>destination, es_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update activity</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if ratchet needed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>should_ratchet():
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>initiate_ratchet()
</span></span></code></pre></div><h3 id="implementación-del-receptor">Implementación del receptor</h3>
<p><strong>Ciclo de vida de la sesión entrante:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Keys</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>remote_ephemeral_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>remote_static_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Tagsets</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Timing</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Paired session</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>paired_outbound <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">try_decrypt_ns</span>(message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Attempt to decrypt as NS message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Parse NS structure</span>
</span></span><span style="display:flex;"><span>        elg2_ephemeral <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">32</span>]
</span></span><span style="display:flex;"><span>        static_ciphertext <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">80</span>]  <span style="color:#75715e"># 32 + 16</span>
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">80</span>:]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decode ephemeral key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            alice_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(elg2_ephemeral)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Not a valid Elligator2 encoding</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check replay</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_replay(alice_ephemeral):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># KDF initialization</span>
</span></span><span style="display:flex;"><span>        chainKey, h <span style="color:#f92672">=</span> initialize_kdf()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix keys</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> alice_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># es DH</span>
</span></span><span style="display:flex;"><span>        es_shared <span style="color:#f92672">=</span> DH(context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>private_key, alice_ephemeral)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, es_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_static <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt static key section</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            static_data <span style="color:#f92672">=</span> DECRYPT(k_static, <span style="color:#ae81ff">0</span>, static_ciphertext, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Not a valid NS message</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> static_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if bound or unbound</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> static_data <span style="color:#f92672">==</span> bytes(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Unbound</span>
</span></span><span style="display:flex;"><span>            alice_static_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> k_static
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Bound - perform ss DH</span>
</span></span><span style="display:flex;"><span>            alice_static_key <span style="color:#f92672">=</span> static_data
</span></span><span style="display:flex;"><span>            ss_shared <span style="color:#f92672">=</span> DH(context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>private_key, alice_static_key)
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(chainKey, ss_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt payload</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> DECRYPT(k_payload, nonce, payload_ciphertext, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> payload_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create session</span>
</span></span><span style="display:flex;"><span>        session <span style="color:#f92672">=</span> InboundSession()
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>remote_ephemeral_key <span style="color:#f92672">=</span> alice_ephemeral
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>remote_static_key <span style="color:#f92672">=</span> alice_static_key
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> (alice_static_key <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>ns_chainkey <span style="color:#f92672">=</span> chainKey
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>ns_hash <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Extract destination if bound</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>bound:
</span></span><span style="display:flex;"><span>            session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> extract_destination_from_payload(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process payload</span>
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>process_payload_blocks(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> session
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_nsr_reply</span>(self, reply_payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Send NSR message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate NSR tagset</span>
</span></span><span style="display:flex;"><span>        tagsetKey <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>ns_chainkey, ZEROLEN, <span style="color:#e6db74">&#34;SessionReplyTags&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        nsr_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(self<span style="color:#f92672">.</span>ns_chainkey, tagsetKey)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get tag</span>
</span></span><span style="display:flex;"><span>        tag, _ <span style="color:#f92672">=</span> nsr_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix tag into hash</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(self<span style="color:#f92672">.</span>ns_hash <span style="color:#f92672">||</span> tag)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate ephemeral key</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>        bob_ephemeral <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>        elg2_bob_ephemeral <span style="color:#f92672">=</span> ENCODE_ELG2(bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix ephemeral key</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>ns_chainkey
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ee DH</span>
</span></span><span style="display:flex;"><span>        ee_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                      self<span style="color:#f92672">.</span>remote_ephemeral_key)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ee_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># se DH</span>
</span></span><span style="display:flex;"><span>        se_shared <span style="color:#f92672">=</span> DH(context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                      self<span style="color:#f92672">.</span>remote_ephemeral_key)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, se_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_key_section <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt key section (empty)</span>
</span></span><span style="display:flex;"><span>        key_section_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_key_section, <span style="color:#ae81ff">0</span>, ZEROLEN, h)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> key_section_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Split for bidirectional ES</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        k_ab <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Alice → Bob</span>
</span></span><span style="display:flex;"><span>        k_ba <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Bob → Alice</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize ES tagsets</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ab)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ba)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build reply payload</span>
</span></span><span style="display:flex;"><span>        payload_data <span style="color:#f92672">=</span> build_payload_blocks(reply_payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt payload</span>
</span></span><span style="display:flex;"><span>        k_nsr <span style="color:#f92672">=</span> HKDF(k_ba, ZEROLEN, <span style="color:#e6db74">&#34;AttachPayloadKDF&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_nsr, <span style="color:#ae81ff">0</span>, payload_data, h)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Assemble NSR</span>
</span></span><span style="display:flex;"><span>        nsr_message <span style="color:#f92672">=</span> tag <span style="color:#f92672">+</span> elg2_bob_ephemeral <span style="color:#f92672">+</span> key_section_ciphertext <span style="color:#f92672">+</span> payload_ciphertext
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send</span>
</span></span><span style="display:flex;"><span>        send_to_network(self<span style="color:#f92672">.</span>destination, nsr_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Wait for ES</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>AWAITING_ES
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_es_received</span>(self, es_message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Process first ES message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>AWAITING_ES:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># First ES received, confirms session</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process ES message</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>process_es_message(es_message)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_es_message</span>(self, es_message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Decrypt and process ES message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Extract tag</span>
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> es_message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>        ciphertext <span style="color:#f92672">=</span> es_message[<span style="color:#ae81ff">8</span>:]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Look up tag</span>
</span></span><span style="display:flex;"><span>        index <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>lookup_tag(tag)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Tag not found&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get key</span>
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>inbound_keyratchet<span style="color:#f92672">.</span>get_key(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Construct nonce</span>
</span></span><span style="display:flex;"><span>        nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> DECRYPT(key, nonce, ciphertext, tag)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;ES MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process blocks</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>process_payload_blocks(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update activity</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span></code></pre></div><h3 id="clasificación-de-mensajes">Clasificación de mensajes</h3>
<p><strong>Distinción de tipos de mensajes:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">classify_message</span>(message):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Determine message type&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Minimum lengths</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">24</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Too short</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for session tag (8 bytes)</span>
</span></span><span style="display:flex;"><span>    tag <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Try ES decryption first (most common)</span>
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> lookup_session_by_tag(tag)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;ES&#39;</span>, session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Try NSR decryption (tag + Elligator2 key)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">72</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if bytes 8-40 are valid Elligator2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            nsr_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(message[<span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">40</span>])
</span></span><span style="display:flex;"><span>            nsr_session <span style="color:#f92672">=</span> find_pending_nsr_by_tag(tag)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> nsr_session:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;NSR&#39;</span>, nsr_session)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Try NS decryption (starts with Elligator2 key)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">96</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            ns_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">32</span>])
</span></span><span style="display:flex;"><span>            ns_session <span style="color:#f92672">=</span> InboundSession<span style="color:#f92672">.</span>try_decrypt_ns(message)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ns_session:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;NS&#39;</span>, ns_session)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check ElGamal/AES (for dual-key compatibility)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">514</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (len(message) <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Might be ElGamal NS</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;ELGAMAL_NS&#39;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> len(message) <span style="color:#f92672">%</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Might be ElGamal ES</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;ELGAMAL_ES&#39;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Unknown message type</span>
</span></span></code></pre></div><h3 id="mejores-prácticas-de-gestión-de-sesiones">Mejores prácticas de gestión de sesiones</h3>
<p><strong>Almacenamiento de sesión:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SessionKeyManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Outbound sessions (one per destination)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_sessions <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># destination -&gt; OutboundSession</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Inbound sessions (multiple per destination during transition)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions <span style="color:#f92672">=</span> []  <span style="color:#75715e"># [InboundSession]</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Session tag lookup (fast path for ES messages)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tag_to_session <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># tag -&gt; InboundSession</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Limits</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_inbound_sessions <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tags_per_session <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_outbound_session</span>(self, destination):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get or create outbound session&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> destination <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>outbound_sessions:
</span></span><span style="display:flex;"><span>            session <span style="color:#f92672">=</span> OutboundSession(destination)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>outbound_sessions[destination] <span style="color:#f92672">=</span> session
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>outbound_sessions[destination]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_inbound_session</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Add new inbound session&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check limits</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(self<span style="color:#f92672">.</span>inbound_sessions) <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_inbound_sessions:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>expire_oldest_session()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions<span style="color:#f92672">.</span>append(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add tags to lookup table</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>register_session_tags(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_session_tags</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Register session&#39;s tags in lookup table&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>get_all_tags():
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>tag_to_session[tag] <span style="color:#f92672">=</span> session
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lookup_tag</span>(self, tag):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Fast tag lookup&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>tag_to_session<span style="color:#f92672">.</span>get(tag)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">expire_sessions</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Periodic session expiration&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        now_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire outbound sessions</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> dest, session <span style="color:#f92672">in</span> list(self<span style="color:#f92672">.</span>outbound_sessions<span style="color:#f92672">.</span>items()):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time(now_time) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>outbound_sessions[dest]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire inbound sessions</span>
</span></span><span style="display:flex;"><span>        expired <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>inbound_sessions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time(now_time) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:
</span></span><span style="display:flex;"><span>                expired<span style="color:#f92672">.</span>append(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> expired:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>remove_inbound_session(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_inbound_session</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Remove inbound session and clean up tags&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions<span style="color:#f92672">.</span>remove(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Remove tags from lookup</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>get_all_tags():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tag <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>tag_to_session:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>tag_to_session[tag]
</span></span></code></pre></div><p><strong>Gestión de memoria:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TagMemoryManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, max_memory_kb<span style="color:#f92672">=</span><span style="color:#ae81ff">10240</span>):  <span style="color:#75715e"># 10 MB default</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_memory <span style="color:#f92672">=</span> max_memory_kb <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_memory <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tags_per_session <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>min_tags_per_session <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_tag_memory</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Calculate memory used by session tags&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        tag_count <span style="color:#f92672">=</span> len(session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>tags)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Each tag: 8 bytes (tag) + 2 bytes (index) + 32 bytes (key, optional)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># + overhead</span>
</span></span><span style="display:flex;"><span>        bytes_per_tag <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span> <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>defer_keys <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> tag_count <span style="color:#f92672">*</span> bytes_per_tag
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_pressure</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Check if under memory pressure&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>current_memory <span style="color:#f92672">&gt;</span> (self<span style="color:#f92672">.</span>max_memory <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.9</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_pressure</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Reduce memory usage when under pressure&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>check_pressure():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 1: Reduce look-ahead windows</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> all_sessions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">&gt;</span> self<span style="color:#f92672">.</span>min_tags_per_session:
</span></span><span style="display:flex;"><span>                session<span style="color:#f92672">.</span>reduce_look_ahead(self<span style="color:#f92672">.</span>min_tags_per_session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 2: Trim old tags aggressively</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> all_sessions:
</span></span><span style="display:flex;"><span>            session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>trim_behind(aggressive<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 3: Refuse new ratchets</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> all_sessions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>should_ratchet():
</span></span><span style="display:flex;"><span>                session<span style="color:#f92672">.</span>defer_ratchet <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 4: Expire idle sessions early</span>
</span></span><span style="display:flex;"><span>        expire_idle_sessions(threshold<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span>)  <span style="color:#75715e"># 5 min instead of 10</span>
</span></span></code></pre></div><h3 id="estrategias-de-prueba">Estrategias de prueba</h3>
<p><strong>Pruebas unitarias:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_x25519_dh</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test X25519 key exchange&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    alice_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    alice_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(alice_sk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    bob_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    bob_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(bob_sk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Both sides compute same shared secret</span>
</span></span><span style="display:flex;"><span>    alice_shared <span style="color:#f92672">=</span> DH(alice_sk, bob_pk)
</span></span><span style="display:flex;"><span>    bob_shared <span style="color:#f92672">=</span> DH(bob_sk, alice_pk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> alice_shared <span style="color:#f92672">==</span> bob_shared
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_elligator2_encode_decode</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test Elligator2 roundtrip&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    sk <span style="color:#f92672">=</span> GENERATE_PRIVATE_ELG2()
</span></span><span style="display:flex;"><span>    pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(sk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    encoded <span style="color:#f92672">=</span> ENCODE_ELG2(pk)
</span></span><span style="display:flex;"><span>    decoded <span style="color:#f92672">=</span> DECODE_ELG2(encoded)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> decoded <span style="color:#f92672">==</span> pk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_chacha_poly_encrypt_decrypt</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test ChaCha20-Poly1305 AEAD&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> construct_nonce(<span style="color:#ae81ff">42</span>)
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello, I2P!&#34;</span>
</span></span><span style="display:flex;"><span>    ad <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;associated_data&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext, ad)
</span></span><span style="display:flex;"><span>    decrypted <span style="color:#f92672">=</span> DECRYPT(key, nonce, ciphertext, ad)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> decrypted <span style="color:#f92672">==</span> plaintext
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_session_tag_ratchet</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test session tag generation&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    sessTag_ck <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    tagset <span style="color:#f92672">=</span> SessionTagRatchet(sessTag_ck)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate 100 tags</span>
</span></span><span style="display:flex;"><span>    tags <span style="color:#f92672">=</span> [tagset<span style="color:#f92672">.</span>get_next_tag() <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>)]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># All tags should be unique</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> len(set(tags)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Each tag should be 8 bytes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> tags:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(tag) <span style="color:#f92672">==</span> <span style="color:#ae81ff">8</span>
</span></span></code></pre></div><p><strong>Pruebas de integración:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_ns_nsr_handshake</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test NS/NSR handshake&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice creates outbound session</span>
</span></span><span style="display:flex;"><span>    alice_session <span style="color:#f92672">=</span> OutboundSession(bob_destination, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice sends NS</span>
</span></span><span style="display:flex;"><span>    ns_message <span style="color:#f92672">=</span> alice_session<span style="color:#f92672">.</span>build_ns_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello Bob&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob receives NS</span>
</span></span><span style="display:flex;"><span>    bob_session <span style="color:#f92672">=</span> InboundSession<span style="color:#f92672">.</span>try_decrypt_ns(ns_message)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> bob_session <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> bob_session<span style="color:#f92672">.</span>bound <span style="color:#f92672">==</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob sends NSR</span>
</span></span><span style="display:flex;"><span>    nsr_message <span style="color:#f92672">=</span> bob_session<span style="color:#f92672">.</span>build_nsr_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello Alice&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice receives NSR</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>on_nsr_received(nsr_message)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> alice_session<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Both should have matching ES tagsets</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># (Cannot directly compare, but can test by sending ES messages)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_es_bidirectional</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test ES messages in both directions&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># (After NS/NSR handshake)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice sends ES to Bob</span>
</span></span><span style="display:flex;"><span>    es_alice_to_bob <span style="color:#f92672">=</span> alice_session<span style="color:#f92672">.</span>send_es_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Data from Alice&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob receives ES</span>
</span></span><span style="display:flex;"><span>    bob_session<span style="color:#f92672">.</span>process_es_message(es_alice_to_bob)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob sends ES to Alice</span>
</span></span><span style="display:flex;"><span>    es_bob_to_alice <span style="color:#f92672">=</span> bob_session<span style="color:#f92672">.</span>send_es_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Data from Bob&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice receives ES</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>process_es_message(es_bob_to_alice)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_dh_ratchet</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test DH ratchet&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># (After established session)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice initiates ratchet</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>initiate_ratchet()
</span></span><span style="display:flex;"><span>    nextkey_alice <span style="color:#f92672">=</span> build_nextkey_block(
</span></span><span style="display:flex;"><span>        flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>,
</span></span><span style="display:flex;"><span>        key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        public_key<span style="color:#f92672">=</span>alice_new_key
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send to Bob</span>
</span></span><span style="display:flex;"><span>    bob_session<span style="color:#f92672">.</span>process_nextkey_block(nextkey_alice)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob replies</span>
</span></span><span style="display:flex;"><span>    nextkey_bob <span style="color:#f92672">=</span> build_nextkey_block(
</span></span><span style="display:flex;"><span>        flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>,
</span></span><span style="display:flex;"><span>        key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        public_key<span style="color:#f92672">=</span>bob_new_key
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send to Alice</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>process_nextkey_block(nextkey_bob)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Both should now be using new tagsets</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> alice_session<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> bob_session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>Vectores de prueba:</strong></p>
<p>Implementar vectores de prueba de la especificación:</p>
<ol>
<li><strong>Noise IK Handshake</strong>: Use vectores de prueba estándar de Noise</li>
<li><strong>HKDF</strong>: Use vectores de prueba del RFC 5869</li>
<li><strong>ChaCha20-Poly1305</strong>: Use vectores de prueba del RFC 7539</li>
<li><strong>Elligator2</strong>: Use vectores de prueba del artículo de Elligator2 o de OBFS4</li>
</ol>
<p><strong>Pruebas de interoperabilidad:</strong></p>
<ol>
<li><strong>Java I2P</strong>: Probar frente a la implementación de referencia de Java I2P</li>
<li><strong>i2pd</strong>: Probar frente a la implementación de i2pd en C++</li>
<li><strong>Capturas de paquetes</strong>: Usar el disector de Wireshark (si está disponible) para verificar los formatos de mensajes</li>
<li><strong>Entre implementaciones</strong>: Crear un banco de pruebas que pueda enviar/recibir entre implementaciones</li>
</ol>
<h3 id="consideraciones-de-rendimiento">Consideraciones de rendimiento</h3>
<p><strong>Generación de claves:</strong></p>
<p>La generación de claves mediante Elligator2 (técnica criptográfica) es costosa (tasa de rechazo del 50%):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KeyPool</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Pre-generate keys in background thread&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, pool_size<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pool <span style="color:#f92672">=</span> Queue(maxsize<span style="color:#f92672">=</span>pool_size)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>generator_thread <span style="color:#f92672">=</span> Thread(target<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>generate_keys, daemon<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>generator_thread<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_keys</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>full():
</span></span><span style="display:flex;"><span>                keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Also compute encoded form</span>
</span></span><span style="display:flex;"><span>                encoded <span style="color:#f92672">=</span> ENCODE_ELG2(keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>put((keypair, encoded))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_keypair</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>get(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1.0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> Empty:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Pool exhausted, generate inline</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> generate_elg2_keypair()
</span></span></code></pre></div><p><strong>Búsqueda de etiquetas:</strong></p>
<p>Utiliza tablas hash para la búsqueda de etiquetas en O(1):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FastTagLookup</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tag_to_session <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Python dict is hash table</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_tag</span>(self, tag, session, index):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 8-byte tag as bytes is hashable</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tag_to_session[tag] <span style="color:#f92672">=</span> (session, index)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lookup_tag</span>(self, tag):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>tag_to_session<span style="color:#f92672">.</span>get(tag)
</span></span></code></pre></div><p><strong>Optimización de memoria:</strong></p>
<p>Diferir la generación de claves simétricas:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DeferredKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Only generate keys when needed&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cache <span style="color:#f92672">=</span> LRUCache(maxsize<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># Cache recent keys</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check cache first</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>cache:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>cache[index]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate keys up to index</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&lt;</span> index:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">==</span> index:
</span></span><span style="display:flex;"><span>                key <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>cache[index] <span style="color:#f92672">=</span> key
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> key
</span></span></code></pre></div><p><strong>Procesamiento por lotes:</strong></p>
<p>Procesar múltiples mensajes por lotes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_message_batch</span>(messages):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Process multiple messages efficiently&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    results <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Group by type</span>
</span></span><span style="display:flex;"><span>    ns_messages <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    nsr_messages <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    es_messages <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> messages:
</span></span><span style="display:flex;"><span>        msg_type <span style="color:#f92672">=</span> classify_message(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> msg_type[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;NS&#39;</span>:
</span></span><span style="display:flex;"><span>            ns_messages<span style="color:#f92672">.</span>append(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> msg_type[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;NSR&#39;</span>:
</span></span><span style="display:flex;"><span>            nsr_messages<span style="color:#f92672">.</span>append(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> msg_type[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ES&#39;</span>:
</span></span><span style="display:flex;"><span>            es_messages<span style="color:#f92672">.</span>append(msg)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Process in batches</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ES messages are most common, process first</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> es_messages:
</span></span><span style="display:flex;"><span>        results<span style="color:#f92672">.</span>append(process_es_message(msg))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> nsr_messages:
</span></span><span style="display:flex;"><span>        results<span style="color:#f92672">.</span>append(process_nsr_message(msg))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> ns_messages:
</span></span><span style="display:flex;"><span>        results<span style="color:#f92672">.</span>append(process_ns_message(msg))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> results
</span></span></code></pre></div><hr>
<h2 id="consideraciones-de-seguridad">Consideraciones de seguridad</h2>
<h3 id="modelo-de-amenazas">Modelo de amenazas</h3>
<p><strong>Capacidades del adversario:</strong></p>
<ol>
<li><strong>Observador pasivo</strong>: Puede observar todo el tráfico de la red</li>
<li><strong>Atacante activo</strong>: Puede inyectar, modificar, descartar y repetir mensajes</li>
<li><strong>Nodo comprometido</strong>: Puede comprometer un router o un destino</li>
<li><strong>Análisis de tráfico</strong>: Puede realizar análisis estadístico de los patrones de tráfico</li>
</ol>
<p><strong>Objetivos de seguridad:</strong></p>
<ol>
<li><strong>Confidencialidad</strong>: Contenido del mensaje oculto para el observador</li>
<li><strong>Autenticación</strong>: Identidad del remitente verificada (para sesiones vinculadas)</li>
<li><strong>Secreto perfecto hacia adelante</strong>: Los mensajes pasados permanecen secretos incluso si se comprometen las claves</li>
<li><strong>Prevención de repetición</strong>: No se pueden repetir mensajes antiguos</li>
<li><strong>Ofuscación del tráfico</strong>: Los handshakes son indistinguibles de datos aleatorios</li>
</ol>
<h3 id="supuestos-criptográficos">Supuestos criptográficos</h3>
<p><strong>Suposiciones de dificultad:</strong></p>
<ol>
<li><strong>X25519 CDH</strong>: El problema de Diffie-Hellman computacional es difícil en Curve25519</li>
<li><strong>ChaCha20 PRF</strong>: ChaCha20 es una función pseudoaleatoria</li>
<li><strong>Poly1305 MAC</strong>: Poly1305 es inforjable bajo ataque de mensaje elegido</li>
<li><strong>SHA-256 CR</strong>: SHA-256 es resistente a colisiones</li>
<li><strong>HKDF Security</strong>: HKDF extrae y expande claves distribuidas uniformemente</li>
</ol>
<p><strong>Niveles de seguridad:</strong></p>
<ul>
<li><strong>X25519</strong>: seguridad de ~128 bits (orden de la curva 2^252)</li>
<li><strong>ChaCha20</strong>: claves de 256 bits, seguridad de 256 bits</li>
<li><strong>Poly1305</strong>: seguridad de 128 bits (probabilidad de colisión)</li>
<li><strong>SHA-256</strong>: resistencia a colisiones de 128 bits, resistencia a preimagen de 256 bits</li>
</ul>
<h3 id="gestión-de-claves">Gestión de claves</h3>
<p><strong>Generación de claves:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Use cryptographically secure RNG</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">CSRNG</span>(length):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># GOOD: os.urandom, secrets.token_bytes (Python)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># GOOD: /dev/urandom (Linux)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># GOOD: BCryptGenRandom (Windows)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># BAD: random.random(), Math.random() (NOT cryptographically secure)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> os<span style="color:#f92672">.</span>urandom(length)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Validate keys</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_x25519_key</span>(pubkey):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for weak keys (all zeros, small order points)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> pubkey <span style="color:#f92672">==</span> bytes(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> WeakKeyError(<span style="color:#e6db74">&#34;All-zero public key&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform DH to check for weak shared secrets</span>
</span></span><span style="display:flex;"><span>    test_shared <span style="color:#f92672">=</span> DH(test_private_key, pubkey)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> test_shared <span style="color:#f92672">==</span> bytes(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> WeakKeyError(<span style="color:#e6db74">&#34;Results in zero shared secret&#34;</span>)
</span></span></code></pre></div><p><strong>Almacenamiento de claves:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Protect private keys</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecureKeyStorage</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Store in memory with protection</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>keys <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Option 1: Memory locking (prevent swapping to disk)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># mlock(self.keys)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Option 2: Encrypted storage</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># self.encryption_key = derive_from_password()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">store_key</span>(self, key_id, private_key):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Option: Encrypt before storage</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># encrypted = encrypt(private_key, self.encryption_key)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># self.keys[key_id] = encrypted</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>keys[key_id] <span style="color:#f92672">=</span> private_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_key</span>(self, key_id):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Securely wipe memory</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> key_id <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>keys:
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>keys[key_id]
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Overwrite with zeros before deletion</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(key)):
</span></span><span style="display:flex;"><span>                key[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>keys[key_id]
</span></span></code></pre></div><p><strong>Rotación de claves:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Rotate keys regularly</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KeyRotationPolicy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_messages_per_tagset <span style="color:#f92672">=</span> <span style="color:#ae81ff">4096</span>  <span style="color:#75715e"># Ratchet before 65535</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tagset_age <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>       <span style="color:#75715e"># 10 minutes</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_session_age <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>      <span style="color:#75715e"># 1 hour</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">should_ratchet</span>(self, tagset):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (tagset<span style="color:#f92672">.</span>messages_sent <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_messages_per_tagset <span style="color:#f92672">or</span>
</span></span><span style="display:flex;"><span>                tagset<span style="color:#f92672">.</span>age() <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_tagset_age)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">should_replace_session</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> session<span style="color:#f92672">.</span>age() <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_session_age
</span></span></code></pre></div><h3 id="mitigaciones-de-ataques">Mitigaciones de ataques</h3>
<h3 id="mitigaciones-contra-ataques-de-repetición">Mitigaciones contra ataques de repetición</h3>
<p><strong>Validación de fecha y hora:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>MAX_CLOCK_SKEW_PAST <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>MAX_CLOCK_SKEW_FUTURE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_datetime</span>(timestamp):
</span></span><span style="display:flex;"><span>    now <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span>    age <span style="color:#f92672">=</span> now <span style="color:#f92672">-</span> timestamp
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span>MAX_CLOCK_SKEW_FUTURE:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> ReplayError(<span style="color:#e6db74">&#34;Timestamp too far in future&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&gt;</span> MAX_CLOCK_SKEW_PAST:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> ReplayError(<span style="color:#e6db74">&#34;Timestamp too old&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><p><strong>Filtro de Bloom para mensajes NS:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReplayFilter</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, capacity<span style="color:#f92672">=</span><span style="color:#ae81ff">100000</span>, error_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>, duration<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bloom <span style="color:#f92672">=</span> BloomFilter(capacity<span style="color:#f92672">=</span>capacity, error_rate<span style="color:#f92672">=</span>error_rate)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>duration <span style="color:#f92672">=</span> duration
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>entries <span style="color:#f92672">=</span> []  <span style="color:#75715e"># (timestamp, ephemeral_key)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_replay</span>(self, ephemeral_key, timestamp):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Validate timestamp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> validate_datetime(timestamp):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check Bloom filter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ephemeral_key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>bloom:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Potential replay (or false positive)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Check exact match in entries</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> ts, key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>entries:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> key <span style="color:#f92672">==</span> ephemeral_key:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Definite replay</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add to filter</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bloom<span style="color:#f92672">.</span>add(ephemeral_key)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>entries<span style="color:#f92672">.</span>append((timestamp, ephemeral_key))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire old entries</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>expire_old_entries()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">expire_old_entries</span>(self):
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>entries <span style="color:#f92672">=</span> [(ts, key) <span style="color:#66d9ef">for</span> ts, key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>entries
</span></span><span style="display:flex;"><span>                       <span style="color:#66d9ef">if</span> now <span style="color:#f92672">-</span> ts <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>duration]
</span></span></code></pre></div><p><strong>Uso único de Session Tag (etiquetas de sesión):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_session_tag</span>(tag):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Look up tag</span>
</span></span><span style="display:flex;"><span>    entry <span style="color:#f92672">=</span> tagset<span style="color:#f92672">.</span>lookup_tag(tag)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> entry <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Invalid session tag&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># CRITICAL: Remove tag immediately (one-time use)</span>
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>remove_tag(tag)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Use associated key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> entry<span style="color:#f92672">.</span>key, entry<span style="color:#f92672">.</span>index
</span></span></code></pre></div><h3 id="mitigaciones-contra-la-suplantación-por-compromiso-de-clave-kci">Mitigaciones contra la suplantación por compromiso de clave (KCI)</h3>
<p><strong>Problema</strong>: La autenticación de los mensajes NS es vulnerable a KCI (suplantación por compromiso de clave) (Nivel de autenticación 1)</p>
<p><strong>Mitigación</strong>:</p>
<ol>
<li>Realiza la transición a NSR (Nivel 2 de autenticación) lo antes posible</li>
<li>No confíes en la carga útil de NS para operaciones críticas de seguridad</li>
<li>Espera la confirmación de NSR antes de realizar acciones irreversibles</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_ns_message</span>(ns_message):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># NS authenticated at Level 1 (KCI vulnerable)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Do NOT perform security-critical operations yet</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract sender&#39;s static key</span>
</span></span><span style="display:flex;"><span>    sender_key <span style="color:#f92672">=</span> ns_message<span style="color:#f92672">.</span>static_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Mark session as pending Level 2 authentication</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>auth_level <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>sender_key <span style="color:#f92672">=</span> sender_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send NSR</span>
</span></span><span style="display:flex;"><span>    send_nsr_reply(session)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_first_es_message</span>(es_message):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Now we have Level 2 authentication (KCI resistant)</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>auth_level <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Safe to perform security-critical operations</span>
</span></span><span style="display:flex;"><span>    process_security_critical_operation(es_message)
</span></span></code></pre></div><h3 id="medidas-de-mitigación-contra-la-denegación-de-servicio">Medidas de mitigación contra la denegación de servicio</h3>
<p><strong>Protección contra inundaciones de NS:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NSFloodProtection</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_count <span style="color:#f92672">=</span> defaultdict(int)  <span style="color:#75715e"># source -&gt; count</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timestamps <span style="color:#f92672">=</span> defaultdict(list)  <span style="color:#75715e"># source -&gt; [timestamps]</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_ns_per_source <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>rate_window <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># seconds</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_concurrent_ns <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_ns_allowed</span>(self, source):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Global limit</span>
</span></span><span style="display:flex;"><span>        total_pending <span style="color:#f92672">=</span> sum(self<span style="color:#f92672">.</span>ns_count<span style="color:#f92672">.</span>values())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> total_pending <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_concurrent_ns:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Per-source rate limit</span>
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        timestamps <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>ns_timestamps[source]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Remove old timestamps</span>
</span></span><span style="display:flex;"><span>        timestamps <span style="color:#f92672">=</span> [ts <span style="color:#66d9ef">for</span> ts <span style="color:#f92672">in</span> timestamps <span style="color:#66d9ef">if</span> now <span style="color:#f92672">-</span> ts <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>rate_window]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timestamps[source] <span style="color:#f92672">=</span> timestamps
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check rate</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(timestamps) <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_ns_per_source:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Allow NS</span>
</span></span><span style="display:flex;"><span>        timestamps<span style="color:#f92672">.</span>append(now)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_count[source] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_session_established</span>(self, source):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrease pending count</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>ns_count[source] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>ns_count[source] <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>Límites de almacenamiento de etiquetas:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TagStorageLimit</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, max_tags<span style="color:#f92672">=</span><span style="color:#ae81ff">1000000</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tags <span style="color:#f92672">=</span> max_tags
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">can_create_session</span>(self, look_ahead):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">+</span> look_ahead <span style="color:#f92672">&gt;</span> self<span style="color:#f92672">.</span>max_tags:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_tags</span>(self, count):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">+=</span> count
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_tags</span>(self, count):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">-=</span> count
</span></span></code></pre></div><p><strong>Gestión adaptativa de recursos:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AdaptiveResourceManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>  <span style="color:#75715e"># 0 = low, 1 = medium, 2 = high, 3 = critical</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">adjust_parameters</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Normal operation</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">160</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Moderate load</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">80</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">800</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># High load</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">32</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">500</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:  <span style="color:#75715e"># load_level == 3</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Critical load</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">16</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span></code></pre></div><h3 id="resistencia-al-análisis-de-tráfico">Resistencia al análisis de tráfico</h3>
<p><strong>Codificación Elligator2:</strong></p>
<p>Garantiza que los mensajes de negociación (handshake) sean indistinguibles de datos aleatorios:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># NS and NSR start with Elligator2-encoded ephemeral keys</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Observer cannot distinguish from random 32-byte string</span>
</span></span></code></pre></div><p><strong>Estrategias de relleno:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Resist message size fingerprinting</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_padding</span>(payload, strategy<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;random&#39;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> strategy <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;random&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Random padding 0-15 bytes</span>
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">15</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> strategy <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;round&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Round to next 64-byte boundary</span>
</span></span><span style="display:flex;"><span>        target <span style="color:#f92672">=</span> ((len(payload) <span style="color:#f92672">+</span> <span style="color:#ae81ff">63</span>) <span style="color:#f92672">//</span> <span style="color:#ae81ff">64</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> target <span style="color:#f92672">-</span> len(payload) <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>  <span style="color:#75715e"># -3 for block header</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> strategy <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;fixed&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Always 1KB messages</span>
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">-</span> len(payload) <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> build_padding_block(size)
</span></span></code></pre></div><p><strong>Ataques de temporización:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Use constant-time operations</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">constant_time_compare</span>(a, b):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Constant-time byte string comparison&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(a) <span style="color:#f92672">!=</span> len(b):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x, y <span style="color:#f92672">in</span> zip(a, b):
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">|=</span> x <span style="color:#f92672">^</span> y
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Constant-time MAC verification</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">verify_mac</span>(computed_mac, received_mac):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> constant_time_compare(computed_mac, received_mac):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Always take same time regardless of where comparison fails</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> AuthenticationError(<span style="color:#e6db74">&#34;MAC verification failed&#34;</span>)
</span></span></code></pre></div><h3 id="escollos-de-implementación">Escollos de implementación</h3>
<p><strong>Errores comunes:</strong></p>
<ol>
<li><strong>Reutilización de nonce</strong> (número usado una vez): NUNCA reutilices pares (key, nonce)
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># BAD: Reusing nonce with same key</span>
</span></span><span style="display:flex;"><span>ciphertext1 <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext1, ad1)
</span></span><span style="display:flex;"><span>ciphertext2 <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext2, ad2)  <span style="color:#75715e"># CATASTROPHIC</span>
</span></span></code></pre></div></li>
</ol>
<h1 id="correcto-nonce-número-único-de-uso-diferente-para-cada-mensaje----ciphertext1--encryptkey-nonce1-plaintext1-ad1----ciphertext2--encryptkey-nonce2-plaintext2-ad2">CORRECTO: Nonce (número único de uso) diferente para cada mensaje    ciphertext1 = ENCRYPT(key, nonce1, plaintext1, ad1)    ciphertext2 = ENCRYPT(key, nonce2, plaintext2, ad2)</h1>
<pre tabindex="0"><code>
2. **Ephemeral Key Reuse**: Generate fresh ephemeral key for each NS/NSR
```python
# MAL: Reutilizar una clave efímera    ephemeral_key = generate_elg2_keypair()    send_ns_message(ephemeral_key)    send_ns_message(ephemeral_key)  # MAL

# CORRECTO: Clave nueva para cada mensaje    send_ns_message(generate_elg2_keypair())    send_ns_message(generate_elg2_keypair())
</code></pre><ol start="3">
<li><strong>Weak RNG</strong>: Use cryptographically secure random number generator
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div></li>
</ol>
<h1 id="mal-generador-de-números-aleatorios-no-criptográfico----import-random----key--bytesrandomrandint0-255-for-_-in-range32---inseguro">MAL: Generador de números aleatorios no criptográfico    import random    key = bytes([random.randint(0, 255) for _ in range(32)])  # INSEGURO</h1>
<h1 id="bueno-generador-de-números-aleatorios-criptográficamente-seguro----import-os----key--osurandom32">BUENO: generador de números aleatorios criptográficamente seguro    import os    key = os.urandom(32)</h1>
<pre tabindex="0"><code>
4. **Timing Attacks**: Use constant-time comparisons
```python
# MAL: Comparación con salida temprana    if computed_mac == received_mac:  # Fuga de temporización

    pass

# CORRECTO: Comparación en tiempo constante    if constant_time_compare(computed_mac, received_mac):

    pass
</code></pre><ol start="5">
<li><strong>Incomplete MAC Verification</strong>: Always verify before using data
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div></li>
</ol>
<h1 id="mal-descifrar-antes-de-verificar----plaintext--chacha20_decryptkey-nonce-ciphertext----mac_ok--verify_macmac-plaintext---demasiado-tarde----if-not-mac_ok">MAL: Descifrar antes de verificar    plaintext = chacha20_decrypt(key, nonce, ciphertext)    mac_ok = verify_mac(mac, plaintext)  # DEMASIADO TARDE    if not mac_ok:</h1>
<pre><code>   return error
</code></pre>
<h1 id="correcto-aead-cifrado-autenticado-con-datos-asociados-verifica-antes-de-descifrar----try">CORRECTO: AEAD (cifrado autenticado con datos asociados) verifica antes de descifrar    try:</h1>
<pre><code>   plaintext = DECRYPT(key, nonce, ciphertext, ad)  # Verifies MAC first
</code></pre>
<p>except AuthenticationError:</p>
<pre><code>   return error
</code></pre>
<pre tabindex="0"><code>
6. **Key Deletion**: Securely wipe keys from memory
```python
# MAL: Eliminación simple    del private_key  # Sigue en memoria

# CORRECTO: Sobrescribir antes de eliminar    for i in range(len(private_key)):

    private_key[i] = 0
del private_key
</code></pre><h3 id="security-audits">Security Audits</h3>
<p><strong>Recommended Audits:</strong></p>
<ol>
<li><strong>Cryptographic Review</strong>: Expert review of KDF chains and DH operations</li>
<li><strong>Implementation Audit</strong>: Code review for timing attacks, key management, RNG usage</li>
<li><strong>Protocol Analysis</strong>: Formal verification of handshake security properties</li>
<li><strong>Side-Channel Analysis</strong>: Timing, power, and cache attacks</li>
<li><strong>Fuzzing</strong>: Random input testing for parser robustness</li>
</ol>
<p><strong>Test Cases:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Casos de prueba críticos para la seguridad</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_nonce_uniqueness</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure nonces are never reused&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    nonces <span style="color:#f92672">=</span> set()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10000</span>):
</span></span><span style="display:flex;"><span>        nonce <span style="color:#f92672">=</span> construct_nonce(i)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> nonce <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> nonces
</span></span><span style="display:flex;"><span>        nonces<span style="color:#f92672">.</span>add(nonce)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_key_isolation</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure sessions don&#39;t share keys&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    session1 <span style="color:#f92672">=</span> create_session(destination1)
</span></span><span style="display:flex;"><span>    session2 <span style="color:#f92672">=</span> create_session(destination2)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> session1<span style="color:#f92672">.</span>key <span style="color:#f92672">!=</span> session2<span style="color:#f92672">.</span>key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_replay_prevention</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure replay attacks are detected&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    ns_message <span style="color:#f92672">=</span> create_ns_message()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># First delivery succeeds</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> process_ns_message(ns_message) <span style="color:#f92672">==</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Replay fails</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> process_ns_message(ns_message) <span style="color:#f92672">==</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_mac_verification</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure MAC verification is enforced&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> construct_nonce(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>    ad <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;test_ad&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext, ad)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Correct MAC verifies</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> DECRYPT(key, nonce, ciphertext, ad) <span style="color:#f92672">==</span> plaintext
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Corrupted MAC fails</span>
</span></span><span style="display:flex;"><span>    corrupted <span style="color:#f92672">=</span> ciphertext[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> bytes([ciphertext[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">^</span> <span style="color:#ae81ff">0xFF</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> pytest<span style="color:#f92672">.</span>raises(AuthenticationError):
</span></span><span style="display:flex;"><span>        DECRYPT(key, nonce, corrupted, ad)
</span></span></code></pre></div><hr>
<h2 id="configuration-and-deployment">Configuration and Deployment</h2>
<h3 id="i2cp-configuration">I2CP Configuration</h3>
<p><strong>Enable ECIES Encryption:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Solo ECIES (esquema integrado de cifrado en curvas elípticas) (recomendado para nuevos despliegues)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Doble clave (ECIES + ElGamal por compatibilidad)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4,0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Solo ElGamal (heredado, no recomendado)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
</span></span></code></pre></div><p><strong>LeaseSet Type:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># LS2 estándar (el más común)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetType</span><span style="color:#f92672">=</span><span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># LS2 cifrado (destinos cegados)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetType</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Meta LS2 (múltiples destinos)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetType</span><span style="color:#f92672">=</span><span style="color:#e6db74">7</span>
</span></span></code></pre></div><p><strong>Additional Options:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Clave estática para ECIES (esquema de cifrado integrado de curva elíptica) (opcional, se genera automáticamente si no se especifica)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Clave pública X25519 de 32 bytes, codificada en base64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetPrivateKey</span><span style="color:#f92672">=</span><span style="color:#e6db74">&lt;base64-encoded-key&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tipo de firma (para LeaseSet)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetSigningPrivateKey</span><span style="color:#f92672">=</span><span style="color:#e6db74">&lt;base64-encoded-key&gt; i2cp.leaseSetSigningType=7  # Ed25519</span>
</span></span></code></pre></div><h3 id="java-i2p-configuration">Java I2P Configuration</h3>
<p><strong>router.config:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># ECIES de router a router (Esquema de Cifrado Integrado de Curva Elíptica)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.useECIES</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span></code></pre></div><p><strong>Build Properties:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// Para clientes I2CP (Java) Properties props = new Properties(); props.setProperty(&#34;i2cp.leaseSetEncType&#34;, &#34;4&#34;); props.setProperty(&#34;i2cp.leaseSetType&#34;, &#34;3&#34;);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>I2PSession session <span style="color:#f92672">=</span> i2pClient.<span style="color:#a6e22e">createSession</span>(props);
</span></span></code></pre></div><h3 id="i2pd-configuration">i2pd Configuration</h3>
<p><strong>i2pd.conf:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[límites]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Límite de memoria para sesiones ECIES (esquema de cifrado integrado de curva elíptica)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ecies.memory</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">128M</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[ecies]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Habilitar ECIES (esquema de cifrado integrado de curva elíptica)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">enabled</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Solo ECIES (esquema de cifrado integrado basado en curvas elípticas) o de doble clave</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">compatibility</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true  # true = doble clave, false = solo ECIES</span>
</span></span></code></pre></div><p><strong>Tunnels Configuration:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">[my-service] type</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http host = 127.0.0.1 port = 8080 keys = my-service-keys.dat</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Solo ECIES (Esquema Integrado de Cifrado de Curva Elíptica)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ecies</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span></code></pre></div><h3 id="compatibility-matrix">Compatibility Matrix</h3>
<p><strong>Router Version Support:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Version</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">ECIES Support</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">LS2 Support</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Dual-Key</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">&lt; 0.9.38</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">❌ No</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">❌ No</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Legacy only</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0.9.38-0.9.45</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">❌ No</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">LS2 only</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0.9.46-0.9.50</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial ECIES</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1.5.0+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Current</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2.0.0+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Current</td>
    </tr>
  </tbody>
</table>
<p><strong>Destination Compatibility:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Destination Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Can Connect To</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ECIES-only</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ECIES-only, Dual-key</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Requires 0.9.46+ routers</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Dual-key</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Any</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Maximum compatibility</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ElGamal-only</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ElGamal-only, Dual-key</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Legacy</td>
    </tr>
  </tbody>
</table>
<p><strong>FloodFill Requirements:</strong></p>
<ul>
<li><strong>ECIES-only destinations</strong>: Require majority of floodfills on 0.9.46+ for encrypted lookups</li>
<li><strong>Dual-key destinations</strong>: Work with any floodfill version</li>
<li><strong>Current status</strong>: Near 100% floodfill adoption as of 2025</li>
</ul>
<h3 id="migration-guide">Migration Guide</h3>
<p><strong>Migrating from ElGamal to ECIES:</strong></p>
<p><strong>Step 1: Enable Dual-Key Mode</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Añadir ECIES manteniendo ElGamal</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4,0</span>
</span></span></code></pre></div><p><strong>Step 2: Monitor Connections</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Comprobar tipos de conexión</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>i2prouter.exe status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># o</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http://127.0.0.1:7657/peers
</span></span></code></pre></div><p><strong>Step 3: Switch to ECIES-Only (after testing)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Eliminar ElGamal</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4</span>
</span></span></code></pre></div><p><strong>Step 4: Restart Application</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Reiniciar el router I2P o la aplicación</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl restart i2p
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># o</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>i2prouter.exe restart
</span></span></code></pre></div><p><strong>Rollback Plan:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Volver a usar únicamente ElGamal si hay problemas</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
</span></span></code></pre></div><h3 id="performance-tuning">Performance Tuning</h3>
<p><strong>Session Limits:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Máximo de sesiones entrantes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.maxInboundSessions</span><span style="color:#f92672">=</span><span style="color:#e6db74">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Número máximo de sesiones salientes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.maxOutboundSessions</span><span style="color:#f92672">=</span><span style="color:#e6db74">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tiempo de espera de la sesión (segundos)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.sessionTimeout</span><span style="color:#f92672">=</span><span style="color:#e6db74">600</span>
</span></span></code></pre></div><p><strong>Memory Limits:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Límite de almacenamiento de etiquetas (KB)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.maxTagMemory</span><span style="color:#f92672">=</span><span style="color:#e6db74">10240  # 10 MB</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Ventana de anticipación</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.tagLookAhead</span><span style="color:#f92672">=</span><span style="color:#e6db74">160 i2p.ecies.tagLookAheadMin=32</span>
</span></span></code></pre></div><p><strong>Ratchet Policy:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Mensajes antes del ratchet (mecanismo de avance criptográfico)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.ratchetThreshold</span><span style="color:#f92672">=</span><span style="color:#e6db74">4096</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tiempo antes del ratchet (mecanismo de avance criptográfico) (segundos)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.ratchetTimeout</span><span style="color:#f92672">=</span><span style="color:#e6db74">600  # 10 minutos</span>
</span></span></code></pre></div><h3 id="monitoring-and-debugging">Monitoring and Debugging</h3>
<p><strong>Logging:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Habilitar el registro de depuración de ECIES (esquema integrado de cifrado basado en curvas elípticas)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">logger.i2p.router.transport.ecies</span><span style="color:#f92672">=</span><span style="color:#e6db74">DEBUG</span>
</span></span></code></pre></div><p><strong>Metrics:</strong></p>
<p>Monitor these metrics:</p>
<ol>
<li><strong>NS Success Rate</strong>: Percentage of NS messages receiving NSR</li>
<li><strong>Session Establishment Time</strong>: Time from NS to first ES</li>
<li><strong>Tag Storage Usage</strong>: Current memory usage for tags</li>
<li><strong>Ratchet Frequency</strong>: How often sessions ratchet</li>
<li><strong>Session Lifetime</strong>: Average session duration</li>
</ol>
<p><strong>Common Issues:</strong></p>
<ol>
<li>
<p><strong>NS Timeout</strong>: No NSR received</p>
<ul>
<li>Check destination is online</li>
<li>Check floodfill availability</li>
<li>Verify LeaseSet published correctly</li>
</ul>
</li>
<li>
<p><strong>High Memory Usage</strong>: Too many tags stored</p>
<ul>
<li>Reduce look-ahead window</li>
<li>Decrease session timeout</li>
<li>Implement aggressive expiration</li>
</ul>
</li>
<li>
<p><strong>Frequent Ratchets</strong>: Sessions ratcheting too often</p>
<ul>
<li>Increase ratchet threshold</li>
<li>Check for retransmissions</li>
</ul>
</li>
<li>
<p><strong>Session Failures</strong>: ES messages failing to decrypt</p>
<ul>
<li>Verify tag synchronization</li>
<li>Check for replay attacks</li>
<li>Validate nonce construction</li>
</ul>
</li>
</ol>
<hr>
<h2 id="references">References</h2>
<h3 id="specifications">Specifications</h3>
<ol>
<li><strong>ECIES Proposal</strong>: <a href="../../../../es/proposals/144-ecies-x25519-aead-ratchet/">Proposal 144</a>
</li>
<li><strong>I2NP</strong>: <a href="../../../../es/docs/specs/i2np/">I2NP Specification</a>
</li>
<li><strong>Common Structures</strong>: <a href="../../../../es/docs/specs/common-structures/">Common Structures Specification</a>
</li>
<li><strong>NTCP2</strong>: <a href="../../../../es/docs/specs/ntcp2/">NTCP2 Specification</a>
</li>
<li><strong>SSU2</strong>: <a href="../../../../es/docs/specs/ssu2/">SSU2 Specification</a>
</li>
<li><strong>I2CP</strong>: <a href="../../../../es/docs/specs/i2cp/">I2CP Specification</a>
</li>
<li><strong>ElGamal/AES+SessionTags</strong>: <a href="../../../../es/docs/legacy/elgamal-aes/">ElGamal/AES Specification</a>
</li>
</ol>
<h3 id="cryptographic-standards">Cryptographic Standards</h3>
<ol>
<li><strong>Noise Protocol Framework</strong>: <a href="https://noiseprotocol.org/noise.html">Noise Specification</a>
 (Revision 34, 2018-07-11)</li>
<li><strong>Signal Double Ratchet</strong>: <a href="https://signal.org/docs/specifications/doubleratchet/">Signal Specification</a>
</li>
<li><strong>RFC 7748</strong>: <a href="https://tools.ietf.org/html/rfc7748">Elliptic Curves for Security (X25519)</a>
</li>
<li><strong>RFC 7539</strong>: <a href="https://tools.ietf.org/html/rfc7539">ChaCha20 and Poly1305 for IETF Protocols</a>
</li>
<li><strong>RFC 5869</strong>: <a href="https://tools.ietf.org/html/rfc5869">HKDF (HMAC-based Key Derivation Function)</a>
</li>
<li><strong>RFC 2104</strong>: <a href="https://tools.ietf.org/html/rfc2104">HMAC: Keyed-Hashing for Message Authentication</a>
</li>
<li><strong>Elligator2</strong>: <a href="https://elligator.cr.yp.to/elligator-20130828.pdf">Elligator Paper</a>
</li>
</ol>
<h3 id="implementation-resources">Implementation Resources</h3>
<ol>
<li><strong>Java I2P</strong>: <a href="https://github.com/i2p/i2p.i2p">i2p.i2p Repository</a>
</li>
<li><strong>i2pd (C++)</strong>: <a href="https://github.com/PurpleI2P/i2pd">i2pd Repository</a>
</li>
<li><strong>OBFS4 (Elligator2)</strong>: <a href="https://gitlab.com/yawning/obfs4">obfs4proxy Repository</a>
</li>
</ol>
<h3 id="additional-information">Additional Information</h3>
<ol>
<li><strong>I2P Website</strong>: <a href="../../../../es/">/</a>
</li>
<li><strong>I2P Forum</strong>: <a href="https://i2pforum.net">https://i2pforum.net</a>
</li>
<li><strong>I2P Wiki</strong>: <a href="https://wiki.i2p-projekt.de">https://wiki.i2p-projekt.de</a>
</li>
</ol>
<hr>
<h2 id="appendix-a-kdf-summary">Appendix A: KDF Summary</h2>
<p><strong>All KDF Operations in ECIES:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Operation</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Input</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Info String</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Output</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NS Initial ChainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">protocol_name</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">(none - SHA256)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">h, chainKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NS Static Key Section</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, es_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, k</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NS Payload Section (bound)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, ss_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, k</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR Tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"SessionReplyTags"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">tagsetKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR ee DH</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, ee_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR se DH</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, se_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, k</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR Split</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">k_ab, k_ba</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR Payload</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">k_ba</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"AttachPayloadKDF"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">k_nsr</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DH Initialize</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">rootKey, k</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"KDFDHRatchetStep"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">nextRootKey, chainKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Tag and Key Chain Keys</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"TagAndKeyGenKeys"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">sessTag_ck, symmKey_ck</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session Tag Init</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">sessTag_ck</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"STInitialization"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, CONSTANT</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session Tag Gen</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, CONSTANT</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"SessionTagKeyGen"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, tag</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Symmetric Key Gen</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"SymmetricRatchet"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DH Ratchet</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">sharedSecret</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"XDHRatchetTagSet"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">tagsetKey</td>
    </tr>
  </tbody>
</table>
<hr>
<h2 id="appendix-b-message-size-calculator">Appendix B: Message Size Calculator</h2>
<p><strong>Calculate message sizes for capacity planning:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_ns_size</span>(payload_size, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Calculate New Session message size&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    ephemeral_key <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    static_section <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># encrypted + MAC</span>
</span></span><span style="display:flex;"><span>    payload_encrypted <span style="color:#f92672">=</span> payload_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># + MAC</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ephemeral_key <span style="color:#f92672">+</span> static_section <span style="color:#f92672">+</span> payload_encrypted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_nsr_size</span>(payload_size):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Calculate New Session Reply message size&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    tag <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    ephemeral_key <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    key_section_mac <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>    payload_encrypted <span style="color:#f92672">=</span> payload_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># + MAC</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tag <span style="color:#f92672">+</span> ephemeral_key <span style="color:#f92672">+</span> key_section_mac <span style="color:#f92672">+</span> payload_encrypted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_es_size</span>(payload_size):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Calculate Existing Session message size&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    tag <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    payload_encrypted <span style="color:#f92672">=</span> payload_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># + MAC</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tag <span style="color:#f92672">+</span> payload_encrypted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Ejemplos</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;NS (vinculado, carga útil de 1KB):&#34;</span>, calculate_ns_size(<span style="color:#ae81ff">1024</span>, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>), <span style="color:#e6db74">&#34;bytes&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Salida: 1120 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;NSR (carga útil de 1KB):&#34;</span>, calculate_nsr_size(<span style="color:#ae81ff">1024</span>), <span style="color:#e6db74">&#34;bytes&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Salida: 1096 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;ES (carga útil de 1KB):&#34;</span>, calculate_es_size(<span style="color:#ae81ff">1024</span>), <span style="color:#e6db74">&#34;bytes&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Salida: 1048 bytes</span>
</span></span></code></pre></div><hr>
<h2 id="appendix-c-glossary">Appendix C: Glossary</h2>
<p><strong>AEAD</strong>: Authenticated Encryption with Associated Data - encryption mode that provides both confidentiality and authenticity</p>
<p><strong>Authentication Level</strong>: Noise protocol security property indicating strength of sender identity verification</p>
<p><strong>Binding</strong>: Association of a session with a specific far-end destination</p>
<p><strong>ChaCha20</strong>: Stream cipher designed by Daniel J. Bernstein</p>
<p><strong>ChainKey</strong>: Cryptographic key used in HKDF chains to derive subsequent keys</p>
<p><strong>Confidentiality Level</strong>: Noise protocol security property indicating strength of forward secrecy</p>
<p><strong>DH</strong>: Diffie-Hellman key agreement protocol</p>
<p><strong>Elligator2</strong>: Encoding technique to make elliptic curve points indistinguishable from random</p>
<p><strong>Ephemeral Key</strong>: Short-lived key used only for a single handshake</p>
<p><strong>ES</strong>: Existing Session message (used after handshake completion)</p>
<p><strong>Forward Secrecy</strong>: Property ensuring past communications remain secure if keys are compromised</p>
<p><strong>Garlic Clove</strong>: I2NP message container for end-to-end delivery</p>
<p><strong>HKDF</strong>: HMAC-based Key Derivation Function</p>
<p><strong>IK Pattern</strong>: Noise handshake pattern where initiator sends static key immediately</p>
<p><strong>KCI</strong>: Key Compromise Impersonation attack</p>
<p><strong>KDF</strong>: Key Derivation Function - cryptographic function for generating keys from other keys</p>
<p><strong>LeaseSet</strong>: I2P structure containing a destination&rsquo;s public keys and tunnel information</p>
<p><strong>LS2</strong>: LeaseSet version 2 with encryption type support</p>
<p><strong>MAC</strong>: Message Authentication Code - cryptographic checksum proving authenticity</p>
<p><strong>MixHash</strong>: Noise protocol function for maintaining running hash transcript</p>
<p><strong>NS</strong>: New Session message (initiates new session)</p>
<p><strong>NSR</strong>: New Session Reply message (response to NS)</p>
<p><strong>Nonce</strong>: Number used once - ensures unique encryption even with same key</p>
<p><strong>Pairing</strong>: Linking an inbound session with an outbound session for bidirectional communication</p>
<p><strong>Poly1305</strong>: Message authentication code designed by Daniel J. Bernstein</p>
<p><strong>Ratchet</strong>: Cryptographic mechanism for deriving sequential keys</p>
<p><strong>Session Tag</strong>: 8-byte one-time identifier for existing session messages</p>
<p><strong>Static Key</strong>: Long-term key associated with a destination&rsquo;s identity</p>
<p><strong>Tag Set</strong>: Collection of session tags derived from a common root</p>
<p><strong>X25519</strong>: Elliptic curve Diffie-Hellman key agreement using Curve25519</p>
<hr>

                </article>

                
                <nav class="page-nav">
                    
                        <a href="../../../../es/docs/specs/ssu2/" class="page-nav-link prev">
                            <span class="nav-label">← Previous</span>
                            <span class="nav-title">Especificación de SSU2</span>
                        </a>
                    
                    
                        <a href="../../../../es/docs/specs/blockfile/" class="page-nav-link next">
                            <span class="nav-label">Next →</span>
                            <span class="nav-title">Especificación de Blockfile (formato de archivo por bloques)</span>
                        </a>
                    
                </nav>

                
                <div class="docs-feedback">
                    <p>Was this page helpful?</p>
                    <div class="feedback-buttons" id="feedback-buttons">
                        <button class="feedback-btn" id="feedback-yes">👍 Yes</button>
                        <button class="feedback-btn" id="feedback-no">👎 No</button>
                    </div>

                    
                    <div class="feedback-form-container" id="feedback-form-container" style="display: none;">
                        <p class="feedback-form-title">We're sorry to hear that. How can we improve this page?</p>
                        <form id="feedback-form">
                            <div class="form-group">
                                <label for="feedback-email">Email (optional - if you'd like a response)</label>
                                <input type="email" id="feedback-email" name="email" placeholder="your@email.com">
                            </div>
                            <div class="form-group">
                                <label for="feedback-message">Feedback *</label>
                                <textarea id="feedback-message" name="message" rows="4" required placeholder="Tell us what we can improve..."></textarea>
                            </div>
                            <button type="submit" class="btn-submit-feedback" id="feedback-submit-btn">
                                <span class="btn-text">Submit Feedback</span>
                                <span class="btn-loading" style="display: none;">Sending...</span>
                            </button>
                        </form>
                    </div>

                    
                    <div class="feedback-message" id="feedback-success" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/>
                        </svg>
                        <span id="feedback-success-text">Thanks for your feedback!</span>
                    </div>
                    <div class="feedback-message feedback-error" id="feedback-error" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path d="M12 8v4M12 16h.01" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span id="feedback-error-text">Something went wrong. Please try again.</span>
                    </div>

                    <p class="feedback-note">
                        Found an issue? <a href="https://gitlab.com/stormycloud-group/i-2-p-www-v-2/-/blob/main/hugo-site/content/es/docs/specs/ecies.md?ref_type=heads" target="_blank">Edit this page on GitLab</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.docs-page {
    min-height: 100vh;
    padding: var(--spacing-xl) 0;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
}

.breadcrumbs a:hover {
    color: var(--color-primary);
}

.separator {
    color: var(--color-border);
}

.current {
    color: var(--color-text);
}

 
.translation-disclaimer {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.dark .translation-disclaimer {
    background: #78350f;
    border-color: #d97706;
}

.disclaimer-message {
    color: #92400e;
    font-size: 0.875rem;
}

.dark .disclaimer-message {
    color: #fde047;
}

.disclaimer-link {
    color: #92400e;
    font-weight: 600;
    text-decoration: underline;
    white-space: nowrap;
}

.dark .disclaimer-link {
    color: #fde047;
}

 
.article-header {
    margin-bottom: var(--spacing-2xl);
}

.article-title {
    font-size: 2.5rem;
    margin: 0 0 var(--spacing-md) 0;
    color: var(--color-text);
}

.article-description {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-md);
}

.article-meta {
    display: flex;
    gap: var(--spacing-lg);
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.meta-item svg {
    color: var(--color-primary);
}

 
.docs-layout {
    display: block;
}

.docs-layout--with-toc {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

 
.docs-toc-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.toc-nav {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
}

.toc-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-text);
    padding-bottom: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.toc-content {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
}

.toc-content::-webkit-scrollbar {
    width: 4px;
}

.toc-content::-webkit-scrollbar-track {
    background: transparent;
}

.toc-content::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
}

.toc-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

.toc-nav ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc-nav li {
    margin-bottom: 0.25rem;
}

.toc-nav ul ul {
    padding-left: var(--spacing-md);
    margin-top: 0.25rem;
}

.toc-nav a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.8125rem;
    display: block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    line-height: 1.4;
}

.toc-nav a:hover {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
}

 
.docs-main {
    min-width: 0;
    max-width: 900px;
}

 
.article-content {
    line-height: 1.8;
    color: var(--color-text);
}

.article-content h2 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.75rem;
    scroll-margin-top: 100px;
}

.article-content h3 {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.375rem;
    scroll-margin-top: 100px;
}

.article-content h4 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-xs);
    font-size: 1.125rem;
    scroll-margin-top: 100px;
}

.article-content p {
    margin-bottom: var(--spacing-md);
}

.article-content ul,
.article-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.article-content li {
    margin-bottom: var(--spacing-xs);
}

.article-content code {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
}

.article-content pre {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: var(--spacing-md);
}

.article-content pre code {
    background: none;
    padding: 0;
}

.article-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin: var(--spacing-lg) 0;
    display: block;
}

.article-content a {
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
}

.article-content a:hover {
    border-bottom-color: var(--color-primary);
}

 
.page-nav {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
}

.page-nav-link {
    display: flex;
    flex-direction: column;
    padding: var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.page-nav-link:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
}

.page-nav-link.next {
    text-align: right;
}

.nav-label {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xs);
}

.nav-title {
    font-weight: 600;
    color: var(--color-text);
}

 
.docs-feedback {
    margin-top: var(--spacing-2xl);
    padding: var(--spacing-lg);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    text-align: center;
}

.feedback-buttons {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    margin: var(--spacing-md) 0;
}

.feedback-btn {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.feedback-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-primary);
    color: white;
}

.feedback-note {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-top: var(--spacing-md);
}

.feedback-note a {
    color: var(--color-primary);
    text-decoration: none;
}

.feedback-note a:hover {
    text-decoration: underline;
}

 
.feedback-form-container {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-align: left;
}

.feedback-form-title {
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--color-text);
}

.form-group {
    margin-bottom: var(--spacing-md);
}

.form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
    color: var(--color-text);
}

.form-group input[type="email"],
.form-group textarea {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    color: var(--color-text);
    font-family: inherit;
    font-size: 0.9375rem;
    transition: border-color var(--transition-fast);
}

.form-group input[type="email"]:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.btn-submit-feedback {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-submit-feedback:hover:not(:disabled) {
    background: var(--color-primary-dark);
    transform: translateY(-1px);
}

.btn-submit-feedback:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

 
.feedback-message {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: #d1fae5;
    color: #065f46;
    border-radius: var(--radius-md);
    margin-top: var(--spacing-md);
}

.feedback-message.feedback-error {
    background: #fee2e2;
    color: #991b1b;
}

.feedback-message svg {
    flex-shrink: 0;
}

 
@media (max-width: 1024px) {
    .docs-layout--with-toc {
        grid-template-columns: 1fr;
    }

    .docs-toc-sidebar {
        position: static;
        max-height: none;
        margin-bottom: var(--spacing-xl);
    }

    .toc-content {
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .article-title {
        font-size: 1.75rem;
    }
}
</style>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = [];

    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const heading = document.getElementById(href.slice(1));
            if (heading) {
                headings.push({ element: heading, link: link });
            }
        }
    });

    function updateActiveLink() {
        const scrollPos = window.scrollY + 120;
        let activeIndex = 0;

        for (let i = 0; i < headings.length; i++) {
            if (headings[i].element.offsetTop <= scrollPos) {
                activeIndex = i;
            }
        }

        tocLinks.forEach(link => link.classList.remove('active'));
        if (headings[activeIndex]) {
            headings[activeIndex].link.classList.add('active');
        }
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});
</script>
<style>
.toc-nav a.active {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
    font-weight: 600;
}
</style>



<script>
(function() {
    'use strict';
    
    
    let baseUrl = window.feedbackBaseUrl;
    if (!baseUrl) {
        const hostname = window.location.hostname;
        
        if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
            baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
        } else if (hostname.endsWith('.onion')) {
            baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
        } else {
            baseUrl = 'https://feedback.i2p.net';
        }
    }
    
    const script = document.createElement('script');
    script.src = baseUrl + '/widgets/docs-feedback.js';
    script.async = true;
    script.onerror = function() {
        console.error('[Docs Feedback] Failed to load docs-feedback.js from:', baseUrl);
    };
    document.body.appendChild(script);
})();
</script>


    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">Mantente informado con las noticias de I2P:</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="Introduce tu correo electrónico" required>
                            <button type="submit">Suscribirse</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>Enlaces Rápidos</h3>
                <ul>
                    <li><a href="../../../../es/financial-support/">Donar</a></li>
                    <li><a href="../../../../es/docs/overview/intro/">Introducción a I2P</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Comunidad</h3>
                <ul>
                    <li><a href="../../../../es/get-involved/">Participa</a></li>
                    <li><a href="../../../../es/blog/">Blog</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">Foros Oficiales</a></li>
                    <li><a href="../../../../es/contact/">Contacto</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Recursos</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">Métricas de I2P</a></li>
                    <li><a href="../../../../es/papers/">Investigación</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">StormyCloud</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 El Proyecto de Internet Invisible. Licenciado bajo Creative Commons.</p>
            <div class="footer-links">
                <a href="../../../../es/privacy/">Privacidad</a>
                <a href="../../../../es/terms/">Términos</a>
                <a href="../../../../es/about/media/">Prensa</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="Cerrar">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>Encuesta de la comunidad</h2>
            <p class="modal-subtitle">Nos encantaría saber de ti</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                Tu voto ayuda a dar forma al futuro de I2P.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>NTCP 2 | I2P - The Invisible Internet Project</title>

    <meta name="description" content="The Invisible Internet Project - A privacy-focused, anonymous network layer">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="NTCP 2 | I2P - The Invisible Internet Project">
    <meta property="og:description" content="The Invisible Internet Project - A privacy-focused, anonymous network layer">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/en/proposals/111-ntcp-2/">

    
    <link rel="icon" type="image/svg+xml" href="../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">I2P Beta Site Now Live E-Mail issues to stormycloud@mail.i2p</span>
            
        </div>
        
        <form method="GET" action="../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="Close banner" title="Close banner">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../en/" class="logo-link">
                    <img src="../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../en/about/" class="">About</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../en/about/">Overview</a></li>
                            <li><a href="../../../en/papers/">Research Papers</a></li>
                            <li><a href="../../../en/about/media/">Press</a></li>
                            <li><a href="../../../en/contact/">Contact Us</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../en/docs/" class="">Docs</a></li>
                    <li><a href="../../../en/downloads/" class="">Downloads</a></li>
                    <li><a href="../../../en/blog/" class="">Blog</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../en/get-involved/" class="">Get Involved</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../en/get-involved/">Overview</a></li>
                            <li><a href="../../../en/feedback/">Feature Suggestions</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">en</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../en/proposals/111-ntcp-2/"
                                class="lang-option active">English</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../es/proposals/111-ntcp-2/"
                                class="lang-option">Spanish</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ko/proposals/111-ntcp-2/"
                                class="lang-option">Korean</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../zh/proposals/111-ntcp-2/"
                                class="lang-option">Chinese</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ru/proposals/111-ntcp-2/"
                                class="lang-option">Russian</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../cs/proposals/111-ntcp-2/"
                                class="lang-option">Czech</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../de/proposals/111-ntcp-2/"
                                class="lang-option">German</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../fr/proposals/111-ntcp-2/"
                                class="lang-option">French</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../tr/proposals/111-ntcp-2/"
                                class="lang-option">Turkish</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../vi/proposals/111-ntcp-2/"
                                class="lang-option">Vietnamese</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../hi/proposals/111-ntcp-2/"
                                class="lang-option">Hindi</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ar/proposals/111-ntcp-2/"
                                class="lang-option">Arabic</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../pt/proposals/111-ntcp-2/"
                                class="lang-option">Portuguese</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../en/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../en/downloads/" class="btn btn-primary">Get I2P</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        



<div class="proposals-page">
    <div class="container">
        
        <nav class="breadcrumbs">
            <a href="../../../en/">Home</a>
            <span class="separator">/</span>
            <a href="../../../en/proposals/">Proposals</a>
            <span class="separator">/</span>
            <span class="current">NTCP 2</span>
        </nav>

        


        
        <header class="proposal-header">
            <div class="proposal-title-section">
                <h1 class="proposal-title">NTCP 2</h1>
                <div class="proposal-number">Proposal 111</div>
            </div>

            
            <div class="proposal-meta-box">
                <div class="proposal-status status-closed">
                    Closed
                </div>

                
                <div class="proposal-info-grid">
                    
                    <div class="info-item">
                        <span class="info-label">Author</span>
                        <span class="info-value">EinMByte, orignal, psi, str4d, zzz</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Created</span>
                        <span class="info-value">2014-02-13</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Last Updated</span>
                        <span class="info-value">2019-08-13</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Target Version</span>
                        <span class="info-value">0.9.36</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Implemented In</span>
                        <span class="info-value">0.9.36</span>
                    </div>
                    
                </div>

                
                
                <div class="proposal-relationships">
                    
                    <div class="relationship">
                        <span class="relationship-label">Supercedes:</span>
                        <span class="relationship-value">106</span>
                    </div>
                    
                    
                </div>
                
            </div>
        </header>

        
        <div class="proposal-layout proposal-layout--with-toc">
            
            
            <aside class="proposal-toc-sidebar">
                <nav class="toc-nav">
                    <div class="toc-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        On This Page
                    </div>
                    <div class="toc-content">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#note">Note</a></li>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#motivation">Motivation</a></li>
    <li><a href="#design-goals">Design Goals</a>
      <ul>
        <li><a href="#non-goals">Non-Goals</a></li>
        <li><a href="#related-goals">Related Goals</a></li>
      </ul>
    </li>
    <li><a href="#security-goals">Security Goals</a>
      <ul>
        <li><a href="#additional-dpi-discussion">Additional DPI Discussion</a></li>
      </ul>
    </li>
    <li><a href="#noise-protocol-framework">Noise Protocol Framework</a></li>
    <li><a href="#additions-to-the-framework">Additions to the Framework</a></li>
    <li><a href="#new-cryptographic-primitives-for-i2p">New Cryptographic Primitives for I2P</a></li>
    <li><a href="#processing-overhead-estimate">Processing overhead estimate</a></li>
    <li><a href="#messages">Messages</a>
      <ul>
        <li><a href="#authenticated-encryption">Authenticated Encryption</a></li>
        <li><a href="#chacha20poly1305">ChaCha20/Poly1305</a></li>
        <li><a href="#aead-error-handling">AEAD Error Handling</a></li>
        <li><a href="#key-derivation-function-kdf-for-handshake-message-1">Key Derivation Function (KDF) (for handshake message 1)</a></li>
        <li><a href="#1-sessionrequest">1) SessionRequest</a></li>
        <li><a href="#key-derivation-function-kdf-for-handshake-message-2-and-message-3-part-1">Key Derivation Function (KDF) (for handshake message 2 and message 3 part 1)</a></li>
        <li><a href="#2-sessioncreated">2) SessionCreated</a></li>
        <li><a href="#encryption-for-for-handshake-message-3-part-1-using-message-2-kdf">Encryption for for handshake message 3 part 1, using message 2 KDF)</a></li>
        <li><a href="#key-derivation-function-kdf-for-handshake-message-3-part-2">Key Derivation Function (KDF) (for handshake message 3 part 2)</a></li>
        <li><a href="#3-sessionconfirmed">3) SessionConfirmed</a></li>
        <li><a href="#key-derivation-function-kdf-for-data-phase">Key Derivation Function (KDF) (for data phase)</a></li>
        <li><a href="#4-data-phase">4) Data Phase</a></li>
        <li><a href="#siphash-obfuscated-length">SipHash obfuscated length</a></li>
        <li><a href="#raw-contents">Raw contents</a></li>
        <li><a href="#unencrypted-data">Unencrypted data</a></li>
        <li><a href="#block-ordering-rules">Block Ordering Rules</a></li>
        <li><a href="#datetime">DateTime</a></li>
        <li><a href="#options">Options</a></li>
        <li><a href="#options-issues">Options Issues</a></li>
        <li><a href="#routerinfo">RouterInfo</a></li>
        <li><a href="#i2np-message">I2NP Message</a></li>
        <li><a href="#termination">Termination</a></li>
        <li><a href="#padding">Padding</a></li>
        <li><a href="#other-block-types">Other block types</a></li>
        <li><a href="#5-termination">5) Termination</a></li>
      </ul>
    </li>
    <li><a href="#published-router-info">Published Router Info</a>
      <ul>
        <li><a href="#published-addresses">Published Addresses</a></li>
        <li><a href="#unpublished-ntcp2-address">Unpublished NTCP2 Address</a></li>
        <li><a href="#public-key-and-iv-rotation">Public Key and IV Rotation</a></li>
        <li><a href="#identity-hiding">Identity Hiding</a></li>
      </ul>
    </li>
    <li><a href="#version-detection">Version Detection</a></li>
    <li><a href="#variants-fallbacks-and-general-issues">Variants, Fallbacks, and General Issues</a></li>
    <li><a href="#appendix-a-padding-scheme">Appendix A: Padding Scheme</a></li>
    <li><a href="#appendix-b-random-delays">Appendix B: Random Delays</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
                    </div>
                </nav>
            </aside>
            

            
            <div class="proposal-main">
                <article class="proposal-content">
                    <h2 id="note">Note</h2>
<p>Proposal phase is closed.
See <a href="../../../en/docs/specs/ntcp2/">SPEC</a>
 for the official specification.
This proposal may still be referenced for background information.</p>
<h2 id="overview">Overview</h2>
<p>This proposal describes an authenticated key agreement protocol to improve the
resistance of <a href="../../../en/docs/ntcp/">NTCP</a>
 to various forms of automated identification and attacks.</p>
<p>The proposal is organized as follows: the security goals are presented,
followed by a discussion of the basic protocol. Next, a complete specification
of all protocol messages is given. Finally, router addresses and version
identification are discussed. An appendix discussing a generic attack on common
padding schemes is also included, as well as an appendix containing a number of
candidates for the authenticated cipher.</p>
<p>As with other I2P transports, NTCP2 is defined solely
for point-to-point (router-to-router) transport of I2NP messages.
It is not a general-purpose data pipe.</p>
<h2 id="motivation">Motivation</h2>
<p><a href="../../../en/docs/ntcp/">NTCP</a>
 data is encrypted after the first message (and the first message
appears to be random data), thus preventing protocol identification through
&ldquo;payload analysis&rdquo;. It is still vulnerable to protocol identification through
&ldquo;flow analysis&rdquo;. That&rsquo;s because the first 4 messages (i.e. the handshake) are
fixed length (288, 304, 448, and 48 bytes).</p>
<p>By adding random amounts of random data to each of the messages, we can make it
a lot harder.</p>
<p>The authors acknowledge that standard security practices would suggest to use
an existing protocol such as TLS, but this is <a href="../../../en/proposals/104-tls-transport/">Prop104</a>
 and it has problems of
its own. Wherever appropriate, &ldquo;future work&rdquo; paragraphs have been added to
indicate missing features or subjects of discussion.</p>
<h2 id="design-goals">Design Goals</h2>
<ul>
<li>
<p>Support NTCP 1 and 2 on a single port, auto-detect, and published as a single
&ldquo;transport&rdquo; (i.e. RouterAddress) in the <a href="../../../en/docs/overview/network-database/">NetDB</a>
.</p>
</li>
<li>
<p>Publish support for version 1 only, 2 only, or 1+2 in the NetDB in a separate
field, and default to version 1 only (don&rsquo;t bind version support to a
particular router version)</p>
</li>
<li>
<p>Ensure that all implementations (Java/i2pd/Kovri/go) can add version 2
support (or not) on their own schedules</p>
</li>
<li>
<p>Add random padding to all NTCP messages including handshake and data messages
(i.e. length obfuscation so all messages aren&rsquo;t a multiple of 16 bytes)
Provide options mechanism for both sides to request min and max padding
and/or padding distribution. Specifics of the padding distribution are
implementation-dependent and may or may not be specified in the protocol
itself.</p>
</li>
<li>
<p>Obfuscate the contents of messages that aren&rsquo;t encrypted (1 and 2),
sufficiently so that DPI boxes and AV signatures can&rsquo;t easily classify them.
Also ensure that the messages going to a single peer or set of peers do not
have a similar pattern of bits.</p>
</li>
<li>
<p>Fix loss of bits in DH due to Java format <a href="https://trac.i2p2.i2p/ticket/1112">Ticket1112</a>
, possibly (probably?)
by switching to X25519.</p>
</li>
<li>
<p>Switch to a real key derivation function (KDF) rather than using the DH
result as-is?</p>
</li>
<li>
<p>Add &ldquo;probing resistance&rdquo; (as Tor calls it); this includes replay resistance.</p>
</li>
<li>
<p>Maintain 2-way authenticated key exchange (2W-AKE). 1W-AKE is not sufficient
for our application.</p>
</li>
<li>
<p>Continue to use the variable-type, variable-length signatures (from the
published RouterIdentity signing key) as a part of authentication.  Rely
on a static public key published in the RouterInfo as another part of
authentication.</p>
</li>
<li>
<p>Add options/version in handshake for future extensibility.</p>
</li>
<li>
<p>Add resistance to malicious MitM TCP segmentation if possible.</p>
</li>
<li>
<p>Don&rsquo;t add significantly to CPU required for connection setup; if possible,
reduce it significantly.</p>
</li>
<li>
<p>Add message authentication (MAC), possibly HMAC-SHA256 and Poly1305, and
remove Adler checksum.</p>
</li>
<li>
<p>Shorten and simplify I2NP header:
Shorten expiration to 4 bytes, as in SSU.
Remove one-byte truncated SHA256 checksum.</p>
</li>
<li>
<p>If possible, reduce the 4-message, two-round-trip handshake to a 3-message,
one-round-trip handshake, as in <a href="../../../en/docs/specs/ssu2/">SSU</a>
. This would require moving Bob&rsquo;s
signature in message 4 to message 2. Research the reason for 4 messages in
the ten-year-old email/status/meeting archives.</p>
</li>
<li>
<p>Minimize protocol overhead before padding. While padding will be added,
and possibly lots of it, overhead before padding is still overhead.
Low-bandwidth nodes must be able to use NTCP2.</p>
</li>
<li>
<p>Maintain timestamps for replay and skew detection.</p>
</li>
<li>
<p>Avoid any year 2038 issues in timestamps, must work until at least 2106.</p>
</li>
<li>
<p>Increase max message size from 16K to 32K or 64K.</p>
</li>
<li>
<p>Any new cryptographic primitives should be readily available in libraries for use in Java
(1.7), C++, and Go router implementations.</p>
</li>
<li>
<p>Include representatives of Java, C++, and Go router developers in the design.</p>
</li>
<li>
<p>Minimize changes (but there will still be a lot).</p>
</li>
<li>
<p>Support both versions in a common set of code (this may not be possible and
is implementation-dependent in any case).</p>
</li>
</ul>
<h3 id="non-goals">Non-Goals</h3>
<ul>
<li>
<p>Bullet-proof DPI resistance&hellip; that would be pluggable transports,
<a href="../../../en/proposals/109-pt-transport/">Prop109</a>
.</p>
</li>
<li>
<p>A TLS-based (or HTTPS-lookalike) transport&hellip; that would be <a href="../../../en/proposals/104-tls-transport/">Prop104</a>
.</p>
</li>
<li>
<p>It&rsquo;s OK to change the symmetric stream cryptography.</p>
</li>
<li>
<p>Timing-based DPI resistance (inter-message timing/delays can be
implementation-dependent; intra-message delays can be introduced at any
point, including before sending the random padding, for example). Artificial
delays (what obfs4 calls IAT or inter-arrival time) are independent of the
protocol itself.</p>
</li>
<li>
<p>Deniability of participating in a session (there&rsquo;s signatures in there).</p>
</li>
</ul>
<p>Non-goals that may be partially reconsidered or discussed:</p>
<ul>
<li>
<p>The degree of protection against Deep Packet Inspection (DPI)</p>
</li>
<li>
<p>Post-Quantum (PQ) security</p>
</li>
<li>
<p>Deniability</p>
</li>
</ul>
<h3 id="related-goals">Related Goals</h3>
<ul>
<li>Implement a NTCP 1/2 test setup</li>
</ul>
<h2 id="security-goals">Security Goals</h2>
<p>We consider three parties:</p>
<ul>
<li>Alice, who wishes to establish a new session.</li>
<li>Bob, with whom Alice wishes to establish a session.</li>
<li>Mallory, the &ldquo;man in the middle&rdquo; between Alice and Bob.</li>
</ul>
<p>At most two participants can engage in active attacks.</p>
<p>Alice and Bob are both in possession of a static key pair, which is contained
in their RouterIdentity.</p>
<p>The proposed protocol attempts to allow Alice and Bob to agree on a shared
secret key (K) under the following requirements:</p>
<ol>
<li>
<p>Private key security: neither Bob nor Mallory learns anything about Alice&rsquo;s
static private key. Symmetrically, Alice does not learn anything about Bob&rsquo;s
static private key.</p>
</li>
<li>
<p>The session key K is only known by Alice and Bob.</p>
</li>
<li>
<p>Perfect forward secrecy: the agreed upon session key remains secret in the
future, even when the static private keys of Alice and/or Bob are revealed
after the key has been agreed upon.</p>
</li>
<li>
<p>Two-way authentication: Alice is certain that she has established a session
with Bob, and vice versa.</p>
</li>
<li>
<p>Protection against online DPI: Ensure that it is not trivial to detect that
Alice and Bob are engaged in the protocol using only straightforward deep
packet inspection (DPI) techniques. See below.</p>
</li>
<li>
<p>Limited deniability: neither Alice nor Bob can deny participation in the
protocol, but if either leaks the shared key the other party can deny the
authenticity of the contents of the transmitted data.</p>
</li>
</ol>
<p>The present proposal attempts to provide all five requirements based on the
Station-To-Station (STS) protocol. Note that this protocol is also the
basis for the <a href="../../../en/docs/specs/ssu2/">SSU</a>
 protocol.</p>
<h3 id="additional-dpi-discussion">Additional DPI Discussion</h3>
<p>We assume two DPI components:</p>
<h4 id="1-online-dpi">1) Online DPI</h4>
<p>Online DPI inspecting all flows in real-time. Connections may be blocked or
otherwise tampered with. Connection data or metadata may be identified and
stored for offline analysis.  The online DPI does not have access to the I2P
network database.  The online DPI has only limited real-time computational
capability, including length calculation, field inspection, and simple
calculations such as XOR.  The online DPI does have the capability of fast
real-time cryptographic functions such as AES, AEAD, and hashing, but these
would be too expensive to apply to most or all flows. Any application of these
cryptographic operations would apply only to flows on IP/Port combinations
previously identified by offline analysis.  The online DPI does not have the
capability of high-overhead cryptographic functions such as DH or elligator2.
The online DPI is not designed specifically to detect I2P, although it may have
limited classification rules for that purpose.</p>
<p>It is a goal to prevent protocol identification by an online DPI.</p>
<p>The notion of online or &ldquo;straightforward&rdquo; DPI is here taken to include the
following adversary capabilities:</p>
<ol>
<li>
<p>The ability to inspect all data sent or received by the target.</p>
</li>
<li>
<p>The ability to perform operations on the observed data, such as
applying block ciphers or hash functions.</p>
</li>
<li>
<p>The ability to store and compare with previously sent messages.</p>
</li>
<li>
<p>The ability to modify, delay or fragment packets.</p>
</li>
</ol>
<p>However, the online DPI is assumed to have the following restrictions:</p>
<ol start="5">
<li>
<p>The inability to map IP addresses to router hashes. While this is trivial
with real-time access to the network database,
it would require a DPI system specifically designed to target I2P.</p>
</li>
<li>
<p>The inability to use timing information to detect the protocol.</p>
</li>
<li>
<p>Generally speaking, the online DPI toolbox does not contain any built-in
tools that are specifically designed for I2P detection. This includes
creating &ldquo;honeypots&rdquo;, which would for example include nonrandom padding in
their messages. Note that this does not exclude machine learning systems or
highly configurable DPI tools as long as they meet the other requirements.</p>
</li>
</ol>
<p>To counter payload analysis, it is ensured that all messages are
indistinguishable from random. This also requires their length to be random,
which is more complicated than just adding random padding. In fact, in Appendix
A, the authors argue that a naive (i.e. uniform) padding scheme does not
resolve the problem. Appendix A therefore proposes to include either random
delays or to develop an alternate padding scheme that can provide reasonable
protection for the proposed attack.</p>
<p>To protect against the sixth entry above, implementations should include random
delays in the protocol. Such techniques are not covered by this proposal, but
they could also resolve the padding length issues. In summary, the proposal
provides good protection against payload analysis (when the considerations in
Appendix A are taken into account), but only limited protection against flow
analysis.</p>
<h4 id="2-offline-dpi">2) Offline DPI</h4>
<p>Offline DPI inspecting data stored by the online DPI for later analysis.
The offline DPI may be designed specifically to detect I2P.
The offline DPI does have real-time access to the I2P network database.
The offline DPI does have access to this and other I2P specifications.
The offline DPI has unlimited computational capability, including
all cryptographic functions defined in this specification.</p>
<p>The offline DPI does not have the ability to block existing connections.  The
offline DPI does have the capability to do near-realtime (within minutes of
setup) sending to host/port of parties, for example TCP RST.  The offline DPI
does have the capability to do near-realtime (within minutes of setup) replay
of previous messages (modified or not) for &ldquo;probing&rdquo; or other reasons.</p>
<p>It is not a goal to prevent protocol identification by an offline DPI.
All decoding of obfuscated data in the first two messages, which
is implemented by I2P routers, may also be implemented by the offline DPI.</p>
<p>It is a goal to reject attempted connections using replay of previous messages.</p>
<h4 id="future-work">Future work</h4>
<ul>
<li>
<p>Consider the behavior of the protocol when packets are dropped or reordered
by an attacker. Recent interesting work in this area can be found in
<a href="https://eprint.iacr.org/2015/1150">IACR-1150</a>
.</p>
</li>
<li>
<p>Provide a more accurate classification of DPI systems, taking into account
the existing literature related to the subject.</p>
</li>
<li>
<p>Discuss the formal security of the proposed protocol, ideally taking into
account the DPI attacker model.</p>
</li>
</ul>
<h2 id="noise-protocol-framework">Noise Protocol Framework</h2>
<p>This proposal provides the requirements based on the Noise Protocol Framework
<a href="https://noiseprotocol.org/noise.html">NOISE</a>
 (Revision 33, 2017-10-04).
Noise has similar properties to the Station-To-Station protocol,
which is the basis for the <a href="../../../en/docs/specs/ssu2/">SSU</a>
 protocol.  In Noise parlance, Alice
is the initiator, and Bob is the responder.</p>
<p>NTCP2 is based on the Noise protocol Noise_XK_25519_ChaChaPoly_SHA256.
(The actual identifier for the initial key derivation function
is &ldquo;Noise_XKaesobfse+hs2+hs3_25519_ChaChaPoly_SHA256&rdquo;
to indicate I2P extensions - see KDF 1 section below)
This Noise protocol uses the following primitives:</p>
<ul>
<li>
<p>Handshake Pattern: XK
Alice transmits her key to Bob (X)
Alice knows Bob&rsquo;s static key already (K)</p>
</li>
<li>
<p>DH Function: X25519
X25519 DH with a key length of 32 bytes as specified in <a href="https://tools.ietf.org/html/rfc7748">RFC-7748</a>
.</p>
</li>
<li>
<p>Cipher Function: ChaChaPoly
AEAD_CHACHA20_POLY1305 as specified in <a href="https://tools.ietf.org/html/rfc7539">RFC-7539</a>
 section 2.8.
12 byte nonce, with the first 4 bytes set to zero.</p>
</li>
<li>
<p>Hash Function: SHA256
Standard 32-byte hash, already used extensively in I2P.</p>
</li>
</ul>
<h2 id="additions-to-the-framework">Additions to the Framework</h2>
<p>This proposal defines the following enhancements to
Noise_XK_25519_ChaChaPoly_SHA256.  These generally follow the guidelines in
<a href="https://noiseprotocol.org/noise.html">NOISE</a>
 section 13.</p>
<ol>
<li>
<p>Cleartext ephemeral keys are obfuscated with AES encryption using a known
key and IV.  This is quicker than elligator2.</p>
</li>
<li>
<p>Random cleartext padding is added to messages 1 and 2.
The cleartext padding is included in the handshake hash (MixHash) calculation.
See the KDF sections below for message 2 and message 3 part 1.
Random AEAD padding is added to message 3 and data phase messages.</p>
</li>
<li>
<p>A two-byte frame length field is added, as is required for Noise over TCP,
and as in obfs4. This is used in the data phase messages only.
Message 1 and 2 AEAD frames are fixed length.
Message 3 part 1 AEAD frame is fixed length.
Message 3 part 2 AEAD frame length is specified in message 1.</p>
</li>
<li>
<p>The two-byte frame length field is obfuscated with SipHash-2-4,
as in obfs4.</p>
</li>
<li>
<p>The payload format is defined for messages 1,2,3, and the data phase.
Of course, this is not defined in Noise.</p>
</li>
</ol>
<h2 id="new-cryptographic-primitives-for-i2p">New Cryptographic Primitives for I2P</h2>
<p>Existing I2P router implementations will require implementations for
the following standard cryptographic primitives,
which are not required for current I2P protocols:</p>
<ol>
<li>
<p>X25519 key generation and DH</p>
</li>
<li>
<p>AEAD_ChaCha20_Poly1305 (abbreviated as ChaChaPoly below)</p>
</li>
<li>
<p>SipHash-2-4</p>
</li>
</ol>
<h2 id="processing-overhead-estimate">Processing overhead estimate</h2>
<p>Message sizes for the 3 messages:</p>
<ol>
<li>64 bytes + padding   (NTCP was 288 bytes)</li>
<li>64 bytes + padding   (NTCP was 304 bytes)</li>
<li>approx. 64 bytes + Alice router info + padding   Average router info is about 750
bytes   Total average 814 bytes before padding (NTCP was 448 bytes)</li>
<li>not required in NTCP2   (NTCP was 48 bytes)</li>
</ol>
<p>Total before padding:
NTCP2: 942 bytes
NTCP: 1088 bytes
Note that if Alice connected to Bob for the purpose of sending
a DatabaseStore Message of her RouterInfo, that message is not required,
saving approximately 800 bytes.</p>
<p>The following cryptographic operations are required by each party to complete
the handshake and start the data phase:</p>
<ul>
<li>AES: 2</li>
<li>SHA256: 7 (Alice), 6 (Bob) (not including 1 Alice, 2 Bob precalculated for
all connections) (not including HMAC-SHA256)</li>
<li>HMAC-SHA256: 19</li>
<li>ChaChaPoly: 4</li>
<li>X25519 key generation: 1</li>
<li>X25519 DH: 3</li>
<li>Signature verification: 1 (Bob) (Alice previously signed when generating her
RI)  Presumably Ed25519 (dependent on RI signature type)</li>
</ul>
<p>The following cryptographic operations are required by each party for each data phase message:</p>
<ul>
<li>SipHash: 1</li>
<li>ChaChaPoly: 1</li>
</ul>
<h2 id="messages">Messages</h2>
<p>All NTCP2 messages are less than or equal to 65537 bytes in length. The message
format is based on Noise messages, with modifications for framing and indistinguishability.
Implementations using standard Noise libraries may need to pre-process received
messages to/from the Noise message format. All encrypted fields are AEAD
ciphertexts.</p>
<p>The establishment sequence is as follows:</p>
<pre tabindex="0"><code>Alice                           Bob

  SessionRequest -------------------&gt;
  &lt;------------------- SessionCreated
  SessionConfirmed -----------------&gt;
</code></pre><p>Using Noise terminology, the establishment and data sequence is as follows:
(Payload Security Properties)</p>
<pre tabindex="0"><code>XK(s, rs):           Authentication   Confidentiality
    &lt;- s
    ...
    -&gt; e, es                  0                2
    &lt;- e, ee                  2                1
    -&gt; s, se                  2                5
    &lt;-                        2                5
</code></pre><p>Once a session has been established, Alice and Bob can exchange Data messages.</p>
<p>All message types (SessionRequest, SessionCreated, SessionConfirmed, Data and
TimeSync) are specified in this section.</p>
<p>Some notations:</p>
<ul>
<li>RH_A = Router Hash for Alice (32 bytes)</li>
<li>RH_B = Router Hash for Bob (32 bytes)</li>
</ul>
<h3 id="authenticated-encryption">Authenticated Encryption</h3>
<p>There are three separate authenticated encryption instances (CipherStates).
One during the handshake phase, and two (transmit and receive) for the data phase.
Each has its own key from a KDF.</p>
<p>Encrypted/authenticated data will be represented as</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   Encrypted and authenticated data    |
  ~               .   .   .               ~
  |                                       |
  +----+----+----+----+----+----+----+----+
</code></pre><h3 id="chacha20poly1305">ChaCha20/Poly1305</h3>
<p>Encrypted and authenticated data format.</p>
<p>Inputs to the encryption/decryption functions:</p>
<pre tabindex="0"><code>k :: 32 byte cipher key, as generated from KDF

  nonce :: Counter-based nonce, 12 bytes.
           Starts at 0 and incremented for each message.
           First four bytes are always zero.
           Last eight bytes are the counter, little-endian encoded.
           Maximum value is 2**64 - 2.
           Connection must be dropped and restarted after
           it reaches that value.
           The value 2**64 - 1 must never be sent.

  ad :: In handshake phase:
        Associated data, 32 bytes.
        The SHA256 hash of all preceding data.
        In data phase:
        Zero bytes

  data :: Plaintext data, 0 or more bytes
</code></pre><p>Output of the encryption function, input to the decryption function:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
  |Obfs Len |                             |
  +----+----+                             +
  |       ChaCha20 encrypted data         |
  ~               .   .   .               ~
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Poly1305 Message Authentication Code |
  +              (MAC)                    +
  |             16 bytes                  |
  +----+----+----+----+----+----+----+----+

  Obfs Len :: Length of (encrypted data + MAC) to follow, 16 - 65535
              Obfuscation using SipHash (see below)
              Not used in message 1 or 2, or message 3 part 1, where the length is fixed
              Not used in message 3 part 1, as the length is specified in message 1

  encrypted data :: Same size as plaintext data, 0 - 65519 bytes

  MAC :: Poly1305 message authentication code, 16 bytes
</code></pre><p>For ChaCha20, what is described here corresponds to <a href="https://tools.ietf.org/html/rfc7539">RFC-7539</a>
, which is also
used similarly in TLS <a href="https://tools.ietf.org/html/rfc7905">RFC-7905</a>
.</p>
<h4 id="notes">Notes</h4>
<ul>
<li>
<p>Since ChaCha20 is a stream cipher, plaintexts need not be padded.
Additional keystream bytes are discarded.</p>
</li>
<li>
<p>The key for the cipher (256 bits) is agreed upon by means of the SHA256 KDF.
The details of the KDF for each message are in separate sections below.</p>
</li>
<li>
<p>ChaChaPoly frames for messages 1, 2, and the first part of message 3,
are of known size. Starting with the second part of message 3,
frames are of variable size. The message 3 part 1 size is specified in message 1.
Starting with the data phase, frames are prepended with a two-byte length
obfuscated with SipHash as in obfs4.</p>
</li>
<li>
<p>Padding is outside the authenticated data frame for messages 1 and 2.
The padding is used in the KDF for the next message so tampering will
be detected. Starting in message 3, padding is inside the authenticated
data frame.</p>
</li>
</ul>
<h3 id="aead-error-handling">AEAD Error Handling</h3>
<ul>
<li>
<p>In messages 1, 2, and message 3 parts 1 and 2, the AEAD message size is known in advance.
On an AEAD authentication failure, recipient must halt further message processing and close the
connection without responding.  This should be an abnormal close (TCP RST).</p>
</li>
<li>
<p>For probing resistance, in message 1, after an AEAD failure, Bob should
set a random timeout (range TBD) and then read a random number of bytes (range TBD)
before closing the socket. Bob should maintain a blacklist of IPs with
repeated failures.</p>
</li>
<li>
<p>In the data phase, the AEAD message size is &ldquo;encrypted&rdquo; (obfuscated) with SipHash.
Care must be taken to avoid creating a decryption oracle.
On a data phase AEAD authentication failure, the recipient should
set a random timeout (range TBD) and then read a random number of bytes (range TBD).
After the read, or on read timeout, the recipient should send a payload
with a termination block containing an &ldquo;AEAD failure&rdquo; reason code,
and close the connection.</p>
</li>
<li>
<p>Take the same error action for an invalid length field value in the data phase.</p>
</li>
</ul>
<h3 id="key-derivation-function-kdf-for-handshake-message-1">Key Derivation Function (KDF) (for handshake message 1)</h3>
<p>The KDF generates a handshake phase cipher key k from the DH result,
using HMAC-SHA256(key, data) as defined in <a href="https://tools.ietf.org/html/rfc2104">RFC-2104</a>
.
These are the InitializeSymmetric(), MixHash(), and MixKey() functions,
exactly as defined in the Noise spec.</p>
<pre tabindex="0"><code>This is the &#34;e&#34; message pattern:

  // Define protocol_name.
  Set protocol_name = &#34;Noise_XKaesobfse+hs2+hs3_25519_ChaChaPoly_SHA256&#34;
   (48 bytes, US-ASCII encoded, no NULL termination).

  // Define Hash h = 32 bytes
  h = SHA256(protocol_name);

  Define ck = 32 byte chaining key. Copy the h data to ck.
  Set ck = h

  Define rs = Bob&#39;s 32-byte static key as published in the RouterInfo

  // MixHash(null prologue)
  h = SHA256(h);

  // up until here, can all be precalculated by Alice for all outgoing connections

  // Alice must validate that Bob&#39;s static key is a valid point on the curve here.

  // Bob static key
  // MixHash(rs)
  // || below means append
  h = SHA256(h || rs);

  // up until here, can all be precalculated by Bob for all incoming connections

  This is the &#34;e&#34; message pattern:

  Alice generates her ephemeral DH key pair e.

  // Alice ephemeral key X
  // MixHash(e.pubkey)
  // || below means append
  h = SHA256(h || e.pubkey);

  // h is used as the associated data for the AEAD in message 1
  // Retain the Hash h for the message 2 KDF


  End of &#34;e&#34; message pattern.

  This is the &#34;es&#34; message pattern:

  // DH(e, rs) == DH(s, re)
  Define input_key_material = 32 byte DH result of Alice&#39;s ephemeral key and Bob&#39;s static key
  Set input_key_material = X25519 DH result

  // MixKey(DH())

  Define temp_key = 32 bytes
  Define HMAC-SHA256(key, data) as in [RFC-2104](https://tools.ietf.org/html/rfc2104)
  // Generate a temp key from the chaining key and DH result
  // ck is the chaining key, defined above
  temp_key = HMAC-SHA256(ck, input_key_material)
  // overwrite the DH result in memory, no longer needed
  input_key_material = (all zeros)

  // Output 1
  // Set a new chaining key from the temp key
  // byte() below means a single byte
  ck =       HMAC-SHA256(temp_key, byte(0x01)).

  // Output 2
  // Generate the cipher key k
  Define k = 32 bytes
  // || below means append
  // byte() below means a single byte
  k =        HMAC-SHA256(temp_key, ck || byte(0x02)).
  // overwrite the temp_key in memory, no longer needed
  temp_key = (all zeros)

  // retain the chaining key ck for message 2 KDF


  End of &#34;es&#34; message pattern.
</code></pre><h3 id="1-sessionrequest">1) SessionRequest</h3>
<p>Alice sends to Bob.</p>
<p>Noise content: Alice&rsquo;s ephemeral key X
Noise payload: 16 byte option block
Non-noise payload: Random padding</p>
<p>(Payload Security Properties)</p>
<pre tabindex="0"><code>XK(s, rs):           Authentication   Confidentiality
    -&gt; e, es                  0                2

    Authentication: None (0).
    This payload may have been sent by any party, including an active attacker.

    Confidentiality: 2.
    Encryption to a known recipient, forward secrecy for sender compromise
    only, vulnerable to replay.  This payload is encrypted based only on DHs
    involving the recipient&#39;s static key pair.  If the recipient&#39;s static
    private key is compromised, even at a later date, this payload can be
    decrypted.  This message can also be replayed, since there&#39;s no ephemeral
    contribution from the recipient.

    &#34;e&#34;: Alice generates a new ephemeral key pair and stores it in the e
         variable, writes the ephemeral public key as cleartext into the
         message buffer, and hashes the public key along with the old h to
         derive a new h.

    &#34;es&#34;: A DH is performed between the Alice&#39;s ephemeral key pair and the
          Bob&#39;s static key pair.  The result is hashed along with the old ck to
          derive a new ck and k, and n is set to zero.
</code></pre><p>The X value is encrypted to ensure payload indistinguishably
and uniqueness, which are necessary DPI countermeasures.
We use AES encryption to achieve this,
rather than more complex and slower alternatives such as elligator2.
Asymmetric encryption to Bob&rsquo;s router public key would be far too slow.
AES encryption uses Bob&rsquo;s router hash as the key and Bob&rsquo;s IV as published
in the network database.</p>
<p>AES encryption is for DPI resistance only.
Any party knowing Bob&rsquo;s router hash, and IV, which are published in the network database,
may decrypt the X value in this message.</p>
<p>The padding is not encrypted by Alice.
It may be necessary for Bob to decrypt the padding,
to inhibit timing attacks.</p>
<p>Raw contents:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+        obfuscated with RH_B           +
|       AES-CBC-256 encrypted X         |
+             (32 bytes)                +
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+                                       +
|   ChaChaPoly frame                    |
+             (32 bytes)                +
|   k defined in KDF for message 1      |
+   n = 0                               +
|   see KDF for associated data         |
+----+----+----+----+----+----+----+----+
|     unencrypted authenticated         |
~         padding (optional)            ~
|     length defined in options block   |
+----+----+----+----+----+----+----+----+

X :: 32 bytes, AES-256-CBC encrypted X25519 ephemeral key, little endian
        key: RH_B
        iv: As published in Bobs network database entry

padding :: Random data, 0 or more bytes.
           Total message length must be 65535 bytes or less.
           Total message length must be 287 bytes or less if
           Bob is publishing his address as NTCP
           (see Version Detection section below).
           Alice and Bob will use the padding data in the KDF for message 2.
           It is authenticated so that any tampering will cause the
           next message to fail.
</code></pre><p>Unencrypted data (Poly1305 authentication tag not shown):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+                                       +
|                   X                   |
+              (32 bytes)               +
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|               options                 |
+              (16 bytes)               +
|                                       |
+----+----+----+----+----+----+----+----+
|     unencrypted authenticated         |
+         padding (optional)            +
|     length defined in options block   |
~               .   .   .               ~
|                                       |
+----+----+----+----+----+----+----+----+

X :: 32 bytes, X25519 ephemeral key, little endian

options :: options block, 16 bytes, see below

padding :: Random data, 0 or more bytes.
           Total message length must be 65535 bytes or less.
           Total message length must be 287 bytes or less if
           Bob is publishing his address as &#34;NTCP&#34;
           (see Version Detection section below)
           Alice and Bob will use the padding data in the KDF for message 2.
           It is authenticated so that any tampering will cause the
           next message to fail.
</code></pre><p>Options block:
Note: All fields are big-endian.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| id | ver|  padLen | m3p2len | Rsvd(0) |
+----+----+----+----+----+----+----+----+
|        tsA        |   Reserved (0)    |
+----+----+----+----+----+----+----+----+

id :: 1 byte, the network ID (currently 2, except for test networks)
      As of 0.9.42. See proposal 147.

ver :: 1 byte, protocol version (currently 2)

padLen :: 2 bytes, length of the padding, 0 or more
          Min/max guidelines TBD. Random size from 0 to 31 bytes minimum?
          (Distribution to be determined, see Appendix A.)

m3p2Len :: 2 bytes, length of the the second AEAD frame in SessionConfirmed
           (message 3 part 2) See notes below

Rsvd :: 2 bytes, set to 0 for compatibility with future options

tsA :: 4 bytes, Unix timestamp, unsigned seconds.
       Wraps around in 2106

Reserved :: 4 bytes, set to 0 for compatibility with future options
</code></pre><h4 id="notes-1">Notes</h4>
<ul>
<li>
<p>When the published address is &ldquo;NTCP&rdquo;, Bob supports both NTCP and NTCP2 on the
same port. For compatibility, when initiating a connection to an address
published as &ldquo;NTCP&rdquo;, Alice must limit the maximum size of this message,
including padding, to 287 bytes or less.  This facilitates automatic protocol
identification by Bob.  When published as &ldquo;NTCP2&rdquo;, there is no size
restriction.  See the Published Addresses and Version Detection sections
below.</p>
</li>
<li>
<p>The unique X value in the initial AES block ensure that the ciphertext is
different for every session.</p>
</li>
<li>
<p>Bob must reject connections where the timestamp value is too far off from the
current time. Call the maximum delta time &ldquo;D&rdquo;.  Bob must maintain a local
cache of previously-used handshake values and reject duplicates, to prevent
replay attacks. Values in the cache must have a lifetime of at least 2*D.
The cache values are implementation-dependent, however the 32-byte X value
(or its encrypted equivalent) may be used.</p>
</li>
<li>
<p>Diffie-Hellman ephemeral keys may never be reused, to prevent cryptographic attacks,
and reuse will be rejected as a replay attack.</p>
</li>
<li>
<p>The &ldquo;KE&rdquo; and &ldquo;auth&rdquo; options must be compatible, i.e. the shared secret K must
be of the appropriate size. If more &ldquo;auth&rdquo; options are added, this could
implicitly change the meaning of the &ldquo;KE&rdquo; flag to use a different KDF or a
different truncation size.</p>
</li>
<li>
<p>Bob must validate that Alice&rsquo;s ephemeral key is a valid point on the curve
here.</p>
</li>
<li>
<p>Padding should be limited to a reasonable amount.  Bob may reject connections
with excessive padding.  Bob will specify his padding options in message 2.
Min/max guidelines TBD. Random size from 0 to 31 bytes minimum?
(Distribution to be determined, see Appendix A.)</p>
</li>
<li>
<p>On any error, including AEAD, DH, timestamp, apparent replay, or key
validation failure, Bob must halt further message processing and close the
connection without responding.  This should be an abnormal close (TCP RST).
For probing resistance, after an AEAD failure, Bob should
set a random timeout (range TBD) and then read a random number of bytes (range TBD),
before closing the socket.</p>
</li>
<li>
<p>DoS Mitigation: DH is a relatively expensive operation. As with the previous NTCP protocol,
routers should take all necessary measures to prevent CPU or connection exhaustion.
Place limits on maximum active connections and maximum connection setups in progress.
Enforce read timeouts (both per-read and total for &ldquo;slowloris&rdquo;).
Limit repeated or simultaneous connections from the same source.
Maintain blacklists for sources that repeatedly fail.
Do not respond to AEAD failure.</p>
</li>
<li>
<p>To facilitate rapid version detection and handshaking, implementations must
ensure that Alice buffers and then flushes the entire contents of the first
message at once, including the padding.  This increases the likelihood that
the data will be contained in a single TCP packet (unless segmented by the OS
or middleboxes), and received all at once by Bob.  Additionally,
implementations must ensure that Bob buffers and then flushes the entire
contents of the second message at once, including the padding.  and that Bob
buffers and then flushes the entire contents of the third message at once.
This is also for efficiency and to ensure the effectiveness of the random
padding.</p>
</li>
<li>
<p>&ldquo;ver&rdquo; field: The overall Noise protocol, extensions, and NTCP protocol
including payload specifications, indicating NTCP2.
This field may be used to indicate support for future changes.</p>
</li>
<li>
<p>Message 3 part 2 length: This is the size of the second AEAD frame (including 16-byte MAC)
containing Alice&rsquo;s Router Info and optional padding that will be sent in
the SessionConfirmed message. As routers periodically regenerate and republish
their Router Info, the size of the current Router Info may change before
message 3 is sent. Implementations must choose one of two strategies:
a) save the current Router Info to be sent in message 3, so the size is known,
and optionally add room for padding;
b) increase the specified size enough to allow for possible increase in
the Router Info size, and always add padding when message 3 is actually sent.
In either case, the &ldquo;m3p2len&rdquo; length included in message 1 must be exactly the
size of that frame when sent in message 3.</p>
</li>
<li>
<p>Bob must fail the connection if any incoming data remains after validating
message 1 and reading in the padding. There should be no extra data from Alice,
as Bob has not responded with message 2 yet.</p>
</li>
<li>
<p>The network ID field is used to quickly identify cross-network connections.
If this field is nonzero, and does not match Bob&rsquo;s network ID,
Bob should disconnect and block future connections.
As of 0.9.42. See proposal 147 for more information.</p>
</li>
</ul>
<h3 id="key-derivation-function-kdf-for-handshake-message-2-and-message-3-part-1">Key Derivation Function (KDF) (for handshake message 2 and message 3 part 1)</h3>
<pre tabindex="0"><code>
// take h saved from message 1 KDF
// MixHash(ciphertext)
h = SHA256(h || 32 byte encrypted payload from message 1)

// MixHash(padding)
// Only if padding length is nonzero
h = SHA256(h || random padding from message 1)

This is the &#34;e&#34; message pattern:

Bob generates his ephemeral DH key pair e.

// h is from KDF for handshake message 1
// Bob ephemeral key Y
// MixHash(e.pubkey)
// || below means append
h = SHA256(h || e.pubkey);

// h is used as the associated data for the AEAD in message 2
// Retain the Hash h for the message 3 KDF

End of &#34;e&#34; message pattern.

This is the &#34;ee&#34; message pattern:

// DH(e, re)
Define input_key_material = 32 byte DH result of Alice&#39;s ephemeral key and Bob&#39;s ephemeral key
Set input_key_material = X25519 DH result
// overwrite Alice&#39;s ephemeral key in memory, no longer needed
// Alice:
e(public and private) = (all zeros)
// Bob:
re = (all zeros)

// MixKey(DH())

Define temp_key = 32 bytes
Define HMAC-SHA256(key, data) as in [RFC-2104](https://tools.ietf.org/html/rfc2104)
// Generate a temp key from the chaining key and DH result
// ck is the chaining key, from the KDF for handshake message 1
temp_key = HMAC-SHA256(ck, input_key_material)
// overwrite the DH result in memory, no longer needed
input_key_material = (all zeros)

// Output 1
// Set a new chaining key from the temp key
// byte() below means a single byte
ck =       HMAC-SHA256(temp_key, byte(0x01)).

// Output 2
// Generate the cipher key k
Define k = 32 bytes
// || below means append
// byte() below means a single byte
k =        HMAC-SHA256(temp_key, ck || byte(0x02)).
// overwrite the temp_key in memory, no longer needed
temp_key = (all zeros)

// retain the chaining key ck for message 3 KDF

End of &#34;ee&#34; message pattern.
</code></pre><h3 id="2-sessioncreated">2) SessionCreated</h3>
<p>Bob sends to Alice.</p>
<p>Noise content: Bob&rsquo;s ephemeral key Y
Noise payload: 16 byte option block
Non-noise payload: Random padding</p>
<p>(Payload Security Properties)</p>
<pre tabindex="0"><code>XK(s, rs):           Authentication   Confidentiality
  &lt;- e, ee                  2                1

  Authentication: 2.
  Sender authentication resistant to key-compromise impersonation (KCI).
  The sender authentication is based on an ephemeral-static DH (&#34;es&#34; or &#34;se&#34;)
  between the sender&#39;s static key pair and the recipient&#39;s ephemeral key pair.
  Assuming the corresponding private keys are secure, this authentication cannot be forged.

  Confidentiality: 1.
  Encryption to an ephemeral recipient.
  This payload has forward secrecy, since encryption involves an ephemeral-ephemeral DH (&#34;ee&#34;).
  However, the sender has not authenticated the recipient,
  so this payload might be sent to any party, including an active attacker.


  &#34;e&#34;: Bob generates a new ephemeral key pair and stores it in the e variable,
  writes the ephemeral public key as cleartext into the message buffer,
  and hashes the public key along with the old h to derive a new h.

  &#34;ee&#34;: A DH is performed between the Bob&#39;s ephemeral key pair and the Alice&#39;s ephemeral key pair.
  The result is hashed along with the old ck to derive a new ck and k, and n is set to zero.
</code></pre><p>The Y value is encrypted to ensure payload indistinguishably and uniqueness,
which are necessary DPI countermeasures.  We use AES encryption to achieve
this, rather than more complex and slower alternatives such as elligator2.
Asymmetric encryption to Alice&rsquo;s router public key would be far too slow.  AES
encryption uses Bob&rsquo;s router hash as the key and the AES state from message 1
(which was initialized with Bob&rsquo;s IV as published in the network database).</p>
<p>AES encryption is for DPI resistance only.  Any party knowing Bob&rsquo;s router hash
and IV, which are published in the network database, and captured the first 32
bytes of message 1, may decrypt the Y value in this message.</p>
<p>Raw contents:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+        obfuscated with RH_B           +
|       AES-CBC-256 encrypted Y         |
+              (32 bytes)               +
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|   ChaChaPoly frame                    |
+   Encrypted and authenticated data    +
|   32 bytes                            |
+   k defined in KDF for message 2      +
|   n = 0; see KDF for associated data  |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|     unencrypted authenticated         |
+         padding (optional)            +
|     length defined in options block   |
~               .   .   .               ~
|                                       |
+----+----+----+----+----+----+----+----+

Y :: 32 bytes, AES-256-CBC encrypted X25519 ephemeral key, little endian
        key: RH_B
        iv: Using AES state from message 1
</code></pre><p>Unencrypted data (Poly1305 auth tag not shown):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+                                       +
|                  Y                    |
+              (32 bytes)               +
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|               options                 |
+              (16 bytes)               +
|                                       |
+----+----+----+----+----+----+----+----+
|     unencrypted authenticated         |
+         padding (optional)            +
|     length defined in options block   |
~               .   .   .               ~
|                                       |
+----+----+----+----+----+----+----+----+

Y :: 32 bytes, X25519 ephemeral key, little endian

options :: options block, 16 bytes, see below

padding :: Random data, 0 or more bytes.
           Total message length must be 65535 bytes or less.
           Alice and Bob will use the padding data in the KDF for message 3 part 1.
           It is authenticated so that any tampering will cause the
           next message to fail.
</code></pre><h4 id="notes-2">Notes</h4>
<ul>
<li>
<p>Alice must validate that Bob&rsquo;s ephemeral key is a valid point on the curve
here.</p>
</li>
<li>
<p>Padding should be limited to a reasonable amount.
Alice may reject connections with excessive padding.
Alice will specify her padding options in message 3.
Min/max guidelines TBD. Random size from 0 to 31 bytes minimum?
(Distribution to be determined, see Appendix A.)</p>
</li>
<li>
<p>On any error, including AEAD, DH, timestamp, apparent replay, or key
validation failure, Alice must halt further message processing and close the
connection without responding.  This should be an abnormal close (TCP RST).</p>
</li>
<li>
<p>To facilitate rapid handshaking, implementations must ensure that Bob buffers
and then flushes the entire contents of the first message at once, including
the padding.  This increases the likelihood that the data will be contained
in a single TCP packet (unless segmented by the OS or middleboxes), and
received all at once by Alice.  This is also for efficiency and to ensure the
effectiveness of the random padding.</p>
</li>
<li>
<p>Alice must fail the connection if any incoming data remains after validating
message 2 and reading in the padding. There should be no extra data from Bob,
as Alice has not responded with message 3 yet.</p>
</li>
</ul>
<p>Options block:
Note: All fields are big-endian.</p>
<pre tabindex="0"><code>
+----+----+----+----+----+----+----+----+
| Rsvd(0) | padLen  |   Reserved (0)    |
+----+----+----+----+----+----+----+----+
|        tsB        |   Reserved (0)    |
+----+----+----+----+----+----+----+----+

Reserved :: 10 bytes total, set to 0 for compatibility with future options

padLen :: 2 bytes, big endian, length of the padding, 0 or more
          Min/max guidelines TBD. Random size from 0 to 31 bytes minimum?
          (Distribution to be determined, see Appendix A.)

tsB :: 4 bytes, big endian, Unix timestamp, unsigned seconds.
       Wraps around in 2106
</code></pre><h4 id="notes-3">Notes</h4>
<ul>
<li>Alice must reject connections where the timestamp value is too far off from
the current time. Call the maximum delta time &ldquo;D&rdquo;.  Alice must maintain a
local cache of previously-used handshake values and reject duplicates, to
prevent replay attacks. Values in the cache must have a lifetime of at least
2*D.  The cache values are implementation-dependent, however the 32-byte Y
value (or its encrypted equivalent) may be used.</li>
</ul>
<h4 id="issues">Issues</h4>
<ul>
<li>Include min/max padding options here?</li>
</ul>
<h3 id="encryption-for-for-handshake-message-3-part-1-using-message-2-kdf">Encryption for for handshake message 3 part 1, using message 2 KDF)</h3>
<pre tabindex="0"><code>
// take h saved from message 2 KDF
// MixHash(ciphertext)
h = SHA256(h || 24 byte encrypted payload from message 2)

// MixHash(padding)
// Only if padding length is nonzero
h = SHA256(h || random padding from message 2)
// h is used as the associated data for the AEAD in message 3 part 1, below

This is the &#34;s&#34; message pattern:

Define s = Alice&#39;s static public key, 32 bytes

// EncryptAndHash(s.publickey)
// EncryptWithAd(h, s.publickey)
// AEAD_ChaCha20_Poly1305(key, nonce, associatedData, data)
// k is from handshake message 1
// n is 1
ciphertext = AEAD_ChaCha20_Poly1305(k, n++, h, s.publickey)
// MixHash(ciphertext)
// || below means append
h = SHA256(h || ciphertext);

// h is used as the associated data for the AEAD in message 3 part 2

End of &#34;s&#34; message pattern.
</code></pre><h3 id="key-derivation-function-kdf-for-handshake-message-3-part-2">Key Derivation Function (KDF) (for handshake message 3 part 2)</h3>
<pre tabindex="0"><code>
This is the &#34;se&#34; message pattern:

// DH(s, re) == DH(e, rs)
Define input_key_material = 32 byte DH result of Alice&#39;s static key and Bob&#39;s ephemeral key
Set input_key_material = X25519 DH result
// overwrite Bob&#39;s ephemeral key in memory, no longer needed
// Alice:
re = (all zeros)
// Bob:
e(public and private) = (all zeros)

// MixKey(DH())

Define temp_key = 32 bytes
Define HMAC-SHA256(key, data) as in [RFC-2104](https://tools.ietf.org/html/rfc2104)
// Generate a temp key from the chaining key and DH result
// ck is the chaining key, from the KDF for handshake message 1
temp_key = HMAC-SHA256(ck, input_key_material)
// overwrite the DH result in memory, no longer needed
input_key_material = (all zeros)

// Output 1
// Set a new chaining key from the temp key
// byte() below means a single byte
ck =       HMAC-SHA256(temp_key, byte(0x01)).

// Output 2
// Generate the cipher key k
Define k = 32 bytes
// || below means append
// byte() below means a single byte
k =        HMAC-SHA256(temp_key, ck || byte(0x02)).

// h from message 3 part 1 is used as the associated data for the AEAD in message 3 part 2

// EncryptAndHash(payload)
// EncryptWithAd(h, payload)
// AEAD_ChaCha20_Poly1305(key, nonce, associatedData, data)
// n is 0
ciphertext = AEAD_ChaCha20_Poly1305(k, n++, h, payload)
// MixHash(ciphertext)
// || below means append
h = SHA256(h || ciphertext);

// retain the chaining key ck for the data phase KDF
// retain the hash h for the data phase Additional Symmetric Key (SipHash) KDF

End of &#34;se&#34; message pattern.

// overwrite the temp_key in memory, no longer needed
temp_key = (all zeros)
</code></pre><h3 id="3-sessionconfirmed">3) SessionConfirmed</h3>
<p>Alice sends to Bob.</p>
<p>Noise content: Alice&rsquo;s static key
Noise payload: Alice&rsquo;s RouterInfo and random padding
Non-noise payload: none</p>
<p>(Payload Security Properties)</p>
<pre tabindex="0"><code>XK(s, rs):           Authentication   Confidentiality
  -&gt; s, se                  2                5

  Authentication: 2.
  Sender authentication resistant to key-compromise impersonation (KCI).  The
  sender authentication is based on an ephemeral-static DH (&#34;es&#34; or &#34;se&#34;)
  between the sender&#39;s static key pair and the recipient&#39;s ephemeral key
  pair.  Assuming the corresponding private keys are secure, this
  authentication cannot be forged.

  Confidentiality: 5.
  Encryption to a known recipient, strong forward secrecy.  This payload is
  encrypted based on an ephemeral-ephemeral DH as well as an ephemeral-static
  DH with the recipient&#39;s static key pair.  Assuming the ephemeral private
  keys are secure, and the recipient is not being actively impersonated by an
  attacker that has stolen its static private key, this payload cannot be
  decrypted.

  &#34;s&#34;: Alice writes her static public key from the s variable into the
  message buffer, encrypting it, and hashes the output along with the old h
  to derive a new h.

  &#34;se&#34;: A DH is performed between the Alice&#39;s static key pair and the Bob&#39;s
  ephemeral key pair.  The result is hashed along with the old ck to derive a
  new ck and k, and n is set to zero.
</code></pre><p>This contains two ChaChaPoly frames.
The first is Alice&rsquo;s encrypted static public key.
The second is the Noise payload: Alice&rsquo;s encrypted RouterInfo, optional
options, and optional padding.  They use different keys, because the MixKey()
function is called in between.</p>
<p>Raw contents:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+   ChaChaPoly frame (48 bytes)         +
|   Encrypted and authenticated         |
+   Alice static key S                  +
|      (32 bytes)                       |
+                                       +
|     k defined in KDF for message 2    |
+     n = 1                             +
|     see KDF for associated data       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+     Length specified in message 1     +
|                                       |
+   ChaChaPoly frame                    +
|   Encrypted and authenticated         |
+                                       +
|       Alice RouterInfo                |
+       using block format 2            +
|       Alice Options (optional)        |
+       using block format 1            +
|       Arbitrary padding               |
+       using block format 254          +
|                                       |
+                                       +
| k defined in KDF for message 3 part 2 |
+     n = 0                             +
|     see KDF for associated data       |
~               .   .   .               ~
|                                       |
+----+----+----+----+----+----+----+----+

S :: 32 bytes, ChaChaPoly encrypted Alice&#39;s X25519 static key, little endian
     inside 48 byte ChaChaPoly frame
</code></pre><p>Unencrypted data (Poly1305 auth tags not shown):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+                                       +
|              S                        |
+       Alice static key                +
|          (32 bytes)                   |
+                                       +
|                                       |
+                                       +
+----+----+----+----+----+----+----+----+
|                                       |
+                                       +
|                                       |
+                                       +
|       Alice RouterInfo block          |
~               .   .   .               ~
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+       Optional Options block          +
|                                       |
~               .   .   .               ~
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+       Optional Padding block          +
|                                       |
~               .   .   .               ~
|                                       |
+----+----+----+----+----+----+----+----+

S :: 32 bytes, Alice&#39;s X25519 static key, little endian
</code></pre><h4 id="notes-4">Notes</h4>
<ul>
<li>
<p>Bob must perform the usual Router Info validation.
Ensure the signature type is supported, verify the signature,
verify the timestamp is within bounds, and any other checks necessary.</p>
</li>
<li>
<p>Bob must verify that Alice&rsquo;s static key received in the first frame matches
the static key in the Router Info. Bob must first search the Router Info for
a NTCP or NTCP2 Router Address with a matching version (v) option.
See Published Router Info and Unpublished Router Info sections below.</p>
</li>
<li>
<p>If Bob has an older version of Alice&rsquo;s RouterInfo in his netdb, verify
that the static key in the router info is the same in both, if present,
and if the older version is less than XXX old (see key rotate time below)</p>
</li>
<li>
<p>Bob must validate that Alice&rsquo;s static key is a valid point on the curve here.</p>
</li>
<li>
<p>Options should be included, to specify padding parameters.</p>
</li>
<li>
<p>On any error, including AEAD, RI, DH, timestamp, or key validation failure,
Bob must halt further message processing and close the connection without
responding.  This should be an abnormal close (TCP RST).</p>
</li>
<li>
<p>To facilitate rapid handshaking, implementations must ensure that Alice
buffers and then flushes the entire contents of the third message at once,
including both AEAD frames.
This increases the likelihood that the data will be contained in a single TCP
packet (unless segmented by the OS or middleboxes), and received all at once
by Bob.  This is also for efficiency and to ensure the effectiveness of the
random padding.</p>
</li>
<li>
<p>Message 3 part 2 frame length: The length of this frame (including MAC) is
sent by Alice in message 1. See that message for important notes on allowing
enough room for padding.</p>
</li>
<li>
<p>Message 3 part 2 frame content: This format of this frame is the same as the
format of data phase frames, except that the length of the frame is sent
by Alice in message 1. See below for the data phase frame format.
The frame must contain 1 to 3 blocks in the following order:</p>
<ol>
<li>Alice&rsquo;s Router Info block (required)</li>
<li>Options block (optional)</li>
<li>Padding block (optional)
This frame must never contain any other block type.</li>
</ol>
</li>
<li>
<p>Message 3 part 2 padding is not required if Alice appends a data phase frame
(optionally containing padding) to the end of message 3 and sends both at once,
as it will appear as one big stream of bytes to an observer.
As Alice will generally, but not always, have an I2NP message to send to Bob
(that&rsquo;s why she connected to him), this is the recommended implementation,
for efficiency and to ensure the effectiveness of the random padding.</p>
</li>
<li>
<p>Total length of both Message 3 AEAD frames (parts 1 and 2) is 65535 bytes;
part 1 is 48 bytes so part 2 max frame length is 65487;
part 2 max plaintext length excluding MAC is 65471.</p>
</li>
</ul>
<h3 id="key-derivation-function-kdf-for-data-phase">Key Derivation Function (KDF) (for data phase)</h3>
<p>The data phase uses a zero-length associated data input.</p>
<p>The KDF generates two cipher keys k_ab and k_ba from the chaining key ck,
using HMAC-SHA256(key, data) as defined in <a href="https://tools.ietf.org/html/rfc2104">RFC-2104</a>
.
This is the Split() function, exactly as defined in the Noise spec.</p>
<pre tabindex="0"><code>
ck = from handshake phase

// k_ab, k_ba = HKDF(ck, zerolen)
// ask_master = HKDF(ck, zerolen, info=&#34;ask&#34;)

// zerolen is a zero-length byte array
temp_key = HMAC-SHA256(ck, zerolen)
// overwrite the chaining key in memory, no longer needed
ck = (all zeros)

// Output 1
// cipher key, for Alice transmits to Bob (Noise doesn&#39;t make clear which is which, but Java code does)
k_ab =   HMAC-SHA256(temp_key, byte(0x01)).

// Output 2
// cipher key, for Bob transmits to Alice (Noise doesn&#39;t make clear which is which, but Java code does)
k_ba =   HMAC-SHA256(temp_key, k_ab || byte(0x02)).


KDF for SipHash for length field:
Generate an Additional Symmetric Key (ask) for SipHash
SipHash uses two 8-byte keys (big endian) and 8 byte IV for first data.

// &#34;ask&#34; is 3 bytes, US-ASCII, no null termination
ask_master = HMAC-SHA256(temp_key, &#34;ask&#34; || byte(0x01))
// sip_master = HKDF(ask_master, h || &#34;siphash&#34;)
// &#34;siphash&#34; is 7 bytes, US-ASCII, no null termination
// overwrite previous temp_key in memory
// h is from KDF for message 3 part 2
temp_key = HMAC-SHA256(ask_master, h || &#34;siphash&#34;)
// overwrite ask_master in memory, no longer needed
ask_master = (all zeros)
sip_master = HMAC-SHA256(temp_key, byte(0x01))

Alice to Bob SipHash k1, k2, IV:
// sipkeys_ab, sipkeys_ba = HKDF(sip_master, zerolen)
// overwrite previous temp_key in memory
temp_key = HMAC-SHA256(sip_master, zerolen)
// overwrite sip_master in memory, no longer needed
sip_master = (all zeros)

sipkeys_ab = HMAC-SHA256(temp_key, byte(0x01)).
sipk1_ab = sipkeys_ab[0:7], little endian
sipk2_ab = sipkeys_ab[8:15], little endian
sipiv_ab = sipkeys_ab[16:23]

Bob to Alice SipHash k1, k2, IV:

sipkeys_ba = HMAC-SHA256(temp_key, sipkeys_ab || byte(0x02)).
sipk1_ba = sipkeys_ba[0:7], little endian
sipk2_ba = sipkeys_ba[8:15], little endian
sipiv_ba = sipkeys_ba[16:23]

// overwrite the temp_key in memory, no longer needed
temp_key = (all zeros)
</code></pre><h3 id="4-data-phase">4) Data Phase</h3>
<p>Noise payload: As defined below, including random padding
Non-noise payload: none</p>
<p>Starting with the 2nd part of message 3, all messages are inside
an authenticated and encrypted ChaChaPoly &ldquo;frame&rdquo;
with a prepended two-byte obfuscated length.
All padding is inside the frame.
Inside the frame is a standard format with zero or more &ldquo;blocks&rdquo;.
Each block has a one-byte type and a two-byte length.
Types include date/time, I2NP message, options, termination, and padding.</p>
<p>Note: Bob may, but is not required, to send his RouterInfo to Alice as
his first message to Alice in the data phase.</p>
<p>(Payload Security Properties)</p>
<pre tabindex="0"><code>XK(s, rs):           Authentication   Confidentiality
  &lt;-                        2                5
  -&gt;                        2                5

  Authentication: 2.
  Sender authentication resistant to key-compromise impersonation (KCI).
  The sender authentication is based on an ephemeral-static DH (&#34;es&#34; or &#34;se&#34;)
  between the sender&#39;s static key pair and the recipient&#39;s ephemeral key pair.
  Assuming the corresponding private keys are secure, this authentication cannot be forged.

  Confidentiality: 5.
  Encryption to a known recipient, strong forward secrecy.
  This payload is encrypted based on an ephemeral-ephemeral DH as well as
  an ephemeral-static DH with the recipient&#39;s static key pair.
  Assuming the ephemeral private keys are secure, and the recipient is not being actively impersonated
  by an attacker that has stolen its static private key, this payload cannot be decrypted.
</code></pre><h4 id="notes-5">Notes</h4>
<ul>
<li>
<p>For efficiency and to minimize identification of the length field,
implementations must ensure that the sender buffers and then flushes the entire contents
of data messages at once, including the length field and the AEAD frame.
This increases the likelihood that the data will be contained in a single TCP packet
(unless segmented by the OS or middleboxes), and received all at once the other party.
This is also for efficiency and to ensure the effectiveness of the random padding.</p>
</li>
<li>
<p>The router may choose to terminate the session on AEAD error, or may continue to attempt communications.
If continuing, the router should terminate after repeated errors.</p>
</li>
</ul>
<h3 id="siphash-obfuscated-length">SipHash obfuscated length</h3>
<p>Reference: <a href="https://www.131002.net/siphash/">SipHash</a>
</p>
<p>Once both sides have completed the handshake, they transfer payloads
that are then encrypted and authenticated in ChaChaPoly &ldquo;frames&rdquo;.</p>
<p>Each frame is preceded by a two-byte length, big endian.
This length specifies the number of encrypted frame bytes to follow,
including the MAC.
To avoid transmitting identifiable length fields in stream, the frame length
is obfuscated by XORing a mask derived from SipHash, as initialized
from the data phase KDF.
Note that the two directions have unique SipHash keys and IVs from the KDF.</p>
<pre tabindex="0"><code>    sipk1, sipk2 = The SipHash keys from the KDF.  (two 8-byte long integers)
    IV[0] = sipiv = The SipHash IV from the KDF. (8 bytes)
    length is big endian.
    For each frame:
      IV[n] = SipHash-2-4(sipk1, sipk2, IV[n-1])
      Mask[n] = First 2 bytes of IV[n]
      obfuscatedLength = length ^ Mask[n]

    The first length output will be XORed with with IV[1].
</code></pre><p>The receiver has the identical SipHash keys and IV.
Decoding the length is done by deriving the mask used to obfsucate the length and XORing the truncated
digest to obtain the length of the frame.
The frame length is the total length of the encrypted frame including the MAC.</p>
<h4 id="notes-6">Notes</h4>
<ul>
<li>If you use a SipHash library function that returns an unsigned long integer,
use the least significant two bytes as the Mask.
Convert the long integer to the next IV as little endian.</li>
</ul>
<h3 id="raw-contents">Raw contents</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|obf size |                             |
+----+----+                             +
|                                       |
+   ChaChaPoly frame                    +
|   Encrypted and authenticated         |
+   key is k_ab for Alice to Bob        +
|   key is k_ba for Bob to Alice        |
+   as defined in KDF for data phase    +
|   n starts at 0 and increments        |
+   for each frame in that direction    +
|   no associated data                  |
+   16 bytes minimum                    +
|                                       |
~               .   .   .               ~
|                                       |
+----+----+----+----+----+----+----+----+

obf size :: 2 bytes length obfuscated with SipHash
            when de-obfuscated: 16 - 65535

Minimum size including length field is 18 bytes.
Maximum size including length field is 65537 bytes.
Obfuscated length is 2 bytes.
Maximum ChaChaPoly frame is 65535 bytes.
</code></pre><h3 id="unencrypted-data">Unencrypted data</h3>
<p>There are zero or more blocks in the encrypted frame.
Each block contains a one-byte identifier, a two-byte length,
and zero or more bytes of data.</p>
<p>For extensibility, receivers must ignore blocks with unknown identifiers,
and treat them as padding.</p>
<p>Encrypted data is 65535 bytes max, including a 16-byte authentication header,
so the max unencrypted data is 65519 bytes.</p>
<p>(Poly1305 auth tag not shown):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|blk |  size   |       data             |
+----+----+----+                        +
|                                       |
~               .   .   .               ~
|                                       |
+----+----+----+----+----+----+----+----+
|blk |  size   |       data             |
+----+----+----+                        +
|                                       |
~               .   .   .               ~
|                                       |
+----+----+----+----+----+----+----+----+
~               .   .   .               ~

blk :: 1 byte
       0 for datetime
       1 for options
       2 for RouterInfo
       3 for I2NP message
       4 for termination
       224-253 reserved for experimental features
       254 for padding
       255 reserved for future extension
size :: 2 bytes, big endian, size of data to follow, 0 - 65516
data :: the data

Maximum ChaChaPoly frame is 65535 bytes.
Poly1305 tag is 16 bytes
Maximum total block size is 65519 bytes
Maximum single block size is 65519 bytes
Block type is 1 byte
Block length is 2 bytes
Maximum single block data size is 65516 bytes.
</code></pre><h3 id="block-ordering-rules">Block Ordering Rules</h3>
<p>In the handshake message 3 part 2, order must be:
RouterInfo, followed by Options if present, followed by Padding if present.
No other blocks are allowed.</p>
<p>In the data phase, order is unspecified, except for the
following requirements:
Padding, if present, must be the last block.
Termination, if present, must be the last block except for Padding.</p>
<p>There may be multiple I2NP blocks in a single frame.
Multiple Padding blocks are not allowed in a single frame.
Other block types probably won&rsquo;t have multiple blocks in
a single frame, but it is not prohibited.</p>
<h3 id="datetime">DateTime</h3>
<p>Special case for time synchronization:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+
| 0  |    4    |     timestamp     |
+----+----+----+----+----+----+----+

blk :: 0
size :: 2 bytes, big endian, value = 4
timestamp :: Unix timestamp, unsigned seconds.
             Wraps around in 2106
</code></pre><h3 id="options">Options</h3>
<p>Pass updated options.
Options include: Min and max padding.</p>
<p>Options block will be variable length.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 1  |  size   |tmin|tmax|rmin|rmax|tdmy|
+----+----+----+----+----+----+----+----+
|tdmy|  rdmy   |  tdelay |  rdelay |    |
~----+----+----+----+----+----+----+    ~
|              more_options             |
~               .   .   .               ~
|                                       |
+----+----+----+----+----+----+----+----+

blk :: 1
size :: 2 bytes, big endian, size of options to follow, 12 bytes minimum

tmin, tmax, rmin, rmax :: requested padding limits
    tmin and rmin are for desired resistance to traffic analysis.
    tmax and rmax are for bandwidth limits.
    tmin and tmax are the transmit limits for the router sending this options block.
    rmin and rmax are the receive limits for the router sending this options block.
    Each is a 4.4 fixed-point float representing 0 to 15.9375
    (or think of it as an unsigned 8-bit integer divided by 16.0).
    This is the ratio of padding to data. Examples:
    Value of 0x00 means no padding
    Value of 0x01 means add 6 percent padding
    Value of 0x10 means add 100 percent padding
    Value of 0x80 means add 800 percent (8x) padding
    Alice and Bob will negotiate the minimum and maximum in each direction.
    These are guidelines, there is no enforcement.
    Sender should honor receiver&#39;s maximum.
    Sender may or may not honor receiver&#39;s minimum, within bandwidth constraints.

tdmy: Max dummy traffic willing to send, 2 bytes big endian, bytes/sec average
rdmy: Requested dummy traffic, 2 bytes big endian, bytes/sec average
tdelay: Max intra-message delay willing to insert, 2 bytes big endian, msec average
rdelay: Requested intra-message delay, 2 bytes big endian, msec average

Padding distribution specified as additional parameters?
Random delay specified as additional parameters?

more_options :: Format TBD
</code></pre><h3 id="options-issues">Options Issues</h3>
<ul>
<li>Options format is TBD.</li>
<li>Options negotiation is TBD.</li>
</ul>
<h3 id="routerinfo">RouterInfo</h3>
<p>Pass Alice&rsquo;s RouterInfo to Bob.
Used in handshake message 3 part 2.
Pass Alice&rsquo;s RouterInfo to Bob, or Bob&rsquo;s to Alice.
Used optionally in the data phase.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 2  |  size   |flg |    RouterInfo     |
+----+----+----+----+                   +
| (Alice RI in handshake msg 3 part 2)  |
~ (Alice, Bob, or third-party           ~
|  RI in data phase)                    |
~               .   .   .               ~
|                                       |
+----+----+----+----+----+----+----+----+

blk :: 2
size :: 2 bytes, big endian, size of flag + router info to follow
flg :: 1 byte flags
       bit order: 76543210
       bit 0: 0 for local store, 1 for flood request
       bits 7-1: Unused, set to 0 for future compatibility
routerinfo :: Alice&#39;s or Bob&#39;s RouterInfo
</code></pre><h4 id="notes-7">Notes</h4>
<ul>
<li>
<p>When used in the data phase, receiver (Alice or Bob) shall validate that
it&rsquo;s the same Router Hash as originally sent (for Alice) or sent to (for Bob).
Then, treat it as a local I2NP DatabaseStore Message. Validate signature,
validate more recent timestamp, and store in the local netdb.
If the flag bit 0 is 1, and the receiving party is floodfill,
treat it as a DatabaseStore Message with a nonzero reply token,
and flood it to the nearest floodfills.</p>
</li>
<li>
<p>The Router Info is NOT compressed with gzip
(unlike in a DatabaseStore Message, where it is)</p>
</li>
<li>
<p>Flooding must not be requested unless there are published
RouterAddresses in the RouterInfo. The receiving router
must not flood the RouterInfo unless there are published
RouterAddresses in it.</p>
</li>
<li>
<p>Implementers must ensure that when reading a block,
malformed or malicious data will not cause reads to
overrun into the next block.</p>
</li>
<li>
<p>This protocol does not provide an acknowledgement that the RouterInfo
was received, stored, or flooded (either in the handshake or data phase).
If acknowledgement is desired, and the receiver is floodfill,
the sender should instead send a standard I2NP DatabaseStoreMessage
with a reply token.</p>
</li>
</ul>
<h4 id="issues-1">Issues</h4>
<ul>
<li>
<p>Could also be used in data phase, instead of a I2NP DatabaseStoreMessage.
For example, Bob could use it to start off the data phase.</p>
</li>
<li>
<p>Is it allowed for this to contain the RI for routers other than the
originator, as a general replacement for DatabaseStoreMessages,
e.g. for flooding by floodfills?</p>
</li>
</ul>
<h3 id="i2np-message">I2NP Message</h3>
<p>An single I2NP message with a modified header.
I2NP messages may not be fragmented across blocks or
across ChaChaPoly frames.</p>
<p>This uses the first 9 bytes from the standard NTCP I2NP header,
and removes the last 7 bytes of the header, as follows:
truncate the expiration from 8 to 4 bytes,
remove the 2 byte length (use the block size - 9),
and remove the one-byte SHA256 checksum.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 3  |  size   |type|    msg id         |
+----+----+----+----+----+----+----+----+
|   short exp       |     message       |
+----+----+----+----+                   +
|                                       |
~               .   .   .               ~
|                                       |
+----+----+----+----+----+----+----+----+

blk :: 3
size :: 2 bytes, big endian, size of type + msg id + exp + message to follow
        I2NP message body size is (size - 9).
type :: 1 byte, I2NP msg type, see I2NP spec
msg id :: 4 bytes, big endian, I2NP message ID
short exp :: 4 bytes, big endian, I2NP message expiration, Unix timestamp, unsigned seconds.
             Wraps around in 2106
message :: I2NP message body
</code></pre><h4 id="notes-8">Notes</h4>
<ul>
<li>Implementers must ensure that when reading a block,
malformed or malicious data will not cause reads to
overrun into the next block.</li>
</ul>
<h3 id="termination">Termination</h3>
<p>Noise recommends an explicit termination message.
Original NTCP doesn&rsquo;t have one.
Drop the connection.
This must be the last non-padding block in the frame.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 4  |  size   |    valid data frames   |
+----+----+----+----+----+----+----+----+
    received   | rsn|     addl data     |
+----+----+----+----+                   +
~               .   .   .               ~
+----+----+----+----+----+----+----+----+

blk :: 4
size :: 2 bytes, big endian, value = 9 or more
valid data frames received :: The number of valid AEAD data phase frames received
                              (current receive nonce value)
                              0 if error occurs in handshake phase
                              8 bytes, big endian
rsn :: reason, 1 byte:
       0: normal close or unspecified
       1: termination received
       2: idle timeout
       3: router shutdown
       4: data phase AEAD failure
       5: incompatible options
       6: incompatible signature type
       7: clock skew
       8: padding violation
       9: AEAD framing error
       10: payload format error
       11: message 1 error
       12: message 2 error
       13: message 3 error
       14: intra-frame read timeout
       15: RI signature verification fail
       16: s parameter missing, invalid, or mismatched in RouterInfo
       17: banned
addl data :: optional, 0 or more bytes, for future expansion, debugging,
             or reason text.
             Format unspecified and may vary based on reason code.
</code></pre><h4 id="notes-9">Notes</h4>
<p>Not all reasons may actually be used, implementation dependent.
Handshake failures will generally result in a close with TCP RST instead.
See notes in handshake message sections above.
Additional reasons listed are for consistency, logging, debugging, or if policy changes.</p>
<h3 id="padding">Padding</h3>
<p>This is for padding inside AEAD frames.
Padding for messages 1 and 2 are outside AEAD frames.
All padding for message 3 and the data phase are inside AEAD frames.</p>
<p>Padding inside AEAD should roughly adhere to the negotiated parameters.
Bob sent his requested tx/rx min/max parameters in message 2.
Alice sent her requested tx/rx min/max parameters in message 3.
Updated options may be sent during the data phase.
See options block information above.</p>
<p>If present, this must be the last block in the frame.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|254 |  size   |      padding           |
+----+----+----+                        +
|                                       |
~               .   .   .               ~
|                                       |
+----+----+----+----+----+----+----+----+

blk :: 254
size :: 2 bytes, big endian, size of padding to follow
padding :: random data
</code></pre><h4 id="notes-10">Notes</h4>
<ul>
<li>Padding strategies TBD.</li>
<li>Minimum padding TBD.</li>
<li>Padding-only frames are allowed.</li>
<li>Padding defaults TBD.</li>
<li>See options block for padding parameter negotiation</li>
<li>See options block for min/max padding parameters</li>
<li>Noise limits messages to 64KB. If more padding is necessary, send multiple frames.</li>
<li>Router response on violation of negotiated padding is implementation-dependent.</li>
</ul>
<h3 id="other-block-types">Other block types</h3>
<p>Implementations should ignore unknown block types for
forward compatibility, except in message 3 part 2, where
unknown blocks are not allowed.</p>
<h4 id="future-work-1">Future work</h4>
<ul>
<li>The padding length is either to be decided on a per-message basis and
estimates of the length distribution, or random delays should be added.
These countermeasures are to be included to resist DPI, as message sizes
would otherwise reveal that I2P traffic is being carried by the transport
protocol. The exact padding scheme is an area of future work, Appendix A
provides more information on the topic.</li>
</ul>
<h3 id="5-termination">5) Termination</h3>
<p>Connections may be terminated via normal or abnormal TCP socket close,
or, as Noise recommends, an explicit termination message.
The explicit termination message is defined in the data phase above.</p>
<p>Upon any normal or abnormal termination, routers should
zero-out any in-memory ephemeral data, including handshake ephemeral keys,
symmetric crypto keys, and related information.</p>
<h2 id="published-router-info">Published Router Info</h2>
<h3 id="published-addresses">Published Addresses</h3>
<p>The published RouterAddress (part of the RouterInfo) will have a
protocol identifier of either &ldquo;NTCP&rdquo; or &ldquo;NTCP2&rdquo;.</p>
<p>The RouterAddress must contain &ldquo;host&rdquo; and &ldquo;port&rdquo; options, as in
the current NTCP protocol.</p>
<p>The RouterAddress must contain three options
to indicate NTCP2 support:</p>
<ul>
<li>
<p>s=(Base64 key)
The current Noise static public key (s) for this RouterAddress.
Base 64 encoded using the standard I2P Base 64 alphabet.
32 bytes in binary, 44 bytes as Base 64 encoded,
little-endian X25519 public key.</p>
</li>
<li>
<p>i=(Base64 IV)
The current IV for encrypting the X value in message 1 for this RouterAddress.
Base 64 encoded using the standard I2P Base 64 alphabet.
16 bytes in binary, 24 bytes as Base 64 encoded,
big-endian.</p>
</li>
<li>
<p>v=2
The current version (2).
When published as &ldquo;NTCP&rdquo;, additional support for version 1 is implied.
Support for future versions will be with comma-separated values,
e.g. v=2,3
Implementation should verify compatibility, including multiple
versions if a comma is present. Comma-separated versions must
be in numerical order.</p>
</li>
</ul>
<p>Alice must verify that all three options are present and valid
before connecting using the NTCP2 protocol.</p>
<p>When published as &ldquo;NTCP&rdquo; with &ldquo;s&rdquo;, &ldquo;i&rdquo;, and &ldquo;v&rdquo; options,
the router must accept incoming connections on that host and port
for both NTCP and NTCP2 protocols, and automatically detect the protocol
version.</p>
<p>When published as &ldquo;NTCP2&rdquo; with &ldquo;s&rdquo;, &ldquo;i&rdquo;, and &ldquo;v&rdquo; options,
the router accepts incoming connections on that host and port
for the NTCP2 protocol only.</p>
<p>If a router supports both NTCP1 and NTCP2 connections but
does not implement automatic version detection for incoming connections,
it must advertise both &ldquo;NTCP&rdquo; and &ldquo;NTCP2&rdquo; addresses, and include
the NTCP2 options in the &ldquo;NTCP2&rdquo; address only.
The router should set a lower cost value (higher priority)
in the &ldquo;NTCP2&rdquo; address than the &ldquo;NTCP&rdquo; address, so NTCP2 is preferred.</p>
<p>If multiple NTCP2 RouterAddresses (either as &ldquo;NTCP&rdquo; or &ldquo;NTCP2&rdquo;) are published
in the same RouterInfo (for additional IP addresses or ports),
all addresses specifying the same port must contain the identical NTCP2 options and values.
In particular, all must contain the same static key and iv.</p>
<h3 id="unpublished-ntcp2-address">Unpublished NTCP2 Address</h3>
<p>If Alice does not publish her NTCP2 address (as &ldquo;NTCP&rdquo; or &ldquo;NTCP2&rdquo;) for incoming connections,
she must publish a &ldquo;NTCP2&rdquo; router address containing only her static key and NTCP2 version,
so that Bob may validate the key after receiving Alice&rsquo;s RouterInfo in message 3 part 2.</p>
<ul>
<li>
<p>s=(Base64 key)
As defined above for published addresses.</p>
</li>
<li>
<p>v=2
As defined above for published addresses.</p>
</li>
</ul>
<p>This router address will not contain &ldquo;i&rdquo;, &ldquo;host&rdquo; or &ldquo;port&rdquo; options,
as these are not required for outbound NTCP2 connections.
The published cost for this address does not strictly matter, as it is inbound only;
however, it may be helpful to other routers if the cost is set higher (lower priority)
than other addresses. The suggested value is 14.</p>
<p>Alice may also simply add the &ldquo;s&rdquo; and &ldquo;v&rdquo; options to an existing published &ldquo;NTCP&rdquo; address.</p>
<h3 id="public-key-and-iv-rotation">Public Key and IV Rotation</h3>
<p>Due to caching of RouterInfos, routers must not rotate the static public key or IV
while the router is up, whether in a published address or not. Routers must
persistently store this key and IV for reuse after an immediate restart, so incoming
connections will continue to work, and restart times are not exposed.  Routers
must persistently store, or otherwise determine, last-shutdown time, so that
the previous downtime may be calculated at startup.</p>
<p>Subject to concerns about exposing restart times, routers may rotate this key or IV
at startup if the router was previously down for some time (a couple hours at
least).</p>
<p>If the router has any published NTCP2 RouterAddresses (as NTCP or NTCP2), the
minimum downtime before rotation should be much longer, for example one month,
unless the local IP address has changed or the router &ldquo;rekeys&rdquo;.</p>
<p>If the router has any published SSU RouterAddresses, but not NTCP2 (as NTCP or
NTCP2) the minimum downtime before rotation should be longer, for example one
day, unless the local IP address has changed or the router &ldquo;rekeys&rdquo;.  This
applies even if the published SSU address has introducers.</p>
<p>If the router does not have any published RouterAddresses (NTCP, NTCP2, or
SSU), the minimum downtime before rotation may be as short as two hours, even
if the IP address changes, unless the router &ldquo;rekeys&rdquo;.</p>
<p>If the router &ldquo;rekeys&rdquo; to a different Router Hash, it should generate a new
noise key and IV as well.</p>
<p>Implementations must be aware that changing the static public key or IV will prohibit
incoming NTCP2 connections from routers that have cached an older RouterInfo.
RouterInfo publishing, tunnel peer selection (including both OBGW and IB
closest hop), zero-hop tunnel selection, transport selection, and other
implementation strategies must take this into account.</p>
<p>IV rotation is subject to identical rules as key rotation, except that IVs are not present
except in published RouterAddresses, so there is no IV for hidden or firewalled
routers. If anything changes (version, key, options?) it is recommended that
the IV change as well.</p>
<p>Note: The minimum downtime before rekeying may be modified to ensure network
health, and to prevent reseeding by a router down for a moderate amount of
time.</p>
<h3 id="identity-hiding">Identity Hiding</h3>
<p>Deniability is not a goal. See overview above.</p>
<p>Each pattern is assigned properties describing the confidentiality supplied to
the initiator&rsquo;s static public key, and to the responder&rsquo;s static public key.
The underlying assumptions are that ephemeral private keys are secure, and that
parties abort the handshake if they receive a static public key from the other
party which they don&rsquo;t trust.</p>
<p>This section only considers identity leakage through static public key fields
in handshakes.  Of course, the identities of Noise participants might be
exposed through other means, including payload fields, traffic analysis, or
metadata such as IP addresses.</p>
<p>Alice: (8) Encrypted with forward secrecy to an authenticated party.</p>
<p>Bob: (3) Not transmitted, but a passive attacker can check candidates for the
responder&rsquo;s private key and determine whether the candidate is correct.</p>
<p>Bob publishes his static public key in the netdb. Alice may or may not?</p>
<h4 id="issues-2">Issues</h4>
<ul>
<li>If Bob changes his static key, could fallback to a &ldquo;XX&rdquo; pattern?</li>
</ul>
<h2 id="version-detection">Version Detection</h2>
<p>When published as &ldquo;NTCP&rdquo;, the router must automatically detect the protocol
version for incoming connections.</p>
<p>This detection is implementation-dependent, but here is some general guidance.</p>
<p>To detect the version of an incoming NTCP connection, Bob proceeds as follows:</p>
<ul>
<li>
<p>Wait for at least 64 bytes (minimum NTCP2 message 1 size)</p>
</li>
<li>
<p>If the initial received data is 288 or more bytes, the incoming connection
is version 1.</p>
</li>
<li>
<p>If less than 288 bytes, either</p>
<ul>
<li>
<p>Wait for a short time for more data (good strategy before widespread NTCP2
adoption) if at least 288 total received, it&rsquo;s NTCP 1.</p>
</li>
<li>
<p>Try the first stages of decoding as version 2, if it fails, wait a short
time for more data (good strategy after widespread NTCP2 adoption)</p>
<ul>
<li>
<p>Decrypt the first 32 bytes (the X key)
of the SessionRequest packet using AES-256 with key RH_B.</p>
</li>
<li>
<p>Verify a valid point on the curve.
If it fails, wait a short time for more data for NTCP 1</p>
</li>
<li>
<p>Verify the AEAD frame.
If it fails, wait a short time for more data for NTCP 1</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Note that changes or additional strategies may be recommended if we detect
active TCP segmentation attacks on NTCP 1.</p>
<p>To facilitate rapid version detection and handshaking, implementations must
ensure that Alice buffers and then flushes the entire contents of the first
message at once, including the padding.
This increases the likelihood that the data will be contained in a single TCP
packet (unless segmented by the OS or middleboxes), and received all at once by
Bob.  This is also for efficiency and to ensure the effectiveness of the random
padding.
This applies to both NTCP and NTCP2 handshakes.</p>
<h2 id="variants-fallbacks-and-general-issues">Variants, Fallbacks, and General Issues</h2>
<ul>
<li>
<p>If Alice and Bob both support NTCP2, Alice should connect with NTCP2.</p>
</li>
<li>
<p>If Alice fails to connect to Bob using NTCP2 for any reason, the connection fails.
Alice may not retry using NTCP 1.</p>
</li>
<li>
<p>Fallback to XX pattern if Bob changes his keys? This would require a type
byte prepended?</p>
</li>
<li>
<p>&ldquo;Fall forward&rdquo; to KK pattern if Alice reconnects, assuming Bob still has her
static key?  This doesn&rsquo;t save any round trips and uses 4 DH rounds compared
to 3 for XK.  Probably not.</p>
</li>
</ul>
<pre tabindex="0"><code>  KK(s, rs):
    -&gt; s
    &lt;- s
    ...
    -&gt; e, es, ss
    &lt;- e, ee, se
</code></pre><h2 id="appendix-a-padding-scheme">Appendix A: Padding Scheme</h2>
<p>This section discusses an attack on typical padding schemes that allows
attackers to discover the probability distribution of the length of the
unpadded messages, by only observing the length of the padded messages. Let N
be a random variable describing the number of unpadded bytes, and P likewise
for the number of padding bytes. The total message size is then N + P.</p>
<p>Assume that for an unpadded size of n, at least <code>P_min(n) &gt;= 0</code> and at most
<code>P_max(n) &gt;= P_min(n)</code> bytes of padding are added in a padding scheme. The
obvious scheme uses padding of length P uniformly chosen at random:</p>
<pre tabindex="0"><code>Pr[P = p | N = n] = 1 / (P_max(n) - P_min(n)) if P_min(n) &lt;= p &lt;= P_max(n),
                    0                         otherwise.
</code></pre><p>A naive padding scheme would simply ensure that the size of the padded message
does not exceed N_max:</p>
<pre tabindex="0"><code>P_max(n) = N_max - n, n &lt;= N_max
P_min(n) = 0.
</code></pre><p>However, this leaks information about the unpadded length.</p>
<p>An attacker can easily estimate <code>Pr[x &lt;= N + P &lt;= y]</code>, for example by means
of a histogram.</p>
<ul>
<li>From this, he can also try to estimate <code>Pr[n_1 &lt;= N &lt;= n_2]</code>, indeed:</li>
</ul>
<pre tabindex="0"><code>Pr[N + P = m] = _n Pr[N = n] Pr[P = m - n | N = n].
</code></pre><p>In the naive scheme,</p>
<pre tabindex="0"><code>Pr[N + P = m] = _{n &lt;= m} Pr[N = n] / (N_max - n).
</code></pre><p>It&rsquo;s pretty obvious, as it was before doing the above calculation, that this
leaks information about <code>Pr[N = n]</code>: if the length of packets is almost
always more than m, then N + P &lt;= m will almost never be observed. This is not
the largest issue though, although being able to observe the minimum message
length can be considered to be a problem by itself.</p>
<p>A bigger issue is that it is possible to determine <code>Pr[N = n]</code> exactly:</p>
<pre tabindex="0"><code>Pr[N + P = m] - Pr[N + P = m-1] = Pr[N = m] / (N_max - m),
</code></pre><p>that is</p>
<pre tabindex="0"><code>Pr[N = n] = (N_max - n)(Pr[N + P = n] - Pr[N + P = n - 1])
</code></pre><p>To distinguish NTCP2, then, the attacker can use any of the following:</p>
<ul>
<li>
<p>Estimate <code>Pr[kB &lt;= N &lt;= (k + 1)B - 1]</code> for positive integers k. It will
always be zero for NTCP2.</p>
</li>
<li>
<p>Estimate <code>Pr[N = kB]</code> and compare with a standard I2P profile.</p>
</li>
</ul>
<p>This simple attack hence partially destroys the purpose of padding, which
attempts to obfuscate the size distribution of the unpadded messages. The
amount of messages that the attacker has to observe to distinguish the protocol
depends on the desired accuracy and on the minimum and maximum unpadded message
sizes that occur in practice. Note that it is easy to gather many messages for
the attacker, since he can use all traffic sent from and to the particular port
that the target is using.</p>
<p>In some forms (e.g. estimation of <code>Pr[kB &lt;= N &lt;= (k + 1)B - 1]</code>) the attack
requires only a few bytes of memory (one integer is enough) and it could be
argued that such an attack might be included in many slightly more advanced but
nevertheless standard DPI frameworks.</p>
<p>This proposal suggests using one of the following countermeasures:</p>
<ul>
<li>
<p>Develop an alternate padding scheme that takes into account the (estimated)
distribution of N by using a non-uniform padding length distribution. A good
padding scheme would probably require maintaining a histogram of the number
of blocks per message.</p>
</li>
<li>
<p>Add random delays between (randomly sized) fragments of messages.</p>
</li>
</ul>
<p>The second option is more generally preferred, because it can be simultaneously
used as a countermeasure against flow analysis. However, such delays may be out
of scope for the NTCP2 protocol, such that the first option, which is also
easier to implement, may be preferred instead.</p>
<h2 id="appendix-b-random-delays">Appendix B: Random Delays</h2>
<p>Timing-based DPI resistance (inter-message timing/delays can be
implementation-dependent; intra-message delays can be introduced at any
point, including before sending the random padding, for example). Artificial
delays (what obfs4 calls IAT or inter-arrival time) are independent of the
protocol itself.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://eprint.iacr.org/2015/1150">IACR-1150</a>
</li>
<li><a href="../../../en/docs/overview/network-database/">NetDB</a>
</li>
<li><a href="https://noiseprotocol.org/noise.html">NOISE</a>
</li>
<li><a href="../../../en/docs/ntcp/">NTCP</a>
</li>
<li><a href="../../../en/proposals/104-tls-transport/">Prop104</a>
</li>
<li><a href="../../../en/proposals/109-pt-transport/">Prop109</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc2104">RFC-2104</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc3526">RFC-3526</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc6151">RFC-6151</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc7539">RFC-7539</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc7748">RFC-7748</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc7905">RFC-7905</a>
</li>
<li><a href="../../../en/docs/specs/common-structures/#routeraddress">RouterAddress</a>
</li>
<li><a href="../../../en/docs/specs/common-structures/#routeridentity">RouterIdentity</a>
</li>
<li>[SIDH] De Feo, Luca; Jao, Plut., Towards quantum-resistant cryptosystems from supersingular elliptic curve isogenies</li>
<li><a href="../../../en/docs/specs/common-structures/#signingpublickey">SigningPublicKey</a>
</li>
<li><a href="https://www.131002.net/siphash/">SipHash</a>
</li>
<li><a href="../../../en/docs/specs/ntcp2/">SPEC</a>
</li>
<li><a href="../../../en/docs/specs/ssu2/">SSU</a>
</li>
<li>[STS] Diffie, W.; van Oorschot P. C.; Wiener M. J., Authentication and Authenticated Key Exchanges</li>
<li><a href="https://trac.i2p2.i2p/ticket/1112">Ticket1112</a>
</li>
<li><a href="https://trac.i2p2.i2p/ticket/1849">Ticket1849</a>
</li>
<li><a href="http://www.chesworkshop.org/ches2009/presentations/01_Session_1/CHES2009_ekasper.pdf">&ldquo;Faster and Timing-Attack Resistant AES-GCM&rdquo; by Emilia Ksper and Peter Schwabe</a>
</li>
<li><a href="https://www.blackhat.com/docs/us-16/materials/us-16-Devlin-Nonce-Disrespecting-Adversaries-Practical-Forgery-Attacks-On-GCM-In-TLS.pdf">&ldquo;Nonce-Disrespecting Adversaries: Practical Forgery Attacks on GCM in TLS&rdquo; by H. Bck, A. Zauner, S. Devlin, J. Somorovsky, P. Jovanovic</a>
</li>
<li><a href="https://eprint.iacr.org/2014/613.pdf">&ldquo;CAESAR submission: Ketje&rdquo; by Guido Bertoni, Joan Daemen, Michal Peeters, Gilles Van Assche, Ronny Van Keer</a>
</li>
<li><a href="https://www.imperialviolet.org/2013/10/07/chacha20.html">&ldquo;ChaCha20 and Poly1305 for IETF protocols&rdquo; by Adam Langley</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc7539">RFC 7539</a>
</li>
</ul>

                </article>

                
                <nav class="page-nav">
                    <a href="../../../en/proposals/" class="page-nav-link">
                         Back to Proposals
                    </a>
                    
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                    <a href="../../../proposals/111-ntcp-2.txt" class="page-nav-link" download>
                        Download Source (.txt)
                    </a>
                    
                </nav>
            </div>
        </div>
    </div>
</div>

<style>
.proposals-page {
    min-height: 100vh;
    padding: var(--spacing-xl) 0;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
}

.breadcrumbs a:hover {
    color: var(--color-primary);
}

.separator {
    color: var(--color-border);
}

.current {
    color: var(--color-text);
}

 
.translation-disclaimer {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.dark .translation-disclaimer {
    background: #78350f;
    border-color: #d97706;
}

.disclaimer-message {
    color: #92400e;
    font-size: 0.875rem;
}

.dark .disclaimer-message {
    color: #fde047;
}

.disclaimer-link {
    color: #92400e;
    font-weight: 600;
    text-decoration: underline;
    white-space: nowrap;
}

.dark .disclaimer-link {
    color: #fde047;
}

 
.proposal-header {
    margin-bottom: var(--spacing-2xl);
}

.proposal-title-section {
    margin-bottom: var(--spacing-lg);
}

.proposal-title {
    font-size: 2.5rem;
    margin: 0 0 var(--spacing-sm) 0;
    color: var(--color-text);
}

.proposal-number {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    font-weight: 600;
}

 
.proposal-meta-box {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
}

.proposal-status {
    display: inline-block;
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: var(--spacing-md);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

 
.status-open {
    background: #dbeafe;
    color: #0369a1;
}

.dark .status-open {
    background: #0c4a6e;
    color: #7dd3fc;
}

.status-accepted {
    background: #dbeafe;
    color: #0369a1;
}

.dark .status-accepted {
    background: #0c4a6e;
    color: #7dd3fc;
}

.status-finished {
    background: #dcfce7;
    color: #15803d;
}

.dark .status-finished {
    background: #164e63;
    color: #86efac;
}

.status-closed {
    background: #dcfce7;
    color: #15803d;
}

.dark .status-closed {
    background: #164e63;
    color: #86efac;
}

.status-rejected {
    background: #fee2e2;
    color: #991b1b;
}

.dark .status-rejected {
    background: #7f1d1d;
    color: #fca5a5;
}

.status-draft,
.status-needs-revision,
.status-dead,
.status-needs-research {
    background: #fef3c7;
    color: #92400e;
}

.dark .status-draft,
.dark .status-needs-revision,
.dark .status-dead,
.dark .status-needs-research {
    background: #78350f;
    color: #fde047;
}

.status-meta,
.status-informational,
.status-reserve {
    background: #e9d5ff;
    color: #6b21a8;
}

.dark .status-meta,
.dark .status-informational,
.dark .status-reserve {
    background: #581c87;
    color: #e879f9;
}

 
.proposal-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.info-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
}

.info-value {
    font-size: 0.9375rem;
    color: var(--color-text);
    font-weight: 500;
}

 
.proposal-relationships {
    border-top: 1px solid var(--color-border);
    padding-top: var(--spacing-md);
}

.relationship {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
}

.relationship:last-child {
    margin-bottom: 0;
}

.relationship-label {
    font-weight: 600;
    color: var(--color-text-muted);
    min-width: 120px;
}

.relationship-value {
    color: var(--color-text);
}

 
.proposal-layout {
    display: block;
}

.proposal-layout--with-toc {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

 
.proposal-toc-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.toc-nav {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
}

.toc-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-text);
    padding-bottom: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.toc-content {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
}

.toc-content::-webkit-scrollbar {
    width: 4px;
}

.toc-content::-webkit-scrollbar-track {
    background: transparent;
}

.toc-content::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
}

.toc-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

.toc-nav ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc-nav li {
    margin-bottom: 0.25rem;
}

.toc-nav ul ul {
    padding-left: var(--spacing-md);
    margin-top: 0.25rem;
}

.toc-nav a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.8125rem;
    display: block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    line-height: 1.4;
}

.toc-nav a:hover {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
}

 
.proposal-main {
    min-width: 0;
}

 
.proposal-content {
    line-height: 1.8;
    color: var(--color-text);
    max-width: 900px;
}

.proposal-content h2 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.75rem;
    scroll-margin-top: 100px;
}

.proposal-content h3 {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.375rem;
    scroll-margin-top: 100px;
}

.proposal-content h4 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-xs);
    font-size: 1.125rem;
    scroll-margin-top: 100px;
}

.proposal-content p {
    margin-bottom: var(--spacing-md);
}

.proposal-content ul,
.proposal-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.proposal-content li {
    margin-bottom: var(--spacing-xs);
}

.proposal-content code {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
}

.proposal-content pre {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: var(--spacing-md);
    font-size: 0.875rem;
}

.proposal-content pre code {
    background: none;
    padding: 0;
}

.proposal-content blockquote {
    border-left: 4px solid var(--color-primary);
    padding-left: var(--spacing-md);
    margin-left: 0;
    margin-bottom: var(--spacing-md);
    font-style: italic;
    color: var(--color-text-secondary);
}

.proposal-content a {
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
}

.proposal-content a:hover {
    border-bottom-color: var(--color-primary);
}

.proposal-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: var(--spacing-md);
}

.proposal-content table th {
    background: var(--color-bg-secondary);
    padding: var(--spacing-sm);
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--color-border);
}

.proposal-content table td {
    padding: var(--spacing-sm);
    border-bottom: 1px solid var(--color-border);
}

.proposal-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin: var(--spacing-lg) 0;
    display: block;
}

 
.page-nav {
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.page-nav-link {
    display: inline-block;
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.page-nav-link:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
}

 
@media (max-width: 1024px) {
    .proposal-layout--with-toc {
        grid-template-columns: 1fr;
    }

    .proposal-toc-sidebar {
        position: static;
        max-height: none;
        margin-bottom: var(--spacing-xl);
    }

    .toc-content {
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .proposal-title {
        font-size: 1.75rem;
    }

    .proposal-info-grid {
        grid-template-columns: 1fr;
    }
}
</style>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = [];

    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const heading = document.getElementById(href.slice(1));
            if (heading) {
                headings.push({ element: heading, link: link });
            }
        }
    });

    function updateActiveLink() {
        const scrollPos = window.scrollY + 120;
        let activeIndex = 0;

        for (let i = 0; i < headings.length; i++) {
            if (headings[i].element.offsetTop <= scrollPos) {
                activeIndex = i;
            }
        }

        tocLinks.forEach(link => link.classList.remove('active'));
        if (headings[activeIndex]) {
            headings[activeIndex].link.classList.add('active');
        }
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});
</script>
<style>
.toc-nav a.active {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
    font-weight: 600;
}
</style>



    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">Stay updated with I2P news:</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="Enter your email" required>
                            <button type="submit">Subscribe</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="../../../en/financial-support/">Donate</a></li>
                    <li><a href="../../../en/docs/overview/intro/">I2P Introduction</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Community</h3>
                <ul>
                    <li><a href="../../../en/get-involved/">Get Involved</a></li>
                    <li><a href="../../../en/blog/">Blog</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">Official Forums</a></li>
                    <li><a href="../../../en/contact/">Contact</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Resources</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">I2P Metrics</a></li>
                    <li><a href="../../../en/papers/">Research</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">StormyCloud</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 The Invisible Internet Project. Licensed under Creative Commons.</p>
            <div class="footer-links">
                <a href="../../../en/privacy/">Privacy</a>
                <a href="../../../en/terms/">Terms</a>
                <a href="../../../en/about/media/">Press</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>Community Poll</h2>
            <p class="modal-subtitle">We&#39;d love to hear from you</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                Your vote helps shape the future of I2P.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
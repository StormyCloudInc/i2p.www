<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Garlic Farm Protocol | I2P - The Invisible Internet Project</title>

    <meta name="description" content="The Invisible Internet Project - A privacy-focused, anonymous network layer">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="Garlic Farm Protocol | I2P - The Invisible Internet Project">
    <meta property="og:description" content="The Invisible Internet Project - A privacy-focused, anonymous network layer">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/en/proposals/150-garlic-farm-protocol/">

    
    <link rel="icon" type="image/svg+xml" href="../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">I2P Beta Site Now Live E-Mail issues to stormycloud@mail.i2p</span>
            
        </div>
        
        <form method="GET" action="../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="Close banner" title="Close banner">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../en/" class="logo-link">
                    <img src="../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../en/about/" class="">About</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../en/about/">Overview</a></li>
                            <li><a href="../../../en/papers/">Research Papers</a></li>
                            <li><a href="../../../en/about/media/">Press</a></li>
                            <li><a href="../../../en/contact/">Contact Us</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../en/docs/" class="">Docs</a></li>
                    <li><a href="../../../en/downloads/" class="">Downloads</a></li>
                    <li><a href="../../../en/blog/" class="">Blog</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../en/get-involved/" class="">Get Involved</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../en/get-involved/">Overview</a></li>
                            <li><a href="../../../en/feedback/">Feature Suggestions</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">en</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../en/proposals/150-garlic-farm-protocol/"
                                class="lang-option active">English</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../es/proposals/150-garlic-farm-protocol/"
                                class="lang-option">Spanish</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ko/proposals/150-garlic-farm-protocol/"
                                class="lang-option">Korean</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../zh/proposals/150-garlic-farm-protocol/"
                                class="lang-option">Chinese</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ru/proposals/150-garlic-farm-protocol/"
                                class="lang-option">Russian</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../cs/proposals/150-garlic-farm-protocol/"
                                class="lang-option">Czech</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../de/proposals/150-garlic-farm-protocol/"
                                class="lang-option">German</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../fr/proposals/150-garlic-farm-protocol/"
                                class="lang-option">French</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../tr/proposals/150-garlic-farm-protocol/"
                                class="lang-option">Turkish</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../vi/proposals/150-garlic-farm-protocol/"
                                class="lang-option">Vietnamese</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../hi/proposals/150-garlic-farm-protocol/"
                                class="lang-option">Hindi</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ar/proposals/150-garlic-farm-protocol/"
                                class="lang-option">Arabic</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../pt/proposals/150-garlic-farm-protocol/"
                                class="lang-option">Portuguese</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../en/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../en/downloads/" class="btn btn-primary">Get I2P</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        



<div class="proposals-page">
    <div class="container">
        
        <nav class="breadcrumbs">
            <a href="../../../en/">Home</a>
            <span class="separator">/</span>
            <a href="../../../en/proposals/">Proposals</a>
            <span class="separator">/</span>
            <span class="current">Garlic Farm Protocol</span>
        </nav>

        


        
        <header class="proposal-header">
            <div class="proposal-title-section">
                <h1 class="proposal-title">Garlic Farm Protocol</h1>
                <div class="proposal-number">Proposal 150</div>
            </div>

            
            <div class="proposal-meta-box">
                <div class="proposal-status status-open">
                    Open
                </div>

                
                <div class="proposal-info-grid">
                    
                    <div class="info-item">
                        <span class="info-label">Author</span>
                        <span class="info-value">zzz</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Created</span>
                        <span class="info-value">2019-05-02</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Last Updated</span>
                        <span class="info-value">2019-05-20</span>
                    </div>
                    

                    

                    
                </div>

                
                
            </div>
        </header>

        
        <div class="proposal-layout proposal-layout--with-toc">
            
            
            <aside class="proposal-toc-sidebar">
                <nav class="toc-nav">
                    <div class="toc-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        On This Page
                    </div>
                    <div class="toc-content">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#goals">Goals</a></li>
    <li><a href="#design">Design</a></li>
    <li><a href="#specification">Specification</a>
      <ul>
        <li><a href="#handshake-and-authentication">Handshake and authentication</a></li>
        <li><a href="#message-types">Message Types</a></li>
        <li><a href="#establishment">Establishment</a></li>
        <li><a href="#definitions">Definitions</a></li>
        <li><a href="#requests">Requests</a></li>
        <li><a href="#responses">Responses</a></li>
      </ul>
    </li>
    <li><a href="#application-layer">Application Layer</a>
      <ul>
        <li><a href="#application-data-contents">Application Data Contents</a></li>
      </ul>
    </li>
    <li><a href="#administration-interface">Administration Interface</a></li>
    <li><a href="#router-interface">Router Interface</a></li>
    <li><a href="#justification">Justification</a></li>
    <li><a href="#notes-2">Notes</a></li>
    <li><a href="#issues">Issues</a></li>
    <li><a href="#migration">Migration</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
                    </div>
                </nav>
            </aside>
            

            
            <div class="proposal-main">
                <article class="proposal-content">
                    <h2 id="overview">Overview</h2>
<p>This is the spec for the Garlic Farm wire protocol,
based on JRaft, its &ldquo;exts&rdquo; code for implementation over TCP,
and its &ldquo;dmprinter&rdquo; sample application <a href="https://github.com/datatechnology/jraft">JRAFT</a>
.</p>
<p>We were unable to find any implementation with a documented wire protocol.
However, the JRaft implementation is simple enough that we could
inspect the code and then document its protocol.
This proposal is the result of that effort.</p>
<p>This will be the backend for coordination of routers publishing
entries in a Meta LeaseSet. See proposal 123.</p>
<h2 id="goals">Goals</h2>
<ul>
<li>Small code size</li>
<li>Based on existing implementation</li>
<li>No serialized Java objects or any Java-specific features or encoding</li>
<li>Any bootstrapping is out-of-scope. At least one other server is assumed
to be hardcoded, or configured out-of-band of this protocol.</li>
<li>Support both out-of-band and in-I2P use cases.</li>
</ul>
<h2 id="design">Design</h2>
<p>The Raft protocol is not a concrete protocol; it defines only a state machine.
Therefore we document the concrete protocol of JRaft and base our protocol on it.
There are no changes to the JRaft protocol other than the addition of
an authentication handshake.</p>
<p>Raft elects a Leader whose job is to publish a log.
The log contains Raft Configuration data and Application data.
Application data contains the status of each Server&rsquo;s Router and the Destination
for the Meta LS2 cluster.
The servers use a common algorithm to determine the publisher and contents
of the Meta LS2.
The publisher of the Meta LS2 is NOT necessarily the Raft Leader.</p>
<h2 id="specification">Specification</h2>
<p>The wire protocol is over SSL sockets or non-SSL I2P sockets.
I2P sockets are proxied through the HTTP Proxy.
There is no support for clearnet non-SSL sockets.</p>
<h3 id="handshake-and-authentication">Handshake and authentication</h3>
<p>Not defined by JRaft.</p>
<p>Goals:</p>
<ul>
<li>User/password authentication method</li>
<li>Version identifier</li>
<li>Cluster identifier</li>
<li>Extensible</li>
<li>Ease of proxying when used for I2P sockets</li>
<li>Do not unnecessarily expose server as a Garlic Farm server</li>
<li>Simple protocol so a full web server implementation is not required</li>
<li>Compatible with common standards, so implementations may use
standard libraries if desired</li>
</ul>
<p>We will use an websocket-like handshake and
HTTP Digest authentication <a href="https://tools.ietf.org/html/rfc2617">RFC 2617</a>
.
RFC 2617 Basic authentication is NOT supported.
When proxying through the HTTP proxy, communicate with
the proxy as specified in <a href="https://tools.ietf.org/html/rfc2616">RFC 2616</a>
.</p>
<h4 id="credentials">Credentials</h4>
<p>Whether usernames and passwords are per-cluster, or
per-server, is implementation-dependent.</p>
<h4 id="http-request-1">HTTP Request 1</h4>
<p>The originator will send the following.</p>
<p>All lines are teriminated with CRLF as required by HTTP.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>GET /GarlicFarm/CLUSTER/VERSION/websocket HTTP/1.1
</span></span><span style="display:flex;"><span>  Host: (ip):(port)
</span></span><span style="display:flex;"><span>  Cache-Control: no-cache
</span></span><span style="display:flex;"><span>  Connection: close
</span></span><span style="display:flex;"><span>  (any other headers ignored)
</span></span><span style="display:flex;"><span>  (blank line)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  CLUSTER is the name of the cluster (default &#34;farm&#34;)
</span></span><span style="display:flex;"><span>  VERSION is the Garlic Farm version (currently &#34;1&#34;)
</span></span></code></pre></div><h4 id="http-response-1">HTTP Response 1</h4>
<p>If the path is not correct, the recipient will send a standard &ldquo;HTTP/1.1 404 Not Found&rdquo; response,
as in <a href="https://tools.ietf.org/html/rfc2616">RFC 2616</a>
.</p>
<p>If the path is correct, the recipient will send a standard &ldquo;HTTP/1.1 401 Unauthorized&rdquo; response,
including the WWW-Authenticate HTTP digest authentication header,
as in <a href="https://tools.ietf.org/html/rfc2617">RFC 2617</a>
.</p>
<p>Both parties will then close the socket.</p>
<h4 id="http-request-2">HTTP Request 2</h4>
<p>The originator will send the following,
as in <a href="https://tools.ietf.org/html/rfc2617">RFC 2617</a>
.</p>
<p>All lines are teriminated with CRLF as required by HTTP.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>GET /GarlicFarm/CLUSTER/VERSION/websocket HTTP/1.1
</span></span><span style="display:flex;"><span>  Host: (ip):(port)
</span></span><span style="display:flex;"><span>  Cache-Control: no-cache
</span></span><span style="display:flex;"><span>  Connection: keep-alive, Upgrade
</span></span><span style="display:flex;"><span>  Upgrade: websocket
</span></span><span style="display:flex;"><span>  (Sec-Websocket-* headers if proxied)
</span></span><span style="display:flex;"><span>  Authorization: (HTTP digest authorization header as in RFC 2617)
</span></span><span style="display:flex;"><span>  (any other headers ignored)
</span></span><span style="display:flex;"><span>  (blank line)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  CLUSTER is the name of the cluster (default &#34;farm&#34;)
</span></span><span style="display:flex;"><span>  VERSION is the Garlic Farm version (currently &#34;1&#34;)
</span></span></code></pre></div><h4 id="http-response-2">HTTP Response 2</h4>
<p>If the authentication is not correct, the recipient will send another standard &ldquo;HTTP/1.1 401 Unauthorized&rdquo; response,
as in <a href="https://tools.ietf.org/html/rfc2617">RFC 2617</a>
.</p>
<p>If the authentication is correct, the recipient will send the following response,
as in the WebSocket protocol.</p>
<p>All lines are teriminated with CRLF as required by HTTP.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HTTP/1.1 101 Switching Protocols
</span></span><span style="display:flex;"><span>  Connection: Upgrade
</span></span><span style="display:flex;"><span>  Upgrade: websocket
</span></span><span style="display:flex;"><span>  (Sec-Websocket-* headers)
</span></span><span style="display:flex;"><span>  (any other headers ignored)
</span></span><span style="display:flex;"><span>  (blank line)
</span></span></code></pre></div><p>After this is received, the socket remains open.
The Raft protocol as defined below commences, on the same socket.</p>
<h4 id="caching">Caching</h4>
<p>Credentials shall be cached for at least one hour, so that
subsequent connections may jump directly to
&ldquo;HTTP Request 2&rdquo; above.</p>
<h3 id="message-types">Message Types</h3>
<p>There are two types of messages, requests and responses.
Requests may contain Log Entries, and are variable-sized;
responses do not contain Log Entries, and are fixed-size.</p>
<p>Message types 1-4 are the standard RPC messages defined by Raft.
This is the core Raft protocol.</p>
<p>Message types 5-15 are the extended RPC messages defined by
JRaft, to support clients, dynamic server changes, and
efficient log synchronization.</p>
<p>Message types 16-17 are the Log Compaction RPC messages defined
in Raft section 7.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Message</th>
          <th style="text-align: left">Number</th>
          <th style="text-align: left">Sent By</th>
          <th style="text-align: left">Sent To</th>
          <th style="text-align: left">Notes</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">RequestVoteRequest</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">Candidate</td>
          <td style="text-align: left">Follower</td>
          <td style="text-align: left">Standard Raft RPC; must not contain log entries</td>
      </tr>
      <tr>
          <td style="text-align: left">RequestVoteResponse</td>
          <td style="text-align: left">2</td>
          <td style="text-align: left">Follower</td>
          <td style="text-align: left">Candidate</td>
          <td style="text-align: left">Standard Raft RPC</td>
      </tr>
      <tr>
          <td style="text-align: left">AppendEntriesRequest</td>
          <td style="text-align: left">3</td>
          <td style="text-align: left">Leader</td>
          <td style="text-align: left">Follower</td>
          <td style="text-align: left">Standard Raft RPC</td>
      </tr>
      <tr>
          <td style="text-align: left">AppendEntriesResponse</td>
          <td style="text-align: left">4</td>
          <td style="text-align: left">Follower</td>
          <td style="text-align: left">Leader / Client</td>
          <td style="text-align: left">Standard Raft RPC</td>
      </tr>
      <tr>
          <td style="text-align: left">ClientRequest</td>
          <td style="text-align: left">5</td>
          <td style="text-align: left">Client</td>
          <td style="text-align: left">Leader / Follower</td>
          <td style="text-align: left">Response is AppendEntriesResponse; must contain Application log entries only</td>
      </tr>
      <tr>
          <td style="text-align: left">AddServerRequest</td>
          <td style="text-align: left">6</td>
          <td style="text-align: left">Client</td>
          <td style="text-align: left">Leader</td>
          <td style="text-align: left">Must contain a single ClusterServer log entry only</td>
      </tr>
      <tr>
          <td style="text-align: left">AddServerResponse</td>
          <td style="text-align: left">7</td>
          <td style="text-align: left">Leader</td>
          <td style="text-align: left">Client</td>
          <td style="text-align: left">Leader will also send a JoinClusterRequest</td>
      </tr>
      <tr>
          <td style="text-align: left">RemoveServerRequest</td>
          <td style="text-align: left">8</td>
          <td style="text-align: left">Follower</td>
          <td style="text-align: left">Leader</td>
          <td style="text-align: left">Must contain a single ClusterServer log entry only</td>
      </tr>
      <tr>
          <td style="text-align: left">RemoveServerResponse</td>
          <td style="text-align: left">9</td>
          <td style="text-align: left">Leader</td>
          <td style="text-align: left">Follower</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">SyncLogRequest</td>
          <td style="text-align: left">10</td>
          <td style="text-align: left">Leader</td>
          <td style="text-align: left">Follower</td>
          <td style="text-align: left">Must contain a single LogPack log entry only</td>
      </tr>
      <tr>
          <td style="text-align: left">SyncLogResponse</td>
          <td style="text-align: left">11</td>
          <td style="text-align: left">Follower</td>
          <td style="text-align: left">Leader</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">JoinClusterRequest</td>
          <td style="text-align: left">12</td>
          <td style="text-align: left">Leader</td>
          <td style="text-align: left">New Server</td>
          <td style="text-align: left">Invitation to join; must contain a single Configuration log entry only</td>
      </tr>
      <tr>
          <td style="text-align: left">JoinClusterResponse</td>
          <td style="text-align: left">13</td>
          <td style="text-align: left">New Server</td>
          <td style="text-align: left">Leader</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">LeaveClusterRequest</td>
          <td style="text-align: left">14</td>
          <td style="text-align: left">Leader</td>
          <td style="text-align: left">Follower</td>
          <td style="text-align: left">Command to leave</td>
      </tr>
      <tr>
          <td style="text-align: left">LeaveClusterResponse</td>
          <td style="text-align: left">15</td>
          <td style="text-align: left">Follower</td>
          <td style="text-align: left">Leader</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">InstallSnapshotRequest</td>
          <td style="text-align: left">16</td>
          <td style="text-align: left">Leader</td>
          <td style="text-align: left">Follower</td>
          <td style="text-align: left">Raft Section 7; Must contain a single SnapshotSyncRequest log entry only</td>
      </tr>
      <tr>
          <td style="text-align: left">InstallSnapshotResponse</td>
          <td style="text-align: left">17</td>
          <td style="text-align: left">Follower</td>
          <td style="text-align: left">Leader</td>
          <td style="text-align: left">Raft Section 7</td>
      </tr>
  </tbody>
</table>
<h3 id="establishment">Establishment</h3>
<p>After the HTTP handshake, the establishment sequence is as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>New Server Alice              Random Follower Bob
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ClientRequest   -------&gt;
</span></span><span style="display:flex;"><span>          &lt;---------   AppendEntriesResponse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  If Bob says he is the leader, continue as below.
</span></span><span style="display:flex;"><span>  Else, Alice must disconnect from Bob and connect to the leader.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  New Server Alice              Leader Charlie
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ClientRequest   -------&gt;
</span></span><span style="display:flex;"><span>          &lt;---------   AppendEntriesResponse
</span></span><span style="display:flex;"><span>  AddServerRequest   -------&gt;
</span></span><span style="display:flex;"><span>          &lt;---------   AddServerResponse
</span></span><span style="display:flex;"><span>          &lt;---------   JoinClusterRequest
</span></span><span style="display:flex;"><span>  JoinClusterResponse  -------&gt;
</span></span><span style="display:flex;"><span>          &lt;---------   SyncLogRequest
</span></span><span style="display:flex;"><span>                       OR InstallSnapshotRequest
</span></span><span style="display:flex;"><span>  SyncLogResponse  -------&gt;
</span></span><span style="display:flex;"><span>  OR InstallSnapshotResponse
</span></span></code></pre></div><p>Disconnect Sequence:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Follower Alice              Leader Charlie
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  RemoveServerRequest   -------&gt;
</span></span><span style="display:flex;"><span>          &lt;---------   RemoveServerResponse
</span></span><span style="display:flex;"><span>          &lt;---------   LeaveClusterRequest
</span></span><span style="display:flex;"><span>  LeaveClusterResponse  -------&gt;
</span></span></code></pre></div><p>Election Sequence:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Candidate Alice               Follower Bob
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  RequestVoteRequest   -------&gt;
</span></span><span style="display:flex;"><span>          &lt;---------   RequestVoteResponse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  if Alice wins election:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Leader Alice                Follower Bob
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  AppendEntriesRequest   -------&gt;
</span></span><span style="display:flex;"><span>  (heartbeat)
</span></span><span style="display:flex;"><span>          &lt;---------   AppendEntriesResponse
</span></span></code></pre></div><h3 id="definitions">Definitions</h3>
<ul>
<li>Source: Identifies the originator of the message</li>
<li>Destination: Identifies the recipient of the message</li>
<li>Terms: See Raft. Initialized to 0, increases monotonically</li>
<li>Indexes: See Raft. Initialized to 0, increases monotonically</li>
</ul>
<h3 id="requests">Requests</h3>
<p>Requests contain a header and zero or more log entries.
Requests contain a fixed-size header and optional Log Entries of variable size.</p>
<h4 id="request-header">Request Header</h4>
<p>The request header is 45 bytes, as follows.
All values are unsigned big-endian.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Message type:      1 byte
</span></span><span style="display:flex;"><span>  Source:            ID, 4 byte integer
</span></span><span style="display:flex;"><span>  Destination:       ID, 4 byte integer
</span></span><span style="display:flex;"><span>  Term:              Current term (see notes), 8 byte integer
</span></span><span style="display:flex;"><span>  Last Log Term:     8 byte integer
</span></span><span style="display:flex;"><span>  Last Log Index:    8 byte integer
</span></span><span style="display:flex;"><span>  Commit Index:      8 byte integer
</span></span><span style="display:flex;"><span>  Log entries size:  Total size in bytes, 4 byte integer
</span></span><span style="display:flex;"><span>  Log entries:       see below, total length as specified
</span></span></code></pre></div><h4 id="notes">Notes</h4>
<p>In the RequestVoteRequest, Term is the candidate&rsquo;s term.
Otherwise, it is the leader&rsquo;s current term.</p>
<p>In the AppendEntriesRequest, when the log entries size is zero,
this message is a heartbeat (keepalive) message.</p>
<h4 id="log-entries">Log Entries</h4>
<p>The log contains zero or more log entries.
Each log entry is as follows.
All values are unsigned big-endian.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Term:           8 byte integer
</span></span><span style="display:flex;"><span>  Value type:     1 byte
</span></span><span style="display:flex;"><span>  Entry size:     In bytes, 4 byte integer
</span></span><span style="display:flex;"><span>  Entry:          length as specified
</span></span></code></pre></div><h4 id="log-contents">Log Contents</h4>
<p>All values are unsigned big-endian.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Log Value Type</th>
          <th style="text-align: left">Number</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Application</td>
          <td style="text-align: left">1</td>
      </tr>
      <tr>
          <td style="text-align: left">Configuration</td>
          <td style="text-align: left">2</td>
      </tr>
      <tr>
          <td style="text-align: left">ClusterServer</td>
          <td style="text-align: left">3</td>
      </tr>
      <tr>
          <td style="text-align: left">LogPack</td>
          <td style="text-align: left">4</td>
      </tr>
      <tr>
          <td style="text-align: left">SnapshotSyncRequest</td>
          <td style="text-align: left">5</td>
      </tr>
  </tbody>
</table>
<h4 id="application">Application</h4>
<p>Application contents are UTF-8 encoded <a href="https://www.json.org/">JSON</a>
.
See the Application Layer section below.</p>
<h4 id="configuration">Configuration</h4>
<p>This is used for the leader to serialize a new cluster configuration and replicate to peers.
It contains zero or more ClusterServer configurations.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Log Index:  8 byte integer
</span></span><span style="display:flex;"><span>  Last Log Index:  8 byte integer
</span></span><span style="display:flex;"><span>  ClusterServer Data for each server:
</span></span><span style="display:flex;"><span>    ID:                4 byte integer
</span></span><span style="display:flex;"><span>    Endpoint data len: In bytes, 4 byte integer
</span></span><span style="display:flex;"><span>    Endpoint data:     ASCII string of the form &#34;tcp://localhost:9001&#34;, length as specified
</span></span></code></pre></div><h4 id="clusterserver">ClusterServer</h4>
<p>The configuration information for a server in a cluster.
This is included only in a AddServerRequest or RemoveServerRequest message.</p>
<p>When used in a AddServerRequest Message:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ID:                4 byte integer
</span></span><span style="display:flex;"><span>  Endpoint data len: In bytes, 4 byte integer
</span></span><span style="display:flex;"><span>  Endpoint data:     ASCII string of the form &#34;tcp://localhost:9001&#34;, length as specified
</span></span></code></pre></div><p>When used in a RemoveServerRequest Message:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ID:                4 byte integer
</span></span></code></pre></div><h4 id="logpack">LogPack</h4>
<p>This is included only in a SyncLogRequest message.</p>
<p>The following is gzipped before transmission:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Index data len: In bytes, 4 byte integer
</span></span><span style="display:flex;"><span>  Log data len:   In bytes, 4 byte integer
</span></span><span style="display:flex;"><span>  Index data:     8 bytes for each index, length as specified
</span></span><span style="display:flex;"><span>  Log data:       length as specified
</span></span></code></pre></div><h4 id="snapshotsyncrequest">SnapshotSyncRequest</h4>
<p>This is included only in a InstallSnapshotRequest message.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Last Log Index:  8 byte integer
</span></span><span style="display:flex;"><span>  Last Log Term:   8 byte integer
</span></span><span style="display:flex;"><span>  Config data len: In bytes, 4 byte integer
</span></span><span style="display:flex;"><span>  Config data:     length as specified
</span></span><span style="display:flex;"><span>  Offset:          The offset of the data in the database, in bytes, 8 byte integer
</span></span><span style="display:flex;"><span>  Data len:        In bytes, 4 byte integer
</span></span><span style="display:flex;"><span>  Data:            length as specified
</span></span><span style="display:flex;"><span>  Is Done:         1 if done, 0 if not done (1 byte)
</span></span></code></pre></div><h3 id="responses">Responses</h3>
<p>All responses are 26 bytes, as follows.
All values are unsigned big-endian.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Message type:   1 byte
</span></span><span style="display:flex;"><span>  Source:         ID, 4 byte integer
</span></span><span style="display:flex;"><span>  Destination:    Usually the actual destination ID (see notes), 4 byte integer
</span></span><span style="display:flex;"><span>  Term:           Current term, 8 byte integer
</span></span><span style="display:flex;"><span>  Next Index:     Initialized to leader last log index + 1, 8 byte integer
</span></span><span style="display:flex;"><span>  Is Accepted:    1 if accepted, 0 if not accepted (see notes), 1 byte
</span></span></code></pre></div><h4 id="notes-1">Notes</h4>
<p>The Destination ID is usually the actual destination for this message.
However, for AppendEntriesResponse, AddServerResponse, and RemoveServerResponse,
it is the ID of the current leader.</p>
<p>In the RequestVoteResponse, Is Accepted is 1 for a vote for the candidate (requestor),
and 0 for no vote.</p>
<h2 id="application-layer">Application Layer</h2>
<p>Each Server periodically posts Application data to the log in a ClientRequest.
Application data contains the status of each Server&rsquo;s Router and the Destination
for the Meta LS2 cluster.
The servers use a common algorithm to determine the publisher and contents
of the Meta LS2.
The server with the &ldquo;best&rdquo; recent status in the log is the Meta LS2 publisher.
The publisher of the Meta LS2 is NOT necessarily the Raft Leader.</p>
<h3 id="application-data-contents">Application Data Contents</h3>
<p>Application contents are UTF-8 encoded <a href="https://json.org/">JSON</a>
,
for simplicity and extensibility.
The full specification is TBD.
The goal is to provide enough data to write an algorithm to determine the &ldquo;best&rdquo;
router to publish the Meta LS2, and for the publisher to have sufficient information
to weight the Destinations in the Meta LS2.
The data will contain both router and Destination statistics.</p>
<p>The data may optionally contain remote sensing data on the health of the
other servers, and the ability to fetch the Meta LS.
These data would not be supported in the first release.</p>
<p>The data may optionally contain configuration information posted
by an administrator client.
These data would not be supported in the first release.</p>
<p>If &ldquo;name: value&rdquo; is listed, that specifies the JSON map key and value.
Otherwise, specification is TBD.</p>
<p>Cluster data (top level):</p>
<ul>
<li>cluster: Cluster name</li>
<li>date: Date of this data (long, ms since the epoch)</li>
<li>id: Raft ID (integer)</li>
</ul>
<p>Configuration data (config):</p>
<ul>
<li>Any configuration parameters</li>
</ul>
<p>MetaLS publishing status (meta):</p>
<ul>
<li>destination: the metals destination, base64</li>
<li>lastPublishedLS: if present, base64 encoding of the last published metals</li>
<li>lastPublishedTime: in ms, or 0 if never</li>
<li>publishConfig: Publisher config status off/on/auto</li>
<li>publishing: metals publisher status boolean true/false</li>
</ul>
<p>Router data (router):</p>
<ul>
<li>lastPublishedRI: if present, base64 encoding of the last published router info</li>
<li>uptime: Uptime in ms</li>
<li>Job lag</li>
<li>Exploratory tunnels</li>
<li>Participating tunnels</li>
<li>Configured bandwidth</li>
<li>Current bandwidth</li>
</ul>
<p>Destinations (destinations):
List</p>
<p>Destination data:</p>
<ul>
<li>destination: the destination, base64</li>
<li>uptime: Uptime in ms</li>
<li>Configured tunnels</li>
<li>Current tunnels</li>
<li>Configured bandwidth</li>
<li>Current bandwidth</li>
<li>Configured connections</li>
<li>Current connections</li>
<li>Blacklist data</li>
</ul>
<p>Remote router sensing data:</p>
<ul>
<li>Last RI version seen</li>
<li>LS Fetch time</li>
<li>Connection test data</li>
<li>Closest floodfills profile data
for time periods yesterday, today, and tomorrow</li>
</ul>
<p>Remote destination sensing data:</p>
<ul>
<li>Last LS version seen</li>
<li>LS Fetch time</li>
<li>Connection test data</li>
<li>Closest floodfills profile data
for time periods yesterday, today, and tomorrow</li>
</ul>
<p>Meta LS sensing data:</p>
<ul>
<li>Last version seen</li>
<li>Fetch time</li>
<li>Closest floodfills profile data
for time periods yesterday, today, and tomorrow</li>
</ul>
<h2 id="administration-interface">Administration Interface</h2>
<p>TBD, possibly a separate proposal.
Not required for the first release.</p>
<p>Requirements of an admin interface:</p>
<ul>
<li>Support for multiple master destinations, i.e. multiple virtual clusters (farms)</li>
<li>Provide comprehensive view of shared cluster state - all stats published by members, who is the current leader, etc.</li>
<li>Ability to force removal of a participant or leader from the cluster</li>
<li>Ability to force publish metaLS (if current node is publisher)</li>
<li>Ability to exclude hashes from metaLS (if current node is publisher)</li>
<li>Configuration import/export functionality for bulk deployments</li>
</ul>
<h2 id="router-interface">Router Interface</h2>
<p>TBD, possibly a separate proposal.
i2pcontrol is not required for the first release and detailed changes will be included in a separate proposal.</p>
<p>Requirements for Garlic Farm to router API (in-JVM java or i2pcontrol)</p>
<ul>
<li>getLocalRouterStatus()</li>
<li>getLocalLeafHash(Hash masterHash)</li>
<li>getLocalLeafStatus(Hash leaf)</li>
<li>getRemoteMeasuredStatus(Hash masterOrLeaf) // probably not in MVP</li>
<li>publishMetaLS(Hash masterHash, List<MetaLease> contents) // or signed MetaLeaseSet? Who signs?</li>
<li>stopPublishingMetaLS(Hash masterHash)</li>
<li>authentication TBD?</li>
</ul>
<h2 id="justification">Justification</h2>
<p>Atomix is too large and won&rsquo;t allow customization for us to route
the protocol over I2P. Also, its wire format is undocumented, and depends
on Java serialization.</p>
<h2 id="notes-2">Notes</h2>
<h2 id="issues">Issues</h2>
<ul>
<li>There&rsquo;s no way for a client to find out about and connect to an unknown leader.
It would be a minor change for a Follower to send the Configuration as a Log Entry in the AppendEntriesResponse.</li>
</ul>
<h2 id="migration">Migration</h2>
<p>No backward compatibility issues.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://github.com/datatechnology/jraft">JRAFT</a>
</li>
<li><a href="https://json.org/">JSON</a>
</li>
<li><a href="https://ramcloud.stanford.edu/wiki/download/attachments/11370504/raft.pdf">RAFT</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc2616">RFC-2616</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc2617">RFC-2617</a>
</li>
<li><a href="https://en.wikipedia.org/wiki/WebSocket">WEBSOCKET</a>
</li>
</ul>

                </article>

                
                <nav class="page-nav">
                    <a href="../../../en/proposals/" class="page-nav-link">
                        ‚Üê Back to Proposals
                    </a>
                    
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                    <a href="../../../proposals/150-garlic-farm-protocol.txt" class="page-nav-link" download>
                        Download Source (.txt)
                    </a>
                    
                </nav>
            </div>
        </div>
    </div>
</div>

<style>
.proposals-page {
    min-height: 100vh;
    padding: var(--spacing-xl) 0;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
}

.breadcrumbs a:hover {
    color: var(--color-primary);
}

.separator {
    color: var(--color-border);
}

.current {
    color: var(--color-text);
}

 
.translation-disclaimer {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.dark .translation-disclaimer {
    background: #78350f;
    border-color: #d97706;
}

.disclaimer-message {
    color: #92400e;
    font-size: 0.875rem;
}

.dark .disclaimer-message {
    color: #fde047;
}

.disclaimer-link {
    color: #92400e;
    font-weight: 600;
    text-decoration: underline;
    white-space: nowrap;
}

.dark .disclaimer-link {
    color: #fde047;
}

 
.proposal-header {
    margin-bottom: var(--spacing-2xl);
}

.proposal-title-section {
    margin-bottom: var(--spacing-lg);
}

.proposal-title {
    font-size: 2.5rem;
    margin: 0 0 var(--spacing-sm) 0;
    color: var(--color-text);
}

.proposal-number {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    font-weight: 600;
}

 
.proposal-meta-box {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
}

.proposal-status {
    display: inline-block;
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: var(--spacing-md);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

 
.status-open {
    background: #dbeafe;
    color: #0369a1;
}

.dark .status-open {
    background: #0c4a6e;
    color: #7dd3fc;
}

.status-accepted {
    background: #dbeafe;
    color: #0369a1;
}

.dark .status-accepted {
    background: #0c4a6e;
    color: #7dd3fc;
}

.status-finished {
    background: #dcfce7;
    color: #15803d;
}

.dark .status-finished {
    background: #164e63;
    color: #86efac;
}

.status-closed {
    background: #dcfce7;
    color: #15803d;
}

.dark .status-closed {
    background: #164e63;
    color: #86efac;
}

.status-rejected {
    background: #fee2e2;
    color: #991b1b;
}

.dark .status-rejected {
    background: #7f1d1d;
    color: #fca5a5;
}

.status-draft,
.status-needs-revision,
.status-dead,
.status-needs-research {
    background: #fef3c7;
    color: #92400e;
}

.dark .status-draft,
.dark .status-needs-revision,
.dark .status-dead,
.dark .status-needs-research {
    background: #78350f;
    color: #fde047;
}

.status-meta,
.status-informational,
.status-reserve {
    background: #e9d5ff;
    color: #6b21a8;
}

.dark .status-meta,
.dark .status-informational,
.dark .status-reserve {
    background: #581c87;
    color: #e879f9;
}

 
.proposal-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.info-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
}

.info-value {
    font-size: 0.9375rem;
    color: var(--color-text);
    font-weight: 500;
}

 
.proposal-relationships {
    border-top: 1px solid var(--color-border);
    padding-top: var(--spacing-md);
}

.relationship {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
}

.relationship:last-child {
    margin-bottom: 0;
}

.relationship-label {
    font-weight: 600;
    color: var(--color-text-muted);
    min-width: 120px;
}

.relationship-value {
    color: var(--color-text);
}

 
.proposal-layout {
    display: block;
}

.proposal-layout--with-toc {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

 
.proposal-toc-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.toc-nav {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
}

.toc-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-text);
    padding-bottom: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.toc-content {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
}

.toc-content::-webkit-scrollbar {
    width: 4px;
}

.toc-content::-webkit-scrollbar-track {
    background: transparent;
}

.toc-content::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
}

.toc-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

.toc-nav ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc-nav li {
    margin-bottom: 0.25rem;
}

.toc-nav ul ul {
    padding-left: var(--spacing-md);
    margin-top: 0.25rem;
}

.toc-nav a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.8125rem;
    display: block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    line-height: 1.4;
}

.toc-nav a:hover {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
}

 
.proposal-main {
    min-width: 0;
}

 
.proposal-content {
    line-height: 1.8;
    color: var(--color-text);
    max-width: 900px;
}

.proposal-content h2 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.75rem;
    scroll-margin-top: 100px;
}

.proposal-content h3 {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.375rem;
    scroll-margin-top: 100px;
}

.proposal-content h4 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-xs);
    font-size: 1.125rem;
    scroll-margin-top: 100px;
}

.proposal-content p {
    margin-bottom: var(--spacing-md);
}

.proposal-content ul,
.proposal-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.proposal-content li {
    margin-bottom: var(--spacing-xs);
}

.proposal-content code {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
}

.proposal-content pre {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: var(--spacing-md);
    font-size: 0.875rem;
}

.proposal-content pre code {
    background: none;
    padding: 0;
}

.proposal-content blockquote {
    border-left: 4px solid var(--color-primary);
    padding-left: var(--spacing-md);
    margin-left: 0;
    margin-bottom: var(--spacing-md);
    font-style: italic;
    color: var(--color-text-secondary);
}

.proposal-content a {
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
}

.proposal-content a:hover {
    border-bottom-color: var(--color-primary);
}

.proposal-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: var(--spacing-md);
}

.proposal-content table th {
    background: var(--color-bg-secondary);
    padding: var(--spacing-sm);
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--color-border);
}

.proposal-content table td {
    padding: var(--spacing-sm);
    border-bottom: 1px solid var(--color-border);
}

.proposal-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin: var(--spacing-lg) 0;
    display: block;
}

 
.page-nav {
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.page-nav-link {
    display: inline-block;
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.page-nav-link:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
}

 
@media (max-width: 1024px) {
    .proposal-layout--with-toc {
        grid-template-columns: 1fr;
    }

    .proposal-toc-sidebar {
        position: static;
        max-height: none;
        margin-bottom: var(--spacing-xl);
    }

    .toc-content {
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .proposal-title {
        font-size: 1.75rem;
    }

    .proposal-info-grid {
        grid-template-columns: 1fr;
    }
}
</style>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = [];

    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const heading = document.getElementById(href.slice(1));
            if (heading) {
                headings.push({ element: heading, link: link });
            }
        }
    });

    function updateActiveLink() {
        const scrollPos = window.scrollY + 120;
        let activeIndex = 0;

        for (let i = 0; i < headings.length; i++) {
            if (headings[i].element.offsetTop <= scrollPos) {
                activeIndex = i;
            }
        }

        tocLinks.forEach(link => link.classList.remove('active'));
        if (headings[activeIndex]) {
            headings[activeIndex].link.classList.add('active');
        }
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});
</script>
<style>
.toc-nav a.active {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
    font-weight: 600;
}
</style>



    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">Stay updated with I2P news:</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="Enter your email" required>
                            <button type="submit">Subscribe</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="../../../en/financial-support/">Donate</a></li>
                    <li><a href="../../../en/docs/overview/intro/">I2P Introduction</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Community</h3>
                <ul>
                    <li><a href="../../../en/get-involved/">Get Involved</a></li>
                    <li><a href="../../../en/blog/">Blog</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">Official Forums</a></li>
                    <li><a href="../../../en/contact/">Contact</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Resources</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">I2P Metrics</a></li>
                    <li><a href="../../../en/papers/">Research</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">StormyCloud</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 The Invisible Internet Project. Licensed under Creative Commons.</p>
            <div class="footer-links">
                <a href="../../../en/privacy/">Privacy</a>
                <a href="../../../en/terms/">Terms</a>
                <a href="../../../en/about/media/">Press</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>Community Poll</h2>
            <p class="modal-subtitle">We&#39;d love to hear from you</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                Your vote helps shape the future of I2P.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
<!DOCTYPE html>
<html lang="tr" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>ECIES-X25519-AEAD-Ratchet (kademeli anahtar yenileme mekanizması) Şifreleme Şartnamesi | I2P - Görünmez İnternet Projesi</title>

    <meta name="description" content="I2P için Eliptik Eğri Bütünleşik Şifreleme Şeması (X25519 &#43; AEAD)">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="ECIES-X25519-AEAD-Ratchet (kademeli anahtar yenileme mekanizması) Şifreleme Şartnamesi | I2P - Görünmez İnternet Projesi">
    <meta property="og:description" content="I2P için Eliptik Eğri Bütünleşik Şifreleme Şeması (X25519 &#43; AEAD)">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/tr/docs/specs/ecies/">

    
    <link rel="icon" type="image/svg+xml" href="../../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">I2P Beta Sitesi Artık Yayında E-posta sorunları için stormycloud@mail.i2p</span>
            
        </div>
        
        <form method="GET" action="../../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="Banner" title="Banner">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../../tr/" class="logo-link">
                    <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../../tr/about/" class="">Hakkında</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../tr/about/">Genel Bakış</a></li>
                            <li><a href="../../../../tr/papers/">Araştırma Makaleleri</a></li>
                            <li><a href="../../../../tr/about/media/">Basın</a></li>
                            <li><a href="../../../../tr/contact/">İletişim</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../../tr/docs/" class="active">Belgeler</a></li>
                    <li><a href="../../../../tr/downloads/" class="">İndirilenler</a></li>
                    <li><a href="../../../../tr/blog/" class="">Blog</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../../tr/get-involved/" class="">Katılım Sağla</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../tr/get-involved/">Genel Bakış</a></li>
                            <li><a href="../../../../tr/feedback/">Özellik Önerileri</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">tr</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../en/docs/specs/ecies/"
                                class="lang-option">İngilizce</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../es/docs/specs/ecies/"
                                class="lang-option">İspanyolca</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ko/docs/specs/ecies/"
                                class="lang-option">Korece</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../zh/docs/specs/ecies/"
                                class="lang-option">Çince</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ru/docs/specs/ecies/"
                                class="lang-option">Rusça</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../cs/docs/specs/ecies/"
                                class="lang-option">Çekçe</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../de/docs/specs/ecies/"
                                class="lang-option">Almanca</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../fr/docs/specs/ecies/"
                                class="lang-option">Fransızca</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../tr/docs/specs/ecies/"
                                class="lang-option active">Türkçe</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../vi/docs/specs/ecies/"
                                class="lang-option">Vietnamca</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../hi/docs/specs/ecies/"
                                class="lang-option">Hintçe</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ar/docs/specs/ecies/"
                                class="lang-option">Arapça</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../pt/docs/specs/ecies/"
                                class="lang-option">Portekizce</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../../tr/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../../tr/downloads/" class="btn btn-primary">I2P&#39;yi Edin</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        




<div class="docs-page">
    <div class="container">
        
        <div class="docs-layout docs-layout--with-toc">
            
            
            <aside class="docs-toc-sidebar">
                <nav class="toc-nav">
                    <div class="toc-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        On This Page
                    </div>
                    <div class="toc-content">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#genel-bakış">Genel Bakış</a>
      <ul>
        <li><a href="#amaç">Amaç</a></li>
        <li><a href="#elgamalaessessiontagse-göre-başlıca-iyileştirmeler">ElGamal/AES+SessionTags&rsquo;e Göre Başlıca İyileştirmeler</a></li>
        <li><a href="#dağıtım-durumu">Dağıtım Durumu</a></li>
        <li><a href="#gerçekleştirme-durumu">Gerçekleştirme Durumu</a></li>
      </ul>
    </li>
    <li><a href="#protokolün-temelleri">Protokolün Temelleri</a>
      <ul>
        <li><a href="#noise-protokol-çerçevesi">Noise Protokol Çerçevesi</a></li>
        <li><a href="#noise-protokol-tanımlayıcısı">Noise Protokol Tanımlayıcısı</a></li>
        <li><a href="#noise-el-sıkışma-örüntüsü">Noise El Sıkışma Örüntüsü</a></li>
        <li><a href="#noise-güvenlik-özellikleri">Noise Güvenlik Özellikleri</a></li>
        <li><a href="#ik-noise-protokolünde-el-sıkışma-kalıbı-ile-xk-noise-protokolünde-el-sıkışma-kalıbı-arasındaki-farklar">IK (Noise protokolünde el sıkışma kalıbı) ile XK (Noise protokolünde el sıkışma kalıbı) Arasındaki Farklar</a></li>
        <li><a href="#signal-double-ratchet-çift-mandallı-anahtar-yenileme-mekanizması-kavramları">Signal Double Ratchet (çift mandallı anahtar yenileme mekanizması) Kavramları</a></li>
        <li><a href="#noise-kriptografik-protokol-çerçevesi-için-i2p-uzantıları">Noise (kriptografik protokol çerçevesi) için I2P Uzantıları</a></li>
      </ul>
    </li>
    <li><a href="#kriptografik-ilkel-yapılar">Kriptografik İlkel Yapılar</a>
      <ul>
        <li><a href="#x25519-diffie-hellman">X25519 Diffie-Hellman</a></li>
        <li><a href="#x25519-generate_private">X25519 GENERATE_PRIVATE()</a></li>
        <li><a href="#x25519-derive_publicprivkey">X25519 DERIVE_PUBLIC(privkey)</a></li>
        <li><a href="#x25519-dhprivkey-pubkey">X25519 DH(privkey, pubkey)</a></li>
        <li><a href="#chacha20-poly1305-aead-ilişkili-verili-kimlik-doğrulamalı-şifreleme">ChaCha20-Poly1305 AEAD (İlişkili Verili Kimlik Doğrulamalı Şifreleme)</a></li>
        <li><a href="#chacha20-poly1305-encryptk-n-plaintext-ad">ChaCha20-Poly1305 ENCRYPT(k, n, plaintext, ad)</a></li>
        <li><a href="#chacha20-poly1305-şifre-çözk-n-ciphertext-ad">ChaCha20-Poly1305 ŞİFRE ÇÖZ(k, n, ciphertext, ad)</a></li>
        <li><a href="#sha-256-özet-fonksiyonu">SHA-256 Özet Fonksiyonu</a></li>
        <li><a href="#sha-256-hp-d">SHA-256 H(p, d)</a></li>
        <li><a href="#sha-256-mixhashd">SHA-256 MixHash(d)</a></li>
        <li><a href="#hkdf-anahtar-türetimi">HKDF Anahtar Türetimi</a></li>
        <li><a href="#elligator2-kodlaması">Elligator2 Kodlaması</a></li>
        <li><a href="#elligator2-generate_private_elg2">Elligator2 GENERATE_PRIVATE_ELG2()</a></li>
        <li><a href="#elligator2-elliptik-eğri-nokta-kodlama-yöntemi-encode_elg2pubkey">Elligator2 (elliptik eğri nokta kodlama yöntemi) ENCODE_ELG2(pubkey)</a></li>
        <li><a href="#elligator2-decode_elg2encodedkey">Elligator2 DECODE_ELG2(encodedKey)</a></li>
      </ul>
    </li>
    <li><a href="#mesaj-biçimleri">Mesaj Biçimleri</a>
      <ul>
        <li><a href="#genel-bakış-1">Genel Bakış</a></li>
        <li><a href="#i2np-garlic-mesaj-kapsayıcısı-garlic-i2pde-kullanılan-birden-fazla-mesajı-demetleme-tekniği">I2NP Garlic Mesaj Kapsayıcısı (garlic: I2P&rsquo;de kullanılan, birden fazla mesajı demetleme tekniği)</a></li>
        <li><a href="#yeni-oturum-ns-mesajı">Yeni Oturum (NS) Mesajı</a></li>
        <li><a href="#bağlama-içeren-ns-mesajı-tip-1b">Bağlama içeren NS Mesajı (Tip 1b)</a></li>
        <li><a href="#bağlama-olmadan-ns-mesajı-tür-1c">Bağlama olmadan NS mesajı (Tür 1c)</a></li>
        <li><a href="#ns-tek-seferlik-mesaj-tür-1d">NS Tek Seferlik Mesaj (Tür 1d)</a></li>
        <li><a href="#yeni-oturum-yanıtı-nsr-mesajı">Yeni Oturum Yanıtı (NSR) Mesajı</a></li>
        <li><a href="#mevcut-oturum-es-mesajı">Mevcut Oturum (ES) Mesajı</a></li>
      </ul>
    </li>
    <li><a href="#anahtar-türetme-fonksiyonları">Anahtar Türetme Fonksiyonları</a>
      <ul>
        <li><a href="#notasyon-ve-sabitler">Notasyon ve Sabitler</a></li>
        <li><a href="#ns-mesajı-kdfleri-anahtar-türetme-fonksiyonları">NS Mesajı KDF&rsquo;leri (anahtar türetme fonksiyonları)</a></li>
        <li><a href="#kdf-1-başlangıç-zincir-anahtarı">KDF 1: Başlangıç Zincir Anahtarı</a></li>
        <li><a href="#kdf-2-bobun-statik-anahtar-karıştırması">KDF 2: Bob&rsquo;un Statik Anahtar Karıştırması</a></li>
        <li><a href="#kdf-3-alicenin-geçici-anahtar-üretimi">KDF 3: Alice&rsquo;nin Geçici Anahtar Üretimi</a></li>
        <li><a href="#kdf-4-ns-statik-anahtar-bölümü-es-dh">KDF 4: NS Statik Anahtar Bölümü (es DH)</a></li>
        <li><a href="#kdf-anahtar-türetme-fonksiyonu-5-ns-payload-bölümü-ss-dh-yalnızca-bağlama-amaçlı">KDF (Anahtar Türetme Fonksiyonu) 5: NS Payload Bölümü (ss DH, yalnızca bağlama amaçlı)</a></li>
        <li><a href="#nsr-reply-tagset-kdf-yanıt-etiket-kümesi-için-anahtar-türetme-fonksiyonu">NSR Reply Tagset KDF (yanıt etiket kümesi için anahtar türetme fonksiyonu)</a></li>
        <li><a href="#nsr-mesajı-kdfleri-anahtar-türetme-fonksiyonları">NSR Mesajı KDF&rsquo;leri (anahtar türetme fonksiyonları)</a></li>
        <li><a href="#kdf-6-nsr-geçici-anahtar-üretimi">KDF 6: NSR Geçici Anahtar Üretimi</a></li>
        <li><a href="#kdf-7-nsr-anahtar-bölümü-ee-ve-se-dh">KDF 7: NSR Anahtar Bölümü (ee ve se DH)</a></li>
        <li><a href="#kdf-8-nsr-yük-bölümü">KDF 8: NSR Yük Bölümü</a></li>
        <li><a href="#es-mesaj-kdfleri-anahtar-türetme-fonksiyonları">ES Mesaj KDF&rsquo;leri (anahtar türetme fonksiyonları)</a></li>
        <li><a href="#dh_initialize-fonksiyonu">DH_INITIALIZE Fonksiyonu</a></li>
      </ul>
    </li>
    <li><a href="#ratchet-mekanizmaları-tek-yönlü-anahtar-yenileme-mekanizmaları">Ratchet Mekanizmaları (tek yönlü anahtar yenileme mekanizmaları)</a>
      <ul>
        <li><a href="#ratchet-mandal-mekanizması-genel-bakış">Ratchet (mandal mekanizması) Genel Bakış</a></li>
        <li><a href="#dh-ratchet-diffie-hellman-temelli-kademeli-anahtar-yenileme-mekanizması">DH Ratchet (Diffie-Hellman temelli kademeli anahtar yenileme mekanizması)</a></li>
        <li><a href="#dh-ratchet-diffie-hellman-anahtar-yenileme-mekanizması-frekansı">DH Ratchet (Diffie-Hellman anahtar yenileme mekanizması) Frekansı</a></li>
        <li><a href="#dh-ratchet-dh-ratchet-mekanizması-etiket-ve-anahtar-kimlikleri">DH Ratchet (DH &ldquo;ratchet&rdquo; mekanizması) Etiket ve Anahtar Kimlikleri</a></li>
        <li><a href="#dh-ratchet-kademeli-anahtar-yenileme-mekanizması-mesaj-akışı">DH Ratchet (kademeli anahtar yenileme mekanizması) Mesaj Akışı</a></li>
        <li><a href="#nextkey-bir-sonraki-anahtar-blok-biçimi">NextKey (bir sonraki anahtar) Blok Biçimi</a></li>
        <li><a href="#dh-ratchet-kdf-anahtar-türetme-fonksiyonu">DH Ratchet KDF (Anahtar Türetme Fonksiyonu)</a></li>
        <li><a href="#dh-ratchet-kademeli-diffie-hellman-anahtar-yenileme-mekanizması-durum-yönetimi">DH Ratchet (kademeli Diffie-Hellman anahtar yenileme mekanizması) Durum Yönetimi</a></li>
        <li><a href="#session-tag-ratchet-oturum-etiketi-için-kademeli-güncelleme-mekanizması">Session Tag Ratchet (oturum etiketi için kademeli güncelleme mekanizması)</a></li>
        <li><a href="#oturum-etiketi-ratchetin-kademeli-anahtar-yenileme-mekanizması-amacı">Oturum Etiketi Ratchet&rsquo;in (kademeli anahtar yenileme mekanizması) Amacı</a></li>
        <li><a href="#oturum-etiketi-ratchet-mandallama-mekanizması-formülü">Oturum Etiketi Ratchet (mandallama mekanizması) Formülü</a></li>
        <li><a href="#session-tag-ratchet-oturum-etiketi-ratchet-mekanizması-gönderici-gerçeklemesi">Session Tag Ratchet (oturum etiketi ratchet mekanizması) Gönderici Gerçeklemesi</a></li>
        <li><a href="#session-tag-ratchet-oturum-etiketi-için-kademeli-anahtar-yenileme-mekanizması-alıcı-tarafı-uygulaması">Session Tag Ratchet (oturum etiketi için kademeli anahtar yenileme mekanizması) Alıcı Tarafı Uygulaması</a></li>
        <li><a href="#oturum-etiketi-ileriye-bakma-stratejisi">Oturum Etiketi İleriye Bakma Stratejisi</a></li>
        <li><a href="#session-taglerin-oturum-etiketleri-sıra-dışı-işlenmesi">Session Tag&rsquo;lerin (Oturum Etiketleri) Sıra Dışı İşlenmesi</a></li>
        <li><a href="#simetrik-anahtar-mandalı">Simetrik Anahtar Mandalı</a></li>
        <li><a href="#symmetric-key-ratchet-simetrik-anahtar-mandal-mekanizması-amacı">Symmetric Key Ratchet (simetrik anahtar mandal mekanizması) Amacı</a></li>
        <li><a href="#symmetric-key-ratchet-simetrik-anahtar-mandalı-formülü">Symmetric Key Ratchet (simetrik anahtar mandalı) formülü</a></li>
        <li><a href="#symmetric-key-ratchet-mandal-mekanizması-gönderici-gerçeklemesi">Symmetric Key Ratchet (mandal mekanizması) Gönderici Gerçeklemesi</a></li>
        <li><a href="#symmetric-key-ratchet-simetrik-anahtar-yenileme-mekanizması-alıcı-tarafı-gerçeklemesi">Symmetric Key Ratchet (simetrik anahtar yenileme mekanizması) Alıcı Tarafı Gerçeklemesi</a></li>
        <li><a href="#oturum-etiketleri-ile-simetrik-ratchet-simetrik-anahtar-yenileme-mekanizması-senkronizasyonu">Oturum Etiketleri ile Simetrik Ratchet (simetrik anahtar yenileme mekanizması) Senkronizasyonu</a></li>
        <li><a href="#symmetric-ratchet-kademeli-anahtar-yenileme-mekanizması-için-nonce-tek-kullanımlık-sayı-oluşturma">Symmetric Ratchet (kademeli anahtar yenileme mekanizması) için Nonce (tek-kullanımlık sayı) Oluşturma</a></li>
      </ul>
    </li>
    <li><a href="#oturum-yönetimi">Oturum Yönetimi</a>
      <ul>
        <li><a href="#oturum-bağlamı">Oturum Bağlamı</a></li>
        <li><a href="#oturum-bağlama">Oturum Bağlama</a></li>
        <li><a href="#bağlı-oturumlar">Bağlı Oturumlar</a></li>
        <li><a href="#bağlı-olmayan-oturumlar">Bağlı Olmayan Oturumlar</a></li>
        <li><a href="#oturum-eşleştirme">Oturum Eşleştirme</a></li>
        <li><a href="#eşleştirilmiş-oturumlar-oluşturma">Eşleştirilmiş Oturumlar Oluşturma</a></li>
        <li><a href="#oturum-eşleştirmenin-avantajları">Oturum Eşleştirmenin Avantajları</a></li>
        <li><a href="#oturum-eşleştirme-kuralları">Oturum Eşleştirme Kuralları</a></li>
        <li><a href="#oturum-yaşam-döngüsü">Oturum Yaşam Döngüsü</a></li>
        <li><a href="#oturum-yaşam-döngüsü-oluşturma-aşaması">Oturum Yaşam Döngüsü: Oluşturma Aşaması</a></li>
        <li><a href="#oturum-yaşam-döngüsü-aktif-aşama">Oturum Yaşam Döngüsü: Aktif Aşama</a></li>
        <li><a href="#oturum-yaşam-döngüsü-sona-erme-aşaması">Oturum Yaşam Döngüsü: Sona Erme Aşaması</a></li>
        <li><a href="#birden-çok-ns-mesajı">Birden çok NS mesajı</a></li>
        <li><a href="#birden-fazla-nsr-mesajı">Birden fazla NSR mesajı</a></li>
        <li><a href="#oturum-durum-makinesi">Oturum Durum Makinesi</a></li>
      </ul>
    </li>
    <li><a href="#yük-biçimi">Yük Biçimi</a>
      <ul>
        <li><a href="#blok-yapısı">Blok Yapısı</a></li>
        <li><a href="#blok-türleri">Blok Türleri</a></li>
        <li><a href="#blok-sıralama-kuralları">Blok Sıralama Kuralları</a></li>
        <li><a href="#ns-mesaj-sıralaması">NS Mesaj Sıralaması</a></li>
        <li><a href="#nsr-mesaj-sıralaması">NSR Mesaj Sıralaması</a></li>
        <li><a href="#es-mesaj-sıralaması">ES Mesaj Sıralaması</a></li>
        <li><a href="#tarih-saat-bloğu-tür-0">Tarih-Saat Bloğu (Tür 0)</a></li>
        <li><a href="#garlic-clove-block-sarımsak-dişi-bloğu-type-11">Garlic Clove Block (Sarımsak Dişi Bloğu) (Type 11)</a></li>
        <li><a href="#nextkey-block-sonraki-anahtar-bloğu-tip-7">NextKey Block (sonraki anahtar bloğu) (Tip 7)</a></li>
        <li><a href="#ack-bloğu-tip-8">ACK Bloğu (Tip 8)</a></li>
        <li><a href="#ack-istek-bloğu-tip-9">ACK İstek Bloğu (Tip 9)</a></li>
        <li><a href="#sonlandırma-bloğu-tür-4">Sonlandırma Bloğu (Tür 4)</a></li>
        <li><a href="#seçenekler-bloğu-tür-5">Seçenekler Bloğu (Tür 5)</a></li>
        <li><a href="#mesaj-numaraları-bloğu-tür-6">Mesaj Numaraları Bloğu (Tür 6)</a></li>
        <li><a href="#dolgu-bloğu-tür-254">Dolgu Bloğu (Tür 254)</a></li>
      </ul>
    </li>
    <li><a href="#uygulama-kılavuzu">Uygulama Kılavuzu</a>
      <ul>
        <li><a href="#önkoşullar">Önkoşullar</a></li>
        <li><a href="#önerilen-uygulama-sırası">Önerilen Uygulama Sırası</a></li>
        <li><a href="#gönderici-gerçeklemesi">Gönderici Gerçeklemesi</a></li>
        <li><a href="#alıcı-gerçeklemesi">Alıcı Gerçeklemesi</a></li>
        <li><a href="#mesaj-sınıflandırması">Mesaj Sınıflandırması</a></li>
        <li><a href="#oturum-yönetimi-en-iyi-uygulamaları">Oturum Yönetimi En İyi Uygulamaları</a></li>
        <li><a href="#test-stratejileri">Test Stratejileri</a></li>
        <li><a href="#performansla-ilgili-hususlar">Performansla İlgili Hususlar</a></li>
      </ul>
    </li>
    <li><a href="#güvenlik-hususları">Güvenlik Hususları</a>
      <ul>
        <li><a href="#tehdit-modeli">Tehdit Modeli</a></li>
        <li><a href="#kriptografik-varsayımlar">Kriptografik Varsayımlar</a></li>
        <li><a href="#anahtar-yönetimi">Anahtar Yönetimi</a></li>
        <li><a href="#saldırı-azaltma-önlemleri">Saldırı Azaltma Önlemleri</a></li>
        <li><a href="#yeniden-oynatma-saldırılarına-karşı-önlemler">Yeniden Oynatma Saldırılarına Karşı Önlemler</a></li>
        <li><a href="#key-compromise-impersonation-kci-anahtar-ele-geçirilmesi-kaynaklı-kimlik-taklidi-için-önlemler">Key Compromise Impersonation (KCI) (anahtar ele geçirilmesi kaynaklı kimlik taklidi) için Önlemler</a></li>
        <li><a href="#hizmet-reddi-dos-azaltma-önlemleri">Hizmet Reddi (DoS) Azaltma Önlemleri</a></li>
        <li><a href="#trafik-analizi-direnci">Trafik Analizi Direnci</a></li>
        <li><a href="#uygulama-tuzakları">Uygulama Tuzakları</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#security-audits">Security Audits</a></li>
      </ul>
    </li>
    <li><a href="#configuration-and-deployment">Configuration and Deployment</a>
      <ul>
        <li><a href="#i2cp-configuration">I2CP Configuration</a></li>
        <li><a href="#java-i2p-configuration">Java I2P Configuration</a></li>
        <li><a href="#i2pd-configuration">i2pd Configuration</a></li>
        <li><a href="#compatibility-matrix">Compatibility Matrix</a></li>
        <li><a href="#migration-guide">Migration Guide</a></li>
        <li><a href="#performance-tuning">Performance Tuning</a></li>
        <li><a href="#monitoring-and-debugging">Monitoring and Debugging</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a>
      <ul>
        <li><a href="#specifications">Specifications</a></li>
        <li><a href="#cryptographic-standards">Cryptographic Standards</a></li>
        <li><a href="#implementation-resources">Implementation Resources</a></li>
        <li><a href="#additional-information">Additional Information</a></li>
      </ul>
    </li>
    <li><a href="#appendix-a-kdf-summary">Appendix A: KDF Summary</a></li>
    <li><a href="#appendix-b-message-size-calculator">Appendix B: Message Size Calculator</a></li>
    <li><a href="#appendix-c-glossary">Appendix C: Glossary</a></li>
  </ul>
</nav>
                    </div>
                </nav>
            </aside>
            

            
            <div class="docs-main">
                
                <nav class="breadcrumbs">
                    <a href="../../../../tr/">Home</a>
                    <span class="separator">/</span>
                    <a href="../../../../tr/docs/">Docs</a>
                    
                        
                            <span class="separator">/</span>
                            <a href="../../../../tr/docs/specs/">Specifications</a>
                        
                    
                    <span class="separator">/</span>
                    <span class="current">ECIES-X25519-AEAD-Ratchet (kademeli anahtar yenileme mekanizması) Şifreleme Şartnamesi</span>
                </nav>

                
<div class="translation-disclaimer" role="note">
    <span class="disclaimer-message">Bu çeviri makine öğrenimi kullanılarak oluşturulmuştur ve %100 doğru olmayabilir.</span>
    
    
    <a href="../../../../en/docs/specs/ecies/" class="disclaimer-link">İngilizce versiyonu görüntüle</a>
    
</div>



                
                <header class="article-header">
                    <h1 class="article-title">ECIES-X25519-AEAD-Ratchet (kademeli anahtar yenileme mekanizması) Şifreleme Şartnamesi</h1>
                    
                        <p class="article-description">I2P için Eliptik Eğri Bütünleşik Şifreleme Şeması (X25519 &#43; AEAD)</p>
                    
                    <div class="article-meta">
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                Updated: 2025-10
                            </span>
                        
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Accurate for: 2.10.0
                            </span>
                        
                    </div>
                </header>

                
                <article class="article-content">
                    <h2 id="genel-bakış">Genel Bakış</h2>
<h3 id="amaç">Amaç</h3>
<p>ECIES-X25519-AEAD-Ratchet, I2P&rsquo;nin modern uçtan uca şifreleme protokolüdür ve eski ElGamal/AES+SessionTags sisteminin yerini alır. İleriye dönük gizlilik, kimlik doğrulamalı şifreleme ve performans ile güvenlikte önemli iyileştirmeler sağlar.</p>
<h3 id="elgamalaessessiontagse-göre-başlıca-iyileştirmeler">ElGamal/AES+SessionTags&rsquo;e Göre Başlıca İyileştirmeler</h3>
<ul>
<li><strong>Daha Küçük Anahtarlar</strong>: 32 baytlık anahtarlar, 256 baytlık ElGamal açık anahtarlarına karşı (%87,5 azalma)</li>
<li><strong>İleri Gizlilik</strong>: DH ratcheting (DH ratchet mekanizması) aracılığıyla sağlanır (eski protokolde mevcut değildir)</li>
<li><strong>Modern Kriptografi</strong>: X25519 DH, ChaCha20-Poly1305 AEAD, SHA-256</li>
<li><strong>Kimlik Doğrulamalı Şifreleme</strong>: AEAD yapısı aracılığıyla yerleşik kimlik doğrulaması</li>
<li><strong>Çift Yönlü Protokol</strong>: Eşleştirilmiş gelen/giden oturumlar, tek yönlü eski protokole karşı</li>
<li><strong>Verimli Etiketler</strong>: 8 baytlık oturum etiketleri, 32 baytlık etiketlere karşı (%75 azalma)</li>
<li><strong>Trafik Gizleme</strong>: Elligator2 kodlaması, el sıkışmalarını rastgele veriden ayırt edilemez hale getirir</li>
</ul>
<h3 id="dağıtım-durumu">Dağıtım Durumu</h3>
<ul>
<li><strong>İlk Sürüm</strong>: Sürüm 0.9.46 (25 Mayıs 2020)</li>
<li><strong>Ağ Dağıtımı</strong>: 2020 itibarıyla tamamlandı</li>
<li><strong>Güncel Durum</strong>: Olgun, yaygın olarak konuşlandırılmış (5+ yıldır üretimde)</li>
<li><strong>Router Desteği</strong>: Sürüm 0.9.46 veya üzeri gereklidir</li>
<li><strong>Floodfill Gereksinimleri</strong>: Şifreli sorgular için neredeyse %100 benimsenme</li>
</ul>
<h3 id="gerçekleştirme-durumu">Gerçekleştirme Durumu</h3>
<p><strong>Tamamen Uygulandı:</strong> - Bağlama içeren New Session (NS) mesajları - New Session Reply (NSR) mesajları - Existing Session (ES) mesajları - DH ratchet (kademeli anahtar yenileme) mekanizması - Session tag ve simetrik anahtar ratchet&rsquo;ları - DateTime, NextKey, ACK, ACK Request, Garlic Clove ve Padding blokları</p>
<p><strong>Uygulanmadı (sürüm 0.9.50 itibarıyla):</strong> - MessageNumbers bloğu (tip 6) - Options bloğu (tip 5) - Termination bloğu (tip 4) - Protokol katmanı otomatik yanıtları - Sıfır statik anahtar modu - Multicast oturumları</p>
<p><strong>Not</strong>: 1.5.0&rsquo;dan 2.10.0&rsquo;a (2021-2025) kadar olan sürümlerin uygulama durumu, bazı özellikler eklenmiş olabileceğinden doğrulama gerektirir.</p>
<hr>
<h2 id="protokolün-temelleri">Protokolün Temelleri</h2>
<h3 id="noise-protokol-çerçevesi">Noise Protokol Çerçevesi</h3>
<p>ECIES-X25519-AEAD-Ratchet, <a href="https://noiseprotocol.org/">Noise Protocol Framework</a>
 (Noise Protokol Çatısı) (Revision 34, 2018-07-11) temelinde, özellikle I2P&rsquo;ye özgü uzantılarla <strong>IK</strong> (Etkileşimli, uzaktaki statik anahtarı bilinen) el sıkışma desenini kullanır.</p>
<h3 id="noise-protokol-tanımlayıcısı">Noise Protokol Tanımlayıcısı</h3>
<pre tabindex="0"><code>Noise_IKelg2+hs2_25519_ChaChaPoly_SHA256
</code></pre><p><strong>Tanımlayıcı Bileşenler:</strong> - <code>Noise</code> - Temel çerçeve - <code>IK</code> - Bilinen uzak statik anahtarla etkileşimli el sıkışma deseni - <code>elg2</code> - Geçici anahtarlar için Elligator2 kodlaması (I2P extension) - <code>+hs2</code> - Etiketi karışıma katmak için ikinci iletiden önce çağrılan MixHash (I2P extension) - <code>25519</code> - X25519 Diffie-Hellman işlevi - <code>ChaChaPoly</code> - ChaCha20-Poly1305 AEAD şifreleme algoritması - <code>SHA256</code> - SHA-256 özet işlevi</p>
<h3 id="noise-el-sıkışma-örüntüsü">Noise El Sıkışma Örüntüsü</h3>
<p><strong>IK Desen Notasyonu:</strong></p>
<pre tabindex="0"><code>&lt;- s                    (Bob&#39;s static key known to Alice)
...
-&gt; e, es, s, ss         (Alice sends ephemeral, DH es, static key, DH ss)
&lt;- e, ee, se            (Bob sends ephemeral, DH ee, DH se)
</code></pre><p><strong>Kısaltmaların Anlamları:</strong> - <code>e</code> - Geçici anahtar iletimi - <code>s</code> - Statik anahtar iletimi - <code>es</code> - Alice&rsquo;in geçici anahtarı ile Bob&rsquo;un statik anahtarı arasındaki DH (Diffie-Hellman) - <code>ss</code> - Alice&rsquo;in statik anahtarı ile Bob&rsquo;un statik anahtarı arasındaki DH - <code>ee</code> - Alice&rsquo;in geçici anahtarı ile Bob&rsquo;un geçici anahtarı arasındaki DH - <code>se</code> - Bob&rsquo;un statik anahtarı ile Alice&rsquo;in geçici anahtarı arasındaki DH</p>
<h3 id="noise-güvenlik-özellikleri">Noise Güvenlik Özellikleri</h3>
<p>Noise terminolojisini kullanarak, IK pattern (IK kalıbı) şunları sağlar:</p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Message</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Authentication Level</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Confidentiality Level</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Message&nbsp;1 (NS)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;1 (sender auth, KCI vulnerable)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;2 (weak forward secrecy)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Message&nbsp;2 (NSR)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;2 (mutual auth)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;4 (weak forward secrecy)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Transport (ES)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;2 (mutual auth)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;5 (strong forward secrecy)</td>
    </tr>
  </tbody>
</table>
**Kimlik Doğrulama Düzeyleri:** - **Düzey 1**: Yükün, gönderenin statik anahtarının sahibine ait olduğu doğrulanır, ancak Key Compromise Impersonation (KCI) (anahtar ele geçirilmesiyle kimliğe bürünme) saldırılarına karşı savunmasızdır - **Düzey 2**: NSR sonrasında KCI saldırılarına karşı dayanıklı
<p><strong>Gizlilik Seviyeleri:</strong> - <strong>Seviye 2</strong>: Göndericinin statik anahtarı daha sonra ele geçirilirse ileri gizlilik - <strong>Seviye 4</strong>: Göndericinin geçici anahtarı daha sonra ele geçirilirse ileri gizlilik - <strong>Seviye 5</strong>: Her iki geçici anahtar da silindikten sonra tam ileri gizlilik</p>
<h3 id="ik-noise-protokolünde-el-sıkışma-kalıbı-ile-xk-noise-protokolünde-el-sıkışma-kalıbı-arasındaki-farklar">IK (Noise protokolünde el sıkışma kalıbı) ile XK (Noise protokolünde el sıkışma kalıbı) Arasındaki Farklar</h3>
<p>IK pattern (IK deseni), NTCP2 ve SSU2&rsquo;de kullanılan XK pattern (XK deseni) ile farklılık gösterir:</p>
<ol>
<li><strong>Dört DH İşlemi</strong>: IK, 4 DH işlemi (es, ss, ee, se) kullanır; XK için sayı 3&rsquo;tür</li>
<li><strong>Anında Kimlik Doğrulama</strong>: Alice’nin kimliği ilk mesajda doğrulanır (Kimlik Doğrulama Düzeyi 1)</li>
<li><strong>Daha Hızlı İleri Gizlilik</strong>: Tam ileri gizlilik (Düzey 5), ikinci mesajdan sonra (1-RTT) sağlanır</li>
<li><strong>Ödün</strong>: İlk mesajın yükü ileri gizliliğe sahip değildir (XK&rsquo;de tüm yükler ileri gizliliğe sahiptir)</li>
</ol>
<p><strong>Özet</strong>: IK (Noise IK deseni), Bob&rsquo;un yanıtının 1-RTT (tek gidiş-dönüş süresi) içinde tam ileri gizlilikle iletilmesini mümkün kılar; bunun bedeli olarak, ilk isteğin ileri gizlilik sağlamamasıdır.</p>
<h3 id="signal-double-ratchet-çift-mandallı-anahtar-yenileme-mekanizması-kavramları">Signal Double Ratchet (çift mandallı anahtar yenileme mekanizması) Kavramları</h3>
<p>ECIES, <a href="https://signal.org/docs/specifications/doubleratchet/">Signal Double Ratchet Algorithm</a>
 kavramlarını benimser:</p>
<ul>
<li><strong>DH Mandalı</strong>: Yeni DH anahtarlarını periyodik olarak değiş tokuş ederek ileri gizlilik sağlar</li>
<li><strong>Simetrik Anahtar Mandalı</strong>: Her mesaj için yeni oturum anahtarları türetir</li>
<li><strong>Oturum Etiketi Mandalı</strong>: Tek kullanımlık oturum etiketlerini deterministik olarak üretir</li>
</ul>
<p><strong>Signal&rsquo;dan Temel Farklar:</strong> - <strong>Daha Seyrek Ratcheting</strong>: (ratchet/mandal mekanizması) I2P yalnızca gerektiğinde ratchet uygular (etiket tükenmesine yaklaşıldığında veya politikaya göre) - <strong>Başlık Şifrelemesi Yerine Oturum Etiketleri</strong>: Şifrelenmiş başlıklar yerine deterministik etiketler kullanır - <strong>Açık ACK&rsquo;ler</strong>: (onay) Yalnızca ters trafiğe güvenmek yerine bant içi ACK bloklarını kullanır - <strong>Ayrı Etiket ve Anahtar Ratchet&rsquo;leri</strong>: Alıcı için daha verimlidir (anahtar hesaplamasını erteleyebilir)</p>
<h3 id="noise-kriptografik-protokol-çerçevesi-için-i2p-uzantıları">Noise (kriptografik protokol çerçevesi) için I2P Uzantıları</h3>
<hr>
<h2 id="kriptografik-ilkel-yapılar">Kriptografik İlkel Yapılar</h2>
<h3 id="x25519-diffie-hellman">X25519 Diffie-Hellman</h3>
<p><strong>Belirtim</strong>: <a href="https://tools.ietf.org/html/rfc7748">RFC 7748</a>
</p>
<p><strong>Anahtar Özellikleri:</strong> - <strong>Özel Anahtar Boyutu</strong>: 32 bayt - <strong>Açık Anahtar Boyutu</strong>: 32 bayt - <strong>Paylaşılan Sır Boyutu</strong>: 32 bayt - <strong>Endianness (bayt sıralaması)</strong>: Little-endian - <strong>Eğri</strong>: Curve25519</p>
<p><strong>İşlemler:</strong></p>
<h3 id="x25519-generate_private">X25519 GENERATE_PRIVATE()</h3>
<p>Rastgele 32 baytlık bir özel anahtar oluşturur:</p>
<pre tabindex="0"><code>privkey = CSRNG(32)
</code></pre><h3 id="x25519-derive_publicprivkey">X25519 DERIVE_PUBLIC(privkey)</h3>
<p>İlgili açık anahtarı türetir:</p>
<pre tabindex="0"><code>pubkey = curve25519_scalarmult_base(privkey)
</code></pre><p>32 baytlık little-endian (küçük uçlu bayt sıralaması) açık anahtarı döndürür.</p>
<h3 id="x25519-dhprivkey-pubkey">X25519 DH(privkey, pubkey)</h3>
<p>Diffie-Hellman anahtar değişimini gerçekleştirir:</p>
<pre tabindex="0"><code>sharedSecret = curve25519_scalarmult(privkey, pubkey)
</code></pre><p>32 bayt uzunluğunda bir paylaşılan sır döndürür.</p>
<p><strong>Güvenlik Notu</strong>: Uygulayıcılar, paylaşılan sırrın tamamının sıfırlardan oluşmadığını doğrulamalıdır (zayıf anahtar). Bu gerçekleşirse reddedin ve el sıkışmayı sonlandırın.</p>
<h3 id="chacha20-poly1305-aead-ilişkili-verili-kimlik-doğrulamalı-şifreleme">ChaCha20-Poly1305 AEAD (İlişkili Verili Kimlik Doğrulamalı Şifreleme)</h3>
<p><strong>Belirtim</strong>: <a href="https://tools.ietf.org/html/rfc7539">RFC 7539</a>
 bölüm 2.8</p>
<p><strong>Parametreler:</strong> - <strong>Anahtar Boyutu</strong>: 32 bayt (256 bit) - <strong>Nonce Boyutu</strong> (tek kullanımlık sayı): 12 bayt (96 bit) - <strong>MAC Boyutu</strong>: 16 bayt (128 bit) - <strong>Blok Boyutu</strong>: 64 bayt (dahili)</p>
<p><strong>Nonce (tek seferlik sayı) Biçimi:</strong></p>
<pre tabindex="0"><code>Byte 0-3:   0x00 0x00 0x00 0x00  (always zero)
Byte 4-11:  Little-endian counter (message number N)
</code></pre><p><strong>AEAD (İlişkili Verili Kimlik Doğrulamalı Şifreleme) Kurgusu:</strong></p>
<p>AEAD (kimlik doğrulamalı şifreleme ve ilişkili veriler), ChaCha20 akış şifreleyicisini Poly1305 MAC (mesaj doğrulama kodu) ile birleştirir:</p>
<ol>
<li>Anahtar ve nonce (tek-kullanımlık sayı) kullanarak ChaCha20 anahtar akışını üretin</li>
<li>Açık metni anahtar akışıyla XOR işlemi uygulayarak şifreleyin</li>
<li>Poly1305 MAC (ileti kimlik doğrulama kodu) değerini (ilişkili veri || şifreli metin) üzerinde hesaplayın</li>
<li>Şifreli metne 16 baytlık MAC ekleyin</li>
</ol>
<h3 id="chacha20-poly1305-encryptk-n-plaintext-ad">ChaCha20-Poly1305 ENCRYPT(k, n, plaintext, ad)</h3>
<p>Düz metni kimlik doğrulamalı olarak şifreler:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Inputs</span>
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span><span style="color:#f92672">-</span>byte cipher key
</span></span><span style="display:flex;"><span>n <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span><span style="color:#f92672">-</span>byte nonce (first <span style="color:#ae81ff">4</span> bytes zero, last <span style="color:#ae81ff">8</span> bytes <span style="color:#f92672">=</span> message number)
</span></span><span style="display:flex;"><span>plaintext <span style="color:#f92672">=</span> data to encrypt (<span style="color:#ae81ff">0</span> to <span style="color:#ae81ff">65519</span> bytes)
</span></span><span style="display:flex;"><span>ad <span style="color:#f92672">=</span> associated data (optional, used <span style="color:#f92672">in</span> MAC calculation)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Output</span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> chacha20_encrypt(k, n, plaintext)
</span></span><span style="display:flex;"><span>mac <span style="color:#f92672">=</span> poly1305(ad <span style="color:#f92672">||</span> ciphertext, poly1305_key_gen(k, n))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> ciphertext <span style="color:#f92672">||</span> mac  <span style="color:#75715e"># Total length = len(plaintext) + 16</span>
</span></span></code></pre></div><p><strong>Özellikler:</strong> - Şifreli metin, açık metinle aynı uzunluktadır (akış şifresi) - Çıktı plaintext_length + 16 bayttır (MAC dahildir) - Anahtar gizliyse, tüm çıktı rastgele veriden ayırt edilemez - MAC hem ilişkili veriyi hem de şifreli metni doğrular</p>
<h3 id="chacha20-poly1305-şifre-çözk-n-ciphertext-ad">ChaCha20-Poly1305 ŞİFRE ÇÖZ(k, n, ciphertext, ad)</h3>
<p>Şifresini çözer ve kimlik doğrulamasını doğrular:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Split ciphertext and MAC</span>
</span></span><span style="display:flex;"><span>ct_without_mac <span style="color:#f92672">=</span> ciphertext[<span style="color:#ae81ff">0</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>received_mac <span style="color:#f92672">=</span> ciphertext[<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Verify MAC</span>
</span></span><span style="display:flex;"><span>expected_mac <span style="color:#f92672">=</span> poly1305(ad <span style="color:#f92672">||</span> ct_without_mac, poly1305_key_gen(k, n))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> constant_time_compare(received_mac, expected_mac):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> AuthenticationError(<span style="color:#e6db74">&#34;MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Decrypt</span>
</span></span><span style="display:flex;"><span>plaintext <span style="color:#f92672">=</span> chacha20_decrypt(k, n, ct_without_mac)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> plaintext
</span></span></code></pre></div><p><strong>Kritik Güvenlik Gereksinimleri:</strong> - Nonces (tek seferlik değer) aynı anahtarla gönderilen her mesaj için MUTLAKA benzersiz olmalıdır - Nonces KESİNLİKLE yeniden kullanılmamalıdır (yeniden kullanılırsa felaket niteliğinde bir başarısızlık) - MAC doğrulaması zamanlama saldırılarını önlemek için sabit zamanlı karşılaştırma MUTLAKA kullanmalıdır - Başarısız MAC doğrulaması, mesajın tamamen reddedilmesiyle MUTLAKA sonuçlanmalıdır (kısmi şifre çözme yok)</p>
<h3 id="sha-256-özet-fonksiyonu">SHA-256 Özet Fonksiyonu</h3>
<p><strong>Belirtim</strong>: NIST FIPS 180-4</p>
<p><strong>Özellikler:</strong> - <strong>Çıktı Boyutu</strong>: 32 bayt (256 bit) - <strong>Blok Boyutu</strong>: 64 bayt (512 bit) - <strong>Güvenlik Seviyesi</strong>: 128 bit (çakışma direnci)</p>
<p><strong>İşlemler:</strong></p>
<h3 id="sha-256-hp-d">SHA-256 H(p, d)</h3>
<p>Kişiselleştirme dizesiyle SHA-256 özeti:</p>
<pre tabindex="0"><code>H(p, d) := SHA256(p || d)
</code></pre><p>Burada <code>||</code> birleştirmeyi ifade eder, <code>p</code> kişiselleştirme dizesidir, <code>d</code> veridir.</p>
<h3 id="sha-256-mixhashd">SHA-256 MixHash(d)</h3>
<p>Çalışan karma değerini yeni verilerle günceller:</p>
<pre tabindex="0"><code>h = SHA256(h || d)
</code></pre><p>Noise el sıkışması boyunca transkript karmasını sürdürmek için kullanılır.</p>
<h3 id="hkdf-anahtar-türetimi">HKDF Anahtar Türetimi</h3>
<p><strong>Spesifikasyon</strong>: <a href="https://tools.ietf.org/html/rfc5869">RFC 5869</a>
</p>
<p><strong>Açıklama</strong>: HMAC tabanlı, SHA-256 kullanan anahtar türetme fonksiyonu</p>
<p><strong>Parametreler:</strong> - <strong>Karma Fonksiyonu</strong>: HMAC-SHA256 - <strong>Tuz Uzunluğu</strong>: En fazla 32 bayt (SHA-256 çıktı boyutu) - <strong>Çıktı Uzunluğu</strong>: Değişken (en fazla 255 * 32 bayt)</p>
<p><strong>HKDF Fonksiyonu:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">HKDF</span>(salt, ikm, info, length):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        salt: Salt value (32 bytes max for SHA-256)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ikm: Input key material (any length)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        info: Context-specific info string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        length: Desired output length in bytes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        output: Derived key material (length bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract phase</span>
</span></span><span style="display:flex;"><span>    prk <span style="color:#f92672">=</span> HMAC<span style="color:#f92672">-</span>SHA256(salt, ikm)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Expand phase</span>
</span></span><span style="display:flex;"><span>    n <span style="color:#f92672">=</span> ceil(length <span style="color:#f92672">/</span> <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    okm <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, n <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> HMAC<span style="color:#f92672">-</span>SHA256(prk, t <span style="color:#f92672">||</span> info <span style="color:#f92672">||</span> byte(i))
</span></span><span style="display:flex;"><span>        okm <span style="color:#f92672">=</span> okm <span style="color:#f92672">||</span> t
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> okm[<span style="color:#ae81ff">0</span>:length]
</span></span></code></pre></div><p><strong>Yaygın Kullanım Kalıpları:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate two keys (64 bytes total)</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret, <span style="color:#e6db74">&#34;KDFDHRatchetStep&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>nextRootKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate session tag (8 bytes)</span>
</span></span><span style="display:flex;"><span>tagdata <span style="color:#f92672">=</span> HKDF(chainKey, CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>nextChainKey <span style="color:#f92672">=</span> tagdata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>sessionTag <span style="color:#f92672">=</span> tagdata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate symmetric key (32 bytes)</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>nextChainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>sessionKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span></code></pre></div><p><strong>ECIES&rsquo;de Kullanılan Bilgi Dizeleri:</strong> - <code>&quot;KDFDHRatchetStep&quot;</code> - DH ratchet (kademeli anahtar yenileme mekanizması) için anahtar türetimi - <code>&quot;TagAndKeyGenKeys&quot;</code> - Etiket ve anahtar zinciri anahtarlarının başlatılması - <code>&quot;STInitialization&quot;</code> - Oturum etiketi ratchet başlatılması - <code>&quot;SessionTagKeyGen&quot;</code> - Oturum etiketi üretimi - <code>&quot;SymmetricRatchet&quot;</code> - Simetrik anahtar üretimi - <code>&quot;XDHRatchetTagSet&quot;</code> - DH ratchet etiket kümesi anahtarı - <code>&quot;SessionReplyTags&quot;</code> - NSR etiket kümesi üretimi - <code>&quot;AttachPayloadKDF&quot;</code> - NSR payload (yük) anahtar türetimi</p>
<h3 id="elligator2-kodlaması">Elligator2 Kodlaması</h3>
<p><strong>Amaç</strong>: X25519 açık anahtarlarını, 32 baytlık eş-dağılımlı rastgele bayt dizilerinden ayırt edilemez olacak şekilde kodlamak.</p>
<p><strong>Spesifikasyon</strong>: <a href="https://elligator.cr.yp.to/elligator-20130828.pdf">Elligator2 Makalesi</a>
</p>
<p><strong>Sorun</strong>: Standart X25519 açık anahtarları tanınabilir bir yapıya sahiptir. Bir gözlemci, içerik şifrelenmiş olsa bile, bu anahtarları tespit ederek el sıkışma mesajlarını belirleyebilir.</p>
<p><strong>Çözüm</strong>: Elligator2, geçerli X25519 açık anahtarlarının yaklaşık %50&rsquo;si ile rastgele görünümlü 254 bitlik bit dizileri arasında bijektif bir eşleme sağlar.</p>
<p><strong>Elligator2 (kriptografik bir eşleme tekniği) ile Anahtar Üretimi:</strong></p>
<h3 id="elligator2-generate_private_elg2">Elligator2 GENERATE_PRIVATE_ELG2()</h3>
<p>Elligator2 (gizleme amaçlı bir kodlama yöntemi) ile kodlanabilir bir genel anahtara karşılık gelen bir özel anahtar üretir:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>    privkey <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    pubkey <span style="color:#f92672">=</span> DERIVE_PUBLIC(privkey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Test if public key is Elligator2-encodable</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        encoded <span style="color:#f92672">=</span> ENCODE_ELG2(pubkey)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Success - this key pair is suitable</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> privkey
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> NotEncodableError:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Try again with new random key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>
</span></span></code></pre></div><p><strong>Önemli</strong>: Rastgele oluşturulan özel anahtarların yaklaşık %50&rsquo;si kodlanamayan açık anahtarlar üretir. Bunlar atılmalı ve yeniden oluşturma denenmelidir.</p>
<p><strong>Performans Optimizasyonu</strong>: El sıkışma sırasında gecikmeleri önlemek için uygun anahtar çiftlerinden oluşan bir havuzu koruyacak şekilde anahtarları arka plan iş parçacığında önceden oluşturun.</p>
<h3 id="elligator2-elliptik-eğri-nokta-kodlama-yöntemi-encode_elg2pubkey">Elligator2 (elliptik eğri nokta kodlama yöntemi) ENCODE_ELG2(pubkey)</h3>
<p>Bir açık anahtarı rastgele görünümlü 32 bayta kodlar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ENCODE_ELG2</span>(pubkey):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Encodes X25519 public key using Elligator2.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pubkey: 32-byte X25519 public key (little-endian)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        encoded: 32-byte encoded key indistinguishable from random
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Raises:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        NotEncodableError: If pubkey cannot be encoded
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform Elligator2 representative calculation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Returns 254-bit value (31.75 bytes)</span>
</span></span><span style="display:flex;"><span>    encodedKey <span style="color:#f92672">=</span> elligator2_encode(pubkey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Add 2 random bits to MSB to make full 32 bytes</span>
</span></span><span style="display:flex;"><span>    randomByte <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    encodedKey[<span style="color:#ae81ff">31</span>] <span style="color:#f92672">|=</span> (randomByte <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xc0</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> encodedKey
</span></span></code></pre></div><p><strong>Kodlama Ayrıntıları:</strong> - Elligator2 254 bit üretir (tam 256 değil) - 31. baytın en anlamlı 2 biti rastgele dolgudur - Sonuç 32 baytlık uzayda uniform dağılımlıdır - Geçerli X25519 açık anahtarlarının yaklaşık %50&rsquo;sini başarıyla kodlar</p>
<h3 id="elligator2-decode_elg2encodedkey">Elligator2 DECODE_ELG2(encodedKey)</h3>
<p>Orijinal açık anahtara geri çözülür:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">DECODE_ELG2</span>(encodedKey):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Decodes Elligator2-encoded key back to X25519 public key.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        encodedKey: 32-byte encoded key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pubkey: 32-byte X25519 public key (little-endian)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Mask out 2 random padding bits from MSB</span>
</span></span><span style="display:flex;"><span>    encodedKey[<span style="color:#ae81ff">31</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0x3f</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform Elligator2 representative inversion</span>
</span></span><span style="display:flex;"><span>    pubkey <span style="color:#f92672">=</span> elligator2_decode(encodedKey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pubkey
</span></span></code></pre></div><p><strong>Güvenlik Özellikleri:</strong> - Kodlanmış anahtarlar, hesaplama bakımından rastgele baytlardan ayırt edilemez - Hiçbir istatistiksel test, Elligator2 ile kodlanmış anahtarları güvenilir biçimde tespit edemez - Kod çözme deterministiktir (aynı kodlanmış anahtar her zaman aynı açık anahtarı üretir) - Kodlama, kodlanabilir altkümedeki anahtarların ~50%&lsquo;si için bijektiftir</p>
<p><strong>Uygulama Notları:</strong> - El sıkışma sırasında yeniden kodlamayı önlemek için kodlanmış anahtarları oluşturma aşamasında saklayın - Elligator2 (eliptik eğri anahtarlarını rastgele görünümlü baytlara eşleyen bir gizleme tekniği) üretiminden çıkan uygun olmayan anahtarlar, NTCP2 için kullanılabilir (Elligator2 gerektirmez) - Arka planda anahtar oluşturma, performans için kritik önemdedir - Ortalama oluşturma süresi, %50 reddedilme oranı nedeniyle iki katına çıkar</p>
<hr>
<h2 id="mesaj-biçimleri">Mesaj Biçimleri</h2>
<h3 id="genel-bakış-1">Genel Bakış</h3>
<p>ECIES (Eliptik Eğri Tümleşik Şifreleme Şeması) üç mesaj türü tanımlar:</p>
<ol>
<li><strong>New Session (NS)</strong>: Alice&rsquo;den Bob&rsquo;a gönderilen ilk el sıkışma mesajı</li>
<li><strong>New Session Reply (NSR)</strong>: Bob&rsquo;un Alice&rsquo;e el sıkışma yanıtı</li>
<li><strong>Existing Session (ES)</strong>: Her iki yönde de bundan sonraki tüm mesajlar</li>
</ol>
<p>Tüm mesajlar, ek şifreleme katmanlarıyla birlikte I2NP Garlic Message (I2NP &lsquo;Garlic Message&rsquo; mesaj biçimi) içinde kapsüllenir.</p>
<h3 id="i2np-garlic-mesaj-kapsayıcısı-garlic-i2pde-kullanılan-birden-fazla-mesajı-demetleme-tekniği">I2NP Garlic Mesaj Kapsayıcısı (garlic: I2P&rsquo;de kullanılan, birden fazla mesajı demetleme tekniği)</h3>
<p>Tüm ECIES (Eliptik Eğri Tabanlı Entegre Şifreleme Şeması) mesajları, standart I2NP Garlic Message başlıklarıyla kapsüllenir:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|type|      msg_id       |  expiration   |
+----+----+----+----+----+----+----+----+
                         |  size   |chks|
+----+----+----+----+----+----+----+----+
|      length       |                   |
+----+----+----+----+                   +
|          encrypted data               |
~                                       ~
</code></pre><p><strong>Alanlar:</strong> - <code>type</code>: 0x26 (Garlic Message - I2P&rsquo;de özel bir mesaj türü) - <code>msg_id</code>: 4 baytlık I2NP mesaj kimliği - <code>expiration</code>: 8 baytlık Unix zaman damgası (milisaniye cinsinden) - <code>size</code>: 2 baytlık yük boyutu - <code>chks</code>: 1 baytlık sağlama toplamı - <code>length</code>: 4 baytlık şifrelenmiş veri uzunluğu - <code>encrypted data</code>: ECIES ile şifrelenmiş yük</p>
<p><strong>Amaç</strong>: I2NP katmanında mesaj tanımlama ve yönlendirme sağlar. <code>length</code> alanı, alıcıların toplam şifrelenmiş yük boyutunu bilmelerine olanak tanır.</p>
<h3 id="yeni-oturum-ns-mesajı">Yeni Oturum (NS) Mesajı</h3>
<p>New Session mesajı, Alice&rsquo;ten Bob&rsquo;a yeni bir oturum başlatır. Üç varyantı vardır:</p>
<ol>
<li><strong>Bağlama ile</strong> (1b): Çift yönlü iletişim için Alice&rsquo;in statik anahtarını içerir</li>
<li><strong>Bağlama olmadan</strong> (1c): Tek yönlü iletişim için statik anahtarı kullanmaz</li>
<li><strong>Tek Seferlik</strong> (1d): Oturum kurulumu olmadan tek mesaj kipi</li>
</ol>
<h3 id="bağlama-içeren-ns-mesajı-tip-1b">Bağlama içeren NS Mesajı (Tip 1b)</h3>
<p><strong>Kullanım durumu</strong>: Akış, yanıtlanabilir datagramlar, yanıt gerektiren herhangi bir protokol</p>
<p><strong>Toplam Uzunluk</strong>: 96 + payload_length bayt</p>
<p><strong>Biçim</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+                                       +
|   New Session Ephemeral Public Key    |
+             32 bytes                  +
|     Encoded with Elligator2           |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+         Static Key Section            +
|       ChaCha20 encrypted data         |
+            32 bytes                   +
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+    (MAC) for Static Key Section       +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for Payload Section     +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Alan Ayrıntıları:</strong></p>
<p><strong>Geçici Açık Anahtar</strong> (32 bayt, açık metin): - Alice&rsquo;in tek kullanımlık X25519 açık anahtarı - Elligator2 ile kodlanmıştır (rastgele veriden ayırt edilemez) - Her NS mesajı için yeni üretilir (asla yeniden kullanılmaz) - Little-endian format (en düşük anlamlı bayt önce)</p>
<p><strong>Statik Anahtar Bölümü</strong> (32 bayt şifreli, MAC ile 48 bayt): - Alice&rsquo;in X25519 statik açık anahtarını (32 bayt) içerir - ChaCha20 ile şifrelenir - Poly1305 MAC (16 bayt) ile doğrulanır - Bob tarafından oturumu Alice&rsquo;in hedefine bağlamak için kullanılır</p>
<p><strong>Payload Bölümü</strong> (değişken uzunlukta şifrelenmiş, +16 bayt MAC): - Garlic Clove (garlic şifrelemesindeki alt-mesaj) öğelerini ve diğer blokları içerir - İlk blok olarak DateTime bloğunu içermelidir - Genellikle uygulama verisi içeren Garlic Clove bloklarını içerir - Anında ratchet (anahtar yenilemesi) için NextKey bloğunu içerebilir - ChaCha20 ile şifrelenir - Poly1305 MAC (16 bayt) ile doğrulanır</p>
<p><strong>Güvenlik Özellikleri:</strong> - Geçici anahtar ileri gizlilik bileşeni sağlar - Statik anahtar, Alice&rsquo;i kimlik doğrular (hedefe bağlayarak) - Her iki bölüm de alan ayrımı için ayrı MAC&rsquo;lere sahiptir - Tüm el sıkışması 2 DH (Diffie-Hellman) işlemi gerçekleştirir (es, ss)</p>
<h3 id="bağlama-olmadan-ns-mesajı-tür-1c">Bağlama olmadan NS mesajı (Tür 1c)</h3>
<p><strong>Kullanım Senaryosu</strong>: Yanıtın beklenmediği veya istenmediği ham datagramlar</p>
<p><strong>Toplam Uzunluk</strong>: 96 + payload_length bayt</p>
<p><strong>Biçim</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+                                       +
|   New Session Ephemeral Public Key    |
+             32 bytes                  +
|     Encoded with Elligator2           |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+           Flags Section               +
|       ChaCha20 encrypted data         |
+            32 bytes                   +
|           All zeros                   |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for above section       +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for Payload Section     +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Temel Fark</strong>: Bayraklar Bölümü, statik anahtar yerine 32 bayt sıfır içerir.</p>
<p><strong>Algılama</strong>: Bob, 32 baytlık bölümü şifresini çözerek ve tüm baytların sıfır olup olmadığını kontrol ederek mesaj türünü belirler: - Tümü sıfır → Bağlı olmayan oturum (type 1c) - Sıfır olmayan → Statik anahtarlı bağlı oturum (type 1b)</p>
<p><strong>Özellikler:</strong> - Statik anahtar olmaması, Alice&rsquo;in hedefiyle kriptografik bir bağ kurulmadığı anlamına gelir - Bob yanıt gönderemez (bilinen bir hedef yok) - Yalnızca 1 DH (Diffie-Hellman) işlemi gerçekleştirir - Noise &ldquo;N&rdquo; örüntüsünü &ldquo;IK&rdquo; yerine izler - Yanıtların hiç gerekmediği durumlarda daha verimlidir</p>
<p><strong>Flags Section</strong> (gelecekte kullanım için ayrılmış): Şu anda tamamı sıfır. Gelecek sürümlerde özellik müzakeresi için kullanılabilir.</p>
<h3 id="ns-tek-seferlik-mesaj-tür-1d">NS Tek Seferlik Mesaj (Tür 1d)</h3>
<p><strong>Kullanım Senaryosu</strong>: Oturum veya yanıt beklenmeyen tek bir anonim mesaj</p>
<p><strong>Toplam Uzunluk</strong>: 96 + payload_length bayt</p>
<p><strong>Biçim</strong>: Bağlama olmadan NS ile aynıdır (tip 1c)</p>
<p><strong>Ayrım</strong>:  - Tip 1c aynı oturumda birden fazla mesaj gönderebilir (ES mesajları ardından gelir) - Tip 1d oturum kurulumu olmadan tam olarak bir mesaj gönderir - Uygulamada, gerçekleştirimler başlangıçta bunları aynı şekilde ele alabilir</p>
<p><strong>Özellikler:</strong> - Maksimum anonimlik (sabit anahtar yok, oturum yok) - Hiçbir taraf oturum durumunu tutmaz - Noise &ldquo;N&rdquo; desenini izler - Tek DH işlemi</p>
<h3 id="yeni-oturum-yanıtı-nsr-mesajı">Yeni Oturum Yanıtı (NSR) Mesajı</h3>
<p>Bob, Alice&rsquo;in NS mesajına yanıt olarak bir veya daha fazla NSR mesajı gönderir. NSR, Noise IK el sıkışmasını (Noise protokolünün IK kalıbı) tamamlar ve iki yönlü bir oturum kurar.</p>
<p><strong>Toplam Uzunluk</strong>: 72 + payload_length bayt</p>
<p><strong>Biçim</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|       Session Tag   8 bytes           |
+----+----+----+----+----+----+----+----+
|                                       |
+        Ephemeral Public Key           +
|                                       |
+            32 bytes                   +
|     Encoded with Elligator2           |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+  (MAC) for Key Section (empty)        +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for Payload Section     +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Alan Ayrıntıları:</strong></p>
<p><strong>Oturum Etiketi</strong> (8 bayt, açık metin): - NSR etiket kümesinden üretilir (bkz. KDF bölümleri) - Bu yanıtı Alice&rsquo;in NS mesajıyla ilişkilendirir - Alice&rsquo;in bu NSR&rsquo;nin hangi NS&rsquo;ye yanıt verdiğini belirlemesini sağlar - Tek seferlik kullanım (asla yeniden kullanılmaz)</p>
<p><strong>Geçici Açık Anahtar</strong> (32 bayt, açık metin): - Bob&rsquo;un tek kullanımlık X25519 açık anahtarı - Elligator2 ile kodlanmış - Her NSR mesajı için yeni üretilir - Gönderilen her NSR için farklı olmalıdır</p>
<p><strong>Key Section MAC</strong> (16 bayt): - Boş veriyi (ZEROLEN) kimlik doğrular - Noise IK protokolünün bir parçası (se pattern) - İlişkili veri olarak transkript karmasını kullanır - NSR&rsquo;nin NS&rsquo;ye bağlanması için kritiktir</p>
<p><strong>Yük Bölümü</strong> (değişken uzunlukta): - Garlic cloves (garlic mesajındaki tekil alt-iletiler) ve bloklar içerir - Genellikle uygulama katmanı yanıtlarını içerir - Boş olabilir (ACK-only NSR) - Maksimum boyut: 65519 bayt (65535 - 16 bayt MAC)</p>
<p><strong>Birden Çok NSR Mesajı:</strong></p>
<p>Bob, bir NS&rsquo;ye (istek mesajı) yanıt olarak birden fazla NSR (yanıt mesajı) gönderebilir: - Her NSR benzersiz bir geçici anahtara sahiptir - Her NSR benzersiz bir oturum etiketine sahiptir - Alice, el sıkışma işlemini tamamlamak için aldığı ilk NSR&rsquo;yi kullanır - Diğer NSR&rsquo;ler yedeklilik içindir (paket kaybı durumunda)</p>
<p><strong>Kritik Zamanlama:</strong> - Alice, ES mesajları göndermeden önce bir NSR almalıdır - Bob, ES mesajları göndermeden önce bir ES mesajı almalıdır - NSR, split() işlemi aracılığıyla çift yönlü oturum anahtarları kurar</p>
<p><strong>Güvenlik Özellikleri:</strong> - Noise IK el sıkışmasını tamamlar - 2 ek DH işlemi gerçekleştirir (ee, se) - NS+NSR genelinde toplam 4 DH işlemi - Karşılıklı kimlik doğrulamayı sağlar (Seviye 2) - NSR yükü için zayıf ileri gizlilik (Seviye 4) sağlar</p>
<h3 id="mevcut-oturum-es-mesajı">Mevcut Oturum (ES) Mesajı</h3>
<p>NS/NSR el sıkışmasından sonra tüm mesajlar Existing Session (mevcut oturum) formatını kullanır. ES mesajları hem Alice hem de Bob tarafından çift yönlü olarak kullanılır.</p>
<p><strong>Toplam Uzunluk</strong>: 8 + payload_length + 16 bayt (en az 24 bayt)</p>
<p><strong>Biçim</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|       Session Tag   8 bytes           |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+              (MAC)                    +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Alan Ayrıntıları:</strong></p>
<p><strong>Oturum Etiketi</strong> (8 bayt, açık metin): - Mevcut giden tagset (etiket kümesi) temel alınarak üretilir - Oturumu ve mesaj numarasını tanımlar - Alıcı, oturum anahtarını ve nonce (tek seferlik değer) bulmak için etiketi arar - Tek seferlik kullanım (her etiket tam olarak bir kez kullanılır) - Biçim: HKDF çıktısının ilk 8 baytı</p>
<p><strong>Yük Bölümü</strong> (değişken uzunlukta): - Garlic cloves (garlic encryption bağlamında &lsquo;clove&rsquo; olarak adlandırılan alt mesajlar) ve bloklar içerir - Gerekli blok yoktur (boş olabilir) - Yaygın bloklar: Garlic Clove, NextKey, ACK, ACK Request, Padding - Maksimum boyut: 65519 bayt (65535 - 16 bayt MAC)</p>
<p><strong>MAC</strong> (16 bayt): - Poly1305 kimlik doğrulama etiketi - Tüm yük üzerinde hesaplanır - İlişkili veri: 8 baytlık oturum etiketi - Doğrulaması başarılı olmalıdır; aksi halde ileti reddedilir</p>
<p><strong>Etiket Sorgulama Süreci:</strong></p>
<ol>
<li>Alıcı 8 baytlık etiketi çıkarır</li>
<li>Geçerli tüm gelen etiket kümelerinde etiketi arar</li>
<li>İlişkili oturum anahtarını ve mesaj numarası N&rsquo;yi alır</li>
<li>Nonce (tek kullanımlık sayı) oluşturur: <code>[0x00, 0x00, 0x00, 0x00, N (8 bytes little-endian)]</code></li>
<li>Etiketi ilişkili veri olarak kullanarak AEAD (İlişkili verili kimlik doğrulamalı şifreleme) ile yükün şifresini çözer</li>
<li>Etiketi etiket kümesinden kaldırır (tek kullanımlık)</li>
<li>Çözülmüş blokları işler</li>
</ol>
<p><strong>Oturum Etiketi Bulunamadı:</strong></p>
<p>Etiket herhangi bir tagset (etiket kümesi) içinde bulunamazsa: - NS mesajı olabilir → NS şifre çözmeyi dene - NSR mesajı olabilir → NSR şifre çözmeyi dene - Sıra dışı bir ES olabilir → tagset güncellemesi için kısa süre bekle - Yeniden oynatma saldırısı olabilir → reddet - Bozuk veri olabilir → reddet</p>
<p><strong>Boş Yük:</strong></p>
<p>ES mesajları boş yükler (0 bayt) içerebilir: - ACK Request alındığında açık bir ACK işlevi görür - Uygulama verisi olmadan protokol katmanı yanıtı sağlar - Yine de bir session tag (oturum etiketi) tüketir - Üst katmanın hemen gönderecek verisi olmadığında kullanışlıdır</p>
<p><strong>Güvenlik Özellikleri:</strong> - NSR alındıktan sonra tam ileri gizlilik (Seviye 5) - AEAD (ek verilerle kimlik doğrulamalı şifreleme) aracılığıyla kimliği doğrulanmış şifreleme - Etiket, ek ilişkili veri olarak işlev görür - Ratchet (anahtar ilerletme mekanizması) gerekli hale gelmeden önce etiket kümesi başına en fazla 65535 ileti</p>
<hr>
<h2 id="anahtar-türetme-fonksiyonları">Anahtar Türetme Fonksiyonları</h2>
<p>Bu bölüm, ECIES&rsquo;te kullanılan tüm KDF işlemlerini (anahtar türetme fonksiyonu) belgeler ve tam kriptografik türetimleri gösterir.</p>
<h3 id="notasyon-ve-sabitler">Notasyon ve Sabitler</h3>
<p><strong>Sabitler:</strong> - <code>ZEROLEN</code> - Sıfır uzunlukta bayt dizisi (boş dize) - <code>||</code> - Birleştirme işleci</p>
<p><strong>Değişkenler:</strong> - <code>h</code> - Transkriptin kümülatif özeti (32 bayt) - <code>chainKey</code> - HKDF için zincirleme anahtarı (32 bayt) - <code>k</code> - Simetrik şifreleme anahtarı (32 bayt) - <code>n</code> - Nonce (tek-kullanımlık sayı) / mesaj numarası</p>
<p><strong>Anahtarlar:</strong> - <code>ask</code> / <code>apk</code> - Alice&rsquo;in statik özel/açık anahtarı - <code>aesk</code> / <code>aepk</code> - Alice&rsquo;in geçici özel/açık anahtarı - <code>bsk</code> / <code>bpk</code> - Bob&rsquo;un statik özel/açık anahtarı - <code>besk</code> / <code>bepk</code> - Bob&rsquo;un geçici özel/açık anahtarı</p>
<h3 id="ns-mesajı-kdfleri-anahtar-türetme-fonksiyonları">NS Mesajı KDF&rsquo;leri (anahtar türetme fonksiyonları)</h3>
<h3 id="kdf-1-başlangıç-zincir-anahtarı">KDF 1: Başlangıç Zincir Anahtarı</h3>
<p>Protokol ilklendirmesinde bir kez yapılır (önceden hesaplanabilir):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Protocol name (40 bytes, ASCII, no null termination)</span>
</span></span><span style="display:flex;"><span>protocol_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Noise_IKelg2+hs2_25519_ChaChaPoly_SHA256&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(protocol_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize chaining key</span>
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># MixHash with empty prologue</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: chainKey and h initialized</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Can be precalculated for all outbound sessions</span>
</span></span></code></pre></div><p><strong>Sonuç:</strong> - <code>chainKey</code> = Tüm sonraki KDF&rsquo;ler (anahtar türetme fonksiyonları) için başlangıç zincirleme anahtarı - <code>h</code> = Başlangıç özet transkripti</p>
<h3 id="kdf-2-bobun-statik-anahtar-karıştırması">KDF 2: Bob&rsquo;un Statik Anahtar Karıştırması</h3>
<p>Bob bunu bir kez yapar (tüm gelen oturumlar için önceden hesaplanabilir):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Bob&#39;s static keys (published in LeaseSet)</span>
</span></span><span style="display:flex;"><span>bsk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>bpk <span style="color:#f92672">=</span> DERIVE_PUBLIC(bsk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix Bob&#39;s public key into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bpk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: h updated with Bob&#39;s identity</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Can be precalculated by Bob for all inbound sessions</span>
</span></span></code></pre></div><h3 id="kdf-3-alicenin-geçici-anahtar-üretimi">KDF 3: Alice&rsquo;nin Geçici Anahtar Üretimi</h3>
<p>Alice her NS message (NS mesajı) için yeni anahtarlar oluşturur:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate ephemeral key pair suitable for Elligator2</span>
</span></span><span style="display:flex;"><span>aesk <span style="color:#f92672">=</span> GENERATE_PRIVATE_ELG2()
</span></span><span style="display:flex;"><span>aepk <span style="color:#f92672">=</span> DERIVE_PUBLIC(aesk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ephemeral public key into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> aepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Elligator2 encode for transmission</span>
</span></span><span style="display:flex;"><span>elg2_aepk <span style="color:#f92672">=</span> ENCODE_ELG2(aepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: h updated with Alice&#39;s ephemeral key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send elg2_aepk as first 32 bytes of NS message</span>
</span></span></code></pre></div><h3 id="kdf-4-ns-statik-anahtar-bölümü-es-dh">KDF 4: NS Statik Anahtar Bölümü (es DH)</h3>
<p>Alice&rsquo;in statik anahtarını şifrelemek için anahtarlar türetir:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Perform first DH (ephemeral-static)</span>
</span></span><span style="display:flex;"><span>sharedSecret <span style="color:#f92672">=</span> DH(aesk, bpk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Equivalent: sharedSecret = DH(bsk, aepk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive cipher key from shared secret</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD encryption parameters</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> h  <span style="color:#75715e"># Current hash transcript</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt static key section</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> binding_requested:
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> apk  <span style="color:#75715e"># Alice&#39;s static public key (32 bytes)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> bytes(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># All zeros for unbound</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, plaintext, associated_data)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ciphertext = 32 bytes encrypted + 16 bytes MAC = 48 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ciphertext into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> ciphertext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Static key section encrypted, h updated</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext (48 bytes) as next part of NS message</span>
</span></span></code></pre></div><h3 id="kdf-anahtar-türetme-fonksiyonu-5-ns-payload-bölümü-ss-dh-yalnızca-bağlama-amaçlı">KDF (Anahtar Türetme Fonksiyonu) 5: NS Payload Bölümü (ss DH, yalnızca bağlama amaçlı)</h3>
<p>Bağlı oturumlarda, yükü şifrelemek için ikinci DH&rsquo;yi (Diffie-Hellman anahtar değişimi) gerçekleştirin:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> binding_requested:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice&#39;s static keys</span>
</span></span><span style="display:flex;"><span>    ask <span style="color:#f92672">=</span> GENERATE_PRIVATE()  <span style="color:#75715e"># Alice&#39;s long-term key</span>
</span></span><span style="display:flex;"><span>    apk <span style="color:#f92672">=</span> DERIVE_PUBLIC(ask)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform second DH (static-static)</span>
</span></span><span style="display:flex;"><span>    sharedSecret <span style="color:#f92672">=</span> DH(ask, bpk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Equivalent: sharedSecret = DH(bsk, apk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive cipher key</span>
</span></span><span style="display:flex;"><span>    keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>    k <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    associated_data <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Unbound: reuse keys from static key section</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># chainKey and k unchanged</span>
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># Increment nonce (reusing same key)</span>
</span></span><span style="display:flex;"><span>    associated_data <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt payload</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> build_payload()  <span style="color:#75715e"># DateTime + Garlic Cloves + etc.</span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, payload, associated_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ciphertext into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> ciphertext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Payload encrypted, h contains complete NS transcript</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Save chainKey and h for NSR processing</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext as final part of NS message</span>
</span></span></code></pre></div><p><strong>Önemli Notlar:</strong></p>
<ol>
<li>
<p><strong>Bound (bağlı) vs Unbound (bağsız)</strong>:</p>
<ul>
<li>Bound 2 DH işlemi gerçekleştirir (es + ss)</li>
<li>Unbound 1 DH işlemi gerçekleştirir (yalnızca es)</li>
<li>Unbound, yeni bir anahtar türetmek yerine nonce (tek kullanımlık sayı) değerini artırır</li>
</ul>
</li>
<li>
<p><strong>Anahtar Yeniden Kullanım Güvenliği</strong>:</p>
<ul>
<li>Farklı nonce&rsquo;lar (0 ve 1), anahtarın/nonce&rsquo;un yeniden kullanılmasını önler</li>
<li>Farklı ilişkili veriler (h farklı) alan ayrımı sağlar</li>
</ul>
</li>
<li>
<p><strong>Hash Transkripti</strong>:</p>
<ul>
<li><code>h</code> artık şunları içerir: protocol_name, empty prologue (önsöz), bpk, aepk, static_key_ciphertext, payload_ciphertext</li>
<li>Bu transkript, NS mesajının tüm parçalarını birbirine bağlar</li>
</ul>
</li>
</ol>
<h3 id="nsr-reply-tagset-kdf-yanıt-etiket-kümesi-için-anahtar-türetme-fonksiyonu">NSR Reply Tagset KDF (yanıt etiket kümesi için anahtar türetme fonksiyonu)</h3>
<p>Bob, NSR (bir mesaj türü) mesajları için etiketler oluşturur:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Chain key from NS payload section</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># chainKey = final chainKey from NS KDF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate tagset key</span>
</span></span><span style="display:flex;"><span>tagsetKey <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SessionReplyTags&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize NSR tagset (see DH_INITIALIZE below)</span>
</span></span><span style="display:flex;"><span>tagset_nsr <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, tagsetKey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get tag for this NSR</span>
</span></span><span style="display:flex;"><span>tagsetEntry <span style="color:#f92672">=</span> tagset_nsr<span style="color:#f92672">.</span>GET_NEXT_ENTRY()
</span></span><span style="display:flex;"><span>tag <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_TAG  <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: tag available for NSR message</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send tag as first 8 bytes of NSR</span>
</span></span></code></pre></div><h3 id="nsr-mesajı-kdfleri-anahtar-türetme-fonksiyonları">NSR Mesajı KDF&rsquo;leri (anahtar türetme fonksiyonları)</h3>
<h3 id="kdf-6-nsr-geçici-anahtar-üretimi">KDF 6: NSR Geçici Anahtar Üretimi</h3>
<p>Bob, her NSR için yeni bir geçici anahtar üretir:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Mix tag into hash (I2P extension to Noise)</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> tag)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate ephemeral key pair</span>
</span></span><span style="display:flex;"><span>besk <span style="color:#f92672">=</span> GENERATE_PRIVATE_ELG2()
</span></span><span style="display:flex;"><span>bepk <span style="color:#f92672">=</span> DERIVE_PUBLIC(besk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ephemeral public key into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Elligator2 encode for transmission</span>
</span></span><span style="display:flex;"><span>elg2_bepk <span style="color:#f92672">=</span> ENCODE_ELG2(bepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: h updated with tag and Bob&#39;s ephemeral key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send elg2_bepk as bytes 9-40 of NSR message</span>
</span></span></code></pre></div><h3 id="kdf-7-nsr-anahtar-bölümü-ee-ve-se-dh">KDF 7: NSR Anahtar Bölümü (ee ve se DH)</h3>
<p>NSR anahtar bölümü için anahtarlar türetir:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Perform third DH (ephemeral-ephemeral)</span>
</span></span><span style="display:flex;"><span>sharedSecret_ee <span style="color:#f92672">=</span> DH(aesk, bepk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Equivalent: sharedSecret_ee = DH(besk, aepk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ee into chain</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret_ee, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Perform fourth DH (static-ephemeral)</span>
</span></span><span style="display:flex;"><span>sharedSecret_se <span style="color:#f92672">=</span> DH(ask, bepk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Equivalent: sharedSecret_se = DH(besk, apk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive cipher key from se</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret_se, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD encryption of empty data (key section has no payload)</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, ZEROLEN, associated_data)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ciphertext = 16 bytes (MAC only, no plaintext)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ciphertext into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> ciphertext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Key section encrypted, chainKey contains all 4 DH results</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext (16 bytes MAC) as bytes 41-56 of NSR</span>
</span></span></code></pre></div><p><strong>Kritik</strong>: Bu, Noise IK el sıkışmasını tamamlar. <code>chainKey</code> artık 4 DH işleminin tümünden (es, ss, ee, se) gelen katkıları içerir.</p>
<h3 id="kdf-8-nsr-yük-bölümü">KDF 8: NSR Yük Bölümü</h3>
<p>NSR yükü şifrelemesi için anahtarlar türetir:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Split chainKey into bidirectional keys</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>k_ab <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]   <span style="color:#75715e"># Alice → Bob key</span>
</span></span><span style="display:flex;"><span>k_ba <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Bob → Alice key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize ES tagsets for both directions</span>
</span></span><span style="display:flex;"><span>tagset_ab <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ab)  <span style="color:#75715e"># Alice → Bob</span>
</span></span><span style="display:flex;"><span>tagset_ba <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ba)  <span style="color:#75715e"># Bob → Alice</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive NSR payload key (Bob → Alice)</span>
</span></span><span style="display:flex;"><span>k_nsr <span style="color:#f92672">=</span> HKDF(k_ba, ZEROLEN, <span style="color:#e6db74">&#34;AttachPayloadKDF&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt NSR payload</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> h  <span style="color:#75715e"># Binds payload to entire NSR</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> build_payload()  <span style="color:#75715e"># Usually application reply</span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_nsr, nonce, payload, associated_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Bidirectional ES sessions established</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tagset_ab and tagset_ba ready for ES messages</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext as bytes 57+ of NSR message</span>
</span></span></code></pre></div><p><strong>Önemli Notlar:</strong></p>
<ol>
<li>
<p><strong>Bölme İşlemi</strong>:</p>
<ul>
<li>Her yön için bağımsız anahtarlar oluşturur</li>
<li>Alice→Bob ve Bob→Alice yönleri arasında anahtarın yeniden kullanılmasını önler</li>
</ul>
</li>
<li>
<p><strong>NSR Yük Bağlama</strong>:</p>
<ul>
<li>Yükü el sıkışmaya bağlamak için ilişkili veri olarak <code>h</code> kullanır</li>
<li>Ayrı bir KDF (anahtar türetme fonksiyonu) (&ldquo;AttachPayloadKDF&rdquo;) alan ayrımı sağlar</li>
</ul>
</li>
<li>
<p><strong>ES (ES adlı mesaj) Hazırlığı</strong>:</p>
<ul>
<li>NSR (NSR adlı mesaj) sonrasında, her iki taraf da ES mesajları gönderebilir</li>
<li>Alice, ES göndermeden önce NSR almalıdır</li>
<li>Bob, ES göndermeden önce ES almalıdır</li>
</ul>
</li>
</ol>
<h3 id="es-mesaj-kdfleri-anahtar-türetme-fonksiyonları">ES Mesaj KDF&rsquo;leri (anahtar türetme fonksiyonları)</h3>
<p>ES iletileri, tagsets (etiket kümeleri) içindeki önceden oluşturulmuş oturum anahtarlarını kullanır:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Sender gets next tag and key</span>
</span></span><span style="display:flex;"><span>tagsetEntry <span style="color:#f92672">=</span> outbound_tagset<span style="color:#f92672">.</span>GET_NEXT_ENTRY()
</span></span><span style="display:flex;"><span>tag <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_TAG     <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_KEY       <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>N <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>INDEX             <span style="color:#75715e"># Message number</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Construct nonce (12 bytes)</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>] <span style="color:#f92672">+</span> little_endian_8_bytes(N)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD encryption</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> tag  <span style="color:#75715e"># Tag is associated data</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> build_payload()
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, payload, associated_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send: tag || ciphertext (8 + len(ciphertext) bytes)</span>
</span></span></code></pre></div><p><strong>Alıcı Süreci:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Extract tag</span>
</span></span><span style="display:flex;"><span>tag <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Look up tag in inbound tagsets</span>
</span></span><span style="display:flex;"><span>tagsetEntry <span style="color:#f92672">=</span> inbound_tagset<span style="color:#f92672">.</span>GET_SESSION_KEY(tag)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> tagsetEntry <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Not an ES message, try NS/NSR decryption</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> try_handshake_decryption(message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_KEY
</span></span><span style="display:flex;"><span>N <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>INDEX
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Construct nonce</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>] <span style="color:#f92672">+</span> little_endian_8_bytes(N)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD decryption</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> tag
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">8</span>:]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> DECRYPT(k, nonce, ciphertext, associated_data)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># MAC verification failed, reject message</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> reject_message()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Process payload blocks</span>
</span></span><span style="display:flex;"><span>process_payload(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remove tag from tagset (one-time use)</span>
</span></span><span style="display:flex;"><span>inbound_tagset<span style="color:#f92672">.</span>remove(tag)
</span></span></code></pre></div><h3 id="dh_initialize-fonksiyonu">DH_INITIALIZE Fonksiyonu</h3>
<p>Tek bir yön için bir tagset (etiket kümesi) oluşturur:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">DH_INITIALIZE</span>(rootKey, k):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Initializes a tagset with session tag and symmetric key ratchets.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rootKey: Chain key from previous DH ratchet (32 bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k: Key material from split() or DH ratchet (32 bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        tagset: Initialized tagset object
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive next root key and chain key</span>
</span></span><span style="display:flex;"><span>    keydata <span style="color:#f92672">=</span> HKDF(rootKey, k, <span style="color:#e6db74">&#34;KDFDHRatchetStep&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    nextRootKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>    chainKey_tagset <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive separate chain keys for tags and keys</span>
</span></span><span style="display:flex;"><span>    keydata <span style="color:#f92672">=</span> HKDF(chainKey_tagset, ZEROLEN, <span style="color:#e6db74">&#34;TagAndKeyGenKeys&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    sessTag_ck <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]   <span style="color:#75715e"># Session tag chain key</span>
</span></span><span style="display:flex;"><span>    symmKey_ck <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Symmetric key chain key</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create tagset object</span>
</span></span><span style="display:flex;"><span>    tagset <span style="color:#f92672">=</span> Tagset()
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>nextRootKey <span style="color:#f92672">=</span> nextRootKey
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>sessTag_chainKey <span style="color:#f92672">=</span> sessTag_ck
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>symmKey_chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>lastIndex <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tagset
</span></span></code></pre></div><p><strong>Kullanım Bağlamları:</strong></p>
<ol>
<li><strong>NSR Etiket Kümesi</strong>: <code>DH_INITIALIZE(chainKey_from_NS, tagsetKey_NSR)</code></li>
<li><strong>ES Etiket Kümeleri</strong>: <code>DH_INITIALIZE(chainKey_from_NSR, k_ab or k_ba)</code></li>
<li><strong>Ratcheted (kademeli) Etiket Kümeleri</strong>: <code>DH_INITIALIZE(nextRootKey_from_previous, tagsetKey_from_DH)</code></li>
</ol>
<hr>
<h2 id="ratchet-mekanizmaları-tek-yönlü-anahtar-yenileme-mekanizmaları">Ratchet Mekanizmaları (tek yönlü anahtar yenileme mekanizmaları)</h2>
<p>ECIES, ileri gizlilik ve verimli oturum yönetimi sağlamak için üç eşzamanlı ratchet (anahtar yenileme mekanizması) kullanır.</p>
<h3 id="ratchet-mandal-mekanizması-genel-bakış">Ratchet (mandal mekanizması) Genel Bakış</h3>
<p><strong>Üç Ratchet (ilerlemeli anahtar yenileme mekanizması) Türleri:</strong></p>
<ol>
<li><strong>DH Ratchet</strong> (tek yönlü anahtar yenileme mekanizması): Yeni kök anahtarlar üretmek için Diffie-Hellman anahtar değişimleri gerçekleştirir</li>
<li><strong>Session Tag Ratchet</strong>: Tek kullanımlık oturum etiketlerini belirlenimli olarak türetir</li>
<li><strong>Symmetric Key Ratchet</strong>: Mesaj şifrelemesi için oturum anahtarlarını türetir</li>
</ol>
<p><strong>İlişki:</strong></p>
<pre tabindex="0"><code>DH Ratchet (periodic)
    ↓
Creates new tagset
    ↓
Session Tag Ratchet (per message) ← synchronized → Symmetric Key Ratchet (per message)
    ↓                                                      ↓
Session Tags (8 bytes each)                      Session Keys (32 bytes each)
</code></pre><p><strong>Temel Özellikler:</strong></p>
<ul>
<li><strong>Gönderici</strong>: Etiketleri ve anahtarları talep üzerine üretir (depolama gerekmez)</li>
<li><strong>Alıcı</strong>: İleri bakış penceresi için etiketleri önceden üretir (depolama gerekir)</li>
<li><strong>Senkronizasyon</strong>: Etiket indeksi, anahtar indeksini belirler (N_tag = N_key)</li>
<li><strong>İleri Gizlilik</strong>: Periyodik DH ratchet (Diffie-Hellman temelli artımlı anahtar yenileme mekanizması) ile sağlanır</li>
<li><strong>Verimlilik</strong>: Alıcı, etiket alınana kadar anahtar hesaplamasını erteleyebilir</li>
</ul>
<h3 id="dh-ratchet-diffie-hellman-temelli-kademeli-anahtar-yenileme-mekanizması">DH Ratchet (Diffie-Hellman temelli kademeli anahtar yenileme mekanizması)</h3>
<p>DH ratchet (Diffie-Hellman tabanlı kademeli anahtar yenileme mekanizması), periyodik olarak yeni geçici anahtarlar değiş tokuş ederek ileri gizlilik sağlar.</p>
<h3 id="dh-ratchet-diffie-hellman-anahtar-yenileme-mekanizması-frekansı">DH Ratchet (Diffie-Hellman anahtar yenileme mekanizması) Frekansı</h3>
<p><strong>Gerekli Ratchet (adım adım anahtar yenileme mekanizması) Koşulları:</strong> - Etiket kümesi tükenmeye yaklaşıyor (azami etiket değeri 65535&rsquo;tir) - Uygulamaya özgü politikalar:   - Mesaj sayısı eşiği (örn. her 4096 mesajda bir)   - Zaman eşiği (örn. her 10 dakikada bir)   - Veri hacmi eşiği (örn. her 100 MB&rsquo;de bir)</p>
<p><strong>Önerilen İlk Ratchet (kademeli anahtar yenileme mekanizması)</strong>: Sınıra ulaşmamak için etiket numarası 4096 civarında</p>
<p><strong>Maksimum Değerler:</strong> - <strong>Maksimum tag set (etiket kümesi) kimliği</strong>: 65535 - <strong>Maksimum anahtar kimliği</strong>: 32767 - <strong>Tag set başına maksimum ileti</strong>: 65535 - <strong>Oturum başına teorik maksimum veri</strong>: ~6.9 TB (64K tag sets × 64K ileti × 1730 bayt ortalama)</p>
<h3 id="dh-ratchet-dh-ratchet-mekanizması-etiket-ve-anahtar-kimlikleri">DH Ratchet (DH &ldquo;ratchet&rdquo; mekanizması) Etiket ve Anahtar Kimlikleri</h3>
<p><strong>İlk Etiket Kümesi</strong> (el sıkışması sonrası): - Etiket kümesi kimliği: 0 - Henüz hiçbir NextKey bloğu gönderilmedi - Hiçbir anahtar kimliği atanmadı</p>
<p><strong>İlk Ratchet (kademeli anahtar yenileme mekanizması) Sonrası</strong>: - Etiket kümesi kimliği: 1 = (1 + Alice&rsquo;in anahtar kimliği + Bob&rsquo;un anahtar kimliği) = (1 + 0 + 0) - Alice, anahtar kimliği 0 olan NextKey (sonraki anahtar) gönderir - Bob, anahtar kimliği 0 olan NextKey ile yanıtlar</p>
<p><strong>Sonraki Etiket Kümeleri</strong>: - Etiket kümesi kimliği = 1 + gönderenin anahtar kimliği + alıcının anahtar kimliği - Örnek: Etiket kümesi 5 = (1 + sender_key_2 + receiver_key_2)</p>
<p><strong>Etiket Kümesi İlerleme Tablosu:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Tag Set ID</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Sender Key ID</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Receiver Key ID</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">n/a</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">n/a</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial tag set (post-NSR)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">First ratchet (both generate new keys)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Sender generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">3</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Receiver generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">4</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Sender generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">5</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Receiver generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">...</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">...</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">...</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Pattern repeats</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">65534</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32767 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32766</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Second-to-last tag set</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">65535</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32767</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32767 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Final tag set</td>
    </tr>
  </tbody>
</table>
\* = Yeni anahtar bu ratchet (kademeli anahtar yenileme mekanizması) sırasında üretildi
<p><strong>Anahtar Kimliği Kuralları:</strong> - Kimlikler 0&rsquo;dan başlayarak ardışık olarak verilir - Kimlikler yalnızca yeni bir anahtar oluşturulduğunda artar - Maksimum anahtar kimliği 32767&rsquo;dir (15 bit) - Anahtar kimliği 32767&rsquo;den sonra yeni oturum gereklidir</p>
<h3 id="dh-ratchet-kademeli-anahtar-yenileme-mekanizması-mesaj-akışı">DH Ratchet (kademeli anahtar yenileme mekanizması) Mesaj Akışı</h3>
<p><strong>Roller:</strong> - <strong>Tag Sender</strong> (Etiket Gönderici): giden etiket kümesine sahiptir, iletiler gönderir - <strong>Tag Receiver</strong> (Etiket Alıcı): gelen etiket kümesine sahiptir, iletiler alır</p>
<p><strong>Kalıp:</strong> Etiket göndericisi, etiket kümesi neredeyse tükendiğinde ratchet (aşamalı anahtar yenileme mekanizması) başlatır.</p>
<p><strong>Mesaj Akış Diyagramı:</strong></p>
<pre tabindex="0"><code>Tag Sender                         Tag Receiver

       ... using tag set #0 ...

(Tag set #0 approaching exhaustion)
(Generate new key #0)

NextKey forward, request reverse, with key #0  --------&gt;
(Repeat until NextKey ACK received)
                                   (Generate new key #0)
                                   (Perform DH: sender_key_0 × receiver_key_0)
                                   (Create inbound tag set #1)

        &lt;---------------           NextKey reverse, with key #0
                                   (Repeat until tag from tag set #1 received)

(Receive NextKey with key #0)
(Perform DH: sender_key_0 × receiver_key_0)
(Create outbound tag set #1)


       ... using tag set #1 ...


(Tag set #1 approaching exhaustion)
(Generate new key #1)

NextKey forward, with key #1        --------&gt;
(Repeat until NextKey ACK received)
                                   (Reuse existing key #0)
                                   (Perform DH: sender_key_1 × receiver_key_0)
                                   (Create inbound tag set #2)

        &lt;--------------            NextKey reverse, id 0 (ACK)
                                   (Repeat until tag from tag set #2 received)

(Receive NextKey with id 0)
(Perform DH: sender_key_1 × receiver_key_0)
(Create outbound tag set #2)


       ... using tag set #2 ...


(Tag set #2 approaching exhaustion)
(Reuse existing key #1)

NextKey forward, request reverse, id 1  --------&gt;
(Repeat until NextKey received)
                                   (Generate new key #1)
                                   (Perform DH: sender_key_1 × receiver_key_1)
                                   (Create inbound tag set #3)

        &lt;--------------            NextKey reverse, with key #1

(Receive NextKey with key #1)
(Perform DH: sender_key_1 × receiver_key_1)
(Create outbound tag set #3)


       ... using tag set #3 ...

       (Pattern repeats: even-numbered tag sets
        use forward key, odd-numbered use reverse key)
</code></pre><p><strong>Ratchet (mandal mekanizması) örüntüleri:</strong></p>
<p><strong>Çift Numaralı Etiket Kümeleri Oluşturma</strong> (2, 4, 6, &hellip;): 1. Gönderen yeni bir anahtar üretir 2. Gönderen yeni anahtar içeren NextKey bloğunu gönderir 3. Alıcı, eski anahtar kimliğiyle NextKey bloğunu gönderir (ACK) 4. Her ikisi de (yeni gönderen anahtarı × eski alıcı anahtarı) ile DH (Diffie-Hellman anahtar değişimi) gerçekleştirir</p>
<p><strong>Tek Sayılı Etiket Kümeleri Oluşturma</strong> (3, 5, 7, &hellip;): 1. Gönderici ters yöndeki anahtarı talep eder (istek bayrağı ile NextKey gönderir) 2. Alıcı yeni bir anahtar üretir 3. Alıcı yeni anahtarla NextKey bloğunu gönderir 4. Her ikisi de (eski gönderici anahtarı × yeni alıcı anahtarı) ile DH (Diffie-Hellman anahtar değişimi) gerçekleştirir</p>
<h3 id="nextkey-bir-sonraki-anahtar-blok-biçimi">NextKey (bir sonraki anahtar) Blok Biçimi</h3>
<p>Ayrıntılı NextKey (sonraki anahtar) blok belirtimi için Payload Format bölümüne bakın.</p>
<p><strong>Temel Öğeler:</strong> - <strong>Bayrak baytı</strong>:   - Bit 0: Anahtar mevcut (1) veya yalnızca kimlik (0)   - Bit 1: Reverse key (ters anahtar) (1) veya forward key (ileri anahtar) (0)   - Bit 2: reverse key talep et (1) veya talep yok (0) - <strong>Anahtar Kimliği</strong>: 2 bayt, big-endian (0-32767) - <strong>Açık Anahtar</strong>: 32 bayt X25519 (eğer bit 0 = 1 ise)</p>
<p><strong>Örnek NextKey Blocks (bir sonraki anahtar blokları):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Sender initiates ratchet with new key (key ID 0, tag set 1)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, pubkey<span style="color:#f92672">=</span>sender_key_0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver replies with new key (key ID 0, tag set 1)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, pubkey<span style="color:#f92672">=</span>receiver_key_0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sender ratchets again with new key (key ID 1, tag set 2)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, pubkey<span style="color:#f92672">=</span>sender_key_1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver ACKs with old key ID (tag set 2)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x02</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sender requests reverse key (tag set 3)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x04</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver sends new reverse key (key ID 1, tag set 3)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, pubkey<span style="color:#f92672">=</span>receiver_key_1)
</span></span></code></pre></div><h3 id="dh-ratchet-kdf-anahtar-türetme-fonksiyonu">DH Ratchet KDF (Anahtar Türetme Fonksiyonu)</h3>
<p>Yeni anahtarlar değiş tokuş edildiğinde:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Tag sender generates or reuses key</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> generating_new:
</span></span><span style="display:flex;"><span>    sender_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    sender_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(sender_sk)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Reuse existing key pair</span>
</span></span><span style="display:flex;"><span>    sender_pk <span style="color:#f92672">=</span> existing_sender_pk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag receiver generates or reuses key</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> generating_new:
</span></span><span style="display:flex;"><span>    receiver_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    receiver_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(receiver_sk)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Reuse existing key pair</span>
</span></span><span style="display:flex;"><span>    receiver_pk <span style="color:#f92672">=</span> existing_receiver_pk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Both parties perform DH</span>
</span></span><span style="display:flex;"><span>sharedSecret <span style="color:#f92672">=</span> DH(sender_sk, receiver_pk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive tagset key</span>
</span></span><span style="display:flex;"><span>tagsetKey <span style="color:#f92672">=</span> HKDF(sharedSecret, ZEROLEN, <span style="color:#e6db74">&#34;XDHRatchetTagSet&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get next root key from previous tagset</span>
</span></span><span style="display:flex;"><span>rootKey <span style="color:#f92672">=</span> previous_tagset<span style="color:#f92672">.</span>nextRootKey
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize new tagset</span>
</span></span><span style="display:flex;"><span>new_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(rootKey, tagsetKey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag sender: outbound tagset</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag receiver: inbound tagset</span>
</span></span></code></pre></div><p><strong>Kritik Zamanlama:</strong></p>
<p><strong>Etiket Gönderici:</strong> - Yeni giden etiket kümesini hemen oluşturur - Yeni etiketleri hemen kullanmaya başlar - Eski giden etiket kümesini siler</p>
<p><strong>Etiket Alıcısı:</strong> - Yeni bir gelen etiket kümesi oluşturur - Tolerans süresi (3 dakika) boyunca eski gelen etiket kümesini muhafaza eder - Tolerans süresi boyunca hem eski hem de yeni etiket kümelerinden etiketleri kabul eder - Tolerans süresinden sonra eski gelen etiket kümesini siler</p>
<h3 id="dh-ratchet-kademeli-diffie-hellman-anahtar-yenileme-mekanizması-durum-yönetimi">DH Ratchet (kademeli Diffie-Hellman anahtar yenileme mekanizması) Durum Yönetimi</h3>
<p><strong>Gönderici Durumu:</strong> - Mevcut giden etiket kümesi - Etiket kümesi kimliği ve anahtar kimlikleri - Sonraki kök anahtar (bir sonraki ratchet (anahtar ilerletme mekanizması) için) - Mevcut etiket kümesindeki ileti sayısı</p>
<p><strong>Alıcı durumu:</strong> - Güncel gelen etiket kümesi(leri) (geçiş süresinde 2 olabilir) - Boşluk tespiti için önceki ileti numaraları (PN) - Önceden üretilmiş etiketler için ileriye bakış penceresi - Sonraki kök anahtar (bir sonraki ratchet (kademeli anahtar yenileme mekanizması) için)</p>
<p><strong>Durum Geçiş Kuralları:</strong></p>
<ol>
<li>
<p><strong>İlk Ratchet (kademeli anahtar yenileme) Öncesi</strong>:</p>
<ul>
<li>Etiket kümesi 0 kullanılıyor (NSR&rsquo;den)</li>
<li>Hiçbir anahtar kimliği atanmadı</li>
</ul>
</li>
<li>
<p><strong>Ratchet (kademeli anahtar yenileme mekanizması) Başlatma</strong>:</p>
<ul>
<li>Yeni anahtar üret (eğer gönderici bu turda üretiyorsa)</li>
<li>ES mesajında NextKey bloğunu gönder</li>
<li>Yeni bir giden etiket kümesi oluşturmadan önce NextKey yanıtını bekle</li>
</ul>
</li>
<li>
<p><strong>Ratchet (anahtar sürgüsü) İsteğinin Alınması</strong>:</p>
<ul>
<li>Yeni bir anahtar üret (bu turda alıcı üretiyorsa)</li>
<li>Alınan anahtarla DH (Diffie-Hellman) gerçekleştir</li>
<li>Yeni bir gelen etiket kümesi oluştur</li>
<li>NextKey yanıtı gönder</li>
<li>Eski gelen etiket kümesini bir müsaade süresi boyunca koru</li>
</ul>
</li>
<li>
<p><strong>Ratchet&rsquo;in Tamamlanması (anahtar yenileme mekanizması)</strong>:</p>
<ul>
<li>NextKey yanıtını alın</li>
<li>DH (Diffie-Hellman anahtar değişimi) gerçekleştirin</li>
<li>Yeni giden etiket kümesi oluşturun</li>
<li>Yeni etiketleri kullanmaya başlayın</li>
</ul>
</li>
</ol>
<h3 id="session-tag-ratchet-oturum-etiketi-için-kademeli-güncelleme-mekanizması">Session Tag Ratchet (oturum etiketi için kademeli güncelleme mekanizması)</h3>
<p>Session tag ratchet (kademeli kriptografik mekanizma), tek kullanımlık 8 baytlık oturum etiketlerini deterministik olarak üretir.</p>
<h3 id="oturum-etiketi-ratchetin-kademeli-anahtar-yenileme-mekanizması-amacı">Oturum Etiketi Ratchet&rsquo;in (kademeli anahtar yenileme mekanizması) Amacı</h3>
<ul>
<li>Açık etiket iletiminin yerini alır (ElGamal 32 baytlık etiketler gönderirdi)</li>
<li>Alıcının ileri bakış penceresi için etiketleri önceden üretmesini sağlar</li>
<li>Gönderici talep üzerine üretir (depolama gerekmez)</li>
<li>Simetrik anahtar ratchet (adım adım anahtar yenileme mekanizması) ile indeks aracılığıyla senkronize olur</li>
</ul>
<h3 id="oturum-etiketi-ratchet-mandallama-mekanizması-formülü">Oturum Etiketi Ratchet (mandallama mekanizması) Formülü</h3>
<p><strong>Başlatma:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># From DH_INITIALIZE</span>
</span></span><span style="display:flex;"><span>sessTag_ck <span style="color:#f92672">=</span> initial_chain_key  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize session tag ratchet</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(sessTag_ck, ZEROLEN, <span style="color:#e6db74">&#34;STInitialization&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># First chain key</span>
</span></span><span style="display:flex;"><span>SESSTAG_CONSTANT <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]   <span style="color:#75715e"># Constant for all tags in this tagset</span>
</span></span></code></pre></div><p><strong>Etiket Üretimi (N etiketi için):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate tag N</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(sessTag_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Chain key for next tag</span>
</span></span><span style="display:flex;"><span>tag_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]              <span style="color:#75715e"># Session tag (8 bytes)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Chain continues for each tag</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tag_0, tag_1, tag_2, ..., tag_65535</span>
</span></span></code></pre></div><p><strong>Tam Sekans:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Tag 0</span>
</span></span><span style="display:flex;"><span>keydata_0 <span style="color:#f92672">=</span> HKDF(sessTag_chainKey, SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>tag_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag 1</span>
</span></span><span style="display:flex;"><span>keydata_1 <span style="color:#f92672">=</span> HKDF(sessTag_chainKey_0, SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>tag_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag N</span>
</span></span><span style="display:flex;"><span>keydata_N <span style="color:#f92672">=</span> HKDF(sessTag_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>tag_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span></code></pre></div><h3 id="session-tag-ratchet-oturum-etiketi-ratchet-mekanizması-gönderici-gerçeklemesi">Session Tag Ratchet (oturum etiketi ratchet mekanizması) Gönderici Gerçeklemesi</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundTagset</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, sessTag_ck):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(sessTag_ck, ZEROLEN, <span style="color:#e6db74">&#34;STInitialization&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>constant <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_next_tag</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Increment index</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">65535</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> TagsetExhausted(<span style="color:#e6db74">&#34;Ratchet required&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate tag</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, self<span style="color:#f92672">.</span>constant, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (tag, self<span style="color:#f92672">.</span>index)
</span></span></code></pre></div><p><strong>Gönderici Süreci:</strong> 1. Her mesaj için <code>get_next_tag()</code> çağrısını yap 2. Dönen etiketi ES mesajında kullan 3. Olası ACK (onay) takibi için indeks N&rsquo;yi sakla 4. Etiket depolaması gerekmez (istek üzerine oluşturulur)</p>
<h3 id="session-tag-ratchet-oturum-etiketi-için-kademeli-anahtar-yenileme-mekanizması-alıcı-tarafı-uygulaması">Session Tag Ratchet (oturum etiketi için kademeli anahtar yenileme mekanizması) Alıcı Tarafı Uygulaması</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundTagset</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, sessTag_ck, look_ahead<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(sessTag_ck, ZEROLEN, <span style="color:#e6db74">&#34;STInitialization&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>constant <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">=</span> look_ahead
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tags <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Dictionary: tag -&gt; index</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Pre-generate initial tags</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>extend(look_ahead)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extend</span>(self, count):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Generate &#39;count&#39; more tags&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(count):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">65535</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>  <span style="color:#75715e"># Cannot exceed maximum</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Generate tag</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, self<span style="color:#f92672">.</span>constant, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            tag <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Store tag</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>tags[tag] <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>index
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lookup_tag</span>(self, tag):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Look up tag and return index&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> tag <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>tags:
</span></span><span style="display:flex;"><span>            index <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>tags[tag]
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Remove tag (one-time use)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>tags[tag]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> index
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_and_extend</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Extend if tag count is low&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        current_count <span style="color:#f92672">=</span> len(self<span style="color:#f92672">.</span>tags)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> current_count <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Extend to restore window</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>extend(self<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">-</span> current_count)
</span></span></code></pre></div><p><strong>Alıcı Süreci:</strong> 1. İleriye bakış penceresi için etiketleri önceden oluştur (örn., 32 etiket) 2. Etiketleri bir hash tablosunda veya sözlükte sakla 3. Mesaj geldiğinde, N indeksini almak için etiketi ara 4. Etiketi depodan kaldır (tek kullanımlık) 5. Etiket sayısı eşik değerin altına düşerse pencereyi genişlet</p>
<h3 id="oturum-etiketi-ileriye-bakma-stratejisi">Oturum Etiketi İleriye Bakma Stratejisi</h3>
<p><strong>Amaç</strong>: Bellek kullanımını sıralama dışı mesaj işleme ile dengelemek</p>
<p><strong>Önerilen Look-Ahead (ileriye bakma) Boyutları:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Tagset Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Initial Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Maximum Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">12</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">12</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Short-lived</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">24</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">160</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial ES tagset</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 1+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">160</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">160</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Ratcheted tagsets</td>
    </tr>
  </tbody>
</table>
**Uyarlanabilir İleriye Bakma:**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Dynamic look-ahead based on highest tag received</span>
</span></span><span style="display:flex;"><span>look_ahead <span style="color:#f92672">=</span> min(tsmax, tsmin <span style="color:#f92672">+</span> N <span style="color:#f92672">//</span> <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Example:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tsmin = 24, tsmax = 160</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 0:   look_ahead = min(160, 24 + 0/4) = 24</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 100: look_ahead = min(160, 24 + 100/4) = 49</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 500: look_ahead = min(160, 24 + 500/4) = 149</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 544: look_ahead = min(160, 24 + 544/4) = 160</span>
</span></span></code></pre></div><p><strong>Geriden Kırp:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Trim tags far behind highest received</span>
</span></span><span style="display:flex;"><span>trim_behind <span style="color:#f92672">=</span> look_ahead <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If highest received tag is N=100, trim tags below N=50</span>
</span></span></code></pre></div><p><strong>Bellek Hesaplama:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Per tag: 8 bytes (tag) + 2 bytes (index) + overhead ≈ 16 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Look-ahead of 160 tags ≈ 2.5 KB per inbound tagset</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># With multiple sessions:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 100 inbound sessions × 2.5 KB = 250 KB total</span>
</span></span></code></pre></div><h3 id="session-taglerin-oturum-etiketleri-sıra-dışı-işlenmesi">Session Tag&rsquo;lerin (Oturum Etiketleri) Sıra Dışı İşlenmesi</h3>
<p><strong>Senaryo</strong>: Mesajlar sırayla gelmiyor</p>
<pre tabindex="0"><code>Expected: tag_5, tag_6, tag_7, tag_8
Received: tag_5, tag_7, tag_6, tag_8
</code></pre><p><strong>Alıcı Davranışı:</strong></p>
<ol>
<li>
<p>tag_5&rsquo;i al:</p>
<ul>
<li>Ara: 5. indekste bulundu</li>
<li>İletiyi işle</li>
<li>tag_5&rsquo;i kaldır</li>
<li>Alınan en yüksek: 5</li>
</ul>
</li>
<li>
<p>tag_7 (sırasız) alındığında:</p>
<ul>
<li>Ara: indeks 7&rsquo;de bulundu</li>
<li>Mesajı işle</li>
<li>tag_7&rsquo;yi kaldır</li>
<li>Alınan en yüksek: 7</li>
<li>Not: tag_6 hâlâ depoda (henüz alınmadı)</li>
</ul>
</li>
<li>
<p>tag_6 alındı (gecikmeli):</p>
<ul>
<li>Sorgula: indeks 6&rsquo;da bulundu</li>
<li>Mesajı işle</li>
<li>tag_6 öğesini kaldır</li>
<li>En yüksek alınan: 7 (değişmedi)</li>
</ul>
</li>
<li>
<p>tag_8&rsquo;i al:</p>
<ul>
<li>Ara: indeks 8&rsquo;de bulundu</li>
<li>Mesajı işle</li>
<li>tag_8&rsquo;i kaldır</li>
<li>Alınan en yüksek: 8</li>
</ul>
</li>
</ol>
<p><strong>Pencere Bakımı:</strong> - Alınan en yüksek indeksi takip et - Eksik indekslerin (boşluklar) listesini tut - Pencereyi en yüksek indekse göre genişlet - İsteğe bağlı: Zaman aşımından sonra eski boşlukları kaldır</p>
<h3 id="simetrik-anahtar-mandalı">Simetrik Anahtar Mandalı</h3>
<p>symmetric key ratchet (simetrik anahtarların kademeli yenileme mekanizması), oturum etiketleriyle eşzamanlı 32 baytlık şifreleme anahtarları üretir.</p>
<h3 id="symmetric-key-ratchet-simetrik-anahtar-mandal-mekanizması-amacı">Symmetric Key Ratchet (simetrik anahtar mandal mekanizması) Amacı</h3>
<ul>
<li>Her mesaj için benzersiz bir şifreleme anahtarı sağlar</li>
<li>session tag ratchet (oturum etiketi kademeli güncelleme mekanizması) ile eşzamanlıdır (aynı indeks)</li>
<li>Gönderici talep üzerine oluşturabilir</li>
<li>Alıcı, etiket alınana kadar oluşturmayı erteleyebilir</li>
</ul>
<h3 id="symmetric-key-ratchet-simetrik-anahtar-mandalı-formülü">Symmetric Key Ratchet (simetrik anahtar mandalı) formülü</h3>
<p><strong>Başlatma:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># From DH_INITIALIZE</span>
</span></span><span style="display:flex;"><span>symmKey_ck <span style="color:#f92672">=</span> initial_chain_key  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># No additional initialization needed</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Unlike session tag ratchet, no constant is derived</span>
</span></span></code></pre></div><p><strong>Anahtar Oluşturma (anahtar N için):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate key N</span>
</span></span><span style="display:flex;"><span>SYMMKEY_CONSTANT <span style="color:#f92672">=</span> ZEROLEN  <span style="color:#75715e"># Empty string</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(symmKey_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), SYMMKEY_CONSTANT, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Chain key for next key</span>
</span></span><span style="display:flex;"><span>key_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]              <span style="color:#75715e"># Session key (32 bytes)</span>
</span></span></code></pre></div><p><strong>Aşamaların Tamamı:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Key 0</span>
</span></span><span style="display:flex;"><span>keydata_0 <span style="color:#f92672">=</span> HKDF(symmKey_ck, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>key_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Key 1</span>
</span></span><span style="display:flex;"><span>keydata_1 <span style="color:#f92672">=</span> HKDF(symmKey_chainKey_0, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>key_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Key N</span>
</span></span><span style="display:flex;"><span>keydata_N <span style="color:#f92672">=</span> HKDF(symmKey_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>key_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span></code></pre></div><h3 id="symmetric-key-ratchet-mandal-mekanizması-gönderici-gerçeklemesi">Symmetric Key Ratchet (mandal mekanizması) Gönderici Gerçeklemesi</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Generate key for specific index&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Fast-forward to desired index if needed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&lt;</span> index:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">==</span> index:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Should not reach here if called correctly</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Key already generated&#34;</span>)
</span></span></code></pre></div><p><strong>Gönderici Süreci:</strong> 1. Sonraki etiketi ve onun N indisini al 2. N indisi için anahtar üret 3. Anahtarı kullanarak mesajı şifrele 4. Anahtar depolaması gerekmez</p>
<h3 id="symmetric-key-ratchet-simetrik-anahtar-yenileme-mekanizması-alıcı-tarafı-gerçeklemesi">Symmetric Key Ratchet (simetrik anahtar yenileme mekanizması) Alıcı Tarafı Gerçeklemesi</h3>
<p><strong>Strateji 1: Ertelenmiş Oluşturma (Önerilen)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cache <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Optional: cache recently used keys</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Generate key for specific index&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check cache first (optional optimization)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>cache:
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cache[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>cache[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> key
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Fast-forward to desired index</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&lt;</span> index:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">==</span> index:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Index already passed&#34;</span>)
</span></span></code></pre></div><p><strong>Ertelenmiş Üretim Süreci:</strong> 1. Etiketli ES mesajını al 2. N indeksini elde etmek için etiketi sorgula 3. 0&rsquo;dan N&rsquo;ye kadar anahtarları üret (henüz üretilmediyse) 4. Mesajı çözmek için N anahtarını kullan 5. Zincir anahtarı artık N indeksinde konumlandı</p>
<p><strong>Avantajlar:</strong> - Minimal bellek kullanımı - Anahtarlar yalnızca gerektiğinde üretilir - Basit gerçekleştirim</p>
<p><strong>Dezavantajlar:</strong> - İlk kullanımda 0&rsquo;dan N&rsquo;e kadar tüm anahtarları üretmelidir - Önbellekleme olmadan sıra dışı mesajları işleyemez</p>
<p><strong>Strateji 2: Etiket Penceresi ile Önceden Oluşturma (Alternatif)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>keys <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Dictionary: index -&gt; key</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extend</span>(self, count):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Pre-generate &#39;count&#39; more keys&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(count):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>keys[self<span style="color:#f92672">.</span>index] <span style="color:#f92672">=</span> key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Retrieve pre-generated key&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>keys:
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>keys[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>keys[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> key
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><p><strong>Önceden Oluşturma Süreci:</strong> 1. Etiket penceresiyle eşleşen anahtarları önceden oluştur (örn., 32 anahtar) 2. Anahtarları mesaj numarasına göre indekslenmiş olarak sakla 3. Etiket alındığında ilgili anahtarı bul 4. Etiketler kullanıldıkça pencereyi genişlet</p>
<p><strong>Avantajlar:</strong> - Sıralama dışı mesajları doğal olarak işler - Hızlı anahtar elde etme (oluşturma gecikmesi yok)</p>
<p><strong>Dezavantajlar:</strong> - Daha yüksek bellek kullanımı (anahtar başına 32 bayt, etiket başına 8 bayta karşı) - Anahtarlar etiketlerle senkronize tutulmalıdır</p>
<p><strong>Bellek Karşılaştırması:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Look-ahead of 160:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags only:  160 × 16 bytes = 2.5 KB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags+Keys:  160 × (16 + 32) bytes = 7.5 KB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For 100 sessions:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags only:  250 KB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags+Keys:  750 KB</span>
</span></span></code></pre></div><h3 id="oturum-etiketleri-ile-simetrik-ratchet-simetrik-anahtar-yenileme-mekanizması-senkronizasyonu">Oturum Etiketleri ile Simetrik Ratchet (simetrik anahtar yenileme mekanizması) Senkronizasyonu</h3>
<p><strong>Kritik Gereksinim</strong>: Oturum etiketi indeksi, simetrik anahtar indeksine eşit olmak zorundadır</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Sender</span>
</span></span><span style="display:flex;"><span>tag, index <span style="color:#f92672">=</span> outbound_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> outbound_keyratchet<span style="color:#f92672">.</span>get_key(index)  <span style="color:#75715e"># Same index</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, payload, tag)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> inbound_tagset<span style="color:#f92672">.</span>lookup_tag(tag)
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> inbound_keyratchet<span style="color:#f92672">.</span>get_key(index)  <span style="color:#75715e"># Same index</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>plaintext <span style="color:#f92672">=</span> DECRYPT(key, nonce, ciphertext, tag)
</span></span></code></pre></div><p><strong>Hata Türleri:</strong></p>
<p>Senkronizasyon bozulursa: - Şifre çözme için yanlış anahtar kullanıldı - MAC doğrulaması başarısız olur - İleti reddedildi</p>
<p><strong>Önleme:</strong> - Etiket ve anahtar için her zaman aynı indeksi kullanın - Her iki ratchet&rsquo;te (anahtar ilerletme mekanizması) de indeksleri asla atlamayın - Sırası bozulmuş mesajları dikkatle ele alın</p>
<h3 id="symmetric-ratchet-kademeli-anahtar-yenileme-mekanizması-için-nonce-tek-kullanımlık-sayı-oluşturma">Symmetric Ratchet (kademeli anahtar yenileme mekanizması) için Nonce (tek-kullanımlık sayı) Oluşturma</h3>
<p>Tek kullanımlık sayı, mesaj numarasından türetilir:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">construct_nonce</span>(index):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Construct 12-byte nonce for ChaCha20-Poly1305
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        index: Message number (0-65535)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        nonce: 12-byte nonce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># First 4 bytes are always zero</span>
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> bytearray(<span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>    nonce[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00\x00\x00\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Last 8 bytes are little-endian message number</span>
</span></span><span style="display:flex;"><span>    nonce[<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> index<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">8</span>, byteorder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> bytes(nonce)
</span></span></code></pre></div><p><strong>Örnekler:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>:     nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> <span style="color:#ae81ff">0000000000000000</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>:     nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> <span style="color:#ae81ff">0100000000000000</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>:   nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> FF00000000000000
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span>:   nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> <span style="color:#ae81ff">0001000000000000</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">65535</span>: nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> FFFF000000000000
</span></span></code></pre></div><p><strong>Önemli Özellikler:</strong> - Nonce (tek kullanımlık sayı) değerleri bir etiket kümesindeki her mesaj için benzersizdir - Nonceler asla tekrar etmez (tek kullanımlık etiketler bunu sağlar) - 8 baytlık sayaç 2^64 mesaja izin verir (biz yalnızca 2^16 kullanıyoruz) - Nonce biçimi RFC 7539&rsquo;un sayaç tabanlı yapısıyla uyumludur</p>
<hr>
<h2 id="oturum-yönetimi">Oturum Yönetimi</h2>
<h3 id="oturum-bağlamı">Oturum Bağlamı</h3>
<p>Tüm gelen ve giden oturumlar belirli bir bağlama ait olmalıdır:</p>
<ol>
<li><strong>Router Bağlamı</strong>: router&rsquo;ın kendisi için oturumlar</li>
<li><strong>Hedef Bağlamı</strong>: belirli bir yerel hedef (istemci uygulaması) için oturumlar</li>
</ol>
<p><strong>Kritik Kural</strong>: Korelasyon saldırılarını önlemek için oturumlar bağlamlar arasında KESİNLİKLE paylaşılmamalıdır.</p>
<p><strong>Uygulama:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SessionKeyManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Context for managing sessions (router or destination)&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, context_id):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>context_id <span style="color:#f92672">=</span> context_id
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions <span style="color:#f92672">=</span> {}   <span style="color:#75715e"># far_end_dest -&gt; [sessions]</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_sessions <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># far_end_dest -&gt; session</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>static_keypair <span style="color:#f92672">=</span> generate_keypair()  <span style="color:#75715e"># Context&#39;s identity</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_outbound_session</span>(self, destination):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get or create outbound session to destination&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> destination <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>outbound_sessions:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>outbound_sessions[destination] <span style="color:#f92672">=</span> create_outbound_session(destination)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>outbound_sessions[destination]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_inbound_session</span>(self, session, destination<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Add inbound session, optionally bound to destination&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> destination:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> destination <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>inbound_sessions:
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>inbound_sessions[destination] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>inbound_sessions[destination]<span style="color:#f92672">.</span>append(session)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Unbound session</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>inbound_sessions[<span style="color:#66d9ef">None</span>]<span style="color:#f92672">.</span>append(session)
</span></span></code></pre></div><p><strong>Java I2P Gerçeklemesi:</strong></p>
<p>Java I2P&rsquo;de, <code>SessionKeyManager</code> sınıfı şu işlevleri sağlar: - router başına bir <code>SessionKeyManager</code> - yerel hedef başına bir <code>SessionKeyManager</code> - her bağlamda ECIES ve ElGamal oturumlarının ayrı yönetimi</p>
<h3 id="oturum-bağlama">Oturum Bağlama</h3>
<p><strong>Binding</strong> (bağlama), bir oturumu belirli bir karşı uçtaki hedefle ilişkilendirir.</p>
<h3 id="bağlı-oturumlar">Bağlı Oturumlar</h3>
<p><strong>Özellikler:</strong> - NS mesajına gönderenin statik anahtarı dahil edilir - Alıcı, gönderenin hedefini belirleyebilir - Çift yönlü iletişimi sağlar - Her hedef için tek bir giden oturum - Birden çok gelen oturum olabilir (geçişler sırasında)</p>
<p><strong>Kullanım Durumları:</strong> - Akış bağlantıları (TCP benzeri) - Yanıtlanabilir datagramlar - İstek/yanıt gerektiren herhangi bir protokol</p>
<p><strong>Bağlama Süreci:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Alice creates bound outbound session</span>
</span></span><span style="display:flex;"><span>outbound_session <span style="color:#f92672">=</span> OutboundSession(
</span></span><span style="display:flex;"><span>    destination<span style="color:#f92672">=</span>bob_destination,
</span></span><span style="display:flex;"><span>    static_key<span style="color:#f92672">=</span>alice_static_key,
</span></span><span style="display:flex;"><span>    bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Alice sends NS with static key</span>
</span></span><span style="display:flex;"><span>ns_message <span style="color:#f92672">=</span> build_ns_message(
</span></span><span style="display:flex;"><span>    ephemeral_key<span style="color:#f92672">=</span>alice_ephemeral_key,
</span></span><span style="display:flex;"><span>    static_key<span style="color:#f92672">=</span>alice_static_key,  <span style="color:#75715e"># Included for binding</span>
</span></span><span style="display:flex;"><span>    payload<span style="color:#f92672">=</span>data
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob receives NS</span>
</span></span><span style="display:flex;"><span>bob_receives_ns(ns_message)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob extracts Alice&#39;s static key</span>
</span></span><span style="display:flex;"><span>alice_static_key <span style="color:#f92672">=</span> decrypt_static_key_section(ns_message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob looks up Alice&#39;s destination (from bundled LeaseSet)</span>
</span></span><span style="display:flex;"><span>alice_destination <span style="color:#f92672">=</span> lookup_destination_by_static_key(alice_static_key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob creates bound inbound session</span>
</span></span><span style="display:flex;"><span>inbound_session <span style="color:#f92672">=</span> InboundSession(
</span></span><span style="display:flex;"><span>    destination<span style="color:#f92672">=</span>alice_destination,
</span></span><span style="display:flex;"><span>    bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob pairs with outbound session</span>
</span></span><span style="display:flex;"><span>outbound_session <span style="color:#f92672">=</span> OutboundSession(
</span></span><span style="display:flex;"><span>    destination<span style="color:#f92672">=</span>alice_destination,
</span></span><span style="display:flex;"><span>    bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>Faydalar:</strong> 1. <strong>Ephemeral-Ephemeral DH</strong>: (geçici-geçici Diffie-Hellman) Yanıt ee DH kullanır (tam ileri gizlilik) 2. <strong>Oturum Sürekliliği</strong>: Ratchets (kademeli anahtar yenileme mekanizmaları) aynı hedefe bağın korunmasını sağlar 3. <strong>Güvenlik</strong>: Oturum ele geçirmeyi önler (statik anahtarla kimliği doğrulanır) 4. <strong>Verimlilik</strong>: Her hedef için tek bir oturum (yinelenme yok)</p>
<h3 id="bağlı-olmayan-oturumlar">Bağlı Olmayan Oturumlar</h3>
<p><strong>Özellikler:</strong> - NS message (NS iletisi) içinde statik anahtar yok (flags bölümü tamamen sıfırdır) - Alıcı gönderenin kimliğini belirleyemez - Yalnızca tek yönlü iletişim - Aynı hedefe birden çok oturuma izin verilir</p>
<p><strong>Kullanım Senaryoları:</strong> - Ham datagramlar (fire-and-forget - gönder-ve-unut) - Anonim yayınlama - Yayın tarzı mesajlaşma</p>
<p><strong>Özellikler:</strong> - Daha anonim (gönderici tanımlaması yok) - Daha verimli (el sıkışmada 1 DH (Diffie-Hellman anahtar değişimi) ile 2 DH) - Yanıt mümkün değil (alıcı nereye yanıt vereceğini bilmiyor) - Oturum ratcheting (adımlı anahtar yenileme) yok (tek seferlik ya da sınırlı kullanım)</p>
<h3 id="oturum-eşleştirme">Oturum Eşleştirme</h3>
<p><strong>Eşleştirme</strong>, çift yönlü iletişim için gelen bir oturumu giden bir oturumla bağlar.</p>
<h3 id="eşleştirilmiş-oturumlar-oluşturma">Eşleştirilmiş Oturumlar Oluşturma</h3>
<p><strong>Alice&rsquo;in Bakış Açısı (başlatıcı):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Create outbound session to Bob</span>
</span></span><span style="display:flex;"><span>outbound_session <span style="color:#f92672">=</span> create_outbound_session(bob_destination)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create paired inbound session</span>
</span></span><span style="display:flex;"><span>inbound_session <span style="color:#f92672">=</span> create_inbound_session(
</span></span><span style="display:flex;"><span>    paired_with<span style="color:#f92672">=</span>outbound_session,
</span></span><span style="display:flex;"><span>    bound_to<span style="color:#f92672">=</span>bob_destination
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Link them</span>
</span></span><span style="display:flex;"><span>outbound_session<span style="color:#f92672">.</span>paired_inbound <span style="color:#f92672">=</span> inbound_session
</span></span><span style="display:flex;"><span>inbound_session<span style="color:#f92672">.</span>paired_outbound <span style="color:#f92672">=</span> outbound_session
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send NS message</span>
</span></span><span style="display:flex;"><span>send_ns_message(outbound_session, payload)
</span></span></code></pre></div><p><strong>Bob&rsquo;un Bakış Açısı (yanıtlayan):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Receive NS message</span>
</span></span><span style="display:flex;"><span>ns_message <span style="color:#f92672">=</span> receive_ns_message()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create inbound session</span>
</span></span><span style="display:flex;"><span>inbound_session <span style="color:#f92672">=</span> create_inbound_session_from_ns(ns_message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If NS contains static key (bound):</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ns_message<span style="color:#f92672">.</span>has_static_key():
</span></span><span style="display:flex;"><span>    alice_destination <span style="color:#f92672">=</span> extract_destination(ns_message)
</span></span><span style="display:flex;"><span>    inbound_session<span style="color:#f92672">.</span>bind_to(alice_destination)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create paired outbound session</span>
</span></span><span style="display:flex;"><span>    outbound_session <span style="color:#f92672">=</span> create_outbound_session(alice_destination)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Link them</span>
</span></span><span style="display:flex;"><span>    outbound_session<span style="color:#f92672">.</span>paired_inbound <span style="color:#f92672">=</span> inbound_session
</span></span><span style="display:flex;"><span>    inbound_session<span style="color:#f92672">.</span>paired_outbound <span style="color:#f92672">=</span> outbound_session
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send NSR</span>
</span></span><span style="display:flex;"><span>send_nsr_message(inbound_session, outbound_session, payload)
</span></span></code></pre></div><h3 id="oturum-eşleştirmenin-avantajları">Oturum Eşleştirmenin Avantajları</h3>
<ol>
<li><strong>Bant içi ACK&rsquo;ler</strong>: Ayrı bir clove (garlic mesajı içindeki alt iletisi) olmadan iletileri onaylayabilir</li>
<li><strong>Verimli ratchet (sürekli anahtar güncelleme mekanizması)</strong>: Her iki yön birlikte ve eşgüdümlü olarak ilerler</li>
<li><strong>Akış denetimi</strong>: Eşleştirilmiş oturumlar arasında back-pressure (aşırı yükü kaynağa geri ileterek baskılama) uygulanabilir</li>
<li><strong>Durum tutarlılığı</strong>: Senkronize durumu sürdürmek daha kolaydır</li>
</ol>
<h3 id="oturum-eşleştirme-kuralları">Oturum Eşleştirme Kuralları</h3>
<ul>
<li>Giden oturum eşleşmemiş olabilir (bağlı olmayan NS)</li>
<li>Bağlı NS için gelen oturum eşleştirilmiş olmalıdır</li>
<li>Eşleştirme oturum oluşturma sırasında gerçekleşir, sonrasında değil</li>
<li>Eşleştirilmiş oturumlar aynı hedefe bağlıdır</li>
<li>Ratchet&rsquo;lar (ardışık anahtar yenileme mekanizması) bağımsız olarak gerçekleşir ancak koordine edilir</li>
</ul>
<h3 id="oturum-yaşam-döngüsü">Oturum Yaşam Döngüsü</h3>
<h3 id="oturum-yaşam-döngüsü-oluşturma-aşaması">Oturum Yaşam Döngüsü: Oluşturma Aşaması</h3>
<p><strong>Giden Oturum Oluşturma (Alice):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_outbound_session</span>(destination, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> OutboundSession()
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> destination
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> bound
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>NEW
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate keys for NS message</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> bound:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>static_key <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Will be populated after NSR received</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> session
</span></span></code></pre></div><p><strong>Gelen Oturum Oluşturma (Bob):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_inbound_session_from_ns</span>(ns_message):
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> InboundSession()
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract from NS</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>remote_ephemeral_key <span style="color:#f92672">=</span> ns_message<span style="color:#f92672">.</span>ephemeral_key
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>remote_static_key <span style="color:#f92672">=</span> ns_message<span style="color:#f92672">.</span>static_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>remote_static_key:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> lookup_destination(session<span style="color:#f92672">.</span>remote_static_key)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate keys for NSR</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create tagsets from KDF</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> create_tagset_from_nsr()
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> create_tagset_from_nsr()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> session
</span></span></code></pre></div><h3 id="oturum-yaşam-döngüsü-aktif-aşama">Oturum Yaşam Döngüsü: Aktif Aşama</h3>
<p><strong>Durum Geçişleri:</strong></p>
<pre tabindex="0"><code>NEW (outbound only)
  ↓
  NS sent
  ↓
PENDING_REPLY (outbound only)
  ↓
  NSR received
  ↓
ESTABLISHED
  ↓
  ES messages exchanged
  ↓
ESTABLISHED (ongoing)
  ↓
  (optional) RATCHETING
  ↓
ESTABLISHED
</code></pre><p><strong>Aktif Oturum Bakımı:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">maintain_active_session</span>(session):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Update last activity time</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for ratchet needed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>needs_ratchet():
</span></span><span style="display:flex;"><span>        initiate_ratchet(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for incoming ratchet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> received_nextkey_block():
</span></span><span style="display:flex;"><span>        process_ratchet(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Trim old tags from inbound tagset</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>expire_old_tags()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check session health</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time() <span style="color:#f92672">&gt;</span> SESSION_TIMEOUT:
</span></span><span style="display:flex;"><span>        mark_session_idle(session)
</span></span></code></pre></div><h3 id="oturum-yaşam-döngüsü-sona-erme-aşaması">Oturum Yaşam Döngüsü: Sona Erme Aşaması</h3>
<p><strong>Oturum Zaman Aşımı Değerleri:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Session Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Sender Timeout</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Receiver Timeout</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Short-lived</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">8 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">10 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 1+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">8 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">10 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Ratcheted</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Old tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">After ratchet</td>
    </tr>
  </tbody>
</table>
**Sona Erme Mantığı:**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_session_expiration</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> active_sessions:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Outbound session expiration (sender)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>is_outbound():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:  <span style="color:#75715e"># 8 minutes</span>
</span></span><span style="display:flex;"><span>                expire_outbound_session(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Inbound session expiration (receiver)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:  <span style="color:#75715e"># 10 minutes</span>
</span></span><span style="display:flex;"><span>                expire_inbound_session(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Old tagsets (after ratchet)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tagset <span style="color:#f92672">in</span> old_tagsets:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> tagset<span style="color:#f92672">.</span>age() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:  <span style="color:#75715e"># 3 minutes</span>
</span></span><span style="display:flex;"><span>            delete_tagset(tagset)
</span></span></code></pre></div><p><strong>Kritik Kural</strong>: Desenkronizasyonu önlemek için giden oturumların süresi, gelen oturumlardan önce MUTLAKA dolmalıdır.</p>
<p><strong>Düzenli Sonlandırma:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">terminate_session</span>(session, reason<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send Termination block (if implemented)</span>
</span></span><span style="display:flex;"><span>    send_termination_block(session, reason)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Mark session for deletion</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>TERMINATED
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Keep session briefly for final messages</span>
</span></span><span style="display:flex;"><span>    schedule_deletion(session, delay<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>)  <span style="color:#75715e"># 30 seconds</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Notify paired session</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>paired_session:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>paired_session<span style="color:#f92672">.</span>mark_remote_terminated()
</span></span></code></pre></div><h3 id="birden-çok-ns-mesajı">Birden çok NS mesajı</h3>
<p><strong>Senaryo</strong>: Alice&rsquo;in NS iletisi kaybolur ya da NSR yanıtı kaybolur.</p>
<p><strong>Alice&rsquo;in Davranışı:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_messages_sent <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_ns_attempts <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_ns_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate new ephemeral key for each NS</span>
</span></span><span style="display:flex;"><span>        ephemeral_key <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        ns_message <span style="color:#f92672">=</span> build_ns_message(
</span></span><span style="display:flex;"><span>            ephemeral_key<span style="color:#f92672">=</span>ephemeral_key,
</span></span><span style="display:flex;"><span>            static_key<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>static_key,
</span></span><span style="display:flex;"><span>            payload<span style="color:#f92672">=</span>payload
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Store state for this NS</span>
</span></span><span style="display:flex;"><span>        ns_state <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;ephemeral_key&#39;</span>: ephemeral_key,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;chainkey&#39;</span>: compute_chainkey(ns_message),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;hash&#39;</span>: compute_hash(ns_message),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;tagset&#39;</span>: derive_nsr_tagset(ns_message),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;sent_time&#39;</span>: now()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_messages_sent<span style="color:#f92672">.</span>append(ns_state)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send message</span>
</span></span><span style="display:flex;"><span>        send_message(ns_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Set timer for retry</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>ns_timer:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> set_timer(<span style="color:#ae81ff">1.0</span>, self<span style="color:#f92672">.</span>on_ns_timeout)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_ns_timeout</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(self<span style="color:#f92672">.</span>ns_messages_sent) <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_ns_attempts:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Give up</span>
</span></span><span style="display:flex;"><span>            fail_session(<span style="color:#e6db74">&#34;No NSR received after </span><span style="color:#e6db74">{self.max_ns_attempts}</span><span style="color:#e6db74"> attempts&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Retry with new NS message</span>
</span></span><span style="display:flex;"><span>        send_ns_message(self<span style="color:#f92672">.</span>payload)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_nsr_received</span>(self, nsr_message):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Cancel timer</span>
</span></span><span style="display:flex;"><span>        cancel_timer(self<span style="color:#f92672">.</span>ns_timer)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Find which NS this NSR responds to</span>
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> nsr_message<span style="color:#f92672">.</span>tag
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> ns_state <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>ns_messages_sent:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tag <span style="color:#f92672">in</span> ns_state[<span style="color:#e6db74">&#39;tagset&#39;</span>]:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># This NSR corresponds to this NS</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>active_ns_state <span style="color:#f92672">=</span> ns_state
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process NSR and complete handshake</span>
</span></span><span style="display:flex;"><span>        complete_handshake(nsr_message, self<span style="color:#f92672">.</span>active_ns_state)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Discard other NS states</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_messages_sent <span style="color:#f92672">=</span> []
</span></span></code></pre></div><p><strong>Önemli Özellikler:</strong></p>
<ol>
<li><strong>Benzersiz Geçici Anahtarlar</strong>: Her NS farklı bir geçici anahtar kullanır</li>
<li><strong>Bağımsız El Sıkışmaları</strong>: Her NS ayrı bir el sıkışma durumu oluşturur</li>
<li><strong>NSR Korelasyonu</strong>: NSR etiketi, hangi NS&rsquo;ye yanıt verdiğini belirler</li>
<li><strong>Durum Temizliği</strong>: Kullanılmayan NS durumları, başarılı bir NSR&rsquo;den sonra atılır</li>
</ol>
<p><strong>Saldırıların Önlenmesi:</strong></p>
<p>Kaynak tükenmesini önlemek için:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Limit NS sending rate</span>
</span></span><span style="display:flex;"><span>max_ns_rate <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> per <span style="color:#ae81ff">10</span> seconds per destination
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Limit total NS attempts</span>
</span></span><span style="display:flex;"><span>max_ns_attempts <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Limit total pending NS states</span>
</span></span><span style="display:flex;"><span>max_pending_ns <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> per context
</span></span></code></pre></div><h3 id="birden-fazla-nsr-mesajı">Birden fazla NSR mesajı</h3>
<p><strong>Senaryo</strong>: Bob birden fazla NSR gönderir (örn. yanıt verileri birden çok mesaja bölünmüştür).</p>
<p><strong>Bob&rsquo;un Davranışı:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_nsr_replies</span>(self, payload_chunks):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># One NS received, multiple NSRs to send</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> chunk <span style="color:#f92672">in</span> payload_chunks:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Generate new ephemeral key for each NSR</span>
</span></span><span style="display:flex;"><span>            ephemeral_key <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Get next tag from NSR tagset</span>
</span></span><span style="display:flex;"><span>            tag <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>nsr_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            nsr_message <span style="color:#f92672">=</span> build_nsr_message(
</span></span><span style="display:flex;"><span>                tag<span style="color:#f92672">=</span>tag,
</span></span><span style="display:flex;"><span>                ephemeral_key<span style="color:#f92672">=</span>ephemeral_key,
</span></span><span style="display:flex;"><span>                payload<span style="color:#f92672">=</span>chunk
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            send_message(nsr_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Wait for ES message from Alice</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>AWAITING_ES
</span></span></code></pre></div><p><strong>Alice&rsquo;nin Davranışı:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_nsr_received</span>(self, nsr_message):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>PENDING_REPLY:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># First NSR received</span>
</span></span><span style="display:flex;"><span>            complete_handshake(nsr_message)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Create ES sessions</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>es_outbound_tagset <span style="color:#f92672">=</span> derive_es_outbound_tagset()
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>es_inbound_tagset <span style="color:#f92672">=</span> derive_es_inbound_tagset()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Send ES message (ACK)</span>
</span></span><span style="display:flex;"><span>            send_es_message(empty_payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Additional NSR received</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Decrypt and process payload</span>
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> decrypt_nsr_payload(nsr_message)
</span></span><span style="display:flex;"><span>            process_payload(payload)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># These NSRs are from other NS attempts, ignore handshake</span>
</span></span></code></pre></div><p><strong>Bob&rsquo;un Temizliği:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_es_received</span>(self, es_message):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># First ES received from Alice</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># This confirms which NSR Alice used</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Clean up other handshake states</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> other_ns_state <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>pending_ns_states:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> other_ns_state <span style="color:#f92672">!=</span> self<span style="color:#f92672">.</span>active_ns_state:
</span></span><span style="display:flex;"><span>                delete_ns_state(other_ns_state)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Delete unused NSR tagsets</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> tagset <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>nsr_tagsets:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tagset <span style="color:#f92672">!=</span> self<span style="color:#f92672">.</span>active_nsr_tagset:
</span></span><span style="display:flex;"><span>                delete_tagset(tagset)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span></code></pre></div><p><strong>Önemli Özellikler:</strong></p>
<ol>
<li><strong>Birden Fazla NSR&rsquo;ye İzin Verilir</strong>: Bob, NS başına birden fazla NSR gönderebilir</li>
<li><strong>Farklı Geçici Anahtarlar</strong>: Her NSR benzersiz bir geçici anahtar kullanmalıdır</li>
<li><strong>Aynı NSR Tagset (etiket kümesi)</strong>: Bir NS için tüm NSR&rsquo;lar aynı tagset kullanır</li>
<li><strong>İlk ES Kazanır</strong>: Alice&rsquo;in ilk ES&rsquo;si hangi NSR&rsquo;nin başarılı olduğunu belirler</li>
<li><strong>ES Sonrası Temizlik</strong>: ES alındıktan sonra Bob kullanılmayan durumları atar</li>
</ol>
<h3 id="oturum-durum-makinesi">Oturum Durum Makinesi</h3>
<p><strong>Tam Durum Diyagramı:</strong></p>
<pre tabindex="0"><code>                    Outbound Session                    Inbound Session

                         NEW
                          |
                     send NS
                          |
                   PENDING_REPLY -------------------- receive NS ---&gt; ESTABLISHED
                          |                                                |
                   receive NSR                                        send NSR
                          |                                                |
                    ESTABLISHED &lt;---------- receive ES ------------- AWAITING_ES
                          |                     |                          |
                    ┌─────┴─────┐               |                    receive ES
                    |           |               |                          |
              send ES      receive ES           |                    ESTABLISHED
                    |           |               |                          |
                    └─────┬─────┘               |                ┌─────────┴─────────┐
                          |                     |                |                   |
                          |                     |          send ES              receive ES
                          |                     |                |                   |
                          |                     |                └─────────┬─────────┘
                          |                     |                          |
                          └─────────────────────┴──────────────────────────┘
                                              ACTIVE
                                                |
                                         idle timeout
                                                |
                                             EXPIRED
</code></pre><p><strong>Durum Açıklamaları:</strong></p>
<ul>
<li><strong>NEW</strong>: Giden oturum oluşturuldu, henüz NS gönderilmedi</li>
<li><strong>PENDING_REPLY</strong>: NS gönderildi, NSR bekleniyor</li>
<li><strong>AWAITING_ES</strong>: NSR gönderildi, Alice&rsquo;ten ilk ES bekleniyor</li>
<li><strong>ESTABLISHED</strong>: El sıkışma tamamlandı, ES gönderip/alabilir</li>
<li><strong>ACTIVE</strong>: ES mesajlarını etkin biçimde değiş tokuş ediyor</li>
<li><strong>RATCHETING</strong>: DH ratchet (Diffie-Hellman mandalı) sürüyor (ACTIVE alt kümesi)</li>
<li><strong>EXPIRED</strong>: Oturum zaman aşımına uğradı, silinmeyi bekliyor</li>
<li><strong>TERMINATED</strong>: Oturum açıkça sonlandırıldı</li>
</ul>
<hr>
<h2 id="yük-biçimi">Yük Biçimi</h2>
<p>Tüm ECIES (Eliptik Eğri Entegre Şifreleme Şeması) iletilerinin (NS, NSR, ES) yük bölümü, NTCP2&rsquo;ye benzer blok tabanlı bir biçim kullanır.</p>
<h3 id="blok-yapısı">Blok Yapısı</h3>
<p><strong>Genel Biçim:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|blk |  size   |       data             |
+----+----+----+                        +
|                                       |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
|blk |  size   |       data             |
+----+----+----+                        +
|                                       |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Alanlar:</strong></p>
<ul>
<li><code>blk</code>: 1 bayt - Blok tür numarası</li>
<li><code>size</code>: 2 bayt - Veri alanının big-endian (büyük anlamlı bayt sıralaması) boyutu (0-65516)</li>
<li><code>data</code>: Değişken uzunluk - Bloğa özgü veri</li>
</ul>
<p><strong>Kısıtlamalar:</strong></p>
<ul>
<li>Maksimum ChaChaPoly çerçevesi: 65535 bayt</li>
<li>Poly1305 MAC: 16 bayt</li>
<li>Maksimum toplam blok boyutu: 65519 bayt (65535 - 16)</li>
<li>Maksimum tek blok: 65519 bayt (3 baytlık başlık dahil)</li>
<li>Maksimum tek blok verisi: 65516 bayt</li>
</ul>
<h3 id="blok-türleri">Blok Türleri</h3>
<p><strong>Tanımlı Blok Türleri:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Name</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Status</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Usage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DateTime</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">7 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Required in NS</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1-3</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future use</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Termination</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">9+ bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Unimplemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session termination</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">5</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Options</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">21+ bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Unimplemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session options</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">6</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">MessageNumbers</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">5 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Unimplemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">PN value</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">7</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NextKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">3 or 35 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DH ratchet</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">8</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ACK</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">4+ bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Message acknowledgment</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">9</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ACK Request</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">3 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Request ACK</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">10</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future use</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">11</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Garlic Clove</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Variable</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Application data</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">12-223</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future use</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">224-253</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Experimental</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Variable</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Testing features</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">254</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Padding</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Variable</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Traffic shaping</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">255</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future extension</td>
    </tr>
  </tbody>
</table>
**Bilinmeyen Blokların İşlenmesi:**
<p>Gerçekleştirimler, tür numaraları bilinmeyen blokları yok saymak ve bunları dolgu olarak değerlendirmek zorundadır. Bu, ileriye dönük uyumluluğu sağlar.</p>
<h3 id="blok-sıralama-kuralları">Blok Sıralama Kuralları</h3>
<h3 id="ns-mesaj-sıralaması">NS Mesaj Sıralaması</h3>
<p><strong>Zorunlu:</strong> - DateTime bloğu MUTLAKA en başta olmalıdır</p>
<p><strong>İzin verilenler:</strong> - Garlic Clove (garlic encryption içinde tekil mesaj parçası) (type 11) - Seçenekler (type 5) - uygulanmışsa - Dolgu (type 254)</p>
<p><strong>Yasak:</strong> - NextKey (sonraki anahtar), ACK (alındı onayı), ACK Request (alındı onayı isteği), Termination (sonlandırma), MessageNumbers (ileti numaraları)</p>
<p><strong>Örnek Geçerli NS Yükü:</strong></p>
<pre tabindex="0"><code>DateTime (0) | Garlic Clove (11) | Garlic Clove (11) | Padding (254)
</code></pre><h3 id="nsr-mesaj-sıralaması">NSR Mesaj Sıralaması</h3>
<p><strong>Gerekli:</strong> - Yok (yük boş olabilir)</p>
<p><strong>İzin verilenler:</strong> - Garlic Clove (Garlic Message içindeki alt birim) (tip 11) - Options (tip 5) - eğer uygulanmışsa - Padding (tip 254)</p>
<p><strong>Yasak:</strong> - DateTime, NextKey, ACK, ACK Request, Termination, MessageNumbers</p>
<p><strong>Geçerli NSR Yükü Örneği:</strong></p>
<pre tabindex="0"><code>Garlic Clove (11) | Garlic Clove (11) | Padding (254)
</code></pre><p>veya</p>
<pre tabindex="0"><code>(empty - ACK only)
</code></pre><h3 id="es-mesaj-sıralaması">ES Mesaj Sıralaması</h3>
<p><strong>Gerekli:</strong> - Yok (payload (yük) boş olabilir)</p>
<p><strong>İzin verilen (herhangi bir sırada):</strong> - Garlic Clove (garlic mesajındaki alt birim) (type 11) - NextKey (Sonraki Anahtar) (type 7) - ACK (type 8) - ACK Request (ACK İsteği) (type 9) - Termination (Sonlandırma) (type 4) - uygulanmışsa - MessageNumbers (Mesaj Numaraları) (type 6) - uygulanmışsa - Options (Seçenekler) (type 5) - uygulanmışsa - Padding (Dolgu) (type 254)</p>
<p><strong>Özel Kurallar:</strong> - Sonlandırma bloğu (Padding hariç) en sonda OLMALIDIR - Padding (doldurma) bloğu en sonda OLMALIDIR - Birden fazla Garlic Cloves (garlic mesajındaki alt mesaj birimleri) kullanılabilir - En fazla 2 NextKey (bir sonraki anahtar bilgisi) bloğuna izin verilir (ileri ve geri) - Birden fazla Padding bloğuna İZİN VERİLMEZ</p>
<p><strong>Geçerli ES Yüklerine Örnekler:</strong></p>
<pre tabindex="0"><code>Garlic Clove (11) | ACK (8) | Padding (254)
</code></pre><pre tabindex="0"><code>NextKey (7) | Garlic Clove (11) | Garlic Clove (11)
</code></pre><pre tabindex="0"><code>NextKey (7) forward | NextKey (7) reverse | Garlic Clove (11)
</code></pre><pre tabindex="0"><code>ACK Request (9) | Garlic Clove (11) | Termination (4) | Padding (254)
</code></pre><h3 id="tarih-saat-bloğu-tür-0">Tarih-Saat Bloğu (Tür 0)</h3>
<p><strong>Amaç</strong>: Yeniden oynatma (replay) saldırılarını önleme ve saat kayması (clock skew) doğrulaması için zaman damgası</p>
<p><strong>Boyut</strong>: 7 bayt (3 bayt başlık + 4 bayt veri)</p>
<p><strong>Biçim:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+
| 0  |    4    |     timestamp     |
+----+----+----+----+----+----+----+
</code></pre><p><strong>Alanlar:</strong></p>
<ul>
<li><code>blk</code>: 0</li>
<li><code>size</code>: 4 (big-endian - yüksek anlamlı bayt önce)</li>
<li><code>timestamp</code>: 4 bayt - saniye cinsinden Unix zaman damgası (işaretsiz, big-endian)</li>
</ul>
<p><strong>Zaman Damgası Biçimi:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>timestamp <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())  <span style="color:#75715e"># Seconds since 1970-01-01 00:00:00 UTC</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wraps around in year 2106 (4-byte unsigned maximum)</span>
</span></span></code></pre></div><p><strong>Doğrulama Kuralları:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>MAX_CLOCK_SKEW_PAST <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>      <span style="color:#75715e"># 5 minutes</span>
</span></span><span style="display:flex;"><span>MAX_CLOCK_SKEW_FUTURE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>    <span style="color:#75715e"># 2 minutes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_datetime</span>(timestamp):
</span></span><span style="display:flex;"><span>    now <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span>    age <span style="color:#f92672">=</span> now <span style="color:#f92672">-</span> timestamp
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span>MAX_CLOCK_SKEW_FUTURE:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Too far in future</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&gt;</span> MAX_CLOCK_SKEW_PAST:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Too old</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><p><strong>Replay Saldırılarını Önleme:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReplayFilter</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, duration<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>duration <span style="color:#f92672">=</span> duration  <span style="color:#75715e"># 5 minutes</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>seen_messages <span style="color:#f92672">=</span> BloomFilter(size<span style="color:#f92672">=</span><span style="color:#ae81ff">100000</span>, false_positive_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cleanup_timer <span style="color:#f92672">=</span> RepeatTimer(<span style="color:#ae81ff">60</span>, self<span style="color:#f92672">.</span>cleanup)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_replay</span>(self, ephemeral_key, timestamp):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check timestamp validity</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> validate_datetime(timestamp):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if ephemeral key seen recently</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ephemeral_key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>seen_messages:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Replay attack</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add to seen messages</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>seen_messages<span style="color:#f92672">.</span>add(ephemeral_key)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cleanup</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire old entries (Bloom filter automatically ages out)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p><strong>Uygulama Notları:</strong></p>
<ol>
<li><strong>NS Mesajları</strong>: DateTime MUTLAKA ilk blok olmalıdır</li>
<li><strong>NSR/ES Mesajları</strong>: DateTime genellikle dahil edilmez</li>
<li><strong>Yeniden Oynatma Penceresi</strong>: 5 dakika önerilen asgari süredir</li>
<li><strong>Bloom Filtresi</strong>: Verimli yeniden oynatma tespiti için önerilir</li>
<li><strong>Saat Kayması</strong>: Geçmişte 5 dakikaya, gelecekte 2 dakikaya izin verin</li>
</ol>
<h3 id="garlic-clove-block-sarımsak-dişi-bloğu-type-11">Garlic Clove Block (Sarımsak Dişi Bloğu) (Type 11)</h3>
<p><strong>Amaç</strong>: İletilmek üzere I2NP mesajlarını kapsüller</p>
<p><strong>Biçim:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 11 |  size   |                        |
+----+----+----+                        +
|      Delivery Instructions            |
~                                       ~
|                                       |
+----+----+----+----+----+----+----+----+
|type|  Message_ID       | Expiration  |
+----+----+----+----+----+----+----+----+
     |      I2NP Message body           |
+----+                                  +
~                                       ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Alanlar:</strong></p>
<ul>
<li><code>blk</code>: 11</li>
<li><code>size</code>: clove (garlic encryption içindeki alt-ileti) toplam boyutu (değişken)</li>
<li><code>Delivery Instructions</code>: I2NP spesifikasyonunda belirtildiği gibi</li>
<li><code>type</code>: I2NP mesaj türü (1 bayt)</li>
<li><code>Message_ID</code>: I2NP mesaj kimliği (4 bayt)</li>
<li><code>Expiration</code>: Saniye cinsinden Unix zaman damgası (4 bayt)</li>
<li><code>I2NP Message body</code>: Değişken uzunluklu mesaj verisi</li>
</ul>
<p><strong>Teslimat Talimatı Biçimleri:</strong></p>
<p><strong>Yerel Teslimat</strong> (1 bayt):</p>
<pre tabindex="0"><code>+----+
|0x00|
+----+
</code></pre><p><strong>Hedefe Teslim</strong> (33 bayt):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|0x01|                                  |
+----+        Destination Hash         +
|              32 bytes                 |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Router Teslimi</strong> (33 bayt):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|0x02|                                  |
+----+         Router Hash              +
|              32 bytes                 |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Tunnel Teslimi</strong> (37 bayt):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|0x03|         Tunnel ID                |
+----+----+----+----+----+              +
|           Router Hash                 |
+              32 bytes                 +
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>I2NP Mesaj Başlığı</strong> (toplam 9 bayt):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|type|      msg_id       |  expiration   |
+----+----+----+----+----+----+----+----+
     |                                   |
</code></pre><ul>
<li><code>type</code>: I2NP mesaj türü (Database Store, Database Lookup, Data, vb.)</li>
<li><code>msg_id</code>: 4 baytlık mesaj kimliği</li>
<li><code>expiration</code>: 4 baytlık Unix zaman damgası (saniye)</li>
</ul>
<p><strong>ElGamal Clove Formatı&rsquo;ndan Önemli Farklar:</strong></p>
<ol>
<li><strong>Sertifika Yok</strong>: Sertifika alanı dahil edilmedi (ElGamal&rsquo;de kullanılmıyor)</li>
<li><strong>Clove ID Yok</strong>: Clove (garlic mesajı içindeki alt mesaj) ID&rsquo;si dahil edilmedi (her zaman 0&rsquo;dı)</li>
<li><strong>Clove Zaman Aşımı Yok</strong>: Bunun yerine I2NP mesaj zaman aşımı kullanılır</li>
<li><strong>Kompakt Başlık</strong>: 9 baytlık I2NP başlığı vs daha büyük ElGamal biçimi</li>
<li><strong>Her Clove Ayrı Bir Bloktur</strong>: CloveSet yapısı yok</li>
</ol>
<p><strong>Birden Çok Clove (garlic mesajı içindeki alt-mesaj birimi):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Multiple Garlic Cloves in one message</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    build_datetime_block(),
</span></span><span style="display:flex;"><span>    build_garlic_clove(i2np_message_1),
</span></span><span style="display:flex;"><span>    build_garlic_clove(i2np_message_2),
</span></span><span style="display:flex;"><span>    build_garlic_clove(i2np_message_3),
</span></span><span style="display:flex;"><span>    build_padding_block()
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>Cloves (garlic mesajındaki alt mesajlar) içindeki yaygın I2NP mesaj türleri:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Name</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Usage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DatabaseStore</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Publishing LeaseSet</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DatabaseLookup</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Requesting LeaseSet</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">5</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DeliveryStatus</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ACK (legacy, avoid in ECIES)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">20</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Streaming data</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">21</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Garlic</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Nested garlic messages</td>
    </tr>
  </tbody>
</table>
**Clove Processing (Clove'un işlenmesi):**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_garlic_clove</span>(clove_data):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Parse delivery instructions</span>
</span></span><span style="display:flex;"><span>    delivery_type <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x00</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Local delivery</span>
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x01</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Destination delivery</span>
</span></span><span style="display:flex;"><span>        dest_hash <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">33</span>]
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x02</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Router delivery</span>
</span></span><span style="display:flex;"><span>        router_hash <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">33</span>]
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x03</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Tunnel delivery</span>
</span></span><span style="display:flex;"><span>        tunnel_id <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;I&#39;</span>, clove_data[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">5</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        router_hash <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">37</span>]
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">37</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Parse I2NP header</span>
</span></span><span style="display:flex;"><span>    i2np_type <span style="color:#f92672">=</span> clove_data[offset]
</span></span><span style="display:flex;"><span>    msg_id <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;I&#39;</span>, clove_data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">5</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    expiration <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;I&#39;</span>, clove_data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">5</span>:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract I2NP body</span>
</span></span><span style="display:flex;"><span>    i2np_body <span style="color:#f92672">=</span> clove_data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span>:]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Process message</span>
</span></span><span style="display:flex;"><span>    process_i2np_message(i2np_type, msg_id, expiration, i2np_body)
</span></span></code></pre></div><h3 id="nextkey-block-sonraki-anahtar-bloğu-tip-7">NextKey Block (sonraki anahtar bloğu) (Tip 7)</h3>
<p><strong>Amaç</strong>: DH ratchet (ardışık anahtar yenileme mekanizması) anahtar değişimi</p>
<p><strong>Biçim (Anahtar Mevcut - 38 bayt):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 7  |   35    |flag|  key ID |         |
+----+----+----+----+----+----+         +
|                                       |
+     Next DH Ratchet Public Key        +
|              32 bytes                 |
+                                       +
|                                       |
+                             +----+----+
|                             |
+----+----+----+----+----+----+
</code></pre><p><strong>Biçim (Yalnızca Anahtar Kimliği - 6 bayt):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+
| 7  |    3    |flag|  key ID |
+----+----+----+----+----+----+
</code></pre><p><strong>Alanlar:</strong></p>
<ul>
<li><code>blk</code>: 7</li>
<li><code>size</code>: 3 (yalnızca ID) veya 35 (anahtarla)</li>
<li><code>flag</code>: 1 bayt - Bayrak bitleri</li>
<li><code>key ID</code>: 2 bayt - Big-endian anahtar tanımlayıcısı (0-32767)</li>
<li><code>Public Key</code>: 32 bayt - X25519 ortak anahtar (little-endian), eğer bayrak bit 0 = 1 ise</li>
</ul>
<p><strong>Bayrak Bitleri:</strong></p>
<pre tabindex="0"><code>Bit 7 6 5 4 3 2 1 0
    | | | | | | | |
    | | | | | | | +-- Bit 0: Key present (1) or ID only (0)
    | | | | | | +---- Bit 1: Reverse key (1) or forward key (0)
    | | | | | +------ Bit 2: Request reverse key (1) or no request (0)
    | | | | |
    +-+-+-+-+-------- Bits 3-7: Reserved (set to 0)
</code></pre><p><strong>Bayrak Örnekleri:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Forward key present</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x01</span>  <span style="color:#75715e"># Binary: 00000001</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Reverse key present</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x03</span>  <span style="color:#75715e"># Binary: 00000011</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Forward key ID only (ACK)</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00</span>  <span style="color:#75715e"># Binary: 00000000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Reverse key ID only (ACK)</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x02</span>  <span style="color:#75715e"># Binary: 00000010</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Forward key ID with reverse request</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x04</span>  <span style="color:#75715e"># Binary: 00000100</span>
</span></span></code></pre></div><p><strong>Anahtar Kimliği Kuralları:</strong></p>
<ul>
<li>ID&rsquo;ler ardışık: 0, 1, 2, &hellip;, 32767</li>
<li>ID yalnızca yeni bir anahtar üretildiğinde artar</li>
<li>Bir sonraki ratchet (anahtar ilerletme mekanizması) gerçekleşene kadar birden çok mesaj için aynı ID kullanılır</li>
<li>En yüksek ID 32767&rsquo;dir (sonrasında yeni bir oturum başlatılmalıdır)</li>
</ul>
<p><strong>Kullanım Örnekleri:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Initiating ratchet (sender generates new key)</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>,           <span style="color:#75715e"># Key present, forward</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    public_key<span style="color:#f92672">=</span>sender_new_pk
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Replying to ratchet (receiver generates new key)</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>,           <span style="color:#75715e"># Key present, reverse</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    public_key<span style="color:#f92672">=</span>receiver_new_pk
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Acknowledging ratchet (no new key from sender)</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x02</span>,           <span style="color:#75715e"># ID only, reverse</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Requesting reverse ratchet</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x04</span>,           <span style="color:#75715e"># Request reverse, forward ID</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>İşleme Mantığı:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_nextkey_block</span>(block):
</span></span><span style="display:flex;"><span>    flags <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>flags
</span></span><span style="display:flex;"><span>    key_id <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>key_id
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    key_present <span style="color:#f92672">=</span> (flags <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x01</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    is_reverse <span style="color:#f92672">=</span> (flags <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x02</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    request_reverse <span style="color:#f92672">=</span> (flags <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x04</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> key_present:
</span></span><span style="display:flex;"><span>        public_key <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_reverse:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Reverse key received</span>
</span></span><span style="display:flex;"><span>            perform_dh_ratchet(receiver_key<span style="color:#f92672">=</span>public_key, key_id<span style="color:#f92672">=</span>key_id)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Sender should ACK with own key ID</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Forward key received</span>
</span></span><span style="display:flex;"><span>            perform_dh_ratchet(sender_key<span style="color:#f92672">=</span>public_key, key_id<span style="color:#f92672">=</span>key_id)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Receiver should reply with reverse key</span>
</span></span><span style="display:flex;"><span>            send_reverse_key(generate_new_key())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Key ID only (ACK)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_reverse:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Reverse key ACK</span>
</span></span><span style="display:flex;"><span>            confirm_reverse_ratchet(key_id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Forward key ACK</span>
</span></span><span style="display:flex;"><span>            confirm_forward_ratchet(key_id)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request_reverse:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Sender requests receiver to generate new key</span>
</span></span><span style="display:flex;"><span>        send_reverse_key(generate_new_key())
</span></span></code></pre></div><p><strong>Birden Çok NextKey Bloğu:</strong></p>
<p>Her iki yön eşzamanlı olarak ratcheting (kademeli anahtar yenileme mekanizması) yapıyorsa, tek bir ES mesajı en fazla 2 NextKey bloğu içerebilir:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Both directions ratcheting</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    NextKeyBlock(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, public_key<span style="color:#f92672">=</span>forward_key),  <span style="color:#75715e"># Forward</span>
</span></span><span style="display:flex;"><span>    NextKeyBlock(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, public_key<span style="color:#f92672">=</span>reverse_key),  <span style="color:#75715e"># Reverse</span>
</span></span><span style="display:flex;"><span>    build_garlic_clove(data)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><h3 id="ack-bloğu-tip-8">ACK Bloğu (Tip 8)</h3>
<p><strong>Amaç</strong>: Alınan mesajları bant içi olarak onaylamak</p>
<p><strong>Biçim (Tekli ACK (onay) - 7 bayt):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+
| 8  |    4    |tagsetid |   N     |
+----+----+----+----+----+----+----+
</code></pre><p><strong>Biçim (Birden Çok ACK):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 8  |  size   |tagsetid |   N     |    |
+----+----+----+----+----+----+----+    +
|            more ACKs                  |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Alanlar:</strong></p>
<ul>
<li><code>blk</code>: 8</li>
<li><code>size</code>: 4 * ACK sayısı (en az 4)</li>
<li>Her ACK için:
<ul>
<li><code>tagsetid</code>: 2 bayt - Big-endian (en anlamlı bayt önce) etiket kümesi kimliği (0-65535)</li>
<li><code>N</code>: 2 bayt - Big-endian mesaj numarası (0-65535)</li>
</ul>
</li>
</ul>
<p><strong>Tag Set ID (etiket kümesi kimliği) Belirlenmesi:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Tag set 0 (initial, after NSR)</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># After first ratchet (tag set 1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Both Alice and Bob sent key ID 0</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># After second ratchet (tag set 2)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Alice sent key ID 1, Bob still using key ID 0</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># After third ratchet (tag set 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Alice still using key ID 1, Bob sent key ID 1</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span></code></pre></div><p><strong>Tek ACK Örneği:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ACK message from tag set 5, message number 127</span>
</span></span><span style="display:flex;"><span>ack_block <span style="color:#f92672">=</span> ACKBlock(
</span></span><span style="display:flex;"><span>    tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>    message_number<span style="color:#f92672">=</span><span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wire format (7 bytes):</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 08 00 04 00 05 00 7F</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  |  |  |  |</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  |  |  |  +-- N (127)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  |  +--------- N high byte</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  +------------ tagset_id (5)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  +--------------- tagset_id high byte</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  +------------------ size (4)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># +--------------------- type (8)</span>
</span></span></code></pre></div><p><strong>Birden Çok ACK Örneği:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ACK three messages</span>
</span></span><span style="display:flex;"><span>ack_block <span style="color:#f92672">=</span> ACKBlock([
</span></span><span style="display:flex;"><span>    (tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, N<span style="color:#f92672">=</span><span style="color:#ae81ff">42</span>),
</span></span><span style="display:flex;"><span>    (tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, N<span style="color:#f92672">=</span><span style="color:#ae81ff">43</span>),
</span></span><span style="display:flex;"><span>    (tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>, N<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wire format (15 bytes):</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 08 00 0C 00 03 00 2A 00 03 00 2B 00 04 00 00</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#                (ts=3, N=42) (ts=3, N=43) (ts=4, N=0)</span>
</span></span></code></pre></div><p><strong>İşleme:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_ack_block</span>(block):
</span></span><span style="display:flex;"><span>    num_acks <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>size <span style="color:#f92672">//</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_acks):
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> i <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>        tagset_id <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;H&#39;</span>, block<span style="color:#f92672">.</span>data[offset:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        message_num <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;H&#39;</span>, block<span style="color:#f92672">.</span>data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mark message as acknowledged</span>
</span></span><span style="display:flex;"><span>        mark_acked(tagset_id, message_num)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># May trigger retransmission timeout cancellation</span>
</span></span><span style="display:flex;"><span>        cancel_retransmit_timer(tagset_id, message_num)
</span></span></code></pre></div><p><strong>ACK&rsquo;ler Ne Zaman Gönderilmeli:</strong></p>
<ol>
<li><strong>Açık ACK İsteği</strong>: ACK İsteği bloğuna her zaman yanıt verin</li>
<li><strong>LeaseSet Teslimi</strong>: Gönderen, iletiye LeaseSet eklediğinde</li>
<li><strong>Oturum Kurulumu</strong>: NS/NSR&rsquo;yi ACK edebilir (NS/NSR: New Session/New Session Reply - Yeni Oturum/Yeni Oturum Yanıtı; protokol her ne kadar ES (Existing Session - Mevcut Oturum) üzerinden örtük ACK&rsquo;i tercih etse de)</li>
<li><strong>Ratchet Onayı</strong>: NextKey (bir sonraki anahtar) alımını ACK edebilir (ratchet: kriptografik anahtar ilerletme mekanizması)</li>
<li><strong>Uygulama Katmanı</strong>: Üst katman protokolünün gerektirdiği şekilde (ör. Streaming (I2P akış katmanı))</li>
</ol>
<p><strong>ACK Zamanlaması:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ACKManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pending_acks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ack_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">request_ack</span>(self, tagset_id, message_num):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pending_acks<span style="color:#f92672">.</span>append((tagset_id, message_num))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>ack_timer:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Delay ACK briefly to allow higher layer to respond</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>ack_timer <span style="color:#f92672">=</span> set_timer(<span style="color:#ae81ff">0.1</span>, self<span style="color:#f92672">.</span>send_acks)  <span style="color:#75715e"># 100ms</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_acks</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>pending_acks <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> has_outbound_data():
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># No higher layer data, send explicit ACK</span>
</span></span><span style="display:flex;"><span>            send_es_message(build_ack_block(self<span style="color:#f92672">.</span>pending_acks))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Otherwise, ACK will piggyback on next ES message</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pending_acks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ack_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><h3 id="ack-istek-bloğu-tip-9">ACK İstek Bloğu (Tip 9)</h3>
<p><strong>Amaç</strong>: Mevcut mesaj için bant içi alındı onayı talep etmek</p>
<p><strong>Biçim:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+
| 9  |    1    |flg |
+----+----+----+----+
</code></pre><p><strong>Alanlar:</strong></p>
<ul>
<li><code>blk</code>: 9</li>
<li><code>size</code>: 1</li>
<li><code>flg</code>: 1 bayt - Bayraklar (tüm bitler şu anda kullanılmamaktadır, 0&rsquo;a ayarlanmıştır)</li>
</ul>
<p><strong>Kullanım:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Request ACK for this message</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    build_ack_request_block(),
</span></span><span style="display:flex;"><span>    build_garlic_clove(important_data)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>Alıcı Yanıtı:</strong></p>
<p>ACK isteği alındığında:</p>
<ol>
<li><strong>Anlık Veriyle</strong>: ACK bloğunu anlık yanıta dahil edin</li>
<li><strong>Anlık Veri Olmadan</strong>: Bir zamanlayıcı başlatın (ör. 100ms) ve zamanlayıcı süresi dolarsa ACK ile boş bir ES gönderin</li>
<li><strong>Tag Set ID (etiket kümesi kimliği)</strong>: Geçerli gelen tagset kimliğini kullanın</li>
<li><strong>Mesaj Numarası</strong>: Alınan session tag (oturum etiketi) ile ilişkili mesaj numarasını kullanın</li>
</ol>
<p><strong>İşleme:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_ack_request</span>(message):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract message identification</span>
</span></span><span style="display:flex;"><span>    tagset_id <span style="color:#f92672">=</span> message<span style="color:#f92672">.</span>tagset_id
</span></span><span style="display:flex;"><span>    message_num <span style="color:#f92672">=</span> message<span style="color:#f92672">.</span>message_num
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Schedule ACK</span>
</span></span><span style="display:flex;"><span>    schedule_ack(tagset_id, message_num)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># If no data to send immediately, start timer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> has_pending_data():
</span></span><span style="display:flex;"><span>        set_timer(<span style="color:#ae81ff">0.1</span>, <span style="color:#66d9ef">lambda</span>: send_ack_only(tagset_id, message_num))
</span></span></code></pre></div><p><strong>ACK İsteği ne zaman kullanılır:</strong></p>
<ol>
<li><strong>Kritik Mesajlar</strong>: Alındı onayı verilmesi gereken mesajlar</li>
<li><strong>LeaseSet Teslimi</strong>: Bir LeaseSet&rsquo;i paket içine dahil ederken</li>
<li><strong>Session Ratchet (oturum ratchet mekanizması)</strong>: NextKey block (bir sonraki anahtar bloğu) gönderdikten sonra</li>
<li><strong>İletimin Sonu</strong>: Gönderenin artık gönderecek verisi kalmadığında ancak onay istediğinde</li>
</ol>
<p><strong>Ne Zaman Kullanılmamalı:</strong></p>
<ol>
<li><strong>Akış Protokolü</strong>: Akış katmanı ACK&rsquo;leri (alındı onayı) işler</li>
<li><strong>Yüksek Frekanslı Mesajlar</strong>: Her mesaj için ACK isteğinden kaçının (ek yük)</li>
<li><strong>Önemsiz Datagramlar</strong>: Ham datagramlar genellikle ACK&rsquo;lere gerek duymaz</li>
</ol>
<h3 id="sonlandırma-bloğu-tür-4">Sonlandırma Bloğu (Tür 4)</h3>
<p><strong>Durum</strong>: UYGULANMADI</p>
<p><strong>Amaç</strong>: Oturumu sorunsuz bir şekilde sonlandırmak</p>
<p><strong>Biçim:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 4  |  size   | rsn|     addl data     |
+----+----+----+----+                   +
~               ...                     ~
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Alanlar:</strong></p>
<ul>
<li><code>blk</code>: 4</li>
<li><code>size</code>: 1 veya daha fazla bayt</li>
<li><code>rsn</code>: 1 bayt - Sebep kodu</li>
<li><code>addl data</code>: İsteğe bağlı ek veri (biçim nedene bağlıdır)</li>
</ul>
<p><strong>Gerekçe Kodları:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Code</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Meaning</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Additional Data</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Normal close / unspecified</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Termination received</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Idle timeout</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None (implementation-specific)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Resource exhaustion</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None (implementation-specific)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implementation-specific</td>
    </tr>
  </tbody>
</table>
**Kullanım (uygulandığında):**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Normal session close</span>
</span></span><span style="display:flex;"><span>termination <span style="color:#f92672">=</span> TerminationBlock(
</span></span><span style="display:flex;"><span>    reason<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    additional_data<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Session termination due to received termination</span>
</span></span><span style="display:flex;"><span>termination <span style="color:#f92672">=</span> TerminationBlock(
</span></span><span style="display:flex;"><span>    reason<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    additional_data<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>Kurallar:</strong></p>
<ul>
<li>Padding (doldurma) dışında son blok olmak ZORUNLUDUR</li>
<li>Varsa Termination (sonlandırma) sonrasında Padding gelmesi ZORUNLUDUR</li>
<li>NS veya NSR iletilerinde izin verilmez</li>
<li>Yalnızca ES iletilerinde izin verilir</li>
</ul>
<h3 id="seçenekler-bloğu-tür-5">Seçenekler Bloğu (Tür 5)</h3>
<p><strong>Durum</strong>: UYGULANMADI</p>
<p><strong>Amaç</strong>: Oturum parametrelerinin müzakere edilmesi</p>
<p><strong>Biçim:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 5  |  size   |ver |flg |STL |STimeout |
+----+----+----+----+----+----+----+----+
|  SOTW   |  RITW   |tmin|tmax|rmin|rmax|
+----+----+----+----+----+----+----+----+
|  tdmy   |  rdmy   |  tdelay |  rdelay |
+----+----+----+----+----+----+----+----+
|              more_options             |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Alanlar:</strong></p>
<ul>
<li><code>blk</code>: 5</li>
<li><code>size</code>: 21 veya daha fazla bayt</li>
<li><code>ver</code>: 1 bayt - Protokol sürümü (0 olmalı)</li>
<li><code>flg</code>: 1 bayt - Bayraklar (şu anda tüm bitler kullanılmıyor)</li>
<li><code>STL</code>: 1 bayt - Oturum etiketi uzunluğu (8 olmalı)</li>
<li><code>STimeout</code>: 2 bayt - Oturum boşta kalma zaman aşımı (saniye cinsinden, big-endian)</li>
<li><code>SOTW</code>: 2 bayt - Gönderen Giden Etiket Penceresi (big-endian)</li>
<li><code>RITW</code>: 2 bayt - Alıcı Gelen Etiket Penceresi (big-endian)</li>
<li><code>tmin</code>, <code>tmax</code>, <code>rmin</code>, <code>rmax</code>: Her biri 1 bayt - Dolgu parametreleri (4.4 sabit noktalı)</li>
<li><code>tdmy</code>: 2 bayt - Göndermeye istekli olunan en yüksek dummy traffic (sahte trafik) (bytes/sec, big-endian)</li>
<li><code>rdmy</code>: 2 bayt - İstenen dummy traffic (bytes/sec, big-endian)</li>
<li><code>tdelay</code>: 2 bayt - Eklemeye istekli olunan en yüksek mesaj içi gecikme (msec, big-endian)</li>
<li><code>rdelay</code>: 2 bayt - İstenen mesaj içi gecikme (msec, big-endian)</li>
<li><code>more_options</code>: Değişken uzunluklu - Gelecekteki genişletmeler</li>
</ul>
<p><strong>Dolgu Parametreleri (4.4 Sabit Noktalı):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encode_padding_ratio</span>(ratio):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Encode padding ratio as 4.4 fixed-point
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ratio: 0.0 to 15.9375
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    returns: 0x00 to 0xFF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> int(ratio <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decode_padding_ratio</span>(encoded):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Decode 4.4 fixed-point to ratio
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    encoded: 0x00 to 0xFF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    returns: 0.0 to 15.9375
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> encoded <span style="color:#f92672">/</span> <span style="color:#ae81ff">16.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Examples:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x00 = 0.0 (no padding)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x01 = 0.0625 (6.25% padding)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x10 = 1.0 (100% padding - double traffic)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x80 = 8.0 (800% padding - 9x traffic)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0xFF = 15.9375 (1593.75% padding)</span>
</span></span></code></pre></div><p><strong>Tag Window Negotiation (Etiket Penceresi Müzakeresi):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># SOTW: Sender&#39;s recommendation for receiver&#39;s inbound window</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RITW: Sender&#39;s declaration of own inbound window</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver calculates actual inbound window:</span>
</span></span><span style="display:flex;"><span>inbound_window <span style="color:#f92672">=</span> calculate_window(
</span></span><span style="display:flex;"><span>    sender_suggestion<span style="color:#f92672">=</span>SOTW,
</span></span><span style="display:flex;"><span>    own_constraints<span style="color:#f92672">=</span>MAX_INBOUND_TAGS,
</span></span><span style="display:flex;"><span>    own_resources<span style="color:#f92672">=</span>available_memory()
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sender uses:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - RITW to know how far ahead receiver will accept</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Own SOTW to hint optimal window size</span>
</span></span></code></pre></div><p><strong>Varsayılan Değerler (Seçenekler müzakere edilmediğinde):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>DEFAULT_OPTIONS <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;version&#39;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;session_tag_length&#39;</span>: <span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">600</span>,  <span style="color:#75715e"># 10 minutes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;sender_outbound_tag_window&#39;</span>: <span style="color:#ae81ff">160</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;receiver_inbound_tag_window&#39;</span>: <span style="color:#ae81ff">160</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tmin&#39;</span>: <span style="color:#ae81ff">0x00</span>,  <span style="color:#75715e"># No minimum padding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tmax&#39;</span>: <span style="color:#ae81ff">0x10</span>,  <span style="color:#75715e"># Up to 100% padding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rmin&#39;</span>: <span style="color:#ae81ff">0x00</span>,  <span style="color:#75715e"># No minimum requested</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rmax&#39;</span>: <span style="color:#ae81ff">0x10</span>,  <span style="color:#75715e"># Up to 100% requested</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tdmy&#39;</span>: <span style="color:#ae81ff">0</span>,     <span style="color:#75715e"># No dummy traffic</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rdmy&#39;</span>: <span style="color:#ae81ff">0</span>,     <span style="color:#75715e"># No dummy traffic requested</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tdelay&#39;</span>: <span style="color:#ae81ff">0</span>,   <span style="color:#75715e"># No delay</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rdelay&#39;</span>: <span style="color:#ae81ff">0</span>    <span style="color:#75715e"># No delay requested</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="mesaj-numaraları-bloğu-tür-6">Mesaj Numaraları Bloğu (Tür 6)</h3>
<p><strong>Durum</strong>: UYGULANMADI</p>
<p><strong>Amaç</strong>: Önceki etiket kümesinde gönderilen son mesajı belirtir (boşluk algılamayı etkinleştirir)</p>
<p><strong>Biçim:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+
| 6  |    2    |  PN    |
+----+----+----+----+----+
</code></pre><p><strong>Alanlar:</strong></p>
<ul>
<li><code>blk</code>: 6</li>
<li><code>size</code>: 2</li>
<li><code>PN</code>: 2 bayt - Önceki etiket kümesinin son ileti numarası (big-endian (yüksek anlamlı bayt önce), 0-65535)</li>
</ul>
<p><strong>PN (Previous Number - Önceki Numara) Tanımı:</strong></p>
<p>PN, önceki etiket kümesinde gönderilen son etiketin indeksidir.</p>
<p><strong>Kullanım (uygulandığında):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># After ratcheting to new tag set</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Old tag set: sent messages 0-4095</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># New tag set: sending first message</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    MessageNumbersBlock(PN<span style="color:#f92672">=</span><span style="color:#ae81ff">4095</span>),
</span></span><span style="display:flex;"><span>    build_garlic_clove(data)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>Alıcı Faydaları:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_message_numbers</span>(pn_value):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Receiver can now:</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1. Determine if any messages were skipped</span>
</span></span><span style="display:flex;"><span>    highest_received_in_old_tagset <span style="color:#f92672">=</span> <span style="color:#ae81ff">4090</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> pn_value <span style="color:#f92672">&gt;</span> highest_received_in_old_tagset:
</span></span><span style="display:flex;"><span>        missing_count <span style="color:#f92672">=</span> pn_value <span style="color:#f92672">-</span> highest_received_in_old_tagset
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 5 messages were never received</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 2. Delete tags higher than PN from old tagset</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tag_index <span style="color:#f92672">in</span> range(pn_value <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, MAX_TAG_INDEX):
</span></span><span style="display:flex;"><span>        delete_tag(old_tagset, tag_index)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 3. Expire tags ≤ PN after grace period (e.g., 2 minutes)</span>
</span></span><span style="display:flex;"><span>    schedule_deletion(old_tagset, delay<span style="color:#f92672">=</span><span style="color:#ae81ff">120</span>)
</span></span></code></pre></div><p><strong>Kurallar:</strong></p>
<ul>
<li>0 numaralı etiket kümesinde kesinlikle gönderilmemelidir (önceki etiket kümesi yok)</li>
<li>Yalnızca ES messages (ES iletileri) içinde gönderilir</li>
<li>Yalnızca yeni etiket kümesinin ilk ileti(ler)inde gönderilir</li>
<li>PN değeri, gönderenin bakış açısına göredir (gönderenin gönderdiği son etiket)</li>
</ul>
<p><strong>Signal ile ilişkisi:</strong></p>
<p>Signal Double Ratchet&rsquo;te, PN mesaj başlığındadır. ECIES&rsquo;te ise şifreli yük içinde bulunur ve isteğe bağlıdır.</p>
<h3 id="dolgu-bloğu-tür-254">Dolgu Bloğu (Tür 254)</h3>
<p><strong>Amaç</strong>: Trafik analizine karşı direnç ve mesaj boyutunun gizlenmesi</p>
<p><strong>Biçim:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|254 |  size   |      padding           |
+----+----+----+                        +
|                                       |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Alanlar:</strong></p>
<ul>
<li><code>blk</code>: 254</li>
<li><code>size</code>: 0-65516 bayt (big-endian; yüksek anlamlı bayt önde)</li>
<li><code>padding</code>: Rastgele veya sıfır veri</li>
</ul>
<p><strong>Kurallar:</strong></p>
<ul>
<li>Mesajdaki son blok olmalıdır</li>
<li>Birden fazla dolgu bloğuna izin verilmez</li>
<li>Sıfır uzunlukta olabilir (yalnızca 3 baytlık başlık)</li>
<li>Dolgu verisi sıfır değerli baytlar veya rastgele baytlar olabilir</li>
</ul>
<p><strong>Varsayılan Doldurma:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>DEFAULT_PADDING_MIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>DEFAULT_PADDING_MAX <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_default_padding</span>():
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(DEFAULT_PADDING_MIN, DEFAULT_PADDING_MAX)
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>bytes(size)  <span style="color:#75715e"># or zeros</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> PaddingBlock(size, data)
</span></span></code></pre></div><p><strong>Trafik Analizi Direncine Yönelik Stratejiler:</strong></p>
<p><strong>Strateji 1: Rastgele Boyut (Varsayılan)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Add 0-15 bytes random padding to each message</span>
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">15</span>)
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>Strateji 2: En Yakın Katına Yuvarlama</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Round total message size to next multiple of 64</span>
</span></span><span style="display:flex;"><span>target_size <span style="color:#f92672">=</span> ((message_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">63</span>) <span style="color:#f92672">//</span> <span style="color:#ae81ff">64</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> target_size <span style="color:#f92672">-</span> message_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>  <span style="color:#75715e"># -3 for block header</span>
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>Strateji 3: Sabit Mesaj Boyutları</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Always send 1KB messages</span>
</span></span><span style="display:flex;"><span>TARGET_MESSAGE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> TARGET_MESSAGE_SIZE <span style="color:#f92672">-</span> message_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>Strateji 4: Müzakere Edilen Dolgu (Seçenekler bloğu)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Calculate padding based on negotiated parameters</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tmin, tmax from Options block</span>
</span></span><span style="display:flex;"><span>min_padding <span style="color:#f92672">=</span> int(payload_size <span style="color:#f92672">*</span> tmin_ratio)
</span></span><span style="display:flex;"><span>max_padding <span style="color:#f92672">=</span> int(payload_size <span style="color:#f92672">*</span> tmax_ratio)
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(min_padding, max_padding)
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>Yalnızca Dolgudan Oluşan Mesajlar:</strong></p>
<p>Mesajlar tamamen dolgudan oluşabilir (uygulama verisi içermez):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Dummy traffic message</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    PaddingBlock(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">500</span>), random<span style="color:#f92672">.</span>bytes(<span style="color:#f92672">...</span>))
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>Uygulama Notları:</strong></p>
<ol>
<li><strong>Tamamen Sıfır Dolgu</strong>: Kabul edilebilir (ChaCha20 tarafından şifrelenecektir)</li>
<li><strong>Rastgele Dolgu</strong>: Şifrelemeden sonra ek bir güvenlik sağlamaz ancak daha fazla entropi kullanır</li>
<li><strong>Performans</strong>: Rastgele dolgu üretimi hesaplama açısından maliyetli olabilir; sıfır kullanmayı değerlendirin</li>
<li><strong>Bellek</strong>: Büyük dolgu blokları bant genişliğini tüketir; maksimum boyut konusunda dikkatli olun</li>
</ol>
<hr>
<h2 id="uygulama-kılavuzu">Uygulama Kılavuzu</h2>
<h3 id="önkoşullar">Önkoşullar</h3>
<p><strong>Kriptografik Kütüphaneler:</strong></p>
<ul>
<li><strong>X25519</strong>: libsodium, NaCl veya Bouncy Castle</li>
<li><strong>ChaCha20-Poly1305</strong>: libsodium, OpenSSL 1.1.0+ veya Bouncy Castle</li>
<li><strong>SHA-256</strong>: OpenSSL, Bouncy Castle veya yerleşik dil desteği</li>
<li><strong>Elligator2</strong>: Sınırlı kütüphane desteği; özel gerçekleştirim gerektirebilir</li>
</ul>
<p><strong>Elligator2 (eliptik eğri noktalarını rastgele görünümlü veriye eşleyen teknik) Uygulaması:</strong></p>
<p>Elligator2 yaygın olarak uygulanmıyor. Seçenekler:</p>
<ol>
<li><strong>OBFS4</strong>: Tor&rsquo;un obfs4 pluggable transport (takılabilir taşıma) özelliği Elligator2 gerçekleştirmesini içerir</li>
<li><strong>Özel Gerçekleme</strong>: <a href="https://elligator.cr.yp.to/elligator-20130828.pdf">Elligator2 makalesi</a>
 temel alınarak</li>
<li><strong>kleshni/Elligator</strong>: GitHub&rsquo;da referans uygulaması</li>
</ol>
<p><strong>Java I2P Notu:</strong> Java I2P, özel Elligator2 (bir kriptografik gizleme tekniği) eklemeleriyle net.i2p.crypto.eddsa kütüphanesini kullanır.</p>
<h3 id="önerilen-uygulama-sırası">Önerilen Uygulama Sırası</h3>
<p><strong>Aşama 1: Temel Kriptografi</strong> 1. X25519 DH (Diffie-Hellman) anahtar üretimi ve değişimi 2. ChaCha20-Poly1305 AEAD (İlişkili Verili Kimlik Doğrulamalı Şifreleme) şifreleme/şifre çözme 3. SHA-256 karmalama ve MixHash (durum karmasını güncelleme işlemi) 4. HKDF (HMAC tabanlı anahtar türetme fonksiyonu) ile anahtar türetme 5. Elligator2 (eliptik eğri noktalarını rastgele görünüme eşleyen kodlama) kodlama/kod çözme (başlangıçta test vektörleri kullanılabilir)</p>
<p><strong>Aşama 2: Mesaj Biçimleri</strong> 1. NS message (bağlı olmayan) - en basit biçim 2. NS message (bağlı) - statik anahtar ekler 3. NSR message 4. ES message 5. Blok ayrıştırma ve oluşturma</p>
<p><strong>Aşama 3: Oturum Yönetimi</strong> 1. Oturum oluşturma ve depolama 2. Etiket kümesi yönetimi (gönderen ve alıcı) 3. Oturum etiketi ratchet (kademeli yenileme mekanizması) 4. Simetrik anahtar ratchet 5. Etiket arama ve pencere yönetimi</p>
<p><strong>Aşama 4: DH Ratcheting (Diffie-Hellman kademeli mekanizması)</strong> 1. NextKey blokunun işlenmesi 2. DH ratchet KDF (Anahtar Türetme Fonksiyonu) 3. Ratchet sonrasında etiket kümesi oluşturma 4. Birden çok etiket kümesinin yönetimi</p>
<p><strong>Aşama 5: Protokol Mantığı</strong> 1. NS/NSR/ES durum makinesi 2. Tekrar saldırısı önleme (DateTime, Bloom filtresi) 3. Yeniden iletim mantığı (çoklu NS/NSR) 4. ACK işleme</p>
<p><strong>Aşama 6: Entegrasyon</strong> 1. I2NP Garlic Clove (garlic encryption içindeki &lsquo;diş&rsquo; öğesi) işleme 2. LeaseSet paketleme 3. Akış protokolü entegrasyonu 4. Datagram protokolü entegrasyonu</p>
<h3 id="gönderici-gerçeklemesi">Gönderici Gerçeklemesi</h3>
<p><strong>Giden Oturum Yaşam Döngüsü:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, destination, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> destination
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> bound
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>NEW
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Keys for NS message</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> bound:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>static_key <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>static_keypair
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Will be populated after NSR</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_keyratchet <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_keyratchet <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Timing</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Retransmission</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_attempts <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_initial_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Send NS message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build NS message</span>
</span></span><span style="display:flex;"><span>        ns_message <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>build_ns_message(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send</span>
</span></span><span style="display:flex;"><span>        send_to_network(self<span style="color:#f92672">.</span>destination, ns_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Track for retransmission</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_attempts<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;message&#39;</span>: ns_message,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;time&#39;</span>: now(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;ephemeral_key&#39;</span>: self<span style="color:#f92672">.</span>ephemeral_keypair,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;kdf_state&#39;</span>: self<span style="color:#f92672">.</span>save_kdf_state()
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Start timer</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> set_timer(<span style="color:#ae81ff">1.0</span>, self<span style="color:#f92672">.</span>on_ns_timeout)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>PENDING_REPLY
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_ns_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Construct NS message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># KDF initialization</span>
</span></span><span style="display:flex;"><span>        chainKey, h <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>initialize_kdf()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Ephemeral key section</span>
</span></span><span style="display:flex;"><span>        elg2_ephemeral <span style="color:#f92672">=</span> ENCODE_ELG2(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> self<span style="color:#f92672">.</span>destination<span style="color:#f92672">.</span>static_key)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># es DH</span>
</span></span><span style="display:flex;"><span>        es_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                       self<span style="color:#f92672">.</span>destination<span style="color:#f92672">.</span>static_key)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, es_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_static <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt static key section</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>bound:
</span></span><span style="display:flex;"><span>            static_section <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>static_key<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            static_section <span style="color:#f92672">=</span> bytes(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        static_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_static, <span style="color:#ae81ff">0</span>, static_section, h)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> static_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ss DH (if bound)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>bound:
</span></span><span style="display:flex;"><span>            ss_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>static_key<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                          self<span style="color:#f92672">.</span>destination<span style="color:#f92672">.</span>static_key)
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(chainKey, ss_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> k_static
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build payload blocks</span>
</span></span><span style="display:flex;"><span>        payload_data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>build_ns_payload(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt payload</span>
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_payload, nonce, payload_data, h)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> payload_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Save KDF state for NSR processing</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_chainkey <span style="color:#f92672">=</span> chainKey
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_hash <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Assemble message</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> elg2_ephemeral <span style="color:#f92672">+</span> static_ciphertext <span style="color:#f92672">+</span> payload_ciphertext
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_ns_payload</span>(self, application_data):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Build NS payload blocks&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        blocks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># DateTime block (required, first)</span>
</span></span><span style="display:flex;"><span>        blocks<span style="color:#f92672">.</span>append(build_datetime_block())
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Garlic Clove(s) with application data</span>
</span></span><span style="display:flex;"><span>        blocks<span style="color:#f92672">.</span>append(build_garlic_clove(application_data))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Optionally bundle LeaseSet</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> should_send_leaseset():
</span></span><span style="display:flex;"><span>            blocks<span style="color:#f92672">.</span>append(build_garlic_clove(build_leaseset_store()))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Padding</span>
</span></span><span style="display:flex;"><span>        blocks<span style="color:#f92672">.</span>append(build_padding_block(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">15</span>)))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> encode_blocks(blocks)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_nsr_received</span>(self, nsr_message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Process NSR and establish ES session&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Cancel retransmission timer</span>
</span></span><span style="display:flex;"><span>        cancel_timer(self<span style="color:#f92672">.</span>ns_timer)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Parse NSR</span>
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>        elg2_bob_ephemeral <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">40</span>]
</span></span><span style="display:flex;"><span>        key_section_mac <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">40</span>:<span style="color:#ae81ff">56</span>]
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">56</span>:]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Find corresponding NS attempt</span>
</span></span><span style="display:flex;"><span>        ns_state <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>find_ns_by_tag(tag)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> ns_state:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;NSR tag doesn&#39;t match any NS&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Restore KDF state</span>
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> ns_state[<span style="color:#e6db74">&#39;chainkey&#39;</span>]
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> ns_state[<span style="color:#e6db74">&#39;hash&#39;</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decode Bob&#39;s ephemeral key</span>
</span></span><span style="display:flex;"><span>        bob_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(elg2_bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix tag and Bob&#39;s ephemeral into hash</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> tag)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ee DH</span>
</span></span><span style="display:flex;"><span>        ee_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>private_key, bob_ephemeral)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ee_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># se DH</span>
</span></span><span style="display:flex;"><span>        se_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>static_key<span style="color:#f92672">.</span>private_key, bob_ephemeral)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, se_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_key_section <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify key section MAC</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            DECRYPT(k_key_section, <span style="color:#ae81ff">0</span>, key_section_mac, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;NSR key section MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> key_section_mac)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Split for bidirectional ES</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        k_ab <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Alice → Bob</span>
</span></span><span style="display:flex;"><span>        k_ba <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Bob → Alice</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize ES tagsets</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ab)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ba)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt NSR payload</span>
</span></span><span style="display:flex;"><span>        k_nsr <span style="color:#f92672">=</span> HKDF(k_ba, ZEROLEN, <span style="color:#e6db74">&#34;AttachPayloadKDF&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> DECRYPT(k_nsr, <span style="color:#ae81ff">0</span>, payload_ciphertext, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;NSR payload MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process NSR payload blocks</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>process_payload_blocks(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Session established</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send ES message (implicit ACK)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>send_es_ack()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_es_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Send ES message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">!=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Session not established&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get next tag and key</span>
</span></span><span style="display:flex;"><span>        tag, index <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>outbound_keyratchet<span style="color:#f92672">.</span>get_key(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Construct nonce</span>
</span></span><span style="display:flex;"><span>        nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build payload blocks</span>
</span></span><span style="display:flex;"><span>        payload_data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>build_es_payload(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># AEAD encryption</span>
</span></span><span style="display:flex;"><span>        ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, payload_data, tag)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Assemble message</span>
</span></span><span style="display:flex;"><span>        es_message <span style="color:#f92672">=</span> tag <span style="color:#f92672">+</span> ciphertext
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send</span>
</span></span><span style="display:flex;"><span>        send_to_network(self<span style="color:#f92672">.</span>destination, es_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update activity</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if ratchet needed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>should_ratchet():
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>initiate_ratchet()
</span></span></code></pre></div><h3 id="alıcı-gerçeklemesi">Alıcı Gerçeklemesi</h3>
<p><strong>Gelen Oturumun Yaşam Döngüsü:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Keys</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>remote_ephemeral_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>remote_static_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Tagsets</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Timing</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Paired session</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>paired_outbound <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">try_decrypt_ns</span>(message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Attempt to decrypt as NS message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Parse NS structure</span>
</span></span><span style="display:flex;"><span>        elg2_ephemeral <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">32</span>]
</span></span><span style="display:flex;"><span>        static_ciphertext <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">80</span>]  <span style="color:#75715e"># 32 + 16</span>
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">80</span>:]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decode ephemeral key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            alice_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(elg2_ephemeral)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Not a valid Elligator2 encoding</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check replay</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_replay(alice_ephemeral):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># KDF initialization</span>
</span></span><span style="display:flex;"><span>        chainKey, h <span style="color:#f92672">=</span> initialize_kdf()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix keys</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> alice_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># es DH</span>
</span></span><span style="display:flex;"><span>        es_shared <span style="color:#f92672">=</span> DH(context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>private_key, alice_ephemeral)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, es_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_static <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt static key section</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            static_data <span style="color:#f92672">=</span> DECRYPT(k_static, <span style="color:#ae81ff">0</span>, static_ciphertext, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Not a valid NS message</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> static_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if bound or unbound</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> static_data <span style="color:#f92672">==</span> bytes(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Unbound</span>
</span></span><span style="display:flex;"><span>            alice_static_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> k_static
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Bound - perform ss DH</span>
</span></span><span style="display:flex;"><span>            alice_static_key <span style="color:#f92672">=</span> static_data
</span></span><span style="display:flex;"><span>            ss_shared <span style="color:#f92672">=</span> DH(context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>private_key, alice_static_key)
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(chainKey, ss_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt payload</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> DECRYPT(k_payload, nonce, payload_ciphertext, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> payload_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create session</span>
</span></span><span style="display:flex;"><span>        session <span style="color:#f92672">=</span> InboundSession()
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>remote_ephemeral_key <span style="color:#f92672">=</span> alice_ephemeral
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>remote_static_key <span style="color:#f92672">=</span> alice_static_key
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> (alice_static_key <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>ns_chainkey <span style="color:#f92672">=</span> chainKey
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>ns_hash <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Extract destination if bound</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>bound:
</span></span><span style="display:flex;"><span>            session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> extract_destination_from_payload(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process payload</span>
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>process_payload_blocks(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> session
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_nsr_reply</span>(self, reply_payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Send NSR message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate NSR tagset</span>
</span></span><span style="display:flex;"><span>        tagsetKey <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>ns_chainkey, ZEROLEN, <span style="color:#e6db74">&#34;SessionReplyTags&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        nsr_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(self<span style="color:#f92672">.</span>ns_chainkey, tagsetKey)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get tag</span>
</span></span><span style="display:flex;"><span>        tag, _ <span style="color:#f92672">=</span> nsr_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix tag into hash</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(self<span style="color:#f92672">.</span>ns_hash <span style="color:#f92672">||</span> tag)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate ephemeral key</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>        bob_ephemeral <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>        elg2_bob_ephemeral <span style="color:#f92672">=</span> ENCODE_ELG2(bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix ephemeral key</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>ns_chainkey
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ee DH</span>
</span></span><span style="display:flex;"><span>        ee_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                      self<span style="color:#f92672">.</span>remote_ephemeral_key)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ee_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># se DH</span>
</span></span><span style="display:flex;"><span>        se_shared <span style="color:#f92672">=</span> DH(context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                      self<span style="color:#f92672">.</span>remote_ephemeral_key)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, se_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_key_section <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt key section (empty)</span>
</span></span><span style="display:flex;"><span>        key_section_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_key_section, <span style="color:#ae81ff">0</span>, ZEROLEN, h)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> key_section_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Split for bidirectional ES</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        k_ab <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Alice → Bob</span>
</span></span><span style="display:flex;"><span>        k_ba <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Bob → Alice</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize ES tagsets</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ab)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ba)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build reply payload</span>
</span></span><span style="display:flex;"><span>        payload_data <span style="color:#f92672">=</span> build_payload_blocks(reply_payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt payload</span>
</span></span><span style="display:flex;"><span>        k_nsr <span style="color:#f92672">=</span> HKDF(k_ba, ZEROLEN, <span style="color:#e6db74">&#34;AttachPayloadKDF&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_nsr, <span style="color:#ae81ff">0</span>, payload_data, h)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Assemble NSR</span>
</span></span><span style="display:flex;"><span>        nsr_message <span style="color:#f92672">=</span> tag <span style="color:#f92672">+</span> elg2_bob_ephemeral <span style="color:#f92672">+</span> key_section_ciphertext <span style="color:#f92672">+</span> payload_ciphertext
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send</span>
</span></span><span style="display:flex;"><span>        send_to_network(self<span style="color:#f92672">.</span>destination, nsr_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Wait for ES</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>AWAITING_ES
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_es_received</span>(self, es_message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Process first ES message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>AWAITING_ES:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># First ES received, confirms session</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process ES message</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>process_es_message(es_message)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_es_message</span>(self, es_message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Decrypt and process ES message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Extract tag</span>
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> es_message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>        ciphertext <span style="color:#f92672">=</span> es_message[<span style="color:#ae81ff">8</span>:]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Look up tag</span>
</span></span><span style="display:flex;"><span>        index <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>lookup_tag(tag)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Tag not found&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get key</span>
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>inbound_keyratchet<span style="color:#f92672">.</span>get_key(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Construct nonce</span>
</span></span><span style="display:flex;"><span>        nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> DECRYPT(key, nonce, ciphertext, tag)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;ES MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process blocks</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>process_payload_blocks(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update activity</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span></code></pre></div><h3 id="mesaj-sınıflandırması">Mesaj Sınıflandırması</h3>
<p><strong>Mesaj Türlerini Ayırt Etme:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">classify_message</span>(message):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Determine message type&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Minimum lengths</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">24</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Too short</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for session tag (8 bytes)</span>
</span></span><span style="display:flex;"><span>    tag <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Try ES decryption first (most common)</span>
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> lookup_session_by_tag(tag)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;ES&#39;</span>, session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Try NSR decryption (tag + Elligator2 key)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">72</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if bytes 8-40 are valid Elligator2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            nsr_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(message[<span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">40</span>])
</span></span><span style="display:flex;"><span>            nsr_session <span style="color:#f92672">=</span> find_pending_nsr_by_tag(tag)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> nsr_session:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;NSR&#39;</span>, nsr_session)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Try NS decryption (starts with Elligator2 key)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">96</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            ns_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">32</span>])
</span></span><span style="display:flex;"><span>            ns_session <span style="color:#f92672">=</span> InboundSession<span style="color:#f92672">.</span>try_decrypt_ns(message)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ns_session:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;NS&#39;</span>, ns_session)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check ElGamal/AES (for dual-key compatibility)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">514</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (len(message) <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Might be ElGamal NS</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;ELGAMAL_NS&#39;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> len(message) <span style="color:#f92672">%</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Might be ElGamal ES</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;ELGAMAL_ES&#39;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Unknown message type</span>
</span></span></code></pre></div><h3 id="oturum-yönetimi-en-iyi-uygulamaları">Oturum Yönetimi En İyi Uygulamaları</h3>
<p><strong>Oturum Depolama:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SessionKeyManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Outbound sessions (one per destination)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_sessions <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># destination -&gt; OutboundSession</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Inbound sessions (multiple per destination during transition)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions <span style="color:#f92672">=</span> []  <span style="color:#75715e"># [InboundSession]</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Session tag lookup (fast path for ES messages)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tag_to_session <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># tag -&gt; InboundSession</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Limits</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_inbound_sessions <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tags_per_session <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_outbound_session</span>(self, destination):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get or create outbound session&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> destination <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>outbound_sessions:
</span></span><span style="display:flex;"><span>            session <span style="color:#f92672">=</span> OutboundSession(destination)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>outbound_sessions[destination] <span style="color:#f92672">=</span> session
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>outbound_sessions[destination]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_inbound_session</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Add new inbound session&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check limits</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(self<span style="color:#f92672">.</span>inbound_sessions) <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_inbound_sessions:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>expire_oldest_session()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions<span style="color:#f92672">.</span>append(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add tags to lookup table</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>register_session_tags(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_session_tags</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Register session&#39;s tags in lookup table&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>get_all_tags():
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>tag_to_session[tag] <span style="color:#f92672">=</span> session
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lookup_tag</span>(self, tag):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Fast tag lookup&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>tag_to_session<span style="color:#f92672">.</span>get(tag)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">expire_sessions</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Periodic session expiration&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        now_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire outbound sessions</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> dest, session <span style="color:#f92672">in</span> list(self<span style="color:#f92672">.</span>outbound_sessions<span style="color:#f92672">.</span>items()):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time(now_time) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>outbound_sessions[dest]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire inbound sessions</span>
</span></span><span style="display:flex;"><span>        expired <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>inbound_sessions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time(now_time) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:
</span></span><span style="display:flex;"><span>                expired<span style="color:#f92672">.</span>append(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> expired:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>remove_inbound_session(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_inbound_session</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Remove inbound session and clean up tags&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions<span style="color:#f92672">.</span>remove(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Remove tags from lookup</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>get_all_tags():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tag <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>tag_to_session:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>tag_to_session[tag]
</span></span></code></pre></div><p><strong>Bellek Yönetimi:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TagMemoryManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, max_memory_kb<span style="color:#f92672">=</span><span style="color:#ae81ff">10240</span>):  <span style="color:#75715e"># 10 MB default</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_memory <span style="color:#f92672">=</span> max_memory_kb <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_memory <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tags_per_session <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>min_tags_per_session <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_tag_memory</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Calculate memory used by session tags&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        tag_count <span style="color:#f92672">=</span> len(session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>tags)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Each tag: 8 bytes (tag) + 2 bytes (index) + 32 bytes (key, optional)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># + overhead</span>
</span></span><span style="display:flex;"><span>        bytes_per_tag <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span> <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>defer_keys <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> tag_count <span style="color:#f92672">*</span> bytes_per_tag
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_pressure</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Check if under memory pressure&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>current_memory <span style="color:#f92672">&gt;</span> (self<span style="color:#f92672">.</span>max_memory <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.9</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_pressure</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Reduce memory usage when under pressure&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>check_pressure():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 1: Reduce look-ahead windows</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> all_sessions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">&gt;</span> self<span style="color:#f92672">.</span>min_tags_per_session:
</span></span><span style="display:flex;"><span>                session<span style="color:#f92672">.</span>reduce_look_ahead(self<span style="color:#f92672">.</span>min_tags_per_session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 2: Trim old tags aggressively</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> all_sessions:
</span></span><span style="display:flex;"><span>            session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>trim_behind(aggressive<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 3: Refuse new ratchets</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> all_sessions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>should_ratchet():
</span></span><span style="display:flex;"><span>                session<span style="color:#f92672">.</span>defer_ratchet <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 4: Expire idle sessions early</span>
</span></span><span style="display:flex;"><span>        expire_idle_sessions(threshold<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span>)  <span style="color:#75715e"># 5 min instead of 10</span>
</span></span></code></pre></div><h3 id="test-stratejileri">Test Stratejileri</h3>
<p><strong>Birim Testleri:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_x25519_dh</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test X25519 key exchange&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    alice_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    alice_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(alice_sk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    bob_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    bob_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(bob_sk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Both sides compute same shared secret</span>
</span></span><span style="display:flex;"><span>    alice_shared <span style="color:#f92672">=</span> DH(alice_sk, bob_pk)
</span></span><span style="display:flex;"><span>    bob_shared <span style="color:#f92672">=</span> DH(bob_sk, alice_pk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> alice_shared <span style="color:#f92672">==</span> bob_shared
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_elligator2_encode_decode</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test Elligator2 roundtrip&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    sk <span style="color:#f92672">=</span> GENERATE_PRIVATE_ELG2()
</span></span><span style="display:flex;"><span>    pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(sk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    encoded <span style="color:#f92672">=</span> ENCODE_ELG2(pk)
</span></span><span style="display:flex;"><span>    decoded <span style="color:#f92672">=</span> DECODE_ELG2(encoded)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> decoded <span style="color:#f92672">==</span> pk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_chacha_poly_encrypt_decrypt</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test ChaCha20-Poly1305 AEAD&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> construct_nonce(<span style="color:#ae81ff">42</span>)
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello, I2P!&#34;</span>
</span></span><span style="display:flex;"><span>    ad <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;associated_data&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext, ad)
</span></span><span style="display:flex;"><span>    decrypted <span style="color:#f92672">=</span> DECRYPT(key, nonce, ciphertext, ad)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> decrypted <span style="color:#f92672">==</span> plaintext
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_session_tag_ratchet</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test session tag generation&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    sessTag_ck <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    tagset <span style="color:#f92672">=</span> SessionTagRatchet(sessTag_ck)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate 100 tags</span>
</span></span><span style="display:flex;"><span>    tags <span style="color:#f92672">=</span> [tagset<span style="color:#f92672">.</span>get_next_tag() <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>)]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># All tags should be unique</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> len(set(tags)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Each tag should be 8 bytes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> tags:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(tag) <span style="color:#f92672">==</span> <span style="color:#ae81ff">8</span>
</span></span></code></pre></div><p><strong>Entegrasyon Testleri:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_ns_nsr_handshake</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test NS/NSR handshake&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice creates outbound session</span>
</span></span><span style="display:flex;"><span>    alice_session <span style="color:#f92672">=</span> OutboundSession(bob_destination, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice sends NS</span>
</span></span><span style="display:flex;"><span>    ns_message <span style="color:#f92672">=</span> alice_session<span style="color:#f92672">.</span>build_ns_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello Bob&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob receives NS</span>
</span></span><span style="display:flex;"><span>    bob_session <span style="color:#f92672">=</span> InboundSession<span style="color:#f92672">.</span>try_decrypt_ns(ns_message)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> bob_session <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> bob_session<span style="color:#f92672">.</span>bound <span style="color:#f92672">==</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob sends NSR</span>
</span></span><span style="display:flex;"><span>    nsr_message <span style="color:#f92672">=</span> bob_session<span style="color:#f92672">.</span>build_nsr_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello Alice&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice receives NSR</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>on_nsr_received(nsr_message)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> alice_session<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Both should have matching ES tagsets</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># (Cannot directly compare, but can test by sending ES messages)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_es_bidirectional</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test ES messages in both directions&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># (After NS/NSR handshake)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice sends ES to Bob</span>
</span></span><span style="display:flex;"><span>    es_alice_to_bob <span style="color:#f92672">=</span> alice_session<span style="color:#f92672">.</span>send_es_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Data from Alice&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob receives ES</span>
</span></span><span style="display:flex;"><span>    bob_session<span style="color:#f92672">.</span>process_es_message(es_alice_to_bob)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob sends ES to Alice</span>
</span></span><span style="display:flex;"><span>    es_bob_to_alice <span style="color:#f92672">=</span> bob_session<span style="color:#f92672">.</span>send_es_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Data from Bob&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice receives ES</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>process_es_message(es_bob_to_alice)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_dh_ratchet</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test DH ratchet&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># (After established session)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice initiates ratchet</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>initiate_ratchet()
</span></span><span style="display:flex;"><span>    nextkey_alice <span style="color:#f92672">=</span> build_nextkey_block(
</span></span><span style="display:flex;"><span>        flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>,
</span></span><span style="display:flex;"><span>        key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        public_key<span style="color:#f92672">=</span>alice_new_key
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send to Bob</span>
</span></span><span style="display:flex;"><span>    bob_session<span style="color:#f92672">.</span>process_nextkey_block(nextkey_alice)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob replies</span>
</span></span><span style="display:flex;"><span>    nextkey_bob <span style="color:#f92672">=</span> build_nextkey_block(
</span></span><span style="display:flex;"><span>        flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>,
</span></span><span style="display:flex;"><span>        key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        public_key<span style="color:#f92672">=</span>bob_new_key
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send to Alice</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>process_nextkey_block(nextkey_bob)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Both should now be using new tagsets</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> alice_session<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> bob_session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>Test Vektörleri:</strong></p>
<p>Spesifikasyonda yer alan test vektörlerini uygulayın:</p>
<ol>
<li><strong>Noise IK el sıkışması</strong>: Standart Noise test vektörlerini kullanın</li>
<li><strong>HKDF</strong>: RFC 5869 test vektörlerini kullanın</li>
<li><strong>ChaCha20-Poly1305</strong>: RFC 7539 test vektörlerini kullanın</li>
<li><strong>Elligator2</strong>: Elligator2 makalesinden veya OBFS4&rsquo;ten test vektörlerini kullanın</li>
</ol>
<p><strong>Birlikte Çalışabilirlik Testleri:</strong></p>
<ol>
<li><strong>Java I2P</strong>: Java I2P referans uygulamasına karşı test edin</li>
<li><strong>i2pd</strong>: C++ i2pd uygulamasına karşı test edin</li>
<li><strong>Paket Yakalamaları</strong>: Mesaj biçimlerini doğrulamak için Wireshark dissector (varsa) kullanın</li>
<li><strong>Uygulamalar Arası</strong>: Uygulamalar arasında gönderme/alma yapabilen bir test düzeneği oluşturun</li>
</ol>
<h3 id="performansla-ilgili-hususlar">Performansla İlgili Hususlar</h3>
<p><strong>Anahtar Üretimi:</strong></p>
<p>Elligator2 (kriptografik eşleme yöntemi) anahtar üretimi hesaplama açısından pahalıdır (%50 reddedilme oranı):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KeyPool</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Pre-generate keys in background thread&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, pool_size<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pool <span style="color:#f92672">=</span> Queue(maxsize<span style="color:#f92672">=</span>pool_size)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>generator_thread <span style="color:#f92672">=</span> Thread(target<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>generate_keys, daemon<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>generator_thread<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_keys</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>full():
</span></span><span style="display:flex;"><span>                keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Also compute encoded form</span>
</span></span><span style="display:flex;"><span>                encoded <span style="color:#f92672">=</span> ENCODE_ELG2(keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>put((keypair, encoded))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_keypair</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>get(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1.0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> Empty:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Pool exhausted, generate inline</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> generate_elg2_keypair()
</span></span></code></pre></div><p><strong>Etiket Sorgulaması:</strong></p>
<p>O(1) etiket araması için hash tabloları kullanın:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FastTagLookup</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tag_to_session <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Python dict is hash table</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_tag</span>(self, tag, session, index):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 8-byte tag as bytes is hashable</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tag_to_session[tag] <span style="color:#f92672">=</span> (session, index)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lookup_tag</span>(self, tag):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>tag_to_session<span style="color:#f92672">.</span>get(tag)
</span></span></code></pre></div><p><strong>Bellek Optimizasyonu:</strong></p>
<p>Simetrik anahtar üretimini ertele:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DeferredKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Only generate keys when needed&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cache <span style="color:#f92672">=</span> LRUCache(maxsize<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># Cache recent keys</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check cache first</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>cache:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>cache[index]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate keys up to index</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&lt;</span> index:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">==</span> index:
</span></span><span style="display:flex;"><span>                key <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>cache[index] <span style="color:#f92672">=</span> key
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> key
</span></span></code></pre></div><p><strong>Toplu İşleme:</strong></p>
<p>Birden çok mesajı toplu olarak işleyin:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_message_batch</span>(messages):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Process multiple messages efficiently&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    results <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Group by type</span>
</span></span><span style="display:flex;"><span>    ns_messages <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    nsr_messages <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    es_messages <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> messages:
</span></span><span style="display:flex;"><span>        msg_type <span style="color:#f92672">=</span> classify_message(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> msg_type[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;NS&#39;</span>:
</span></span><span style="display:flex;"><span>            ns_messages<span style="color:#f92672">.</span>append(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> msg_type[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;NSR&#39;</span>:
</span></span><span style="display:flex;"><span>            nsr_messages<span style="color:#f92672">.</span>append(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> msg_type[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ES&#39;</span>:
</span></span><span style="display:flex;"><span>            es_messages<span style="color:#f92672">.</span>append(msg)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Process in batches</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ES messages are most common, process first</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> es_messages:
</span></span><span style="display:flex;"><span>        results<span style="color:#f92672">.</span>append(process_es_message(msg))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> nsr_messages:
</span></span><span style="display:flex;"><span>        results<span style="color:#f92672">.</span>append(process_nsr_message(msg))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> ns_messages:
</span></span><span style="display:flex;"><span>        results<span style="color:#f92672">.</span>append(process_ns_message(msg))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> results
</span></span></code></pre></div><hr>
<h2 id="güvenlik-hususları">Güvenlik Hususları</h2>
<h3 id="tehdit-modeli">Tehdit Modeli</h3>
<p><strong>Saldırganın Yetenekleri:</strong></p>
<ol>
<li><strong>Pasif Gözlemci</strong>: Tüm ağ trafiğini gözlemleyebilir</li>
<li><strong>Aktif Saldırgan</strong>: İletileri enjekte edebilir, değiştirebilir, düşürebilir, yeniden oynatabilir</li>
<li><strong>Kompromize Düğüm</strong>: Bir router&rsquo;ı veya bir hedefi kompromize edebilir</li>
<li><strong>Trafik Analizi</strong>: Trafik kalıpları üzerinde istatistiksel analiz yapabilir</li>
</ol>
<p><strong>Güvenlik Hedefleri:</strong></p>
<ol>
<li><strong>Gizlilik</strong>: Mesaj içerikleri gözlemciden gizlenir</li>
<li><strong>Kimlik Doğrulama</strong>: Göndericinin kimliği doğrulanır (bağlı oturumlar için)</li>
<li><strong>İleri Gizlilik</strong>: Anahtarlar ele geçirilse bile geçmiş mesajlar gizli kalır</li>
<li><strong>Yeniden Oynatmayı Önleme</strong>: Eski mesajlar yeniden oynatılamaz</li>
<li><strong>Trafik Gizleme</strong>: El sıkışmaları rastgele veriden ayırt edilemez</li>
</ol>
<h3 id="kriptografik-varsayımlar">Kriptografik Varsayımlar</h3>
<p><strong>Zorluk Varsayımları:</strong></p>
<ol>
<li><strong>X25519 CDH</strong>: Curve25519 üzerinde Hesaplamalı Diffie-Hellman (CDH) probleminin çözümü hesaplamalı olarak zordur</li>
<li><strong>ChaCha20 PRF</strong>: ChaCha20 bir psödo-rastgele fonksiyondur</li>
<li><strong>Poly1305 MAC</strong>: Poly1305, seçilmiş mesaj saldırısı altında taklit edilemezlik sağlar</li>
<li><strong>SHA-256 CR</strong>: SHA-256 çakışmaya dayanıklıdır</li>
<li><strong>HKDF Security</strong>: HKDF, anahtarları eş dağılımlı olacak şekilde çıkarır ve genişletir</li>
</ol>
<p><strong>Güvenlik Düzeyleri:</strong></p>
<ul>
<li><strong>X25519</strong>: ~128-bit güvenlik düzeyi (eğrinin mertebesi 2^252)</li>
<li><strong>ChaCha20</strong>: 256-bit anahtarlar, 256-bit güvenlik düzeyi</li>
<li><strong>Poly1305</strong>: 128-bit güvenlik düzeyi (çakışma olasılığı)</li>
<li><strong>SHA-256</strong>: 128-bit çakışma direnci, 256-bit ön-imaj direnci</li>
</ul>
<h3 id="anahtar-yönetimi">Anahtar Yönetimi</h3>
<p><strong>Anahtar Oluşturma:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Use cryptographically secure RNG</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">CSRNG</span>(length):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># GOOD: os.urandom, secrets.token_bytes (Python)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># GOOD: /dev/urandom (Linux)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># GOOD: BCryptGenRandom (Windows)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># BAD: random.random(), Math.random() (NOT cryptographically secure)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> os<span style="color:#f92672">.</span>urandom(length)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Validate keys</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_x25519_key</span>(pubkey):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for weak keys (all zeros, small order points)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> pubkey <span style="color:#f92672">==</span> bytes(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> WeakKeyError(<span style="color:#e6db74">&#34;All-zero public key&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform DH to check for weak shared secrets</span>
</span></span><span style="display:flex;"><span>    test_shared <span style="color:#f92672">=</span> DH(test_private_key, pubkey)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> test_shared <span style="color:#f92672">==</span> bytes(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> WeakKeyError(<span style="color:#e6db74">&#34;Results in zero shared secret&#34;</span>)
</span></span></code></pre></div><p><strong>Anahtar Depolama:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Protect private keys</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecureKeyStorage</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Store in memory with protection</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>keys <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Option 1: Memory locking (prevent swapping to disk)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># mlock(self.keys)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Option 2: Encrypted storage</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># self.encryption_key = derive_from_password()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">store_key</span>(self, key_id, private_key):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Option: Encrypt before storage</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># encrypted = encrypt(private_key, self.encryption_key)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># self.keys[key_id] = encrypted</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>keys[key_id] <span style="color:#f92672">=</span> private_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_key</span>(self, key_id):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Securely wipe memory</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> key_id <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>keys:
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>keys[key_id]
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Overwrite with zeros before deletion</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(key)):
</span></span><span style="display:flex;"><span>                key[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>keys[key_id]
</span></span></code></pre></div><p><strong>Anahtar Döndürme:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Rotate keys regularly</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KeyRotationPolicy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_messages_per_tagset <span style="color:#f92672">=</span> <span style="color:#ae81ff">4096</span>  <span style="color:#75715e"># Ratchet before 65535</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tagset_age <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>       <span style="color:#75715e"># 10 minutes</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_session_age <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>      <span style="color:#75715e"># 1 hour</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">should_ratchet</span>(self, tagset):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (tagset<span style="color:#f92672">.</span>messages_sent <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_messages_per_tagset <span style="color:#f92672">or</span>
</span></span><span style="display:flex;"><span>                tagset<span style="color:#f92672">.</span>age() <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_tagset_age)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">should_replace_session</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> session<span style="color:#f92672">.</span>age() <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_session_age
</span></span></code></pre></div><h3 id="saldırı-azaltma-önlemleri">Saldırı Azaltma Önlemleri</h3>
<h3 id="yeniden-oynatma-saldırılarına-karşı-önlemler">Yeniden Oynatma Saldırılarına Karşı Önlemler</h3>
<p><strong>DateTime (tarih-saat) Doğrulaması:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>MAX_CLOCK_SKEW_PAST <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>MAX_CLOCK_SKEW_FUTURE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_datetime</span>(timestamp):
</span></span><span style="display:flex;"><span>    now <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span>    age <span style="color:#f92672">=</span> now <span style="color:#f92672">-</span> timestamp
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span>MAX_CLOCK_SKEW_FUTURE:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> ReplayError(<span style="color:#e6db74">&#34;Timestamp too far in future&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&gt;</span> MAX_CLOCK_SKEW_PAST:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> ReplayError(<span style="color:#e6db74">&#34;Timestamp too old&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><p><strong>NS Mesajları için Bloom Filtresi:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReplayFilter</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, capacity<span style="color:#f92672">=</span><span style="color:#ae81ff">100000</span>, error_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>, duration<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bloom <span style="color:#f92672">=</span> BloomFilter(capacity<span style="color:#f92672">=</span>capacity, error_rate<span style="color:#f92672">=</span>error_rate)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>duration <span style="color:#f92672">=</span> duration
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>entries <span style="color:#f92672">=</span> []  <span style="color:#75715e"># (timestamp, ephemeral_key)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_replay</span>(self, ephemeral_key, timestamp):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Validate timestamp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> validate_datetime(timestamp):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check Bloom filter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ephemeral_key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>bloom:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Potential replay (or false positive)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Check exact match in entries</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> ts, key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>entries:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> key <span style="color:#f92672">==</span> ephemeral_key:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Definite replay</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add to filter</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bloom<span style="color:#f92672">.</span>add(ephemeral_key)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>entries<span style="color:#f92672">.</span>append((timestamp, ephemeral_key))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire old entries</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>expire_old_entries()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">expire_old_entries</span>(self):
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>entries <span style="color:#f92672">=</span> [(ts, key) <span style="color:#66d9ef">for</span> ts, key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>entries
</span></span><span style="display:flex;"><span>                       <span style="color:#66d9ef">if</span> now <span style="color:#f92672">-</span> ts <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>duration]
</span></span></code></pre></div><p><strong>Session Tag (oturum etiketi) Tek Seferlik Kullanım:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_session_tag</span>(tag):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Look up tag</span>
</span></span><span style="display:flex;"><span>    entry <span style="color:#f92672">=</span> tagset<span style="color:#f92672">.</span>lookup_tag(tag)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> entry <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Invalid session tag&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># CRITICAL: Remove tag immediately (one-time use)</span>
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>remove_tag(tag)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Use associated key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> entry<span style="color:#f92672">.</span>key, entry<span style="color:#f92672">.</span>index
</span></span></code></pre></div><h3 id="key-compromise-impersonation-kci-anahtar-ele-geçirilmesi-kaynaklı-kimlik-taklidi-için-önlemler">Key Compromise Impersonation (KCI) (anahtar ele geçirilmesi kaynaklı kimlik taklidi) için Önlemler</h3>
<p><strong>Sorun</strong>: NS mesaj kimlik doğrulaması KCI&rsquo;ye (Key Compromise Impersonation - anahtar ele geçirilmesiyle kimlik taklidi) karşı savunmasızdır (Kimlik Doğrulama Düzeyi 1)</p>
<p><strong>Azaltma</strong>:</p>
<ol>
<li>Mümkün olan en kısa sürede NSR (Authentication Level 2 - Kimlik Doğrulama Seviyesi 2) durumuna geçin</li>
<li>Güvenlik açısından kritik işlemler için NS payload (yük)&lsquo;a güvenmeyin</li>
<li>Geri döndürülemez işlemleri gerçekleştirmeden önce NSR onayını bekleyin</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_ns_message</span>(ns_message):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># NS authenticated at Level 1 (KCI vulnerable)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Do NOT perform security-critical operations yet</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract sender&#39;s static key</span>
</span></span><span style="display:flex;"><span>    sender_key <span style="color:#f92672">=</span> ns_message<span style="color:#f92672">.</span>static_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Mark session as pending Level 2 authentication</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>auth_level <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>sender_key <span style="color:#f92672">=</span> sender_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send NSR</span>
</span></span><span style="display:flex;"><span>    send_nsr_reply(session)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_first_es_message</span>(es_message):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Now we have Level 2 authentication (KCI resistant)</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>auth_level <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Safe to perform security-critical operations</span>
</span></span><span style="display:flex;"><span>    process_security_critical_operation(es_message)
</span></span></code></pre></div><h3 id="hizmet-reddi-dos-azaltma-önlemleri">Hizmet Reddi (DoS) Azaltma Önlemleri</h3>
<p><strong>NS Flood Koruması:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NSFloodProtection</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_count <span style="color:#f92672">=</span> defaultdict(int)  <span style="color:#75715e"># source -&gt; count</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timestamps <span style="color:#f92672">=</span> defaultdict(list)  <span style="color:#75715e"># source -&gt; [timestamps]</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_ns_per_source <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>rate_window <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># seconds</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_concurrent_ns <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_ns_allowed</span>(self, source):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Global limit</span>
</span></span><span style="display:flex;"><span>        total_pending <span style="color:#f92672">=</span> sum(self<span style="color:#f92672">.</span>ns_count<span style="color:#f92672">.</span>values())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> total_pending <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_concurrent_ns:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Per-source rate limit</span>
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        timestamps <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>ns_timestamps[source]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Remove old timestamps</span>
</span></span><span style="display:flex;"><span>        timestamps <span style="color:#f92672">=</span> [ts <span style="color:#66d9ef">for</span> ts <span style="color:#f92672">in</span> timestamps <span style="color:#66d9ef">if</span> now <span style="color:#f92672">-</span> ts <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>rate_window]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timestamps[source] <span style="color:#f92672">=</span> timestamps
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check rate</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(timestamps) <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_ns_per_source:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Allow NS</span>
</span></span><span style="display:flex;"><span>        timestamps<span style="color:#f92672">.</span>append(now)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_count[source] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_session_established</span>(self, source):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrease pending count</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>ns_count[source] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>ns_count[source] <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>Etiket Depolama Sınırları:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TagStorageLimit</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, max_tags<span style="color:#f92672">=</span><span style="color:#ae81ff">1000000</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tags <span style="color:#f92672">=</span> max_tags
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">can_create_session</span>(self, look_ahead):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">+</span> look_ahead <span style="color:#f92672">&gt;</span> self<span style="color:#f92672">.</span>max_tags:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_tags</span>(self, count):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">+=</span> count
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_tags</span>(self, count):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">-=</span> count
</span></span></code></pre></div><p><strong>Uyarlanabilir Kaynak Yönetimi:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AdaptiveResourceManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>  <span style="color:#75715e"># 0 = low, 1 = medium, 2 = high, 3 = critical</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">adjust_parameters</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Normal operation</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">160</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Moderate load</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">80</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">800</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># High load</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">32</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">500</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:  <span style="color:#75715e"># load_level == 3</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Critical load</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">16</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span></code></pre></div><h3 id="trafik-analizi-direnci">Trafik Analizi Direnci</h3>
<p><strong>Elligator2 (eliptik eğri noktalarını rastgele veri gibi gösteren bir teknik) Kodlaması:</strong></p>
<p>El sıkışma mesajlarının rastgele veriden ayırt edilemez olmasını sağlar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># NS and NSR start with Elligator2-encoded ephemeral keys</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Observer cannot distinguish from random 32-byte string</span>
</span></span></code></pre></div><p><strong>Dolgu Stratejileri:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Resist message size fingerprinting</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_padding</span>(payload, strategy<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;random&#39;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> strategy <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;random&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Random padding 0-15 bytes</span>
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">15</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> strategy <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;round&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Round to next 64-byte boundary</span>
</span></span><span style="display:flex;"><span>        target <span style="color:#f92672">=</span> ((len(payload) <span style="color:#f92672">+</span> <span style="color:#ae81ff">63</span>) <span style="color:#f92672">//</span> <span style="color:#ae81ff">64</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> target <span style="color:#f92672">-</span> len(payload) <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>  <span style="color:#75715e"># -3 for block header</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> strategy <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;fixed&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Always 1KB messages</span>
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">-</span> len(payload) <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> build_padding_block(size)
</span></span></code></pre></div><p><strong>Zamanlama Saldırıları:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Use constant-time operations</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">constant_time_compare</span>(a, b):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Constant-time byte string comparison&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(a) <span style="color:#f92672">!=</span> len(b):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x, y <span style="color:#f92672">in</span> zip(a, b):
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">|=</span> x <span style="color:#f92672">^</span> y
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Constant-time MAC verification</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">verify_mac</span>(computed_mac, received_mac):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> constant_time_compare(computed_mac, received_mac):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Always take same time regardless of where comparison fails</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> AuthenticationError(<span style="color:#e6db74">&#34;MAC verification failed&#34;</span>)
</span></span></code></pre></div><h3 id="uygulama-tuzakları">Uygulama Tuzakları</h3>
<p><strong>Yaygın Hatalar:</strong></p>
<ol>
<li><strong>Nonce (tek kullanımlık sayı) Yeniden Kullanımı</strong>: (key, nonce) çiftlerini ASLA yeniden kullanmayın
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># BAD: Reusing nonce with same key</span>
</span></span><span style="display:flex;"><span>ciphertext1 <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext1, ad1)
</span></span><span style="display:flex;"><span>ciphertext2 <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext2, ad2)  <span style="color:#75715e"># CATASTROPHIC</span>
</span></span></code></pre></div></li>
</ol>
<h1 id="iyi-her-mesaj-için-benzersiz-nonce-tek-kullanımlık-sayı----ciphertext1--encryptkey-nonce1-plaintext1-ad1----ciphertext2--encryptkey-nonce2-plaintext2-ad2">İYİ: Her mesaj için benzersiz nonce (tek kullanımlık sayı)    ciphertext1 = ENCRYPT(key, nonce1, plaintext1, ad1)    ciphertext2 = ENCRYPT(key, nonce2, plaintext2, ad2)</h1>
<pre tabindex="0"><code>
2. **Ephemeral Key Reuse**: Generate fresh ephemeral key for each NS/NSR
```python
# KÖTÜ: Geçici anahtarın yeniden kullanımı    ephemeral_key = generate_elg2_keypair()    send_ns_message(ephemeral_key)    send_ns_message(ephemeral_key)  # KÖTÜ

# İYİ: Her mesaj için yeni bir anahtar    send_ns_message(generate_elg2_keypair())    send_ns_message(generate_elg2_keypair())
</code></pre><ol start="3">
<li><strong>Weak RNG</strong>: Use cryptographically secure random number generator
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div></li>
</ol>
<h1 id="kötü-kriptografik-olmayan-rastgele-sayı-üreteci-rng----import-random----key--bytesrandomrandint0-255-for-_-in-range32---güvensiz">KÖTÜ: Kriptografik olmayan rastgele sayı üreteci (RNG)    import random    key = bytes([random.randint(0, 255) for _ in range(32)])  # GÜVENSİZ</h1>
<h1 id="doğru-kriptografik-olarak-güvenli-rastgele-sayı-üreteci----import-os----key--osurandom32">DOĞRU: Kriptografik olarak güvenli rastgele sayı üreteci    import os    key = os.urandom(32)</h1>
<pre tabindex="0"><code>
4. **Timing Attacks**: Use constant-time comparisons
```python
# KÖTÜ: Erken çıkışlı karşılaştırma    if computed_mac == received_mac:  # Zamanlama sızıntısı

    pass

# İYİ: Sabit zamanlı karşılaştırma    if constant_time_compare(computed_mac, received_mac):

    pass
</code></pre><ol start="5">
<li><strong>Incomplete MAC Verification</strong>: Always verify before using data
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div></li>
</ol>
<h1 id="yanliş-doğrulamadan-önce-şifre-çözme----plaintext--chacha20_decryptkey-nonce-ciphertext----mac_ok--verify_macmac-plaintext---çok-geç----if-not-mac_ok">YANLIŞ: Doğrulamadan önce şifre çözme    plaintext = chacha20_decrypt(key, nonce, ciphertext)    mac_ok = verify_mac(mac, plaintext)  # ÇOK GEÇ    if not mac_ok:</h1>
<pre><code>   return error
</code></pre>
<h1 id="doğru-aead-ek-verili-kimlik-doğrulamalı-şifreleme-şifre-çözmeden-önce-doğrular----try">DOĞRU: AEAD (ek verili kimlik doğrulamalı şifreleme) şifre çözmeden önce doğrular    try:</h1>
<pre><code>   plaintext = DECRYPT(key, nonce, ciphertext, ad)  # Verifies MAC first
</code></pre>
<p>except AuthenticationError:</p>
<pre><code>   return error
</code></pre>
<pre tabindex="0"><code>
6. **Key Deletion**: Securely wipe keys from memory
```python
# KÖTÜ: Basit silme    del private_key  # Hâlâ bellekte

# İYİ: Silmeden önce üzerine yazın    for i in range(len(private_key)):

    private_key[i] = 0
del private_key
</code></pre><h3 id="security-audits">Security Audits</h3>
<p><strong>Recommended Audits:</strong></p>
<ol>
<li><strong>Cryptographic Review</strong>: Expert review of KDF chains and DH operations</li>
<li><strong>Implementation Audit</strong>: Code review for timing attacks, key management, RNG usage</li>
<li><strong>Protocol Analysis</strong>: Formal verification of handshake security properties</li>
<li><strong>Side-Channel Analysis</strong>: Timing, power, and cache attacks</li>
<li><strong>Fuzzing</strong>: Random input testing for parser robustness</li>
</ol>
<p><strong>Test Cases:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Güvenlik açısından kritik test vakaları</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_nonce_uniqueness</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure nonces are never reused&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    nonces <span style="color:#f92672">=</span> set()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10000</span>):
</span></span><span style="display:flex;"><span>        nonce <span style="color:#f92672">=</span> construct_nonce(i)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> nonce <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> nonces
</span></span><span style="display:flex;"><span>        nonces<span style="color:#f92672">.</span>add(nonce)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_key_isolation</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure sessions don&#39;t share keys&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    session1 <span style="color:#f92672">=</span> create_session(destination1)
</span></span><span style="display:flex;"><span>    session2 <span style="color:#f92672">=</span> create_session(destination2)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> session1<span style="color:#f92672">.</span>key <span style="color:#f92672">!=</span> session2<span style="color:#f92672">.</span>key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_replay_prevention</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure replay attacks are detected&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    ns_message <span style="color:#f92672">=</span> create_ns_message()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># First delivery succeeds</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> process_ns_message(ns_message) <span style="color:#f92672">==</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Replay fails</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> process_ns_message(ns_message) <span style="color:#f92672">==</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_mac_verification</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure MAC verification is enforced&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> construct_nonce(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>    ad <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;test_ad&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext, ad)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Correct MAC verifies</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> DECRYPT(key, nonce, ciphertext, ad) <span style="color:#f92672">==</span> plaintext
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Corrupted MAC fails</span>
</span></span><span style="display:flex;"><span>    corrupted <span style="color:#f92672">=</span> ciphertext[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> bytes([ciphertext[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">^</span> <span style="color:#ae81ff">0xFF</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> pytest<span style="color:#f92672">.</span>raises(AuthenticationError):
</span></span><span style="display:flex;"><span>        DECRYPT(key, nonce, corrupted, ad)
</span></span></code></pre></div><hr>
<h2 id="configuration-and-deployment">Configuration and Deployment</h2>
<h3 id="i2cp-configuration">I2CP Configuration</h3>
<p><strong>Enable ECIES Encryption:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Yalnızca ECIES (Eliptik Eğri Entegre Şifreleme Şeması) (yeni kurulumlar için önerilir)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Çift anahtarlı (uyumluluk için ECIES + ElGamal)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4,0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Yalnızca ElGamal (eski, önerilmez)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
</span></span></code></pre></div><p><strong>LeaseSet Type:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Standart LS2 (en yaygın)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetType</span><span style="color:#f92672">=</span><span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Şifreli LS2 (blinded destinations - körleştirilmiş hedefler)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetType</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Meta LS2 (birden fazla hedef)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetType</span><span style="color:#f92672">=</span><span style="color:#e6db74">7</span>
</span></span></code></pre></div><p><strong>Additional Options:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># ECIES (Eliptik Eğri Entegre Şifreleme Şeması) için statik anahtar (isteğe bağlı, belirtilmezse otomatik olarak oluşturulur)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Base64 ile kodlanmış 32 baytlık X25519 (elliptik eğri Diffie-Hellman anahtar değişimi) açık anahtar</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetPrivateKey</span><span style="color:#f92672">=</span><span style="color:#e6db74">&lt;base64-encoded-key&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># İmza türü (LeaseSet için)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetSigningPrivateKey</span><span style="color:#f92672">=</span><span style="color:#e6db74">&lt;base64-encoded-key&gt; i2cp.leaseSetSigningType=7  # Ed25519</span>
</span></span></code></pre></div><h3 id="java-i2p-configuration">Java I2P Configuration</h3>
<p><strong>router.config:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Router&#39;dan router&#39;a ECIES (Eliptik Eğri Entegre Şifreleme Şeması)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.useECIES</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span></code></pre></div><p><strong>Build Properties:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// For I2CP clients (Java) Properties props = new Properties(); props.setProperty(&#34;i2cp.leaseSetEncType&#34;, &#34;4&#34;); props.setProperty(&#34;i2cp.leaseSetType&#34;, &#34;3&#34;);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>I2PSession session <span style="color:#f92672">=</span> i2pClient.<span style="color:#a6e22e">createSession</span>(props);
</span></span></code></pre></div><h3 id="i2pd-configuration">i2pd Configuration</h3>
<p><strong>i2pd.conf:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[sınırlar]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ECIES (Eliptik Eğri Entegre Şifreleme Şeması) oturumlarının bellek sınırı</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ecies.memory</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">128M</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[ecies]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ECIES&#39;i etkinleştir (Eliptik Eğri Entegre Şifreleme Şeması)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">enabled</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Yalnızca ECIES (Eliptik Eğri Bütünleşik Şifreleme Düzeni) veya çift anahtarlı</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">compatibility</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true  # true = çift anahtarlı, false = yalnızca ECIES</span>
</span></span></code></pre></div><p><strong>Tunnels Configuration:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">[my-service] type</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http host = 127.0.0.1 port = 8080 keys = my-service-keys.dat</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Yalnızca ECIES (Eliptik Eğri Tümleşik Şifreleme Şeması)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ecies</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span></code></pre></div><h3 id="compatibility-matrix">Compatibility Matrix</h3>
<p><strong>Router Version Support:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Version</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">ECIES Support</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">LS2 Support</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Dual-Key</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">&lt; 0.9.38</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">❌ No</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">❌ No</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Legacy only</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0.9.38-0.9.45</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">❌ No</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">LS2 only</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0.9.46-0.9.50</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial ECIES</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1.5.0+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Current</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2.0.0+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Current</td>
    </tr>
  </tbody>
</table>
<p><strong>Destination Compatibility:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Destination Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Can Connect To</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ECIES-only</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ECIES-only, Dual-key</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Requires 0.9.46+ routers</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Dual-key</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Any</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Maximum compatibility</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ElGamal-only</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ElGamal-only, Dual-key</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Legacy</td>
    </tr>
  </tbody>
</table>
<p><strong>FloodFill Requirements:</strong></p>
<ul>
<li><strong>ECIES-only destinations</strong>: Require majority of floodfills on 0.9.46+ for encrypted lookups</li>
<li><strong>Dual-key destinations</strong>: Work with any floodfill version</li>
<li><strong>Current status</strong>: Near 100% floodfill adoption as of 2025</li>
</ul>
<h3 id="migration-guide">Migration Guide</h3>
<p><strong>Migrating from ElGamal to ECIES:</strong></p>
<p><strong>Step 1: Enable Dual-Key Mode</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># ElGamal&#39;i koruyarak ECIES&#39;i ekleyin</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4,0</span>
</span></span></code></pre></div><p><strong>Step 2: Monitor Connections</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Bağlantı türlerini kontrol edin</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>i2prouter.exe status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># veya</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http://127.0.0.1:7657/peers
</span></span></code></pre></div><p><strong>Step 3: Switch to ECIES-Only (after testing)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># ElGamal&#39;ı kaldır</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4</span>
</span></span></code></pre></div><p><strong>Step 4: Restart Application</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># I2P router&#39;ı veya uygulamayı yeniden başlatın</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl restart i2p
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># veya</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>i2prouter.exe restart
</span></span></code></pre></div><p><strong>Rollback Plan:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Sorunlar olursa yalnızca ElGamal&#39;a geri dönün</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
</span></span></code></pre></div><h3 id="performance-tuning">Performance Tuning</h3>
<p><strong>Session Limits:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Maksimum gelen oturum sayısı</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.maxInboundSessions</span><span style="color:#f92672">=</span><span style="color:#e6db74">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># En fazla giden oturum sayısı</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.maxOutboundSessions</span><span style="color:#f92672">=</span><span style="color:#e6db74">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Oturum zaman aşımı (saniye)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.sessionTimeout</span><span style="color:#f92672">=</span><span style="color:#e6db74">600</span>
</span></span></code></pre></div><p><strong>Memory Limits:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Etiket depolama sınırı (KB)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.maxTagMemory</span><span style="color:#f92672">=</span><span style="color:#e6db74">10240  # 10 MB</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># İleri bakış penceresi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.tagLookAhead</span><span style="color:#f92672">=</span><span style="color:#e6db74">160 i2p.ecies.tagLookAheadMin=32</span>
</span></span></code></pre></div><p><strong>Ratchet Policy:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># ratchet (anahtar yenileme mekanizması) öncesi mesajlar</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.ratchetThreshold</span><span style="color:#f92672">=</span><span style="color:#e6db74">4096</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Ratchet (kademeli anahtar yenileme mekanizması) başlamadan önceki süre (saniye)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.ratchetTimeout</span><span style="color:#f92672">=</span><span style="color:#e6db74">600  # 10 dakika</span>
</span></span></code></pre></div><h3 id="monitoring-and-debugging">Monitoring and Debugging</h3>
<p><strong>Logging:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># ECIES (Eliptik Eğri Entegre Şifreleme Şeması) hata ayıklama günlüğünü etkinleştir</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">logger.i2p.router.transport.ecies</span><span style="color:#f92672">=</span><span style="color:#e6db74">DEBUG</span>
</span></span></code></pre></div><p><strong>Metrics:</strong></p>
<p>Monitor these metrics:</p>
<ol>
<li><strong>NS Success Rate</strong>: Percentage of NS messages receiving NSR</li>
<li><strong>Session Establishment Time</strong>: Time from NS to first ES</li>
<li><strong>Tag Storage Usage</strong>: Current memory usage for tags</li>
<li><strong>Ratchet Frequency</strong>: How often sessions ratchet</li>
<li><strong>Session Lifetime</strong>: Average session duration</li>
</ol>
<p><strong>Common Issues:</strong></p>
<ol>
<li>
<p><strong>NS Timeout</strong>: No NSR received</p>
<ul>
<li>Check destination is online</li>
<li>Check floodfill availability</li>
<li>Verify LeaseSet published correctly</li>
</ul>
</li>
<li>
<p><strong>High Memory Usage</strong>: Too many tags stored</p>
<ul>
<li>Reduce look-ahead window</li>
<li>Decrease session timeout</li>
<li>Implement aggressive expiration</li>
</ul>
</li>
<li>
<p><strong>Frequent Ratchets</strong>: Sessions ratcheting too often</p>
<ul>
<li>Increase ratchet threshold</li>
<li>Check for retransmissions</li>
</ul>
</li>
<li>
<p><strong>Session Failures</strong>: ES messages failing to decrypt</p>
<ul>
<li>Verify tag synchronization</li>
<li>Check for replay attacks</li>
<li>Validate nonce construction</li>
</ul>
</li>
</ol>
<hr>
<h2 id="references">References</h2>
<h3 id="specifications">Specifications</h3>
<ol>
<li><strong>ECIES Proposal</strong>: <a href="../../../../tr/proposals/144-ecies-x25519-aead-ratchet/">Proposal 144</a>
</li>
<li><strong>I2NP</strong>: <a href="../../../../tr/docs/specs/i2np/">I2NP Specification</a>
</li>
<li><strong>Common Structures</strong>: <a href="../../../../tr/docs/specs/common-structures/">Common Structures Specification</a>
</li>
<li><strong>NTCP2</strong>: <a href="../../../../tr/docs/specs/ntcp2/">NTCP2 Specification</a>
</li>
<li><strong>SSU2</strong>: <a href="../../../../tr/docs/specs/ssu2/">SSU2 Specification</a>
</li>
<li><strong>I2CP</strong>: <a href="../../../../tr/docs/specs/i2cp/">I2CP Specification</a>
</li>
<li><strong>ElGamal/AES+SessionTags</strong>: <a href="../../../../tr/docs/legacy/elgamal-aes/">ElGamal/AES Specification</a>
</li>
</ol>
<h3 id="cryptographic-standards">Cryptographic Standards</h3>
<ol>
<li><strong>Noise Protocol Framework</strong>: <a href="https://noiseprotocol.org/noise.html">Noise Specification</a>
 (Revision 34, 2018-07-11)</li>
<li><strong>Signal Double Ratchet</strong>: <a href="https://signal.org/docs/specifications/doubleratchet/">Signal Specification</a>
</li>
<li><strong>RFC 7748</strong>: <a href="https://tools.ietf.org/html/rfc7748">Elliptic Curves for Security (X25519)</a>
</li>
<li><strong>RFC 7539</strong>: <a href="https://tools.ietf.org/html/rfc7539">ChaCha20 and Poly1305 for IETF Protocols</a>
</li>
<li><strong>RFC 5869</strong>: <a href="https://tools.ietf.org/html/rfc5869">HKDF (HMAC-based Key Derivation Function)</a>
</li>
<li><strong>RFC 2104</strong>: <a href="https://tools.ietf.org/html/rfc2104">HMAC: Keyed-Hashing for Message Authentication</a>
</li>
<li><strong>Elligator2</strong>: <a href="https://elligator.cr.yp.to/elligator-20130828.pdf">Elligator Paper</a>
</li>
</ol>
<h3 id="implementation-resources">Implementation Resources</h3>
<ol>
<li><strong>Java I2P</strong>: <a href="https://github.com/i2p/i2p.i2p">i2p.i2p Repository</a>
</li>
<li><strong>i2pd (C++)</strong>: <a href="https://github.com/PurpleI2P/i2pd">i2pd Repository</a>
</li>
<li><strong>OBFS4 (Elligator2)</strong>: <a href="https://gitlab.com/yawning/obfs4">obfs4proxy Repository</a>
</li>
</ol>
<h3 id="additional-information">Additional Information</h3>
<ol>
<li><strong>I2P Website</strong>: <a href="../../../../tr/">/</a>
</li>
<li><strong>I2P Forum</strong>: <a href="https://i2pforum.net">https://i2pforum.net</a>
</li>
<li><strong>I2P Wiki</strong>: <a href="https://wiki.i2p-projekt.de">https://wiki.i2p-projekt.de</a>
</li>
</ol>
<hr>
<h2 id="appendix-a-kdf-summary">Appendix A: KDF Summary</h2>
<p><strong>All KDF Operations in ECIES:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Operation</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Input</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Info String</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Output</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NS Initial ChainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">protocol_name</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">(none - SHA256)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">h, chainKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NS Static Key Section</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, es_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, k</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NS Payload Section (bound)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, ss_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, k</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR Tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"SessionReplyTags"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">tagsetKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR ee DH</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, ee_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR se DH</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, se_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, k</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR Split</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">k_ab, k_ba</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR Payload</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">k_ba</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"AttachPayloadKDF"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">k_nsr</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DH Initialize</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">rootKey, k</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"KDFDHRatchetStep"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">nextRootKey, chainKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Tag and Key Chain Keys</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"TagAndKeyGenKeys"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">sessTag_ck, symmKey_ck</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session Tag Init</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">sessTag_ck</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"STInitialization"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, CONSTANT</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session Tag Gen</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, CONSTANT</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"SessionTagKeyGen"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, tag</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Symmetric Key Gen</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"SymmetricRatchet"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DH Ratchet</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">sharedSecret</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"XDHRatchetTagSet"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">tagsetKey</td>
    </tr>
  </tbody>
</table>
<hr>
<h2 id="appendix-b-message-size-calculator">Appendix B: Message Size Calculator</h2>
<p><strong>Calculate message sizes for capacity planning:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_ns_size</span>(payload_size, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Calculate New Session message size&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    ephemeral_key <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    static_section <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># encrypted + MAC</span>
</span></span><span style="display:flex;"><span>    payload_encrypted <span style="color:#f92672">=</span> payload_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># + MAC</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ephemeral_key <span style="color:#f92672">+</span> static_section <span style="color:#f92672">+</span> payload_encrypted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_nsr_size</span>(payload_size):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Calculate New Session Reply message size&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    tag <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    ephemeral_key <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    key_section_mac <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>    payload_encrypted <span style="color:#f92672">=</span> payload_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># + MAC</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tag <span style="color:#f92672">+</span> ephemeral_key <span style="color:#f92672">+</span> key_section_mac <span style="color:#f92672">+</span> payload_encrypted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_es_size</span>(payload_size):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Calculate Existing Session message size&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    tag <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    payload_encrypted <span style="color:#f92672">=</span> payload_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># + MAC</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tag <span style="color:#f92672">+</span> payload_encrypted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Örnekler</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;NS (bound, 1KB yük):&#34;</span>, calculate_ns_size(<span style="color:#ae81ff">1024</span>, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>), <span style="color:#e6db74">&#34;bayt&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Çıktı: 1120 bayt</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;NSR (1KB veri yükü):&#34;</span>, calculate_nsr_size(<span style="color:#ae81ff">1024</span>), <span style="color:#e6db74">&#34;bayt&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Çıktı: 1096 bayt</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;ES (1KB veri yükü):&#34;</span>, calculate_es_size(<span style="color:#ae81ff">1024</span>), <span style="color:#e6db74">&#34;bayt&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Çıktı: 1048 bayt</span>
</span></span></code></pre></div><hr>
<h2 id="appendix-c-glossary">Appendix C: Glossary</h2>
<p><strong>AEAD</strong>: Authenticated Encryption with Associated Data - encryption mode that provides both confidentiality and authenticity</p>
<p><strong>Authentication Level</strong>: Noise protocol security property indicating strength of sender identity verification</p>
<p><strong>Binding</strong>: Association of a session with a specific far-end destination</p>
<p><strong>ChaCha20</strong>: Stream cipher designed by Daniel J. Bernstein</p>
<p><strong>ChainKey</strong>: Cryptographic key used in HKDF chains to derive subsequent keys</p>
<p><strong>Confidentiality Level</strong>: Noise protocol security property indicating strength of forward secrecy</p>
<p><strong>DH</strong>: Diffie-Hellman key agreement protocol</p>
<p><strong>Elligator2</strong>: Encoding technique to make elliptic curve points indistinguishable from random</p>
<p><strong>Ephemeral Key</strong>: Short-lived key used only for a single handshake</p>
<p><strong>ES</strong>: Existing Session message (used after handshake completion)</p>
<p><strong>Forward Secrecy</strong>: Property ensuring past communications remain secure if keys are compromised</p>
<p><strong>Garlic Clove</strong>: I2NP message container for end-to-end delivery</p>
<p><strong>HKDF</strong>: HMAC-based Key Derivation Function</p>
<p><strong>IK Pattern</strong>: Noise handshake pattern where initiator sends static key immediately</p>
<p><strong>KCI</strong>: Key Compromise Impersonation attack</p>
<p><strong>KDF</strong>: Key Derivation Function - cryptographic function for generating keys from other keys</p>
<p><strong>LeaseSet</strong>: I2P structure containing a destination&rsquo;s public keys and tunnel information</p>
<p><strong>LS2</strong>: LeaseSet version 2 with encryption type support</p>
<p><strong>MAC</strong>: Message Authentication Code - cryptographic checksum proving authenticity</p>
<p><strong>MixHash</strong>: Noise protocol function for maintaining running hash transcript</p>
<p><strong>NS</strong>: New Session message (initiates new session)</p>
<p><strong>NSR</strong>: New Session Reply message (response to NS)</p>
<p><strong>Nonce</strong>: Number used once - ensures unique encryption even with same key</p>
<p><strong>Pairing</strong>: Linking an inbound session with an outbound session for bidirectional communication</p>
<p><strong>Poly1305</strong>: Message authentication code designed by Daniel J. Bernstein</p>
<p><strong>Ratchet</strong>: Cryptographic mechanism for deriving sequential keys</p>
<p><strong>Session Tag</strong>: 8-byte one-time identifier for existing session messages</p>
<p><strong>Static Key</strong>: Long-term key associated with a destination&rsquo;s identity</p>
<p><strong>Tag Set</strong>: Collection of session tags derived from a common root</p>
<p><strong>X25519</strong>: Elliptic curve Diffie-Hellman key agreement using Curve25519</p>
<hr>

                </article>

                
                <nav class="page-nav">
                    
                        <a href="../../../../tr/docs/specs/ecies-hybrid/" class="page-nav-link prev">
                            <span class="nav-label">← Previous</span>
                            <span class="nav-title">ECIES-X25519-AEAD-Ratchet Hibrit Şifreleme</span>
                        </a>
                    
                    
                        <a href="../../../../tr/docs/specs/cryptography/" class="page-nav-link next">
                            <span class="nav-label">Next →</span>
                            <span class="nav-title">Düşük düzey kriptografi</span>
                        </a>
                    
                </nav>

                
                <div class="docs-feedback">
                    <p>Was this page helpful?</p>
                    <div class="feedback-buttons" id="feedback-buttons">
                        <button class="feedback-btn" id="feedback-yes">👍 Yes</button>
                        <button class="feedback-btn" id="feedback-no">👎 No</button>
                    </div>

                    
                    <div class="feedback-form-container" id="feedback-form-container" style="display: none;">
                        <p class="feedback-form-title">We're sorry to hear that. How can we improve this page?</p>
                        <form id="feedback-form">
                            <div class="form-group">
                                <label for="feedback-email">Email (optional - if you'd like a response)</label>
                                <input type="email" id="feedback-email" name="email" placeholder="your@email.com">
                            </div>
                            <div class="form-group">
                                <label for="feedback-message">Feedback *</label>
                                <textarea id="feedback-message" name="message" rows="4" required placeholder="Tell us what we can improve..."></textarea>
                            </div>
                            <button type="submit" class="btn-submit-feedback" id="feedback-submit-btn">
                                <span class="btn-text">Submit Feedback</span>
                                <span class="btn-loading" style="display: none;">Sending...</span>
                            </button>
                        </form>
                    </div>

                    
                    <div class="feedback-message" id="feedback-success" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/>
                        </svg>
                        <span id="feedback-success-text">Thanks for your feedback!</span>
                    </div>
                    <div class="feedback-message feedback-error" id="feedback-error" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path d="M12 8v4M12 16h.01" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span id="feedback-error-text">Something went wrong. Please try again.</span>
                    </div>

                    <p class="feedback-note">
                        Found an issue? <a href="https://gitlab.com/stormycloud-group/i-2-p-www-v-2/-/blob/main/hugo-site/content/tr/docs/specs/ecies.md?ref_type=heads" target="_blank">Edit this page on GitLab</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.docs-page {
    min-height: 100vh;
    padding: var(--spacing-xl) 0;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
}

.breadcrumbs a:hover {
    color: var(--color-primary);
}

.separator {
    color: var(--color-border);
}

.current {
    color: var(--color-text);
}

 
.translation-disclaimer {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.dark .translation-disclaimer {
    background: #78350f;
    border-color: #d97706;
}

.disclaimer-message {
    color: #92400e;
    font-size: 0.875rem;
}

.dark .disclaimer-message {
    color: #fde047;
}

.disclaimer-link {
    color: #92400e;
    font-weight: 600;
    text-decoration: underline;
    white-space: nowrap;
}

.dark .disclaimer-link {
    color: #fde047;
}

 
.article-header {
    margin-bottom: var(--spacing-2xl);
}

.article-title {
    font-size: 2.5rem;
    margin: 0 0 var(--spacing-md) 0;
    color: var(--color-text);
}

.article-description {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-md);
}

.article-meta {
    display: flex;
    gap: var(--spacing-lg);
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.meta-item svg {
    color: var(--color-primary);
}

 
.docs-layout {
    display: block;
}

.docs-layout--with-toc {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

 
.docs-toc-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.toc-nav {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
}

.toc-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-text);
    padding-bottom: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.toc-content {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
}

.toc-content::-webkit-scrollbar {
    width: 4px;
}

.toc-content::-webkit-scrollbar-track {
    background: transparent;
}

.toc-content::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
}

.toc-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

.toc-nav ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc-nav li {
    margin-bottom: 0.25rem;
}

.toc-nav ul ul {
    padding-left: var(--spacing-md);
    margin-top: 0.25rem;
}

.toc-nav a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.8125rem;
    display: block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    line-height: 1.4;
}

.toc-nav a:hover {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
}

 
.docs-main {
    min-width: 0;
    max-width: 900px;
}

 
.article-content {
    line-height: 1.8;
    color: var(--color-text);
}

.article-content h2 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.75rem;
    scroll-margin-top: 100px;
}

.article-content h3 {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.375rem;
    scroll-margin-top: 100px;
}

.article-content h4 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-xs);
    font-size: 1.125rem;
    scroll-margin-top: 100px;
}

.article-content p {
    margin-bottom: var(--spacing-md);
}

.article-content ul,
.article-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.article-content li {
    margin-bottom: var(--spacing-xs);
}

.article-content code {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
}

.article-content pre {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: var(--spacing-md);
}

.article-content pre code {
    background: none;
    padding: 0;
}

.article-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin: var(--spacing-lg) 0;
    display: block;
}

.article-content a {
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
}

.article-content a:hover {
    border-bottom-color: var(--color-primary);
}

 
.page-nav {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
}

.page-nav-link {
    display: flex;
    flex-direction: column;
    padding: var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.page-nav-link:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
}

.page-nav-link.next {
    text-align: right;
}

.nav-label {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xs);
}

.nav-title {
    font-weight: 600;
    color: var(--color-text);
}

 
.docs-feedback {
    margin-top: var(--spacing-2xl);
    padding: var(--spacing-lg);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    text-align: center;
}

.feedback-buttons {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    margin: var(--spacing-md) 0;
}

.feedback-btn {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.feedback-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-primary);
    color: white;
}

.feedback-note {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-top: var(--spacing-md);
}

.feedback-note a {
    color: var(--color-primary);
    text-decoration: none;
}

.feedback-note a:hover {
    text-decoration: underline;
}

 
.feedback-form-container {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-align: left;
}

.feedback-form-title {
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--color-text);
}

.form-group {
    margin-bottom: var(--spacing-md);
}

.form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
    color: var(--color-text);
}

.form-group input[type="email"],
.form-group textarea {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    color: var(--color-text);
    font-family: inherit;
    font-size: 0.9375rem;
    transition: border-color var(--transition-fast);
}

.form-group input[type="email"]:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.btn-submit-feedback {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-submit-feedback:hover:not(:disabled) {
    background: var(--color-primary-dark);
    transform: translateY(-1px);
}

.btn-submit-feedback:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

 
.feedback-message {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: #d1fae5;
    color: #065f46;
    border-radius: var(--radius-md);
    margin-top: var(--spacing-md);
}

.feedback-message.feedback-error {
    background: #fee2e2;
    color: #991b1b;
}

.feedback-message svg {
    flex-shrink: 0;
}

 
@media (max-width: 1024px) {
    .docs-layout--with-toc {
        grid-template-columns: 1fr;
    }

    .docs-toc-sidebar {
        position: static;
        max-height: none;
        margin-bottom: var(--spacing-xl);
    }

    .toc-content {
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .article-title {
        font-size: 1.75rem;
    }
}
</style>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = [];

    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const heading = document.getElementById(href.slice(1));
            if (heading) {
                headings.push({ element: heading, link: link });
            }
        }
    });

    function updateActiveLink() {
        const scrollPos = window.scrollY + 120;
        let activeIndex = 0;

        for (let i = 0; i < headings.length; i++) {
            if (headings[i].element.offsetTop <= scrollPos) {
                activeIndex = i;
            }
        }

        tocLinks.forEach(link => link.classList.remove('active'));
        if (headings[activeIndex]) {
            headings[activeIndex].link.classList.add('active');
        }
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});
</script>
<style>
.toc-nav a.active {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
    font-weight: 600;
}
</style>



<script>
(function() {
    'use strict';
    
    
    let baseUrl = window.feedbackBaseUrl;
    if (!baseUrl) {
        const hostname = window.location.hostname;
        
        if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
            baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
        } else if (hostname.endsWith('.onion')) {
            baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
        } else {
            baseUrl = 'https://feedback.i2p.net';
        }
    }
    
    const script = document.createElement('script');
    script.src = baseUrl + '/widgets/docs-feedback.js';
    script.async = true;
    script.onerror = function() {
        console.error('[Docs Feedback] Failed to load docs-feedback.js from:', baseUrl);
    };
    document.body.appendChild(script);
})();
</script>


    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">I2P haberleriyle güncel kalın:</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="E-posta adresinizi girin" required>
                            <button type="submit">Abone Ol</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>Hızlı Bağlantılar</h3>
                <ul>
                    <li><a href="../../../../tr/financial-support/">Bağış Yap</a></li>
                    <li><a href="../../../../tr/docs/overview/intro/">I2P Tanıtımı</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Topluluk</h3>
                <ul>
                    <li><a href="../../../../tr/get-involved/">Katılın</a></li>
                    <li><a href="../../../../tr/blog/">Blog</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">Resmi Forumlar</a></li>
                    <li><a href="../../../../tr/contact/">İletişim</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Kaynaklar</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">I2P Metrikleri</a></li>
                    <li><a href="../../../../tr/papers/">Araştırma</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">StormyCloud</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 Invisible Internet Projesi. Creative Commons altında lisanslanmıştır.</p>
            <div class="footer-links">
                <a href="../../../../tr/privacy/">Gizlilik</a>
                <a href="../../../../tr/terms/">Şartlar</a>
                <a href="../../../../tr/about/media/">Basın</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="Kapat">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>Topluluk Anketi</h2>
            <p class="modal-subtitle">Sizden haber almaktan memnuniyet duyarız</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                Oyunuz I2P&#39;nin geleceğini şekillendirmeye yardımcı olur.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
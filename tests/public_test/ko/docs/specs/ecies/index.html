<!DOCTYPE html>
<html lang="ko" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>ECIES-X25519-AEAD-Ratchet 암호화 명세 | I2P - 보이지 않는 인터넷 프로젝트</title>

    <meta name="description" content="I2P용 타원곡선 통합 암호화 스킴 (X25519 &#43; AEAD)">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="ECIES-X25519-AEAD-Ratchet 암호화 명세 | I2P - 보이지 않는 인터넷 프로젝트">
    <meta property="og:description" content="I2P용 타원곡선 통합 암호화 스킴 (X25519 &#43; AEAD)">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/ko/docs/specs/ecies/">

    
    <link rel="icon" type="image/svg+xml" href="../../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">I2P 베타 사이트 현재 운영 중 문의사항은 stormycloud@mail.i2p로 이메일 주세요</span>
            
        </div>
        
        <form method="GET" action="../../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="배너 닫기" title="배너 닫기">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../../ko/" class="logo-link">
                    <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../../ko/about/" class="">소개</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../ko/about/">개요</a></li>
                            <li><a href="../../../../ko/papers/">연구 논문</a></li>
                            <li><a href="../../../../ko/about/media/">보도자료</a></li>
                            <li><a href="../../../../ko/contact/">문의하기</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../../ko/docs/" class="active">문서</a></li>
                    <li><a href="../../../../ko/downloads/" class="">다운로드</a></li>
                    <li><a href="../../../../ko/blog/" class="">블로그</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../../ko/get-involved/" class="">참여하기</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../ko/get-involved/">개요</a></li>
                            <li><a href="../../../../ko/feedback/">기능 제안</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">ko</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../en/docs/specs/ecies/"
                                class="lang-option">영어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../es/docs/specs/ecies/"
                                class="lang-option">스페인어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ko/docs/specs/ecies/"
                                class="lang-option active">한국어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../zh/docs/specs/ecies/"
                                class="lang-option">중국어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ru/docs/specs/ecies/"
                                class="lang-option">러시아어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../cs/docs/specs/ecies/"
                                class="lang-option">체코어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../de/docs/specs/ecies/"
                                class="lang-option">독일어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../fr/docs/specs/ecies/"
                                class="lang-option">프랑스어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../tr/docs/specs/ecies/"
                                class="lang-option">터키어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../vi/docs/specs/ecies/"
                                class="lang-option">베트남어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../hi/docs/specs/ecies/"
                                class="lang-option">힌디어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ar/docs/specs/ecies/"
                                class="lang-option">아랍어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../pt/docs/specs/ecies/"
                                class="lang-option">포르투갈어</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../../ko/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../../ko/downloads/" class="btn btn-primary">I2P 다운로드</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        




<div class="docs-page">
    <div class="container">
        
        <div class="docs-layout docs-layout--with-toc">
            
            
            <aside class="docs-toc-sidebar">
                <nav class="toc-nav">
                    <div class="toc-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        On This Page
                    </div>
                    <div class="toc-content">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#개요">개요</a>
      <ul>
        <li><a href="#목적">목적</a></li>
        <li><a href="#elgamalaessessiontags-대비-핵심-개선점">ElGamal/AES+SessionTags 대비 핵심 개선점</a></li>
        <li><a href="#배포-상태">배포 상태</a></li>
        <li><a href="#구현-상태">구현 상태</a></li>
      </ul>
    </li>
    <li><a href="#프로토콜의-기초">프로토콜의 기초</a>
      <ul>
        <li><a href="#noise-protocol-frameworknoise-프로토콜-프레임워크">Noise Protocol Framework(Noise 프로토콜 프레임워크)</a></li>
        <li><a href="#noise-protocol비밀-통신용-암호-프로토콜-프레임워크-식별자">Noise Protocol(비밀 통신용 암호 프로토콜 프레임워크) 식별자</a></li>
        <li><a href="#noise-핸드셰이크-패턴">Noise 핸드셰이크 패턴</a></li>
        <li><a href="#noise프로토콜-프레임워크의-보안-속성">Noise(프로토콜 프레임워크)의 보안 속성</a></li>
        <li><a href="#ik와-xk의-차이점">IK와 XK의 차이점</a></li>
        <li><a href="#signal-double-ratchet시그널-이중-래칫-개념">Signal Double Ratchet(시그널 이중 래칫) 개념</a></li>
        <li><a href="#noise프로토콜-프레임워크용-i2p-확장">Noise(프로토콜 프레임워크)용 I2P 확장</a></li>
      </ul>
    </li>
    <li><a href="#암호학적-프리미티브">암호학적 프리미티브</a>
      <ul>
        <li><a href="#x25519-디피-헬만">X25519 디피-헬만</a></li>
        <li><a href="#x25519-generate_private">X25519 GENERATE_PRIVATE()</a></li>
        <li><a href="#x25519-derive_publicprivkey">X25519 DERIVE_PUBLIC(privkey)</a></li>
        <li><a href="#x25519-dhprivkey-pubkey">X25519 DH(privkey, pubkey)</a></li>
        <li><a href="#chacha20-poly1305-aead연관-데이터가-있는-인증된-암호화">ChaCha20-Poly1305 AEAD(연관 데이터가 있는 인증된 암호화)</a></li>
        <li><a href="#chacha20-poly1305-encryptk-n-plaintext-ad">ChaCha20-Poly1305 ENCRYPT(k, n, plaintext, ad)</a></li>
        <li><a href="#chacha20-poly1305-복호화k-n-ciphertext-ad">ChaCha20-Poly1305 복호화(k, n, ciphertext, ad)</a></li>
        <li><a href="#sha-256-해시-함수">SHA-256 해시 함수</a></li>
        <li><a href="#sha-256-hp-d">SHA-256 H(p, d)</a></li>
        <li><a href="#sha-256-mixhashd">SHA-256 MixHash(d)</a></li>
        <li><a href="#hkdf-키-파생">HKDF 키 파생</a></li>
        <li><a href="#elligator2엘리게이터2-인코딩">Elligator2(엘리게이터2) 인코딩</a></li>
        <li><a href="#elligator2-generate_private_elg2">Elligator2 GENERATE_PRIVATE_ELG2()</a></li>
        <li><a href="#elligator2-encode_elg2pubkey">Elligator2 ENCODE_ELG2(pubkey)</a></li>
        <li><a href="#elligator2-decode_elg2encodedkey">Elligator2 DECODE_ELG2(encodedKey)</a></li>
      </ul>
    </li>
    <li><a href="#메시지-형식">메시지 형식</a>
      <ul>
        <li><a href="#개요-1">개요</a></li>
        <li><a href="#i2np-garlic-메시지-컨테이너">I2NP Garlic 메시지 컨테이너</a></li>
        <li><a href="#새-세션-ns-메시지">새 세션 (NS) 메시지</a></li>
        <li><a href="#바인딩이-포함된-ns-메시지-유형-1b">바인딩이 포함된 NS 메시지 (유형 1b)</a></li>
        <li><a href="#바인딩-없는-ns-메시지-유형-1c">바인딩 없는 NS 메시지 (유형 1c)</a></li>
        <li><a href="#ns-일회성-메시지-type-1d">NS 일회성 메시지 (Type 1d)</a></li>
        <li><a href="#새-세션-응답nsr-메시지">새 세션 응답(NSR) 메시지</a></li>
        <li><a href="#기존-세션es-메시지">기존 세션(ES) 메시지</a></li>
      </ul>
    </li>
    <li><a href="#키-유도-함수">키 유도 함수</a>
      <ul>
        <li><a href="#표기법과-상수">표기법과 상수</a></li>
        <li><a href="#ns-메시지-키-파생-함수">NS 메시지 키 파생 함수</a></li>
        <li><a href="#kdf-1-초기-체인-키">KDF 1: 초기 체인 키</a></li>
        <li><a href="#kdf-2-bob의-정적-키-혼합">KDF 2: Bob의 정적 키 혼합</a></li>
        <li><a href="#kdf-3-앨리스의-임시-키-생성">KDF 3: 앨리스의 임시 키 생성</a></li>
        <li><a href="#kdf-4-ns-정적-키-섹션-es-dh-일시적-정적-diffie-hellman">KDF 4: NS 정적 키 섹션 (es DH, 일시적-정적 Diffie-Hellman)</a></li>
        <li><a href="#kdf-5-ns-페이로드-섹션-ss-dh-바인딩-전용">KDF 5: NS 페이로드 섹션 (ss DH, 바인딩 전용)</a></li>
        <li><a href="#nsr-응답-태그-집합-키-파생-함수">NSR 응답 태그 집합 키 파생 함수</a></li>
        <li><a href="#nsr-메시지-kdf키-파생-함수">NSR 메시지 KDF(키 파생 함수)</a></li>
        <li><a href="#kdf-6-nsr-임시-키-생성">KDF 6: NSR 임시 키 생성</a></li>
        <li><a href="#kdf-7-nsr-키-섹션-ee-및-se-dh">KDF 7: NSR 키 섹션 (ee 및 se DH)</a></li>
        <li><a href="#kdf-8-nsr-페이로드-섹션">KDF 8: NSR 페이로드 섹션</a></li>
        <li><a href="#es-메시지-키-파생-함수">ES 메시지 키 파생 함수</a></li>
        <li><a href="#dh_initialize-함수">DH_INITIALIZE 함수</a></li>
      </ul>
    </li>
    <li><a href="#래칫-메커니즘">래칫 메커니즘</a>
      <ul>
        <li><a href="#ratchet래칫-개요">Ratchet(래칫) 개요</a></li>
        <li><a href="#dh-ratchet디피-헬만-기반의-단계적-키-갱신-기법">DH Ratchet(디피-헬만 기반의 단계적 키 갱신 기법)</a></li>
        <li><a href="#dh-ratchet디피-헬만-기반-키-래칫-빈도">DH Ratchet(디피-헬만 기반 키 래칫) 빈도</a></li>
        <li><a href="#dh-ratchet디피-헬만-래칫-태그-및-키-id">DH Ratchet(디피-헬만 래칫) 태그 및 키 ID</a></li>
        <li><a href="#dh-래칫-메시지-흐름">DH 래칫 메시지 흐름</a></li>
        <li><a href="#nextkey다음-키-블록-형식">NextKey(다음 키) 블록 형식</a></li>
        <li><a href="#dh-래칫-키-파생-함수">DH 래칫 키 파생 함수</a></li>
        <li><a href="#dh-래칫-상태-관리">DH 래칫 상태 관리</a></li>
        <li><a href="#세션-태그-래칫">세션 태그 래칫</a></li>
        <li><a href="#session-tag-ratchetsession-tag를-전진-갱신하는-암호학적-메커니즘의-목적">Session Tag Ratchet(Session Tag를 전진 갱신하는 암호학적 메커니즘)의 목적</a></li>
        <li><a href="#세션-태그-래칫-공식">세션 태그 래칫 공식</a></li>
        <li><a href="#session-tag-ratchet세션-태그를-단계적으로-교체하는-메커니즘-송신자-구현">Session Tag Ratchet(세션 태그를 단계적으로 교체하는 메커니즘) 송신자 구현</a></li>
        <li><a href="#세션-태그-ratchet키-갱신-메커니즘-수신자-구현">세션 태그 Ratchet(키 갱신 메커니즘) 수신자 구현</a></li>
        <li><a href="#세션-태그-사전-준비-전략">세션 태그 사전 준비 전략</a></li>
        <li><a href="#session-tag세션-태그-순서-뒤바뀜-처리">Session Tag(세션 태그) 순서 뒤바뀜 처리</a></li>
        <li><a href="#대칭-키-래칫">대칭 키 래칫</a></li>
        <li><a href="#symmetric-key-ratchet대칭-키-래칫의-목적">Symmetric Key Ratchet(대칭 키 래칫)의 목적</a></li>
        <li><a href="#대칭-키-래칫-공식">대칭 키 래칫 공식</a></li>
        <li><a href="#symmetric-key-ratchet대칭키-래칫-송신자-구현">Symmetric Key Ratchet(대칭키 래칫) 송신자 구현</a></li>
        <li><a href="#대칭-키-래칫-수신자-구현">대칭 키 래칫 수신자 구현</a></li>
        <li><a href="#session-tags세션-태그를-이용한-대칭-래칫-동기화">Session Tags(세션 태그)를 이용한 대칭 래칫 동기화</a></li>
        <li><a href="#대칭-래칫-논스-구성">대칭 래칫 논스 구성</a></li>
      </ul>
    </li>
    <li><a href="#세션-관리">세션 관리</a>
      <ul>
        <li><a href="#세션-컨텍스트">세션 컨텍스트</a></li>
        <li><a href="#세션-바인딩">세션 바인딩</a></li>
        <li><a href="#바인딩된-세션">바인딩된 세션</a></li>
        <li><a href="#바인딩되지-않은-세션">바인딩되지 않은 세션</a></li>
        <li><a href="#세션-페어링">세션 페어링</a></li>
        <li><a href="#페어링된-세션-생성">페어링된 세션 생성</a></li>
        <li><a href="#세션-페어링의-이점">세션 페어링의 이점</a></li>
        <li><a href="#세션-페어링-규칙">세션 페어링 규칙</a></li>
        <li><a href="#세션-수명주기">세션 수명주기</a></li>
        <li><a href="#세션-수명-주기-생성-단계">세션 수명 주기: 생성 단계</a></li>
        <li><a href="#세션-수명-주기-활성-단계">세션 수명 주기: 활성 단계</a></li>
        <li><a href="#세션-수명주기-만료-단계">세션 수명주기: 만료 단계</a></li>
        <li><a href="#복수의-ns-메시지">복수의 NS 메시지</a></li>
        <li><a href="#여러-nsrntcp2의-세션-요청-메시지-메시지">여러 NSR(NTCP2의 세션 요청 메시지) 메시지</a></li>
        <li><a href="#세션-상태-머신">세션 상태 머신</a></li>
      </ul>
    </li>
    <li><a href="#페이로드-형식">페이로드 형식</a>
      <ul>
        <li><a href="#블록-구조">블록 구조</a></li>
        <li><a href="#블록-유형">블록 유형</a></li>
        <li><a href="#블록-순서-규칙">블록 순서 규칙</a></li>
        <li><a href="#ns-메시지-순서">NS 메시지 순서</a></li>
        <li><a href="#nsr-메시지-순서">NSR 메시지 순서</a></li>
        <li><a href="#es-메시지-순서">ES 메시지 순서</a></li>
        <li><a href="#datetime-블록-유형-0">DateTime 블록 (유형 0)</a></li>
        <li><a href="#garlic-clove-block-garlic-encryption에서-개별-클로브를-담는-블록-유형-11">Garlic Clove Block (garlic encryption에서 개별 클로브를 담는 블록) (유형 11)</a></li>
        <li><a href="#nextkey-블록-유형-7">NextKey 블록 (유형 7)</a></li>
        <li><a href="#ack확인-응답-블록-유형-8">ACK(확인 응답) 블록 (유형 8)</a></li>
        <li><a href="#ack-요청-블록-타입-9">ACK 요청 블록 (타입 9)</a></li>
        <li><a href="#종료-블록-유형-4">종료 블록 (유형 4)</a></li>
        <li><a href="#옵션-블록-타입-5">옵션 블록 (타입 5)</a></li>
        <li><a href="#messagenumbers메시지-번호-블록-유형-6">MessageNumbers(메시지 번호) 블록 (유형 6)</a></li>
        <li><a href="#패딩-블록-유형-254">패딩 블록 (유형 254)</a></li>
      </ul>
    </li>
    <li><a href="#구현-가이드">구현 가이드</a>
      <ul>
        <li><a href="#사전-준비-사항">사전 준비 사항</a></li>
        <li><a href="#권장-구현-순서">권장 구현 순서</a></li>
        <li><a href="#송신자-구현">송신자 구현</a></li>
        <li><a href="#수신기-구현">수신기 구현</a></li>
        <li><a href="#메시지-분류">메시지 분류</a></li>
        <li><a href="#세션-관리-모범-사례">세션 관리 모범 사례</a></li>
        <li><a href="#테스트-전략">테스트 전략</a></li>
        <li><a href="#성능-고려-사항">성능 고려 사항</a></li>
      </ul>
    </li>
    <li><a href="#보안-고려사항">보안 고려사항</a>
      <ul>
        <li><a href="#위협-모델">위협 모델</a></li>
        <li><a href="#암호학적-가정">암호학적 가정</a></li>
        <li><a href="#키-관리">키 관리</a></li>
        <li><a href="#공격-완화-대책">공격 완화 대책</a></li>
        <li><a href="#재전송-공격-완화-기법">재전송 공격 완화 기법</a></li>
        <li><a href="#key-compromise-impersonation-kci-키-손상-가장-공격-완화-방안">Key Compromise Impersonation (KCI, 키 손상 가장 공격) 완화 방안</a></li>
        <li><a href="#서비스-거부dos-완화-대책">서비스 거부(DoS) 완화 대책</a></li>
        <li><a href="#트래픽-분석-저항성">트래픽 분석 저항성</a></li>
        <li><a href="#구현상의-함정">구현상의 함정</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#security-audits">Security Audits</a></li>
      </ul>
    </li>
    <li><a href="#configuration-and-deployment">Configuration and Deployment</a>
      <ul>
        <li><a href="#i2cp-configuration">I2CP Configuration</a></li>
        <li><a href="#java-i2p-configuration">Java I2P Configuration</a></li>
        <li><a href="#i2pd-configuration">i2pd Configuration</a></li>
        <li><a href="#compatibility-matrix">Compatibility Matrix</a></li>
        <li><a href="#migration-guide">Migration Guide</a></li>
        <li><a href="#performance-tuning">Performance Tuning</a></li>
        <li><a href="#monitoring-and-debugging">Monitoring and Debugging</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a>
      <ul>
        <li><a href="#specifications">Specifications</a></li>
        <li><a href="#cryptographic-standards">Cryptographic Standards</a></li>
        <li><a href="#implementation-resources">Implementation Resources</a></li>
        <li><a href="#additional-information">Additional Information</a></li>
      </ul>
    </li>
    <li><a href="#appendix-a-kdf-summary">Appendix A: KDF Summary</a></li>
    <li><a href="#appendix-b-message-size-calculator">Appendix B: Message Size Calculator</a></li>
    <li><a href="#appendix-c-glossary">Appendix C: Glossary</a></li>
  </ul>
</nav>
                    </div>
                </nav>
            </aside>
            

            
            <div class="docs-main">
                
                <nav class="breadcrumbs">
                    <a href="../../../../ko/">Home</a>
                    <span class="separator">/</span>
                    <a href="../../../../ko/docs/">Docs</a>
                    
                        
                            <span class="separator">/</span>
                            <a href="../../../../ko/docs/specs/">Specifications</a>
                        
                    
                    <span class="separator">/</span>
                    <span class="current">ECIES-X25519-AEAD-Ratchet 암호화 명세</span>
                </nav>

                
<div class="translation-disclaimer" role="note">
    <span class="disclaimer-message">이 번역은 기계 학습을 사용하여 생성되었으며 100% 정확하지 않을 수 있습니다.</span>
    
    
    <a href="../../../../en/docs/specs/ecies/" class="disclaimer-link">영어 버전 보기</a>
    
</div>



                
                <header class="article-header">
                    <h1 class="article-title">ECIES-X25519-AEAD-Ratchet 암호화 명세</h1>
                    
                        <p class="article-description">I2P용 타원곡선 통합 암호화 스킴 (X25519 &#43; AEAD)</p>
                    
                    <div class="article-meta">
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                Updated: 2025-10
                            </span>
                        
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Accurate for: 2.10.0
                            </span>
                        
                    </div>
                </header>

                
                <article class="article-content">
                    <h2 id="개요">개요</h2>
<h3 id="목적">목적</h3>
<p>ECIES-X25519-AEAD-Ratchet는 I2P의 최신 종단 간 암호화 프로토콜로, 기존의 ElGamal/AES+SessionTags(세션 태그) 시스템을 대체합니다. 이는 순방향 기밀성, 인증된 암호화, 그리고 성능과 보안의 상당한 향상을 제공합니다.</p>
<h3 id="elgamalaessessiontags-대비-핵심-개선점">ElGamal/AES+SessionTags 대비 핵심 개선점</h3>
<ul>
<li><strong>더 작은 키</strong>: 32바이트 키 대 256바이트 ElGamal 공개 키 (87.5% 감소)</li>
<li><strong>순방향 보안</strong>: DH ratcheting(세션 키를 단계적으로 갱신해 선행 키 노출에 대비하는 기법)으로 달성 (기존 프로토콜에는 없음)</li>
<li><strong>현대적 암호기술</strong>: X25519 DH, ChaCha20-Poly1305 AEAD(인증 기능이 결합된 암호화 방식), SHA-256</li>
<li><strong>인증된 암호화</strong>: AEAD 구성으로 인증이 내장됨</li>
<li><strong>양방향 프로토콜</strong>: 쌍으로 묶인 수신/송신 세션 대 단방향의 기존 방식</li>
<li><strong>효율적인 태그</strong>: 8바이트 세션 태그 대 32바이트 태그 (75% 감소)</li>
<li><strong>트래픽 난독화</strong>: Elligator2 encoding(무작위처럼 보이도록 매핑하는 인코딩)으로 핸드셰이크가 무작위와 구분되지 않음</li>
</ul>
<h3 id="배포-상태">배포 상태</h3>
<ul>
<li><strong>초기 릴리스</strong>: 버전 0.9.46 (2020년 5월 25일)</li>
<li><strong>네트워크 배포</strong>: 2020년 기준 완료</li>
<li><strong>현재 상태</strong>: 성숙함, 널리 배포됨(운영 환경에서 5년 이상)</li>
<li><strong>Router 지원</strong>: 버전 0.9.46 이상 필요</li>
<li><strong>Floodfill 요구 사항</strong>: 암호화된 조회를 위해 거의 100% 채택 필요</li>
</ul>
<h3 id="구현-상태">구현 상태</h3>
<p><strong>완전히 구현됨:</strong> - 바인딩이 포함된 새 세션(NS) 메시지 - 새 세션 응답(NSR) 메시지 - 기존 세션(ES) 메시지 - DH ratchet(단계적 키 갱신 메커니즘) - 세션 태그 ratchet 및 대칭 키 ratchet - DateTime, NextKey, ACK, ACK Request, Garlic Clove(갈릭 클로브), 및 Padding 블록</p>
<p><strong>미구현(버전 0.9.50 기준):</strong> - MessageNumbers 블록 (유형 6) - 옵션 블록 (유형 5) - 종료 블록 (유형 4) - 프로토콜 계층 자동 응답 - 정적 키 미사용 모드 - 멀티캐스트 세션</p>
<p><strong>참고</strong>: 일부 기능이 추가되었을 수 있으므로 버전 1.5.0부터 2.10.0(2021-2025)까지의 구현 상태는 확인이 필요합니다.</p>
<hr>
<h2 id="프로토콜의-기초">프로토콜의 기초</h2>
<h3 id="noise-protocol-frameworknoise-프로토콜-프레임워크">Noise Protocol Framework(Noise 프로토콜 프레임워크)</h3>
<p>ECIES-X25519-AEAD-Ratchet(ECIES, X25519, AEAD를 조합한 래쳇 방식)은 <a href="https://noiseprotocol.org/">Noise Protocol Framework</a>
 (리비전 34, 2018-07-11)를 기반으로 하며, 특히 I2P 특화 확장을 적용한 <strong>IK</strong>(대화형, 원격 정적 키가 알려진) 핸드셰이크 패턴을 사용한다.</p>
<h3 id="noise-protocol비밀-통신용-암호-프로토콜-프레임워크-식별자">Noise Protocol(비밀 통신용 암호 프로토콜 프레임워크) 식별자</h3>
<pre tabindex="0"><code>Noise_IKelg2+hs2_25519_ChaChaPoly_SHA256
</code></pre><p><strong>식별자 구성 요소:</strong> - <code>Noise</code> - 기본 프레임워크 - <code>IK</code> - 알려진 원격 정적 키와의 대화형 핸드셰이크 패턴 - <code>elg2</code> - 임시 키를 위한 Elligator2 인코딩(난독화 매핑 기법) (I2P 확장) - <code>+hs2</code> - 태그를 혼합하기 위해 두 번째 메시지 전에 호출되는 MixHash (I2P 확장) - <code>25519</code> - X25519 디피-헬만 함수 - <code>ChaChaPoly</code> - ChaCha20-Poly1305 AEAD 암호 - <code>SHA256</code> - SHA-256 해시 함수</p>
<h3 id="noise-핸드셰이크-패턴">Noise 핸드셰이크 패턴</h3>
<p><strong>IK 패턴 표기:</strong></p>
<pre tabindex="0"><code>&lt;- s                    (Bob&#39;s static key known to Alice)
...
-&gt; e, es, s, ss         (Alice sends ephemeral, DH es, static key, DH ss)
&lt;- e, ee, se            (Bob sends ephemeral, DH ee, DH se)
</code></pre><p><strong>토큰 의미:</strong> - <code>e</code> - 임시 키 전송 - <code>s</code> - 정적 키 전송 - <code>es</code> - Alice의 임시 키와 Bob의 정적 키 간의 DH(Diffie-Hellman) - <code>ss</code> - Alice의 정적 키와 Bob의 정적 키 간의 DH - <code>ee</code> - Alice의 임시 키와 Bob의 임시 키 간의 DH - <code>se</code> - Bob의 정적 키와 Alice의 임시 키 간의 DH</p>
<h3 id="noise프로토콜-프레임워크의-보안-속성">Noise(프로토콜 프레임워크)의 보안 속성</h3>
<p>Noise 용어로 말하면 IK pattern(Noise 핸드셰이크 패턴의 하나)은 다음을 제공합니다:</p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Message</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Authentication Level</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Confidentiality Level</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Message&nbsp;1 (NS)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;1 (sender auth, KCI vulnerable)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;2 (weak forward secrecy)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Message&nbsp;2 (NSR)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;2 (mutual auth)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;4 (weak forward secrecy)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Transport (ES)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;2 (mutual auth)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;5 (strong forward secrecy)</td>
    </tr>
  </tbody>
</table>
**인증 수준:** - **레벨 1**: 페이로드는 발신자의 정적 키 소유자의 것으로 인증되지만, 키 손상에 의한 사칭(KCI)에 취약함 - **레벨 2**: NSR 이후 KCI 공격에 대한 내성이 있음
<p><strong>기밀성 수준:</strong> - <strong>레벨 2</strong>: 발신자의 정적 키가 나중에 노출되더라도 순방향 기밀성 - <strong>레벨 4</strong>: 발신자의 임시 키가 나중에 노출되더라도 순방향 기밀성 - <strong>레벨 5</strong>: 양쪽의 임시 키가 모두 삭제된 후 완전한 순방향 기밀성</p>
<h3 id="ik와-xk의-차이점">IK와 XK의 차이점</h3>
<p>IK 패턴(Noise 프로토콜의 핸드셰이크 패턴)은 NTCP2와 SSU2에서 사용되는 XK 패턴과 다릅니다:</p>
<ol>
<li><strong>네 가지 DH 연산</strong>: IK는 4개의 DH 연산(es, ss, ee, se)을 사용하며, XK는 3개</li>
<li><strong>즉시 인증</strong>: 첫 번째 메시지에서 Alice가 인증됨(인증 수준 1)</li>
<li><strong>더 빠른 전방향 기밀성</strong>: 두 번째 메시지(1-RTT) 후에 완전한 전방향 기밀성(수준 5) 달성</li>
<li><strong>트레이드오프</strong>: 첫 번째 메시지의 페이로드는 전방향 기밀성이 아님(XK에서는 모든 페이로드가 전방향 기밀성임)</li>
</ol>
<p><strong>Summary</strong>: IK는 Bob의 응답을 완전한 전방향 보안성(forward secrecy) 하에 1-RTT로 전달할 수 있게 해주지만, 그 대가로 초기 요청에는 전방향 보안성이 적용되지 않는다.</p>
<h3 id="signal-double-ratchet시그널-이중-래칫-개념">Signal Double Ratchet(시그널 이중 래칫) 개념</h3>
<p>ECIES(타원 곡선 통합 암호화 방식)은 <a href="https://signal.org/docs/specifications/doubleratchet/">Signal Double Ratchet 알고리즘</a>
에서 개념을 채택합니다:</p>
<ul>
<li><strong>DH Ratchet</strong>(디피-헬먼 래칫): 주기적으로 새로운 DH 키를 교환하여 순방향 기밀성을 제공합니다</li>
<li><strong>Symmetric Key Ratchet</strong>(대칭 키 래칫): 각 메시지마다 새로운 세션 키를 파생합니다</li>
<li><strong>Session Tag Ratchet</strong>(세션 태그 래칫): 결정론적으로 일회용 session tags를 생성합니다</li>
</ul>
<p><strong>Signal과의 주요 차이점:</strong> - <strong>래칫을 덜 자주 수행</strong>: I2P는 필요할 때만 래칫을 수행함(태그가 소진되기 직전이거나 정책에 따라) - <strong>헤더 암호화 대신 세션 태그</strong>: 암호화된 헤더 대신 결정적 태그를 사용 - <strong>명시적 ACK(확인 응답)</strong>: 역방향 트래픽에만 의존하지 않고 대역 내(in-band) ACK 블록을 사용 - <strong>태그 래칫과 키 래칫 분리</strong>: 수신자에게 더 효율적임(키 계산을 지연할 수 있음)</p>
<h3 id="noise프로토콜-프레임워크용-i2p-확장">Noise(프로토콜 프레임워크)용 I2P 확장</h3>
<hr>
<h2 id="암호학적-프리미티브">암호학적 프리미티브</h2>
<h3 id="x25519-디피-헬만">X25519 디피-헬만</h3>
<p><strong>명세</strong>: <a href="https://tools.ietf.org/html/rfc7748">RFC 7748</a>
</p>
<p><strong>주요 속성:</strong> - <strong>개인 키 크기</strong>: 32 바이트 - <strong>공개 키 크기</strong>: 32 바이트 - <strong>공유 비밀 크기</strong>: 32 바이트 - <strong>엔디언 방식</strong>: 리틀 엔디언 - <strong>곡선</strong>: Curve25519</p>
<p><strong>작업:</strong></p>
<h3 id="x25519-generate_private">X25519 GENERATE_PRIVATE()</h3>
<p>무작위 32바이트 개인 키를 생성합니다:</p>
<pre tabindex="0"><code>privkey = CSRNG(32)
</code></pre><h3 id="x25519-derive_publicprivkey">X25519 DERIVE_PUBLIC(privkey)</h3>
<p>해당하는 공개 키를 도출합니다:</p>
<pre tabindex="0"><code>pubkey = curve25519_scalarmult_base(privkey)
</code></pre><p>32바이트 리틀 엔디언 공개 키를 반환합니다.</p>
<h3 id="x25519-dhprivkey-pubkey">X25519 DH(privkey, pubkey)</h3>
<p>Diffie-Hellman 키 합의를 수행합니다:</p>
<pre tabindex="0"><code>sharedSecret = curve25519_scalarmult(privkey, pubkey)
</code></pre><p>32바이트 길이의 공유 비밀을 반환합니다.</p>
<p><strong>Security Note</strong>: 구현자는 공유 비밀이 모두 0인 값(약한 키)이 아님을 검증해야 한다. 이 경우에는 거부하고 핸드셰이크를 중단해야 한다.</p>
<h3 id="chacha20-poly1305-aead연관-데이터가-있는-인증된-암호화">ChaCha20-Poly1305 AEAD(연관 데이터가 있는 인증된 암호화)</h3>
<p><strong>명세</strong>: <a href="https://tools.ietf.org/html/rfc7539">RFC 7539</a>
 섹션 2.8</p>
<p><strong>매개변수:</strong> - <strong>키 길이</strong>: 32 바이트 (256 비트) - <strong>논스 길이</strong>: 12 바이트 (96 비트) - <strong>MAC 길이</strong>: 16 바이트 (128 비트) - <strong>블록 크기</strong>: 64 바이트 (내부)</p>
<p><strong>논스 형식:</strong></p>
<pre tabindex="0"><code>Byte 0-3:   0x00 0x00 0x00 0x00  (always zero)
Byte 4-11:  Little-endian counter (message number N)
</code></pre><p><strong>AEAD(연관 데이터가 포함된 인증 암포화) 구성:</strong></p>
<p>AEAD(연관 데이터가 있는 인증 암호화)은 ChaCha20 스트림 암호와 Poly1305 MAC을 결합합니다:</p>
<ol>
<li>키와 논스로부터 ChaCha20 키스트림을 생성한다</li>
<li>키스트림과 XOR하여 평문을 암호화한다</li>
<li>(연관 데이터 || 암호문)에 대해 Poly1305 MAC을 계산한다</li>
<li>암호문에 16바이트 MAC을 추가한다</li>
</ol>
<h3 id="chacha20-poly1305-encryptk-n-plaintext-ad">ChaCha20-Poly1305 ENCRYPT(k, n, plaintext, ad)</h3>
<p>인증과 함께 평문을 암호화합니다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Inputs</span>
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span><span style="color:#f92672">-</span>byte cipher key
</span></span><span style="display:flex;"><span>n <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span><span style="color:#f92672">-</span>byte nonce (first <span style="color:#ae81ff">4</span> bytes zero, last <span style="color:#ae81ff">8</span> bytes <span style="color:#f92672">=</span> message number)
</span></span><span style="display:flex;"><span>plaintext <span style="color:#f92672">=</span> data to encrypt (<span style="color:#ae81ff">0</span> to <span style="color:#ae81ff">65519</span> bytes)
</span></span><span style="display:flex;"><span>ad <span style="color:#f92672">=</span> associated data (optional, used <span style="color:#f92672">in</span> MAC calculation)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Output</span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> chacha20_encrypt(k, n, plaintext)
</span></span><span style="display:flex;"><span>mac <span style="color:#f92672">=</span> poly1305(ad <span style="color:#f92672">||</span> ciphertext, poly1305_key_gen(k, n))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> ciphertext <span style="color:#f92672">||</span> mac  <span style="color:#75715e"># Total length = len(plaintext) + 16</span>
</span></span></code></pre></div><p><strong>속성:</strong> - 암호문은 평문과 동일한 길이입니다(스트림 암호) - 출력은 plaintext_length + 16바이트입니다(MAC 포함) - 키가 비밀인 경우 전체 출력은 무작위 데이터와 구별되지 않습니다 - MAC(메시지 인증 코드)는 연관 데이터와 암호문 모두를 인증합니다</p>
<h3 id="chacha20-poly1305-복호화k-n-ciphertext-ad">ChaCha20-Poly1305 복호화(k, n, ciphertext, ad)</h3>
<p>복호화하고 인증을 검증합니다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Split ciphertext and MAC</span>
</span></span><span style="display:flex;"><span>ct_without_mac <span style="color:#f92672">=</span> ciphertext[<span style="color:#ae81ff">0</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>received_mac <span style="color:#f92672">=</span> ciphertext[<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Verify MAC</span>
</span></span><span style="display:flex;"><span>expected_mac <span style="color:#f92672">=</span> poly1305(ad <span style="color:#f92672">||</span> ct_without_mac, poly1305_key_gen(k, n))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> constant_time_compare(received_mac, expected_mac):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> AuthenticationError(<span style="color:#e6db74">&#34;MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Decrypt</span>
</span></span><span style="display:flex;"><span>plaintext <span style="color:#f92672">=</span> chacha20_decrypt(k, n, ct_without_mac)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> plaintext
</span></span></code></pre></div><p><strong>중요 보안 요구 사항:</strong> - 동일한 키를 사용하는 각 메시지마다 논스(nonce)는 반드시 고유해야 합니다 - 논스는 재사용되어서는 안 됩니다 (재사용 시 치명적인 실패 발생) - MAC 검증은 타이밍 공격을 방지하기 위해 상수 시간 비교를 사용해야 합니다 - MAC 검증에 실패한 경우 반드시 전체 메시지를 거부해야 합니다 (부분 복호화 없음)</p>
<h3 id="sha-256-해시-함수">SHA-256 해시 함수</h3>
<p><strong>명세</strong>: NIST FIPS 180-4</p>
<p><strong>속성:</strong> - <strong>출력 크기</strong>: 32 바이트 (256 비트) - <strong>블록 크기</strong>: 64 바이트 (512 비트) - <strong>보안 수준</strong>: 128 비트 (충돌 저항성)</p>
<p><strong>작업:</strong></p>
<h3 id="sha-256-hp-d">SHA-256 H(p, d)</h3>
<p>personalization string(개인화 문자열)을 사용한 SHA-256 해시:</p>
<pre tabindex="0"><code>H(p, d) := SHA256(p || d)
</code></pre><p>여기서 <code>||</code>는 연접을 나타내고, <code>p</code>는 개인화 문자열, <code>d</code>는 데이터이다.</p>
<h3 id="sha-256-mixhashd">SHA-256 MixHash(d)</h3>
<p>새 데이터로 누적 해시를 업데이트합니다:</p>
<pre tabindex="0"><code>h = SHA256(h || d)
</code></pre><p>Noise 핸드셰이크 전 과정에서 transcript hash(대화 기록 해시)를 유지하기 위해 사용됩니다.</p>
<h3 id="hkdf-키-파생">HKDF 키 파생</h3>
<p><strong>사양</strong>: <a href="https://tools.ietf.org/html/rfc5869">RFC 5869</a>
</p>
<p><strong>설명</strong>: SHA-256을 사용하는 HMAC 기반 키 유도 함수</p>
<p><strong>매개변수:</strong> - <strong>해시 함수</strong>: HMAC-SHA256 - <strong>솔트 길이</strong>: 최대 32 바이트 (SHA-256 출력 크기) - <strong>출력 길이</strong>: 가변 (최대 255 * 32 바이트)</p>
<p><strong>HKDF 함수:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">HKDF</span>(salt, ikm, info, length):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        salt: Salt value (32 bytes max for SHA-256)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ikm: Input key material (any length)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        info: Context-specific info string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        length: Desired output length in bytes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        output: Derived key material (length bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract phase</span>
</span></span><span style="display:flex;"><span>    prk <span style="color:#f92672">=</span> HMAC<span style="color:#f92672">-</span>SHA256(salt, ikm)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Expand phase</span>
</span></span><span style="display:flex;"><span>    n <span style="color:#f92672">=</span> ceil(length <span style="color:#f92672">/</span> <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    okm <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, n <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> HMAC<span style="color:#f92672">-</span>SHA256(prk, t <span style="color:#f92672">||</span> info <span style="color:#f92672">||</span> byte(i))
</span></span><span style="display:flex;"><span>        okm <span style="color:#f92672">=</span> okm <span style="color:#f92672">||</span> t
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> okm[<span style="color:#ae81ff">0</span>:length]
</span></span></code></pre></div><p><strong>일반적인 사용 패턴:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate two keys (64 bytes total)</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret, <span style="color:#e6db74">&#34;KDFDHRatchetStep&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>nextRootKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate session tag (8 bytes)</span>
</span></span><span style="display:flex;"><span>tagdata <span style="color:#f92672">=</span> HKDF(chainKey, CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>nextChainKey <span style="color:#f92672">=</span> tagdata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>sessionTag <span style="color:#f92672">=</span> tagdata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate symmetric key (32 bytes)</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>nextChainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>sessionKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span></code></pre></div><p><strong>ECIES에서 사용되는 Info 문자열:</strong> - <code>&quot;KDFDHRatchetStep&quot;</code> - DH ratchet(일방향 상태 갱신 메커니즘) 키 유도 - <code>&quot;TagAndKeyGenKeys&quot;</code> - 태그 및 키 체인 키 초기화 - <code>&quot;STInitialization&quot;</code> - 세션 태그 ratchet 초기화 - <code>&quot;SessionTagKeyGen&quot;</code> - 세션 태그 생성 - <code>&quot;SymmetricRatchet&quot;</code> - 대칭 키 생성 - <code>&quot;XDHRatchetTagSet&quot;</code> - DH ratchet 태그 세트 키 - <code>&quot;SessionReplyTags&quot;</code> - NSR 태그 세트 생성 - <code>&quot;AttachPayloadKDF&quot;</code> - NSR 페이로드 키 유도</p>
<h3 id="elligator2엘리게이터2-인코딩">Elligator2(엘리게이터2) 인코딩</h3>
<p><strong>목적</strong>: X25519 공개 키를 균일한 무작위 32바이트 문자열과 구분할 수 없도록 인코딩한다.</p>
<p><strong>명세</strong>: <a href="https://elligator.cr.yp.to/elligator-20130828.pdf">Elligator2 논문</a>
</p>
<p><strong>문제</strong>: 표준 X25519 공개 키는 식별 가능한 구조를 갖습니다. 관찰자는 내용이 암호화되어 있더라도 이러한 키를 감지하여 핸드셰이크 메시지를 식별할 수 있습니다.</p>
<p><strong>해결책</strong>: Elligator2(타원 곡선 공개 키를 난수처럼 보이게 매핑하는 기법)는 유효한 X25519 공개 키의 약 50%와 난수처럼 보이는 254비트 문자열 사이에 일대일(전단사) 대응을 제공합니다.</p>
<p><strong>Elligator2(타원곡선 포인트를 균일한 난수처럼 매핑하는 기법)을 사용한 키 생성:</strong></p>
<h3 id="elligator2-generate_private_elg2">Elligator2 GENERATE_PRIVATE_ELG2()</h3>
<p>Elligator2(공개 키를 난수처럼 보이게 인코딩하는 기법)로 인코딩 가능한 공개 키에 대응하는 개인 키를 생성합니다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>    privkey <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    pubkey <span style="color:#f92672">=</span> DERIVE_PUBLIC(privkey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Test if public key is Elligator2-encodable</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        encoded <span style="color:#f92672">=</span> ENCODE_ELG2(pubkey)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Success - this key pair is suitable</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> privkey
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> NotEncodableError:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Try again with new random key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>
</span></span></code></pre></div><p><strong>중요</strong>: 무작위로 생성된 개인 키의 약 50%는 인코딩할 수 없는 공개 키를 생성합니다. 이러한 키는 폐기하고 재생성을 시도해야 합니다.</p>
<p><strong>성능 최적화</strong>: 백그라운드 스레드에서 키를 미리 생성해 적합한 키 쌍 풀을 유지함으로써 핸드셰이크 중 지연을 방지합니다.</p>
<h3 id="elligator2-encode_elg2pubkey">Elligator2 ENCODE_ELG2(pubkey)</h3>
<p>공개 키를 무작위처럼 보이는 32바이트로 인코딩합니다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ENCODE_ELG2</span>(pubkey):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Encodes X25519 public key using Elligator2.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pubkey: 32-byte X25519 public key (little-endian)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        encoded: 32-byte encoded key indistinguishable from random
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Raises:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        NotEncodableError: If pubkey cannot be encoded
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform Elligator2 representative calculation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Returns 254-bit value (31.75 bytes)</span>
</span></span><span style="display:flex;"><span>    encodedKey <span style="color:#f92672">=</span> elligator2_encode(pubkey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Add 2 random bits to MSB to make full 32 bytes</span>
</span></span><span style="display:flex;"><span>    randomByte <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    encodedKey[<span style="color:#ae81ff">31</span>] <span style="color:#f92672">|=</span> (randomByte <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xc0</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> encodedKey
</span></span></code></pre></div><p><strong>인코딩 세부사항:</strong> - Elligator2(공개키를 무작위 데이터처럼 보이게 매핑하는 기법)는 254비트를 생성합니다(전체 256은 아님) - 바이트 31의 상위 2비트는 무작위 패딩입니다 - 결과는 32바이트 공간 전체에 균일하게 분포합니다 - 유효한 X25519(곡선25519 기반 키 교환) 공개키의 약 50%를 성공적으로 인코딩합니다</p>
<h3 id="elligator2-decode_elg2encodedkey">Elligator2 DECODE_ELG2(encodedKey)</h3>
<p>다시 원래의 공개 키로 디코딩됩니다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">DECODE_ELG2</span>(encodedKey):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Decodes Elligator2-encoded key back to X25519 public key.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        encodedKey: 32-byte encoded key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pubkey: 32-byte X25519 public key (little-endian)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Mask out 2 random padding bits from MSB</span>
</span></span><span style="display:flex;"><span>    encodedKey[<span style="color:#ae81ff">31</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0x3f</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform Elligator2 representative inversion</span>
</span></span><span style="display:flex;"><span>    pubkey <span style="color:#f92672">=</span> elligator2_decode(encodedKey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pubkey
</span></span></code></pre></div><p><strong>보안 속성:</strong> - 인코딩된 키는 계산적으로 난수 바이트와 구별할 수 없다 - 어떠한 통계적 검정으로도 Elligator2로 인코딩된 키를 신뢰할 만하게 검출할 수 없다 - 디코딩은 결정적이다 (같은 인코딩된 키는 항상 같은 공개키를 생성한다) - 인코딩 가능한 부분집합에 속한 키의 ~50%에 대해서 인코딩은 전단사이다</p>
<p><strong>구현 노트:</strong> - 핸드셰이크 중 재인코딩을 피하기 위해 생성 단계에서 인코딩된 키를 저장 - Elligator2(공개키를 난수처럼 보이게 매핑하는 기법) 생성 과정에서 부적합 판정된 키는 NTCP2에서 사용 가능(Elligator2가 필요하지 않음) - 백그라운드에서의 키 생성은 성능에 필수적 - 거부율 50%로 인해 평균 생성 시간이 두 배로 증가</p>
<hr>
<h2 id="메시지-형식">메시지 형식</h2>
<h3 id="개요-1">개요</h3>
<p>ECIES(타원 곡선 통합 암호화 체계)는 세 가지 메시지 유형을 정의합니다:</p>
<ol>
<li><strong>새 세션 (NS)</strong>: Alice가 Bob에게 보내는 초기 핸드셰이크 메시지</li>
<li><strong>새 세션 응답 (NSR)</strong>: Bob이 Alice에게 보내는 핸드셰이크 응답</li>
<li><strong>기존 세션 (ES)</strong>: 이후의 모든 메시지(양방향)</li>
</ol>
<p>모든 메시지는 추가적인 암호화 계층을 더해 I2NP Garlic Message(여러 메시지를 하나로 묶어 전달하는 I2P 메시지 형식) 포맷으로 캡슐화됩니다.</p>
<h3 id="i2np-garlic-메시지-컨테이너">I2NP Garlic 메시지 컨테이너</h3>
<p>모든 ECIES(타원곡선 통합 암호 체계) 메시지는 표준 I2NP Garlic Message 헤더로 감싸집니다:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|type|      msg_id       |  expiration   |
+----+----+----+----+----+----+----+----+
                         |  size   |chks|
+----+----+----+----+----+----+----+----+
|      length       |                   |
+----+----+----+----+                   +
|          encrypted data               |
~                                       ~
</code></pre><p><strong>필드:</strong> - <code>type</code>: 0x26 (Garlic Message(갈릭 메시지)) - <code>msg_id</code>: 4바이트 I2NP 메시지 ID - <code>expiration</code>: 8바이트 유닉스 타임스탬프(밀리초) - <code>size</code>: 2바이트 페이로드 크기 - <code>chks</code>: 1바이트 체크섬 - <code>length</code>: 4바이트 암호화된 데이터 길이 - <code>encrypted data</code>: ECIES(타원곡선 통합 암호 방식)로 암호화된 페이로드</p>
<p><strong>목적</strong>: I2NP 계층의 메시지 식별 및 라우팅을 제공합니다. <code>length</code> 필드는 수신자가 암호화된 페이로드의 총 크기를 알 수 있도록 합니다.</p>
<h3 id="새-세션-ns-메시지">새 세션 (NS) 메시지</h3>
<p>New Session 메시지(새 세션 메시지)는 Alice가 Bob에게 새 세션을 개시한다. 이 메시지는 세 가지 변형으로 존재한다:</p>
<ol>
<li><strong>바인딩 포함</strong> (1b): 양방향 통신을 위해 Alice의 정적 키를 포함</li>
<li><strong>바인딩 없음</strong> (1c): 단방향 통신을 위해 정적 키를 생략</li>
<li><strong>일회용</strong> (1d): 세션 수립 없이 단일 메시지 모드</li>
</ol>
<h3 id="바인딩이-포함된-ns-메시지-유형-1b">바인딩이 포함된 NS 메시지 (유형 1b)</h3>
<p><strong>사용 사례</strong>: 스트리밍, 응답 가능한 데이터그램, 응답이 필요한 모든 프로토콜</p>
<p><strong>총 길이</strong>: 96 + payload_length 바이트</p>
<p><strong>형식</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+                                       +
|   New Session Ephemeral Public Key    |
+             32 bytes                  +
|     Encoded with Elligator2           |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+         Static Key Section            +
|       ChaCha20 encrypted data         |
+            32 bytes                   +
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+    (MAC) for Static Key Section       +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for Payload Section     +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>필드 세부 정보:</strong></p>
<p><strong>임시 공개키</strong> (32바이트, 평문): - Alice의 1회용 X25519 공개키 - Elligator2로 인코딩됨 (무작위와 구분 불가능) - 각 NS 메시지마다 새로 생성됨 (재사용하지 않음) - 리틀엔디언 형식</p>
<p><strong>정적 키 섹션</strong> (32바이트 암호화, MAC 포함 48바이트): - Alice의 X25519 정적 공개 키(32바이트) 포함 - ChaCha20으로 암호화됨 - Poly1305 MAC(16바이트)으로 인증됨 - Bob이 세션을 Alice의 목적지에 바인딩하는 데 사용</p>
<p><strong>페이로드 섹션</strong> (가변 길이로 암호화됨, +16바이트 MAC): - Garlic Clove(서브메시지 단위) 및 기타 블록을 포함함 - 첫 번째 블록으로 DateTime 블록을 반드시 포함해야 함 - 보통 애플리케이션 데이터가 포함된 Garlic Clove 블록을 포함함 - immediate ratchet(즉시 래칫)을 위한 NextKey 블록을 포함할 수 있음 - ChaCha20으로 암호화됨 - Poly1305 MAC (16바이트)으로 인증됨</p>
<p><strong>보안 속성:</strong> - 임시 키는 전방 기밀성 요소를 제공한다 - 정적 키는 Alice를 인증한다(목적지에 바인딩) - 각 섹션은 도메인 분리를 위해 별도의 MAC을 사용한다 - 전체 핸드셰이크는 2개의 DH 연산을 수행한다 (es, ss)</p>
<h3 id="바인딩-없는-ns-메시지-유형-1c">바인딩 없는 NS 메시지 (유형 1c)</h3>
<p><strong>사용 사례</strong>: 응답을 기대하지도 원하지도 않는 원시 데이터그램</p>
<p><strong>총 길이</strong>: 96 + payload_length 바이트</p>
<p><strong>형식</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+                                       +
|   New Session Ephemeral Public Key    |
+             32 bytes                  +
|     Encoded with Elligator2           |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+           Flags Section               +
|       ChaCha20 encrypted data         |
+            32 bytes                   +
|           All zeros                   |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for above section       +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for Payload Section     +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>핵심 차이점</strong>: Flags 섹션은 정적 키 대신 0으로 채워진 32바이트를 포함합니다.</p>
<p><strong>판별</strong>: Bob은 32바이트 구간을 복호화하고 모든 바이트가 0인지 확인해 메시지 유형을 판별한다: - 모두 0 → Unbound session (바인딩되지 않은 세션) (type 1c) - 0이 아님 → Bound session with static key (정적 키로 바인딩된 세션) (type 1b)</p>
<p><strong>속성:</strong> - static key(정적 키)가 없으므로 Alice의 Destination(목적지)에 바인딩되지 않음 - Bob은 응답을 보낼 수 없음(Destination을 알 수 없음) - DH(디피-헬먼) 연산을 단 1회만 수행 - &ldquo;IK&rdquo;(상호 정적 키 인지 패턴) 대신 Noise &ldquo;N&rdquo; pattern(상대 정적 키 미인지 패턴)을 따름 - 응답이 전혀 필요하지 않을 때 더 효율적임</p>
<p><strong>플래그 섹션</strong> (향후 사용을 위해 예약됨): 현재는 모두 0입니다. 향후 버전에서 feature negotiation(기능 협상)에 사용될 수 있습니다.</p>
<h3 id="ns-일회성-메시지-type-1d">NS 일회성 메시지 (Type 1d)</h3>
<p><strong>사용 사례</strong>: 세션 없이 회신도 기대하지 않는 단일 익명 메시지</p>
<p><strong>총 길이</strong>: 96 + payload_length 바이트</p>
<p><strong>형식</strong>: 바인딩 없는 NS와 동일함 (type 1c)</p>
<p><strong>구분</strong>:  - Type 1c는 동일한 세션에서 여러 메시지를 보낼 수 있습니다 (ES 메시지가 뒤따릅니다) - Type 1d는 세션 수립 없이 정확히 하나의 메시지만 보냅니다 - 실제 구현에서는 초기에는 이를 동일하게 취급할 수 있습니다</p>
<p><strong>속성:</strong> - 최대 익명성 (정적 키 없음, 세션 없음) - 양측 모두 세션 상태를 유지하지 않음 - Noise &ldquo;N&rdquo; 패턴을 따름 - 단일 DH(디피-헬만) 연산 (es)</p>
<h3 id="새-세션-응답nsr-메시지">새 세션 응답(NSR) 메시지</h3>
<p>Bob은 Alice의 NS 메시지에 응답하여 하나 이상의 NSR 메시지를 전송한다. NSR은 Noise IK handshake(Noise 프로토콜의 IK 방식 핸드셰이크)를 완료하고 양방향 세션을 수립한다.</p>
<p><strong>총 길이</strong>: 72 + payload_length 바이트</p>
<p><strong>형식</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|       Session Tag   8 bytes           |
+----+----+----+----+----+----+----+----+
|                                       |
+        Ephemeral Public Key           +
|                                       |
+            32 bytes                   +
|     Encoded with Elligator2           |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+  (MAC) for Key Section (empty)        +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for Payload Section     +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>필드 세부 정보:</strong></p>
<p><strong>세션 태그</strong> (8바이트, 평문): - NSR(약어) 태그 세트에서 생성됨 (KDF(키 유도 함수) 섹션 참조) - 이 응답을 Alice의 NS(약어) 메시지와 연관시킴 - Alice가 이 NSR이 어떤 NS에 응답하는지 식별할 수 있게 함 - 일회용 (재사용하지 않음)</p>
<p><strong>Ephemeral Public Key</strong> (임시 공개키) (32바이트, 평문): - Bob의 일회용 X25519 공개키 - Elligator2로 인코딩됨 - 각 NSR 메시지마다 새로 생성됨 - 전송되는 각 NSR마다 서로 달라야 함</p>
<p><strong>키 섹션 MAC</strong> (16바이트): - 빈 데이터(ZEROLEN)를 인증함 - Noise IK 프로토콜(se pattern: static-ephemeral 패턴)의 일부 - 해시 트랜스크립트(hash transcript)를 연관 데이터(associated data)로 사용 - NSR을 NS에 바인딩하는 데 핵심적</p>
<p><strong>Payload Section</strong> (가변 길이): - garlic cloves(갈릭 메시지의 하위 메시지 단위)와 블록을 포함 - 보통 애플리케이션 계층 응답을 포함 - 비어 있을 수 있음(ACK-only NSR) - 최대 크기: 65519바이트(65535 - 16바이트 MAC)</p>
<p><strong>여러 개의 NSR 메시지:</strong></p>
<p>Bob은 하나의 NS에 대한 응답으로 여러 개의 NSR 메시지를 보낼 수 있습니다: - 각 NSR에는 고유한 임시 키가 있습니다 - 각 NSR에는 고유한 세션 태그가 있습니다 - Alice는 가장 먼저 수신된 NSR을 사용해 핸드셰이크를 완료합니다 - 다른 NSR들은 (패킷 손실 발생 시를 대비한) 중복입니다</p>
<p><strong>중요 타이밍:</strong> - Alice는 ES 메시지를 보내기 전에 NSR을 하나 수신해야 합니다 - Bob은 ES 메시지를 보내기 전에 ES 메시지 하나를 수신해야 합니다 - NSR은 split() 연산을 통해 양방향 세션 키를 설정합니다</p>
<p><strong>보안 속성:</strong> - Noise IK 핸드셰이크를 완료함 - 추가로 2개의 Diffie-Hellman(DH) 연산을 수행함(ee, se) - NS+NSR 전반에 걸쳐 총 4회의 DH 연산 - 상호 인증(Level 2)을 달성함 - NSR 페이로드에 대해 약한 Forward Secrecy(순방향 기밀성) (Level 4)을 제공함</p>
<h3 id="기존-세션es-메시지">기존 세션(ES) 메시지</h3>
<p>NS/NSR 핸드셰이크 이후의 모든 메시지는 Existing Session(기존 세션) 형식을 사용한다. ES 메시지는 Alice와 Bob 모두에 의해 양방향으로 사용된다.</p>
<p><strong>총 길이</strong>: 8 + payload_length + 16 바이트 (최소 24 바이트)</p>
<p><strong>형식</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|       Session Tag   8 bytes           |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+              (MAC)                    +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>필드 세부 정보:</strong></p>
<p><strong>세션 태그</strong> (8바이트, 평문): - 현재 발신 태그셋에서 생성됨 - 세션과 메시지 번호를 식별 - 수신자는 태그를 조회하여 세션 키와 논스를 찾음 - 일회용(각 태그는 정확히 한 번만 사용됨) - 형식: HKDF 출력의 처음 8바이트</p>
<p><strong>페이로드 섹션</strong> (가변 길이): - Garlic Clove(garlic encryption에서의 개별 메시지 단위)와 블록을 포함 - 필수 블록 없음(비어 있을 수 있음) - 일반적인 블록: Garlic Clove, NextKey, ACK, ACK Request, Padding - 최대 크기: 65519 바이트 (65535 - 16 바이트 MAC)</p>
<p><strong>MAC</strong> (16바이트): - Poly1305 인증 태그 - 전체 페이로드에 대해 계산됨 - 연관 데이터: 8바이트 세션 태그 - 올바르게 검증되어야 하며 그렇지 않으면 메시지가 거부됨</p>
<p><strong>태그 조회 과정:</strong></p>
<ol>
<li>수신자는 8바이트 태그를 추출한다</li>
<li>현재의 모든 인바운드 태그셋에서 태그를 조회한다</li>
<li>연관된 세션 키와 메시지 번호 N을 가져온다</li>
<li>논스를 구성한다: <code>[0x00, 0x00, 0x00, 0x00, N (8 bytes little-endian)]</code></li>
<li>태그를 연관 데이터로 하여 AEAD(연관 데이터가 있는 인증 암호화)를 사용해 페이로드를 복호화한다</li>
<li>태그셋에서 태그를 제거한다(일회용)</li>
<li>복호화된 블록을 처리한다</li>
</ol>
<p><strong>세션 태그를 찾을 수 없음:</strong></p>
<p>태그가 어떤 태그 세트에서도 발견되지 않는 경우: - NS 메시지일 수 있음 → NS 복호화 시도 - NSR 메시지일 수 있음 → NSR 복호화 시도 - 순서가 뒤바뀐 ES일 수 있음 → 태그 세트 업데이트를 잠시 기다림 - 재전송 공격일 수 있음 → 거부 - 손상된 데이터일 수 있음 → 거부</p>
<p><strong>빈 페이로드:</strong></p>
<p>ES 메시지는 빈 페이로드(0바이트)를 가질 수 있습니다: - ACK 요청이 수신되었을 때 명시적인 ACK(확인 응답)으로 동작함 - 애플리케이션 데이터 없이 프로토콜 계층의 응답을 제공함 - 여전히 세션 태그를 소모함 - 상위 계층에서 즉시 보낼 데이터가 없을 때 유용함</p>
<p><strong>보안 속성:</strong> - NSR 수신 후 완전한 전방향 기밀성(레벨 5) - AEAD(연관 데이터를 포함한 인증 암호)를 통한 인증 암호화 - 태그가 추가적인 연관 데이터로 작용 - ratchet(키 갱신 메커니즘)이 필요해지기 전에 태그 세트당 최대 65535개의 메시지</p>
<hr>
<h2 id="키-유도-함수">키 유도 함수</h2>
<p>이 섹션에서는 ECIES(타원곡선 통합 암호화 방식)에서 사용되는 모든 KDF(키 파생 함수) 연산을 문서화하고, 완전한 암호학적 유도 과정을 보여 줍니다.</p>
<h3 id="표기법과-상수">표기법과 상수</h3>
<p><strong>상수:</strong> - <code>ZEROLEN</code> - 길이가 0인 바이트 배열(빈 문자열) - <code>||</code> - 연결 연산자</p>
<p><strong>변수:</strong> - <code>h</code> - 트랜스크립트의 누적 해시 (32바이트) - <code>chainKey</code> - HKDF용 체인 키 (32바이트) - <code>k</code> - 대칭 암호 키 (32바이트) - <code>n</code> - 논스 / 메시지 번호</p>
<p><strong>키:</strong> - <code>ask</code> / <code>apk</code> - 앨리스의 정적 개인/공개 키 - <code>aesk</code> / <code>aepk</code> - 앨리스의 임시 개인/공개 키 - <code>bsk</code> / <code>bpk</code> - 밥의 정적 개인/공개 키 - <code>besk</code> / <code>bepk</code> - 밥의 임시 개인/공개 키</p>
<h3 id="ns-메시지-키-파생-함수">NS 메시지 키 파생 함수</h3>
<h3 id="kdf-1-초기-체인-키">KDF 1: 초기 체인 키</h3>
<p>프로토콜 초기화 시 한 번 수행됨(사전에 계산 가능):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Protocol name (40 bytes, ASCII, no null termination)</span>
</span></span><span style="display:flex;"><span>protocol_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Noise_IKelg2+hs2_25519_ChaChaPoly_SHA256&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(protocol_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize chaining key</span>
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># MixHash with empty prologue</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: chainKey and h initialized</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Can be precalculated for all outbound sessions</span>
</span></span></code></pre></div><p><strong>결과:</strong> - <code>chainKey</code> = 이후 모든 KDF(키 유도 함수)에 대한 초기 체이닝 키 - <code>h</code> = 초기 해시 트랜스크립트</p>
<h3 id="kdf-2-bob의-정적-키-혼합">KDF 2: Bob의 정적 키 혼합</h3>
<p>Bob은 이 작업을 한 번만 수행한다(모든 인바운드 세션에 대해 미리 계산할 수 있음):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Bob&#39;s static keys (published in LeaseSet)</span>
</span></span><span style="display:flex;"><span>bsk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>bpk <span style="color:#f92672">=</span> DERIVE_PUBLIC(bsk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix Bob&#39;s public key into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bpk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: h updated with Bob&#39;s identity</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Can be precalculated by Bob for all inbound sessions</span>
</span></span></code></pre></div><h3 id="kdf-3-앨리스의-임시-키-생성">KDF 3: 앨리스의 임시 키 생성</h3>
<p>Alice는 각 NS 메시지마다 새로운 키를 생성합니다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate ephemeral key pair suitable for Elligator2</span>
</span></span><span style="display:flex;"><span>aesk <span style="color:#f92672">=</span> GENERATE_PRIVATE_ELG2()
</span></span><span style="display:flex;"><span>aepk <span style="color:#f92672">=</span> DERIVE_PUBLIC(aesk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ephemeral public key into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> aepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Elligator2 encode for transmission</span>
</span></span><span style="display:flex;"><span>elg2_aepk <span style="color:#f92672">=</span> ENCODE_ELG2(aepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: h updated with Alice&#39;s ephemeral key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send elg2_aepk as first 32 bytes of NS message</span>
</span></span></code></pre></div><h3 id="kdf-4-ns-정적-키-섹션-es-dh-일시적-정적-diffie-hellman">KDF 4: NS 정적 키 섹션 (es DH, 일시적-정적 Diffie-Hellman)</h3>
<p>앨리스의 정적 키를 암호화하기 위한 키를 파생한다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Perform first DH (ephemeral-static)</span>
</span></span><span style="display:flex;"><span>sharedSecret <span style="color:#f92672">=</span> DH(aesk, bpk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Equivalent: sharedSecret = DH(bsk, aepk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive cipher key from shared secret</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD encryption parameters</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> h  <span style="color:#75715e"># Current hash transcript</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt static key section</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> binding_requested:
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> apk  <span style="color:#75715e"># Alice&#39;s static public key (32 bytes)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> bytes(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># All zeros for unbound</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, plaintext, associated_data)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ciphertext = 32 bytes encrypted + 16 bytes MAC = 48 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ciphertext into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> ciphertext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Static key section encrypted, h updated</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext (48 bytes) as next part of NS message</span>
</span></span></code></pre></div><h3 id="kdf-5-ns-페이로드-섹션-ss-dh-바인딩-전용">KDF 5: NS 페이로드 섹션 (ss DH, 바인딩 전용)</h3>
<p>바인딩된 세션의 경우, 페이로드 암호화를 위해 두 번째 DH(Diffie-Hellman 키 교환)를 수행하십시오:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> binding_requested:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice&#39;s static keys</span>
</span></span><span style="display:flex;"><span>    ask <span style="color:#f92672">=</span> GENERATE_PRIVATE()  <span style="color:#75715e"># Alice&#39;s long-term key</span>
</span></span><span style="display:flex;"><span>    apk <span style="color:#f92672">=</span> DERIVE_PUBLIC(ask)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform second DH (static-static)</span>
</span></span><span style="display:flex;"><span>    sharedSecret <span style="color:#f92672">=</span> DH(ask, bpk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Equivalent: sharedSecret = DH(bsk, apk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive cipher key</span>
</span></span><span style="display:flex;"><span>    keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>    k <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    associated_data <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Unbound: reuse keys from static key section</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># chainKey and k unchanged</span>
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># Increment nonce (reusing same key)</span>
</span></span><span style="display:flex;"><span>    associated_data <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt payload</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> build_payload()  <span style="color:#75715e"># DateTime + Garlic Cloves + etc.</span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, payload, associated_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ciphertext into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> ciphertext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Payload encrypted, h contains complete NS transcript</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Save chainKey and h for NSR processing</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext as final part of NS message</span>
</span></span></code></pre></div><p><strong>중요 사항:</strong></p>
<ol>
<li>
<p><strong>Bound vs Unbound</strong>:</p>
<ul>
<li>Bound는 DH(Diffie-Hellman) 연산을 2회 수행함 (es + ss)</li>
<li>Unbound는 DH 연산을 1회 수행함 (es만)</li>
<li>Unbound는 새 키를 도출하는 대신 nonce(논스)를 증가시킴</li>
</ul>
</li>
<li>
<p><strong>키 재사용 안전성</strong>:</p>
<ul>
<li>서로 다른 논스(0 vs 1)는 키/논스 재사용을 방지한다</li>
<li>서로 다른 연관 데이터(h가 다름)는 도메인 분리를 제공한다</li>
</ul>
</li>
<li>
<p><strong>해시 트랜스크립트</strong>:</p>
<ul>
<li><code>h</code>에는 이제 다음이 포함됩니다: protocol_name, 비어 있는 prologue, bpk, aepk, static_key_ciphertext, payload_ciphertext</li>
<li>이 트랜스크립트는 NS message(NS 메시지)의 모든 부분을 하나로 결합합니다</li>
</ul>
</li>
</ol>
<h3 id="nsr-응답-태그-집합-키-파생-함수">NSR 응답 태그 집합 키 파생 함수</h3>
<p>Bob은 NSR 메시지용 태그를 생성합니다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Chain key from NS payload section</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># chainKey = final chainKey from NS KDF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate tagset key</span>
</span></span><span style="display:flex;"><span>tagsetKey <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SessionReplyTags&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize NSR tagset (see DH_INITIALIZE below)</span>
</span></span><span style="display:flex;"><span>tagset_nsr <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, tagsetKey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get tag for this NSR</span>
</span></span><span style="display:flex;"><span>tagsetEntry <span style="color:#f92672">=</span> tagset_nsr<span style="color:#f92672">.</span>GET_NEXT_ENTRY()
</span></span><span style="display:flex;"><span>tag <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_TAG  <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: tag available for NSR message</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send tag as first 8 bytes of NSR</span>
</span></span></code></pre></div><h3 id="nsr-메시지-kdf키-파생-함수">NSR 메시지 KDF(키 파생 함수)</h3>
<h3 id="kdf-6-nsr-임시-키-생성">KDF 6: NSR 임시 키 생성</h3>
<p>Bob은 각 NSR에 대해 새로운 임시 키를 생성한다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Mix tag into hash (I2P extension to Noise)</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> tag)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate ephemeral key pair</span>
</span></span><span style="display:flex;"><span>besk <span style="color:#f92672">=</span> GENERATE_PRIVATE_ELG2()
</span></span><span style="display:flex;"><span>bepk <span style="color:#f92672">=</span> DERIVE_PUBLIC(besk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ephemeral public key into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Elligator2 encode for transmission</span>
</span></span><span style="display:flex;"><span>elg2_bepk <span style="color:#f92672">=</span> ENCODE_ELG2(bepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: h updated with tag and Bob&#39;s ephemeral key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send elg2_bepk as bytes 9-40 of NSR message</span>
</span></span></code></pre></div><h3 id="kdf-7-nsr-키-섹션-ee-및-se-dh">KDF 7: NSR 키 섹션 (ee 및 se DH)</h3>
<p>NSR 키 섹션에 사용할 키를 파생합니다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Perform third DH (ephemeral-ephemeral)</span>
</span></span><span style="display:flex;"><span>sharedSecret_ee <span style="color:#f92672">=</span> DH(aesk, bepk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Equivalent: sharedSecret_ee = DH(besk, aepk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ee into chain</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret_ee, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Perform fourth DH (static-ephemeral)</span>
</span></span><span style="display:flex;"><span>sharedSecret_se <span style="color:#f92672">=</span> DH(ask, bepk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Equivalent: sharedSecret_se = DH(besk, apk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive cipher key from se</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret_se, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD encryption of empty data (key section has no payload)</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, ZEROLEN, associated_data)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ciphertext = 16 bytes (MAC only, no plaintext)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ciphertext into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> ciphertext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Key section encrypted, chainKey contains all 4 DH results</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext (16 bytes MAC) as bytes 41-56 of NSR</span>
</span></span></code></pre></div><p><strong>중요</strong>: 이것으로 Noise IK 핸드셰이크가 완료됩니다. <code>chainKey</code>에는 이제 4가지 DH(디피-헬만) 연산(es, ss, ee, se)에서 나온 모든 값이 반영되어 있습니다.</p>
<h3 id="kdf-8-nsr-페이로드-섹션">KDF 8: NSR 페이로드 섹션</h3>
<p>NSR(특정 프로토콜/메시지 형식의 약어) 페이로드 암호화를 위한 키를 파생합니다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Split chainKey into bidirectional keys</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>k_ab <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]   <span style="color:#75715e"># Alice → Bob key</span>
</span></span><span style="display:flex;"><span>k_ba <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Bob → Alice key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize ES tagsets for both directions</span>
</span></span><span style="display:flex;"><span>tagset_ab <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ab)  <span style="color:#75715e"># Alice → Bob</span>
</span></span><span style="display:flex;"><span>tagset_ba <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ba)  <span style="color:#75715e"># Bob → Alice</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive NSR payload key (Bob → Alice)</span>
</span></span><span style="display:flex;"><span>k_nsr <span style="color:#f92672">=</span> HKDF(k_ba, ZEROLEN, <span style="color:#e6db74">&#34;AttachPayloadKDF&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt NSR payload</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> h  <span style="color:#75715e"># Binds payload to entire NSR</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> build_payload()  <span style="color:#75715e"># Usually application reply</span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_nsr, nonce, payload, associated_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Bidirectional ES sessions established</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tagset_ab and tagset_ba ready for ES messages</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext as bytes 57+ of NSR message</span>
</span></span></code></pre></div><p><strong>중요 사항:</strong></p>
<ol>
<li>
<p><strong>Split Operation(분할 연산)</strong>:</p>
<ul>
<li>각 방향마다 독립적인 키를 생성</li>
<li>Alice→Bob 및 Bob→Alice 간의 키 재사용을 방지</li>
</ul>
</li>
<li>
<p><strong>NSR 페이로드 바인딩</strong>:</p>
<ul>
<li><code>h</code>를 연관 데이터(associated data)로 사용하여 페이로드를 핸드셰이크에 바인딩</li>
<li>별도의 KDF (&ldquo;AttachPayloadKDF&rdquo;)가 도메인 분리를 제공</li>
</ul>
</li>
<li>
<p><strong>ES(메시지) 준비 상태</strong>:</p>
<ul>
<li>NSR(메시지) 이후, 양측은 ES 메시지를 보낼 수 있다</li>
<li>Alice는 ES를 보내기 전에 NSR을 수신해야 한다</li>
<li>Bob은 ES를 보내기 전에 ES를 수신해야 한다</li>
</ul>
</li>
</ol>
<h3 id="es-메시지-키-파생-함수">ES 메시지 키 파생 함수</h3>
<p>ES 메시지는 tagsets(태그셋)에서 미리 생성된 세션 키를 사용합니다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Sender gets next tag and key</span>
</span></span><span style="display:flex;"><span>tagsetEntry <span style="color:#f92672">=</span> outbound_tagset<span style="color:#f92672">.</span>GET_NEXT_ENTRY()
</span></span><span style="display:flex;"><span>tag <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_TAG     <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_KEY       <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>N <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>INDEX             <span style="color:#75715e"># Message number</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Construct nonce (12 bytes)</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>] <span style="color:#f92672">+</span> little_endian_8_bytes(N)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD encryption</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> tag  <span style="color:#75715e"># Tag is associated data</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> build_payload()
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, payload, associated_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send: tag || ciphertext (8 + len(ciphertext) bytes)</span>
</span></span></code></pre></div><p><strong>수신 프로세스:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Extract tag</span>
</span></span><span style="display:flex;"><span>tag <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Look up tag in inbound tagsets</span>
</span></span><span style="display:flex;"><span>tagsetEntry <span style="color:#f92672">=</span> inbound_tagset<span style="color:#f92672">.</span>GET_SESSION_KEY(tag)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> tagsetEntry <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Not an ES message, try NS/NSR decryption</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> try_handshake_decryption(message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_KEY
</span></span><span style="display:flex;"><span>N <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>INDEX
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Construct nonce</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>] <span style="color:#f92672">+</span> little_endian_8_bytes(N)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD decryption</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> tag
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">8</span>:]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> DECRYPT(k, nonce, ciphertext, associated_data)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># MAC verification failed, reject message</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> reject_message()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Process payload blocks</span>
</span></span><span style="display:flex;"><span>process_payload(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remove tag from tagset (one-time use)</span>
</span></span><span style="display:flex;"><span>inbound_tagset<span style="color:#f92672">.</span>remove(tag)
</span></span></code></pre></div><h3 id="dh_initialize-함수">DH_INITIALIZE 함수</h3>
<p>한 방향용 태그 집합을 생성합니다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">DH_INITIALIZE</span>(rootKey, k):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Initializes a tagset with session tag and symmetric key ratchets.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rootKey: Chain key from previous DH ratchet (32 bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k: Key material from split() or DH ratchet (32 bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        tagset: Initialized tagset object
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive next root key and chain key</span>
</span></span><span style="display:flex;"><span>    keydata <span style="color:#f92672">=</span> HKDF(rootKey, k, <span style="color:#e6db74">&#34;KDFDHRatchetStep&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    nextRootKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>    chainKey_tagset <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive separate chain keys for tags and keys</span>
</span></span><span style="display:flex;"><span>    keydata <span style="color:#f92672">=</span> HKDF(chainKey_tagset, ZEROLEN, <span style="color:#e6db74">&#34;TagAndKeyGenKeys&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    sessTag_ck <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]   <span style="color:#75715e"># Session tag chain key</span>
</span></span><span style="display:flex;"><span>    symmKey_ck <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Symmetric key chain key</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create tagset object</span>
</span></span><span style="display:flex;"><span>    tagset <span style="color:#f92672">=</span> Tagset()
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>nextRootKey <span style="color:#f92672">=</span> nextRootKey
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>sessTag_chainKey <span style="color:#f92672">=</span> sessTag_ck
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>symmKey_chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>lastIndex <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tagset
</span></span></code></pre></div><p><strong>사용 맥락:</strong></p>
<ol>
<li><strong>NSR Tagset(태그셋)</strong>: <code>DH_INITIALIZE(chainKey_from_NS, tagsetKey_NSR)</code></li>
<li><strong>ES Tagsets</strong>: <code>DH_INITIALIZE(chainKey_from_NSR, k_ab or k_ba)</code></li>
<li><strong>Ratcheted(래칫) Tagsets</strong>: <code>DH_INITIALIZE(nextRootKey_from_previous, tagsetKey_from_DH)</code></li>
</ol>
<hr>
<h2 id="래칫-메커니즘">래칫 메커니즘</h2>
<p>ECIES(타원곡선 통합 암호 체계)는 서로 동기화된 세 가지 ratchet(래칫) 메커니즘을 사용하여 전방향 기밀성과 효율적인 세션 관리를 제공합니다.</p>
<h3 id="ratchet래칫-개요">Ratchet(래칫) 개요</h3>
<p><strong>세 가지 Ratchet(단계적 키 갱신 메커니즘) 유형:</strong></p>
<ol>
<li><strong>DH 래칫</strong>: 새로운 루트 키를 생성하기 위해 디피-헬만 키 교환을 수행한다</li>
<li><strong>세션 태그 래칫</strong>: 일회용 세션 태그를 결정적으로 파생한다</li>
<li><strong>대칭 키 래칫</strong>: 메시지 암호화를 위한 세션 키를 파생한다</li>
</ol>
<p><strong>관계:</strong></p>
<pre tabindex="0"><code>DH Ratchet (periodic)
    ↓
Creates new tagset
    ↓
Session Tag Ratchet (per message) ← synchronized → Symmetric Key Ratchet (per message)
    ↓                                                      ↓
Session Tags (8 bytes each)                      Session Keys (32 bytes each)
</code></pre><p><strong>주요 속성:</strong></p>
<ul>
<li><strong>송신자</strong>: 필요할 때 태그와 키를 생성(저장 필요 없음)</li>
<li><strong>수신자</strong>: look-ahead window(선행 윈도우)를 위해 태그를 미리 생성(저장 필요)</li>
<li><strong>동기화</strong>: 태그 인덱스가 키 인덱스를 결정 (N_tag = N_key)</li>
<li><strong>전방향 기밀성</strong>: 주기적 DH ratchet(DH 래칫)으로 달성</li>
<li><strong>효율성</strong>: 수신자는 태그를 받을 때까지 키 계산을 지연할 수 있음</li>
</ul>
<h3 id="dh-ratchet디피-헬만-기반의-단계적-키-갱신-기법">DH Ratchet(디피-헬만 기반의 단계적 키 갱신 기법)</h3>
<p>DH ratchet(디피-헬먼 기반 키 래칫 메커니즘)은 주기적으로 새로운 임시 키를 교환하여 전방향 기밀성을 제공합니다.</p>
<h3 id="dh-ratchet디피-헬만-기반-키-래칫-빈도">DH Ratchet(디피-헬만 기반 키 래칫) 빈도</h3>
<p><strong>필수 Ratchet(암호 프로토콜의 단계적 키 갱신 메커니즘) 조건:</strong> - 태그 집합이 소진에 임박함 (태그 65535가 최대치) - 구현별 정책:   - 메시지 수 임계값 (예: 매 4096개 메시지마다)   - 시간 임계값 (예: 매 10분마다)   - 데이터 용량 임계값 (예: 매 100 MB마다)</p>
<p><strong>권장되는 첫 번째 Ratchet(세션 키를 순차적으로 갱신하는 메커니즘)</strong>: 제한에 도달하지 않도록 태그 번호를 4096 전후로</p>
<p><strong>최대값:</strong> - <strong>최대 태그 세트 ID</strong>: 65535 - <strong>최대 키 ID</strong>: 32767 - <strong>태그 세트당 최대 메시지 수</strong>: 65535 - <strong>세션당 이론상 최대 데이터</strong>: ~6.9 TB (64K 태그 세트 × 64K 메시지 × 평균 1730바이트)</p>
<h3 id="dh-ratchet디피-헬만-래칫-태그-및-키-id">DH Ratchet(디피-헬만 래칫) 태그 및 키 ID</h3>
<p><strong>초기 태그 세트</strong> (핸드셰이크 이후): - 태그 세트 ID: 0 - NextKey(다음 키) 블록이 아직 전송되지 않았음 - 키 ID가 할당되지 않음</p>
<p><strong>첫 번째 래칫 이후</strong>: - 태그 세트 ID: 1 = (1 + Alice의 키 ID + Bob의 키 ID) = (1 + 0 + 0) - Alice는 키 ID 0을 사용한 NextKey(다음 키)를 보냄 - Bob은 키 ID 0을 사용한 NextKey로 응답함</p>
<p><strong>후속 태그 세트</strong>: - 태그 세트 ID = 1 + 송신자의 키 ID + 수신자의 키 ID - 예: 태그 세트 5 = (1 + sender_key_2 + receiver_key_2)</p>
<p><strong>태그 세트 진행 표:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Tag Set ID</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Sender Key ID</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Receiver Key ID</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">n/a</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">n/a</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial tag set (post-NSR)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">First ratchet (both generate new keys)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Sender generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">3</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Receiver generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">4</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Sender generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">5</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Receiver generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">...</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">...</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">...</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Pattern repeats</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">65534</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32767 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32766</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Second-to-last tag set</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">65535</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32767</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32767 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Final tag set</td>
    </tr>
  </tbody>
</table>
\* = 이번 ratchet(래칫)에서 새 키가 생성됨
<p><strong>키 ID 규칙:</strong> - ID는 0부터 순차적으로 부여됩니다 - 새 키가 생성될 때에만 ID가 증가합니다 - 최대 키 ID는 32767(15비트)입니다 - 키 ID 32767 이후에는 새 세션이 필요합니다</p>
<h3 id="dh-래칫-메시지-흐름">DH 래칫 메시지 흐름</h3>
<p><strong>역할:</strong> - <strong>태그 송신자</strong>: 아웃바운드 태그 집합을 소유하고, 메시지를 보냄 - <strong>태그 수신자</strong>: 인바운드 태그 집합을 소유하고, 메시지를 받음</p>
<p><strong>패턴:</strong> 태그 발신자는 태그 세트가 거의 소진되었을 때 ratchet(키를 단계적으로 갱신하는 메커니즘)을 개시한다.</p>
<p><strong>메시지 흐름 다이어그램:</strong></p>
<pre tabindex="0"><code>Tag Sender                         Tag Receiver

       ... using tag set #0 ...

(Tag set #0 approaching exhaustion)
(Generate new key #0)

NextKey forward, request reverse, with key #0  --------&gt;
(Repeat until NextKey ACK received)
                                   (Generate new key #0)
                                   (Perform DH: sender_key_0 × receiver_key_0)
                                   (Create inbound tag set #1)

        &lt;---------------           NextKey reverse, with key #0
                                   (Repeat until tag from tag set #1 received)

(Receive NextKey with key #0)
(Perform DH: sender_key_0 × receiver_key_0)
(Create outbound tag set #1)


       ... using tag set #1 ...


(Tag set #1 approaching exhaustion)
(Generate new key #1)

NextKey forward, with key #1        --------&gt;
(Repeat until NextKey ACK received)
                                   (Reuse existing key #0)
                                   (Perform DH: sender_key_1 × receiver_key_0)
                                   (Create inbound tag set #2)

        &lt;--------------            NextKey reverse, id 0 (ACK)
                                   (Repeat until tag from tag set #2 received)

(Receive NextKey with id 0)
(Perform DH: sender_key_1 × receiver_key_0)
(Create outbound tag set #2)


       ... using tag set #2 ...


(Tag set #2 approaching exhaustion)
(Reuse existing key #1)

NextKey forward, request reverse, id 1  --------&gt;
(Repeat until NextKey received)
                                   (Generate new key #1)
                                   (Perform DH: sender_key_1 × receiver_key_1)
                                   (Create inbound tag set #3)

        &lt;--------------            NextKey reverse, with key #1

(Receive NextKey with key #1)
(Perform DH: sender_key_1 × receiver_key_1)
(Create outbound tag set #3)


       ... using tag set #3 ...

       (Pattern repeats: even-numbered tag sets
        use forward key, odd-numbered use reverse key)
</code></pre><p><strong>Ratchet(래칫) 패턴:</strong></p>
<p><strong>짝수 번호 태그 세트 생성</strong> (2, 4, 6, &hellip;): 1. 송신자는 새 키를 생성한다 2. 송신자는 새 키와 함께 NextKey block을 전송한다 3. 수신자는 이전 키 ID와 함께 NextKey block을 전송한다 (ACK, 확인 응답) 4. 양측은 (새 송신자 키 × 이전 수신자 키)로 DH(디피-헬만 키 교환)를 수행한다</p>
<p><strong>홀수 번호 태그 세트 생성</strong> (3, 5, 7, &hellip;): 1. 송신자는 역방향 키를 요청함(요청 플래그가 설정된 NextKey 전송) 2. 수신자는 새 키를 생성 3. 수신자는 새 키가 포함된 NextKey 블록을 전송 4. 양측은 (이전 송신자 키 × 새 수신자 키)로 DH(디피-헬만)를 수행</p>
<h3 id="nextkey다음-키-블록-형식">NextKey(다음 키) 블록 형식</h3>
<p>자세한 NextKey(다음 키) 블록 사양은 Payload Format 섹션을 참조하십시오.</p>
<p><strong>핵심 요소:</strong> - <strong>플래그 바이트</strong>:   - 비트 0: 키 존재(1) 또는 ID만(0)   - 비트 1: 역방향 키(1) 또는 정방향 키(0)   - 비트 2: 역방향 키 요청(1) 또는 요청 없음(0) - <strong>키 ID</strong>: 2바이트, 빅엔디언(0-32767) - <strong>공개 키</strong>: 32바이트 X25519 (비트 0 = 1인 경우)</p>
<p><strong>NextKey 블록 예시:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Sender initiates ratchet with new key (key ID 0, tag set 1)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, pubkey<span style="color:#f92672">=</span>sender_key_0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver replies with new key (key ID 0, tag set 1)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, pubkey<span style="color:#f92672">=</span>receiver_key_0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sender ratchets again with new key (key ID 1, tag set 2)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, pubkey<span style="color:#f92672">=</span>sender_key_1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver ACKs with old key ID (tag set 2)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x02</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sender requests reverse key (tag set 3)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x04</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver sends new reverse key (key ID 1, tag set 3)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, pubkey<span style="color:#f92672">=</span>receiver_key_1)
</span></span></code></pre></div><h3 id="dh-래칫-키-파생-함수">DH 래칫 키 파생 함수</h3>
<p>새 키가 교환될 때:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Tag sender generates or reuses key</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> generating_new:
</span></span><span style="display:flex;"><span>    sender_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    sender_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(sender_sk)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Reuse existing key pair</span>
</span></span><span style="display:flex;"><span>    sender_pk <span style="color:#f92672">=</span> existing_sender_pk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag receiver generates or reuses key</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> generating_new:
</span></span><span style="display:flex;"><span>    receiver_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    receiver_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(receiver_sk)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Reuse existing key pair</span>
</span></span><span style="display:flex;"><span>    receiver_pk <span style="color:#f92672">=</span> existing_receiver_pk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Both parties perform DH</span>
</span></span><span style="display:flex;"><span>sharedSecret <span style="color:#f92672">=</span> DH(sender_sk, receiver_pk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive tagset key</span>
</span></span><span style="display:flex;"><span>tagsetKey <span style="color:#f92672">=</span> HKDF(sharedSecret, ZEROLEN, <span style="color:#e6db74">&#34;XDHRatchetTagSet&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get next root key from previous tagset</span>
</span></span><span style="display:flex;"><span>rootKey <span style="color:#f92672">=</span> previous_tagset<span style="color:#f92672">.</span>nextRootKey
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize new tagset</span>
</span></span><span style="display:flex;"><span>new_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(rootKey, tagsetKey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag sender: outbound tagset</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag receiver: inbound tagset</span>
</span></span></code></pre></div><p><strong>중요한 타이밍:</strong></p>
<p><strong>태그 송신자:</strong> - 새 아웃바운드 태그 세트를 즉시 생성합니다 - 새 태그를 즉시 사용하기 시작합니다 - 기존 아웃바운드 태그 세트를 삭제합니다</p>
<p><strong>태그 수신자:</strong> - 새로운 인바운드 태그 세트를 생성 - 유예 기간(3분) 동안 기존 인바운드 태그 세트를 유지 - 유예 기간 동안 기존 및 새 태그 세트의 태그를 모두 수락 - 유예 기간 후 기존 인바운드 태그 세트를 삭제</p>
<h3 id="dh-래칫-상태-관리">DH 래칫 상태 관리</h3>
<p><strong>송신자 상태:</strong> - 현재 발신 태그 세트 - 태그 세트 ID 및 키 ID - 다음 루트 키(다음 ratchet(단계적 키 갱신 메커니즘)용) - 현재 태그 세트의 메시지 수</p>
<p><strong>수신자 상태:</strong> - 현재 인바운드 태그 세트(유예 기간 동안에는 2개일 수 있음) - 누락 감지를 위한 이전 메시지 번호(PN) - 사전 생성된 태그의 look-ahead window(선행 창) - 다음 루트 키(다음 ratchet(암호 키를 단계적으로 갱신하는 메커니즘)용)</p>
<p><strong>상태 전이 규칙:</strong></p>
<ol>
<li>
<p><strong>첫 번째 Ratchet(암호 키 갱신 메커니즘) 이전</strong>:</p>
<ul>
<li>태그 세트 0 사용(NSR에서)</li>
<li>키 ID가 할당되지 않음</li>
</ul>
</li>
<li>
<p><strong>Ratchet(래칫) 초기화</strong>:</p>
<ul>
<li>새 키 생성(이번 라운드에서 발신자가 생성하는 경우)</li>
<li>ES message에 NextKey block 전송</li>
<li>새 아웃바운드 tag set 생성 전에 NextKey reply 대기</li>
</ul>
</li>
<li>
<p><strong>Ratchet(래칫, 연속적 키 갱신 메커니즘) 요청 수신</strong>:</p>
<ul>
<li>새 키 생성(이번 라운드에서 수신자가 생성자일 경우)</li>
<li>수신한 키로 Diffie-Hellman(DH) 수행</li>
<li>새 인바운드 태그 세트 생성</li>
<li>NextKey(다음 키) 응답 전송</li>
<li>유예 기간 동안 기존 인바운드 태그 세트 유지</li>
</ul>
</li>
<li>
<p><strong>Ratchet(래칫, 단계적 키 갱신) 완료</strong>:</p>
<ul>
<li>NextKey 응답 수신</li>
<li>디피-헬만 키 교환 수행</li>
<li>새 아웃바운드 태그 세트 생성</li>
<li>새 태그 사용 시작</li>
</ul>
</li>
</ol>
<h3 id="세션-태그-래칫">세션 태그 래칫</h3>
<p>session tag ratchet(세션 태그를 위한 암호화 래칫 메커니즘)은 일회용 8바이트 세션 태그를 결정적으로 생성한다.</p>
<h3 id="session-tag-ratchetsession-tag를-전진-갱신하는-암호학적-메커니즘의-목적">Session Tag Ratchet(Session Tag를 전진 갱신하는 암호학적 메커니즘)의 목적</h3>
<ul>
<li>명시적 태그 전송을 대체함 (ElGamal은 32바이트 태그를 전송했음)</li>
<li>수신자가 look-ahead window(선행 윈도우)를 위해 태그를 사전 생성할 수 있게 함</li>
<li>송신자는 요청 시 생성함 (저장 필요 없음)</li>
<li>인덱스를 통해 symmetric key ratchet(대칭키 래칫, 단계적으로 대칭키를 갱신하는 메커니즘)과 동기화됨</li>
</ul>
<h3 id="세션-태그-래칫-공식">세션 태그 래칫 공식</h3>
<p><strong>초기화:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># From DH_INITIALIZE</span>
</span></span><span style="display:flex;"><span>sessTag_ck <span style="color:#f92672">=</span> initial_chain_key  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize session tag ratchet</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(sessTag_ck, ZEROLEN, <span style="color:#e6db74">&#34;STInitialization&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># First chain key</span>
</span></span><span style="display:flex;"><span>SESSTAG_CONSTANT <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]   <span style="color:#75715e"># Constant for all tags in this tagset</span>
</span></span></code></pre></div><p><strong>태그 생성(태그 N에 대해):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate tag N</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(sessTag_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Chain key for next tag</span>
</span></span><span style="display:flex;"><span>tag_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]              <span style="color:#75715e"># Session tag (8 bytes)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Chain continues for each tag</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tag_0, tag_1, tag_2, ..., tag_65535</span>
</span></span></code></pre></div><p><strong>전체 시퀀스:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Tag 0</span>
</span></span><span style="display:flex;"><span>keydata_0 <span style="color:#f92672">=</span> HKDF(sessTag_chainKey, SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>tag_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag 1</span>
</span></span><span style="display:flex;"><span>keydata_1 <span style="color:#f92672">=</span> HKDF(sessTag_chainKey_0, SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>tag_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag N</span>
</span></span><span style="display:flex;"><span>keydata_N <span style="color:#f92672">=</span> HKDF(sessTag_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>tag_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span></code></pre></div><h3 id="session-tag-ratchet세션-태그를-단계적으로-교체하는-메커니즘-송신자-구현">Session Tag Ratchet(세션 태그를 단계적으로 교체하는 메커니즘) 송신자 구현</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundTagset</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, sessTag_ck):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(sessTag_ck, ZEROLEN, <span style="color:#e6db74">&#34;STInitialization&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>constant <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_next_tag</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Increment index</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">65535</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> TagsetExhausted(<span style="color:#e6db74">&#34;Ratchet required&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate tag</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, self<span style="color:#f92672">.</span>constant, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (tag, self<span style="color:#f92672">.</span>index)
</span></span></code></pre></div><p><strong>송신 프로세스:</strong> 1. 각 메시지마다 <code>get_next_tag()</code>를 호출 2. 반환된 태그를 ES 메시지에 사용 3. 잠재적인 ACK(확인 응답) 추적을 위해 인덱스 N을 저장 4. 태그 저장이 필요 없음(필요 시 생성됨)</p>
<h3 id="세션-태그-ratchet키-갱신-메커니즘-수신자-구현">세션 태그 Ratchet(키 갱신 메커니즘) 수신자 구현</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundTagset</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, sessTag_ck, look_ahead<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(sessTag_ck, ZEROLEN, <span style="color:#e6db74">&#34;STInitialization&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>constant <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">=</span> look_ahead
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tags <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Dictionary: tag -&gt; index</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Pre-generate initial tags</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>extend(look_ahead)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extend</span>(self, count):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Generate &#39;count&#39; more tags&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(count):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">65535</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>  <span style="color:#75715e"># Cannot exceed maximum</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Generate tag</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, self<span style="color:#f92672">.</span>constant, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            tag <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Store tag</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>tags[tag] <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>index
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lookup_tag</span>(self, tag):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Look up tag and return index&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> tag <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>tags:
</span></span><span style="display:flex;"><span>            index <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>tags[tag]
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Remove tag (one-time use)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>tags[tag]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> index
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_and_extend</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Extend if tag count is low&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        current_count <span style="color:#f92672">=</span> len(self<span style="color:#f92672">.</span>tags)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> current_count <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Extend to restore window</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>extend(self<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">-</span> current_count)
</span></span></code></pre></div><p><strong>수신 프로세스:</strong> 1. look-ahead window(선행 윈도우)용 태그를 미리 생성한다(예: 태그 32개) 2. 태그를 해시 테이블 또는 사전에 저장한다 3. 메시지가 도착하면 태그를 조회하여 인덱스 N을 얻는다 4. 저장소에서 태그를 제거한다(1회용) 5. 태그 수가 임계값 아래로 떨어지면 윈도우를 확장한다</p>
<h3 id="세션-태그-사전-준비-전략">세션 태그 사전 준비 전략</h3>
<p><strong>목적</strong>: 메모리 사용량과 순서가 어긋난 메시지 처리 간의 균형 조정</p>
<p><strong>권장 룩어헤드 크기:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Tagset Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Initial Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Maximum Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">12</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">12</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Short-lived</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">24</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">160</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial ES tagset</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 1+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">160</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">160</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Ratcheted tagsets</td>
    </tr>
  </tbody>
</table>
**적응형 전방 탐색:**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Dynamic look-ahead based on highest tag received</span>
</span></span><span style="display:flex;"><span>look_ahead <span style="color:#f92672">=</span> min(tsmax, tsmin <span style="color:#f92672">+</span> N <span style="color:#f92672">//</span> <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Example:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tsmin = 24, tsmax = 160</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 0:   look_ahead = min(160, 24 + 0/4) = 24</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 100: look_ahead = min(160, 24 + 100/4) = 49</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 500: look_ahead = min(160, 24 + 500/4) = 149</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 544: look_ahead = min(160, 24 + 544/4) = 160</span>
</span></span></code></pre></div><p><strong>뒤쪽 자르기:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Trim tags far behind highest received</span>
</span></span><span style="display:flex;"><span>trim_behind <span style="color:#f92672">=</span> look_ahead <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If highest received tag is N=100, trim tags below N=50</span>
</span></span></code></pre></div><p><strong>메모리 계산:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Per tag: 8 bytes (tag) + 2 bytes (index) + overhead ≈ 16 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Look-ahead of 160 tags ≈ 2.5 KB per inbound tagset</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># With multiple sessions:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 100 inbound sessions × 2.5 KB = 250 KB total</span>
</span></span></code></pre></div><h3 id="session-tag세션-태그-순서-뒤바뀜-처리">Session Tag(세션 태그) 순서 뒤바뀜 처리</h3>
<p><strong>시나리오</strong>: 메시지가 순서대로 도착하지 않음</p>
<pre tabindex="0"><code>Expected: tag_5, tag_6, tag_7, tag_8
Received: tag_5, tag_7, tag_6, tag_8
</code></pre><p><strong>수신자 동작:</strong></p>
<ol>
<li>
<p>tag_5 수신:</p>
<ul>
<li>조회: 인덱스 5에서 찾음</li>
<li>메시지 처리</li>
<li>tag_5 제거</li>
<li>최대 수신값: 5</li>
</ul>
</li>
<li>
<p>tag_7 수신 (순서 어긋남):</p>
<ul>
<li>조회: 인덱스 7에서 발견</li>
<li>메시지 처리</li>
<li>tag_7 제거</li>
<li>최고 수신 번호: 7</li>
<li>참고: tag_6은 여전히 저장소에 있음 (아직 수신되지 않음)</li>
</ul>
</li>
<li>
<p>tag_6 수신(지연됨):</p>
<ul>
<li>조회: 인덱스 6에서 찾음</li>
<li>메시지 처리</li>
<li>tag_6 제거</li>
<li>최대 수신값: 7 (변경 없음)</li>
</ul>
</li>
<li>
<p>tag_8 수신:</p>
<ul>
<li>조회: 인덱스 8에서 찾음</li>
<li>메시지 처리</li>
<li>tag_8 제거</li>
<li>가장 높은 수신 번호: 8</li>
</ul>
</li>
</ol>
<p><strong>윈도우 관리:</strong> - 수신된 인덱스의 최댓값을 추적 - 누락된 인덱스(갭) 목록 유지 - 최댓값 인덱스를 기준으로 윈도우 확장 - 선택 사항: 타임아웃 후 오래된 갭 만료</p>
<h3 id="대칭-키-래칫">대칭 키 래칫</h3>
<p>symmetric key ratchet(대칭키 래칫)은 session tags(세션 태그)와 동기화된 32바이트 암호화 키를 생성합니다.</p>
<h3 id="symmetric-key-ratchet대칭-키-래칫의-목적">Symmetric Key Ratchet(대칭 키 래칫)의 목적</h3>
<ul>
<li>각 메시지마다 고유한 암호화 키 제공</li>
<li>session tag ratchet(세션 태그 래칫, 단계적 키 갱신 메커니즘)과 동기화됨(같은 인덱스)</li>
<li>송신자는 필요 시 생성 가능</li>
<li>수신자는 태그를 받을 때까지 생성을 지연할 수 있음</li>
</ul>
<h3 id="대칭-키-래칫-공식">대칭 키 래칫 공식</h3>
<p><strong>초기화:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># From DH_INITIALIZE</span>
</span></span><span style="display:flex;"><span>symmKey_ck <span style="color:#f92672">=</span> initial_chain_key  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># No additional initialization needed</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Unlike session tag ratchet, no constant is derived</span>
</span></span></code></pre></div><p><strong>키 생성(키 N용):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate key N</span>
</span></span><span style="display:flex;"><span>SYMMKEY_CONSTANT <span style="color:#f92672">=</span> ZEROLEN  <span style="color:#75715e"># Empty string</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(symmKey_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), SYMMKEY_CONSTANT, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Chain key for next key</span>
</span></span><span style="display:flex;"><span>key_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]              <span style="color:#75715e"># Session key (32 bytes)</span>
</span></span></code></pre></div><p><strong>전체 시퀀스:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Key 0</span>
</span></span><span style="display:flex;"><span>keydata_0 <span style="color:#f92672">=</span> HKDF(symmKey_ck, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>key_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Key 1</span>
</span></span><span style="display:flex;"><span>keydata_1 <span style="color:#f92672">=</span> HKDF(symmKey_chainKey_0, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>key_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Key N</span>
</span></span><span style="display:flex;"><span>keydata_N <span style="color:#f92672">=</span> HKDF(symmKey_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>key_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span></code></pre></div><h3 id="symmetric-key-ratchet대칭키-래칫-송신자-구현">Symmetric Key Ratchet(대칭키 래칫) 송신자 구현</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Generate key for specific index&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Fast-forward to desired index if needed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&lt;</span> index:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">==</span> index:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Should not reach here if called correctly</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Key already generated&#34;</span>)
</span></span></code></pre></div><p><strong>송신자 프로세스:</strong> 1. 다음 태그와 해당 인덱스 N을 가져온다 2. 인덱스 N에 대한 키를 생성한다 3. 키를 사용하여 메시지를 암호화한다 4. 키 저장이 필요하지 않다</p>
<h3 id="대칭-키-래칫-수신자-구현">대칭 키 래칫 수신자 구현</h3>
<p><strong>전략 1: 지연 생성 (권장)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cache <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Optional: cache recently used keys</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Generate key for specific index&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check cache first (optional optimization)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>cache:
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cache[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>cache[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> key
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Fast-forward to desired index</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&lt;</span> index:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">==</span> index:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Index already passed&#34;</span>)
</span></span></code></pre></div><p><strong>지연 생성 프로세스:</strong> 1. 태그가 포함된 ES message(ES 메시지)를 수신 2. 태그를 조회해 인덱스 N을 얻음 3. (아직 생성되지 않았다면) 키 0부터 N까지 생성 4. 키 N으로 메시지를 복호화 5. Chain key(체인 키)는 이제 인덱스 N에 위치함</p>
<p><strong>장점:</strong> - 메모리 사용량 최소화 - 필요할 때에만 키 생성 - 구현이 단순함</p>
<p><strong>단점:</strong> - 최초 사용 시 0부터 N까지 모든 키를 생성해야 함 - 캐싱 없이는 순서가 뒤바뀐 메시지를 처리할 수 없음</p>
<p><strong>전략 2: 태그 윈도우 기반 사전 생성 (대안)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>keys <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Dictionary: index -&gt; key</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extend</span>(self, count):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Pre-generate &#39;count&#39; more keys&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(count):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>keys[self<span style="color:#f92672">.</span>index] <span style="color:#f92672">=</span> key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Retrieve pre-generated key&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>keys:
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>keys[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>keys[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> key
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><p><strong>사전 생성 프로세스:</strong> 1. tag window(태그 윈도우)에 맞춰 키를 미리 생성 (예: 키 32개) 2. 메시지 번호로 인덱싱하여 키를 저장 3. 태그를 수신하면 해당 키를 조회 4. 태그가 사용됨에 따라 윈도우를 확장</p>
<p><strong>장점:</strong> - 순서가 뒤바뀐 메시지도 자연스럽게 처리 - 빠른 키 조회(생성 지연 없음)</p>
<p><strong>단점:</strong> - 메모리 사용량 증가 (키당 32바이트 대 태그당 8바이트) - 키를 태그와 동기화된 상태로 유지해야 함</p>
<p><strong>메모리 비교:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Look-ahead of 160:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags only:  160 × 16 bytes = 2.5 KB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags+Keys:  160 × (16 + 32) bytes = 7.5 KB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For 100 sessions:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags only:  250 KB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags+Keys:  750 KB</span>
</span></span></code></pre></div><h3 id="session-tags세션-태그를-이용한-대칭-래칫-동기화">Session Tags(세션 태그)를 이용한 대칭 래칫 동기화</h3>
<p><strong>중대한 요구 사항</strong>: 세션 태그 인덱스는 대칭 키 인덱스와 반드시 동일해야 한다</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Sender</span>
</span></span><span style="display:flex;"><span>tag, index <span style="color:#f92672">=</span> outbound_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> outbound_keyratchet<span style="color:#f92672">.</span>get_key(index)  <span style="color:#75715e"># Same index</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, payload, tag)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> inbound_tagset<span style="color:#f92672">.</span>lookup_tag(tag)
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> inbound_keyratchet<span style="color:#f92672">.</span>get_key(index)  <span style="color:#75715e"># Same index</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>plaintext <span style="color:#f92672">=</span> DECRYPT(key, nonce, ciphertext, tag)
</span></span></code></pre></div><p><strong>실패 모드:</strong></p>
<p>동기화가 깨지면: - 복호화에 잘못된 키가 사용됨 - MAC(메시지 인증 코드) 검증 실패 - 메시지가 거부됨</p>
<p><strong>예방:</strong> - 태그와 키에 동일한 인덱스를 항상 사용하십시오 - 어느 쪽의 ratchet(암호 키 발전 메커니즘)에서도 인덱스를 건너뛰지 마십시오 - 순서가 어긋난 메시지는 신중하게 처리하십시오</p>
<h3 id="대칭-래칫-논스-구성">대칭 래칫 논스 구성</h3>
<p>Nonce(논스)는 메시지 번호에서 파생됩니다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">construct_nonce</span>(index):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Construct 12-byte nonce for ChaCha20-Poly1305
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        index: Message number (0-65535)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        nonce: 12-byte nonce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># First 4 bytes are always zero</span>
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> bytearray(<span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>    nonce[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00\x00\x00\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Last 8 bytes are little-endian message number</span>
</span></span><span style="display:flex;"><span>    nonce[<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> index<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">8</span>, byteorder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> bytes(nonce)
</span></span></code></pre></div><p><strong>예시:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>:     nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> <span style="color:#ae81ff">0000000000000000</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>:     nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> <span style="color:#ae81ff">0100000000000000</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>:   nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> FF00000000000000
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span>:   nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> <span style="color:#ae81ff">0001000000000000</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">65535</span>: nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> FFFF000000000000
</span></span></code></pre></div><p><strong>중요한 속성:</strong> - nonce(논스)는 tagset(태그 집합) 내 각 메시지마다 고유합니다 - nonce는 절대 반복되지 않습니다(일회용 태그가 이를 보장합니다) - 8바이트 카운터는 2^64개의 메시지를 허용합니다(우리는 2^16만 사용합니다) - nonce 형식은 RFC 7539의 카운터 기반 구성과 일치합니다</p>
<hr>
<h2 id="세션-관리">세션 관리</h2>
<h3 id="세션-컨텍스트">세션 컨텍스트</h3>
<p>모든 인바운드 및 아웃바운드 세션은 특정 컨텍스트에 속해야 합니다:</p>
<ol>
<li><strong>Router 컨텍스트</strong>: router 자체용 세션</li>
<li><strong>Destination 컨텍스트</strong>: 특정 로컬 destination(I2P 목적지) (클라이언트 애플리케이션)을 위한 세션</li>
</ol>
<p><strong>중요 규칙</strong>: 상관관계 공격을 방지하기 위해 세션은 컨텍스트 간에 절대 공유되어서는 안 됩니다.</p>
<p><strong>구현:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SessionKeyManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Context for managing sessions (router or destination)&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, context_id):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>context_id <span style="color:#f92672">=</span> context_id
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions <span style="color:#f92672">=</span> {}   <span style="color:#75715e"># far_end_dest -&gt; [sessions]</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_sessions <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># far_end_dest -&gt; session</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>static_keypair <span style="color:#f92672">=</span> generate_keypair()  <span style="color:#75715e"># Context&#39;s identity</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_outbound_session</span>(self, destination):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get or create outbound session to destination&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> destination <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>outbound_sessions:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>outbound_sessions[destination] <span style="color:#f92672">=</span> create_outbound_session(destination)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>outbound_sessions[destination]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_inbound_session</span>(self, session, destination<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Add inbound session, optionally bound to destination&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> destination:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> destination <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>inbound_sessions:
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>inbound_sessions[destination] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>inbound_sessions[destination]<span style="color:#f92672">.</span>append(session)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Unbound session</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>inbound_sessions[<span style="color:#66d9ef">None</span>]<span style="color:#f92672">.</span>append(session)
</span></span></code></pre></div><p><strong>Java I2P 구현:</strong></p>
<p>Java I2P에서, <code>SessionKeyManager</code> 클래스는 다음 기능을 제공합니다: - router마다 하나의 <code>SessionKeyManager</code> - 로컬 destination(목적지)마다 하나의 <code>SessionKeyManager</code> - 각 컨텍스트 내에서 ECIES(타원 곡선 기반 공개키 암호 방식)와 ElGamal(공개키 암호 체계) 세션을 분리하여 관리</p>
<h3 id="세션-바인딩">세션 바인딩</h3>
<p><strong>Binding</strong>(바인딩)은 세션을 특정 원격단 목적지와 연관합니다.</p>
<h3 id="바인딩된-세션">바인딩된 세션</h3>
<p><strong>특징:</strong> - NS 메시지에 송신자의 정적 키 포함 - 수신자는 송신자의 목적지를 식별할 수 있음 - 양방향 통신을 가능하게 함 - 목적지당 단일 발신 세션 - 여러 수신 세션이 있을 수 있음(전환 중)</p>
<p><strong>사용 사례:</strong> - 스트리밍 연결(TCP 유사) - 회신 가능한 데이터그램 - 요청/응답이 필요한 모든 프로토콜</p>
<p><strong>바인딩 프로세스:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Alice creates bound outbound session</span>
</span></span><span style="display:flex;"><span>outbound_session <span style="color:#f92672">=</span> OutboundSession(
</span></span><span style="display:flex;"><span>    destination<span style="color:#f92672">=</span>bob_destination,
</span></span><span style="display:flex;"><span>    static_key<span style="color:#f92672">=</span>alice_static_key,
</span></span><span style="display:flex;"><span>    bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Alice sends NS with static key</span>
</span></span><span style="display:flex;"><span>ns_message <span style="color:#f92672">=</span> build_ns_message(
</span></span><span style="display:flex;"><span>    ephemeral_key<span style="color:#f92672">=</span>alice_ephemeral_key,
</span></span><span style="display:flex;"><span>    static_key<span style="color:#f92672">=</span>alice_static_key,  <span style="color:#75715e"># Included for binding</span>
</span></span><span style="display:flex;"><span>    payload<span style="color:#f92672">=</span>data
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob receives NS</span>
</span></span><span style="display:flex;"><span>bob_receives_ns(ns_message)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob extracts Alice&#39;s static key</span>
</span></span><span style="display:flex;"><span>alice_static_key <span style="color:#f92672">=</span> decrypt_static_key_section(ns_message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob looks up Alice&#39;s destination (from bundled LeaseSet)</span>
</span></span><span style="display:flex;"><span>alice_destination <span style="color:#f92672">=</span> lookup_destination_by_static_key(alice_static_key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob creates bound inbound session</span>
</span></span><span style="display:flex;"><span>inbound_session <span style="color:#f92672">=</span> InboundSession(
</span></span><span style="display:flex;"><span>    destination<span style="color:#f92672">=</span>alice_destination,
</span></span><span style="display:flex;"><span>    bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob pairs with outbound session</span>
</span></span><span style="display:flex;"><span>outbound_session <span style="color:#f92672">=</span> OutboundSession(
</span></span><span style="display:flex;"><span>    destination<span style="color:#f92672">=</span>alice_destination,
</span></span><span style="display:flex;"><span>    bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>이점:</strong> 1. <strong>Ephemeral-Ephemeral DH</strong>(일시적-일시적 디피-헬먼 키 교환): 응답은 ee DH를 사용함(완전한 순방향 기밀성) 2. <strong>세션 연속성</strong>: Ratchets(래칫 기반 키 갱신 메커니즘)가 동일한 목적지에 대한 바인딩을 유지 3. <strong>보안</strong>: 세션 하이재킹을 방지(정적 키로 인증됨) 4. <strong>효율성</strong>: 목적지당 단일 세션(중복 없음)</p>
<h3 id="바인딩되지-않은-세션">바인딩되지 않은 세션</h3>
<p><strong>특징:</strong> - NS 메시지에 고정 키가 없음(플래그 섹션은 모두 0) - 수신자는 발신자를 식별할 수 없음 - 단방향 통신만 가능 - 동일한 destination(목적지)에 여러 세션 허용</p>
<p><strong>사용 사례:</strong> - 원시 데이터그램 (fire-and-forget(보낸 뒤 확인하지 않음)) - 익명 게시 - 방송형 메시징</p>
<p><strong>특성:</strong> - 더 높은 익명성 (발신자 식별 없음) - 더 높은 효율 (핸드셰이크에서 1 DH 대 2 DH) - 응답 불가 (수신자가 어디로 응답해야 할지 모름) - session ratcheting(세션 키를 점진적으로 갱신하는 메커니즘) 없음 (일회성 또는 제한적 사용)</p>
<h3 id="세션-페어링">세션 페어링</h3>
<p><strong>Pairing(페어링)</strong> 은 양방향 통신을 위해 인바운드 세션과 아웃바운드 세션을 연결합니다.</p>
<h3 id="페어링된-세션-생성">페어링된 세션 생성</h3>
<p><strong>Alice의 관점 (개시자):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Create outbound session to Bob</span>
</span></span><span style="display:flex;"><span>outbound_session <span style="color:#f92672">=</span> create_outbound_session(bob_destination)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create paired inbound session</span>
</span></span><span style="display:flex;"><span>inbound_session <span style="color:#f92672">=</span> create_inbound_session(
</span></span><span style="display:flex;"><span>    paired_with<span style="color:#f92672">=</span>outbound_session,
</span></span><span style="display:flex;"><span>    bound_to<span style="color:#f92672">=</span>bob_destination
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Link them</span>
</span></span><span style="display:flex;"><span>outbound_session<span style="color:#f92672">.</span>paired_inbound <span style="color:#f92672">=</span> inbound_session
</span></span><span style="display:flex;"><span>inbound_session<span style="color:#f92672">.</span>paired_outbound <span style="color:#f92672">=</span> outbound_session
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send NS message</span>
</span></span><span style="display:flex;"><span>send_ns_message(outbound_session, payload)
</span></span></code></pre></div><p><strong>Bob의 관점(응답자):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Receive NS message</span>
</span></span><span style="display:flex;"><span>ns_message <span style="color:#f92672">=</span> receive_ns_message()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create inbound session</span>
</span></span><span style="display:flex;"><span>inbound_session <span style="color:#f92672">=</span> create_inbound_session_from_ns(ns_message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If NS contains static key (bound):</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ns_message<span style="color:#f92672">.</span>has_static_key():
</span></span><span style="display:flex;"><span>    alice_destination <span style="color:#f92672">=</span> extract_destination(ns_message)
</span></span><span style="display:flex;"><span>    inbound_session<span style="color:#f92672">.</span>bind_to(alice_destination)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create paired outbound session</span>
</span></span><span style="display:flex;"><span>    outbound_session <span style="color:#f92672">=</span> create_outbound_session(alice_destination)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Link them</span>
</span></span><span style="display:flex;"><span>    outbound_session<span style="color:#f92672">.</span>paired_inbound <span style="color:#f92672">=</span> inbound_session
</span></span><span style="display:flex;"><span>    inbound_session<span style="color:#f92672">.</span>paired_outbound <span style="color:#f92672">=</span> outbound_session
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send NSR</span>
</span></span><span style="display:flex;"><span>send_nsr_message(inbound_session, outbound_session, payload)
</span></span></code></pre></div><h3 id="세션-페어링의-이점">세션 페어링의 이점</h3>
<ol>
<li><strong>인밴드 ACK</strong>: 별도의 clove(garlic encryption에서 개별 메시지 단위) 없이 메시지를 수신 확인할 수 있음</li>
<li><strong>효율적인 Ratcheting(세션 키를 단계적으로 갱신하는 래칫 기법)</strong>: 양 방향이 함께 래칫을 진행함</li>
<li><strong>흐름 제어</strong>: 쌍으로 연결된 세션 전반에 걸쳐 back-pressure(소비 속도에 맞춰 전송을 억제하는 메커니즘)를 구현할 수 있음</li>
<li><strong>상태 일관성</strong>: 동기화된 상태를 더 쉽게 유지할 수 있음</li>
</ol>
<h3 id="세션-페어링-규칙">세션 페어링 규칙</h3>
<ul>
<li>아웃바운드 세션은 페어링되지 않았을 수 있음 (바인딩되지 않은 NS)</li>
<li>바인딩된 NS의 인바운드 세션은 페어링되어야 함</li>
<li>페어링은 세션 생성 시에 이루어지며, 그 이후에는 이루어지지 않음</li>
<li>페어링된 세션은 동일한 목적지 바인딩을 가짐</li>
<li>래칫은 독립적으로 발생하지만 조율됨</li>
</ul>
<h3 id="세션-수명주기">세션 수명주기</h3>
<h3 id="세션-수명-주기-생성-단계">세션 수명 주기: 생성 단계</h3>
<p><strong>아웃바운드 세션 생성 (Alice):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_outbound_session</span>(destination, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> OutboundSession()
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> destination
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> bound
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>NEW
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate keys for NS message</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> bound:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>static_key <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Will be populated after NSR received</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> session
</span></span></code></pre></div><p><strong>인바운드 세션 생성 (Bob):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_inbound_session_from_ns</span>(ns_message):
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> InboundSession()
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract from NS</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>remote_ephemeral_key <span style="color:#f92672">=</span> ns_message<span style="color:#f92672">.</span>ephemeral_key
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>remote_static_key <span style="color:#f92672">=</span> ns_message<span style="color:#f92672">.</span>static_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>remote_static_key:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> lookup_destination(session<span style="color:#f92672">.</span>remote_static_key)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate keys for NSR</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create tagsets from KDF</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> create_tagset_from_nsr()
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> create_tagset_from_nsr()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> session
</span></span></code></pre></div><h3 id="세션-수명-주기-활성-단계">세션 수명 주기: 활성 단계</h3>
<p><strong>상태 전이:</strong></p>
<pre tabindex="0"><code>NEW (outbound only)
  ↓
  NS sent
  ↓
PENDING_REPLY (outbound only)
  ↓
  NSR received
  ↓
ESTABLISHED
  ↓
  ES messages exchanged
  ↓
ESTABLISHED (ongoing)
  ↓
  (optional) RATCHETING
  ↓
ESTABLISHED
</code></pre><p><strong>활성 세션 유지 관리:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">maintain_active_session</span>(session):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Update last activity time</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for ratchet needed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>needs_ratchet():
</span></span><span style="display:flex;"><span>        initiate_ratchet(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for incoming ratchet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> received_nextkey_block():
</span></span><span style="display:flex;"><span>        process_ratchet(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Trim old tags from inbound tagset</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>expire_old_tags()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check session health</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time() <span style="color:#f92672">&gt;</span> SESSION_TIMEOUT:
</span></span><span style="display:flex;"><span>        mark_session_idle(session)
</span></span></code></pre></div><h3 id="세션-수명주기-만료-단계">세션 수명주기: 만료 단계</h3>
<p><strong>세션 타임아웃 값:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Session Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Sender Timeout</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Receiver Timeout</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Short-lived</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">8 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">10 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 1+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">8 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">10 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Ratcheted</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Old tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">After ratchet</td>
    </tr>
  </tbody>
</table>
**만료 로직:**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_session_expiration</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> active_sessions:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Outbound session expiration (sender)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>is_outbound():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:  <span style="color:#75715e"># 8 minutes</span>
</span></span><span style="display:flex;"><span>                expire_outbound_session(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Inbound session expiration (receiver)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:  <span style="color:#75715e"># 10 minutes</span>
</span></span><span style="display:flex;"><span>                expire_inbound_session(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Old tagsets (after ratchet)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tagset <span style="color:#f92672">in</span> old_tagsets:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> tagset<span style="color:#f92672">.</span>age() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:  <span style="color:#75715e"># 3 minutes</span>
</span></span><span style="display:flex;"><span>            delete_tagset(tagset)
</span></span></code></pre></div><p><strong>중요 규칙</strong>: 동기화가 어긋나는 것을 방지하기 위해 아웃바운드 세션은 인바운드 세션보다 반드시 먼저 만료되어야 합니다.</p>
<p><strong>정상 종료:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">terminate_session</span>(session, reason<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send Termination block (if implemented)</span>
</span></span><span style="display:flex;"><span>    send_termination_block(session, reason)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Mark session for deletion</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>TERMINATED
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Keep session briefly for final messages</span>
</span></span><span style="display:flex;"><span>    schedule_deletion(session, delay<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>)  <span style="color:#75715e"># 30 seconds</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Notify paired session</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>paired_session:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>paired_session<span style="color:#f92672">.</span>mark_remote_terminated()
</span></span></code></pre></div><h3 id="복수의-ns-메시지">복수의 NS 메시지</h3>
<p><strong>시나리오</strong>: Alice의 NS 메시지가 손실되었거나 NSR 응답이 손실된 경우.</p>
<p><strong>Alice의 동작:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_messages_sent <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_ns_attempts <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_ns_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate new ephemeral key for each NS</span>
</span></span><span style="display:flex;"><span>        ephemeral_key <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        ns_message <span style="color:#f92672">=</span> build_ns_message(
</span></span><span style="display:flex;"><span>            ephemeral_key<span style="color:#f92672">=</span>ephemeral_key,
</span></span><span style="display:flex;"><span>            static_key<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>static_key,
</span></span><span style="display:flex;"><span>            payload<span style="color:#f92672">=</span>payload
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Store state for this NS</span>
</span></span><span style="display:flex;"><span>        ns_state <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;ephemeral_key&#39;</span>: ephemeral_key,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;chainkey&#39;</span>: compute_chainkey(ns_message),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;hash&#39;</span>: compute_hash(ns_message),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;tagset&#39;</span>: derive_nsr_tagset(ns_message),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;sent_time&#39;</span>: now()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_messages_sent<span style="color:#f92672">.</span>append(ns_state)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send message</span>
</span></span><span style="display:flex;"><span>        send_message(ns_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Set timer for retry</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>ns_timer:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> set_timer(<span style="color:#ae81ff">1.0</span>, self<span style="color:#f92672">.</span>on_ns_timeout)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_ns_timeout</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(self<span style="color:#f92672">.</span>ns_messages_sent) <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_ns_attempts:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Give up</span>
</span></span><span style="display:flex;"><span>            fail_session(<span style="color:#e6db74">&#34;No NSR received after </span><span style="color:#e6db74">{self.max_ns_attempts}</span><span style="color:#e6db74"> attempts&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Retry with new NS message</span>
</span></span><span style="display:flex;"><span>        send_ns_message(self<span style="color:#f92672">.</span>payload)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_nsr_received</span>(self, nsr_message):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Cancel timer</span>
</span></span><span style="display:flex;"><span>        cancel_timer(self<span style="color:#f92672">.</span>ns_timer)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Find which NS this NSR responds to</span>
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> nsr_message<span style="color:#f92672">.</span>tag
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> ns_state <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>ns_messages_sent:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tag <span style="color:#f92672">in</span> ns_state[<span style="color:#e6db74">&#39;tagset&#39;</span>]:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># This NSR corresponds to this NS</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>active_ns_state <span style="color:#f92672">=</span> ns_state
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process NSR and complete handshake</span>
</span></span><span style="display:flex;"><span>        complete_handshake(nsr_message, self<span style="color:#f92672">.</span>active_ns_state)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Discard other NS states</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_messages_sent <span style="color:#f92672">=</span> []
</span></span></code></pre></div><p><strong>중요한 속성:</strong></p>
<ol>
<li><strong>고유한 임시 키</strong>: 각 NS(핸드셰이크 시작 메시지)는 서로 다른 임시 키를 사용함</li>
<li><strong>독립적인 핸드셰이크</strong>: 각 NS는 별도의 핸드셰이크 상태를 생성함</li>
<li><strong>NSR 연관</strong>: NSR(해당 NS에 대한 응답 메시지) 태그는 어떤 NS에 대한 응답인지 식별함</li>
<li><strong>상태 정리</strong>: NSR이 성공하면 사용되지 않은 NS 상태는 폐기됨</li>
</ol>
<p><strong>공격 방지:</strong></p>
<p>리소스 고갈을 방지하기 위해:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Limit NS sending rate</span>
</span></span><span style="display:flex;"><span>max_ns_rate <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> per <span style="color:#ae81ff">10</span> seconds per destination
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Limit total NS attempts</span>
</span></span><span style="display:flex;"><span>max_ns_attempts <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Limit total pending NS states</span>
</span></span><span style="display:flex;"><span>max_pending_ns <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> per context
</span></span></code></pre></div><h3 id="여러-nsrntcp2의-세션-요청-메시지-메시지">여러 NSR(NTCP2의 세션 요청 메시지) 메시지</h3>
<p><strong>시나리오</strong>: Bob이 여러 개의 NSR(응답 메시지)을 전송한다(예: 응답 데이터가 여러 메시지로 분할된 경우).</p>
<p><strong>Bob의 동작:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_nsr_replies</span>(self, payload_chunks):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># One NS received, multiple NSRs to send</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> chunk <span style="color:#f92672">in</span> payload_chunks:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Generate new ephemeral key for each NSR</span>
</span></span><span style="display:flex;"><span>            ephemeral_key <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Get next tag from NSR tagset</span>
</span></span><span style="display:flex;"><span>            tag <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>nsr_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            nsr_message <span style="color:#f92672">=</span> build_nsr_message(
</span></span><span style="display:flex;"><span>                tag<span style="color:#f92672">=</span>tag,
</span></span><span style="display:flex;"><span>                ephemeral_key<span style="color:#f92672">=</span>ephemeral_key,
</span></span><span style="display:flex;"><span>                payload<span style="color:#f92672">=</span>chunk
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            send_message(nsr_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Wait for ES message from Alice</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>AWAITING_ES
</span></span></code></pre></div><p><strong>앨리스의 동작:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_nsr_received</span>(self, nsr_message):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>PENDING_REPLY:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># First NSR received</span>
</span></span><span style="display:flex;"><span>            complete_handshake(nsr_message)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Create ES sessions</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>es_outbound_tagset <span style="color:#f92672">=</span> derive_es_outbound_tagset()
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>es_inbound_tagset <span style="color:#f92672">=</span> derive_es_inbound_tagset()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Send ES message (ACK)</span>
</span></span><span style="display:flex;"><span>            send_es_message(empty_payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Additional NSR received</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Decrypt and process payload</span>
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> decrypt_nsr_payload(nsr_message)
</span></span><span style="display:flex;"><span>            process_payload(payload)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># These NSRs are from other NS attempts, ignore handshake</span>
</span></span></code></pre></div><p><strong>Bob의 정리:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_es_received</span>(self, es_message):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># First ES received from Alice</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># This confirms which NSR Alice used</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Clean up other handshake states</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> other_ns_state <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>pending_ns_states:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> other_ns_state <span style="color:#f92672">!=</span> self<span style="color:#f92672">.</span>active_ns_state:
</span></span><span style="display:flex;"><span>                delete_ns_state(other_ns_state)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Delete unused NSR tagsets</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> tagset <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>nsr_tagsets:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tagset <span style="color:#f92672">!=</span> self<span style="color:#f92672">.</span>active_nsr_tagset:
</span></span><span style="display:flex;"><span>                delete_tagset(tagset)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span></code></pre></div><p><strong>중요한 속성:</strong></p>
<ol>
<li><strong>여러 개의 NSR 허용</strong>: Bob은 NS당 여러 개의 NSR을 보낼 수 있다</li>
<li><strong>서로 다른 임시 키</strong>: 각 NSR은 고유한 임시 키를 사용해야 한다</li>
<li><strong>동일한 NSR Tagset</strong>: 하나의 NS에 대한 모든 NSR은 동일한 tagset(태그 집합)을 사용한다</li>
<li><strong>먼저 도착한 ES가 승리</strong>: Alice의 첫 ES가 어떤 NSR이 성공했는지 결정한다</li>
<li><strong>ES 이후 정리</strong>: Bob은 ES를 받은 후 사용되지 않은 상태를 폐기한다</li>
</ol>
<h3 id="세션-상태-머신">세션 상태 머신</h3>
<p><strong>전체 상태 다이어그램:</strong></p>
<pre tabindex="0"><code>                    Outbound Session                    Inbound Session

                         NEW
                          |
                     send NS
                          |
                   PENDING_REPLY -------------------- receive NS ---&gt; ESTABLISHED
                          |                                                |
                   receive NSR                                        send NSR
                          |                                                |
                    ESTABLISHED &lt;---------- receive ES ------------- AWAITING_ES
                          |                     |                          |
                    ┌─────┴─────┐               |                    receive ES
                    |           |               |                          |
              send ES      receive ES           |                    ESTABLISHED
                    |           |               |                          |
                    └─────┬─────┘               |                ┌─────────┴─────────┐
                          |                     |                |                   |
                          |                     |          send ES              receive ES
                          |                     |                |                   |
                          |                     |                └─────────┬─────────┘
                          |                     |                          |
                          └─────────────────────┴──────────────────────────┘
                                              ACTIVE
                                                |
                                         idle timeout
                                                |
                                             EXPIRED
</code></pre><p><strong>상태 설명:</strong></p>
<ul>
<li><strong>NEW</strong>: 아웃바운드 세션이 생성되었으며, 아직 NS를 보내지 않음</li>
<li><strong>PENDING_REPLY</strong>: NS를 전송했으며, NSR을 대기 중</li>
<li><strong>AWAITING_ES</strong>: NSR을 전송했으며, Alice로부터 첫 번째 ES를 대기 중</li>
<li><strong>ESTABLISHED</strong>: 핸드셰이크가 완료되어 ES를 송수신할 수 있음</li>
<li><strong>ACTIVE</strong>: ES 메시지를 활발히 교환 중</li>
<li><strong>RATCHETING</strong>: DH ratchet(디피-헬만 기반 키 갱신 래칫) 진행 중 (ACTIVE의 하위 상태)</li>
<li><strong>EXPIRED</strong>: 세션이 타임아웃되어 삭제 대기 중</li>
<li><strong>TERMINATED</strong>: 세션이 명시적으로 종료됨</li>
</ul>
<hr>
<h2 id="페이로드-형식">페이로드 형식</h2>
<p>모든 ECIES(타원곡선 통합 암호화 방식) 메시지(NS, NSR, ES)의 페이로드 섹션은 NTCP2와 유사한 블록 기반 형식을 사용합니다.</p>
<h3 id="블록-구조">블록 구조</h3>
<p><strong>일반 형식:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|blk |  size   |       data             |
+----+----+----+                        +
|                                       |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
|blk |  size   |       data             |
+----+----+----+                        +
|                                       |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>필드:</strong></p>
<ul>
<li><code>blk</code>: 1바이트 - 블록 유형 번호</li>
<li><code>size</code>: 2바이트 - 빅엔디언 형태의 데이터 필드 크기 (0-65516)</li>
<li><code>data</code>: 가변 길이 - 블록별 데이터</li>
</ul>
<p><strong>제약 사항:</strong></p>
<ul>
<li>최대 ChaChaPoly(ChaCha20-Poly1305 조합) 프레임: 65535 바이트</li>
<li>Poly1305 MAC(메시지 인증 코드): 16 바이트</li>
<li>블록 총합의 최대 크기: 65519 바이트 (65535 - 16)</li>
<li>단일 블록의 최대 크기: 65519 바이트 (3바이트 헤더 포함)</li>
<li>단일 블록 데이터의 최대 크기: 65516 바이트</li>
</ul>
<h3 id="블록-유형">블록 유형</h3>
<p><strong>정의된 블록 유형:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Name</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Status</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Usage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DateTime</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">7 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Required in NS</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1-3</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future use</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Termination</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">9+ bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Unimplemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session termination</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">5</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Options</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">21+ bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Unimplemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session options</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">6</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">MessageNumbers</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">5 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Unimplemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">PN value</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">7</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NextKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">3 or 35 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DH ratchet</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">8</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ACK</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">4+ bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Message acknowledgment</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">9</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ACK Request</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">3 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Request ACK</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">10</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future use</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">11</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Garlic Clove</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Variable</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Application data</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">12-223</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future use</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">224-253</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Experimental</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Variable</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Testing features</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">254</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Padding</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Variable</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Traffic shaping</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">255</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future extension</td>
    </tr>
  </tbody>
</table>
**알 수 없는 블록 처리:**
<p>구현체는 알 수 없는 타입 번호의 블록을 반드시 무시하고 패딩으로 취급해야 한다. 이는 전방 호환성을 보장한다.</p>
<h3 id="블록-순서-규칙">블록 순서 규칙</h3>
<h3 id="ns-메시지-순서">NS 메시지 순서</h3>
<p><strong>필수:</strong> - DateTime 블록은 반드시 맨 앞에 와야 합니다</p>
<p><strong>허용됨:</strong> - Garlic Clove (garlic 메시지를 구성하는 단위) (유형 11) - 옵션 (유형 5) - 구현된 경우 - 패딩 (유형 254)</p>
<p><strong>금지:</strong> - NextKey, ACK, ACK Request, Termination, MessageNumbers</p>
<p><strong>유효한 NS 페이로드 예시:</strong></p>
<pre tabindex="0"><code>DateTime (0) | Garlic Clove (11) | Garlic Clove (11) | Padding (254)
</code></pre><h3 id="nsr-메시지-순서">NSR 메시지 순서</h3>
<p><strong>필수:</strong> - 없음 (페이로드는 비어 있을 수 있음)</p>
<p><strong>허용:</strong> - Garlic Clove(garlic 메시지 내부의 개별 메시지 단위) (유형 11) - 옵션 (유형 5) - 구현된 경우 - 패딩 (유형 254)</p>
<p><strong>금지:</strong> - DateTime, NextKey, ACK, ACK Request, Termination, MessageNumbers</p>
<p><strong>유효한 NSR 페이로드 예시:</strong></p>
<pre tabindex="0"><code>Garlic Clove (11) | Garlic Clove (11) | Padding (254)
</code></pre><p>또는</p>
<pre tabindex="0"><code>(empty - ACK only)
</code></pre><h3 id="es-메시지-순서">ES 메시지 순서</h3>
<p><strong>필수:</strong> - 없음 (페이로드가 비어 있을 수 있음)</p>
<p><strong>허용됨(순서는 무관):</strong> - Garlic Clove (type 11) - NextKey (type 7) - ACK (type 8) - ACK Request (type 9) - Termination (type 4) - 구현된 경우 - MessageNumbers (type 6) - 구현된 경우 - Options (type 5) - 구현된 경우 - Padding (type 254)</p>
<p><strong>특별 규칙:</strong> - Termination(종료) 블록은 반드시 마지막 블록이어야 함(단, Padding(패딩)이 있을 경우 Padding이 마지막) - Padding 블록은 반드시 마지막 블록이어야 함 - Garlic Cloves(Garlic 메시지의 하위 메시지) 다수 허용 - NextKey(다음 키) 블록은 최대 2개까지 허용(순방향 및 역방향) - Padding 블록 다수는 허용되지 않음</p>
<p><strong>유효한 ES 페이로드 예시:</strong></p>
<pre tabindex="0"><code>Garlic Clove (11) | ACK (8) | Padding (254)
</code></pre><pre tabindex="0"><code>NextKey (7) | Garlic Clove (11) | Garlic Clove (11)
</code></pre><pre tabindex="0"><code>NextKey (7) forward | NextKey (7) reverse | Garlic Clove (11)
</code></pre><pre tabindex="0"><code>ACK Request (9) | Garlic Clove (11) | Termination (4) | Padding (254)
</code></pre><h3 id="datetime-블록-유형-0">DateTime 블록 (유형 0)</h3>
<p><strong>목적</strong>: replay(재전송 공격) 방지 및 clock skew(시계 오차) 검증을 위한 타임스탬프</p>
<p><strong>크기</strong>: 7바이트 (3바이트 헤더 + 4바이트 데이터)</p>
<p><strong>형식:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+
| 0  |    4    |     timestamp     |
+----+----+----+----+----+----+----+
</code></pre><p><strong>필드:</strong></p>
<ul>
<li><code>blk</code>: 0</li>
<li><code>size</code>: 4 (big-endian(빅엔디언))</li>
<li><code>timestamp</code>: 4바이트 - 초 단위의 유닉스 타임스탬프(부호 없는, big-endian)</li>
</ul>
<p><strong>타임스탬프 형식:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>timestamp <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())  <span style="color:#75715e"># Seconds since 1970-01-01 00:00:00 UTC</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wraps around in year 2106 (4-byte unsigned maximum)</span>
</span></span></code></pre></div><p><strong>유효성 검사 규칙:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>MAX_CLOCK_SKEW_PAST <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>      <span style="color:#75715e"># 5 minutes</span>
</span></span><span style="display:flex;"><span>MAX_CLOCK_SKEW_FUTURE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>    <span style="color:#75715e"># 2 minutes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_datetime</span>(timestamp):
</span></span><span style="display:flex;"><span>    now <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span>    age <span style="color:#f92672">=</span> now <span style="color:#f92672">-</span> timestamp
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span>MAX_CLOCK_SKEW_FUTURE:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Too far in future</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&gt;</span> MAX_CLOCK_SKEW_PAST:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Too old</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><p><strong>재전송 공격 방지:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReplayFilter</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, duration<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>duration <span style="color:#f92672">=</span> duration  <span style="color:#75715e"># 5 minutes</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>seen_messages <span style="color:#f92672">=</span> BloomFilter(size<span style="color:#f92672">=</span><span style="color:#ae81ff">100000</span>, false_positive_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cleanup_timer <span style="color:#f92672">=</span> RepeatTimer(<span style="color:#ae81ff">60</span>, self<span style="color:#f92672">.</span>cleanup)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_replay</span>(self, ephemeral_key, timestamp):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check timestamp validity</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> validate_datetime(timestamp):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if ephemeral key seen recently</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ephemeral_key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>seen_messages:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Replay attack</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add to seen messages</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>seen_messages<span style="color:#f92672">.</span>add(ephemeral_key)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cleanup</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire old entries (Bloom filter automatically ages out)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p><strong>구현 참고 사항:</strong></p>
<ol>
<li><strong>NS Messages</strong>(NS 메시지): DateTime은 반드시 첫 번째 블록이어야 함</li>
<li><strong>NSR/ES Messages</strong>(NSR/ES 메시지): DateTime은 일반적으로 포함되지 않음</li>
<li><strong>Replay Window</strong>(리플레이 윈도우): 최소 권장값은 5분</li>
<li><strong>Bloom Filter</strong>(블룸 필터): 효율적인 리플레이 탐지를 위해 권장됨</li>
<li><strong>Clock Skew</strong>(시계 오차): 과거 5분, 미래 2분 허용</li>
</ol>
<h3 id="garlic-clove-block-garlic-encryption에서-개별-클로브를-담는-블록-유형-11">Garlic Clove Block (garlic encryption에서 개별 클로브를 담는 블록) (유형 11)</h3>
<p><strong>목적</strong>: 전달을 위해 I2NP 메시지를 캡슐화합니다</p>
<p><strong>형식:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 11 |  size   |                        |
+----+----+----+                        +
|      Delivery Instructions            |
~                                       ~
|                                       |
+----+----+----+----+----+----+----+----+
|type|  Message_ID       | Expiration  |
+----+----+----+----+----+----+----+----+
     |      I2NP Message body           |
+----+                                  +
~                                       ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>필드:</strong></p>
<ul>
<li><code>blk</code>: 11</li>
<li><code>size</code>: clove(garlic encryption에서의 개별 메시지 단위)의 총 크기(가변)</li>
<li><code>Delivery Instructions</code>: I2NP 사양에 명시된 대로</li>
<li><code>type</code>: I2NP 메시지 유형(1바이트)</li>
<li><code>Message_ID</code>: I2NP 메시지 ID(4바이트)</li>
<li><code>Expiration</code>: 초 단위 Unix 타임스탬프(4바이트)</li>
<li><code>I2NP Message body</code>: 가변 길이의 메시지 데이터</li>
</ul>
<p><strong>전달 지시 형식:</strong></p>
<p><strong>Local Delivery(로컬 전달)</strong> (1바이트):</p>
<pre tabindex="0"><code>+----+
|0x00|
+----+
</code></pre><p><strong>목적지 전달</strong> (33 바이트):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|0x01|                                  |
+----+        Destination Hash         +
|              32 bytes                 |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Router 전달</strong> (33 바이트):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|0x02|                                  |
+----+         Router Hash              +
|              32 bytes                 |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Tunnel 전달</strong> (37 바이트):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|0x03|         Tunnel ID                |
+----+----+----+----+----+              +
|           Router Hash                 |
+              32 bytes                 +
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>I2NP 메시지 헤더</strong> (총 9바이트):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|type|      msg_id       |  expiration   |
+----+----+----+----+----+----+----+----+
     |                                   |
</code></pre><ul>
<li><code>type</code>: I2NP 메시지 유형 (Database Store, Database Lookup, Data 등)</li>
<li><code>msg_id</code>: 4바이트 메시지 식별자</li>
<li><code>expiration</code>: 4바이트 유닉스 타임스탬프 (초)</li>
</ul>
<p><strong>ElGamal Clove 형식과의 중요한 차이점:</strong></p>
<ol>
<li><strong>인증서 없음</strong>: 인증서 필드를 생략함 (ElGamal(엘가말, 공개키 암호 방식)에서는 사용되지 않음)</li>
<li><strong>Clove ID 없음</strong>: Clove(I2P 메시지 내부의 서브메시지 단위) ID를 생략함 (항상 0이었음)</li>
<li><strong>Clove 만료 시간 없음</strong>: 대신 I2NP 메시지 만료 시간을 사용함</li>
<li><strong>간결한 헤더</strong>: 9바이트 I2NP 헤더 vs 더 큰 ElGamal 형식</li>
<li><strong>각 Clove는 별도의 블록</strong>: CloveSet(여러 Clove를 묶는 구조) 구조 없음</li>
</ol>
<p><strong>여러 개의 Clove(클로브: 하나의 garlic 메시지 안에 포장되는 개별 하위 메시지 단위):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Multiple Garlic Cloves in one message</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    build_datetime_block(),
</span></span><span style="display:flex;"><span>    build_garlic_clove(i2np_message_1),
</span></span><span style="display:flex;"><span>    build_garlic_clove(i2np_message_2),
</span></span><span style="display:flex;"><span>    build_garlic_clove(i2np_message_3),
</span></span><span style="display:flex;"><span>    build_padding_block()
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>Cloves(garlic encryption 메시지의 하위 메시지 단위)에서 일반적인 I2NP 메시지 유형:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Name</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Usage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DatabaseStore</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Publishing LeaseSet</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DatabaseLookup</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Requesting LeaseSet</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">5</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DeliveryStatus</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ACK (legacy, avoid in ECIES)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">20</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Streaming data</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">21</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Garlic</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Nested garlic messages</td>
    </tr>
  </tbody>
</table>
**Clove(클로브, garlic 메시지의 하위 메시지) 처리:**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_garlic_clove</span>(clove_data):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Parse delivery instructions</span>
</span></span><span style="display:flex;"><span>    delivery_type <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x00</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Local delivery</span>
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x01</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Destination delivery</span>
</span></span><span style="display:flex;"><span>        dest_hash <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">33</span>]
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x02</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Router delivery</span>
</span></span><span style="display:flex;"><span>        router_hash <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">33</span>]
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x03</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Tunnel delivery</span>
</span></span><span style="display:flex;"><span>        tunnel_id <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;I&#39;</span>, clove_data[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">5</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        router_hash <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">37</span>]
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">37</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Parse I2NP header</span>
</span></span><span style="display:flex;"><span>    i2np_type <span style="color:#f92672">=</span> clove_data[offset]
</span></span><span style="display:flex;"><span>    msg_id <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;I&#39;</span>, clove_data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">5</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    expiration <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;I&#39;</span>, clove_data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">5</span>:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract I2NP body</span>
</span></span><span style="display:flex;"><span>    i2np_body <span style="color:#f92672">=</span> clove_data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span>:]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Process message</span>
</span></span><span style="display:flex;"><span>    process_i2np_message(i2np_type, msg_id, expiration, i2np_body)
</span></span></code></pre></div><h3 id="nextkey-블록-유형-7">NextKey 블록 (유형 7)</h3>
<p><strong>목적</strong>: DH ratchet(디피-헬만 기반 래칫) 키 교환</p>
<p><strong>형식 (키 존재 - 38바이트):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 7  |   35    |flag|  key ID |         |
+----+----+----+----+----+----+         +
|                                       |
+     Next DH Ratchet Public Key        +
|              32 bytes                 |
+                                       +
|                                       |
+                             +----+----+
|                             |
+----+----+----+----+----+----+
</code></pre><p><strong>형식 (Key ID만 - 6바이트):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+
| 7  |    3    |flag|  key ID |
+----+----+----+----+----+----+
</code></pre><p><strong>필드:</strong></p>
<ul>
<li><code>blk</code>: 7</li>
<li><code>size</code>: 3 (ID만) 또는 35 (키 포함)</li>
<li><code>flag</code>: 1 바이트 - 플래그 비트</li>
<li><code>key ID</code>: 2 바이트 - 빅 엔디안 키 식별자(0-32767)</li>
<li><code>Public Key</code>: 32 바이트 - X25519 공개 키(리틀 엔디안), 플래그 비트 0 = 1인 경우</li>
</ul>
<p><strong>플래그 비트:</strong></p>
<pre tabindex="0"><code>Bit 7 6 5 4 3 2 1 0
    | | | | | | | |
    | | | | | | | +-- Bit 0: Key present (1) or ID only (0)
    | | | | | | +---- Bit 1: Reverse key (1) or forward key (0)
    | | | | | +------ Bit 2: Request reverse key (1) or no request (0)
    | | | | |
    +-+-+-+-+-------- Bits 3-7: Reserved (set to 0)
</code></pre><p><strong>플래그 예시:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Forward key present</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x01</span>  <span style="color:#75715e"># Binary: 00000001</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Reverse key present</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x03</span>  <span style="color:#75715e"># Binary: 00000011</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Forward key ID only (ACK)</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00</span>  <span style="color:#75715e"># Binary: 00000000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Reverse key ID only (ACK)</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x02</span>  <span style="color:#75715e"># Binary: 00000010</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Forward key ID with reverse request</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x04</span>  <span style="color:#75715e"># Binary: 00000100</span>
</span></span></code></pre></div><p><strong>키 ID 규칙:</strong></p>
<ul>
<li>ID는 순차적임: 0, 1, 2, &hellip;, 32767</li>
<li>ID는 새 키가 생성될 때에만 증가함</li>
<li>다음 ratchet(래칫, 단계적 키 갱신 메커니즘) 전까지는 여러 메시지에 동일한 ID가 사용됨</li>
<li>최대 ID는 32767 (그 이후에는 새 세션을 시작해야 함)</li>
</ul>
<p><strong>사용 예시:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Initiating ratchet (sender generates new key)</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>,           <span style="color:#75715e"># Key present, forward</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    public_key<span style="color:#f92672">=</span>sender_new_pk
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Replying to ratchet (receiver generates new key)</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>,           <span style="color:#75715e"># Key present, reverse</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    public_key<span style="color:#f92672">=</span>receiver_new_pk
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Acknowledging ratchet (no new key from sender)</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x02</span>,           <span style="color:#75715e"># ID only, reverse</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Requesting reverse ratchet</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x04</span>,           <span style="color:#75715e"># Request reverse, forward ID</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>처리 로직:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_nextkey_block</span>(block):
</span></span><span style="display:flex;"><span>    flags <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>flags
</span></span><span style="display:flex;"><span>    key_id <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>key_id
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    key_present <span style="color:#f92672">=</span> (flags <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x01</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    is_reverse <span style="color:#f92672">=</span> (flags <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x02</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    request_reverse <span style="color:#f92672">=</span> (flags <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x04</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> key_present:
</span></span><span style="display:flex;"><span>        public_key <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_reverse:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Reverse key received</span>
</span></span><span style="display:flex;"><span>            perform_dh_ratchet(receiver_key<span style="color:#f92672">=</span>public_key, key_id<span style="color:#f92672">=</span>key_id)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Sender should ACK with own key ID</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Forward key received</span>
</span></span><span style="display:flex;"><span>            perform_dh_ratchet(sender_key<span style="color:#f92672">=</span>public_key, key_id<span style="color:#f92672">=</span>key_id)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Receiver should reply with reverse key</span>
</span></span><span style="display:flex;"><span>            send_reverse_key(generate_new_key())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Key ID only (ACK)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_reverse:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Reverse key ACK</span>
</span></span><span style="display:flex;"><span>            confirm_reverse_ratchet(key_id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Forward key ACK</span>
</span></span><span style="display:flex;"><span>            confirm_forward_ratchet(key_id)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request_reverse:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Sender requests receiver to generate new key</span>
</span></span><span style="display:flex;"><span>        send_reverse_key(generate_new_key())
</span></span></code></pre></div><p><strong>여러 개의 NextKey Blocks(다음 키 블록):</strong></p>
<p>양방향에서 동시에 ratcheting(키를 단계적으로 갱신하는 절차)을 수행할 때, 단일 ES message는 최대 2개의 NextKey blocks를 포함할 수 있습니다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Both directions ratcheting</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    NextKeyBlock(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, public_key<span style="color:#f92672">=</span>forward_key),  <span style="color:#75715e"># Forward</span>
</span></span><span style="display:flex;"><span>    NextKeyBlock(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, public_key<span style="color:#f92672">=</span>reverse_key),  <span style="color:#75715e"># Reverse</span>
</span></span><span style="display:flex;"><span>    build_garlic_clove(data)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><h3 id="ack확인-응답-블록-유형-8">ACK(확인 응답) 블록 (유형 8)</h3>
<p><strong>목적</strong>: 수신된 메시지에 대한 수신 확인을 in-band(동일 채널 내에서)으로 수행</p>
<p><strong>형식 (단일 ACK - 7바이트):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+
| 8  |    4    |tagsetid |   N     |
+----+----+----+----+----+----+----+
</code></pre><p><strong>형식 (여러 개의 ACK(확인 응답)):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 8  |  size   |tagsetid |   N     |    |
+----+----+----+----+----+----+----+    +
|            more ACKs                  |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>필드:</strong></p>
<ul>
<li><code>blk</code>: 8</li>
<li><code>size</code>: 4 * ACK의 개수(최소 4)</li>
<li>각 ACK에 대해:
<ul>
<li><code>tagsetid</code>: 2바이트 - 빅엔디언 태그 세트 ID (0-65535)</li>
<li><code>N</code>: 2바이트 - 빅엔디언 메시지 번호 (0-65535)</li>
</ul>
</li>
</ul>
<p><strong>태그 세트 ID 결정:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Tag set 0 (initial, after NSR)</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># After first ratchet (tag set 1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Both Alice and Bob sent key ID 0</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># After second ratchet (tag set 2)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Alice sent key ID 1, Bob still using key ID 0</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># After third ratchet (tag set 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Alice still using key ID 1, Bob sent key ID 1</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span></code></pre></div><p><strong>단일 ACK(확인 응답) 예시:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ACK message from tag set 5, message number 127</span>
</span></span><span style="display:flex;"><span>ack_block <span style="color:#f92672">=</span> ACKBlock(
</span></span><span style="display:flex;"><span>    tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>    message_number<span style="color:#f92672">=</span><span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wire format (7 bytes):</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 08 00 04 00 05 00 7F</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  |  |  |  |</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  |  |  |  +-- N (127)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  |  +--------- N high byte</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  +------------ tagset_id (5)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  +--------------- tagset_id high byte</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  +------------------ size (4)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># +--------------------- type (8)</span>
</span></span></code></pre></div><p><strong>여러 ACK(승인) 예시:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ACK three messages</span>
</span></span><span style="display:flex;"><span>ack_block <span style="color:#f92672">=</span> ACKBlock([
</span></span><span style="display:flex;"><span>    (tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, N<span style="color:#f92672">=</span><span style="color:#ae81ff">42</span>),
</span></span><span style="display:flex;"><span>    (tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, N<span style="color:#f92672">=</span><span style="color:#ae81ff">43</span>),
</span></span><span style="display:flex;"><span>    (tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>, N<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wire format (15 bytes):</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 08 00 0C 00 03 00 2A 00 03 00 2B 00 04 00 00</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#                (ts=3, N=42) (ts=3, N=43) (ts=4, N=0)</span>
</span></span></code></pre></div><p><strong>처리:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_ack_block</span>(block):
</span></span><span style="display:flex;"><span>    num_acks <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>size <span style="color:#f92672">//</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_acks):
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> i <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>        tagset_id <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;H&#39;</span>, block<span style="color:#f92672">.</span>data[offset:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        message_num <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;H&#39;</span>, block<span style="color:#f92672">.</span>data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mark message as acknowledged</span>
</span></span><span style="display:flex;"><span>        mark_acked(tagset_id, message_num)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># May trigger retransmission timeout cancellation</span>
</span></span><span style="display:flex;"><span>        cancel_retransmit_timer(tagset_id, message_num)
</span></span></code></pre></div><p><strong>ACK(승인 응답)을 언제 보낼지:</strong></p>
<ol>
<li><strong>명시적 ACK Request</strong>: ACK Request 블록에는 항상 응답</li>
<li><strong>LeaseSet 전달</strong>: 발신자가 메시지에 LeaseSet을 포함할 때</li>
<li><strong>세션 설정</strong>: NS/NSR을 ACK할 수 있음(프로토콜은 ES를 통한 암시적 ACK를 선호함)</li>
<li><strong>Ratchet(단계적 키 갱신 메커니즘) 확인</strong>: NextKey 수신을 ACK할 수 있음</li>
<li><strong>애플리케이션 계층</strong>: 상위 계층 프로토콜의 요구에 따라(예: Streaming)</li>
</ol>
<p><strong>ACK(승인) 타이밍:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ACKManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pending_acks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ack_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">request_ack</span>(self, tagset_id, message_num):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pending_acks<span style="color:#f92672">.</span>append((tagset_id, message_num))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>ack_timer:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Delay ACK briefly to allow higher layer to respond</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>ack_timer <span style="color:#f92672">=</span> set_timer(<span style="color:#ae81ff">0.1</span>, self<span style="color:#f92672">.</span>send_acks)  <span style="color:#75715e"># 100ms</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_acks</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>pending_acks <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> has_outbound_data():
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># No higher layer data, send explicit ACK</span>
</span></span><span style="display:flex;"><span>            send_es_message(build_ack_block(self<span style="color:#f92672">.</span>pending_acks))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Otherwise, ACK will piggyback on next ES message</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pending_acks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ack_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><h3 id="ack-요청-블록-타입-9">ACK 요청 블록 (타입 9)</h3>
<p><strong>목적</strong>: 현재 메시지에 대한 인밴드 수신 확인을 요청</p>
<p><strong>형식:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+
| 9  |    1    |flg |
+----+----+----+----+
</code></pre><p><strong>필드:</strong></p>
<ul>
<li><code>blk</code>: 9</li>
<li><code>size</code>: 1</li>
<li><code>flg</code>: 1바이트 - 플래그(현재 모든 비트는 미사용이며 0으로 설정됨)</li>
</ul>
<p><strong>사용법:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Request ACK for this message</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    build_ack_request_block(),
</span></span><span style="display:flex;"><span>    build_garlic_clove(important_data)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>수신자 응답:</strong></p>
<p>ACK 요청을 수신했을 때:</p>
<ol>
<li><strong>즉시 데이터가 있는 경우</strong>: 즉시 응답에 ACK(확인 응답) 블록을 포함</li>
<li><strong>즉시 데이터가 없는 경우</strong>: 타이머를 시작하고(예: 100ms), 타이머가 만료되면 ACK와 함께 빈 ES를 전송</li>
<li><strong>태그 세트 ID</strong>: 현재 인바운드 태그세트 ID를 사용</li>
<li><strong>메시지 번호</strong>: 수신된 세션 태그에 연관된 메시지 번호를 사용</li>
</ol>
<p><strong>처리:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_ack_request</span>(message):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract message identification</span>
</span></span><span style="display:flex;"><span>    tagset_id <span style="color:#f92672">=</span> message<span style="color:#f92672">.</span>tagset_id
</span></span><span style="display:flex;"><span>    message_num <span style="color:#f92672">=</span> message<span style="color:#f92672">.</span>message_num
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Schedule ACK</span>
</span></span><span style="display:flex;"><span>    schedule_ack(tagset_id, message_num)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># If no data to send immediately, start timer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> has_pending_data():
</span></span><span style="display:flex;"><span>        set_timer(<span style="color:#ae81ff">0.1</span>, <span style="color:#66d9ef">lambda</span>: send_ack_only(tagset_id, message_num))
</span></span></code></pre></div><p><strong>ACK 요청을 언제 사용해야 하나요:</strong></p>
<ol>
<li><strong>중요한 메시지</strong>: 반드시 확인되어야 하는 메시지</li>
<li><strong>LeaseSet 전달</strong>: LeaseSet을 함께 묶어 보낼 때</li>
<li><strong>세션 래칫</strong>: NextKey block(다음 키 블록)을 전송한 뒤</li>
<li><strong>전송 종료</strong>: 송신자가 더 보낼 데이터는 없지만 확인을 원할 때</li>
</ol>
<p><strong>사용하지 말아야 할 때:</strong></p>
<ol>
<li><strong>Streaming Protocol</strong>: 스트리밍 계층이 ACK를 처리합니다</li>
<li><strong>High Frequency Messages</strong>: 모든 메시지마다 ACK 요청을 피하세요(오버헤드)</li>
<li><strong>Unimportant Datagrams</strong>: 원시 데이터그램은 일반적으로 ACK가 필요하지 않습니다</li>
</ol>
<h3 id="종료-블록-유형-4">종료 블록 (유형 4)</h3>
<p><strong>상태</strong>: 미구현</p>
<p><strong>목적</strong>: 세션을 정상적으로 종료</p>
<p><strong>형식:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 4  |  size   | rsn|     addl data     |
+----+----+----+----+                   +
~               ...                     ~
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>필드:</strong></p>
<ul>
<li><code>blk</code>: 4</li>
<li><code>size</code>: 1바이트 이상</li>
<li><code>rsn</code>: 1바이트 - 이유 코드</li>
<li><code>addl data</code>: 선택적 추가 데이터 (형식은 이유에 따라 다름)</li>
</ul>
<p><strong>사유 코드:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Code</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Meaning</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Additional Data</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Normal close / unspecified</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Termination received</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Idle timeout</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None (implementation-specific)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Resource exhaustion</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None (implementation-specific)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implementation-specific</td>
    </tr>
  </tbody>
</table>
**사용 방법(구현되면):**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Normal session close</span>
</span></span><span style="display:flex;"><span>termination <span style="color:#f92672">=</span> TerminationBlock(
</span></span><span style="display:flex;"><span>    reason<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    additional_data<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Session termination due to received termination</span>
</span></span><span style="display:flex;"><span>termination <span style="color:#f92672">=</span> TerminationBlock(
</span></span><span style="display:flex;"><span>    reason<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    additional_data<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>규칙:</strong></p>
<ul>
<li>Padding(패딩)을 제외하면 반드시 마지막 블록이어야 함</li>
<li>존재하는 경우 Padding은 Termination(종료) 뒤에 반드시 와야 함</li>
<li>NS 또는 NSR 메시지에서는 허용되지 않음</li>
<li>ES 메시지에서만 허용됨</li>
</ul>
<h3 id="옵션-블록-타입-5">옵션 블록 (타입 5)</h3>
<p><strong>상태</strong>: 미구현</p>
<p><strong>목적</strong>: 세션 매개변수 협상</p>
<p><strong>형식:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 5  |  size   |ver |flg |STL |STimeout |
+----+----+----+----+----+----+----+----+
|  SOTW   |  RITW   |tmin|tmax|rmin|rmax|
+----+----+----+----+----+----+----+----+
|  tdmy   |  rdmy   |  tdelay |  rdelay |
+----+----+----+----+----+----+----+----+
|              more_options             |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>필드:</strong></p>
<ul>
<li><code>blk</code>: 5</li>
<li><code>size</code>: 21바이트 이상</li>
<li><code>ver</code>: 1바이트 - 프로토콜 버전(0이어야 함)</li>
<li><code>flg</code>: 1바이트 - 플래그(현재 모든 비트 미사용)</li>
<li><code>STL</code>: 1바이트 - 세션 태그 길이(8이어야 함)</li>
<li><code>STimeout</code>: 2바이트 - 세션 유휴 타임아웃(초, 빅 엔디언)</li>
<li><code>SOTW</code>: 2바이트 - 송신자 아웃바운드 태그 윈도우(빅 엔디언)</li>
<li><code>RITW</code>: 2바이트 - 수신자 인바운드 태그 윈도우(빅 엔디언)</li>
<li><code>tmin</code>, <code>tmax</code>, <code>rmin</code>, <code>rmax</code>: 각 1바이트 - 패딩 파라미터(4.4 고정소수점)</li>
<li><code>tdmy</code>: 2바이트 - 보내려는 최대 더미 트래픽(바이트/초, 빅 엔디언)</li>
<li><code>rdmy</code>: 2바이트 - 요청된 더미 트래픽(바이트/초, 빅 엔디언)</li>
<li><code>tdelay</code>: 2바이트 - 삽입하려는 최대 메시지 내부 지연(밀리초, 빅 엔디언)</li>
<li><code>rdelay</code>: 2바이트 - 요청된 메시지 내부 지연(밀리초, 빅 엔디언)</li>
<li><code>more_options</code>: 가변 길이 - 향후 확장</li>
</ul>
<p><strong>패딩 매개변수 (4.4 고정소수점):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encode_padding_ratio</span>(ratio):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Encode padding ratio as 4.4 fixed-point
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ratio: 0.0 to 15.9375
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    returns: 0x00 to 0xFF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> int(ratio <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decode_padding_ratio</span>(encoded):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Decode 4.4 fixed-point to ratio
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    encoded: 0x00 to 0xFF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    returns: 0.0 to 15.9375
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> encoded <span style="color:#f92672">/</span> <span style="color:#ae81ff">16.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Examples:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x00 = 0.0 (no padding)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x01 = 0.0625 (6.25% padding)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x10 = 1.0 (100% padding - double traffic)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x80 = 8.0 (800% padding - 9x traffic)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0xFF = 15.9375 (1593.75% padding)</span>
</span></span></code></pre></div><p><strong>Tag Window Negotiation(태그 윈도우 협상):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># SOTW: Sender&#39;s recommendation for receiver&#39;s inbound window</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RITW: Sender&#39;s declaration of own inbound window</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver calculates actual inbound window:</span>
</span></span><span style="display:flex;"><span>inbound_window <span style="color:#f92672">=</span> calculate_window(
</span></span><span style="display:flex;"><span>    sender_suggestion<span style="color:#f92672">=</span>SOTW,
</span></span><span style="display:flex;"><span>    own_constraints<span style="color:#f92672">=</span>MAX_INBOUND_TAGS,
</span></span><span style="display:flex;"><span>    own_resources<span style="color:#f92672">=</span>available_memory()
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sender uses:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - RITW to know how far ahead receiver will accept</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Own SOTW to hint optimal window size</span>
</span></span></code></pre></div><p><strong>기본값(옵션이 협상되지 않은 경우):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>DEFAULT_OPTIONS <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;version&#39;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;session_tag_length&#39;</span>: <span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">600</span>,  <span style="color:#75715e"># 10 minutes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;sender_outbound_tag_window&#39;</span>: <span style="color:#ae81ff">160</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;receiver_inbound_tag_window&#39;</span>: <span style="color:#ae81ff">160</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tmin&#39;</span>: <span style="color:#ae81ff">0x00</span>,  <span style="color:#75715e"># No minimum padding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tmax&#39;</span>: <span style="color:#ae81ff">0x10</span>,  <span style="color:#75715e"># Up to 100% padding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rmin&#39;</span>: <span style="color:#ae81ff">0x00</span>,  <span style="color:#75715e"># No minimum requested</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rmax&#39;</span>: <span style="color:#ae81ff">0x10</span>,  <span style="color:#75715e"># Up to 100% requested</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tdmy&#39;</span>: <span style="color:#ae81ff">0</span>,     <span style="color:#75715e"># No dummy traffic</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rdmy&#39;</span>: <span style="color:#ae81ff">0</span>,     <span style="color:#75715e"># No dummy traffic requested</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tdelay&#39;</span>: <span style="color:#ae81ff">0</span>,   <span style="color:#75715e"># No delay</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rdelay&#39;</span>: <span style="color:#ae81ff">0</span>    <span style="color:#75715e"># No delay requested</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="messagenumbers메시지-번호-블록-유형-6">MessageNumbers(메시지 번호) 블록 (유형 6)</h3>
<p><strong>상태</strong>: 미구현</p>
<p><strong>목적</strong>: 이전 태그 세트에서 전송된 마지막 메시지를 표시하여 누락 감지를 가능하게 함</p>
<p><strong>형식:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+
| 6  |    2    |  PN    |
+----+----+----+----+----+
</code></pre><p><strong>필드:</strong></p>
<ul>
<li><code>blk</code>: 6</li>
<li><code>size</code>: 2</li>
<li><code>PN</code>: 2바이트 - 이전 태그 세트의 마지막 메시지 번호(빅엔디언, 0-65535)</li>
</ul>
<p><strong>PN (이전 번호) 정의:</strong></p>
<p>PN은 이전 태그 세트에서 보낸 마지막 태그의 인덱스입니다.</p>
<p><strong>사용법(구현되면):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># After ratcheting to new tag set</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Old tag set: sent messages 0-4095</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># New tag set: sending first message</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    MessageNumbersBlock(PN<span style="color:#f92672">=</span><span style="color:#ae81ff">4095</span>),
</span></span><span style="display:flex;"><span>    build_garlic_clove(data)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>수신자 이점:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_message_numbers</span>(pn_value):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Receiver can now:</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1. Determine if any messages were skipped</span>
</span></span><span style="display:flex;"><span>    highest_received_in_old_tagset <span style="color:#f92672">=</span> <span style="color:#ae81ff">4090</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> pn_value <span style="color:#f92672">&gt;</span> highest_received_in_old_tagset:
</span></span><span style="display:flex;"><span>        missing_count <span style="color:#f92672">=</span> pn_value <span style="color:#f92672">-</span> highest_received_in_old_tagset
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 5 messages were never received</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 2. Delete tags higher than PN from old tagset</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tag_index <span style="color:#f92672">in</span> range(pn_value <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, MAX_TAG_INDEX):
</span></span><span style="display:flex;"><span>        delete_tag(old_tagset, tag_index)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 3. Expire tags ≤ PN after grace period (e.g., 2 minutes)</span>
</span></span><span style="display:flex;"><span>    schedule_deletion(old_tagset, delay<span style="color:#f92672">=</span><span style="color:#ae81ff">120</span>)
</span></span></code></pre></div><p><strong>규칙:</strong></p>
<ul>
<li>tag set(태그 세트) 0(이전 tag set 없음)에서는 절대 전송하면 안 됨</li>
<li>ES 메시지에서만 전송됨</li>
<li>새로운 tag set의 최초 메시지(들)에서만 전송됨</li>
<li>PN 값은 발신자 관점 기준임(발신자가 마지막으로 보낸 tag(태그))</li>
</ul>
<p><strong>Signal과의 관계:</strong></p>
<p>Signal Double Ratchet(시그널 프로토콜의 더블 래칫 알고리즘)에서는 PN(이전 체인 길이)이 메시지 헤더에 포함된다. ECIES(타원곡선 통합 암호화 체계)에서는 암호화된 페이로드에 포함되며 선택 사항이다.</p>
<h3 id="패딩-블록-유형-254">패딩 블록 (유형 254)</h3>
<p><strong>목적</strong>: 트래픽 분석 저항성과 메시지 크기 난독화</p>
<p><strong>형식:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|254 |  size   |      padding           |
+----+----+----+                        +
|                                       |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>필드:</strong></p>
<ul>
<li><code>blk</code>: 254</li>
<li><code>size</code>: 0-65516 바이트 (빅엔디언)</li>
<li><code>padding</code>: 무작위 데이터 또는 0으로 채운 데이터</li>
</ul>
<p><strong>규칙:</strong></p>
<ul>
<li>반드시 메시지에서 마지막 블록이어야 함</li>
<li>여러 개의 패딩 블록은 허용되지 않음</li>
<li>길이가 0일 수 있음(3바이트 헤더만)</li>
<li>패딩 데이터는 0으로 채우거나 임의의 바이트일 수 있음</li>
</ul>
<p><strong>기본 패딩:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>DEFAULT_PADDING_MIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>DEFAULT_PADDING_MAX <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_default_padding</span>():
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(DEFAULT_PADDING_MIN, DEFAULT_PADDING_MAX)
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>bytes(size)  <span style="color:#75715e"># or zeros</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> PaddingBlock(size, data)
</span></span></code></pre></div><p><strong>트래픽 분석 저항 전략:</strong></p>
<p><strong>전략 1: 무작위 크기(기본값)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Add 0-15 bytes random padding to each message</span>
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">15</span>)
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>전략 2: 배수로 반올림</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Round total message size to next multiple of 64</span>
</span></span><span style="display:flex;"><span>target_size <span style="color:#f92672">=</span> ((message_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">63</span>) <span style="color:#f92672">//</span> <span style="color:#ae81ff">64</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> target_size <span style="color:#f92672">-</span> message_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>  <span style="color:#75715e"># -3 for block header</span>
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>전략 3: 고정 메시지 크기</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Always send 1KB messages</span>
</span></span><span style="display:flex;"><span>TARGET_MESSAGE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> TARGET_MESSAGE_SIZE <span style="color:#f92672">-</span> message_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>전략 4: 협상된 패딩 (Options block(옵션 블록))</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Calculate padding based on negotiated parameters</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tmin, tmax from Options block</span>
</span></span><span style="display:flex;"><span>min_padding <span style="color:#f92672">=</span> int(payload_size <span style="color:#f92672">*</span> tmin_ratio)
</span></span><span style="display:flex;"><span>max_padding <span style="color:#f92672">=</span> int(payload_size <span style="color:#f92672">*</span> tmax_ratio)
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(min_padding, max_padding)
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>패딩 전용 메시지:</strong></p>
<p>메시지는 전적으로 패딩으로만 구성될 수 있습니다(애플리케이션 데이터 없음):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Dummy traffic message</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    PaddingBlock(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">500</span>), random<span style="color:#f92672">.</span>bytes(<span style="color:#f92672">...</span>))
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>구현 참고 사항:</strong></p>
<ol>
<li><strong>올-제로 패딩</strong>: 허용됨(ChaCha20(스트림 암호 알고리즘)에 의해 암호화됨)</li>
<li><strong>무작위 패딩</strong>: 암호화 후에는 추가적인 보안을 제공하지 않지만 더 많은 엔트로피를 사용함</li>
<li><strong>성능</strong>: 무작위 패딩 생성은 비용이 많이 들 수 있으므로 0 사용을 고려</li>
<li><strong>메모리</strong>: 큰 패딩 블록은 대역폭을 소모하므로 최대 크기에 주의</li>
</ol>
<hr>
<h2 id="구현-가이드">구현 가이드</h2>
<h3 id="사전-준비-사항">사전 준비 사항</h3>
<p><strong>암호화 라이브러리:</strong></p>
<ul>
<li><strong>X25519</strong>: libsodium, NaCl, 또는 Bouncy Castle</li>
<li><strong>ChaCha20-Poly1305</strong>: libsodium, OpenSSL 1.1.0+, 또는 Bouncy Castle</li>
<li><strong>SHA-256</strong>: OpenSSL, Bouncy Castle, 또는 언어의 내장 지원</li>
<li><strong>Elligator2</strong>: 라이브러리 지원이 제한적임; 사용자 정의 구현이 필요할 수 있음</li>
</ul>
<p><strong>Elligator2(타원곡선 점을 무작위 데이터처럼 보이게 하는 매핑 기법) 구현:</strong></p>
<p>Elligator2(암호학적 매핑 기법)은 널리 구현되어 있지 않습니다. 옵션:</p>
<ol>
<li><strong>OBFS4</strong>: Tor의 obfs4 pluggable transport(플러그형 전송)는 Elligator2 구현을 포함합니다</li>
<li><strong>Custom Implementation</strong>: <a href="https://elligator.cr.yp.to/elligator-20130828.pdf">Elligator2 paper</a>
를 기반으로 합니다</li>
<li><strong>kleshni/Elligator</strong>: GitHub의 참조 구현</li>
</ol>
<p><strong>Java I2P 참고:</strong> Java I2P는 사용자 지정 Elligator2(암호학적 매핑 기법) 추가 기능이 포함된 net.i2p.crypto.eddsa 라이브러리를 사용합니다.</p>
<h3 id="권장-구현-순서">권장 구현 순서</h3>
<p><strong>1단계: 핵심 암호 기술</strong> 1. X25519 DH 키 생성 및 교환 2. ChaCha20-Poly1305 AEAD 암호화/복호화 3. SHA-256 해싱 및 MixHash 4. HKDF 키 파생 5. Elligator2 인코딩/디코딩(초기에는 테스트 벡터를 사용할 수 있음)</p>
<p><strong>2단계: 메시지 형식</strong> 1. NS 메시지 (바인딩되지 않음) - 가장 단순한 형식 2. NS 메시지 (바인딩됨) - 정적 키 추가 3. NSR 메시지 4. ES 메시지 5. 블록 파싱 및 생성</p>
<p><strong>3단계: 세션 관리</strong> 1. 세션 생성 및 저장 2. 태그 집합 관리(송신자와 수신자) 3. 세션 태그 ratchet(래칫: 단계적으로 키를 갱신하는 암호 메커니즘) 4. 대칭키 ratchet 5. 태그 조회 및 윈도우 관리</p>
<p><strong>4단계: DH 래칫팅</strong> 1. NextKey 블록 처리 2. DH 래칫 KDF(키 유도 함수) 3. 래칫 이후 태그 세트 생성 4. 다중 태그 세트 관리</p>
<p><strong>5단계: 프로토콜 로직</strong> 1. NS/NSR/ES 상태 머신 2. 재생 공격 방지 (DateTime(날짜/시간), Bloom filter(블룸 필터)) 3. 재전송 로직 (복수의 NS/NSR) 4. ACK(확인 응답) 처리</p>
<p><strong>6단계: 통합</strong> 1. I2NP Garlic Clove(서브메시지 단위) 처리 2. LeaseSet 번들링 3. 스트리밍 프로토콜 통합 4. 데이터그램 프로토콜 통합</p>
<h3 id="송신자-구현">송신자 구현</h3>
<p><strong>아웃바운드 세션 수명주기:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, destination, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> destination
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> bound
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>NEW
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Keys for NS message</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> bound:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>static_key <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>static_keypair
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Will be populated after NSR</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_keyratchet <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_keyratchet <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Timing</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Retransmission</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_attempts <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_initial_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Send NS message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build NS message</span>
</span></span><span style="display:flex;"><span>        ns_message <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>build_ns_message(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send</span>
</span></span><span style="display:flex;"><span>        send_to_network(self<span style="color:#f92672">.</span>destination, ns_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Track for retransmission</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_attempts<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;message&#39;</span>: ns_message,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;time&#39;</span>: now(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;ephemeral_key&#39;</span>: self<span style="color:#f92672">.</span>ephemeral_keypair,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;kdf_state&#39;</span>: self<span style="color:#f92672">.</span>save_kdf_state()
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Start timer</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> set_timer(<span style="color:#ae81ff">1.0</span>, self<span style="color:#f92672">.</span>on_ns_timeout)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>PENDING_REPLY
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_ns_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Construct NS message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># KDF initialization</span>
</span></span><span style="display:flex;"><span>        chainKey, h <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>initialize_kdf()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Ephemeral key section</span>
</span></span><span style="display:flex;"><span>        elg2_ephemeral <span style="color:#f92672">=</span> ENCODE_ELG2(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> self<span style="color:#f92672">.</span>destination<span style="color:#f92672">.</span>static_key)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># es DH</span>
</span></span><span style="display:flex;"><span>        es_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                       self<span style="color:#f92672">.</span>destination<span style="color:#f92672">.</span>static_key)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, es_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_static <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt static key section</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>bound:
</span></span><span style="display:flex;"><span>            static_section <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>static_key<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            static_section <span style="color:#f92672">=</span> bytes(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        static_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_static, <span style="color:#ae81ff">0</span>, static_section, h)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> static_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ss DH (if bound)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>bound:
</span></span><span style="display:flex;"><span>            ss_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>static_key<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                          self<span style="color:#f92672">.</span>destination<span style="color:#f92672">.</span>static_key)
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(chainKey, ss_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> k_static
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build payload blocks</span>
</span></span><span style="display:flex;"><span>        payload_data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>build_ns_payload(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt payload</span>
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_payload, nonce, payload_data, h)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> payload_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Save KDF state for NSR processing</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_chainkey <span style="color:#f92672">=</span> chainKey
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_hash <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Assemble message</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> elg2_ephemeral <span style="color:#f92672">+</span> static_ciphertext <span style="color:#f92672">+</span> payload_ciphertext
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_ns_payload</span>(self, application_data):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Build NS payload blocks&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        blocks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># DateTime block (required, first)</span>
</span></span><span style="display:flex;"><span>        blocks<span style="color:#f92672">.</span>append(build_datetime_block())
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Garlic Clove(s) with application data</span>
</span></span><span style="display:flex;"><span>        blocks<span style="color:#f92672">.</span>append(build_garlic_clove(application_data))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Optionally bundle LeaseSet</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> should_send_leaseset():
</span></span><span style="display:flex;"><span>            blocks<span style="color:#f92672">.</span>append(build_garlic_clove(build_leaseset_store()))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Padding</span>
</span></span><span style="display:flex;"><span>        blocks<span style="color:#f92672">.</span>append(build_padding_block(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">15</span>)))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> encode_blocks(blocks)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_nsr_received</span>(self, nsr_message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Process NSR and establish ES session&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Cancel retransmission timer</span>
</span></span><span style="display:flex;"><span>        cancel_timer(self<span style="color:#f92672">.</span>ns_timer)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Parse NSR</span>
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>        elg2_bob_ephemeral <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">40</span>]
</span></span><span style="display:flex;"><span>        key_section_mac <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">40</span>:<span style="color:#ae81ff">56</span>]
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">56</span>:]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Find corresponding NS attempt</span>
</span></span><span style="display:flex;"><span>        ns_state <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>find_ns_by_tag(tag)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> ns_state:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;NSR tag doesn&#39;t match any NS&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Restore KDF state</span>
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> ns_state[<span style="color:#e6db74">&#39;chainkey&#39;</span>]
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> ns_state[<span style="color:#e6db74">&#39;hash&#39;</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decode Bob&#39;s ephemeral key</span>
</span></span><span style="display:flex;"><span>        bob_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(elg2_bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix tag and Bob&#39;s ephemeral into hash</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> tag)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ee DH</span>
</span></span><span style="display:flex;"><span>        ee_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>private_key, bob_ephemeral)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ee_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># se DH</span>
</span></span><span style="display:flex;"><span>        se_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>static_key<span style="color:#f92672">.</span>private_key, bob_ephemeral)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, se_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_key_section <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify key section MAC</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            DECRYPT(k_key_section, <span style="color:#ae81ff">0</span>, key_section_mac, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;NSR key section MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> key_section_mac)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Split for bidirectional ES</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        k_ab <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Alice → Bob</span>
</span></span><span style="display:flex;"><span>        k_ba <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Bob → Alice</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize ES tagsets</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ab)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ba)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt NSR payload</span>
</span></span><span style="display:flex;"><span>        k_nsr <span style="color:#f92672">=</span> HKDF(k_ba, ZEROLEN, <span style="color:#e6db74">&#34;AttachPayloadKDF&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> DECRYPT(k_nsr, <span style="color:#ae81ff">0</span>, payload_ciphertext, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;NSR payload MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process NSR payload blocks</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>process_payload_blocks(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Session established</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send ES message (implicit ACK)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>send_es_ack()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_es_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Send ES message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">!=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Session not established&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get next tag and key</span>
</span></span><span style="display:flex;"><span>        tag, index <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>outbound_keyratchet<span style="color:#f92672">.</span>get_key(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Construct nonce</span>
</span></span><span style="display:flex;"><span>        nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build payload blocks</span>
</span></span><span style="display:flex;"><span>        payload_data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>build_es_payload(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># AEAD encryption</span>
</span></span><span style="display:flex;"><span>        ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, payload_data, tag)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Assemble message</span>
</span></span><span style="display:flex;"><span>        es_message <span style="color:#f92672">=</span> tag <span style="color:#f92672">+</span> ciphertext
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send</span>
</span></span><span style="display:flex;"><span>        send_to_network(self<span style="color:#f92672">.</span>destination, es_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update activity</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if ratchet needed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>should_ratchet():
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>initiate_ratchet()
</span></span></code></pre></div><h3 id="수신기-구현">수신기 구현</h3>
<p><strong>인바운드 세션 라이프사이클:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Keys</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>remote_ephemeral_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>remote_static_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Tagsets</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Timing</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Paired session</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>paired_outbound <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">try_decrypt_ns</span>(message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Attempt to decrypt as NS message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Parse NS structure</span>
</span></span><span style="display:flex;"><span>        elg2_ephemeral <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">32</span>]
</span></span><span style="display:flex;"><span>        static_ciphertext <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">80</span>]  <span style="color:#75715e"># 32 + 16</span>
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">80</span>:]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decode ephemeral key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            alice_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(elg2_ephemeral)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Not a valid Elligator2 encoding</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check replay</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_replay(alice_ephemeral):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># KDF initialization</span>
</span></span><span style="display:flex;"><span>        chainKey, h <span style="color:#f92672">=</span> initialize_kdf()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix keys</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> alice_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># es DH</span>
</span></span><span style="display:flex;"><span>        es_shared <span style="color:#f92672">=</span> DH(context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>private_key, alice_ephemeral)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, es_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_static <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt static key section</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            static_data <span style="color:#f92672">=</span> DECRYPT(k_static, <span style="color:#ae81ff">0</span>, static_ciphertext, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Not a valid NS message</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> static_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if bound or unbound</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> static_data <span style="color:#f92672">==</span> bytes(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Unbound</span>
</span></span><span style="display:flex;"><span>            alice_static_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> k_static
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Bound - perform ss DH</span>
</span></span><span style="display:flex;"><span>            alice_static_key <span style="color:#f92672">=</span> static_data
</span></span><span style="display:flex;"><span>            ss_shared <span style="color:#f92672">=</span> DH(context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>private_key, alice_static_key)
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(chainKey, ss_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt payload</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> DECRYPT(k_payload, nonce, payload_ciphertext, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> payload_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create session</span>
</span></span><span style="display:flex;"><span>        session <span style="color:#f92672">=</span> InboundSession()
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>remote_ephemeral_key <span style="color:#f92672">=</span> alice_ephemeral
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>remote_static_key <span style="color:#f92672">=</span> alice_static_key
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> (alice_static_key <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>ns_chainkey <span style="color:#f92672">=</span> chainKey
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>ns_hash <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Extract destination if bound</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>bound:
</span></span><span style="display:flex;"><span>            session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> extract_destination_from_payload(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process payload</span>
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>process_payload_blocks(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> session
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_nsr_reply</span>(self, reply_payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Send NSR message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate NSR tagset</span>
</span></span><span style="display:flex;"><span>        tagsetKey <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>ns_chainkey, ZEROLEN, <span style="color:#e6db74">&#34;SessionReplyTags&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        nsr_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(self<span style="color:#f92672">.</span>ns_chainkey, tagsetKey)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get tag</span>
</span></span><span style="display:flex;"><span>        tag, _ <span style="color:#f92672">=</span> nsr_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix tag into hash</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(self<span style="color:#f92672">.</span>ns_hash <span style="color:#f92672">||</span> tag)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate ephemeral key</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>        bob_ephemeral <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>        elg2_bob_ephemeral <span style="color:#f92672">=</span> ENCODE_ELG2(bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix ephemeral key</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>ns_chainkey
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ee DH</span>
</span></span><span style="display:flex;"><span>        ee_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                      self<span style="color:#f92672">.</span>remote_ephemeral_key)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ee_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># se DH</span>
</span></span><span style="display:flex;"><span>        se_shared <span style="color:#f92672">=</span> DH(context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                      self<span style="color:#f92672">.</span>remote_ephemeral_key)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, se_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_key_section <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt key section (empty)</span>
</span></span><span style="display:flex;"><span>        key_section_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_key_section, <span style="color:#ae81ff">0</span>, ZEROLEN, h)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> key_section_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Split for bidirectional ES</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        k_ab <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Alice → Bob</span>
</span></span><span style="display:flex;"><span>        k_ba <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Bob → Alice</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize ES tagsets</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ab)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ba)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build reply payload</span>
</span></span><span style="display:flex;"><span>        payload_data <span style="color:#f92672">=</span> build_payload_blocks(reply_payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt payload</span>
</span></span><span style="display:flex;"><span>        k_nsr <span style="color:#f92672">=</span> HKDF(k_ba, ZEROLEN, <span style="color:#e6db74">&#34;AttachPayloadKDF&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_nsr, <span style="color:#ae81ff">0</span>, payload_data, h)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Assemble NSR</span>
</span></span><span style="display:flex;"><span>        nsr_message <span style="color:#f92672">=</span> tag <span style="color:#f92672">+</span> elg2_bob_ephemeral <span style="color:#f92672">+</span> key_section_ciphertext <span style="color:#f92672">+</span> payload_ciphertext
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send</span>
</span></span><span style="display:flex;"><span>        send_to_network(self<span style="color:#f92672">.</span>destination, nsr_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Wait for ES</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>AWAITING_ES
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_es_received</span>(self, es_message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Process first ES message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>AWAITING_ES:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># First ES received, confirms session</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process ES message</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>process_es_message(es_message)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_es_message</span>(self, es_message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Decrypt and process ES message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Extract tag</span>
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> es_message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>        ciphertext <span style="color:#f92672">=</span> es_message[<span style="color:#ae81ff">8</span>:]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Look up tag</span>
</span></span><span style="display:flex;"><span>        index <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>lookup_tag(tag)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Tag not found&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get key</span>
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>inbound_keyratchet<span style="color:#f92672">.</span>get_key(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Construct nonce</span>
</span></span><span style="display:flex;"><span>        nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> DECRYPT(key, nonce, ciphertext, tag)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;ES MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process blocks</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>process_payload_blocks(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update activity</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span></code></pre></div><h3 id="메시지-분류">메시지 분류</h3>
<p><strong>메시지 유형 구분:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">classify_message</span>(message):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Determine message type&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Minimum lengths</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">24</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Too short</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for session tag (8 bytes)</span>
</span></span><span style="display:flex;"><span>    tag <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Try ES decryption first (most common)</span>
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> lookup_session_by_tag(tag)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;ES&#39;</span>, session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Try NSR decryption (tag + Elligator2 key)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">72</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if bytes 8-40 are valid Elligator2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            nsr_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(message[<span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">40</span>])
</span></span><span style="display:flex;"><span>            nsr_session <span style="color:#f92672">=</span> find_pending_nsr_by_tag(tag)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> nsr_session:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;NSR&#39;</span>, nsr_session)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Try NS decryption (starts with Elligator2 key)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">96</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            ns_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">32</span>])
</span></span><span style="display:flex;"><span>            ns_session <span style="color:#f92672">=</span> InboundSession<span style="color:#f92672">.</span>try_decrypt_ns(message)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ns_session:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;NS&#39;</span>, ns_session)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check ElGamal/AES (for dual-key compatibility)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">514</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (len(message) <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Might be ElGamal NS</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;ELGAMAL_NS&#39;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> len(message) <span style="color:#f92672">%</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Might be ElGamal ES</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;ELGAMAL_ES&#39;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Unknown message type</span>
</span></span></code></pre></div><h3 id="세션-관리-모범-사례">세션 관리 모범 사례</h3>
<p><strong>세션 저장소:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SessionKeyManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Outbound sessions (one per destination)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_sessions <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># destination -&gt; OutboundSession</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Inbound sessions (multiple per destination during transition)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions <span style="color:#f92672">=</span> []  <span style="color:#75715e"># [InboundSession]</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Session tag lookup (fast path for ES messages)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tag_to_session <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># tag -&gt; InboundSession</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Limits</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_inbound_sessions <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tags_per_session <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_outbound_session</span>(self, destination):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get or create outbound session&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> destination <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>outbound_sessions:
</span></span><span style="display:flex;"><span>            session <span style="color:#f92672">=</span> OutboundSession(destination)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>outbound_sessions[destination] <span style="color:#f92672">=</span> session
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>outbound_sessions[destination]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_inbound_session</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Add new inbound session&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check limits</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(self<span style="color:#f92672">.</span>inbound_sessions) <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_inbound_sessions:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>expire_oldest_session()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions<span style="color:#f92672">.</span>append(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add tags to lookup table</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>register_session_tags(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_session_tags</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Register session&#39;s tags in lookup table&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>get_all_tags():
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>tag_to_session[tag] <span style="color:#f92672">=</span> session
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lookup_tag</span>(self, tag):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Fast tag lookup&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>tag_to_session<span style="color:#f92672">.</span>get(tag)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">expire_sessions</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Periodic session expiration&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        now_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire outbound sessions</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> dest, session <span style="color:#f92672">in</span> list(self<span style="color:#f92672">.</span>outbound_sessions<span style="color:#f92672">.</span>items()):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time(now_time) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>outbound_sessions[dest]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire inbound sessions</span>
</span></span><span style="display:flex;"><span>        expired <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>inbound_sessions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time(now_time) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:
</span></span><span style="display:flex;"><span>                expired<span style="color:#f92672">.</span>append(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> expired:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>remove_inbound_session(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_inbound_session</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Remove inbound session and clean up tags&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions<span style="color:#f92672">.</span>remove(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Remove tags from lookup</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>get_all_tags():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tag <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>tag_to_session:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>tag_to_session[tag]
</span></span></code></pre></div><p><strong>메모리 관리:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TagMemoryManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, max_memory_kb<span style="color:#f92672">=</span><span style="color:#ae81ff">10240</span>):  <span style="color:#75715e"># 10 MB default</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_memory <span style="color:#f92672">=</span> max_memory_kb <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_memory <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tags_per_session <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>min_tags_per_session <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_tag_memory</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Calculate memory used by session tags&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        tag_count <span style="color:#f92672">=</span> len(session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>tags)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Each tag: 8 bytes (tag) + 2 bytes (index) + 32 bytes (key, optional)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># + overhead</span>
</span></span><span style="display:flex;"><span>        bytes_per_tag <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span> <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>defer_keys <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> tag_count <span style="color:#f92672">*</span> bytes_per_tag
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_pressure</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Check if under memory pressure&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>current_memory <span style="color:#f92672">&gt;</span> (self<span style="color:#f92672">.</span>max_memory <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.9</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_pressure</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Reduce memory usage when under pressure&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>check_pressure():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 1: Reduce look-ahead windows</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> all_sessions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">&gt;</span> self<span style="color:#f92672">.</span>min_tags_per_session:
</span></span><span style="display:flex;"><span>                session<span style="color:#f92672">.</span>reduce_look_ahead(self<span style="color:#f92672">.</span>min_tags_per_session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 2: Trim old tags aggressively</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> all_sessions:
</span></span><span style="display:flex;"><span>            session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>trim_behind(aggressive<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 3: Refuse new ratchets</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> all_sessions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>should_ratchet():
</span></span><span style="display:flex;"><span>                session<span style="color:#f92672">.</span>defer_ratchet <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 4: Expire idle sessions early</span>
</span></span><span style="display:flex;"><span>        expire_idle_sessions(threshold<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span>)  <span style="color:#75715e"># 5 min instead of 10</span>
</span></span></code></pre></div><h3 id="테스트-전략">테스트 전략</h3>
<p><strong>단위 테스트:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_x25519_dh</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test X25519 key exchange&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    alice_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    alice_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(alice_sk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    bob_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    bob_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(bob_sk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Both sides compute same shared secret</span>
</span></span><span style="display:flex;"><span>    alice_shared <span style="color:#f92672">=</span> DH(alice_sk, bob_pk)
</span></span><span style="display:flex;"><span>    bob_shared <span style="color:#f92672">=</span> DH(bob_sk, alice_pk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> alice_shared <span style="color:#f92672">==</span> bob_shared
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_elligator2_encode_decode</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test Elligator2 roundtrip&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    sk <span style="color:#f92672">=</span> GENERATE_PRIVATE_ELG2()
</span></span><span style="display:flex;"><span>    pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(sk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    encoded <span style="color:#f92672">=</span> ENCODE_ELG2(pk)
</span></span><span style="display:flex;"><span>    decoded <span style="color:#f92672">=</span> DECODE_ELG2(encoded)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> decoded <span style="color:#f92672">==</span> pk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_chacha_poly_encrypt_decrypt</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test ChaCha20-Poly1305 AEAD&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> construct_nonce(<span style="color:#ae81ff">42</span>)
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello, I2P!&#34;</span>
</span></span><span style="display:flex;"><span>    ad <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;associated_data&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext, ad)
</span></span><span style="display:flex;"><span>    decrypted <span style="color:#f92672">=</span> DECRYPT(key, nonce, ciphertext, ad)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> decrypted <span style="color:#f92672">==</span> plaintext
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_session_tag_ratchet</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test session tag generation&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    sessTag_ck <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    tagset <span style="color:#f92672">=</span> SessionTagRatchet(sessTag_ck)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate 100 tags</span>
</span></span><span style="display:flex;"><span>    tags <span style="color:#f92672">=</span> [tagset<span style="color:#f92672">.</span>get_next_tag() <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>)]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># All tags should be unique</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> len(set(tags)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Each tag should be 8 bytes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> tags:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(tag) <span style="color:#f92672">==</span> <span style="color:#ae81ff">8</span>
</span></span></code></pre></div><p><strong>통합 테스트:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_ns_nsr_handshake</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test NS/NSR handshake&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice creates outbound session</span>
</span></span><span style="display:flex;"><span>    alice_session <span style="color:#f92672">=</span> OutboundSession(bob_destination, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice sends NS</span>
</span></span><span style="display:flex;"><span>    ns_message <span style="color:#f92672">=</span> alice_session<span style="color:#f92672">.</span>build_ns_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello Bob&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob receives NS</span>
</span></span><span style="display:flex;"><span>    bob_session <span style="color:#f92672">=</span> InboundSession<span style="color:#f92672">.</span>try_decrypt_ns(ns_message)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> bob_session <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> bob_session<span style="color:#f92672">.</span>bound <span style="color:#f92672">==</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob sends NSR</span>
</span></span><span style="display:flex;"><span>    nsr_message <span style="color:#f92672">=</span> bob_session<span style="color:#f92672">.</span>build_nsr_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello Alice&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice receives NSR</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>on_nsr_received(nsr_message)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> alice_session<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Both should have matching ES tagsets</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># (Cannot directly compare, but can test by sending ES messages)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_es_bidirectional</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test ES messages in both directions&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># (After NS/NSR handshake)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice sends ES to Bob</span>
</span></span><span style="display:flex;"><span>    es_alice_to_bob <span style="color:#f92672">=</span> alice_session<span style="color:#f92672">.</span>send_es_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Data from Alice&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob receives ES</span>
</span></span><span style="display:flex;"><span>    bob_session<span style="color:#f92672">.</span>process_es_message(es_alice_to_bob)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob sends ES to Alice</span>
</span></span><span style="display:flex;"><span>    es_bob_to_alice <span style="color:#f92672">=</span> bob_session<span style="color:#f92672">.</span>send_es_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Data from Bob&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice receives ES</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>process_es_message(es_bob_to_alice)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_dh_ratchet</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test DH ratchet&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># (After established session)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice initiates ratchet</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>initiate_ratchet()
</span></span><span style="display:flex;"><span>    nextkey_alice <span style="color:#f92672">=</span> build_nextkey_block(
</span></span><span style="display:flex;"><span>        flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>,
</span></span><span style="display:flex;"><span>        key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        public_key<span style="color:#f92672">=</span>alice_new_key
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send to Bob</span>
</span></span><span style="display:flex;"><span>    bob_session<span style="color:#f92672">.</span>process_nextkey_block(nextkey_alice)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob replies</span>
</span></span><span style="display:flex;"><span>    nextkey_bob <span style="color:#f92672">=</span> build_nextkey_block(
</span></span><span style="display:flex;"><span>        flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>,
</span></span><span style="display:flex;"><span>        key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        public_key<span style="color:#f92672">=</span>bob_new_key
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send to Alice</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>process_nextkey_block(nextkey_bob)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Both should now be using new tagsets</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> alice_session<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> bob_session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>테스트 벡터:</strong></p>
<p>명세에 따른 테스트 벡터 구현:</p>
<ol>
<li><strong>Noise IK Handshake</strong> (Noise 프로토콜의 IK 핸드셰이크): 표준 Noise 테스트 벡터를 사용</li>
<li><strong>HKDF</strong> (HMAC 기반 키 유도 함수): RFC 5869 테스트 벡터를 사용</li>
<li><strong>ChaCha20-Poly1305</strong> (ChaCha20 스트림 암호와 Poly1305 인증을 결합한 AEAD 알고리즘): RFC 7539 테스트 벡터를 사용</li>
<li><strong>Elligator2</strong> (타원곡선 공개키를 균일 분포처럼 위장하는 매핑): Elligator2 논문 또는 OBFS4의 테스트 벡터를 사용</li>
</ol>
<p><strong>상호운용성 테스트:</strong></p>
<ol>
<li><strong>Java I2P</strong>: Java I2P 참조 구현을 대상으로 테스트</li>
<li><strong>i2pd</strong>: C++ i2pd 구현을 대상으로 테스트</li>
<li><strong>패킷 캡처</strong>: Wireshark dissector(프로토콜 해석기)를 사용해 메시지 형식을 검증(가능한 경우)</li>
<li><strong>교차 구현</strong>: 서로 다른 구현 간 송수신이 가능한 테스트 하네스를 구축</li>
</ol>
<h3 id="성능-고려-사항">성능 고려 사항</h3>
<p><strong>키 생성:</strong></p>
<p>Elligator2(키를 무작위 바이트처럼 보이게 인코딩하는 기법) 키 생성은 연산 비용이 큽니다(거부율 50%):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KeyPool</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Pre-generate keys in background thread&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, pool_size<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pool <span style="color:#f92672">=</span> Queue(maxsize<span style="color:#f92672">=</span>pool_size)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>generator_thread <span style="color:#f92672">=</span> Thread(target<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>generate_keys, daemon<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>generator_thread<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_keys</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>full():
</span></span><span style="display:flex;"><span>                keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Also compute encoded form</span>
</span></span><span style="display:flex;"><span>                encoded <span style="color:#f92672">=</span> ENCODE_ELG2(keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>put((keypair, encoded))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_keypair</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>get(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1.0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> Empty:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Pool exhausted, generate inline</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> generate_elg2_keypair()
</span></span></code></pre></div><p><strong>태그 조회:</strong></p>
<p>O(1) 태그 조회를 위해 해시 테이블을 사용하십시오:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FastTagLookup</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tag_to_session <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Python dict is hash table</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_tag</span>(self, tag, session, index):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 8-byte tag as bytes is hashable</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tag_to_session[tag] <span style="color:#f92672">=</span> (session, index)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lookup_tag</span>(self, tag):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>tag_to_session<span style="color:#f92672">.</span>get(tag)
</span></span></code></pre></div><p><strong>메모리 최적화:</strong></p>
<p>대칭 키 생성 연기:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DeferredKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Only generate keys when needed&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cache <span style="color:#f92672">=</span> LRUCache(maxsize<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># Cache recent keys</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check cache first</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>cache:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>cache[index]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate keys up to index</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&lt;</span> index:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">==</span> index:
</span></span><span style="display:flex;"><span>                key <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>cache[index] <span style="color:#f92672">=</span> key
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> key
</span></span></code></pre></div><p><strong>배치 처리:</strong></p>
<p>여러 메시지를 일괄 처리:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_message_batch</span>(messages):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Process multiple messages efficiently&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    results <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Group by type</span>
</span></span><span style="display:flex;"><span>    ns_messages <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    nsr_messages <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    es_messages <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> messages:
</span></span><span style="display:flex;"><span>        msg_type <span style="color:#f92672">=</span> classify_message(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> msg_type[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;NS&#39;</span>:
</span></span><span style="display:flex;"><span>            ns_messages<span style="color:#f92672">.</span>append(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> msg_type[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;NSR&#39;</span>:
</span></span><span style="display:flex;"><span>            nsr_messages<span style="color:#f92672">.</span>append(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> msg_type[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ES&#39;</span>:
</span></span><span style="display:flex;"><span>            es_messages<span style="color:#f92672">.</span>append(msg)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Process in batches</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ES messages are most common, process first</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> es_messages:
</span></span><span style="display:flex;"><span>        results<span style="color:#f92672">.</span>append(process_es_message(msg))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> nsr_messages:
</span></span><span style="display:flex;"><span>        results<span style="color:#f92672">.</span>append(process_nsr_message(msg))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> ns_messages:
</span></span><span style="display:flex;"><span>        results<span style="color:#f92672">.</span>append(process_ns_message(msg))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> results
</span></span></code></pre></div><hr>
<h2 id="보안-고려사항">보안 고려사항</h2>
<h3 id="위협-모델">위협 모델</h3>
<p><strong>공격자의 능력:</strong></p>
<ol>
<li><strong>수동 관찰자</strong>: 모든 네트워크 트래픽을 관찰할 수 있음</li>
<li><strong>능동 공격자</strong>: 메시지를 삽입, 수정, 드롭(폐기), 재전송(리플레이)할 수 있음</li>
<li><strong>침해된 노드</strong>: router 또는 목적지를 침해할 수 있음</li>
<li><strong>트래픽 분석</strong>: 트래픽 패턴에 대한 통계적 분석을 수행할 수 있음</li>
</ol>
<p><strong>보안 목표:</strong></p>
<ol>
<li><strong>기밀성</strong>: 관찰자가 메시지 내용을 볼 수 없음</li>
<li><strong>인증</strong>: 발신자 신원 검증 (바운드 세션의 경우)</li>
<li><strong>전방향 기밀성</strong>: 키가 유출되더라도 과거 메시지는 비밀로 유지됨</li>
<li><strong>재생 공격 방지</strong>: 이전 메시지를 재전송할 수 없음</li>
<li><strong>트래픽 난독화</strong>: 핸드셰이크가 무작위 데이터와 구분되지 않음</li>
</ol>
<h3 id="암호학적-가정">암호학적 가정</h3>
<p><strong>계산적 난이도 가정:</strong></p>
<ol>
<li><strong>X25519 CDH</strong>: Curve25519에서 계산적 디피-헬만 문제는 풀기 어렵다</li>
<li><strong>ChaCha20 PRF</strong>: ChaCha20은 의사난수 함수(PRF)이다</li>
<li><strong>Poly1305 MAC</strong>: Poly1305는 선택 메시지 공격에 대해 위조가 불가능하다</li>
<li><strong>SHA-256 CR</strong>: SHA-256은 충돌 저항성을 가진다</li>
<li><strong>HKDF Security</strong>: HKDF는 키를 추출하고 균일한 분포의 키로 확장한다</li>
</ol>
<p><strong>보안 수준:</strong></p>
<ul>
<li><strong>X25519</strong>: ~128비트 보안 강도 (곡선의 차수 2^252)</li>
<li><strong>ChaCha20</strong>: 256비트 키, 256비트 보안 강도</li>
<li><strong>Poly1305</strong>: 128비트 보안 강도 (충돌 확률 기준)</li>
<li><strong>SHA-256</strong>: 128비트 충돌 저항성, 256비트 전이미지 저항성</li>
</ul>
<h3 id="키-관리">키 관리</h3>
<p><strong>키 생성:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Use cryptographically secure RNG</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">CSRNG</span>(length):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># GOOD: os.urandom, secrets.token_bytes (Python)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># GOOD: /dev/urandom (Linux)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># GOOD: BCryptGenRandom (Windows)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># BAD: random.random(), Math.random() (NOT cryptographically secure)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> os<span style="color:#f92672">.</span>urandom(length)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Validate keys</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_x25519_key</span>(pubkey):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for weak keys (all zeros, small order points)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> pubkey <span style="color:#f92672">==</span> bytes(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> WeakKeyError(<span style="color:#e6db74">&#34;All-zero public key&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform DH to check for weak shared secrets</span>
</span></span><span style="display:flex;"><span>    test_shared <span style="color:#f92672">=</span> DH(test_private_key, pubkey)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> test_shared <span style="color:#f92672">==</span> bytes(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> WeakKeyError(<span style="color:#e6db74">&#34;Results in zero shared secret&#34;</span>)
</span></span></code></pre></div><p><strong>키 저장소:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Protect private keys</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecureKeyStorage</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Store in memory with protection</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>keys <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Option 1: Memory locking (prevent swapping to disk)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># mlock(self.keys)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Option 2: Encrypted storage</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># self.encryption_key = derive_from_password()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">store_key</span>(self, key_id, private_key):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Option: Encrypt before storage</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># encrypted = encrypt(private_key, self.encryption_key)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># self.keys[key_id] = encrypted</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>keys[key_id] <span style="color:#f92672">=</span> private_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_key</span>(self, key_id):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Securely wipe memory</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> key_id <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>keys:
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>keys[key_id]
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Overwrite with zeros before deletion</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(key)):
</span></span><span style="display:flex;"><span>                key[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>keys[key_id]
</span></span></code></pre></div><p><strong>키 로테이션:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Rotate keys regularly</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KeyRotationPolicy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_messages_per_tagset <span style="color:#f92672">=</span> <span style="color:#ae81ff">4096</span>  <span style="color:#75715e"># Ratchet before 65535</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tagset_age <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>       <span style="color:#75715e"># 10 minutes</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_session_age <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>      <span style="color:#75715e"># 1 hour</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">should_ratchet</span>(self, tagset):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (tagset<span style="color:#f92672">.</span>messages_sent <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_messages_per_tagset <span style="color:#f92672">or</span>
</span></span><span style="display:flex;"><span>                tagset<span style="color:#f92672">.</span>age() <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_tagset_age)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">should_replace_session</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> session<span style="color:#f92672">.</span>age() <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_session_age
</span></span></code></pre></div><h3 id="공격-완화-대책">공격 완화 대책</h3>
<h3 id="재전송-공격-완화-기법">재전송 공격 완화 기법</h3>
<p><strong>DateTime(날짜/시간) 유효성 검사:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>MAX_CLOCK_SKEW_PAST <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>MAX_CLOCK_SKEW_FUTURE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_datetime</span>(timestamp):
</span></span><span style="display:flex;"><span>    now <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span>    age <span style="color:#f92672">=</span> now <span style="color:#f92672">-</span> timestamp
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span>MAX_CLOCK_SKEW_FUTURE:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> ReplayError(<span style="color:#e6db74">&#34;Timestamp too far in future&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&gt;</span> MAX_CLOCK_SKEW_PAST:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> ReplayError(<span style="color:#e6db74">&#34;Timestamp too old&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><p><strong>NS 메시지용 블룸 필터:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReplayFilter</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, capacity<span style="color:#f92672">=</span><span style="color:#ae81ff">100000</span>, error_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>, duration<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bloom <span style="color:#f92672">=</span> BloomFilter(capacity<span style="color:#f92672">=</span>capacity, error_rate<span style="color:#f92672">=</span>error_rate)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>duration <span style="color:#f92672">=</span> duration
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>entries <span style="color:#f92672">=</span> []  <span style="color:#75715e"># (timestamp, ephemeral_key)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_replay</span>(self, ephemeral_key, timestamp):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Validate timestamp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> validate_datetime(timestamp):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check Bloom filter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ephemeral_key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>bloom:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Potential replay (or false positive)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Check exact match in entries</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> ts, key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>entries:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> key <span style="color:#f92672">==</span> ephemeral_key:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Definite replay</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add to filter</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bloom<span style="color:#f92672">.</span>add(ephemeral_key)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>entries<span style="color:#f92672">.</span>append((timestamp, ephemeral_key))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire old entries</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>expire_old_entries()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">expire_old_entries</span>(self):
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>entries <span style="color:#f92672">=</span> [(ts, key) <span style="color:#66d9ef">for</span> ts, key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>entries
</span></span><span style="display:flex;"><span>                       <span style="color:#66d9ef">if</span> now <span style="color:#f92672">-</span> ts <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>duration]
</span></span></code></pre></div><p><strong>Session Tag(세션 태그) 일회성 사용:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_session_tag</span>(tag):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Look up tag</span>
</span></span><span style="display:flex;"><span>    entry <span style="color:#f92672">=</span> tagset<span style="color:#f92672">.</span>lookup_tag(tag)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> entry <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Invalid session tag&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># CRITICAL: Remove tag immediately (one-time use)</span>
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>remove_tag(tag)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Use associated key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> entry<span style="color:#f92672">.</span>key, entry<span style="color:#f92672">.</span>index
</span></span></code></pre></div><h3 id="key-compromise-impersonation-kci-키-손상-가장-공격-완화-방안">Key Compromise Impersonation (KCI, 키 손상 가장 공격) 완화 방안</h3>
<p><strong>문제</strong>: NS 메시지 인증은 KCI(키 손상 사칭 공격)에 취약함 (인증 수준 1)</p>
<p><strong>완화 조치</strong>:</p>
<ol>
<li>가능한 한 빨리 NSR(인증 레벨 2)로 전환하세요</li>
<li>보안에 민감한 작업에서는 NS 페이로드를 신뢰하지 마세요</li>
<li>되돌릴 수 없는 작업을 수행하기 전에 NSR 확인을 기다리세요</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_ns_message</span>(ns_message):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># NS authenticated at Level 1 (KCI vulnerable)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Do NOT perform security-critical operations yet</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract sender&#39;s static key</span>
</span></span><span style="display:flex;"><span>    sender_key <span style="color:#f92672">=</span> ns_message<span style="color:#f92672">.</span>static_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Mark session as pending Level 2 authentication</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>auth_level <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>sender_key <span style="color:#f92672">=</span> sender_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send NSR</span>
</span></span><span style="display:flex;"><span>    send_nsr_reply(session)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_first_es_message</span>(es_message):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Now we have Level 2 authentication (KCI resistant)</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>auth_level <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Safe to perform security-critical operations</span>
</span></span><span style="display:flex;"><span>    process_security_critical_operation(es_message)
</span></span></code></pre></div><h3 id="서비스-거부dos-완화-대책">서비스 거부(DoS) 완화 대책</h3>
<p><strong>NS 플러딩 방지:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NSFloodProtection</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_count <span style="color:#f92672">=</span> defaultdict(int)  <span style="color:#75715e"># source -&gt; count</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timestamps <span style="color:#f92672">=</span> defaultdict(list)  <span style="color:#75715e"># source -&gt; [timestamps]</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_ns_per_source <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>rate_window <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># seconds</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_concurrent_ns <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_ns_allowed</span>(self, source):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Global limit</span>
</span></span><span style="display:flex;"><span>        total_pending <span style="color:#f92672">=</span> sum(self<span style="color:#f92672">.</span>ns_count<span style="color:#f92672">.</span>values())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> total_pending <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_concurrent_ns:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Per-source rate limit</span>
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        timestamps <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>ns_timestamps[source]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Remove old timestamps</span>
</span></span><span style="display:flex;"><span>        timestamps <span style="color:#f92672">=</span> [ts <span style="color:#66d9ef">for</span> ts <span style="color:#f92672">in</span> timestamps <span style="color:#66d9ef">if</span> now <span style="color:#f92672">-</span> ts <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>rate_window]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timestamps[source] <span style="color:#f92672">=</span> timestamps
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check rate</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(timestamps) <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_ns_per_source:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Allow NS</span>
</span></span><span style="display:flex;"><span>        timestamps<span style="color:#f92672">.</span>append(now)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_count[source] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_session_established</span>(self, source):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrease pending count</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>ns_count[source] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>ns_count[source] <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>태그 저장 제한:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TagStorageLimit</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, max_tags<span style="color:#f92672">=</span><span style="color:#ae81ff">1000000</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tags <span style="color:#f92672">=</span> max_tags
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">can_create_session</span>(self, look_ahead):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">+</span> look_ahead <span style="color:#f92672">&gt;</span> self<span style="color:#f92672">.</span>max_tags:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_tags</span>(self, count):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">+=</span> count
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_tags</span>(self, count):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">-=</span> count
</span></span></code></pre></div><p><strong>적응형 자원 관리:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AdaptiveResourceManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>  <span style="color:#75715e"># 0 = low, 1 = medium, 2 = high, 3 = critical</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">adjust_parameters</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Normal operation</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">160</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Moderate load</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">80</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">800</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># High load</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">32</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">500</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:  <span style="color:#75715e"># load_level == 3</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Critical load</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">16</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span></code></pre></div><h3 id="트래픽-분석-저항성">트래픽 분석 저항성</h3>
<p><strong>Elligator2 Encoding(엘리게이터2 인코딩):</strong></p>
<p>핸드셰이크 메시지가 무작위 데이터와 구분되지 않도록 보장합니다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># NS and NSR start with Elligator2-encoded ephemeral keys</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Observer cannot distinguish from random 32-byte string</span>
</span></span></code></pre></div><p><strong>패딩 전략:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Resist message size fingerprinting</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_padding</span>(payload, strategy<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;random&#39;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> strategy <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;random&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Random padding 0-15 bytes</span>
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">15</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> strategy <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;round&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Round to next 64-byte boundary</span>
</span></span><span style="display:flex;"><span>        target <span style="color:#f92672">=</span> ((len(payload) <span style="color:#f92672">+</span> <span style="color:#ae81ff">63</span>) <span style="color:#f92672">//</span> <span style="color:#ae81ff">64</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> target <span style="color:#f92672">-</span> len(payload) <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>  <span style="color:#75715e"># -3 for block header</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> strategy <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;fixed&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Always 1KB messages</span>
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">-</span> len(payload) <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> build_padding_block(size)
</span></span></code></pre></div><p><strong>타이밍 공격:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Use constant-time operations</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">constant_time_compare</span>(a, b):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Constant-time byte string comparison&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(a) <span style="color:#f92672">!=</span> len(b):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x, y <span style="color:#f92672">in</span> zip(a, b):
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">|=</span> x <span style="color:#f92672">^</span> y
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Constant-time MAC verification</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">verify_mac</span>(computed_mac, received_mac):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> constant_time_compare(computed_mac, received_mac):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Always take same time regardless of where comparison fails</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> AuthenticationError(<span style="color:#e6db74">&#34;MAC verification failed&#34;</span>)
</span></span></code></pre></div><h3 id="구현상의-함정">구현상의 함정</h3>
<p><strong>일반적인 실수:</strong></p>
<ol>
<li><strong>Nonce(논스) 재사용</strong>: (key, nonce) 쌍을 절대 재사용하지 마십시오
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># BAD: Reusing nonce with same key</span>
</span></span><span style="display:flex;"><span>ciphertext1 <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext1, ad1)
</span></span><span style="display:flex;"><span>ciphertext2 <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext2, ad2)  <span style="color:#75715e"># CATASTROPHIC</span>
</span></span></code></pre></div></li>
</ol>
<h1 id="좋음-각-메시지마다-고유한-nonce논스-한-번만-사용하는-임의값----ciphertext1--encryptkey-nonce1-plaintext1-ad1----ciphertext2--encryptkey-nonce2-plaintext2-ad2">좋음: 각 메시지마다 고유한 nonce(논스: 한 번만 사용하는 임의값)    ciphertext1 = ENCRYPT(key, nonce1, plaintext1, ad1)    ciphertext2 = ENCRYPT(key, nonce2, plaintext2, ad2)</h1>
<pre tabindex="0"><code>
2. **Ephemeral Key Reuse**: Generate fresh ephemeral key for each NS/NSR
```python
# 나쁨: 임시 키 재사용    ephemeral_key = generate_elg2_keypair()    send_ns_message(ephemeral_key)    send_ns_message(ephemeral_key)  # 나쁨

# 좋음: 각 메시지마다 새 키    send_ns_message(generate_elg2_keypair())    send_ns_message(generate_elg2_keypair())
</code></pre><ol start="3">
<li><strong>Weak RNG</strong>: Use cryptographically secure random number generator
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div></li>
</ol>
<h1 id="나쁨-비암호학적-난수-생성기----import-random----key--bytesrandomrandint0-255-for-_-in-range32---안전하지-않음">나쁨: 비암호학적 난수 생성기    import random    key = bytes([random.randint(0, 255) for _ in range(32)])  # 안전하지 않음</h1>
<h1 id="좋음-암호학적으로-안전한-rng난수-생성기----import-os----key--osurandom32">좋음: 암호학적으로 안전한 RNG(난수 생성기)    import os    key = os.urandom(32)</h1>
<pre tabindex="0"><code>
4. **Timing Attacks**: Use constant-time comparisons
```python
# 나쁨: Early-exit(조기 종료) 비교    if computed_mac == received_mac:  # 타이밍 누출

    pass

# 좋음: 상수 시간 비교    if constant_time_compare(computed_mac, received_mac):

    pass
</code></pre><ol start="5">
<li><strong>Incomplete MAC Verification</strong>: Always verify before using data
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div></li>
</ol>
<h1 id="나쁜-예-검증-전에-복호화----plaintext--chacha20_decryptkey-nonce-ciphertext----mac_ok--verify_macmac-plaintext---너무-늦음----if-not-mac_ok">나쁜 예: 검증 전에 복호화    plaintext = chacha20_decrypt(key, nonce, ciphertext)    mac_ok = verify_mac(mac, plaintext)  # 너무 늦음    if not mac_ok:</h1>
<pre><code>   return error
</code></pre>
<h1 id="좋음-aead부가-데이터가-있는-인증-암호화는-복호화하기-전에-검증한다----try">좋음: AEAD(부가 데이터가 있는 인증 암호화)는 복호화하기 전에 검증한다    try:</h1>
<pre><code>   plaintext = DECRYPT(key, nonce, ciphertext, ad)  # Verifies MAC first
</code></pre>
<p>except AuthenticationError:</p>
<pre><code>   return error
</code></pre>
<pre tabindex="0"><code>
6. **Key Deletion**: Securely wipe keys from memory
```python
# 나쁨: 단순 삭제    del private_key  # 아직 메모리에 남아 있음

# 권장: 삭제 전에 덮어쓰기    for i in range(len(private_key)):

    private_key[i] = 0
del private_key
</code></pre><h3 id="security-audits">Security Audits</h3>
<p><strong>Recommended Audits:</strong></p>
<ol>
<li><strong>Cryptographic Review</strong>: Expert review of KDF chains and DH operations</li>
<li><strong>Implementation Audit</strong>: Code review for timing attacks, key management, RNG usage</li>
<li><strong>Protocol Analysis</strong>: Formal verification of handshake security properties</li>
<li><strong>Side-Channel Analysis</strong>: Timing, power, and cache attacks</li>
<li><strong>Fuzzing</strong>: Random input testing for parser robustness</li>
</ol>
<p><strong>Test Cases:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 보안상 중요한 테스트 케이스</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_nonce_uniqueness</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure nonces are never reused&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    nonces <span style="color:#f92672">=</span> set()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10000</span>):
</span></span><span style="display:flex;"><span>        nonce <span style="color:#f92672">=</span> construct_nonce(i)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> nonce <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> nonces
</span></span><span style="display:flex;"><span>        nonces<span style="color:#f92672">.</span>add(nonce)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_key_isolation</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure sessions don&#39;t share keys&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    session1 <span style="color:#f92672">=</span> create_session(destination1)
</span></span><span style="display:flex;"><span>    session2 <span style="color:#f92672">=</span> create_session(destination2)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> session1<span style="color:#f92672">.</span>key <span style="color:#f92672">!=</span> session2<span style="color:#f92672">.</span>key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_replay_prevention</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure replay attacks are detected&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    ns_message <span style="color:#f92672">=</span> create_ns_message()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># First delivery succeeds</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> process_ns_message(ns_message) <span style="color:#f92672">==</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Replay fails</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> process_ns_message(ns_message) <span style="color:#f92672">==</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_mac_verification</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure MAC verification is enforced&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> construct_nonce(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>    ad <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;test_ad&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext, ad)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Correct MAC verifies</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> DECRYPT(key, nonce, ciphertext, ad) <span style="color:#f92672">==</span> plaintext
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Corrupted MAC fails</span>
</span></span><span style="display:flex;"><span>    corrupted <span style="color:#f92672">=</span> ciphertext[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> bytes([ciphertext[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">^</span> <span style="color:#ae81ff">0xFF</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> pytest<span style="color:#f92672">.</span>raises(AuthenticationError):
</span></span><span style="display:flex;"><span>        DECRYPT(key, nonce, corrupted, ad)
</span></span></code></pre></div><hr>
<h2 id="configuration-and-deployment">Configuration and Deployment</h2>
<h3 id="i2cp-configuration">I2CP Configuration</h3>
<p><strong>Enable ECIES Encryption:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># ECIES(타원곡선 통합 암호화 방식) 전용(신규 배포에 권장)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 이중 키 (ECIES + ElGamal 호환성용)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4,0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ElGamal 전용 (레거시, 권장되지 않음)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
</span></span></code></pre></div><p><strong>LeaseSet Type:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># 표준 LS2(LeaseSet2, 가장 일반적)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetType</span><span style="color:#f92672">=</span><span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 암호화된 LS2 (blinded destinations, 블라인드된 목적지)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetType</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 메타 LS2 (여러 Destination(목적지))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetType</span><span style="color:#f92672">=</span><span style="color:#e6db74">7</span>
</span></span></code></pre></div><p><strong>Additional Options:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># ECIES(타원곡선 통합 암호화 방식)용 정적 키(선택 사항, 지정하지 않으면 자동 생성)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Base64로 인코딩된 32바이트 X25519(타원 곡선 기반 키 교환 알고리즘) 공개 키</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetPrivateKey</span><span style="color:#f92672">=</span><span style="color:#e6db74">&lt;base64-encoded-key&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 서명 유형(LeaseSet용)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetSigningPrivateKey</span><span style="color:#f92672">=</span><span style="color:#e6db74">&lt;base64-encoded-key&gt; i2cp.leaseSetSigningType=7  # Ed25519</span>
</span></span></code></pre></div><h3 id="java-i2p-configuration">Java I2P Configuration</h3>
<p><strong>router.config:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># router 간 ECIES</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.useECIES</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span></code></pre></div><p><strong>Build Properties:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// I2CP 클라이언트(Java)용 Properties props = new Properties(); props.setProperty(&#34;i2cp.leaseSetEncType&#34;, &#34;4&#34;); props.setProperty(&#34;i2cp.leaseSetType&#34;, &#34;3&#34;);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>I2PSession session <span style="color:#f92672">=</span> i2pClient.<span style="color:#a6e22e">createSession</span>(props);
</span></span></code></pre></div><h3 id="i2pd-configuration">i2pd Configuration</h3>
<p><strong>i2pd.conf:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[제한]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ECIES(타원곡선 통합 암호화 방식) 세션 메모리 제한</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ecies.memory</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">128M</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[ecies]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ECIES(타원 곡선 통합 암호화 체계) 활성화</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">enabled</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ECIES(타원곡선 통합 암호화 체계) 전용 또는 이중 키</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">compatibility</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true  # true = dual-key(이중 키), false = ECIES-only(ECIES 전용)</span>
</span></span></code></pre></div><p><strong>Tunnels Configuration:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">[my-service] type</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http host = 127.0.0.1 port = 8080 keys = my-service-keys.dat</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ECIES(타원곡선 통합 암호 방식) 전용</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ecies</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span></code></pre></div><h3 id="compatibility-matrix">Compatibility Matrix</h3>
<p><strong>Router Version Support:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Version</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">ECIES Support</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">LS2 Support</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Dual-Key</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">&lt; 0.9.38</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">❌ No</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">❌ No</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Legacy only</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0.9.38-0.9.45</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">❌ No</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">LS2 only</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0.9.46-0.9.50</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial ECIES</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1.5.0+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Current</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2.0.0+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Current</td>
    </tr>
  </tbody>
</table>
<p><strong>Destination Compatibility:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Destination Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Can Connect To</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ECIES-only</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ECIES-only, Dual-key</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Requires 0.9.46+ routers</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Dual-key</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Any</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Maximum compatibility</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ElGamal-only</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ElGamal-only, Dual-key</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Legacy</td>
    </tr>
  </tbody>
</table>
<p><strong>FloodFill Requirements:</strong></p>
<ul>
<li><strong>ECIES-only destinations</strong>: Require majority of floodfills on 0.9.46+ for encrypted lookups</li>
<li><strong>Dual-key destinations</strong>: Work with any floodfill version</li>
<li><strong>Current status</strong>: Near 100% floodfill adoption as of 2025</li>
</ul>
<h3 id="migration-guide">Migration Guide</h3>
<p><strong>Migrating from ElGamal to ECIES:</strong></p>
<p><strong>Step 1: Enable Dual-Key Mode</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># ElGamal은 유지하면서 ECIES를 추가</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4,0</span>
</span></span></code></pre></div><p><strong>Step 2: Monitor Connections</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 연결 유형 확인</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>i2prouter.exe status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 또는</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http://127.0.0.1:7657/peers
</span></span></code></pre></div><p><strong>Step 3: Switch to ECIES-Only (after testing)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># ElGamal 제거</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4</span>
</span></span></code></pre></div><p><strong>Step 4: Restart Application</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># I2P router 또는 애플리케이션을 재시작</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl restart i2p
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 또는</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>i2prouter.exe restart
</span></span></code></pre></div><p><strong>Rollback Plan:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># 문제가 발생하면 ElGamal(엘가말)만 사용하도록 되돌리기</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
</span></span></code></pre></div><h3 id="performance-tuning">Performance Tuning</h3>
<p><strong>Session Limits:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># 최대 인바운드 세션 수</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.maxInboundSessions</span><span style="color:#f92672">=</span><span style="color:#e6db74">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 최대 아웃바운드 세션 수</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.maxOutboundSessions</span><span style="color:#f92672">=</span><span style="color:#e6db74">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 세션 타임아웃 (초)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.sessionTimeout</span><span style="color:#f92672">=</span><span style="color:#e6db74">600</span>
</span></span></code></pre></div><p><strong>Memory Limits:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># 태그 저장 용량 제한 (KB)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.maxTagMemory</span><span style="color:#f92672">=</span><span style="color:#e6db74">10240  # 10 MB</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 룩어헤드 윈도우</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.tagLookAhead</span><span style="color:#f92672">=</span><span style="color:#e6db74">160 i2p.ecies.tagLookAheadMin=32</span>
</span></span></code></pre></div><p><strong>Ratchet Policy:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># ratchet(키를 단계적으로 갱신하는 암호화 메커니즘) 이전의 메시지</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.ratchetThreshold</span><span style="color:#f92672">=</span><span style="color:#e6db74">4096</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 래칫까지 남은 시간(초)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.ratchetTimeout</span><span style="color:#f92672">=</span><span style="color:#e6db74">600  # 10분</span>
</span></span></code></pre></div><h3 id="monitoring-and-debugging">Monitoring and Debugging</h3>
<p><strong>Logging:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># ECIES(타원곡선 통합 암호 방식) 디버그 로깅 활성화</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">logger.i2p.router.transport.ecies</span><span style="color:#f92672">=</span><span style="color:#e6db74">DEBUG</span>
</span></span></code></pre></div><p><strong>Metrics:</strong></p>
<p>Monitor these metrics:</p>
<ol>
<li><strong>NS Success Rate</strong>: Percentage of NS messages receiving NSR</li>
<li><strong>Session Establishment Time</strong>: Time from NS to first ES</li>
<li><strong>Tag Storage Usage</strong>: Current memory usage for tags</li>
<li><strong>Ratchet Frequency</strong>: How often sessions ratchet</li>
<li><strong>Session Lifetime</strong>: Average session duration</li>
</ol>
<p><strong>Common Issues:</strong></p>
<ol>
<li>
<p><strong>NS Timeout</strong>: No NSR received</p>
<ul>
<li>Check destination is online</li>
<li>Check floodfill availability</li>
<li>Verify LeaseSet published correctly</li>
</ul>
</li>
<li>
<p><strong>High Memory Usage</strong>: Too many tags stored</p>
<ul>
<li>Reduce look-ahead window</li>
<li>Decrease session timeout</li>
<li>Implement aggressive expiration</li>
</ul>
</li>
<li>
<p><strong>Frequent Ratchets</strong>: Sessions ratcheting too often</p>
<ul>
<li>Increase ratchet threshold</li>
<li>Check for retransmissions</li>
</ul>
</li>
<li>
<p><strong>Session Failures</strong>: ES messages failing to decrypt</p>
<ul>
<li>Verify tag synchronization</li>
<li>Check for replay attacks</li>
<li>Validate nonce construction</li>
</ul>
</li>
</ol>
<hr>
<h2 id="references">References</h2>
<h3 id="specifications">Specifications</h3>
<ol>
<li><strong>ECIES Proposal</strong>: <a href="../../../../ko/proposals/144-ecies-x25519-aead-ratchet/">Proposal 144</a>
</li>
<li><strong>I2NP</strong>: <a href="../../../../ko/docs/specs/i2np/">I2NP Specification</a>
</li>
<li><strong>Common Structures</strong>: <a href="../../../../ko/docs/specs/common-structures/">Common Structures Specification</a>
</li>
<li><strong>NTCP2</strong>: <a href="../../../../ko/docs/specs/ntcp2/">NTCP2 Specification</a>
</li>
<li><strong>SSU2</strong>: <a href="../../../../ko/docs/specs/ssu2/">SSU2 Specification</a>
</li>
<li><strong>I2CP</strong>: <a href="../../../../ko/docs/specs/i2cp/">I2CP Specification</a>
</li>
<li><strong>ElGamal/AES+SessionTags</strong>: <a href="../../../../ko/docs/legacy/elgamal-aes/">ElGamal/AES Specification</a>
</li>
</ol>
<h3 id="cryptographic-standards">Cryptographic Standards</h3>
<ol>
<li><strong>Noise Protocol Framework</strong>: <a href="https://noiseprotocol.org/noise.html">Noise Specification</a>
 (Revision 34, 2018-07-11)</li>
<li><strong>Signal Double Ratchet</strong>: <a href="https://signal.org/docs/specifications/doubleratchet/">Signal Specification</a>
</li>
<li><strong>RFC 7748</strong>: <a href="https://tools.ietf.org/html/rfc7748">Elliptic Curves for Security (X25519)</a>
</li>
<li><strong>RFC 7539</strong>: <a href="https://tools.ietf.org/html/rfc7539">ChaCha20 and Poly1305 for IETF Protocols</a>
</li>
<li><strong>RFC 5869</strong>: <a href="https://tools.ietf.org/html/rfc5869">HKDF (HMAC-based Key Derivation Function)</a>
</li>
<li><strong>RFC 2104</strong>: <a href="https://tools.ietf.org/html/rfc2104">HMAC: Keyed-Hashing for Message Authentication</a>
</li>
<li><strong>Elligator2</strong>: <a href="https://elligator.cr.yp.to/elligator-20130828.pdf">Elligator Paper</a>
</li>
</ol>
<h3 id="implementation-resources">Implementation Resources</h3>
<ol>
<li><strong>Java I2P</strong>: <a href="https://github.com/i2p/i2p.i2p">i2p.i2p Repository</a>
</li>
<li><strong>i2pd (C++)</strong>: <a href="https://github.com/PurpleI2P/i2pd">i2pd Repository</a>
</li>
<li><strong>OBFS4 (Elligator2)</strong>: <a href="https://gitlab.com/yawning/obfs4">obfs4proxy Repository</a>
</li>
</ol>
<h3 id="additional-information">Additional Information</h3>
<ol>
<li><strong>I2P Website</strong>: <a href="../../../../ko/">/</a>
</li>
<li><strong>I2P Forum</strong>: <a href="https://i2pforum.net">https://i2pforum.net</a>
</li>
<li><strong>I2P Wiki</strong>: <a href="https://wiki.i2p-projekt.de">https://wiki.i2p-projekt.de</a>
</li>
</ol>
<hr>
<h2 id="appendix-a-kdf-summary">Appendix A: KDF Summary</h2>
<p><strong>All KDF Operations in ECIES:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Operation</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Input</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Info String</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Output</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NS Initial ChainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">protocol_name</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">(none - SHA256)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">h, chainKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NS Static Key Section</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, es_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, k</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NS Payload Section (bound)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, ss_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, k</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR Tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"SessionReplyTags"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">tagsetKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR ee DH</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, ee_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR se DH</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, se_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, k</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR Split</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">k_ab, k_ba</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR Payload</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">k_ba</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"AttachPayloadKDF"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">k_nsr</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DH Initialize</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">rootKey, k</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"KDFDHRatchetStep"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">nextRootKey, chainKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Tag and Key Chain Keys</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"TagAndKeyGenKeys"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">sessTag_ck, symmKey_ck</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session Tag Init</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">sessTag_ck</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"STInitialization"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, CONSTANT</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session Tag Gen</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, CONSTANT</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"SessionTagKeyGen"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, tag</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Symmetric Key Gen</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"SymmetricRatchet"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DH Ratchet</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">sharedSecret</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"XDHRatchetTagSet"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">tagsetKey</td>
    </tr>
  </tbody>
</table>
<hr>
<h2 id="appendix-b-message-size-calculator">Appendix B: Message Size Calculator</h2>
<p><strong>Calculate message sizes for capacity planning:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_ns_size</span>(payload_size, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Calculate New Session message size&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    ephemeral_key <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    static_section <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># encrypted + MAC</span>
</span></span><span style="display:flex;"><span>    payload_encrypted <span style="color:#f92672">=</span> payload_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># + MAC</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ephemeral_key <span style="color:#f92672">+</span> static_section <span style="color:#f92672">+</span> payload_encrypted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_nsr_size</span>(payload_size):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Calculate New Session Reply message size&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    tag <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    ephemeral_key <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    key_section_mac <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>    payload_encrypted <span style="color:#f92672">=</span> payload_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># + MAC</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tag <span style="color:#f92672">+</span> ephemeral_key <span style="color:#f92672">+</span> key_section_mac <span style="color:#f92672">+</span> payload_encrypted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_es_size</span>(payload_size):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Calculate Existing Session message size&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    tag <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    payload_encrypted <span style="color:#f92672">=</span> payload_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># + MAC</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tag <span style="color:#f92672">+</span> payload_encrypted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 예제</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;NS (bound, 1KB payload):&#34;</span>, calculate_ns_size(<span style="color:#ae81ff">1024</span>, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>), <span style="color:#e6db74">&#34;바이트&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 출력: 1120 바이트</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;NSR (1KB payload):&#34;</span>, calculate_nsr_size(<span style="color:#ae81ff">1024</span>), <span style="color:#e6db74">&#34;bytes&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 출력: 1096 바이트</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;ES (1KB 페이로드):&#34;</span>, calculate_es_size(<span style="color:#ae81ff">1024</span>), <span style="color:#e6db74">&#34;바이트&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 출력: 1048 바이트</span>
</span></span></code></pre></div><hr>
<h2 id="appendix-c-glossary">Appendix C: Glossary</h2>
<p><strong>AEAD</strong>: Authenticated Encryption with Associated Data - encryption mode that provides both confidentiality and authenticity</p>
<p><strong>Authentication Level</strong>: Noise protocol security property indicating strength of sender identity verification</p>
<p><strong>Binding</strong>: Association of a session with a specific far-end destination</p>
<p><strong>ChaCha20</strong>: Stream cipher designed by Daniel J. Bernstein</p>
<p><strong>ChainKey</strong>: Cryptographic key used in HKDF chains to derive subsequent keys</p>
<p><strong>Confidentiality Level</strong>: Noise protocol security property indicating strength of forward secrecy</p>
<p><strong>DH</strong>: Diffie-Hellman key agreement protocol</p>
<p><strong>Elligator2</strong>: Encoding technique to make elliptic curve points indistinguishable from random</p>
<p><strong>Ephemeral Key</strong>: Short-lived key used only for a single handshake</p>
<p><strong>ES</strong>: Existing Session message (used after handshake completion)</p>
<p><strong>Forward Secrecy</strong>: Property ensuring past communications remain secure if keys are compromised</p>
<p><strong>Garlic Clove</strong>: I2NP message container for end-to-end delivery</p>
<p><strong>HKDF</strong>: HMAC-based Key Derivation Function</p>
<p><strong>IK Pattern</strong>: Noise handshake pattern where initiator sends static key immediately</p>
<p><strong>KCI</strong>: Key Compromise Impersonation attack</p>
<p><strong>KDF</strong>: Key Derivation Function - cryptographic function for generating keys from other keys</p>
<p><strong>LeaseSet</strong>: I2P structure containing a destination&rsquo;s public keys and tunnel information</p>
<p><strong>LS2</strong>: LeaseSet version 2 with encryption type support</p>
<p><strong>MAC</strong>: Message Authentication Code - cryptographic checksum proving authenticity</p>
<p><strong>MixHash</strong>: Noise protocol function for maintaining running hash transcript</p>
<p><strong>NS</strong>: New Session message (initiates new session)</p>
<p><strong>NSR</strong>: New Session Reply message (response to NS)</p>
<p><strong>Nonce</strong>: Number used once - ensures unique encryption even with same key</p>
<p><strong>Pairing</strong>: Linking an inbound session with an outbound session for bidirectional communication</p>
<p><strong>Poly1305</strong>: Message authentication code designed by Daniel J. Bernstein</p>
<p><strong>Ratchet</strong>: Cryptographic mechanism for deriving sequential keys</p>
<p><strong>Session Tag</strong>: 8-byte one-time identifier for existing session messages</p>
<p><strong>Static Key</strong>: Long-term key associated with a destination&rsquo;s identity</p>
<p><strong>Tag Set</strong>: Collection of session tags derived from a common root</p>
<p><strong>X25519</strong>: Elliptic curve Diffie-Hellman key agreement using Curve25519</p>
<hr>

                </article>

                
                <nav class="page-nav">
                    
                        <a href="../../../../ko/docs/specs/ecies-hybrid/" class="page-nav-link prev">
                            <span class="nav-label">← Previous</span>
                            <span class="nav-title">ECIES-X25519-AEAD-Ratchet 하이브리드 암호화</span>
                        </a>
                    
                    
                        <a href="../../../../ko/docs/specs/blockfile/" class="page-nav-link next">
                            <span class="nav-label">Next →</span>
                            <span class="nav-title">Blockfile(블록파일) 사양</span>
                        </a>
                    
                </nav>

                
                <div class="docs-feedback">
                    <p>Was this page helpful?</p>
                    <div class="feedback-buttons" id="feedback-buttons">
                        <button class="feedback-btn" id="feedback-yes">👍 Yes</button>
                        <button class="feedback-btn" id="feedback-no">👎 No</button>
                    </div>

                    
                    <div class="feedback-form-container" id="feedback-form-container" style="display: none;">
                        <p class="feedback-form-title">We're sorry to hear that. How can we improve this page?</p>
                        <form id="feedback-form">
                            <div class="form-group">
                                <label for="feedback-email">Email (optional - if you'd like a response)</label>
                                <input type="email" id="feedback-email" name="email" placeholder="your@email.com">
                            </div>
                            <div class="form-group">
                                <label for="feedback-message">Feedback *</label>
                                <textarea id="feedback-message" name="message" rows="4" required placeholder="Tell us what we can improve..."></textarea>
                            </div>
                            <button type="submit" class="btn-submit-feedback" id="feedback-submit-btn">
                                <span class="btn-text">Submit Feedback</span>
                                <span class="btn-loading" style="display: none;">Sending...</span>
                            </button>
                        </form>
                    </div>

                    
                    <div class="feedback-message" id="feedback-success" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/>
                        </svg>
                        <span id="feedback-success-text">Thanks for your feedback!</span>
                    </div>
                    <div class="feedback-message feedback-error" id="feedback-error" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path d="M12 8v4M12 16h.01" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span id="feedback-error-text">Something went wrong. Please try again.</span>
                    </div>

                    <p class="feedback-note">
                        Found an issue? <a href="https://gitlab.com/stormycloud-group/i-2-p-www-v-2/-/blob/main/hugo-site/content/ko/docs/specs/ecies.md?ref_type=heads" target="_blank">Edit this page on GitLab</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.docs-page {
    min-height: 100vh;
    padding: var(--spacing-xl) 0;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
}

.breadcrumbs a:hover {
    color: var(--color-primary);
}

.separator {
    color: var(--color-border);
}

.current {
    color: var(--color-text);
}

 
.translation-disclaimer {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.dark .translation-disclaimer {
    background: #78350f;
    border-color: #d97706;
}

.disclaimer-message {
    color: #92400e;
    font-size: 0.875rem;
}

.dark .disclaimer-message {
    color: #fde047;
}

.disclaimer-link {
    color: #92400e;
    font-weight: 600;
    text-decoration: underline;
    white-space: nowrap;
}

.dark .disclaimer-link {
    color: #fde047;
}

 
.article-header {
    margin-bottom: var(--spacing-2xl);
}

.article-title {
    font-size: 2.5rem;
    margin: 0 0 var(--spacing-md) 0;
    color: var(--color-text);
}

.article-description {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-md);
}

.article-meta {
    display: flex;
    gap: var(--spacing-lg);
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.meta-item svg {
    color: var(--color-primary);
}

 
.docs-layout {
    display: block;
}

.docs-layout--with-toc {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

 
.docs-toc-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.toc-nav {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
}

.toc-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-text);
    padding-bottom: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.toc-content {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
}

.toc-content::-webkit-scrollbar {
    width: 4px;
}

.toc-content::-webkit-scrollbar-track {
    background: transparent;
}

.toc-content::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
}

.toc-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

.toc-nav ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc-nav li {
    margin-bottom: 0.25rem;
}

.toc-nav ul ul {
    padding-left: var(--spacing-md);
    margin-top: 0.25rem;
}

.toc-nav a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.8125rem;
    display: block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    line-height: 1.4;
}

.toc-nav a:hover {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
}

 
.docs-main {
    min-width: 0;
    max-width: 900px;
}

 
.article-content {
    line-height: 1.8;
    color: var(--color-text);
}

.article-content h2 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.75rem;
    scroll-margin-top: 100px;
}

.article-content h3 {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.375rem;
    scroll-margin-top: 100px;
}

.article-content h4 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-xs);
    font-size: 1.125rem;
    scroll-margin-top: 100px;
}

.article-content p {
    margin-bottom: var(--spacing-md);
}

.article-content ul,
.article-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.article-content li {
    margin-bottom: var(--spacing-xs);
}

.article-content code {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
}

.article-content pre {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: var(--spacing-md);
}

.article-content pre code {
    background: none;
    padding: 0;
}

.article-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin: var(--spacing-lg) 0;
    display: block;
}

.article-content a {
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
}

.article-content a:hover {
    border-bottom-color: var(--color-primary);
}

 
.page-nav {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
}

.page-nav-link {
    display: flex;
    flex-direction: column;
    padding: var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.page-nav-link:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
}

.page-nav-link.next {
    text-align: right;
}

.nav-label {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xs);
}

.nav-title {
    font-weight: 600;
    color: var(--color-text);
}

 
.docs-feedback {
    margin-top: var(--spacing-2xl);
    padding: var(--spacing-lg);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    text-align: center;
}

.feedback-buttons {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    margin: var(--spacing-md) 0;
}

.feedback-btn {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.feedback-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-primary);
    color: white;
}

.feedback-note {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-top: var(--spacing-md);
}

.feedback-note a {
    color: var(--color-primary);
    text-decoration: none;
}

.feedback-note a:hover {
    text-decoration: underline;
}

 
.feedback-form-container {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-align: left;
}

.feedback-form-title {
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--color-text);
}

.form-group {
    margin-bottom: var(--spacing-md);
}

.form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
    color: var(--color-text);
}

.form-group input[type="email"],
.form-group textarea {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    color: var(--color-text);
    font-family: inherit;
    font-size: 0.9375rem;
    transition: border-color var(--transition-fast);
}

.form-group input[type="email"]:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.btn-submit-feedback {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-submit-feedback:hover:not(:disabled) {
    background: var(--color-primary-dark);
    transform: translateY(-1px);
}

.btn-submit-feedback:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

 
.feedback-message {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: #d1fae5;
    color: #065f46;
    border-radius: var(--radius-md);
    margin-top: var(--spacing-md);
}

.feedback-message.feedback-error {
    background: #fee2e2;
    color: #991b1b;
}

.feedback-message svg {
    flex-shrink: 0;
}

 
@media (max-width: 1024px) {
    .docs-layout--with-toc {
        grid-template-columns: 1fr;
    }

    .docs-toc-sidebar {
        position: static;
        max-height: none;
        margin-bottom: var(--spacing-xl);
    }

    .toc-content {
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .article-title {
        font-size: 1.75rem;
    }
}
</style>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = [];

    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const heading = document.getElementById(href.slice(1));
            if (heading) {
                headings.push({ element: heading, link: link });
            }
        }
    });

    function updateActiveLink() {
        const scrollPos = window.scrollY + 120;
        let activeIndex = 0;

        for (let i = 0; i < headings.length; i++) {
            if (headings[i].element.offsetTop <= scrollPos) {
                activeIndex = i;
            }
        }

        tocLinks.forEach(link => link.classList.remove('active'));
        if (headings[activeIndex]) {
            headings[activeIndex].link.classList.add('active');
        }
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});
</script>
<style>
.toc-nav a.active {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
    font-weight: 600;
}
</style>



<script>
(function() {
    'use strict';
    
    
    let baseUrl = window.feedbackBaseUrl;
    if (!baseUrl) {
        const hostname = window.location.hostname;
        
        if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
            baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
        } else if (hostname.endsWith('.onion')) {
            baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
        } else {
            baseUrl = 'https://feedback.i2p.net';
        }
    }
    
    const script = document.createElement('script');
    script.src = baseUrl + '/widgets/docs-feedback.js';
    script.async = true;
    script.onerror = function() {
        console.error('[Docs Feedback] Failed to load docs-feedback.js from:', baseUrl);
    };
    document.body.appendChild(script);
})();
</script>


    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">I2P 뉴스 받기:</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="이메일을 입력하세요" required>
                            <button type="submit">구독하기</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>빠른 링크</h3>
                <ul>
                    <li><a href="../../../../ko/financial-support/">기부하기</a></li>
                    <li><a href="../../../../ko/docs/overview/intro/">I2P 소개</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>커뮤니티</h3>
                <ul>
                    <li><a href="../../../../ko/get-involved/">참여하기</a></li>
                    <li><a href="../../../../ko/blog/">블로그</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">공식 포럼</a></li>
                    <li><a href="../../../../ko/contact/">연락처</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>리소스</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">I2P 메트릭</a></li>
                    <li><a href="../../../../ko/papers/">연구</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">스톰이클라우드</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 Invisible Internet Project. Creative Commons 라이선스 적용.</p>
            <div class="footer-links">
                <a href="../../../../ko/privacy/">개인정보 처리방침</a>
                <a href="../../../../ko/terms/">이용 약관</a>
                <a href="../../../../ko/about/media/">언론</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="닫기">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>커뮤니티 설문 조사</h2>
            <p class="modal-subtitle">귀하의 의견을 듣고 싶습니다</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                귀하의 투표는 I2P의 미래를 형성하는 데 도움이 됩니다.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
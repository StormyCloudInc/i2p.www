<!DOCTYPE html>
<html lang="ko" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>NTCP2 전송 | I2P - 보이지 않는 인터넷 프로젝트</title>

    <meta name="description" content="router 간 링크를 위한 Noise(프로토콜 프레임워크) 기반 TCP 전송">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="NTCP2 전송 | I2P - 보이지 않는 인터넷 프로젝트">
    <meta property="og:description" content="router 간 링크를 위한 Noise(프로토콜 프레임워크) 기반 TCP 전송">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/ko/docs/specs/ntcp2/">

    
    <link rel="icon" type="image/svg+xml" href="../../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">I2P 베타 사이트 현재 운영 중 문의사항은 stormycloud@mail.i2p로 이메일 주세요</span>
            
        </div>
        
        <form method="GET" action="../../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="배너 닫기" title="배너 닫기">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../../ko/" class="logo-link">
                    <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../../ko/about/" class="">소개</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../ko/about/">개요</a></li>
                            <li><a href="../../../../ko/papers/">연구 논문</a></li>
                            <li><a href="../../../../ko/about/media/">보도자료</a></li>
                            <li><a href="../../../../ko/contact/">문의하기</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../../ko/docs/" class="active">문서</a></li>
                    <li><a href="../../../../ko/downloads/" class="">다운로드</a></li>
                    <li><a href="../../../../ko/blog/" class="">블로그</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../../ko/get-involved/" class="">참여하기</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../ko/get-involved/">개요</a></li>
                            <li><a href="../../../../ko/feedback/">기능 제안</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">ko</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../en/docs/specs/ntcp2/"
                                class="lang-option">영어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../es/docs/specs/ntcp2/"
                                class="lang-option">스페인어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ko/docs/specs/ntcp2/"
                                class="lang-option active">한국어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../zh/docs/specs/ntcp2/"
                                class="lang-option">중국어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ru/docs/specs/ntcp2/"
                                class="lang-option">러시아어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../cs/docs/specs/ntcp2/"
                                class="lang-option">체코어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../de/docs/specs/ntcp2/"
                                class="lang-option">독일어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../fr/docs/specs/ntcp2/"
                                class="lang-option">프랑스어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../tr/docs/specs/ntcp2/"
                                class="lang-option">터키어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../vi/docs/specs/ntcp2/"
                                class="lang-option">베트남어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../hi/docs/specs/ntcp2/"
                                class="lang-option">힌디어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ar/docs/specs/ntcp2/"
                                class="lang-option">아랍어</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../pt/docs/specs/ntcp2/"
                                class="lang-option">포르투갈어</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../../ko/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../../ko/downloads/" class="btn btn-primary">I2P 다운로드</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        




<div class="docs-page">
    <div class="container">
        
        <div class="docs-layout docs-layout--with-toc">
            
            
            <aside class="docs-toc-sidebar">
                <nav class="toc-nav">
                    <div class="toc-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        On This Page
                    </div>
                    <div class="toc-content">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#개요">개요</a></li>
    <li><a href="#noise-protocol-framework노이즈-프로토콜-프레임워크">Noise Protocol Framework(노이즈 프로토콜 프레임워크)</a>
      <ul>
        <li><a href="#i2p-전용-확장-기능">I2P 전용 확장 기능</a></li>
      </ul>
    </li>
    <li><a href="#핸드셰이크-흐름">핸드셰이크 흐름</a>
      <ul>
        <li><a href="#3-메시지-핸드셰이크">3-메시지 핸드셰이크</a></li>
        <li><a href="#noise프로토콜-프레임워크-메시지-패턴">Noise(프로토콜 프레임워크) 메시지 패턴</a></li>
      </ul>
    </li>
    <li><a href="#메시지-명세">메시지 명세</a>
      <ul>
        <li><a href="#키-표기법">키 표기법</a></li>
        <li><a href="#인증된-암호화-chacha20-poly1305">인증된 암호화 (ChaCha20-Poly1305)</a></li>
      </ul>
    </li>
    <li><a href="#메시지-1-sessionrequest세션-요청">메시지 1: SessionRequest(세션 요청)</a>
      <ul>
        <li><a href="#원시-형식">원시 형식</a></li>
        <li><a href="#복호화된-콘텐츠">복호화된 콘텐츠</a></li>
        <li><a href="#옵션-블록-16바이트-빅-엔디언">옵션 블록 (16바이트, 빅 엔디언)</a></li>
        <li><a href="#키-유도-함수kdf-1">키 유도 함수(KDF-1)</a></li>
        <li><a href="#구현-참고-사항">구현 참고 사항</a></li>
      </ul>
    </li>
    <li><a href="#메시지-2-sessioncreated세션-생성됨">메시지 2: SessionCreated(세션 생성됨)</a>
      <ul>
        <li><a href="#원시-형식-1">원시 형식</a></li>
        <li><a href="#복호화된-콘텐츠-1">복호화된 콘텐츠</a></li>
        <li><a href="#옵션-블록-16바이트-빅엔디언">옵션 블록 (16바이트, 빅엔디언)</a></li>
        <li><a href="#키-유도-함수kdf-2">키 유도 함수(KDF-2)</a></li>
        <li><a href="#구현-참고사항">구현 참고사항</a></li>
      </ul>
    </li>
    <li><a href="#메시지-3-sessionconfirmed세션-확인">메시지 3: SessionConfirmed(세션 확인)</a>
      <ul>
        <li><a href="#두-부분-구조">두 부분 구조</a></li>
        <li><a href="#원시-형식-2">원시 형식</a></li>
        <li><a href="#복호화된-콘텐츠-2">복호화된 콘텐츠</a></li>
        <li><a href="#키-파생-함수kdf-3">키 파생 함수(KDF-3)</a></li>
        <li><a href="#구현-참고-사항-1">구현 참고 사항</a></li>
      </ul>
    </li>
    <li><a href="#데이터-단계">데이터 단계</a>
      <ul>
        <li><a href="#키-파생-함수데이터-단계">키 파생 함수(데이터 단계)</a></li>
        <li><a href="#프레임-구조">프레임 구조</a></li>
        <li><a href="#siphash-길이-난독화">SipHash 길이 난독화</a></li>
        <li><a href="#블록-형식">블록 형식</a></li>
        <li><a href="#블록-유형">블록 유형</a></li>
        <li><a href="#블록-유형-0-datetime">블록 유형 0: DateTime</a></li>
        <li><a href="#블록-유형-1-옵션">블록 유형 1: 옵션</a></li>
        <li><a href="#블록-유형-2-routerinfo">블록 유형 2: RouterInfo</a></li>
        <li><a href="#블록-유형-3-i2np-메시지">블록 유형 3: I2NP 메시지</a></li>
        <li><a href="#블록-유형-4-종료">블록 유형 4: 종료</a></li>
        <li><a href="#블록-유형-254-패딩">블록 유형 254: 패딩</a></li>
      </ul>
    </li>
    <li><a href="#aead-오류-처리">AEAD 오류 처리</a>
      <ul>
        <li><a href="#핸드셰이크-단계-메시지-1-3">핸드셰이크 단계 (메시지 1-3)</a></li>
        <li><a href="#데이터-단계-1">데이터 단계</a></li>
      </ul>
    </li>
    <li><a href="#게시된-routerinfo">게시된 RouterInfo</a>
      <ul>
        <li><a href="#router-주소-형식">Router 주소 형식</a></li>
        <li><a href="#필수-옵션">필수 옵션</a></li>
        <li><a href="#routeraddress-엔트리-예시">RouterAddress 엔트리 예시</a></li>
        <li><a href="#공개되지-않은-ntcp2-주소">공개되지 않은 NTCP2 주소</a></li>
        <li><a href="#공개-키-및-iv초기화-벡터-로테이션">공개 키 및 IV(초기화 벡터) 로테이션</a></li>
      </ul>
    </li>
    <li><a href="#버전-감지">버전 감지</a></li>
    <li><a href="#시계-오차-지침">시계 오차 지침</a>
      <ul>
        <li><a href="#bob의-처리-메시지-1">Bob의 처리 (메시지 1)</a></li>
        <li><a href="#앨리스의-처리-메시지-2">앨리스의 처리 (메시지 2)</a></li>
        <li><a href="#bob의-처리-메시지-3">Bob의 처리 (메시지 3)</a></li>
        <li><a href="#시간-동기화">시간 동기화</a></li>
      </ul>
    </li>
    <li><a href="#보안-속성">보안 속성</a>
      <ul>
        <li><a href="#순방향-기밀성">순방향 기밀성</a></li>
        <li><a href="#인증">인증</a></li>
        <li><a href="#트래픽-분석에-대한-저항성">트래픽 분석에 대한 저항성</a></li>
        <li><a href="#서비스-거부dos-완화">서비스 거부(DoS) 완화</a></li>
        <li><a href="#암호학적-보안">암호학적 보안</a></li>
      </ul>
    </li>
    <li><a href="#참고-자료">참고 자료</a>
      <ul>
        <li><a href="#주요-명세">주요 명세</a></li>
        <li><a href="#암호화-표준">암호화 표준</a></li>
        <li><a href="#관련-i2p-명세">관련 I2P 명세</a></li>
        <li><a href="#구현-참고-자료">구현 참고 자료</a></li>
        <li><a href="#역사적-맥락">역사적 맥락</a></li>
      </ul>
    </li>
    <li><a href="#구현-지침">구현 지침</a>
      <ul>
        <li><a href="#필수-요구-사항">필수 요구 사항</a></li>
        <li><a href="#권장-사항">권장 사항</a></li>
        <li><a href="#자주-하는-실수">자주 하는 실수</a></li>
        <li><a href="#테스트-방법론">테스트 방법론</a></li>
        <li><a href="#ntcp에서의-마이그레이션">NTCP에서의 마이그레이션</a></li>
      </ul>
    </li>
    <li><a href="#부록-a-noise-xk-patternnoise-프로토콜의-xk-패턴">부록 A: Noise XK Pattern(Noise 프로토콜의 XK 패턴)</a></li>
    <li><a href="#부록-b-base64-인코딩">부록 B: Base64 인코딩</a></li>
    <li><a href="#부록-c-패킷-캡처-분석">부록 C: 패킷 캡처 분석</a></li>
    <li><a href="#부록-d-버전-이력">부록 D: 버전 이력</a></li>
  </ul>
</nav>
                    </div>
                </nav>
            </aside>
            

            
            <div class="docs-main">
                
                <nav class="breadcrumbs">
                    <a href="../../../../ko/">Home</a>
                    <span class="separator">/</span>
                    <a href="../../../../ko/docs/">Docs</a>
                    
                        
                            <span class="separator">/</span>
                            <a href="../../../../ko/docs/specs/">Specifications</a>
                        
                    
                    <span class="separator">/</span>
                    <span class="current">NTCP2 전송</span>
                </nav>

                
<div class="translation-disclaimer" role="note">
    <span class="disclaimer-message">이 번역은 기계 학습을 사용하여 생성되었으며 100% 정확하지 않을 수 있습니다.</span>
    
    
    <a href="../../../../en/docs/specs/ntcp2/" class="disclaimer-link">영어 버전 보기</a>
    
</div>



                
                <header class="article-header">
                    <h1 class="article-title">NTCP2 전송</h1>
                    
                        <p class="article-description">router 간 링크를 위한 Noise(프로토콜 프레임워크) 기반 TCP 전송</p>
                    
                    <div class="article-meta">
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                Updated: 2025-10
                            </span>
                        
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Accurate for: 0.9.66
                            </span>
                        
                    </div>
                </header>

                
                <article class="article-content">
                    <h2 id="개요">개요</h2>
<p>NTCP2는 트래픽 지문 식별에 대한 저항성을 갖고, 길이 필드를 암호화하며, 최신 암호군을 지원하는 Noise(보안 핸드셰이크 프레임워크) 기반 핸드셰이크로 기존 NTCP 전송을 대체합니다. Routers는 I2P 네트워크에서 필수인 두 가지 전송 프로토콜로서 SSU2와 함께 NTCP2를 실행할 수 있습니다. NTCP(버전 1)은 0.9.40(2019년 5월)에서 사용 중단되었으며 0.9.50(2021년 5월)에서 완전히 제거되었습니다.</p>
<h2 id="noise-protocol-framework노이즈-프로토콜-프레임워크">Noise Protocol Framework(노이즈 프로토콜 프레임워크)</h2>
<p>NTCP2는 I2P 전용 확장과 함께 Noise Protocol Framework <a href="https://noiseprotocol.org/noise.html">Revision 33, 2017-10-04</a>
 (암호화 핸드셰이크 프로토콜 설계 프레임워크)를 사용합니다:</p>
<ul>
<li><strong>패턴</strong>: <code>Noise_XK_25519_ChaChaPoly_SHA256</code></li>
<li><strong>확장 식별자</strong>: <code>Noise_XKaesobfse+hs2+hs3_25519_ChaChaPoly_SHA256</code> (KDF 초기화를 위해)</li>
<li><strong>DH 함수</strong>: X25519 (RFC 7748) - 32바이트 키, 리틀 엔디언 인코딩</li>
<li><strong>암호</strong>: AEAD_CHACHA20_POLY1305 (RFC 7539/RFC 8439)
<ul>
<li>12바이트 논스: 처음 4바이트는 0, 마지막 8바이트는 카운터(리틀 엔디언)</li>
<li>최대 논스 값: 2^64 - 2 (연결은 2^64 - 1에 도달하기 전에 종료되어야 함)</li>
</ul>
</li>
<li><strong>해시 함수</strong>: SHA-256 (32바이트 출력)</li>
<li><strong>MAC</strong>: Poly1305 (16바이트 인증 태그)</li>
</ul>
<h3 id="i2p-전용-확장-기능">I2P 전용 확장 기능</h3>
<ol>
<li><strong>AES 난독화</strong>: 임시 키는 Bob의 router 해시와 공개된 IV를 사용하여 AES-256-CBC로 암호화됨</li>
<li><strong>임의 패딩</strong>: 메시지 1-2에서는 평문 패딩(인증됨), 메시지 3+에서는 AEAD(연관 데이터 인증 암호) 패딩(암호화됨)</li>
<li><strong>SipHash-2-4 길이 난독화</strong>: 2바이트 프레임 길이는 SipHash 출력과 XOR 처리됨</li>
<li><strong>프레임 구조</strong>: 데이터 단계에서 길이 접두사 프레임(TCP 스트리밍 호환성)</li>
<li><strong>블록 기반 페이로드</strong>: 타입이 지정된 블록으로 구성된 구조화된 데이터 형식</li>
</ol>
<h2 id="핸드셰이크-흐름">핸드셰이크 흐름</h2>
<pre tabindex="0"><code>Alice (Initiator)             Bob (Responder)
SessionRequest  ──────────────────────►
                ◄────────────────────── SessionCreated
SessionConfirmed ──────────────────────►
</code></pre><h3 id="3-메시지-핸드셰이크">3-메시지 핸드셰이크</h3>
<ol>
<li><strong>SessionRequest</strong>(세션 요청) - 앨리스의 난독화된 임시 키, 옵션, 패딩 힌트</li>
<li><strong>SessionCreated</strong>(세션 생성) - 밥의 난독화된 임시 키, 암호화된 옵션, 패딩</li>
<li><strong>SessionConfirmed</strong>(세션 확인) - 앨리스의 암호화된 정적 키와 RouterInfo(router 정보) (AEAD(연관 데이터가 있는 인증 암호) 프레임 두 개)</li>
</ol>
<h3 id="noise프로토콜-프레임워크-메시지-패턴">Noise(프로토콜 프레임워크) 메시지 패턴</h3>
<pre tabindex="0"><code>XK(s, rs):           Authentication   Confidentiality
  &lt;- s               (Bob&#39;s static key known in advance)
  -&gt; e, es                  0                2
  &lt;- e, ee                  2                1
  -&gt; s, se                  2                5
  &lt;-                        2                5
</code></pre><p><strong>인증 수준:</strong> - 0: 인증 없음 (누구나 보냈을 수 있음) - 2: key-compromise impersonation (KCI, 키 손상 사칭)에 대한 저항성을 갖춘 발신자 인증</p>
<p><strong>기밀성 수준:</strong> - 1: 일시적 수신자(전방향 보안(forward secrecy), 수신자 인증 없음) - 2: 확인된 수신자, 발신자 침해에 대해서만 전방향 보안 - 5: 강한 전방향 보안(ephemeral-ephemeral + ephemeral-static DH(Diffie-Hellman, 디피-헬만))</p>
<h2 id="메시지-명세">메시지 명세</h2>
<h3 id="키-표기법">키 표기법</h3>
<ul>
<li><code>RH_A</code> = Alice에 대한 Router 해시(32바이트, SHA-256)</li>
<li><code>RH_B</code> = Bob에 대한 Router 해시(32바이트, SHA-256)</li>
<li><code>||</code> = 연결 연산자</li>
<li><code>byte(n)</code> = 값이 n인 단일 바이트</li>
<li>모든 멀티바이트 정수는 별도 지정이 없는 한 <strong>빅엔디언</strong></li>
<li>X25519 키는 <strong>리틀엔디언</strong>(32바이트)</li>
</ul>
<h3 id="인증된-암호화-chacha20-poly1305">인증된 암호화 (ChaCha20-Poly1305)</h3>
<p><strong>암호화 함수:</strong></p>
<pre tabindex="0"><code>AEAD_ChaCha20_Poly1305(key, nonce, associatedData, plaintext)
  → (ciphertext || MAC)
</code></pre><p><strong>매개변수:</strong> - <code>key</code>: KDF(키 유도 함수)에서 파생된 32바이트 암호 키 - <code>nonce</code>: 12바이트(0 값 바이트 4개 + 8바이트 카운터, 리틀 엔디언) - <code>associatedData</code>: 핸드셰이크 단계에서는 32바이트 해시; 데이터 단계에서는 길이 0 - <code>plaintext</code>: 암호화할 데이터(0바이트 이상)</p>
<p><strong>출력:</strong> - 암호문: 평문과 동일한 길이 - MAC: 16바이트 (Poly1305 인증 태그)</p>
<p><strong>논스 관리:</strong> - 각 암호 인스턴스마다 카운터는 0에서 시작 - 해당 방향의 각 AEAD 연산마다 증가 - 데이터 단계에서 Alice→Bob 및 Bob→Alice에 대해 별도의 카운터 - 카운터가 2^64 - 1에 도달하기 전에 연결을 종료해야 함</p>
<h2 id="메시지-1-sessionrequest세션-요청">메시지 1: SessionRequest(세션 요청)</h2>
<p>앨리스가 밥과의 연결을 시작한다.</p>
<p><strong>Noise 연산</strong>: <code>e, es</code> (임시 키 생성 및 교환)</p>
<h3 id="원시-형식">원시 형식</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+    AES-256-CBC Encrypted X (32B)      +
|    Key: RH_B, IV: Bob&#39;s published IV  |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+    ChaChaPoly Frame (48 bytes)        +
|    Plaintext: 32B (X + options)       |
+    k from KDF-1, n=0, ad=h            +
|                                       |
+----+----+----+----+----+----+----+----+
|    Cleartext Padding (optional)       |
+    Length specified in options         +
|    0 to 65535 - 80 bytes              |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>크기 제한:</strong> - 최소: 80바이트 (32 AES + 48 AEAD) - 최대: 총 65535바이트 - <strong>특수한 경우</strong>: &ldquo;NTCP&rdquo; 주소에 연결할 때 최대 287바이트 (버전 감지)</p>
<h3 id="복호화된-콘텐츠">복호화된 콘텐츠</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+    X (Alice ephemeral public key)     +
|    32 bytes, X25519, little-endian    |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|           Options Block               |
+             (16 bytes)                +
|                                       |
+----+----+----+----+----+----+----+----+
|    Cleartext Padding (optional)       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+
</code></pre><h3 id="옵션-블록-16바이트-빅-엔디언">옵션 블록 (16바이트, 빅 엔디언)</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| id | ver|  padLen | m3p2len | Rsvd(0) |
+----+----+----+----+----+----+----+----+
|        tsA        |   Reserved (0)    |
+----+----+----+----+----+----+----+----+

id      : 1 byte  - Network ID (2 for mainnet, 16-254 for testnets)
ver     : 1 byte  - Protocol version (currently 2)
padLen  : 2 bytes - Padding length in this message (0-65455)
m3p2len : 2 bytes - Length of SessionConfirmed part 2 frame
Rsvd    : 2 bytes - Reserved, set to 0
tsA     : 4 bytes - Unix timestamp (seconds since epoch)
Reserved: 4 bytes - Reserved, set to 0
</code></pre><p><strong>중요 필드:</strong> - <strong>네트워크 ID</strong> (since 0.9.42): 네트워크 간 연결을 신속하게 거부 - <strong>m3p2len</strong>: 메시지 3 파트 2의 정확한 크기(전송 시 일치해야 함)</p>
<h3 id="키-유도-함수kdf-1">키 유도 함수(KDF-1)</h3>
<p><strong>프로토콜 초기화:</strong></p>
<pre tabindex="0"><code>protocol_name = &#34;Noise_XKaesobfse+hs2+hs3_25519_ChaChaPoly_SHA256&#34;
h = SHA256(protocol_name)
ck = h  // Chaining key initialized to hash
</code></pre><p><strong>MixHash(혼합 해시) 연산:</strong></p>
<pre tabindex="0"><code>h = SHA256(h)                    // Null prologue
h = SHA256(h || rs)              // Bob&#39;s static key (known)
h = SHA256(h || e.pubkey)        // Alice&#39;s ephemeral key X
// h is now the associated data for message 1 AEAD
</code></pre><p><strong>MixKey 동작 (es 패턴):</strong></p>
<pre tabindex="0"><code>dh_result = X25519(Alice.ephemeral_private, Bob.static_public)
temp_key = HMAC-SHA256(ck, dh_result)
ck = HMAC-SHA256(temp_key, byte(0x01))
k = HMAC-SHA256(temp_key, ck || byte(0x02))
// k is the cipher key for message 1
// ck is retained for message 2 KDF
</code></pre><h3 id="구현-참고-사항">구현 참고 사항</h3>
<ol>
<li><strong>AES 난독화</strong>: DPI(딥 패킷 검사) 회피 목적에만 사용됨; Bob의 router 해시와 IV를 가진 누구나 X를 복호화할 수 있음</li>
<li><strong>재생 공격 방지</strong>: Bob은 최소 2*D초 동안 X 값(또는 암호화된 동등값)을 캐시해야 함 (D = 최대 시계 스큐)</li>
<li><strong>타임스탬프 검증</strong>: Bob은 |tsA - current_time| &gt; D 인 연결을 거부해야 함 (일반적으로 D = 60초)</li>
<li><strong>곡선 검증</strong>: Bob은 X가 유효한 X25519 점인지 검증해야 함</li>
<li><strong>빠른 거부</strong>: 복호화 전에 Bob은 X[31] &amp; 0x80 == 0 여부를 확인할 수 있음 (유효한 X25519 키는 MSB(최상위 비트)가 클리어되어 있음)</li>
<li><strong>오류 처리</strong>: 어떤 실패가 발생해도, 임의의 타임아웃과 임의의 바이트를 읽은 뒤 TCP RST로 연결을 종료함</li>
<li><strong>버퍼링</strong>: 효율을 위해 Alice는 전체 메시지(패딩 포함)를 한 번에 플러시해야 함</li>
</ol>
<h2 id="메시지-2-sessioncreated세션-생성됨">메시지 2: SessionCreated(세션 생성됨)</h2>
<p>Bob이 Alice에게 응답한다.</p>
<p><strong>Noise 연산</strong>: <code>e, ee</code> (ephemeral-ephemeral DH; 일회용-일회용 Diffie-Hellman)</p>
<h3 id="원시-형식-1">원시 형식</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+    AES-256-CBC Encrypted Y (32B)      +
|    Key: RH_B, IV: AES state from msg1 |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+    ChaChaPoly Frame (48 bytes)        +
|    Plaintext: 32B (Y + options)       |
+    k from KDF-2, n=0, ad=h            +
|                                       |
+----+----+----+----+----+----+----+----+
|    Cleartext Padding (optional)       |
+    Length specified in options         +
|    0 to 65535 - 80 bytes              |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+
</code></pre><h3 id="복호화된-콘텐츠-1">복호화된 콘텐츠</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+    Y (Bob ephemeral public key)       +
|    32 bytes, X25519, little-endian    |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|           Options Block               |
+             (16 bytes)                +
|                                       |
+----+----+----+----+----+----+----+----+
|    Cleartext Padding (optional)       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+
</code></pre><h3 id="옵션-블록-16바이트-빅엔디언">옵션 블록 (16바이트, 빅엔디언)</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| Rsvd(0) | padLen  |   Reserved (0)    |
+----+----+----+----+----+----+----+----+
|        tsB        |   Reserved (0)    |
+----+----+----+----+----+----+----+----+

Rsvd    : 2 bytes - Reserved, set to 0
padLen  : 2 bytes - Padding length in this message
Reserved: 10 bytes - Reserved, set to 0
tsB     : 4 bytes - Unix timestamp (seconds since epoch)
</code></pre><h3 id="키-유도-함수kdf-2">키 유도 함수(KDF-2)</h3>
<p><strong>MixHash 연산:</strong></p>
<pre tabindex="0"><code>h = SHA256(h || encrypted_payload_msg1)  // 32-byte ciphertext
if (msg1_padding_length &gt; 0):
    h = SHA256(h || padding_from_msg1)
h = SHA256(h || e.pubkey)                // Bob&#39;s ephemeral key Y
// h is now the associated data for message 2 AEAD
</code></pre><p><strong>MixKey 연산 (ee pattern, ee 패턴):</strong></p>
<pre tabindex="0"><code>dh_result = X25519(Bob.ephemeral_private, Alice.ephemeral_public)
temp_key = HMAC-SHA256(ck, dh_result)
ck = HMAC-SHA256(temp_key, byte(0x01))
k = HMAC-SHA256(temp_key, ck || byte(0x02))
// k is the cipher key for message 2
// ck is retained for message 3 KDF
</code></pre><p><strong>메모리 정리:</strong></p>
<pre tabindex="0"><code>// Overwrite ephemeral keys after ee DH
Alice.ephemeral_public = zeros(32)
Alice.ephemeral_private = zeros(32)  // Bob side
Bob.received_ephemeral = zeros(32)    // Bob side
</code></pre><h3 id="구현-참고사항">구현 참고사항</h3>
<ol>
<li><strong>AES 체이닝</strong>: Y 암호화는 메시지 1의 AES-CBC(암호 블록 연쇄 모드) 상태를 사용한다(초기화하지 않음)</li>
<li><strong>재생 공격 방지</strong>: Alice는 최소 2*D초 동안 Y 값을 캐시해야 한다</li>
<li><strong>타임스탬프 검증</strong>: Alice는 |tsB - current_time| &gt; D 인 경우 거부해야 한다</li>
<li><strong>타원곡선 검증</strong>: Alice는 Y가 유효한 X25519(타원곡선 Diffie-Hellman(ECDH) 키 교환 방식) 점인지 확인해야 한다</li>
<li><strong>오류 처리</strong>: 실패가 발생하면 Alice는 TCP RST(연결 재설정 플래그)로 연결을 닫는다</li>
<li><strong>버퍼링</strong>: Bob은 전체 메시지를 한 번에 플러시해야 한다</li>
</ol>
<h2 id="메시지-3-sessionconfirmed세션-확인">메시지 3: SessionConfirmed(세션 확인)</h2>
<p>Alice는 세션을 확인하고 RouterInfo(router 정보)를 전송한다.</p>
<p><strong>Noise 연산</strong>: <code>s, se</code> (정적 키 공개 및 정적-에페메럴 DH)</p>
<h3 id="두-부분-구조">두 부분 구조</h3>
<p>메시지 3은 <strong>별도의 AEAD(연관 데이터가 포함된 인증된 암호화) 프레임 두 개</strong>로 구성됩니다:</p>
<ol>
<li><strong>부분 1</strong>: Alice의 암호화된 정적 키를 포함한 고정된 48바이트 프레임</li>
<li><strong>부분 2</strong>: RouterInfo(라우터 정보), 옵션 및 패딩을 포함한 가변 길이 프레임</li>
</ol>
<h3 id="원시-형식-2">원시 형식</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|    ChaChaPoly Frame 1 (48 bytes)      |
+    Plaintext: Alice static key (32B)  +
|    k from KDF-2, n=1, ad=h            |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+    ChaChaPoly Frame 2 (variable)      +
|    Length specified in msg1.m3p2len   |
+    k from KDF-3, n=0, ad=h            +
|    Plaintext: RouterInfo + padding    |
+                                       +
|                                       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>크기 제한:</strong> - 파트 1: 정확히 48바이트 (32바이트 평문 + 16바이트 MAC) - 파트 2: 메시지 1에서 지정된 길이 (m3p2len 필드) - 총 최대: 65535바이트 (파트 1 최대 48, 따라서 파트 2 최대 65487)</p>
<h3 id="복호화된-콘텐츠-2">복호화된 콘텐츠</h3>
<p><strong>파트 1:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+    S (Alice static public key)        +
|    32 bytes, X25519, little-endian    |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>2부:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|    Block: RouterInfo (required)       |
+    Type=2, contains Alice&#39;s RI         +
|                                       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+
|    Block: Options (optional)          |
+    Type=1, padding parameters          +
|                                       |
+----+----+----+----+----+----+----+----+
|    Block: Padding (optional)          |
+    Type=254, random data               +
|    MUST be last block if present      |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+
</code></pre><h3 id="키-파생-함수kdf-3">키 파생 함수(KDF-3)</h3>
<p><strong>파트 1 (s 패턴):</strong></p>
<pre tabindex="0"><code>h = SHA256(h || encrypted_payload_msg2)  // 32-byte ciphertext
if (msg2_padding_length &gt; 0):
    h = SHA256(h || padding_from_msg2)

// Encrypt static key with message 2 cipher key
ciphertext = AEAD_ChaCha20_Poly1305(k_msg2, n=1, h, Alice.static_public)
h = SHA256(h || ciphertext)  // 48 bytes (32 + 16)
// h is now the associated data for message 3 part 2
</code></pre><p><strong>2부(se 패턴):</strong></p>
<pre tabindex="0"><code>dh_result = X25519(Alice.static_private, Bob.ephemeral_public)
temp_key = HMAC-SHA256(ck, dh_result)
ck = HMAC-SHA256(temp_key, byte(0x01))
k = HMAC-SHA256(temp_key, ck || byte(0x02))
// k is the cipher key for message 3 part 2
// ck is retained for data phase KDF

ciphertext = AEAD_ChaCha20_Poly1305(k, n=0, h, payload)
h = SHA256(h || ciphertext)
// h is retained for SipHash KDF
</code></pre><p><strong>메모리 정리:</strong></p>
<pre tabindex="0"><code>// Overwrite Bob&#39;s ephemeral key after se DH
Alice.received_ephemeral = zeros(32)  // Alice side
Bob.ephemeral_public = zeros(32)       // Bob side
Bob.ephemeral_private = zeros(32)      // Bob side
</code></pre><h3 id="구현-참고-사항-1">구현 참고 사항</h3>
<ol>
<li><strong>RouterInfo(라우터 정보) 검증</strong>: Bob은 서명, 타임스탬프, 키의 일관성을 검증해야 한다</li>
<li><strong>키 일치</strong>: Bob은 파트 1에 있는 Alice의 정적 키가 RouterInfo의 키와 일치하는지 검증해야 한다</li>
<li><strong>정적 키 위치</strong>: NTCP 또는 NTCP2 RouterAddress(라우터 주소)에서 일치하는 &ldquo;s&rdquo; 매개변수를 찾는다</li>
<li><strong>블록 순서</strong>: RouterInfo는 첫 번째여야 하고, Options는 두 번째(있는 경우), Padding은 마지막(있는 경우)이어야 한다</li>
<li><strong>길이 계획</strong>: Alice는 메시지 1의 m3p2len이 파트 2 길이와 정확히 일치하도록 해야 한다</li>
<li><strong>버퍼링</strong>: Alice는 두 파트를 하나의 TCP 전송으로 함께 보내도록 플러시해야 한다</li>
<li><strong>선택적 체이닝</strong>: 효율을 위해 Alice는 즉시 data phase frame(데이터 단계 프레임)을 이어붙일 수 있다</li>
</ol>
<h2 id="데이터-단계">데이터 단계</h2>
<p>핸드셰이크가 완료된 후에는 모든 메시지가 난독화된 길이 필드를 가진 가변 길이 AEAD(연관 데이터가 포함된 인증 암호화) 프레임을 사용합니다.</p>
<h3 id="키-파생-함수데이터-단계">키 파생 함수(데이터 단계)</h3>
<p><strong>Split 함수(Noise 프로토콜):</strong></p>
<pre tabindex="0"><code>// Generate transmit and receive keys
zerolen = &#34;&#34;  // Zero-length byte array
temp_key = HMAC-SHA256(ck, zerolen)

// Alice transmits to Bob
k_ab = HMAC-SHA256(temp_key, byte(0x01))

// Bob transmits to Alice  
k_ba = HMAC-SHA256(temp_key, k_ab || byte(0x02))

// Cleanup
ck = zeros(32)
temp_key = zeros(32)
</code></pre><p><strong>SipHash 키 파생:</strong></p>
<pre tabindex="0"><code>// Generate additional symmetric key for SipHash
ask_master = HMAC-SHA256(temp_key, &#34;ask&#34; || byte(0x01))

// &#34;siphash&#34; is 7 bytes US-ASCII
temp_key2 = HMAC-SHA256(ask_master, h || &#34;siphash&#34;)
sip_master = HMAC-SHA256(temp_key2, byte(0x01))

// Alice to Bob SipHash keys
temp_key3 = HMAC-SHA256(sip_master, zerolen)
sipkeys_ab = HMAC-SHA256(temp_key3, byte(0x01))
sipk1_ab = sipkeys_ab[0:7]   // 8 bytes, little-endian
sipk2_ab = sipkeys_ab[8:15]  // 8 bytes, little-endian
sipiv_ab = sipkeys_ab[16:23] // 8 bytes, IV

// Bob to Alice SipHash keys
sipkeys_ba = HMAC-SHA256(temp_key3, sipkeys_ab || byte(0x02))
sipk1_ba = sipkeys_ba[0:7]   // 8 bytes, little-endian
sipk2_ba = sipkeys_ba[8:15]  // 8 bytes, little-endian
sipiv_ba = sipkeys_ba[16:23] // 8 bytes, IV
</code></pre><h3 id="프레임-구조">프레임 구조</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|Obfs Len |                             |
+----+----+    ChaChaPoly Frame         +
|    Encrypted Block Data               |
+    k_ab (Alice→Bob) or k_ba (Bob→Alice)|
|    Nonce starts at 0, increments      |
+    No associated data (empty string)  +
|                                       |
~           .   .   .                   ~
|                                       |
+----+----+----+----+----+----+----+----+
|    Poly1305 MAC (16 bytes)            |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>프레임 제약 조건:</strong> - 최소: 18바이트 (2바이트 난독화된 길이 + 0바이트 평문 + 16바이트 MAC(메시지 인증 코드)) - 최대: 65537바이트 (2바이트 난독화된 길이 + 65535바이트 프레임) - 권장: 프레임당 수 KB (수신 지연을 최소화)</p>
<h3 id="siphash-길이-난독화">SipHash 길이 난독화</h3>
<p><strong>목적</strong>: DPI(딥 패킷 검사)가 프레임 경계를 식별하는 것을 방지</p>
<p><strong>알고리즘:</strong></p>
<pre tabindex="0"><code>// Initialization (per direction)
IV[0] = sipiv  // From KDF

// For each frame:
IV[n] = SipHash-2-4(sipk1, sipk2, IV[n-1])
Mask[n] = IV[n][0:1]  // First 2 bytes of IV
ObfuscatedLength = ActualLength XOR Mask[n]

// Send 2-byte ObfuscatedLength, then ActualLength bytes
</code></pre><p><strong>디코딩:</strong></p>
<pre tabindex="0"><code>// Receiver maintains identical IV chain
IV[n] = SipHash-2-4(sipk1, sipk2, IV[n-1])
Mask[n] = IV[n][0:1]
ActualLength = ObfuscatedLength XOR Mask[n]
// Read ActualLength bytes (includes 16-byte MAC)
</code></pre><p><strong>참고:</strong> - 각 방향(Alice→Bob 및 Bob→Alice)에 대해 별도의 IV(초기화 벡터) 체인을 사용 - SipHash가 uint64를 반환하는 경우, 최하위 2바이트를 마스크로 사용 - uint64를 little-endian 바이트로 변환하여 다음 IV로 사용</p>
<h3 id="블록-형식">블록 형식</h3>
<p>각 프레임에는 0개 이상의 블록이 포함됩니다:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|Type| Length  |       Data              |
+----+----+----+                        +
|                                       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+

Type  : 1 byte  - Block type identifier
Length: 2 bytes - Big-endian, data size (0-65516)
Data  : Variable length payload
</code></pre><p><strong>크기 제한:</strong> - 최대 프레임: 65535 바이트 (MAC 포함) - 최대 블록 공간: 65519 바이트 (프레임 - 16바이트 MAC) - 최대 단일 블록: 65519 바이트 (3바이트 헤더 + 65516바이트 데이터)</p>
<h3 id="블록-유형">블록 유형</h3>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Name</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">0</td><td style="border:1px solid var(--color-border); padding:0.5rem;">DateTime</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Time synchronization (4-byte timestamp)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Options</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Padding parameters, dummy traffic</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2</td><td style="border:1px solid var(--color-border); padding:0.5rem;">RouterInfo</td><td style="border:1px solid var(--color-border); padding:0.5rem;">RouterInfo delivery/flooding</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3</td><td style="border:1px solid var(--color-border); padding:0.5rem;">I2NP</td><td style="border:1px solid var(--color-border); padding:0.5rem;">I2NP message with shortened header</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Termination</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Explicit connection close</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">224-253</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Experimental features</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">254</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Padding</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Random padding (must be last)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">255</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Future extensions</td></tr>
  </tbody>
</table>
**블록 순서 규칙:** - **메시지 3 파트 2**: RouterInfo(라우터 정보), 옵션 (선택 사항), 패딩 (선택 사항) - 다른 유형은 없음 - **데이터 단계**: 다음 예외를 제외하고 임의 순서:   - 패딩은 존재하는 경우 반드시 마지막 블록이어야 함   - 종료는 존재하는 경우(패딩 제외) 반드시 마지막 블록이어야 함 - 프레임당 I2NP 블록 여러 개 허용 - 프레임당 패딩 블록 여러 개는 허용되지 않음
<h3 id="블록-유형-0-datetime">블록 유형 0: DateTime</h3>
<p>clock skew(클록 간 시간 불일치) 감지를 위한 시간 동기화.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+
| 0  |    4    |     timestamp     |
+----+----+----+----+----+----+----+

Type     : 0
Length   : 4 (big-endian)
Timestamp: 4 bytes, Unix seconds (big-endian)
</code></pre><p><strong>구현</strong>: 시계 오차 누적을 방지하기 위해 가장 가까운 초로 반올림합니다.</p>
<h3 id="블록-유형-1-옵션">블록 유형 1: 옵션</h3>
<p>패딩 및 트래픽 셰이핑 매개변수.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 1  |  size   |tmin|tmax|rmin|rmax|tdmy|
+----+----+----+----+----+----+----+----+
|tdmy|  rdmy   |  tdelay |  rdelay |    |
+----+----+----+----+----+----+----+    +
|         more_options (TBD)            |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+

Type  : 1
Length: 12+ bytes (big-endian)
</code></pre><p><strong>패딩 비율</strong> (4.4 고정소수점 값, value/16.0): - <code>tmin</code>: 송신 최소 패딩 비율 (0.0 - 15.9375) - <code>tmax</code>: 송신 최대 패딩 비율 (0.0 - 15.9375) - <code>rmin</code>: 수신 최소 패딩 비율 (0.0 - 15.9375) - <code>rmax</code>: 수신 최대 패딩 비율 (0.0 - 15.9375)</p>
<p><strong>예시:</strong> - 0x00 = 0% 패딩 - 0x01 = 6.25% 패딩 - 0x10 = 100% 패딩 (1:1 비율) - 0x80 = 800% 패딩 (8:1 비율)</p>
<p><strong>더미 트래픽:</strong> - <code>tdmy</code>: 보내기를 허용하는 최대치 (2바이트, 초당 바이트 평균) - <code>rdmy</code>: 수신 요청치 (2바이트, 초당 바이트 평균)</p>
<p><strong>지연 삽입:</strong> - <code>tdelay</code>: 삽입하려는 최대치 (2바이트, 밀리초 평균) - <code>rdelay</code>: 요청된 지연 (2바이트, 밀리초 평균)</p>
<p><strong>지침:</strong> - 최소값은 원하는 트래픽 분석 저항성을 나타낸다 - 최대값은 대역폭 제약을 나타낸다 - 송신자는 수신자의 최대값을 존중해야 한다 - 송신자는 제약 내에서 수신자의 최소값을 존중할 수 있다 - 강제 메커니즘은 없음; 구현은 달라질 수 있음</p>
<h3 id="블록-유형-2-routerinfo">블록 유형 2: RouterInfo</h3>
<p>netdb 구축 및 flooding(브로드캐스트식 전파)을 위한 RouterInfo 배포.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 2  |  size   |flg |    RouterInfo     |
+----+----+----+----+                   +
|                                       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+

Type : 2
Length: Flag (1 byte) + RouterInfo size
Flag : Bit 0 = flood request (1) or local store (0)
       Bits 1-7 = Reserved, set to 0
</code></pre><p><strong>사용법:</strong></p>
<p><strong>메시지 3 파트 2에서</strong> (핸드셰이크): - Alice가 자신의 RouterInfo(라우터 정보)를 Bob에게 보냄 - Flood bit는 보통 0(로컬 저장) - RouterInfo는 gzip으로 압축되지 않음</p>
<p><strong>데이터 단계에서:</strong> - 양측 중 어느 한쪽은 업데이트된 RouterInfo를 보낼 수 있음 - Flood bit(플러드 비트) = 1: floodfill 배포를 요청(수신자가 floodfill인 경우) - Flood bit = 0: 로컬 netdb 저장만</p>
<p><strong>검증 요구 사항:</strong> 1. 서명 유형이 지원되는지 확인 2. RouterInfo 서명 확인 3. 타임스탬프가 허용 범위 내에 있는지 확인 4. 핸드셰이크의 경우: 정적 키가 NTCP2 주소의 &ldquo;s&rdquo; 매개변수와 일치하는지 확인 5. 데이터 단계의 경우: router 해시가 세션 피어와 일치하는지 확인 6. 공개된 주소가 있는 RouterInfos만 전파</p>
<p><strong>참고:</strong> - ACK 메커니즘 없음(필요한 경우 reply token(응답 토큰)과 함께 I2NP DatabaseStore 사용) - 제3자 RouterInfos(라우터 정보)를 포함할 수 있음(floodfill 사용) - gzip으로 압축되지 않음(I2NP DatabaseStore와 달리)</p>
<h3 id="블록-유형-3-i2np-메시지">블록 유형 3: I2NP 메시지</h3>
<p>축약된 9바이트 헤더를 가진 I2NP 메시지.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 3  |  size   |type|    msg_id         |
+----+----+----+----+----+----+----+----+
|   expiration  |     I2NP payload      |
+----+----+----+                        +
|                                       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+

Type      : 3
Length    : 9 + payload_size (big-endian)
Type      : 1 byte, I2NP message type
Msg_ID    : 4 bytes, big-endian, I2NP message ID
Expiration: 4 bytes, big-endian, Unix timestamp (seconds)
Payload   : I2NP message body (length = size - 9)
</code></pre><p><strong>NTCP1과의 차이점:</strong> - 만료 시각: 4바이트(초) vs 8바이트(밀리초) - 길이: 생략됨(블록 길이에서 도출 가능) - 체크섬: 생략됨(AEAD가 무결성을 제공) - 헤더: 9바이트 vs 16바이트(44% 감소)</p>
<p><strong>단편화:</strong> - I2NP 메시지는 블록 간 분할되어서는 안 됩니다 - I2NP 메시지는 프레임 간 분할되어서는 안 됩니다 - 프레임당 여러 I2NP 블록이 허용됩니다</p>
<h3 id="블록-유형-4-종료">블록 유형 4: 종료</h3>
<p>사유 코드를 포함한 명시적 연결 종료.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 4  |  size   |  valid_frames_recv    |
+----+----+----+----+----+----+----+----+
| (continued) |rsn |   additional_data   |
+----+----+----+----+                   +
|                                       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+

Type            : 4
Length          : 9+ bytes (big-endian)
Valid_Frames_Recv: 8 bytes, big-endian (receive nonce value)
                  0 if error in handshake phase
Reason          : 1 byte (see table below)
Additional_Data : Optional (format unspecified, for debugging)
</code></pre><p><strong>사유 코드:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Code</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Reason</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Phase</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">0</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Normal close / unspecified</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Any</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Termination received</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Idle timeout</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Router shutdown</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data phase AEAD failure</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">5</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Incompatible options</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">6</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Incompatible signature type</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">7</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Clock skew</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">8</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Padding violation</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Any</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">9</td><td style="border:1px solid var(--color-border); padding:0.5rem;">AEAD framing error</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">10</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Payload format error</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">11</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Message 1 error</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">12</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Message 2 error</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">13</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Message 3 error</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">14</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Intra-frame read timeout</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">15</td><td style="border:1px solid var(--color-border); padding:0.5rem;">RouterInfo signature verification fail</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">16</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Static key parameter mismatch</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">17</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Banned</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Any</td></tr>
  </tbody>
</table>
**규칙:** - 종료 블록은 프레임 내에서 패딩이 아닌 마지막 블록이어야 함 - 프레임당 종료 블록은 최대 1개 - 송신자는 전송 후 연결을 닫는 것이 바람직함 - 수신자는 수신 후 연결을 닫는 것이 바람직함
<p><strong>오류 처리:</strong> - 핸드셰이크 오류: 일반적으로 TCP RST로 종료(종료 블록 없음) - 데이터 단계 AEAD 오류: 무작위 타임아웃 + 무작위 읽기, 그런 다음 종료 전송 - 보안 절차는 &ldquo;AEAD Error Handling&rdquo; 섹션을 참조하십시오</p>
<h3 id="블록-유형-254-패딩">블록 유형 254: 패딩</h3>
<p>트래픽 분석 저항성을 위한 무작위 패딩.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|254 |  size   |     random_data       |
+----+----+----+                        +
|                                       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+

Type: 254
Length: 0-65516 bytes (big-endian)
Data: Cryptographically random bytes
</code></pre><p><strong>규칙:</strong> - 패딩이 존재하는 경우 프레임 내에서 마지막 블록이어야 함 - 길이가 0인 패딩은 허용됨 - 프레임당 패딩 블록은 하나만 허용됨 - 패딩만 있는 프레임은 허용됨 - Options 블록에서 협상된 매개변수를 준수해야 함</p>
<p><strong>메시지 1-2의 패딩:</strong> - AEAD(연관 데이터가 있는 인증된 암호화) 프레임 바깥(평문) - 다음 메시지의 해시 체인에 포함됨(인증됨) - 다음 메시지의 AEAD가 실패하면 변조가 탐지됨</p>
<p><strong>메시지 3+ 및 데이터 단계의 패딩:</strong> - AEAD 프레임 내부(암호화 및 인증됨) - 트래픽 셰이핑과 크기 은폐에 사용됨</p>
<h2 id="aead-오류-처리">AEAD 오류 처리</h2>
<p><strong>핵심 보안 요구사항:</strong></p>
<h3 id="핸드셰이크-단계-메시지-1-3">핸드셰이크 단계 (메시지 1-3)</h3>
<p><strong>알려진 메시지 크기:</strong> - 메시지 크기는 미리 정해지거나 사전에 지정됨 - AEAD(연관 데이터가 있는 인증 암호화) 인증 실패는 모호하지 않음</p>
<p><strong>Bob의 메시지 1 실패에 대한 대응:</strong> 1. 임의의 타임아웃 설정(범위는 구현에 따라 다름, 권장 100–500ms) 2. 임의의 바이트 수 읽기(범위는 구현에 따라 다름, 권장 1KB–64KB) 3. TCP RST로 연결 종료(응답 없이) 4. 소스 IP를 일시적으로 차단 목록에 추가 5. 장기 차단을 위해 반복된 실패를 추적</p>
<p><strong>메시지 2 실패에 대한 Alice의 대응:</strong> 1. TCP RST로 즉시 연결을 종료 2. Bob에게 응답하지 않음</p>
<p><strong>메시지 3 실패에 대한 Bob의 응답:</strong> 1. TCP RST(TCP 재설정)로 즉시 연결 종료 2. Alice에게 응답 없음</p>
<h3 id="데이터-단계-1">데이터 단계</h3>
<p><strong>난독화된 메시지 크기:</strong> - 길이 필드는 SipHash(경량 MAC 함수)로 난독화됨 - 잘못된 길이이거나 AEAD(연관 데이터가 있는 인증된 암호화) 실패는 다음을 의미할 수 있음:   - 공격자 프로빙(탐색)   - 네트워크 손상   - 비동기화된 SipHash IV(초기화 벡터)   - 악의적인 피어</p>
<p><strong>AEAD(연관 데이터가 있는 인증 암호화) 또는 길이 오류에 대한 응답:</strong> 1. 임의의 타임아웃을 설정한다 (권장 100-500ms) 2. 임의의 바이트 수를 읽는다 (권장 1KB-64KB) 3. 사유 코드 4(AEAD 실패) 또는 9(프레이밍 오류)가 포함된 종료 블록을 전송한다 4. 연결을 종료한다</p>
<p><strong>복호화 오라클 방지:</strong> - 임의의 타임아웃이 지나기 전에는 피어에게 오류 유형을 절대 공개하지 말 것 - AEAD(연관 데이터 인증 암호화) 검사를 수행하기 전에 길이 검증을 절대로 건너뛰지 말 것 - 유효하지 않은 길이는 AEAD 실패와 동일하게 취급할 것 - 두 오류 모두에 대해 동일한 오류 처리 경로를 사용할 것</p>
<p><strong>구현 시 고려사항:</strong> - AEAD(인증된 연관 데이터 암호화) 오류가 드물다면 일부 구현은 계속 진행할 수 있음 - 반복적으로 오류가 발생할 경우 종료 (권장 임계값: 시간당 3-5회 오류) - 오류 복구와 보안 간 균형 유지</p>
<h2 id="게시된-routerinfo">게시된 RouterInfo</h2>
<h3 id="router-주소-형식">Router 주소 형식</h3>
<p>NTCP2 지원 여부는 특정 옵션이 포함된 공개된 RouterAddress 항목을 통해 고지됩니다.</p>
<p><strong>전송 방식:</strong> - <code>&quot;NTCP2&quot;</code> - 이 포트에서 NTCP2만 사용 - <code>&quot;NTCP&quot;</code> - 이 포트에서 NTCP와 NTCP2 모두 사용(자동 감지)   - <strong>참고</strong>: NTCP (v1) 지원은 0.9.50(2021년 5월)에서 제거됨   - &ldquo;NTCP&rdquo; 스타일은 이제 사용 중단됨; &ldquo;NTCP2&quot;를 사용하세요</p>
<h3 id="필수-옵션">필수 옵션</h3>
<p><strong>모든 공개된 NTCP2 주소:</strong></p>
<ol>
<li>
<p><strong><code>host</code></strong> - IP 주소(IPv4 또는 IPv6) 또는 호스트 이름</p>
<ul>
<li>형식: 표준 IP 표기법 또는 도메인 이름</li>
<li>아웃바운드 전용 또는 숨겨진 router의 경우 생략할 수 있음</li>
</ul>
</li>
<li>
<p><strong><code>port</code></strong> - TCP 포트 번호</p>
<ul>
<li>형식: 정수, 1-65535</li>
<li>아웃바운드 전용 또는 숨겨진 router에서는 생략될 수 있음</li>
</ul>
</li>
<li>
<p><strong><code>s</code></strong> - 정적 공개 키 (X25519)</p>
<ul>
<li>형식: Base64 인코딩, 44자</li>
<li>인코딩: I2P Base64 알파벳</li>
<li>원본: 32바이트 X25519 공개 키, little-endian(리틀 엔디언)</li>
</ul>
</li>
<li>
<p><strong><code>i</code></strong> - AES용 초기화 벡터(IV)</p>
<ul>
<li>형식: Base64로 인코딩된, 24자</li>
<li>인코딩: I2P Base64 알파벳</li>
<li>원본: 16바이트 IV, 빅엔디언</li>
</ul>
</li>
<li>
<p><strong><code>v</code></strong> - 프로토콜 버전</p>
<ul>
<li>형식: 정수 또는 쉼표로 구분된 정수들</li>
<li>현재: <code>&quot;2&quot;</code></li>
<li>향후: <code>&quot;2,3&quot;</code> (숫자 순서여야 함)</li>
</ul>
</li>
</ol>
<p><strong>선택적 옵션:</strong></p>
<ol start="6">
<li>
<p><strong><code>caps</code></strong> - Capabilities(기능) (0.9.50부터)</p>
<ul>
<li>형식: capability 문자로 이루어진 문자열</li>
<li>값:
<ul>
<li><code>&quot;4&quot;</code> - IPv4 아웃바운드 기능</li>
<li><code>&quot;6&quot;</code> - IPv6 아웃바운드 기능</li>
<li><code>&quot;46&quot;</code> - IPv4와 IPv6 모두 (권장 순서)</li>
</ul>
</li>
<li><code>host</code>가 공개된 경우 필요 없음</li>
<li>숨겨진/방화벽 뒤에 있는 routers에 유용함</li>
</ul>
</li>
<li>
<p><strong><code>cost</code></strong> - 주소 우선순위</p>
<ul>
<li>형식: 정수, 0-255</li>
<li>값이 낮을수록 = 우선순위가 높음</li>
<li>권장: 일반 주소의 경우 5-10</li>
<li>권장: 미공개 주소의 경우 14</li>
</ul>
</li>
</ol>
<h3 id="routeraddress-엔트리-예시">RouterAddress 엔트리 예시</h3>
<p><strong>공개된 IPv4 주소:</strong></p>
<pre tabindex="0"><code>&lt;Address cost=&#34;5&#34;&gt;
  &lt;transport_style&gt;NTCP2&lt;/transport_style&gt;
  &lt;options&gt;
    &lt;host&gt;192.0.2.1&lt;/host&gt;
    &lt;port&gt;8887&lt;/port&gt;
    &lt;s&gt;9EjeG7BZeznKbL9a2fXx8JBDPgLZbLmKbqY3QrNGJCo=&lt;/s&gt;
    &lt;i&gt;MDEyMzQ1Njc4OUFCQ0RFRg==&lt;/i&gt;
    &lt;v&gt;2&lt;/v&gt;
  &lt;/options&gt;
&lt;/Address&gt;
</code></pre><p><strong>숨겨진 Router (아웃바운드 전용):</strong></p>
<pre tabindex="0"><code>&lt;Address cost=&#34;14&#34;&gt;
  &lt;transport_style&gt;NTCP2&lt;/transport_style&gt;
  &lt;options&gt;
    &lt;s&gt;9EjeG7BZeznKbL9a2fXx8JBDPgLZbLmKbqY3QrNGJCo=&lt;/s&gt;
    &lt;v&gt;2&lt;/v&gt;
    &lt;caps&gt;4&lt;/caps&gt;
  &lt;/options&gt;
&lt;/Address&gt;
</code></pre><p><strong>듀얼 스택 Router:</strong></p>
<pre tabindex="0"><code>&lt;!-- IPv4 Address --&gt;
&lt;Address cost=&#34;5&#34;&gt;
  &lt;transport_style&gt;NTCP2&lt;/transport_style&gt;
  &lt;options&gt;
    &lt;host&gt;192.0.2.1&lt;/host&gt;
    &lt;port&gt;8887&lt;/port&gt;
    &lt;s&gt;9EjeG7BZeznKbL9a2fXx8JBDPgLZbLmKbqY3QrNGJCo=&lt;/s&gt;
    &lt;i&gt;MDEyMzQ1Njc4OUFCQ0RFRg==&lt;/i&gt;
    &lt;v&gt;2&lt;/v&gt;
  &lt;/options&gt;
&lt;/Address&gt;

&lt;!-- IPv6 Address (same keys, same port) --&gt;
&lt;Address cost=&#34;5&#34;&gt;
  &lt;transport_style&gt;NTCP2&lt;/transport_style&gt;
  &lt;options&gt;
    &lt;host&gt;2001:db8::1&lt;/host&gt;
    &lt;port&gt;8887&lt;/port&gt;
    &lt;s&gt;9EjeG7BZeznKbL9a2fXx8JBDPgLZbLmKbqY3QrNGJCo=&lt;/s&gt;
    &lt;i&gt;MDEyMzQ1Njc4OUFCQ0RFRg==&lt;/i&gt;
    &lt;v&gt;2&lt;/v&gt;
  &lt;/options&gt;
&lt;/Address&gt;
</code></pre><p><strong>중요 규칙:</strong> - <strong>동일한 포트</strong>를 사용하는 여러 NTCP2 주소는 <code>s</code>, <code>i</code>, <code>v</code> 값이 반드시 <strong>동일해야</strong> 합니다 - 서로 다른 포트는 서로 다른 키를 사용할 수 있습니다 - 듀얼스택 router는 IPv4와 IPv6 주소를 별도로 게시해야 합니다</p>
<h3 id="공개되지-않은-ntcp2-주소">공개되지 않은 NTCP2 주소</h3>
<p><strong>아웃바운드 전용 Routers의 경우:</strong></p>
<p>router가 수신 NTCP2 연결을 허용하지 않지만 송신 연결은 개시하는 경우에도, 여전히 다음을 포함하는 RouterAddress(라우터 주소 정보)를 발행해야 한다:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;Address</span> <span style="color:#a6e22e">cost=</span><span style="color:#e6db74">&#34;14&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;transport_style&gt;</span>NTCP2<span style="color:#f92672">&lt;/transport_style&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;options&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;s&gt;</span>9EjeG7BZeznKbL9a2fXx8JBDPgLZbLmKbqY3QrNGJCo=<span style="color:#f92672">&lt;/s&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;v&gt;</span>2<span style="color:#f92672">&lt;/v&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/options&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/Address&gt;</span>
</span></span></code></pre></div><p><strong>목적:</strong> - 핸드셰이크 중 Bob이 Alice의 정적 키를 검증할 수 있도록 함 - 메시지 3 파트 2의 RouterInfo 검증에 필요 - <code>i</code>, <code>host</code>, <code>port</code>가 필요 없음 (아웃바운드 전용)</p>
<p><strong>대안:</strong> - 기존에 공개된 &ldquo;NTCP&rdquo; 또는 SSU 주소에 <code>s</code>와 <code>v</code>를 추가합니다</p>
<h3 id="공개-키-및-iv초기화-벡터-로테이션">공개 키 및 IV(초기화 벡터) 로테이션</h3>
<p><strong>중요 보안 정책:</strong></p>
<p><strong>일반 규칙:</strong> 1. <strong>router가 실행 중일 때는 절대 rotate(교체)하지 마십시오</strong> 2. <strong>키와 IV(초기화 벡터)를 영구적으로 저장</strong> 재시작 간에도 3. <strong>이전 다운타임을 추적</strong> rotation 적용 가능 여부를 판단하기 위해</p>
<p><strong>로테이션 전에 필요한 최소 다운타임:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Router Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Min Downtime</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Reason</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Published NTCP2 address</td><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>1 month</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Many routers cache RouterInfo</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Published SSU only (no NTCP2)</td><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>1 day</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Moderate caching</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">No published addresses (hidden)</td><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>2 hours</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Minimal impact</td></tr>
  </tbody>
</table>
**추가 트리거:** - 로컬 IP 주소 변경: 다운타임 여부와 상관없이 변경될 수 있음 - Router "rekey" (새 Router Hash): 새 키 생성
<p><strong>근거:</strong> - 키 변경을 통해 재시작 시간을 노출하는 것을 방지 - 캐시된 RouterInfos(라우터 정보 객체)가 자연스럽게 만료되도록 허용 - 네트워크 안정성을 유지 - 실패한 연결 시도를 줄임</p>
<p><strong>구현:</strong> 1. 키, IV(초기화 벡터), 마지막 종료 타임스탬프를 영구적으로 저장한다 2. 시작 시, downtime 값을 current_time - last_shutdown으로 계산한다 3. downtime가 router 유형의 최소값을 초과하면 키를 교체할 수 있다 4. IP가 변경되었거나 rekeying(키를 다시 생성하는 작업)이면 키를 교체할 수 있다 5. 그렇지 않으면 이전 키와 IV를 재사용한다</p>
<p><strong>IV 회전:</strong> - 키 회전과 동일한 규칙이 적용됨 - 공개된 주소에만 존재함 (숨겨진 routers에는 해당 없음) - 키가 변경될 때마다 IV를 변경할 것을 권장</p>
<h2 id="버전-감지">버전 감지</h2>
<p><strong>맥락:</strong> <code>transportStyle=&quot;NTCP&quot;</code> (레거시)인 경우, Bob은 동일한 포트에서 NTCP v1과 v2를 모두 지원하며 프로토콜 버전을 자동으로 감지해야 합니다.</p>
<p><strong>탐지 알고리즘:</strong></p>
<pre tabindex="0"><code>1. Wait for at least 64 bytes (minimum NTCP2 message 1 size)

2. If received ≥ 288 bytes:
   → Connection is NTCP version 1 (NTCP1 message 1 is 288 bytes)

3. If received &lt; 288 bytes:
   
   Option A (conservative, pre-NTCP2 majority):
   a. Wait additional short time (e.g., 100-500ms)
   b. If total received ≥ 288 bytes → NTCP1
   c. Otherwise → Attempt NTCP2 decode
   
   Option B (aggressive, post-NTCP2 majority):
   a. Attempt NTCP2 decode immediately:
      - Decrypt first 32 bytes (X key) with AES-256-CBC
      - Verify valid X25519 point (X[31] &amp; 0x80 == 0)
      - Verify AEAD frame
   b. If decode succeeds → NTCP2
   c. If decode fails → Wait for more data or NTCP1
</code></pre><p><strong>빠른 MSB 검사:</strong> - AES 복호화 전에 다음을 확인: <code>encrypted_X[31] &amp; 0x80 == 0</code> - 유효한 X25519 키는 최상위 비트가 클리어되어 있음 - 실패 시 NTCP1(또는 공격)일 가능성이 높음 - 실패 시 probing resistance(탐침 방어) 구현(무작위 타임아웃 + 읽기)</p>
<p><strong>구현 요구 사항:</strong></p>
<ol>
<li>
<p><strong>Alice의 책임:</strong></p>
<ul>
<li>&ldquo;NTCP&rdquo; 주소에 연결할 때, 메시지 1의 크기를 최대 287바이트로 제한</li>
<li>메시지 1 전체를 버퍼링하고 한 번에 플러시</li>
<li>단일 TCP 패킷으로 전송될 가능성을 높임</li>
</ul>
</li>
<li>
<p><strong>Bob의 책임:</strong></p>
<ul>
<li>버전을 판별하기 전에 수신된 데이터를 버퍼링할 것</li>
<li>적절한 타임아웃 처리를 구현할 것</li>
<li>빠른 버전 판별을 위해 TCP_NODELAY(Nagle algorithm 비활성화 옵션)을 사용할 것</li>
<li>버전 판별 후 메시지 2 전체를 버퍼에 모아 한 번에 플러시할 것</li>
</ul>
</li>
</ol>
<p><strong>보안 고려사항:</strong> - 세그멘테이션 공격: Bob은 TCP 세그멘테이션에 내성이 있어야 함 - 프로빙 공격: 실패 시 무작위 지연과 바이트 읽기를 구현 - DoS 방지: 대기 중인 동시 연결 수를 제한 - 읽기 타임아웃: 개별 읽기와 전체 둘 다 (&ldquo;slowloris&rdquo;(연결을 길게 유지하며 요청을 지연시켜 자원을 고갈시키는 공격) 방어)</p>
<h2 id="시계-오차-지침">시계 오차 지침</h2>
<p><strong>타임스탬프 필드:</strong> - 메시지 1: <code>tsA</code> (Alice의 타임스탬프) - 메시지 2: <code>tsB</code> (Bob의 타임스탬프) - 메시지 3+: 선택적 DateTime 블록</p>
<p><strong>최대 시간 오차(D):</strong> - 일반적: <strong>±60초</strong> - 구현별로 설정 가능 - 시간 오차 &gt; D는 일반적으로 치명적임</p>
<h3 id="bob의-처리-메시지-1">Bob의 처리 (메시지 1)</h3>
<pre tabindex="0"><code>1. Receive tsA from Alice
2. skew = tsA - current_time
3. If |skew| &gt; D:
   a. Still send message 2 (allows Alice to calculate skew)
   b. Include tsB in message 2
   c. Do NOT initiate handshake completion
   d. Optionally: Temporary ban Alice&#39;s IP
   e. After message 2 sent, close connection

4. If |skew| ≤ D:
   a. Continue handshake normally
</code></pre><p><strong>이유:</strong> skew(클록 오차) 상태에서도 메시지 2를 보내면 Alice가 클록 문제를 진단할 수 있다.</p>
<h3 id="앨리스의-처리-메시지-2">앨리스의 처리 (메시지 2)</h3>
<pre tabindex="0"><code>1. Receive tsB from Bob
2. RTT = (current_time_now - tsA_sent)
3. adjusted_skew = (tsB - current_time_now) - (RTT / 2)
4. If |adjusted_skew| &gt; D:
   a. Close connection immediately
   b. If local clock suspect: Adjust clock or use external time source
   c. If Bob&#39;s clock suspect: Temporary ban Bob
   d. Log for operator review
5. If |adjusted_skew| ≤ D:
   a. Continue handshake normally
   b. Optionally: Track skew for time synchronization
</code></pre><p><strong>RTT 조정:</strong> - 계산된 스큐(시간 편차)에서 RTT의 절반을 빼기 - 네트워크 전파 지연을 반영 - 더 정확한 스큐 추정</p>
<h3 id="bob의-처리-메시지-3">Bob의 처리 (메시지 3)</h3>
<pre tabindex="0"><code>1. If message 3 received (unlikely if skew exceeded in message 1)
2. Recalculate skew = tsA_received - current_time
3. If |adjusted_skew| &gt; D:
   a. Send termination block (reason code 7: clock skew)
   b. Close connection
   c. Ban Alice for period (e.g., 1-24 hours)
</code></pre><h3 id="시간-동기화">시간 동기화</h3>
<p><strong>DateTime 블록(데이터 단계):</strong> - 주기적으로 DateTime 블록 전송 (type 0) - 수신자는 시계 조정에 사용할 수 있음 - 타임스탬프를 가장 가까운 초로 반올림 (편향 방지)</p>
<p><strong>외부 시간 소스:</strong> - NTP(네트워크 시간 프로토콜) - 시스템 시계 동기화 - I2P 네트워크 합의 시간</p>
<p><strong>클록 조정 전략:</strong> - 로컬 클록이 잘못된 경우: 시스템 시간을 조정하거나 오프셋 사용 - 피어 클록이 지속적으로 잘못된 경우: 피어 문제로 플래그 지정 - 네트워크 건전성 모니터링을 위해 clock skew(시간 오차) 통계를 추적</p>
<h2 id="보안-속성">보안 속성</h2>
<h3 id="순방향-기밀성">순방향 기밀성</h3>
<p><strong>다음 방식으로 달성:</strong> - 임시 Diffie-Hellman 키 교환 (X25519) - 세 가지 DH 연산: es, ee, se (Noise XK pattern: Noise 프로토콜의 XK 패턴) - 핸드셰이크 완료 후 임시 키 파기</p>
<p><strong>기밀성 진행:</strong> - 메시지 1: 레벨 2 (발신자 키 유출 시 forward secrecy(순방향 보안)) - 메시지 2: 레벨 1 (임시 수신자) - 메시지 3+: 레벨 5 (강력한 forward secrecy)</p>
<p><strong>완전 순방향 기밀성(Perfect Forward Secrecy, PFS):</strong> - 장기 정적 키가 유출되어도 과거 세션 키는 공개되지 않습니다 - 각 세션은 고유한 임시 키를 사용합니다 - 임시 개인 키는 절대 재사용하지 않습니다 - 키 합의 후 메모리 정리</p>
<p><strong>제한 사항:</strong> - Bob의 정적 키가 탈취되면 메시지 1은 취약해진다(단, Alice가 침해되더라도 Forward Secrecy(전방향 기밀성)은 유지됨) - 메시지 1에 대해 재전송 공격 가능(타임스탬프와 재전송 캐시로 완화됨)</p>
<h3 id="인증">인증</h3>
<p><strong>상호 인증:</strong> - Alice는 메시지 3의 정적 키로 인증됨 - Bob은 정적 개인 키를 보유함으로써 인증됨 (성공적인 핸드셰이크에서 암시됨)</p>
<p><strong>Key Compromise Impersonation (KCI, 키 손상에 의한 사칭) 저항성:</strong> - 인증 레벨 2 (KCI에 내성) - 공격자는 Alice의 정적 개인 키만으로는 (Alice의 임시 키 없이) Alice를 사칭할 수 없음 - 공격자는 Bob의 정적 개인 키만으로는 (Bob의 임시 키 없이) Bob을 사칭할 수 없음</p>
<p><strong>정적 키 검증:</strong> - Alice는 Bob의 정적 키를 미리 알고 있음(RouterInfo(라우터 정보)에서) - Bob은 메시지 3에서 Alice의 정적 키가 RouterInfo와 일치하는지 검증함 - 중간자 공격을 방지함</p>
<h3 id="트래픽-분석에-대한-저항성">트래픽 분석에 대한 저항성</h3>
<p><strong>DPI(딥 패킷 검사) 대응책:</strong> 1. <strong>AES 난독화:</strong> 임시 키가 암호화되어 무작위처럼 보임 2. <strong>SipHash 길이 난독화:</strong> 프레임 길이는 평문이 아님 3. <strong>무작위 패딩:</strong> 메시지 크기가 가변적이며, 고정된 패턴이 없음 4. <strong>암호화된 프레임:</strong> 모든 페이로드는 ChaCha20으로 암호화됨</p>
<p><strong>리플레이(재전송) 공격 방지:</strong> - 타임스탬프 검증(±60초) - ephemeral 키에 대한 replay 캐시(수명 2*D) - Nonce(일회용 임의값) 증가로 세션 내 패킷 재전송을 방지</p>
<p><strong>프로빙 저항성:</strong> - AEAD(부가 데이터가 포함된 인증된 암호화) 실패 시 임의의 타임아웃 - 연결 종료 전에 임의의 바이트 읽기 - 핸드셰이크 실패 시 응답 없음 - 반복된 실패 시 IP 블랙리스트 등재</p>
<p><strong>패딩 지침:</strong> - 메시지 1-2: 평문 패딩(인증됨) - 메시지 3+: AEAD(연관 데이터가 포함된 인증 암호) 프레임 내부의 암호화된 패딩 - 협상된 패딩 매개변수(Options 블록) - 패딩 전용 프레임 허용됨</p>
<h3 id="서비스-거부dos-완화">서비스 거부(DoS) 완화</h3>
<p><strong>연결 제한:</strong> - 최대 활성 연결 수(구현에 따라 다름) - 대기 중인 핸드셰이크의 최대치(예: 100-1000) - IP당 연결 제한(예: 동시 3-10개)</p>
<p><strong>리소스 보호:</strong> - DH 연산 속도 제한 (비용이 큼) - 소켓별 및 전체 읽기 타임아웃 - &ldquo;Slowloris&rdquo; 보호 (총 시간 제한) - 남용 방지를 위한 IP 블랙리스트</p>
<p><strong>빠른 거부:</strong> - Network ID 불일치 → 즉시 종료 - 유효하지 않은 X25519 point(타원 곡선 X25519의 점) → 복호화 전에 빠른 최상위 비트(MSB) 검사 - 범위를 벗어난 타임스탬프 → 연산 없이 종료 - AEAD 실패 → 응답 없음, 무작위 지연</p>
<p><strong>프로빙 저항성:</strong> - 임의 타임아웃: 100-500ms (구현에 따라 다름) - 임의 읽기: 1KB-64KB (구현에 따라 다름) - 공격자에게 오류 정보를 제공하지 않음 - TCP RST로 종료 (FIN 핸드셰이크 없음)</p>
<h3 id="암호학적-보안">암호학적 보안</h3>
<p><strong>알고리즘:</strong> - <strong>X25519</strong>: 128비트 보안 강도, 타원곡선 DH (Curve25519) - <strong>ChaCha20</strong>: 256비트 키를 사용하는 스트림 암호 - <strong>Poly1305</strong>: 정보이론적으로 안전한 MAC - <strong>SHA-256</strong>: 128비트 충돌 저항성, 256비트 전이미지 저항성 - <strong>HMAC-SHA256</strong>: 키 파생용 PRF(의사난수 함수)</p>
<p><strong>키 크기:</strong> - 정적 키: 32 바이트 (256 비트) - 임시 키: 32 바이트 (256 비트) - 암호화 키: 32 바이트 (256 비트) - MAC: 16 바이트 (128 비트)</p>
<p><strong>알려진 문제:</strong> - ChaCha20 논스 재사용은 치명적입니다 (카운터 증가로 방지됨) - X25519에는 작은 부분군 문제가 있습니다 (곡선 검증으로 완화됨) - SHA-256은 이론적으로 길이 확장 공격에 취약합니다 (HMAC에서는 악용되지 않음)</p>
<p><strong>알려진 취약점 없음(2025년 10월 기준):</strong> - Noise Protocol Framework(노이즈 프로토콜 프레임워크) 광범위하게 분석됨 - ChaCha20-Poly1305 TLS 1.3에 채택됨 - X25519 최신 프로토콜에서 표준 - 구성에 대한 실질적인 공격 없음</p>
<h2 id="참고-자료">참고 자료</h2>
<h3 id="주요-명세">주요 명세</h3>
<ul>
<li><strong><a href="../../../../ko/docs/specs/ntcp2/">NTCP2 명세</a>
</strong> - 공식 I2P 명세 문서</li>
<li><strong><a href="../../../../ko/proposals/111-ntcp-2/">Proposal 111</a>
</strong> - 설계 근거를 담은 원래 설계 문서</li>
<li><strong><a href="https://noiseprotocol.org/noise.html">Noise Protocol Framework</a>
</strong> (노이즈 프로토콜 프레임워크) - 리비전 33 (2017-10-04)</li>
</ul>
<h3 id="암호화-표준">암호화 표준</h3>
<ul>
<li><strong><a href="https://www.rfc-editor.org/rfc/rfc7748">RFC 7748</a>
</strong> - 보안용 타원 곡선 (X25519)</li>
<li><strong><a href="https://www.rfc-editor.org/rfc/rfc7539">RFC 7539</a>
</strong> - IETF 프로토콜용 ChaCha20 및 Poly1305</li>
<li><strong><a href="https://www.rfc-editor.org/rfc/rfc8439">RFC 8439</a>
</strong> - ChaCha20-Poly1305 (RFC 7539를 대체함)</li>
<li><strong><a href="https://www.rfc-editor.org/rfc/rfc2104">RFC 2104</a>
</strong> - HMAC: 메시지 인증을 위한 키 기반 해시</li>
<li><strong><a href="https://www.131002.net/siphash/">SipHash</a>
</strong> - 해시 함수 응용을 위한 SipHash-2-4</li>
</ul>
<h3 id="관련-i2p-명세">관련 I2P 명세</h3>
<ul>
<li><strong><a href="../../../../ko/docs/specs/i2np/">I2NP 사양</a>
</strong> - I2P 네트워크 프로토콜 메시지 형식</li>
<li><strong><a href="../../../../ko/docs/specs/common-structures/">공통 구조체</a>
</strong> - RouterInfo, RouterAddress 형식</li>
<li><strong><a href="../../../../ko/docs/legacy/ssu/">SSU 전송</a>
</strong> - UDP 전송(원래 버전, 현재는 SSU2)</li>
<li><strong><a href="../../../../ko/proposals/147-transport-network-id-check/">제안 147</a>
</strong> - 전송 네트워크 ID 확인(0.9.42)</li>
</ul>
<h3 id="구현-참고-자료">구현 참고 자료</h3>
<ul>
<li><strong><a href="https://github.com/i2p/i2p.i2p">I2P Java</a>
</strong> - 참조 구현(Java)</li>
<li><strong><a href="https://github.com/PurpleI2P/i2pd">i2pd</a>
</strong> - C++ 구현</li>
<li><strong><a href="../../../../ko/blog/">I2P 릴리스 노트</a>
</strong> - 버전 기록 및 업데이트</li>
</ul>
<h3 id="역사적-맥락">역사적 맥락</h3>
<ul>
<li><strong><a href="https://en.wikipedia.org/wiki/Station-to-Station_protocol">Station-To-Station Protocol (STS)</a>
</strong> - Noise 프레임워크의 영감이 된</li>
<li><strong><a href="https://gitlab.com/yawning/obfs4">obfs4</a>
</strong> - 플러그형 트랜스포트 (SipHash 길이 난독화의 선례)</li>
</ul>
<h2 id="구현-지침">구현 지침</h2>
<h3 id="필수-요구-사항">필수 요구 사항</h3>
<p><strong>규정 준수를 위해:</strong></p>
<ol>
<li>
<p><strong>완전한 핸드셰이크 구현:</strong></p>
<ul>
<li>올바른 KDF(키 파생 함수) 체인을 사용해 세 가지 메시지 모두 지원</li>
<li>모든 AEAD(연관 데이터가 있는 인증된 암호화) 태그를 검증</li>
<li>X25519(ECDH 키 교환) 점이 유효한지 확인</li>
</ul>
</li>
<li>
<p><strong>데이터 단계 구현:</strong></p>
<ul>
<li>SipHash 길이 난독화 (양방향)</li>
<li>모든 블록 타입: 0 (날짜/시간), 1 (옵션), 2 (RouterInfo), 3 (I2NP), 4 (종료), 254 (패딩)</li>
<li>적절한 nonce(일회용 값) 관리 (분리된 카운터)</li>
</ul>
</li>
<li>
<p><strong>보안 기능:</strong></p>
<ul>
<li>재생 공격 방지(2*D 동안 임시 키 캐시)</li>
<li>타임스탬프 검증(기본값 ±60초)</li>
<li>메시지 1-2에 무작위 패딩</li>
<li>무작위 타임아웃을 사용하는 AEAD(부가 데이터가 포함된 인증된 암호화) 오류 처리</li>
</ul>
</li>
<li>
<p><strong>RouterInfo(라우터 정보를 담는 데이터 구조) 게시:</strong></p>
<ul>
<li>정적 키 (&ldquo;s&rdquo;), IV (&ldquo;i&rdquo;, 초기화 벡터) 및 버전 (&ldquo;v&rdquo;)을 게시</li>
<li>정책에 따라 키를 순환 교체</li>
<li>숨겨진 router용 capabilities 필드 (&ldquo;caps&rdquo;) 지원</li>
</ul>
</li>
<li>
<p><strong>네트워크 호환성:</strong></p>
<ul>
<li>네트워크 ID 필드 지원(현재 메인넷에서는 2)</li>
<li>기존 Java 및 i2pd 구현과 상호 운용</li>
<li>IPv4와 IPv6 모두 지원</li>
</ul>
</li>
</ol>
<h3 id="권장-사항">권장 사항</h3>
<p><strong>성능 최적화:</strong></p>
<ol>
<li>
<p><strong>버퍼링 전략:</strong></p>
<ul>
<li>전체 메시지를 한 번에 플러시 (메시지 1, 2, 3)</li>
<li>핸드셰이크 메시지에는 TCP_NODELAY 사용</li>
<li>여러 데이터 블록을 단일 프레임으로 버퍼링</li>
<li>프레임 크기를 몇 KB로 제한 (수신 측 지연시간 최소화)</li>
</ul>
</li>
<li>
<p><strong>연결 관리:</strong></p>
<ul>
<li>가능한 경우 연결을 재사용하세요</li>
<li>연결 풀링을 구현하세요</li>
<li>연결 상태를 모니터링하세요 (DateTime blocks)</li>
</ul>
</li>
<li>
<p><strong>메모리 관리:</strong></p>
<ul>
<li>사용 후 민감 데이터를 0으로 덮어쓰기(임시 키, DH 결과)</li>
<li>동시 핸드셰이크 제한(DoS(서비스 거부) 방지)</li>
<li>빈번한 할당에는 메모리 풀 사용</li>
</ul>
</li>
</ol>
<p><strong>보안 강화:</strong></p>
<ol>
<li>
<p><strong>프로빙 저항성:</strong></p>
<ul>
<li>무작위 타임아웃: 100-500ms</li>
<li>무작위 바이트 읽기: 1KB-64KB</li>
<li>반복적인 실패 시 IP 블랙리스트 추가</li>
<li>피어에게 오류 세부 정보를 제공하지 않음</li>
</ul>
</li>
<li>
<p><strong>리소스 제한:</strong></p>
<ul>
<li>IP당 최대 연결 수: 3-10</li>
<li>대기 중인 핸드셰이크 최대 수: 100-1000</li>
<li>읽기 타임아웃: 작업당 30-60초</li>
<li>전체 연결 타임아웃: 핸드셰이크 완료까지 5분</li>
</ul>
</li>
<li>
<p><strong>키 관리:</strong></p>
<ul>
<li>정적 키와 IV(초기화 벡터)의 영구 저장</li>
<li>보안 난수 생성(암호학적 난수 생성기)</li>
<li>키 로테이션 정책 엄수</li>
<li>임시 키 절대 재사용 금지</li>
</ul>
</li>
</ol>
<p><strong>모니터링 및 진단:</strong></p>
<ol>
<li>
<p><strong>지표:</strong></p>
<ul>
<li>핸드셰이크 성공/실패 비율</li>
<li>AEAD(Authenticated Encryption with Associated Data, 인증된 연계 데이터 암호화) 오류율</li>
<li>시계 오차 분포</li>
<li>연결 지속 시간 통계</li>
</ul>
</li>
<li>
<p><strong>로깅:</strong></p>
<ul>
<li>이유 코드와 함께 핸드셰이크 실패를 로그에 기록</li>
<li>clock skew(시계 오차) 이벤트를 로그에 기록</li>
<li>차단된 IP 주소를 로그에 기록</li>
<li>민감한 키 재료는 절대로 로그에 기록하지 말 것</li>
</ul>
</li>
<li>
<p><strong>테스트:</strong></p>
<ul>
<li>KDF(키 파생 함수) 체인에 대한 단위 테스트</li>
<li>다른 구현과의 통합 테스트</li>
<li>패킷 처리용 퍼징</li>
<li>DoS(서비스 거부) 내성에 대한 부하 테스트</li>
</ul>
</li>
</ol>
<h3 id="자주-하는-실수">자주 하는 실수</h3>
<p><strong>피해야 할 치명적인 오류:</strong></p>
<ol>
<li>
<p><strong>Nonce(일회용 난수 값) 재사용:</strong></p>
<ul>
<li>세션 중간에 nonce 카운터를 절대 초기화하지 말 것</li>
<li>송신/수신 각각에 대해 별도의 카운터를 사용할 것</li>
<li>2^64 - 1에 도달하기 전에 세션을 종료할 것</li>
</ul>
</li>
<li>
<p><strong>키 로테이션:</strong></p>
<ul>
<li>router가 실행 중일 때는 키를 절대 교체(로테이션)하지 마십시오</li>
<li>세션 간에 임시 키를 절대 재사용하지 마십시오</li>
<li>최소 다운타임 규칙을 준수하십시오</li>
</ul>
</li>
<li>
<p><strong>타임스탬프 처리:</strong></p>
<ul>
<li>만료된 타임스탬프는 절대 허용하지 않는다</li>
<li>편차를 계산할 때는 항상 RTT(왕복 지연 시간)를 보정한다</li>
<li>DateTime 타임스탬프는 초 단위로 반올림한다</li>
</ul>
</li>
<li>
<p><strong>AEAD(연관 데이터가 있는 인증된 암호화) 오류:</strong></p>
<ul>
<li>공격자에게 오류 유형을 절대 공개하지 말 것</li>
<li>닫기 전에 항상 무작위 타임아웃을 사용할 것</li>
<li>잘못된 길이는 AEAD 실패와 동일하게 처리할 것</li>
</ul>
</li>
<li>
<p><strong>패딩:</strong></p>
<ul>
<li>합의된 범위를 벗어난 패딩은 절대 전송하지 않는다</li>
<li>패딩 블록은 항상 마지막에 배치한다</li>
<li>프레임당 여러 개의 패딩 블록을 절대 포함하지 않는다</li>
</ul>
</li>
<li>
<p><strong>RouterInfo:</strong></p>
<ul>
<li>항상 정적 키가 RouterInfo와 일치하는지 확인하세요</li>
<li>공개된 주소가 없는 RouterInfos는 절대 flood(대량 전파)하지 마세요</li>
<li>항상 서명을 검증하세요</li>
</ul>
</li>
</ol>
<h3 id="테스트-방법론">테스트 방법론</h3>
<p><strong>단위 테스트:</strong></p>
<ol>
<li>
<p><strong>암호학 기본 구성 요소:</strong></p>
<ul>
<li>X25519, ChaCha20, Poly1305, SHA-256용 테스트 벡터</li>
<li>HMAC-SHA256 테스트 벡터</li>
<li>SipHash-2-4 테스트 벡터</li>
</ul>
</li>
<li>
<p><strong>KDF 체인:</strong></p>
<ul>
<li>세 가지 메시지 모두에 대한 정답(known-answer) 테스트</li>
<li>체이닝 키 전파 검증</li>
<li>SipHash IV 생성 테스트</li>
</ul>
</li>
<li>
<p><strong>메시지 파싱:</strong></p>
<ul>
<li>유효한 메시지 디코딩</li>
<li>잘못된 메시지 거부</li>
<li>경계 조건(빈 입력, 최대 크기)</li>
</ul>
</li>
</ol>
<p><strong>통합 테스트:</strong></p>
<ol>
<li>
<p><strong>핸드셰이크:</strong></p>
<ul>
<li>3-메시지 교환 성공</li>
<li>시계 오차 거부</li>
<li>리플레이 공격 감지</li>
<li>유효하지 않은 키 거부</li>
</ul>
</li>
<li>
<p><strong>데이터 단계:</strong></p>
<ul>
<li>I2NP 메시지 전송</li>
<li>RouterInfo(router 정보) 교환</li>
<li>패딩 처리</li>
<li>종료 메시지</li>
</ul>
</li>
<li>
<p><strong>상호운용성:</strong></p>
<ul>
<li>Java I2P와의 상호운용성 테스트</li>
<li>i2pd와의 상호운용성 테스트</li>
<li>IPv4 및 IPv6 테스트</li>
<li>공개된 및 숨겨진 router 테스트</li>
</ul>
</li>
</ol>
<p><strong>보안 테스트:</strong></p>
<ol>
<li>
<p><strong>네거티브 테스트:</strong></p>
<ul>
<li>유효하지 않은 AEAD 태그</li>
<li>리플레이된 메시지</li>
<li>Clock skew(시계 오차) 공격</li>
<li>비정상 형식의 프레임</li>
</ul>
</li>
<li>
<p><strong>DoS 테스트:</strong></p>
<ul>
<li>연결 플러딩</li>
<li>Slowloris 공격(느린 전송으로 연결을 붙잡아 두는 기법)</li>
<li>CPU 고갈(과도한 DH(디피-헬만) 연산)</li>
<li>메모리 고갈</li>
</ul>
</li>
<li>
<p><strong>퍼징:</strong></p>
<ul>
<li>무작위 핸드셰이크 메시지</li>
<li>무작위 데이터 단계 프레임</li>
<li>무작위 블록 유형과 크기</li>
<li>유효하지 않은 암호학적 값</li>
</ul>
</li>
</ol>
<h3 id="ntcp에서의-마이그레이션">NTCP에서의 마이그레이션</h3>
<p><strong>레거시 NTCP 지원(현재 제거됨):</strong></p>
<p>I2P 0.9.50 (2021년 5월)에서 NTCP (버전 1, I2P 전송 프로토콜)가 제거되었습니다. 현재 모든 구현체는 NTCP2를 지원해야 합니다. 역사적 참고 사항:</p>
<ol>
<li>
<p><strong>전환 기간(2018-2021):</strong></p>
<ul>
<li>0.9.36: NTCP2 도입(기본적으로 비활성화)</li>
<li>0.9.37: NTCP2 기본적으로 활성화</li>
<li>0.9.40: NTCP 사용 중단</li>
<li>0.9.50: NTCP 제거</li>
</ul>
</li>
<li>
<p><strong>버전 감지:</strong></p>
<ul>
<li>&ldquo;NTCP&rdquo; transportStyle는 두 버전을 모두 지원함을 나타냄</li>
<li>&ldquo;NTCP2&rdquo; transportStyle는 NTCP2만 지원함을 나타냄</li>
<li>메시지 크기를 통해 자동 감지(287 대 288 바이트)</li>
</ul>
</li>
<li>
<p><strong>현재 상태:</strong></p>
<ul>
<li>모든 routers는 NTCP2를 지원해야 합니다</li>
<li>&ldquo;NTCP&rdquo; transportStyle(전송 스타일)은 더 이상 사용되지 않습니다</li>
<li>&ldquo;NTCP2&rdquo; transportStyle만 사용하십시오</li>
</ul>
</li>
</ol>
<h2 id="부록-a-noise-xk-patternnoise-프로토콜의-xk-패턴">부록 A: Noise XK Pattern(Noise 프로토콜의 XK 패턴)</h2>
<p><strong>표준 Noise XK Pattern(Noise 프로토콜 프레임워크의 XK 패턴):</strong></p>
<pre tabindex="0"><code>XK(s, rs):
  &lt;- s
  ...
  -&gt; e, es
  &lt;- e, ee
  -&gt; s, se
</code></pre><p><strong>해석:</strong></p>
<ul>
<li><code>&lt;-</code> : 응답자(Bob)에서 개시자(Alice)로의 메시지</li>
<li><code>-&gt;</code> : 개시자(Alice)에서 응답자(Bob)로의 메시지</li>
<li><code>s</code> : 정적 키(장기 식별 키)</li>
<li><code>rs</code> : 원격 정적 키(피어의 정적 키, 사전에 알고 있음)</li>
<li><code>e</code> : 임시 키(세션별, 필요 시 생성)</li>
<li><code>es</code> : 임시-정적 DH (Alice 임시 × Bob 정적)</li>
<li><code>ee</code> : 임시-임시 DH (Alice 임시 × Bob 임시)</li>
<li><code>se</code> : 정적-임시 DH (Alice 정적 × Bob 임시)</li>
</ul>
<p><strong>키 합의 절차:</strong></p>
<ol>
<li><strong>사전 메시지:</strong> Alice는 Bob의 정적 공개키를 알고 있음(RouterInfo에서)</li>
<li><strong>메시지 1:</strong> Alice는 임시 키를 전송하고 es DH를 수행</li>
<li><strong>메시지 2:</strong> Bob은 임시 키를 전송하고 ee DH를 수행</li>
<li><strong>메시지 3:</strong> Alice는 정적 키를 공개하고 se DH를 수행</li>
</ol>
<p><strong>보안 속성:</strong></p>
<ul>
<li>Alice 인증됨: 예 (메시지 3에 의해)</li>
<li>Bob 인증됨: 예 (정적 개인 키를 보유함으로써)</li>
<li>전방향 기밀성: 예 (임시 키가 파기됨)</li>
<li>KCI 저항성(키 손상 가장 공격에 대한 저항성): 예 (인증 수준 2)</li>
</ul>
<h2 id="부록-b-base64-인코딩">부록 B: Base64 인코딩</h2>
<p><strong>I2P Base64 알파벳:</strong></p>
<pre tabindex="0"><code>ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-~
</code></pre><p><strong>표준 Base64와의 차이점:</strong> - 문자 62-63: <code>+/</code> 대신 <code>-~</code> - 패딩: 동일함 (<code>=</code>) 또는 문맥에 따라 생략</p>
<p><strong>NTCP2에서의 사용:</strong> - 정적 키 (&ldquo;s&rdquo;): 32바이트 → 44문자 (패딩 없음) - IV (&ldquo;i&rdquo;): 16바이트 → 24문자 (패딩 없음)</p>
<p><strong>인코딩 예시:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 32-byte static key (hex): </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># f4489e1bb0597b39ca6cbf5ad9f5f1f09043e02d96cb9aa6a63742b3462429aa</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># I2P Base64 encoded:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 9EjeG7BZeznKbL9a2fXx8JBDPgLZbLmKbqY3QrNGJCo=</span>
</span></span></code></pre></div><h2 id="부록-c-패킷-캡처-분석">부록 C: 패킷 캡처 분석</h2>
<p><strong>NTCP2 트래픽 식별:</strong></p>
<ol>
<li>
<p><strong>TCP 핸드셰이크:</strong></p>
<ul>
<li>표준 TCP SYN, SYN-ACK, ACK</li>
<li>목적지 포트는 보통 8887 또는 비슷한 포트</li>
</ul>
</li>
<li>
<p><strong>메시지 1 (SessionRequest):</strong></p>
<ul>
<li>Alice가 보낸 첫 애플리케이션 데이터</li>
<li>80-65535 바이트 (일반적으로 수백 바이트)</li>
<li>무작위처럼 보임 (AES로 암호화된 임시 키)</li>
<li>&ldquo;NTCP&rdquo; 주소에 연결하는 경우 최대 287 바이트</li>
</ul>
</li>
<li>
<p><strong>메시지 2 (SessionCreated):</strong></p>
<ul>
<li>Bob의 응답</li>
<li>80-65535바이트(일반적으로 수백 바이트)</li>
<li>또한 무작위로 보입니다</li>
</ul>
</li>
<li>
<p><strong>메시지 3 (SessionConfirmed(세션 확인)):</strong></p>
<ul>
<li>Alice로부터</li>
<li>48바이트 + 가변 길이(RouterInfo(router 정보 구조체) 크기 + 패딩)</li>
<li>보통 1~4 KB</li>
</ul>
</li>
<li>
<p><strong>데이터 단계:</strong></p>
<ul>
<li>가변 길이 프레임</li>
<li>길이 필드 난독화(무작위처럼 보임)</li>
<li>암호화된 페이로드</li>
<li>패딩으로 인해 크기를 예측할 수 없음</li>
</ul>
</li>
</ol>
<p><strong>DPI(딥 패킷 검사) 우회:</strong> - 평문 헤더 없음 - 고정된 패턴 없음 - 길이 필드 난독화 - 무작위 패딩으로 크기 기반 휴리스틱 무력화</p>
<p><strong>NTCP와의 비교:</strong> - NTCP 메시지 1은 항상 288바이트(식별 가능) - NTCP2 메시지 1의 크기는 가변적임(식별 불가) - NTCP에는 식별 가능한 패턴이 있었음 - NTCP2는 DPI(딥 패킷 검사)에 저항하도록 설계됨</p>
<h2 id="부록-d-버전-이력">부록 D: 버전 이력</h2>
<p><strong>주요 이정표:</strong></p>
<ul>
<li><strong>0.9.36</strong> (2018년 8월 23일): NTCP2 도입, 기본값으로 비활성화</li>
<li><strong>0.9.37</strong> (2018년 10월 4일): NTCP2 기본값으로 활성화</li>
<li><strong>0.9.40</strong> (2019년 5월 20일): NTCP 사용 중단</li>
<li><strong>0.9.42</strong> (2019년 8월 27일): 네트워크 ID 필드 추가(제안 147)</li>
<li><strong>0.9.50</strong> (2021년 5월 17일): NTCP 제거, capabilities 지원 추가</li>
<li><strong>2.10.0</strong> (2025년 9월 9일): 최신 안정 버전</li>
</ul>
<p><strong>프로토콜 안정성:</strong> - 0.9.50 이후 호환성 파괴 변경 없음 - 프로빙(probing, 서비스 탐지 시도)에 대한 저항성 지속 개선 - 성능과 신뢰성에 집중 - 양자 이후 암호(Post-quantum cryptography) 개발 중 (기본값으로는 비활성화)</p>
<p><strong>현재 전송 프로토콜 상태:</strong> - NTCP2: 필수 TCP 전송 프로토콜 - SSU2: 필수 UDP 전송 프로토콜 - NTCP (v1): 제거됨 - SSU (v1): 제거됨</p>

                </article>

                
                <nav class="page-nav">
                    
                        <a href="../../../../ko/docs/specs/red25519-signature-scheme/" class="page-nav-link prev">
                            <span class="nav-label">← Previous</span>
                            <span class="nav-title">Red25519 서명 스킴</span>
                        </a>
                    
                    
                        <a href="../../../../ko/docs/specs/i2cp/" class="page-nav-link next">
                            <span class="nav-label">Next →</span>
                            <span class="nav-title">I2P 클라이언트 프로토콜 (I2CP)</span>
                        </a>
                    
                </nav>

                
                <div class="docs-feedback">
                    <p>Was this page helpful?</p>
                    <div class="feedback-buttons" id="feedback-buttons">
                        <button class="feedback-btn" id="feedback-yes">👍 Yes</button>
                        <button class="feedback-btn" id="feedback-no">👎 No</button>
                    </div>

                    
                    <div class="feedback-form-container" id="feedback-form-container" style="display: none;">
                        <p class="feedback-form-title">We're sorry to hear that. How can we improve this page?</p>
                        <form id="feedback-form">
                            <div class="form-group">
                                <label for="feedback-email">Email (optional - if you'd like a response)</label>
                                <input type="email" id="feedback-email" name="email" placeholder="your@email.com">
                            </div>
                            <div class="form-group">
                                <label for="feedback-message">Feedback *</label>
                                <textarea id="feedback-message" name="message" rows="4" required placeholder="Tell us what we can improve..."></textarea>
                            </div>
                            <button type="submit" class="btn-submit-feedback" id="feedback-submit-btn">
                                <span class="btn-text">Submit Feedback</span>
                                <span class="btn-loading" style="display: none;">Sending...</span>
                            </button>
                        </form>
                    </div>

                    
                    <div class="feedback-message" id="feedback-success" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/>
                        </svg>
                        <span id="feedback-success-text">Thanks for your feedback!</span>
                    </div>
                    <div class="feedback-message feedback-error" id="feedback-error" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path d="M12 8v4M12 16h.01" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span id="feedback-error-text">Something went wrong. Please try again.</span>
                    </div>

                    <p class="feedback-note">
                        Found an issue? <a href="https://gitlab.com/stormycloud-group/i-2-p-www-v-2/-/blob/main/hugo-site/content/ko/docs/specs/ntcp2.md?ref_type=heads" target="_blank">Edit this page on GitLab</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.docs-page {
    min-height: 100vh;
    padding: var(--spacing-xl) 0;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
}

.breadcrumbs a:hover {
    color: var(--color-primary);
}

.separator {
    color: var(--color-border);
}

.current {
    color: var(--color-text);
}

 
.translation-disclaimer {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.dark .translation-disclaimer {
    background: #78350f;
    border-color: #d97706;
}

.disclaimer-message {
    color: #92400e;
    font-size: 0.875rem;
}

.dark .disclaimer-message {
    color: #fde047;
}

.disclaimer-link {
    color: #92400e;
    font-weight: 600;
    text-decoration: underline;
    white-space: nowrap;
}

.dark .disclaimer-link {
    color: #fde047;
}

 
.article-header {
    margin-bottom: var(--spacing-2xl);
}

.article-title {
    font-size: 2.5rem;
    margin: 0 0 var(--spacing-md) 0;
    color: var(--color-text);
}

.article-description {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-md);
}

.article-meta {
    display: flex;
    gap: var(--spacing-lg);
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.meta-item svg {
    color: var(--color-primary);
}

 
.docs-layout {
    display: block;
}

.docs-layout--with-toc {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

 
.docs-toc-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.toc-nav {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
}

.toc-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-text);
    padding-bottom: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.toc-content {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
}

.toc-content::-webkit-scrollbar {
    width: 4px;
}

.toc-content::-webkit-scrollbar-track {
    background: transparent;
}

.toc-content::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
}

.toc-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

.toc-nav ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc-nav li {
    margin-bottom: 0.25rem;
}

.toc-nav ul ul {
    padding-left: var(--spacing-md);
    margin-top: 0.25rem;
}

.toc-nav a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.8125rem;
    display: block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    line-height: 1.4;
}

.toc-nav a:hover {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
}

 
.docs-main {
    min-width: 0;
    max-width: 900px;
}

 
.article-content {
    line-height: 1.8;
    color: var(--color-text);
}

.article-content h2 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.75rem;
    scroll-margin-top: 100px;
}

.article-content h3 {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.375rem;
    scroll-margin-top: 100px;
}

.article-content h4 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-xs);
    font-size: 1.125rem;
    scroll-margin-top: 100px;
}

.article-content p {
    margin-bottom: var(--spacing-md);
}

.article-content ul,
.article-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.article-content li {
    margin-bottom: var(--spacing-xs);
}

.article-content code {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
}

.article-content pre {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: var(--spacing-md);
}

.article-content pre code {
    background: none;
    padding: 0;
}

.article-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin: var(--spacing-lg) 0;
    display: block;
}

.article-content a {
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
}

.article-content a:hover {
    border-bottom-color: var(--color-primary);
}

 
.page-nav {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
}

.page-nav-link {
    display: flex;
    flex-direction: column;
    padding: var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.page-nav-link:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
}

.page-nav-link.next {
    text-align: right;
}

.nav-label {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xs);
}

.nav-title {
    font-weight: 600;
    color: var(--color-text);
}

 
.docs-feedback {
    margin-top: var(--spacing-2xl);
    padding: var(--spacing-lg);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    text-align: center;
}

.feedback-buttons {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    margin: var(--spacing-md) 0;
}

.feedback-btn {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.feedback-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-primary);
    color: white;
}

.feedback-note {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-top: var(--spacing-md);
}

.feedback-note a {
    color: var(--color-primary);
    text-decoration: none;
}

.feedback-note a:hover {
    text-decoration: underline;
}

 
.feedback-form-container {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-align: left;
}

.feedback-form-title {
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--color-text);
}

.form-group {
    margin-bottom: var(--spacing-md);
}

.form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
    color: var(--color-text);
}

.form-group input[type="email"],
.form-group textarea {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    color: var(--color-text);
    font-family: inherit;
    font-size: 0.9375rem;
    transition: border-color var(--transition-fast);
}

.form-group input[type="email"]:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.btn-submit-feedback {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-submit-feedback:hover:not(:disabled) {
    background: var(--color-primary-dark);
    transform: translateY(-1px);
}

.btn-submit-feedback:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

 
.feedback-message {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: #d1fae5;
    color: #065f46;
    border-radius: var(--radius-md);
    margin-top: var(--spacing-md);
}

.feedback-message.feedback-error {
    background: #fee2e2;
    color: #991b1b;
}

.feedback-message svg {
    flex-shrink: 0;
}

 
@media (max-width: 1024px) {
    .docs-layout--with-toc {
        grid-template-columns: 1fr;
    }

    .docs-toc-sidebar {
        position: static;
        max-height: none;
        margin-bottom: var(--spacing-xl);
    }

    .toc-content {
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .article-title {
        font-size: 1.75rem;
    }
}
</style>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = [];

    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const heading = document.getElementById(href.slice(1));
            if (heading) {
                headings.push({ element: heading, link: link });
            }
        }
    });

    function updateActiveLink() {
        const scrollPos = window.scrollY + 120;
        let activeIndex = 0;

        for (let i = 0; i < headings.length; i++) {
            if (headings[i].element.offsetTop <= scrollPos) {
                activeIndex = i;
            }
        }

        tocLinks.forEach(link => link.classList.remove('active'));
        if (headings[activeIndex]) {
            headings[activeIndex].link.classList.add('active');
        }
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});
</script>
<style>
.toc-nav a.active {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
    font-weight: 600;
}
</style>



<script>
(function() {
    'use strict';
    
    
    let baseUrl = window.feedbackBaseUrl;
    if (!baseUrl) {
        const hostname = window.location.hostname;
        
        if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
            baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
        } else if (hostname.endsWith('.onion')) {
            baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
        } else {
            baseUrl = 'https://feedback.i2p.net';
        }
    }
    
    const script = document.createElement('script');
    script.src = baseUrl + '/widgets/docs-feedback.js';
    script.async = true;
    script.onerror = function() {
        console.error('[Docs Feedback] Failed to load docs-feedback.js from:', baseUrl);
    };
    document.body.appendChild(script);
})();
</script>


    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">I2P 뉴스 받기:</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="이메일을 입력하세요" required>
                            <button type="submit">구독하기</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>빠른 링크</h3>
                <ul>
                    <li><a href="../../../../ko/financial-support/">기부하기</a></li>
                    <li><a href="../../../../ko/docs/overview/intro/">I2P 소개</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>커뮤니티</h3>
                <ul>
                    <li><a href="../../../../ko/get-involved/">참여하기</a></li>
                    <li><a href="../../../../ko/blog/">블로그</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">공식 포럼</a></li>
                    <li><a href="../../../../ko/contact/">연락처</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>리소스</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">I2P 메트릭</a></li>
                    <li><a href="../../../../ko/papers/">연구</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">스톰이클라우드</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 Invisible Internet Project. Creative Commons 라이선스 적용.</p>
            <div class="footer-links">
                <a href="../../../../ko/privacy/">개인정보 처리방침</a>
                <a href="../../../../ko/terms/">이용 약관</a>
                <a href="../../../../ko/about/media/">언론</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="닫기">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>커뮤니티 설문 조사</h2>
            <p class="modal-subtitle">귀하의 의견을 듣고 싶습니다</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                귀하의 투표는 I2P의 미래를 형성하는 데 도움이 됩니다.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
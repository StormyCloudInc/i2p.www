<!DOCTYPE html>
<html lang="pt" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Detalhes de Implementação do NTCP2 | I2P - O Projeto de Internet Invisível</title>

    <meta name="description" content="Detalhes de implementação e especificações técnicas do novo protocolo de transporte do I2P">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="Detalhes de Implementação do NTCP2 | I2P - O Projeto de Internet Invisível">
    <meta property="og:description" content="Detalhes de implementação e especificações técnicas do novo protocolo de transporte do I2P">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/pt/blog/2018/08/20/detalhes-de-implementa%C3%A7%C3%A3o-do-ntcp2/">

    
    <link rel="icon" type="image/svg+xml" href="../../../../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">Site Beta I2P Agora no Ar Reporte problemas por e-mail para stormycloud@mail.i2p</span>
            
        </div>
        
        <form method="GET" action="../../../../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="Fechar banner" title="Fechar banner">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../../../../pt/" class="logo-link">
                    <img src="../../../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../../../../pt/about/" class="">Sobre</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../../../pt/about/">Visão Geral</a></li>
                            <li><a href="../../../../../../pt/papers/">Artigos de Pesquisa</a></li>
                            <li><a href="../../../../../../pt/about/media/">Imprensa</a></li>
                            <li><a href="../../../../../../pt/contact/">Contate-nos</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../../../../pt/docs/" class="">Docs</a></li>
                    <li><a href="../../../../../../pt/downloads/" class="">Downloads</a></li>
                    <li><a href="../../../../../../pt/blog/" class="active">Blog</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../../../../pt/get-involved/" class="">Participe</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../../../pt/get-involved/">Visão Geral</a></li>
                            <li><a href="../../../../../../pt/feedback/">Sugestões de Recursos</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">pt</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../en/blog/2018/08/20/ntcp2-implementation-details/"
                                class="lang-option">Inglês</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../es/blog/2018/08/20/detalles-de-implementaci%C3%B3n-de-ntcp2/"
                                class="lang-option">Espanhol</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../ko/blog/2018/08/20/ntcp2-%EA%B5%AC%ED%98%84-%EC%84%B8%EB%B6%80-%EC%82%AC%ED%95%AD/"
                                class="lang-option">Coreano</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../zh/blog/2018/08/20/ntcp2-%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82/"
                                class="lang-option">Chinês</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../ru/blog/2018/08/20/%D0%BF%D0%BE%D0%B4%D1%80%D0%BE%D0%B1%D0%BD%D0%BE%D1%81%D1%82%D0%B8-%D1%80%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8-ntcp2/"
                                class="lang-option">Russo</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../cs/blog/2018/08/20/podrobnosti-implementace-ntcp2/"
                                class="lang-option">Tcheco</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../de/blog/2018/08/20/ntcp2-implementierungsdetails/"
                                class="lang-option">Alemão</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../fr/blog/2018/08/20/d%C3%A9tails-de-limpl%C3%A9mentation-de-ntcp2/"
                                class="lang-option">Francês</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../tr/blog/2018/08/20/ntcp2-uygulama-ayr%C4%B1nt%C4%B1lar%C4%B1/"
                                class="lang-option">Turco</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../vi/blog/2018/08/20/chi-ti%E1%BA%BFt-tri%E1%BB%83n-khai-ntcp2/"
                                class="lang-option">Vietnamita</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../hi/blog/2018/08/20/ntcp2-%E0%A4%95%E0%A4%BE%E0%A4%B0%E0%A5%8D%E0%A4%AF%E0%A4%BE%E0%A4%A8%E0%A5%8D%E0%A4%B5%E0%A4%AF%E0%A4%A8-%E0%A4%B5%E0%A4%BF%E0%A4%B5%E0%A4%B0%E0%A4%A3/"
                                class="lang-option">Hindi</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../ar/blog/2018/08/20/ntcp2-implementation-details/"
                                class="lang-option">Árabe</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../pt/blog/2018/08/20/detalhes-de-implementa%C3%A7%C3%A3o-do-ntcp2/"
                                class="lang-option active">Português</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../../../../pt/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../../../../pt/downloads/" class="btn btn-primary">Obter I2P</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        
<article class="blog-post">
    <div class="container">
        <div class="post-header">
            <div class="post-meta-row">
                
                <time class="post-date" datetime="2018-08-20">
                    August 20, 2018
                </time>
                

                
                <div class="post-categories">
                    
                    <span class="category-badge">development</span>
                    
                </div>
                
            </div>

            <h1 class="post-title">Detalhes de Implementação do NTCP2</h1>

            
            <div class="post-author">By villain</div>
            
        </div>

        <div class="post-content">
            <p>Os protocolos de transporte do I2P foram originalmente desenvolvidos há cerca de 15 anos. Na época, o principal objetivo era ocultar os dados transferidos, não ocultar o fato de que se estava usando o próprio protocolo. Ninguém pensava seriamente em proteger contra DPI (inspeção profunda de pacotes) e censura de protocolos. Os tempos mudam e, embora os protocolos de transporte originais ainda forneçam segurança robusta, surgiu demanda por um novo protocolo de transporte. NTCP2 foi projetado para resistir às ameaças de censura atuais. Principalmente, à análise por DPI do comprimento dos pacotes. Além disso, o novo protocolo usa os desenvolvimentos mais modernos em criptografia. NTCP2 é baseado no <a href="https://noiseprotocol.org/noise.html">Noise Protocol Framework</a>
, com SHA256 como função de hash e x25519 como um mecanismo de troca de chaves Diffie-Hellman (DH) de curva elíptica.</p>
<p>A especificação completa do protocolo NTCP2 pode ser <a href="../../../../../../pt/docs/specs/ntcp2/">encontrada aqui</a>
.</p>
<h2 id="nova-criptografia">Nova criptografia</h2>
<p>NTCP2 requer a adição dos seguintes algoritmos criptográficos a uma implementação do I2P:</p>
<ul>
<li>x25519</li>
<li>HMAC-SHA256</li>
<li>Chacha20</li>
<li>Poly1305</li>
<li>AEAD</li>
<li>SipHash</li>
</ul>
<p>Compared to our original protocol, NTCP, NTCP2 uses x25519 instead of ElGamal for DH function, AEAD/Chaha20/Poly1305 instead of AES-256-CBC/Adler32, and uses SipHash for obfuscating the packet&rsquo;s length information. The key derivation function used in NTCP2 is more complex, now using many HMAC-SHA256 calls.</p>
<p><em>Nota sobre a implementação do i2pd (C++): Todos os algoritmos mencionados acima, exceto o SipHash, estão implementados no OpenSSL 1.1.0. O SipHash será adicionado à próxima versão do OpenSSL 1.1.1. Para compatibilidade com o OpenSSL 1.0.2, que é usado na maioria dos sistemas atuais, o desenvolvedor principal do i2pd <a href="https://github.com/majestrate">Jeff Becker</a>
 contribuiu com implementações independentes dos algoritmos criptográficos ausentes.</em></p>
<h2 id="alterações-no-routerinfo">Alterações no RouterInfo</h2>
<p>O NTCP2 requer a existência de uma terceira chave (x25519), além das duas já existentes (as chaves de criptografia e de assinatura). Ela é chamada de chave estática e deve ser adicionada a qualquer um dos endereços RouterInfo como parâmetro &ldquo;s&rdquo;. Ela é obrigatória tanto para o iniciador do NTCP2 (Alice) quanto para o respondente (Bob). Se mais de um endereço suportar NTCP2, por exemplo, IPv4 e IPv6, o &ldquo;s&rdquo; deve ser o mesmo para todos. O endereço de Alice pode ter apenas o parâmetro &ldquo;s&rdquo; sem &ldquo;host&rdquo; e &ldquo;port&rdquo; definidos. Além disso, é necessário um parâmetro &ldquo;v&rdquo;, que atualmente é sempre definido como &ldquo;2&rdquo;.</p>
<p>O endereço NTCP2 pode ser declarado como um endereço NTCP2 separado ou como um endereço NTCP de estilo antigo com parâmetros adicionais; nesse caso, ele aceitará conexões NTCP e NTCP2. A implementação do I2P em Java usa a segunda abordagem, o i2pd (implementação em C++) usa a primeira.</p>
<p>Se um nó aceita conexões NTCP2, ele deve publicar seu RouterInfo com o parâmetro &ldquo;i&rdquo;, que é usado como um vetor de inicialização (IV) para a chave pública de criptografia quando esse nó estabelece novas conexões.</p>
<h2 id="estabelecendo-uma-conexão">Estabelecendo uma conexão</h2>
<p>Para estabelecer uma conexão, ambos os lados precisam gerar pares de chaves efêmeras x25519. Com base nessas chaves e em chaves &ldquo;estáticas&rdquo;, eles derivam um conjunto de chaves para a transferência de dados. Ambas as partes devem verificar que o outro lado de fato possui uma chave privada correspondente àquela chave &ldquo;estática&rdquo; e que essa chave &ldquo;estática&rdquo; é a mesma que consta no RouterInfo.</p>
<p>Três mensagens estão sendo enviadas para estabelecer uma conexão:</p>
<pre tabindex="0"><code>Alice                           Bob

SessionRequest -------------------&gt;
&lt;------------------- SessionCreated
SessionConfirmed -----------------&gt;
</code></pre><p>Uma chave x25519 comum, chamada «input key material» (material de chave de entrada), é computada para cada mensagem, após o que a chave de criptografia da mensagem é gerada com uma função MixKey. Um valor ck (chave de encadeamento) é mantido enquanto as mensagens estão sendo trocadas. Esse valor é usado como entrada final ao gerar chaves para transferência de dados.</p>
<p>A função MixKey se parece com algo assim na implementação em C++ do I2P:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> NTCP2Establisher<span style="color:#f92672">::</span>MixKey (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span> inputKeyMaterial, <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span> derived)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// temp_key = HMAC-SHA256(ck, input_key_material)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">uint8_t</span> tempKey[<span style="color:#ae81ff">32</span>]; <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> len;
</span></span><span style="display:flex;"><span>    HMAC(EVP_sha256(), m_CK, <span style="color:#ae81ff">32</span>, inputKeyMaterial, <span style="color:#ae81ff">32</span>, tempKey, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ck = HMAC-SHA256(temp_key, byte(0x01))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint8_t</span> one[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span>  { <span style="color:#ae81ff">1</span> };
</span></span><span style="display:flex;"><span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, one, <span style="color:#ae81ff">1</span>, m_CK, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// derived = HMAC-SHA256(temp_key, ck || byte(0x02))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    m_CK[<span style="color:#ae81ff">32</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, m_CK, <span style="color:#ae81ff">33</span>, derived, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>A mensagem <strong>SessionRequest</strong> é composta por uma chave pública x25519 de Alice (32 bytes), um bloco de dados criptografado com AEAD/Chacha20/Poly1305 (16 bytes), um hash (16 bytes) e alguns dados aleatórios no final (preenchimento (padding)). O comprimento do preenchimento é definido no bloco de dados criptografado. O bloco criptografado também contém o comprimento da segunda parte da mensagem <strong>SessionConfirmed</strong>. Um bloco de dados é criptografado e assinado com uma chave derivada da chave efêmera de Alice e da chave estática de Bob. O valor inicial de ck para a função MixKey é definido como SHA256 (Noise_XKaesobfse+hs2+hs3_25519_ChaChaPoly_SHA256).</p>
<p>Como 32 bytes da chave pública x25519 podem ser detectados por DPI (inspeção profunda de pacotes), ela é cifrada com o algoritmo AES-256-CBC, usando o hash do endereço de Bob como chave e o parâmetro &ldquo;i&rdquo; do RouterInfo como vetor de inicialização (IV).</p>
<p>A mensagem <strong>SessionCreated</strong> tem a mesma estrutura que <strong>SessionRequest</strong>, exceto que a chave é calculada com base nas chaves efêmeras de ambas as partes. O IV (vetor de inicialização) gerado após criptografar/descriptografar a chave pública da mensagem <strong>SessionRequest</strong> é usado como IV para criptografar/descriptografar a chave pública efêmera.</p>
<p>A mensagem <strong>SessionConfirmed</strong> tem 2 partes: chave pública estática e o RouterInfo de Alice. A diferença em relação às mensagens anteriores é que a chave pública efêmera é criptografada com AEAD/Chaha20/Poly1305 usando a mesma chave de <strong>SessionCreated</strong>. Isso faz com que a primeira parte da mensagem aumente de 32 para 48 bytes. A segunda parte também é criptografada com AEAD/Chaha20/Poly1305, mas usando uma nova chave, derivada a partir da chave efêmera de Bob e da chave estática de Alice. A parte RouterInfo também pode ser complementada com padding (preenchimento) de dados aleatórios, mas isso não é obrigatório, pois o RouterInfo normalmente tem comprimentos variados.</p>
<h2 id="geração-de-chaves-de-transferência-de-dados">Geração de Chaves de Transferência de Dados</h2>
<p>Se todas as verificações de hash e de chave tiverem sido bem-sucedidas, um valor ck comum deve estar presente após a última operação MixKey em ambos os lados. Este valor é usado para gerar dois conjuntos de chaves &lt;k, sipk, sipiv&gt; para cada lado de uma conexão. &ldquo;k&rdquo; é uma chave AEAD/Chaha20/Poly1305, &ldquo;sipk&rdquo; é uma chave SipHash, &ldquo;sipiv&rdquo; é um valor inicial para o SipHash IV, que é alterado após cada uso.</p>
<p>O código usado para gerar chaves se parece com isto na implementação em C++ do I2P:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> NTCP2Session<span style="color:#f92672">::</span>KeyDerivationFunctionDataPhase ()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint8_t</span> tempKey[<span style="color:#ae81ff">32</span>]; <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> len;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// temp_key = HMAC-SHA256(ck, zerolen)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), m_Establisher<span style="color:#f92672">-&gt;</span>GetCK (), <span style="color:#ae81ff">32</span>, <span style="color:#66d9ef">nullptr</span>, <span style="color:#ae81ff">0</span>, tempKey, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint8_t</span> one[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span>  { <span style="color:#ae81ff">1</span> };
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// k_ab = HMAC-SHA256(temp_key, byte(0x01)).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, one, <span style="color:#ae81ff">1</span>, m_Kab, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    m_Kab[<span style="color:#ae81ff">32</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// k_ba = HMAC-SHA256(temp_key, k_ab || byte(0x02))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, m_Kab, <span style="color:#ae81ff">33</span>, m_Kba, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint8_t</span> ask[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> { <span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;s&#39;</span>, <span style="color:#e6db74">&#39;k&#39;</span>, <span style="color:#ae81ff">1</span> }, master[<span style="color:#ae81ff">32</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ask_master = HMAC-SHA256(temp_key, &#34;ask&#34; || byte(0x01))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, ask, <span style="color:#ae81ff">4</span>, master, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint8_t</span> h[<span style="color:#ae81ff">39</span>];
</span></span><span style="display:flex;"><span>    memcpy (h, m_Establisher<span style="color:#f92672">-&gt;</span>GetH (), <span style="color:#ae81ff">32</span>);
</span></span><span style="display:flex;"><span>    memcpy (h <span style="color:#f92672">+</span> <span style="color:#ae81ff">32</span>, <span style="color:#e6db74">&#34;siphash&#34;</span>, <span style="color:#ae81ff">7</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// temp_key = HMAC-SHA256(ask_master, h || &#34;siphash&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), master, <span style="color:#ae81ff">32</span>, h, <span style="color:#ae81ff">39</span>, tempKey, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sip_master = HMAC-SHA256(temp_key, byte(0x01))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, one, <span style="color:#ae81ff">1</span>, master, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// temp_key = HMAC-SHA256(sip_master, zerolen)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), master, <span style="color:#ae81ff">32</span>, <span style="color:#66d9ef">nullptr</span>, <span style="color:#ae81ff">0</span>, tempKey, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// sipkeys_ab = HMAC-SHA256(temp_key, byte(0x01)).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, one, <span style="color:#ae81ff">1</span>, m_Sipkeysab, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    m_Sipkeysab[<span style="color:#ae81ff">32</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">// sipkeys_ba = HMAC-SHA256(temp_key, sipkeys_ab || byte(0x02))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, m_Sipkeysab, <span style="color:#ae81ff">33</span>, m_Sipkeysba, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><em>nota de implementação do i2pd (C++): Os primeiros 16 bytes do array &ldquo;sipkeys&rdquo; são uma chave SipHash; os últimos 8 bytes são o IV (vetor de inicialização). O SipHash requer duas chaves de 8 bytes, mas o i2pd as trata como uma única chave de 16 bytes.</em></p>
<h2 id="transferência-de-dados">Transferência de Dados</h2>
<p>Os dados são transferidos em quadros, cada quadro possui 3 partes:</p>
<ul>
<li>2 bytes of frame length obfuscated with SipHash</li>
<li>data encrypted with Chacha20</li>
<li>16 bytes of Poly1305 hash value</li>
</ul>
<p>O tamanho máximo dos dados transferidos em um quadro é 65519 bytes.</p>
<p>O tamanho da mensagem é ofuscado por meio da aplicação da operação XOR com os dois primeiros bytes do IV atual do SipHash.</p>
<p>A parte de dados criptografados contém blocos de dados. Cada bloco é precedido por um cabeçalho de 3 bytes, que define o tipo e o comprimento do bloco. Em geral, são transferidos blocos do tipo I2NP, que são mensagens I2NP com um cabeçalho alterado. Um único quadro NTCP2 pode transferir múltiplos blocos I2NP.</p>
<p>O outro tipo importante de bloco de dados é o bloco de dados aleatório. Recomenda-se adicionar um bloco de dados aleatório a cada quadro NTCP2. Apenas um bloco de dados aleatório pode ser adicionado e deve ser o último bloco.</p>
<p>Estes são outros blocos de dados usados na implementação atual do NTCP2:</p>
<ul>
<li><strong>RouterInfo</strong> — usually contains Bob&rsquo;s RouterInfo after the connection has been established, but it can also contain RouterInfo of a random node for the purpose of speeding up floodfills (there is a flags field for that case).</li>
<li><strong>Termination</strong> — is used when a host explicitly terminates a connection and specifies a reason for that.</li>
<li><strong>DateTime</strong> — a current time in seconds.</li>
</ul>
<h2 id="resumo">Resumo</h2>
<p>O novo protocolo de transporte do I2P, NTCP2, oferece resistência eficaz à censura por DPI. Ele também reduz a carga de CPU devido à criptografia mais rápida e moderna utilizada. Isso torna mais provável que o I2P seja executado em dispositivos de baixo desempenho, como smartphones e routers domésticos. As duas principais implementações do I2P têm suporte completo ao NTCP2 e o disponibilizam para uso a partir da versão 0.9.36 (Java) e 2.20 (i2pd, C++).</p>

        </div>

        <div class="post-navigation">
            <a href="../../../../../../pt/blog" class="back-to-blog">← Back to Blog</a>
        </div>
    </div>
</article>

<style>
.blog-post {
    padding: var(--spacing-2xl) 0;
}

.post-header {
    margin-bottom: var(--spacing-2xl);
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    padding-bottom: var(--spacing-xl);
    border-bottom: 1px solid var(--color-border);
}

.post-meta-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

.post-date {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.post-categories {
    display: flex;
    gap: var(--spacing-xs);
}

.category-badge {
    padding: 0.25rem 0.625rem;
    background-color: var(--color-primary);
    color: white;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.post-title {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-sm);
    line-height: 1.2;
}

.post-author {
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
}

.post-content {
    max-width: 800px;
    margin: 0 auto var(--spacing-2xl);
    line-height: 1.8;
    font-size: 1.0625rem;
}

.post-content h2,
.post-content h3,
.post-content h4 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
}

.post-content h2 {
    font-size: 1.875rem;
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--color-border);
}

.post-content h3 {
    font-size: 1.5rem;
}

.post-content h4 {
    font-size: 1.25rem;
}

.post-content ul,
.post-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.post-content li {
    margin-bottom: var(--spacing-sm);
}

.post-content pre {
    background-color: var(--color-bg-secondary);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    overflow-x: auto;
    margin: var(--spacing-lg) 0;
    border: 1px solid var(--color-border);
}

.post-content code {
    font-family: var(--font-mono);
    font-size: 0.875em;
}

.post-content pre code {
    background-color: transparent;
    padding: 0;
}

.post-content :not(pre) > code {
    background-color: var(--color-bg-tertiary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
}

.post-navigation {
    max-width: 800px;
    margin: var(--spacing-2xl) auto 0;
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
}

.back-to-blog {
    color: var(--color-primary);
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    transition: gap var(--transition-fast);
}

.back-to-blog:hover {
    gap: var(--spacing-sm);
}

@media (max-width: 768px) {
    .post-meta-row {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-xs);
    }

    .post-title {
        font-size: 2rem;
    }

    .post-content {
        font-size: 1rem;
    }
}
</style>

    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">Fique atualizado com as notícias do I2P:</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="Digite seu e-mail" required>
                            <button type="submit">Inscrever-se</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>Links Rápidos</h3>
                <ul>
                    <li><a href="../../../../../../pt/financial-support/">Doar</a></li>
                    <li><a href="../../../../../../pt/docs/overview/intro/">Introdução ao I2P</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Comunidade</h3>
                <ul>
                    <li><a href="../../../../../../pt/get-involved/">Participe</a></li>
                    <li><a href="../../../../../../pt/blog/">Blog</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">Fóruns Oficiais</a></li>
                    <li><a href="../../../../../../pt/contact/">Contato</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Recursos</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">Métricas I2P</a></li>
                    <li><a href="../../../../../../pt/papers/">Pesquisa</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">StormyCloud</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 O Projeto de Internet Invisível. Licenciado sob Creative Commons.</p>
            <div class="footer-links">
                <a href="../../../../../../pt/privacy/">Privacidade</a>
                <a href="../../../../../../pt/terms/">Termos</a>
                <a href="../../../../../../pt/about/media/">Imprensa</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="Fechar">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>Enquete da comunidade</h2>
            <p class="modal-subtitle">Gostaríamos de ouvir sua opinião</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                Seu voto ajuda a moldar o futuro do I2P.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
<!DOCTYPE html>
<html lang="ru" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>ECIES Tunnels | I2P - Проект невидимого интернета</title>

    <meta name="description" content="The Invisible Internet Project - A privacy-focused, anonymous network layer">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="ECIES Tunnels | I2P - Проект невидимого интернета">
    <meta property="og:description" content="The Invisible Internet Project - A privacy-focused, anonymous network layer">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/ru/proposals/152-ecies-tunnels/">

    
    <link rel="icon" type="image/svg+xml" href="../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">Бета-сайт I2P теперь доступен Сообщайте о проблемах с E-Mail на stormycloud@mail.i2p</span>
            
        </div>
        
        <form method="GET" action="../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="Закрыть баннер" title="Закрыть баннер">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../ru/" class="logo-link">
                    <img src="../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../ru/about/" class="">О проекте</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../ru/about/">Обзор</a></li>
                            <li><a href="../../../ru/papers/">Научные статьи</a></li>
                            <li><a href="../../../ru/about/media/">Пресса</a></li>
                            <li><a href="../../../ru/contact/">Связаться с нами</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../ru/docs/" class="">Документы</a></li>
                    <li><a href="../../../ru/downloads/" class="">Загрузки</a></li>
                    <li><a href="../../../ru/blog/" class="">Блог</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../ru/get-involved/" class="">Присоединиться</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../ru/get-involved/">Обзор</a></li>
                            <li><a href="../../../ru/feedback/">Предложения по функциям</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">ru</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../en/proposals/152-ecies-tunnels/"
                                class="lang-option">Английский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../es/proposals/152-ecies-tunnels/"
                                class="lang-option">Испанский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ko/proposals/152-ecies-tunnels/"
                                class="lang-option">Корейский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../zh/proposals/152-ecies-tunnels/"
                                class="lang-option">Китайский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ru/proposals/152-ecies-tunnels/"
                                class="lang-option active">Русский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../cs/proposals/152-ecies-tunnels/"
                                class="lang-option">Чешский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../de/proposals/152-ecies-tunnels/"
                                class="lang-option">Немецкий</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../fr/proposals/152-ecies-tunnels/"
                                class="lang-option">Французский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../tr/proposals/152-ecies-tunnels/"
                                class="lang-option">Турецкий</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../vi/proposals/152-ecies-tunnels/"
                                class="lang-option">Вьетнамский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../hi/proposals/152-ecies-tunnels/"
                                class="lang-option">Хинди</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ar/proposals/152-ecies-tunnels/"
                                class="lang-option">Арабский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../pt/proposals/152-ecies-tunnels/"
                                class="lang-option">Португальский</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../ru/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../ru/downloads/" class="btn btn-primary">Загрузить I2P</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        



<div class="proposals-page">
    <div class="container">
        
        <nav class="breadcrumbs">
            <a href="../../../ru/">Home</a>
            <span class="separator">/</span>
            <a href="../../../ru/proposals/">Proposals</a>
            <span class="separator">/</span>
            <span class="current">ECIES Tunnels</span>
        </nav>

        
<div class="translation-disclaimer" role="note">
    <span class="disclaimer-message">Этот перевод был создан с помощью машинного обучения и может быть не на 100% точным.</span>
    
    
    <a href="../../../en/proposals/152-ecies-tunnels/" class="disclaimer-link">Просмотреть английскую версию</a>
    
</div>



        
        <header class="proposal-header">
            <div class="proposal-title-section">
                <h1 class="proposal-title">ECIES Tunnels</h1>
                <div class="proposal-number">Proposal 152</div>
            </div>

            
            <div class="proposal-meta-box">
                <div class="proposal-status status-closed">
                    Closed
                </div>

                
                <div class="proposal-info-grid">
                    
                    <div class="info-item">
                        <span class="info-label">Author</span>
                        <span class="info-value">chisana, zzz, orignal</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Created</span>
                        <span class="info-value">2019-07-04</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Last Updated</span>
                        <span class="info-value">2025-03-05</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Target Version</span>
                        <span class="info-value">0.9.48</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Implemented In</span>
                        <span class="info-value">0.9.48</span>
                    </div>
                    
                </div>

                
                
            </div>
        </header>

        
        <div class="proposal-layout proposal-layout--with-toc">
            
            
            <aside class="proposal-toc-sidebar">
                <nav class="toc-nav">
                    <div class="toc-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        On This Page
                    </div>
                    <div class="toc-content">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#note">Note</a></li>
    <li><a href="#overview">Overview</a>
      <ul>
        <li><a href="#cryptographic-primitives">Cryptographic Primitives</a></li>
        <li><a href="#goals">Goals</a></li>
        <li><a href="#non-goals">Non-Goals</a></li>
      </ul>
    </li>
    <li><a href="#threat-model">Threat Model</a>
      <ul>
        <li><a href="#design-goals">Design Goals</a></li>
        <li><a href="#tagging-attacks">Tagging Attacks</a></li>
      </ul>
    </li>
    <li><a href="#design">Design</a>
      <ul>
        <li><a href="#noise-protocol-framework">Noise Protocol Framework</a></li>
        <li><a href="#handshake-patterns">Handshake Patterns</a></li>
        <li><a href="#request-encryption">Request encryption</a></li>
        <li><a href="#reply-encryption">Reply encryption</a></li>
        <li><a href="#justification">Justification</a></li>
      </ul>
    </li>
    <li><a href="#specification">Specification</a>
      <ul>
        <li><a href="#build-request-records">Build Request Records</a></li>
        <li><a href="#build-reply-records">Build Reply Records</a></li>
        <li><a href="#symmetric-encryption-of-records">Symmetric Encryption of Records</a></li>
        <li><a href="#request-record-keys-ecies">Request Record Keys (ECIES)</a></li>
        <li><a href="#request-record-encryption-elgamal">Request Record Encryption (ElGamal)</a></li>
        <li><a href="#reply-record-encryption-ecies">Reply Record Encryption (ECIES)</a></li>
        <li><a href="#reply-record-encryption-elgamal">Reply Record Encryption (ElGamal)</a></li>
        <li><a href="#security-analysis">Security Analysis</a></li>
      </ul>
    </li>
    <li><a href="#justification-1">Justification</a></li>
    <li><a href="#implementation-notes">Implementation Notes</a></li>
    <li><a href="#issues">Issues</a></li>
    <li><a href="#migration">Migration</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
                    </div>
                </nav>
            </aside>
            

            
            <div class="proposal-main">
                <article class="proposal-content">
                    <h2 id="note">Note</h2>
<p>Network deployment and testing in progress.
Subject to minor revisions.
See <a href="../../../ru/docs/specs/implementation/">SPEC</a>
 for the official specification.</p>
<h2 id="overview">Overview</h2>
<p>This document proposes changes to Tunnel Build message encryption
using crypto primitives introduced by <a href="../../../ru/docs/specs/ecies/">ECIES-X25519</a>
.
It is a portion of the overall proposal
<a href="../../../ru/proposals/156-ecies-routers">Proposal 156</a>
 for converting routers from ElGamal to ECIES-X25519 keys.</p>
<p>For the purposes of transitioning the network from ElGamal + AES256 to ECIES + ChaCha20,
tunnels with mixed ElGamal and ECIES routers are necessary.
Specifications for handling mixed tunnel hops are provided.
No changes will be made to the format, processing, or encryption of ElGamal hops.</p>
<p>ElGamal tunnel creators will need create ephemeral X25519 keypairs per-hop, and
follow this spec for creating tunnels containing ECIES hops.</p>
<p>This proposal specifies changes needed for ECIES-X25519 Tunnel Building.
For an overview of all changes required for ECIES routers, see proposal 156 <a href="../../../ru/proposals/156-ecies-routers">Proposal 156</a>
.</p>
<p>This proposal maintains the same size for tunnel build records,
as required for compatibility. Smaller build records and messages will be
implemented later - see <a href="../../../ru/proposals/157-new-tbm">Proposal 157</a>
.</p>
<h3 id="cryptographic-primitives">Cryptographic Primitives</h3>
<p>No new cryptographic primitives are introduced. The primitives required to implement this proposal are:</p>
<ul>
<li>AES-256-CBC as in <a href="../../../ru/docs/specs/cryptography/">Cryptography</a>
</li>
<li>STREAM ChaCha20/Poly1305 functions:
ENCRYPT(k, n, plaintext, ad) and DECRYPT(k, n, ciphertext, ad) - as in <a href="../../../ru/docs/specs/ntcp2/">NTCP2</a>
 <a href="../../../ru/docs/specs/ecies/">ECIES-X25519</a>
 and <a href="https://tools.ietf.org/html/rfc7539">RFC-7539</a>
</li>
<li>X25519 DH functions - as in <a href="../../../ru/docs/specs/ntcp2/">NTCP2</a>
 and <a href="../../../ru/docs/specs/ecies/">ECIES-X25519</a>
</li>
<li>HKDF(salt, ikm, info, n) - as in <a href="../../../ru/docs/specs/ntcp2/">NTCP2</a>
 and <a href="../../../ru/docs/specs/ecies/">ECIES-X25519</a>
</li>
</ul>
<p>Other Noise functions defined elsewhere:</p>
<ul>
<li>MixHash(d) - as in <a href="../../../ru/docs/specs/ntcp2/">NTCP2</a>
 and <a href="../../../ru/docs/specs/ecies/">ECIES-X25519</a>
</li>
<li>MixKey(d) - as in <a href="../../../ru/docs/specs/ntcp2/">NTCP2</a>
 and <a href="../../../ru/docs/specs/ecies/">ECIES-X25519</a>
</li>
</ul>
<h3 id="goals">Goals</h3>
<ul>
<li>Increase speed of crypto operations</li>
<li>Replace ElGamal + AES256/CBC with ECIES primitives for tunnel BuildRequestRecords and BuildReplyRecords.</li>
<li>No change to size of encrypted BuildRequestRecords and BuildReplyRecords (528 bytes) for compatibility</li>
<li>No new I2NP messages</li>
<li>Maintain encrypted build record size for compatibility</li>
<li>Add forward secrecy for Tunnel Build Messages.</li>
<li>Add authenticated encryption</li>
<li>Detect hops reordering BuildRequestRecords</li>
<li>Increase resolution of timestamp so that Bloom filter size may be reduced</li>
<li>Add field for tunnel expiration so that varying tunnel lifetimes will be possible (all-ECIES tunnels only)</li>
<li>Add extensible options field for future features</li>
<li>Reuse existing cryptographic primitives</li>
<li>Improve tunnel build message security where possible while maintaining compatibility</li>
<li>Support tunnels with mixed ElGamal/ECIES peers</li>
<li>Improve defenses against &ldquo;tagging&rdquo; attacks on build messages</li>
<li>Hops do not need to know the encryption type of the next hop before processing the build message,
as they may not have the next hop&rsquo;s RI at that time</li>
<li>Maximize compatibility with current network</li>
<li>No change to tunnel build AES request/reply encryption for ElGamal routers</li>
<li>No change to tunnel AES &ldquo;layer&rdquo; encryption, for that see <a href="../../../ru/proposals/153-chacha20-layer-encryption">Proposal 153</a>
</li>
<li>Continue to support both 8-record TBM/TBRM and variable-size VTBM/VTBRM</li>
<li>Do not require &ldquo;flag day&rdquo; upgrade to entire network</li>
</ul>
<h3 id="non-goals">Non-Goals</h3>
<ul>
<li>Complete redesign of tunnel build messages requiring a &ldquo;flag day&rdquo;.</li>
<li>Shrinking tunnel build messages (requires all-ECIES hops and a new proposal)</li>
<li>Use of tunnel build options as defined in <a href="../../../ru/proposals/143-build-message-options">Proposal 143</a>
, only required for small messages</li>
<li>Bidirectional tunnels - for that see <a href="../../../ru/proposals/119-bidirectional-tunnels">Proposal 119</a>
</li>
<li>Smaller tunnel build messages - for that see <a href="../../../ru/proposals/157-new-tbm">Proposal 157</a>
</li>
</ul>
<h2 id="threat-model">Threat Model</h2>
<h3 id="design-goals">Design Goals</h3>
<ul>
<li>
<p>No hops are able to determine the originator of the tunnel.</p>
</li>
<li>
<p>Middle hops must not be able to determine the direction of the tunnel
or their position in the tunnel.</p>
</li>
<li>
<p>No hops can read any contents of other request or reply records, except
for truncated router hash and ephemeral key for next hop</p>
</li>
<li>
<p>No member of reply tunnel for outbound build can read any reply records.</p>
</li>
<li>
<p>No member of outbound tunnel for inbound build can read any request records,
except that OBEP can see truncated router hash and ephemeral key for IBGW</p>
</li>
</ul>
<h3 id="tagging-attacks">Tagging Attacks</h3>
<p>A major goal of the tunnel building design is to make it harder
for colluding routers X and Y to know that they are in a single tunnel.
If router X is at hop m and router Y is at hop m+1, they obviously will know.
But if router X is at hop m and router Y is at hop m+n for n&gt;1, this should be much harder.</p>
<p>Tagging attacks are where middle-hop router X alters the tunnel build message in such a way that
router Y can detect the alteration when the build message gets there.
The goal is for any altered message is dropped by a router between X and Y before it gets to router Y.
For modifications that are not dropped before router Y, the tunnel creator should detect the corruption in the reply
and discard the tunnel.</p>
<p>Possible attacks:</p>
<ul>
<li>Alter a build record</li>
<li>Replace a build record</li>
<li>Add or remove a build record</li>
<li>Reorder the build records</li>
</ul>
<p>TODO: Does the current design prevent all these attacks?</p>
<h2 id="design">Design</h2>
<h3 id="noise-protocol-framework">Noise Protocol Framework</h3>
<p>This proposal provides the requirements based on the Noise Protocol Framework
<a href="https://noiseprotocol.org/noise.html">NOISE</a>
 (Revision 34, 2018-07-11).
In Noise parlance, Alice is the initiator, and Bob is the responder.</p>
<p>This proposal is based on the Noise protocol Noise_N_25519_ChaChaPoly_SHA256.
This Noise protocol uses the following primitives:</p>
<ul>
<li>
<p>One-Way Handshake Pattern: N
Alice does not transmit her static key to Bob (N)</p>
</li>
<li>
<p>DH Function: X25519
X25519 DH with a key length of 32 bytes as specified in <a href="https://tools.ietf.org/html/rfc7748">RFC-7748</a>
.</p>
</li>
<li>
<p>Cipher Function: ChaChaPoly
AEAD_CHACHA20_POLY1305 as specified in <a href="https://tools.ietf.org/html/rfc7539">RFC-7539</a>
 section 2.8.
12 byte nonce, with the first 4 bytes set to zero.
Identical to that in <a href="../../../ru/docs/specs/ntcp2/">NTCP2</a>
.</p>
</li>
<li>
<p>Hash Function: SHA256
Standard 32-byte hash, already used extensively in I2P.</p>
</li>
</ul>
<h4 id="additions-to-the-framework">Additions to the Framework</h4>
<p>None.</p>
<h3 id="handshake-patterns">Handshake Patterns</h3>
<p>Handshakes use <a href="https://noiseprotocol.org/noise.html">Noise</a>
 handshake patterns.</p>
<p>The following letter mapping is used:</p>
<ul>
<li>e = one-time ephemeral key</li>
<li>s = static key</li>
<li>p = message payload</li>
</ul>
<p>The build request is identical to the Noise N pattern.
This is also identical to the first (Session Request) message in the XK pattern used in <a href="../../../ru/docs/specs/ntcp2/">NTCP2</a>
.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>&lt;- s
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  e es p -&gt;
</span></span></code></pre></div><h3 id="request-encryption">Request encryption</h3>
<p>Build request records are created by the tunnel creator and asymmetrically encrypted to the individual hop.
This asymmetric encryption of request records is currently ElGamal as defined in <a href="../../../ru/docs/specs/cryptography/">Cryptography</a>

and contains a SHA-256 checksum. This design is not forward-secret.</p>
<p>The new design will use the one-way Noise pattern &ldquo;N&rdquo; with ECIES-X25519 ephemeral-static DH, with an HKDF, and
ChaCha20/Poly1305 AEAD for forward secrecy, integrity, and authentication.
Alice is the tunnel build requestor. Each hop in the tunnel is a Bob.</p>
<p>(Payload Security Properties)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>N:                      Authentication   Confidentiality
</span></span><span style="display:flex;"><span>    -&gt; e, es                  0                2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Authentication: None (0).
</span></span><span style="display:flex;"><span>    This payload may have been sent by any party, including an active attacker.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Confidentiality: 2.
</span></span><span style="display:flex;"><span>    Encryption to a known recipient, forward secrecy for sender compromise
</span></span><span style="display:flex;"><span>    only, vulnerable to replay.  This payload is encrypted based only on DHs
</span></span><span style="display:flex;"><span>    involving the recipient&#39;s static key pair.  If the recipient&#39;s static
</span></span><span style="display:flex;"><span>    private key is compromised, even at a later date, this payload can be
</span></span><span style="display:flex;"><span>    decrypted.  This message can also be replayed, since there&#39;s no ephemeral
</span></span><span style="display:flex;"><span>    contribution from the recipient.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    &#34;e&#34;: Alice generates a new ephemeral key pair and stores it in the e
</span></span><span style="display:flex;"><span>         variable, writes the ephemeral public key as cleartext into the
</span></span><span style="display:flex;"><span>         message buffer, and hashes the public key along with the old h to
</span></span><span style="display:flex;"><span>         derive a new h.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    &#34;es&#34;: A DH is performed between the Alice&#39;s ephemeral key pair and the
</span></span><span style="display:flex;"><span>          Bob&#39;s static key pair.  The result is hashed along with the old ck to
</span></span><span style="display:flex;"><span>          derive a new ck and k, and n is set to zero.
</span></span></code></pre></div><h3 id="reply-encryption">Reply encryption</h3>
<p>Build reply records are created by the hops creator and symmetrically encrypted to the creator.
This symmetric encryption of reply records is currently AES with a prepended SHA-256 checksum.
and contains a SHA-256 checksum. This design is not forward-secret.</p>
<p>The new design will use ChaCha20/Poly1305 AEAD for integrity, and authentication.</p>
<h3 id="justification">Justification</h3>
<p>The ephemeral public key in the request does not need to be obfuscated with AES
or Elligator2. The previous hop is the only one that can see it, and that hop
knows that the next hop is ECIES.</p>
<p>Reply records do not need full asymmetric encryption with another DH.</p>
<h2 id="specification">Specification</h2>
<h3 id="build-request-records">Build Request Records</h3>
<p>Encrypted BuildRequestRecords are 528 bytes for both ElGamal and ECIES, for compatibility.</p>
<h4 id="request-record-unencrypted-elgamal">Request Record Unencrypted (ElGamal)</h4>
<p>For reference, this is the current specification of the tunnel BuildRequestRecord for ElGamal routers, taken from <a href="../../../ru/docs/specs/i2np/">I2NP</a>
.
The unencrypted data is prepended with a nonzero byte and the SHA-256 hash of the data before encryption,
as defined in <a href="../../../ru/docs/specs/cryptography/">Cryptography</a>
.</p>
<p>All fields are big-endian.</p>
<p>Unencrypted size: 222 bytes</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bytes     0-3: tunnel ID to receive messages as, nonzero
</span></span><span style="display:flex;"><span>  bytes    4-35: local router identity hash
</span></span><span style="display:flex;"><span>  bytes   36-39: next tunnel ID, nonzero
</span></span><span style="display:flex;"><span>  bytes   40-71: next router identity hash
</span></span><span style="display:flex;"><span>  bytes  72-103: AES-256 tunnel layer key
</span></span><span style="display:flex;"><span>  bytes 104-135: AES-256 tunnel IV key
</span></span><span style="display:flex;"><span>  bytes 136-167: AES-256 reply key
</span></span><span style="display:flex;"><span>  bytes 168-183: AES-256 reply IV
</span></span><span style="display:flex;"><span>  byte      184: flags
</span></span><span style="display:flex;"><span>  bytes 185-188: request time (in hours since the epoch, rounded down)
</span></span><span style="display:flex;"><span>  bytes 189-192: next message ID
</span></span><span style="display:flex;"><span>  bytes 193-221: uninterpreted / random padding
</span></span></code></pre></div><h4 id="request-record-encrypted-elgamal">Request Record Encrypted (ElGamal)</h4>
<p>For reference, this is the current specification of the tunnel BuildRequestRecord for ElGamal routers, taken from <a href="../../../ru/docs/specs/i2np/">I2NP</a>
.</p>
<p>Encrypted size: 528 bytes</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bytes    0-15: Hop&#39;s truncated identity hash
</span></span><span style="display:flex;"><span>  bytes  16-528: ElGamal encrypted BuildRequestRecord
</span></span></code></pre></div><h4 id="request-record-unencrypted-ecies">Request Record Unencrypted (ECIES)</h4>
<p>This is the proposed specification of the tunnel BuildRequestRecord for ECIES-X25519 routers.
Summary of changes:</p>
<ul>
<li>Remove unused 32-byte router hash</li>
<li>Change request time from hours to minutes</li>
<li>Add expiration field for future variable tunnel time</li>
<li>Add more space for flags</li>
<li>Add Mapping for additional build options</li>
<li>AES-256 reply key and IV are not used for the hop&rsquo;s own reply record</li>
<li>Unencrypted record is longer because there is less encryption overhead</li>
</ul>
<p>The request record does not contain any ChaCha reply keys.
Those keys are derived from a KDF. See below.</p>
<p>All fields are big-endian.</p>
<p>Unencrypted size: 464 bytes</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bytes     0-3: tunnel ID to receive messages as, nonzero
</span></span><span style="display:flex;"><span>  bytes     4-7: next tunnel ID, nonzero
</span></span><span style="display:flex;"><span>  bytes    8-39: next router identity hash
</span></span><span style="display:flex;"><span>  bytes   40-71: AES-256 tunnel layer key
</span></span><span style="display:flex;"><span>  bytes  72-103: AES-256 tunnel IV key
</span></span><span style="display:flex;"><span>  bytes 104-135: AES-256 reply key
</span></span><span style="display:flex;"><span>  bytes 136-151: AES-256 reply IV
</span></span><span style="display:flex;"><span>  byte      152: flags
</span></span><span style="display:flex;"><span>  bytes 153-155: more flags, unused, set to 0 for compatibility
</span></span><span style="display:flex;"><span>  bytes 156-159: request time (in minutes since the epoch, rounded down)
</span></span><span style="display:flex;"><span>  bytes 160-163: request expiration (in seconds since creation)
</span></span><span style="display:flex;"><span>  bytes 164-167: next message ID
</span></span><span style="display:flex;"><span>  bytes   168-x: tunnel build options (Mapping)
</span></span><span style="display:flex;"><span>  bytes     x-x: other data as implied by flags or options
</span></span><span style="display:flex;"><span>  bytes   x-463: random padding
</span></span></code></pre></div><p>The flags field is the same as defined in <a href="../../../ru/docs/specs/implementation/">Tunnel Creation</a>
 and contains the following::</p>
<p>Bit order: 76543210 (bit 7 is MSB)
bit 7: if set, allow messages from anyone
bit 6: if set, allow messages to anyone, and send the reply to the
specified next hop in a Tunnel Build Reply Message
bits 5-0: Undefined, must set to 0 for compatibility with future options</p>
<p>Bit 7 indicates that the hop will be an inbound gateway (IBGW).  Bit 6
indicates that the hop will be an outbound endpoint (OBEP).  If neither bit is
set, the hop will be an intermediate participant.  Both cannot be set at once.</p>
<p>The request exipration is for future variable tunnel duration.
For now, the only supported value is 600 (10 minutes).</p>
<p>The tunnel build options is a Mapping structure as defined in <a href="../../../ru/docs/specs/common-structures/">Common Structures</a>
.
This is for future use. No options are currently defined.
If the Mapping structure is empty, this is two bytes 0x00 0x00.
The maximum size of the Mapping (including the length field) is 296 bytes,
and the maximum value of the Mapping length field is 294.</p>
<h4 id="request-record-encrypted-ecies">Request Record Encrypted (ECIES)</h4>
<p>All fields are big-endian except for the ephemeral public key which is little-endian.</p>
<p>Encrypted size: 528 bytes</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bytes    0-15: Hop&#39;s truncated identity hash
</span></span><span style="display:flex;"><span>  bytes   16-47: Sender&#39;s ephemeral X25519 public key
</span></span><span style="display:flex;"><span>  bytes  48-511: ChaCha20 encrypted BuildRequestRecord
</span></span><span style="display:flex;"><span>  bytes 512-527: Poly1305 MAC
</span></span></code></pre></div><h3 id="build-reply-records">Build Reply Records</h3>
<p>Encrypted BuildReplyRecords are 528 bytes for both ElGamal and ECIES, for compatibility.</p>
<h4 id="reply-record-unencrypted-elgamal">Reply Record Unencrypted (ElGamal)</h4>
<p>ElGamal replies are encrypted with AES.</p>
<p>All fields are big-endian.</p>
<p>Unencrypted size: 528 bytes</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bytes   0-31: SHA-256 Hash of bytes 32-527
</span></span><span style="display:flex;"><span>  bytes 32-526: random data
</span></span><span style="display:flex;"><span>  byte     527: reply
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  total length: 528
</span></span></code></pre></div><h4 id="reply-record-unencrypted-ecies">Reply Record Unencrypted (ECIES)</h4>
<p>This is the proposed specification of the tunnel BuildReplyRecord for ECIES-X25519 routers.
Summary of changes:</p>
<ul>
<li>Add Mapping for build reply options</li>
<li>Unencrypted record is longer because there is less encryption overhead</li>
</ul>
<p>ECIES replies are encrypted with ChaCha20/Poly1305.</p>
<p>All fields are big-endian.</p>
<p>Unencrypted size: 512 bytes</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bytes    0-x: Tunnel Build Reply Options (Mapping)
</span></span><span style="display:flex;"><span>  bytes    x-x: other data as implied by options
</span></span><span style="display:flex;"><span>  bytes  x-510: Random padding
</span></span><span style="display:flex;"><span>  byte     511: Reply byte
</span></span></code></pre></div><p>The tunnel build reply options is a Mapping structure as defined in <a href="../../../ru/docs/specs/common-structures/">Common Structures</a>
.
This is for future use. No options are currently defined.
If the Mapping structure is empty, this is two bytes 0x00 0x00.
The maximum size of the Mapping (including the length field) is 511 bytes,
and the maximum value of the Mapping length field is 509.</p>
<p>The reply byte is one of the following values
as defined in <a href="../../../ru/docs/specs/implementation/">Tunnel Creation</a>
 to avoid fingerprinting:</p>
<ul>
<li>0x00 (accept)</li>
<li>30 (TUNNEL_REJECT_BANDWIDTH)</li>
</ul>
<h4 id="reply-record-encrypted-ecies">Reply Record Encrypted (ECIES)</h4>
<p>Encrypted size: 528 bytes</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bytes   0-511: ChaCha20 encrypted BuildReplyRecord
</span></span><span style="display:flex;"><span>  bytes 512-527: Poly1305 MAC
</span></span></code></pre></div><p>After full transition to ECIES records, ranged padding rules are the same as for request records.</p>
<h3 id="symmetric-encryption-of-records">Symmetric Encryption of Records</h3>
<p>Mixed tunnels are allowed, and necessary, for the transition from ElGamal to ECIES.
During the transitionary period, an increasing number of routers will be keyed under ECIES keys.</p>
<p>Symmetric cryptography preprocessing will run in the same way:</p>
<ul>
<li>
<p>&ldquo;encryption&rdquo;:</p>
<ul>
<li>cipher run in decryption mode</li>
<li>request records preemptively decrypted in preprocessing (concealing encrypted request records)</li>
</ul>
</li>
<li>
<p>&ldquo;decryption&rdquo;:</p>
<ul>
<li>cipher run in encryption mode</li>
<li>request records encrypted (revealing next plaintext request record) by participant hops</li>
</ul>
</li>
<li>
<p>ChaCha20 does not have &ldquo;modes&rdquo;, so it is simply run three times:</p>
<ul>
<li>once in preprocessing</li>
<li>once by the hop</li>
<li>once on final reply processing</li>
</ul>
</li>
</ul>
<p>When mixed tunnels are used, tunnel creators will need to base the symmetric encryption
of BuildRequestRecord on the current and previous hop&rsquo;s encryption type.</p>
<p>Each hop will use its own encryption type for encrypting BuildReplyRecords, and the other
records in the VariableTunnelBuildMessage (VTBM).</p>
<p>On the reply path, the endpoint (sender) will need to undo the <a href="https://en.wikipedia.org/wiki/Multiple_encryption">Multiple Encryption</a>
, using each hop&rsquo;s reply key.</p>
<p>As a clarifying example, let&rsquo;s look at an outbound tunnel w/ ECIES surrounded by ElGamal:</p>
<ul>
<li>Sender (OBGW) -&gt; ElGamal (H1) -&gt; ECIES (H2) -&gt; ElGamal (H3)</li>
</ul>
<p>All BuildRequestRecords are in their encrypted state (using ElGamal or ECIES).</p>
<p>AES256/CBC cipher, when used, is still used for each record, without chaining across multiple records.</p>
<p>Likewise, ChaCha20 will be used to encrypt each record, not streaming across the entire VTBM.</p>
<p>The request records are preprocessed by the Sender (OBGW):</p>
<ul>
<li>
<p>H3&rsquo;s record is &ldquo;encrypted&rdquo; using:</p>
<ul>
<li>H2&rsquo;s reply key (ChaCha20)</li>
<li>H1&rsquo;s reply key (AES256/CBC)</li>
</ul>
</li>
<li>
<p>H2&rsquo;s record is &ldquo;encrypted&rdquo; using:</p>
<ul>
<li>H1&rsquo;s reply key (AES256/CBC)</li>
</ul>
</li>
<li>
<p>H1&rsquo;s record goes out without symmetric encryption</p>
</li>
</ul>
<p>Only H2 checks the reply encryption flag, and sees its followed by AES256/CBC.</p>
<p>After being processed by each hop, the records are in a &ldquo;decrypted&rdquo; state:</p>
<ul>
<li>
<p>H3&rsquo;s record is &ldquo;decrypted&rdquo; using:</p>
<ul>
<li>H3&rsquo;s reply key (AES256/CBC)</li>
</ul>
</li>
<li>
<p>H2&rsquo;s record is &ldquo;decrypted&rdquo; using:</p>
<ul>
<li>H3&rsquo;s reply key (AES256/CBC)</li>
<li>H2&rsquo;s reply key (ChaCha20-Poly1305)</li>
</ul>
</li>
<li>
<p>H1&rsquo;s record is &ldquo;decrypted&rdquo; using:</p>
<ul>
<li>H3&rsquo;s reply key (AES256/CBC)</li>
<li>H2&rsquo;s reply key (ChaCha20)</li>
<li>H1&rsquo;s reply key (AES256/CBC)</li>
</ul>
</li>
</ul>
<p>The tunnel creator, a.k.a. Inbound Endpoint (IBEP), postprocesses the reply:</p>
<ul>
<li>
<p>H3&rsquo;s record is &ldquo;encrypted&rdquo; using:</p>
<ul>
<li>H3&rsquo;s reply key (AES256/CBC)</li>
</ul>
</li>
<li>
<p>H2&rsquo;s record is &ldquo;encrypted&rdquo; using:</p>
<ul>
<li>H3&rsquo;s reply key (AES256/CBC)</li>
<li>H2&rsquo;s reply key (ChaCha20-Poly1305)</li>
</ul>
</li>
<li>
<p>H1&rsquo;s record is &ldquo;encrypted&rdquo; using:</p>
<ul>
<li>H3&rsquo;s reply key (AES256/CBC)</li>
<li>H2&rsquo;s reply key (ChaCha20)</li>
<li>H1&rsquo;s reply key (AES256/CBC)</li>
</ul>
</li>
</ul>
<h3 id="request-record-keys-ecies">Request Record Keys (ECIES)</h3>
<p>These keys are explicitly included in ElGamal BuildRequestRecords.
For ECIES BuildRequestRecords, the tunnel keys and AES reply keys are included,
but the ChaCha reply keys are derived from the DH exchange.
See <a href="../../../ru/proposals/156-ecies-routers">Proposal 156</a>
 for details of the router static ECIES keys.</p>
<p>Below is a description of how to derive the keys previously transmitted in request records.</p>
<h4 id="kdf-for-initial-ck-and-h">KDF for Initial ck and h</h4>
<p>This is standard <a href="https://noiseprotocol.org/noise.html">NOISE</a>
 for pattern &ldquo;N&rdquo; with a standard protocol name.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>This is the &#34;e&#34; message pattern:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // Define protocol_name.
</span></span><span style="display:flex;"><span>  Set protocol_name = &#34;Noise_N_25519_ChaChaPoly_SHA256&#34;
</span></span><span style="display:flex;"><span>  (31 bytes, US-ASCII encoded, no NULL termination).
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // Define Hash h = 32 bytes
</span></span><span style="display:flex;"><span>  // Pad to 32 bytes. Do NOT hash it, because it is not more than 32 bytes.
</span></span><span style="display:flex;"><span>  h = protocol_name || 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Define ck = 32 byte chaining key. Copy the h data to ck.
</span></span><span style="display:flex;"><span>  Set chainKey = h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // MixHash(null prologue)
</span></span><span style="display:flex;"><span>  h = SHA256(h);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // up until here, can all be precalculated by all routers.
</span></span></code></pre></div><h4 id="kdf-for-request-record">KDF for Request Record</h4>
<p>ElGamal tunnel creators generate an ephemeral X25519 keypair for each
ECIES hop in the tunnel, and use scheme above for encrypting their BuildRequestRecord.
ElGamal tunnel creators will use the scheme prior to this spec for encrypting to ElGamal hops.</p>
<p>ECIES tunnel creators will need to encrypt to each of the ElGamal hop&rsquo;s public key using the
scheme defined in <a href="../../../ru/docs/specs/implementation/">Tunnel Creation</a>
. ECIES tunnel creators will use the above scheme for encrypting
to ECIES hops.</p>
<p>This means that tunnel hops will only see encrypted records from their same encryption type.</p>
<p>For ElGamal and ECIES tunnel creators, they will generate unique ephemeral X25519 keypairs
per-hop for encrypting to ECIES hops.</p>
<p><strong>IMPORTANT</strong>:
Ephemeral keys must be unique per ECIES hop, and per build record.
Failing to use unique keys opens an attack vector for colluding hops to confirm they are in the same tunnel.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>// Each hop&#39;s X25519 static keypair (hesk, hepk) from the Router Identity
</span></span><span style="display:flex;"><span>  hesk = GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>  hepk = DERIVE_PUBLIC(hesk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // MixHash(hepk)
</span></span><span style="display:flex;"><span>  // || below means append
</span></span><span style="display:flex;"><span>  h = SHA256(h || hepk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // up until here, can all be precalculated by each router
</span></span><span style="display:flex;"><span>  // for all incoming build requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // Sender generates an X25519 ephemeral keypair per ECIES hop in the VTBM (sesk, sepk)
</span></span><span style="display:flex;"><span>  sesk = GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>  sepk = DERIVE_PUBLIC(sesk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // MixHash(sepk)
</span></span><span style="display:flex;"><span>  h = SHA256(h || sepk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  End of &#34;e&#34; message pattern.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  This is the &#34;es&#34; message pattern:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // Noise es
</span></span><span style="display:flex;"><span>  // Sender performs an X25519 DH with Hop&#39;s static public key.
</span></span><span style="display:flex;"><span>  // Each Hop, finds the record w/ their truncated identity hash,
</span></span><span style="display:flex;"><span>  // and extracts the Sender&#39;s ephemeral key preceding the encrypted record.
</span></span><span style="display:flex;"><span>  sharedSecret = DH(sesk, hepk) = DH(hesk, sepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // MixKey(DH())
</span></span><span style="display:flex;"><span>  //[chainKey, k] = MixKey(sharedSecret)
</span></span><span style="display:flex;"><span>  // ChaChaPoly parameters to encrypt/decrypt
</span></span><span style="display:flex;"><span>  keydata = HKDF(chainKey, sharedSecret, &#34;&#34;, 64)
</span></span><span style="display:flex;"><span>  // Save for Reply Record KDF
</span></span><span style="display:flex;"><span>  chainKey = keydata[0:31]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // AEAD parameters
</span></span><span style="display:flex;"><span>  k = keydata[32:63]
</span></span><span style="display:flex;"><span>  n = 0
</span></span><span style="display:flex;"><span>  plaintext = 464 byte build request record
</span></span><span style="display:flex;"><span>  ad = h
</span></span><span style="display:flex;"><span>  ciphertext = ENCRYPT(k, n, plaintext, ad)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  End of &#34;es&#34; message pattern.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // MixHash(ciphertext)
</span></span><span style="display:flex;"><span>  // Save for Reply Record KDF
</span></span><span style="display:flex;"><span>  h = SHA256(h || ciphertext)
</span></span></code></pre></div><p><code>replyKey</code>, <code>layerKey</code> and <code>layerIV</code> must still be included inside ElGamal records,
and can be generated randomly.</p>
<h3 id="request-record-encryption-elgamal">Request Record Encryption (ElGamal)</h3>
<p>As defined in <a href="../../../ru/docs/specs/implementation/">Tunnel Creation</a>
.
There are no changes to encryption for ElGamal hops.</p>
<h3 id="reply-record-encryption-ecies">Reply Record Encryption (ECIES)</h3>
<p>The reply record is ChaCha20/Poly1305 encrypted.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>// AEAD parameters
</span></span><span style="display:flex;"><span>  k = chainkey from build request
</span></span><span style="display:flex;"><span>  n = 0
</span></span><span style="display:flex;"><span>  plaintext = 512 byte build reply record
</span></span><span style="display:flex;"><span>  ad = h from build request
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ciphertext = ENCRYPT(k, n, plaintext, ad)
</span></span></code></pre></div><h3 id="reply-record-encryption-elgamal">Reply Record Encryption (ElGamal)</h3>
<p>As defined in <a href="../../../ru/docs/specs/implementation/">Tunnel Creation</a>
.
There are no changes to encryption for ElGamal hops.</p>
<h3 id="security-analysis">Security Analysis</h3>
<p>ElGamal does not provide forward secrecy for Tunnel Build Messages.</p>
<p>AES256/CBC is in slightly better standing, only being vulnerable to a theoretical weakening from a
known plaintext <code>biclique</code> attack.</p>
<p>The only known practical attack against AES256/CBC is a padding oracle attack, when the IV is known to the attacker.</p>
<p>An attacker would need to break the next hop&rsquo;s ElGamal encryption to gain the AES256/CBC key info (reply key and IV).</p>
<p>ElGamal is significantly more CPU-intensive than ECIES, leading to potential resource exhaustion.</p>
<p>ECIES, used with new ephemeral keys per-BuildRequestRecord or VariableTunnelBuildMessage, provides forward-secrecy.</p>
<p>ChaCha20Poly1305 provides AEAD encryption, allowing the recipient to verify message integrity before attempting decryption.</p>
<h2 id="justification-1">Justification</h2>
<p>This design maximizes reuse of existing cryptographic primitives, protocols, and code.
This design minimizes risk.</p>
<h2 id="implementation-notes">Implementation Notes</h2>
<ul>
<li>Older routers do not check the encryption type of the hop and will send ElGamal-encrypted
records. Some recent routers are buggy and will send various types of malformed records.
Implementers should detect and reject these records prior to the DH operation
if possible, to reduce CPU usage.</li>
</ul>
<h2 id="issues">Issues</h2>
<h2 id="migration">Migration</h2>
<p>See <a href="../../../ru/proposals/156-ecies-routers">Proposal 156</a>
.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="../../../ru/docs/specs/common-structures/">Common</a>
</li>
<li><a href="../../../ru/docs/specs/cryptography/">Cryptography</a>
</li>
<li><a href="../../../ru/docs/specs/ecies/">ECIES-X25519</a>
</li>
<li><a href="../../../ru/docs/specs/i2np/">I2NP</a>
</li>
<li><a href="https://noiseprotocol.org/noise.html">NOISE</a>
</li>
<li><a href="../../../ru/docs/specs/ntcp2/">NTCP2</a>
</li>
<li><a href="../../../ru/proposals/119-bidirectional-tunnels/">Prop119</a>
</li>
<li><a href="../../../ru/proposals/143-build-message-options/">Prop143</a>
</li>
<li><a href="../../../ru/proposals/153-chacha20-layer-encryption/">Prop153</a>
</li>
<li><a href="../../../ru/proposals/156-ecies-routers/">Prop156</a>
</li>
<li><a href="../../../ru/proposals/157-new-tbm/">Prop157</a>
</li>
<li><a href="../../../ru/docs/specs/implementation/#tunnel-creation-ecies">SPEC</a>
</li>
<li><a href="../../../ru/docs/specs/implementation/#tunnel-creation-ecies">Tunnel-Creation</a>
</li>
<li><a href="https://en.wikipedia.org/wiki/Multiple_encryption">Multiple-Encryption</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc7539">RFC-7539</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc7748">RFC-7748</a>
</li>
</ul>

                </article>

                
                <nav class="page-nav">
                    <a href="../../../ru/proposals/" class="page-nav-link">
                        ← Back to Proposals
                    </a>
                    
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                    <a href="../../../proposals/152-ecies-tunnels.txt" class="page-nav-link" download>
                        Download Source (.txt)
                    </a>
                    
                </nav>
            </div>
        </div>
    </div>
</div>

<style>
.proposals-page {
    min-height: 100vh;
    padding: var(--spacing-xl) 0;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
}

.breadcrumbs a:hover {
    color: var(--color-primary);
}

.separator {
    color: var(--color-border);
}

.current {
    color: var(--color-text);
}

 
.translation-disclaimer {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.dark .translation-disclaimer {
    background: #78350f;
    border-color: #d97706;
}

.disclaimer-message {
    color: #92400e;
    font-size: 0.875rem;
}

.dark .disclaimer-message {
    color: #fde047;
}

.disclaimer-link {
    color: #92400e;
    font-weight: 600;
    text-decoration: underline;
    white-space: nowrap;
}

.dark .disclaimer-link {
    color: #fde047;
}

 
.proposal-header {
    margin-bottom: var(--spacing-2xl);
}

.proposal-title-section {
    margin-bottom: var(--spacing-lg);
}

.proposal-title {
    font-size: 2.5rem;
    margin: 0 0 var(--spacing-sm) 0;
    color: var(--color-text);
}

.proposal-number {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    font-weight: 600;
}

 
.proposal-meta-box {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
}

.proposal-status {
    display: inline-block;
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: var(--spacing-md);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

 
.status-open {
    background: #dbeafe;
    color: #0369a1;
}

.dark .status-open {
    background: #0c4a6e;
    color: #7dd3fc;
}

.status-accepted {
    background: #dbeafe;
    color: #0369a1;
}

.dark .status-accepted {
    background: #0c4a6e;
    color: #7dd3fc;
}

.status-finished {
    background: #dcfce7;
    color: #15803d;
}

.dark .status-finished {
    background: #164e63;
    color: #86efac;
}

.status-closed {
    background: #dcfce7;
    color: #15803d;
}

.dark .status-closed {
    background: #164e63;
    color: #86efac;
}

.status-rejected {
    background: #fee2e2;
    color: #991b1b;
}

.dark .status-rejected {
    background: #7f1d1d;
    color: #fca5a5;
}

.status-draft,
.status-needs-revision,
.status-dead,
.status-needs-research {
    background: #fef3c7;
    color: #92400e;
}

.dark .status-draft,
.dark .status-needs-revision,
.dark .status-dead,
.dark .status-needs-research {
    background: #78350f;
    color: #fde047;
}

.status-meta,
.status-informational,
.status-reserve {
    background: #e9d5ff;
    color: #6b21a8;
}

.dark .status-meta,
.dark .status-informational,
.dark .status-reserve {
    background: #581c87;
    color: #e879f9;
}

 
.proposal-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.info-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
}

.info-value {
    font-size: 0.9375rem;
    color: var(--color-text);
    font-weight: 500;
}

 
.proposal-relationships {
    border-top: 1px solid var(--color-border);
    padding-top: var(--spacing-md);
}

.relationship {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
}

.relationship:last-child {
    margin-bottom: 0;
}

.relationship-label {
    font-weight: 600;
    color: var(--color-text-muted);
    min-width: 120px;
}

.relationship-value {
    color: var(--color-text);
}

 
.proposal-layout {
    display: block;
}

.proposal-layout--with-toc {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

 
.proposal-toc-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.toc-nav {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
}

.toc-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-text);
    padding-bottom: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.toc-content {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
}

.toc-content::-webkit-scrollbar {
    width: 4px;
}

.toc-content::-webkit-scrollbar-track {
    background: transparent;
}

.toc-content::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
}

.toc-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

.toc-nav ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc-nav li {
    margin-bottom: 0.25rem;
}

.toc-nav ul ul {
    padding-left: var(--spacing-md);
    margin-top: 0.25rem;
}

.toc-nav a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.8125rem;
    display: block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    line-height: 1.4;
}

.toc-nav a:hover {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
}

 
.proposal-main {
    min-width: 0;
}

 
.proposal-content {
    line-height: 1.8;
    color: var(--color-text);
    max-width: 900px;
}

.proposal-content h2 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.75rem;
    scroll-margin-top: 100px;
}

.proposal-content h3 {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.375rem;
    scroll-margin-top: 100px;
}

.proposal-content h4 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-xs);
    font-size: 1.125rem;
    scroll-margin-top: 100px;
}

.proposal-content p {
    margin-bottom: var(--spacing-md);
}

.proposal-content ul,
.proposal-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.proposal-content li {
    margin-bottom: var(--spacing-xs);
}

.proposal-content code {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
}

.proposal-content pre {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: var(--spacing-md);
    font-size: 0.875rem;
}

.proposal-content pre code {
    background: none;
    padding: 0;
}

.proposal-content blockquote {
    border-left: 4px solid var(--color-primary);
    padding-left: var(--spacing-md);
    margin-left: 0;
    margin-bottom: var(--spacing-md);
    font-style: italic;
    color: var(--color-text-secondary);
}

.proposal-content a {
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
}

.proposal-content a:hover {
    border-bottom-color: var(--color-primary);
}

.proposal-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: var(--spacing-md);
}

.proposal-content table th {
    background: var(--color-bg-secondary);
    padding: var(--spacing-sm);
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--color-border);
}

.proposal-content table td {
    padding: var(--spacing-sm);
    border-bottom: 1px solid var(--color-border);
}

.proposal-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin: var(--spacing-lg) 0;
    display: block;
}

 
.page-nav {
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.page-nav-link {
    display: inline-block;
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.page-nav-link:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
}

 
@media (max-width: 1024px) {
    .proposal-layout--with-toc {
        grid-template-columns: 1fr;
    }

    .proposal-toc-sidebar {
        position: static;
        max-height: none;
        margin-bottom: var(--spacing-xl);
    }

    .toc-content {
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .proposal-title {
        font-size: 1.75rem;
    }

    .proposal-info-grid {
        grid-template-columns: 1fr;
    }
}
</style>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = [];

    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const heading = document.getElementById(href.slice(1));
            if (heading) {
                headings.push({ element: heading, link: link });
            }
        }
    });

    function updateActiveLink() {
        const scrollPos = window.scrollY + 120;
        let activeIndex = 0;

        for (let i = 0; i < headings.length; i++) {
            if (headings[i].element.offsetTop <= scrollPos) {
                activeIndex = i;
            }
        }

        tocLinks.forEach(link => link.classList.remove('active'));
        if (headings[activeIndex]) {
            headings[activeIndex].link.classList.add('active');
        }
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});
</script>
<style>
.toc-nav a.active {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
    font-weight: 600;
}
</style>



    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">Следите за новостями I2P:</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="Введите ваш email" required>
                            <button type="submit">Подписаться</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>Быстрые ссылки</h3>
                <ul>
                    <li><a href="../../../ru/financial-support/">Пожертвовать</a></li>
                    <li><a href="../../../ru/docs/overview/intro/">Введение в I2P</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Сообщество</h3>
                <ul>
                    <li><a href="../../../ru/get-involved/">Присоединяйтесь</a></li>
                    <li><a href="../../../ru/blog/">Блог</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">Официальные форумы</a></li>
                    <li><a href="../../../ru/contact/">Контакты</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Ресурсы</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">I2P Метрики</a></li>
                    <li><a href="../../../ru/papers/">Исследование</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">StormyCloud</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 Проект Невидимый Интернет. Лицензировано под Creative Commons.</p>
            <div class="footer-links">
                <a href="../../../ru/privacy/">Конфиденциальность</a>
                <a href="../../../ru/terms/">Условия</a>
                <a href="../../../ru/about/media/">Пресса</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="Закрыть">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>Опрос сообщества</h2>
            <p class="modal-subtitle">Мы хотели бы услышать ваше мнение</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                Ваш голос помогает формировать будущее I2P.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
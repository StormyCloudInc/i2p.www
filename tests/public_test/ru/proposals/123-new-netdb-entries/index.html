<!DOCTYPE html>
<html lang="ru" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Новые записи netDB | I2P - Проект невидимого интернета</title>

    <meta name="description" content="The Invisible Internet Project - A privacy-focused, anonymous network layer">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="Новые записи netDB | I2P - Проект невидимого интернета">
    <meta property="og:description" content="The Invisible Internet Project - A privacy-focused, anonymous network layer">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/ru/proposals/123-new-netdb-entries/">

    
    <link rel="icon" type="image/svg+xml" href="../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">Бета-сайт I2P теперь доступен Сообщайте о проблемах с E-Mail на stormycloud@mail.i2p</span>
            
        </div>
        
        <form method="GET" action="../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="Закрыть баннер" title="Закрыть баннер">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../ru/" class="logo-link">
                    <img src="../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../ru/about/" class="">О проекте</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../ru/about/">Обзор</a></li>
                            <li><a href="../../../ru/papers/">Научные статьи</a></li>
                            <li><a href="../../../ru/about/media/">Пресса</a></li>
                            <li><a href="../../../ru/contact/">Связаться с нами</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../ru/docs/" class="">Документы</a></li>
                    <li><a href="../../../ru/downloads/" class="">Загрузки</a></li>
                    <li><a href="../../../ru/blog/" class="">Блог</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../ru/get-involved/" class="">Присоединиться</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../ru/get-involved/">Обзор</a></li>
                            <li><a href="../../../ru/feedback/">Предложения по функциям</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">ru</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../en/proposals/123-new-netdb-entries/"
                                class="lang-option">Английский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../es/proposals/123-new-netdb-entries/"
                                class="lang-option">Испанский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ko/proposals/123-new-netdb-entries/"
                                class="lang-option">Корейский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../zh/proposals/123-new-netdb-entries/"
                                class="lang-option">Китайский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ru/proposals/123-new-netdb-entries/"
                                class="lang-option active">Русский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../cs/proposals/123-new-netdb-entries/"
                                class="lang-option">Чешский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../de/proposals/123-new-netdb-entries/"
                                class="lang-option">Немецкий</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../fr/proposals/123-new-netdb-entries/"
                                class="lang-option">Французский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../tr/proposals/123-new-netdb-entries/"
                                class="lang-option">Турецкий</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../vi/proposals/123-new-netdb-entries/"
                                class="lang-option">Вьетнамский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../hi/proposals/123-new-netdb-entries/"
                                class="lang-option">Хинди</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ar/proposals/123-new-netdb-entries/"
                                class="lang-option">Арабский</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../pt/proposals/123-new-netdb-entries/"
                                class="lang-option">Португальский</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../ru/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../ru/downloads/" class="btn btn-primary">Загрузить I2P</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        



<div class="proposals-page">
    <div class="container">
        
        <nav class="breadcrumbs">
            <a href="../../../ru/">Home</a>
            <span class="separator">/</span>
            <a href="../../../ru/proposals/">Proposals</a>
            <span class="separator">/</span>
            <span class="current">Новые записи netDB</span>
        </nav>

        
<div class="translation-disclaimer" role="note">
    <span class="disclaimer-message">Этот перевод был создан с помощью машинного обучения и может быть не на 100% точным.</span>
    
    
    <a href="../../../en/proposals/123-new-netdb-entries/" class="disclaimer-link">Просмотреть английскую версию</a>
    
</div>



        
        <header class="proposal-header">
            <div class="proposal-title-section">
                <h1 class="proposal-title">Новые записи netDB</h1>
                <div class="proposal-number">Proposal 123</div>
            </div>

            
            <div class="proposal-meta-box">
                <div class="proposal-status status-открыть">
                    Открыть
                </div>

                
                <div class="proposal-info-grid">
                    
                    <div class="info-item">
                        <span class="info-label">Author</span>
                        <span class="info-value">zzz, str4d, orignal</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Created</span>
                        <span class="info-value">2016-01-16</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Last Updated</span>
                        <span class="info-value">2020-07-18</span>
                    </div>
                    

                    

                    
                </div>

                
                
                <div class="proposal-relationships">
                    
                    <div class="relationship">
                        <span class="relationship-label">Supercedes:</span>
                        <span class="relationship-value">110, 120, 121, 122</span>
                    </div>
                    
                    
                </div>
                
            </div>
        </header>

        
        <div class="proposal-layout proposal-layout--with-toc">
            
            
            <aside class="proposal-toc-sidebar">
                <nav class="toc-nav">
                    <div class="toc-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        On This Page
                    </div>
                    <div class="toc-content">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#статус">Статус</a></li>
    <li><a href="#обзор">Обзор</a></li>
    <li><a href="#предложение">Предложение</a>
      <ul>
        <li><a href="#goals">Goals</a></li>
        <li><a href="#non-goals--out-of-scope">Non-Goals / Out-of-scope</a></li>
        <li><a href="#justification">Justification</a></li>
        <li><a href="#цели">Цели</a></li>
        <li><a href="#не-цели--вне-области-применения">Не-цели / Вне области применения</a></li>
        <li><a href="#обоснование">Обоснование</a></li>
        <li><a href="#типы-данных-netdb">Типы данных NetDB</a></li>
        <li><a href="#примечания">Примечания</a></li>
      </ul>
    </li>
    <li><a href="#standard-ls2-header">Standard LS2 Header</a>
      <ul>
        <li><a href="#процесс-поискасохранения">Процесс поиска/сохранения</a></li>
        <li><a href="#формат">Формат</a></li>
        <li><a href="#соображения-конфиденциальностибезопасности">Соображения конфиденциальности/безопасности</a></li>
        <li><a href="#notes">Notes</a></li>
      </ul>
    </li>
    <li><a href="#new-databaseentry-types">New DatabaseEntry types</a>
      <ul>
        <li><a href="#формат-1">Формат</a></li>
        <li><a href="#обоснование-1">Обоснование</a></li>
        <li><a href="#проблемы">Проблемы</a></li>
        <li><a href="#примечания-1">Примечания</a></li>
        <li><a href="#new-encryption-issues">New Encryption Issues</a></li>
        <li><a href="#leaseset-2">LeaseSet 2</a></li>
        <li><a href="#формат-2">Формат</a></li>
        <li><a href="#обоснование-2">Обоснование</a></li>
        <li><a href="#обсуждение">Обсуждение</a></li>
        <li><a href="#новые-проблемы-с-шифрованием">Новые проблемы с шифрованием</a></li>
        <li><a href="#примечания-2">Примечания</a></li>
        <li><a href="#зашифрованная-ls2">Зашифрованная LS2</a></li>
        <li><a href="#определения">Определения</a></li>
        <li><a href="#формат-3">Формат</a></li>
        <li><a href="#notes-1">Notes</a></li>
        <li><a href="#meta-ls2">Meta LS2</a></li>
        <li><a href="#format">Format</a></li>
        <li><a href="#вывод-ключа-ослепления">Вывод ключа ослепления</a></li>
        <li><a href="#service-record">Service Record</a></li>
        <li><a href="#format-1">Format</a></li>
        <li><a href="#notes-2">Notes</a></li>
        <li><a href="#service-list">Service List</a></li>
        <li><a href="#format-2">Format</a></li>
        <li><a href="#notes-3">Notes</a></li>
      </ul>
    </li>
    <li><a href="#common-structures-spec-changes-required">Common Structures Spec Changes Required</a>
      <ul>
        <li><a href="#шифрование-и-обработка">Шифрование и обработка</a></li>
        <li><a href="#new-intermediate-structures">New Intermediate Structures</a></li>
        <li><a href="#new-netdb-types">New NetDB Types</a></li>
        <li><a href="#new-signature-type">New Signature Type</a></li>
      </ul>
    </li>
    <li><a href="#encryption-spec-changes-required">Encryption Spec Changes Required</a></li>
    <li><a href="#i2np-changes-required">I2NP Changes Required</a>
      <ul>
        <li><a href="#database-lookup-message">Database Lookup Message</a></li>
        <li><a href="#changes">Changes</a></li>
        <li><a href="#авторизация-для-каждого-клиента">Авторизация для каждого клиента</a></li>
        <li><a href="#changes-1">Changes</a></li>
      </ul>
    </li>
    <li><a href="#i2cp-changes-required">I2CP Changes Required</a>
      <ul>
        <li><a href="#i2cp-options">I2CP Options</a></li>
        <li><a href="#session-config">Session Config</a></li>
        <li><a href="#зашифрованные-ls-с-адресами-base-32">Зашифрованные LS с адресами Base 32</a></li>
        <li><a href="#зашифрованный-ls-с-офлайн-ключами">Зашифрованный LS с офлайн ключами</a></li>
        <li><a href="#примечания-3">Примечания</a></li>
        <li><a href="#meta-ls2-1">Meta LS2</a></li>
        <li><a href="#формат-4">Формат</a></li>
        <li><a href="#примечания-4">Примечания</a></li>
        <li><a href="#запись-службы">Запись службы</a></li>
        <li><a href="#формат-5">Формат</a></li>
        <li><a href="#примечания-5">Примечания</a></li>
        <li><a href="#список-сервисов">Список сервисов</a></li>
        <li><a href="#формат-6">Формат</a></li>
        <li><a href="#примечания-6">Примечания</a></li>
        <li><a href="#format-3">Format</a></li>
        <li><a href="#ключевые-сертификаты">Ключевые сертификаты</a></li>
        <li><a href="#новые-промежуточные-структуры">Новые промежуточные структуры</a></li>
        <li><a href="#новые-типы-netdb">Новые типы NetDB</a></li>
        <li><a href="#новый-тип-подписи">Новый тип подписи</a></li>
        <li><a href="#justification-1">Justification</a></li>
        <li><a href="#usage">Usage</a></li>
        <li><a href="#сообщение-запроса-базы-данных">Сообщение запроса базы данных</a></li>
        <li><a href="#изменения">Изменения</a></li>
        <li><a href="#сообщение-хранилища-базы-данных">Сообщение хранилища базы данных</a></li>
        <li><a href="#изменения-1">Изменения</a></li>
      </ul>
    </li>
    <li><a href="#private-key-file-changes-required">Private Key File Changes Required</a>
      <ul>
        <li><a href="#changes-2">Changes</a></li>
        <li><a href="#опции-i2cp">Опции I2CP</a></li>
      </ul>
    </li>
    <li><a href="#streaming-changes-required">Streaming Changes Required</a>
      <ul>
        <li><a href="#конфигурация-сессии">Конфигурация сессии</a></li>
        <li><a href="#сообщение-запроса-leaseset">Сообщение запроса LeaseSet</a></li>
      </ul>
    </li>
    <li><a href="#стандартный-заголовок-ls2">Стандартный заголовок LS2</a>
      <ul>
        <li><a href="#сообщение-запроса-переменного-leaseset">Сообщение запроса переменного LeaseSet</a></li>
        <li><a href="#создать-сообщение-leaseset2">Создать сообщение Leaseset2</a></li>
      </ul>
    </li>
    <li><a href="#sam-v3-changes-required">SAM V3 Changes Required</a>
      <ul>
        <li><a href="#обоснование-3">Обоснование</a></li>
        <li><a href="#тип-сообщения">Тип сообщения</a></li>
      </ul>
    </li>
    <li><a href="#bob-changes-required">BOB Changes Required</a></li>
    <li><a href="#publishing-migration-compatibility">Publishing, Migration, Compatibility</a></li>
    <li><a href="#rollout">Rollout</a></li>
    <li><a href="#новые-типы-databaseentry">Новые типы DatabaseEntry</a></li>
  </ul>
</nav>
                    </div>
                </nav>
            </aside>
            

            
            <div class="proposal-main">
                <article class="proposal-content">
                    <h2 id="статус">Статус</h2>
<p>Части данного предложения завершены и реализованы в версиях 0.9.38 и 0.9.39. Спецификации Common Structures, I2CP, I2NP и другие теперь обновлены, чтобы отражать изменения, которые поддерживаются в настоящее время.</p>
<p>Завершенные части всё ещё могут подвергаться незначительным изменениям. Другие части данного предложения всё ещё находятся в разработке и могут подвергаться существенным изменениям.</p>
<p>Service Lookup (типы 9 и 11) имеют низкий приоритет и не планируются, и могут быть выделены в отдельное предложение.</p>
<h2 id="обзор">Обзор</h2>
<p>Это обновление и объединение следующих 4 предложений:</p>
<ul>
<li>110 LS2</li>
<li>120 Meta LS2 для массивного мультихоминга</li>
<li>121 Зашифрованный LS2</li>
<li>122 Неаутентифицированный поиск сервиса (анкастинг)</li>
</ul>
<p>Эти предложения в основном независимы, но для разумности мы определяем и используем общий формат для нескольких из них.</p>
<p>Следующие предложения в некоторой степени связаны:</p>
<ul>
<li>140 Невидимый мультихоминг (несовместим с данным предложением)</li>
<li>142 Новый криптографический шаблон (для новой симметричной криптографии)</li>
<li>144 ECIES-X25519-AEAD-Ratchet</li>
<li>145 ECIES-P256</li>
<li>146 Red25519</li>
<li>148 EdDSA-BLAKE2b-Ed25519</li>
<li>149 B32 для зашифрованных LS2</li>
<li>150 Протокол Garlic Farm</li>
<li>151 Слепая подпись ECDSA</li>
</ul>
<h2 id="предложение">Предложение</h2>
<p>Данное предложение определяет 5 новых типов DatabaseEntry и процесс их хранения в сетевой базе данных и извлечения из неё, а также метод их подписания и проверки этих подписей.</p>
<h3 id="goals">Goals</h3>
<ul>
<li>Обратная совместимость</li>
<li>LS2 совместим со старым стилем multihoming</li>
<li>Не требуется новая криптография или примитивы для поддержки</li>
<li>Сохраняет разделение криптографии и подписи; поддерживает все текущие и будущие версии</li>
<li>Включает опциональные offline ключи подписи</li>
<li>Снижает точность временных меток для уменьшения fingerprinting</li>
<li>Включает новую криптографию для destination&rsquo;ов</li>
<li>Включает массивный multihoming</li>
<li>Исправляет множественные проблемы с существующими зашифрованными LS</li>
<li>Опциональное blinding для снижения видимости со стороны floodfill&rsquo;ов</li>
<li>Зашифрованные поддерживают как однокнопочные, так и множественные отзывные ключи</li>
<li>Service lookup для упрощения поиска outproxy, bootstrap DHT приложений,
и других применений</li>
<li>Не нарушает ничего, что зависит от 32-байтных бинарных хешей destination&rsquo;ов, например bittorrent</li>
<li>Добавляет гибкость к leaseSet&rsquo;ам через свойства, как у нас есть в routerinfo</li>
<li>Помещает опубликованную временную метку и переменное время истечения в заголовок, чтобы это работало даже
если содержимое зашифровано (не выводить временную метку из самого раннего lease)</li>
<li>Все новые типы находятся в том же DHT пространстве и тех же местах, что и существующие leaseSet&rsquo;ы,
чтобы пользователи могли мигрировать со старого LS на LS2,
или переключаться между LS2, Meta и Encrypted,
без изменения Destination или хеша.</li>
<li>Существующий Destination может быть преобразован для использования offline ключей,
или обратно к online ключам, без изменения Destination или хеша.</li>
</ul>
<h3 id="non-goals--out-of-scope">Non-Goals / Out-of-scope</h3>
<ul>
<li>Новый алгоритм ротации DHT или генерация общего случайного числа</li>
<li>Конкретный новый тип шифрования и схема сквозного шифрования
для использования этого нового типа будут в отдельном предложении.
Никакой новой криптографии здесь не указано или не обсуждается.</li>
<li>Новое шифрование для RI или построения tunnel.
Это будет в отдельном предложении.</li>
<li>Методы шифрования, передачи и приема I2NP DLM / DSM / DSRM сообщений.
Не изменяются.</li>
<li>Как генерировать и поддерживать Meta, включая межмаршрутизаторную связь backend, управление, переключение при отказах и координацию.
Поддержка может быть добавлена в I2CP, или i2pcontrol, или новый протокол.
Это может быть стандартизировано или нет.</li>
<li>Как фактически реализовать и управлять tunnel с более длительным сроком действия, или отменять существующие tunnel.
Это крайне сложно, и без этого невозможно корректно завершить работу.</li>
<li>Изменения модели угроз</li>
<li>Формат офлайн-хранения или методы для хранения/извлечения/совместного использования данных.</li>
<li>Детали реализации здесь не обсуждаются и оставляются на усмотрение каждого проекта.</li>
</ul>
<h3 id="justification">Justification</h3>
<p>LS2 добавляет поля для изменения типа шифрования и для будущих изменений протокола.</p>
<p>Зашифрованный LS2 исправляет несколько проблем безопасности существующего зашифрованного LS, используя асимметричное шифрование всего набора leases.</p>
<p>Meta LS2 обеспечивает гибкое, эффективное, действенное и крупномасштабное мультихоминг.</p>
<p>Service Record и Service List предоставляют anycast-сервисы, такие как поиск имен и начальная загрузка DHT.</p>
<h3 id="цели">Цели</h3>
<p>Номера типов используются в I2NP сообщениях Database Lookup/Store.</p>
<p>Столбец end-to-end указывает, отправляются ли запросы/ответы к Destination в Garlic Message.</p>
<p>Существующие типы:</p>
<table>
  <thead>
      <tr>
          <th>NetDB Data</th>
          <th>Lookup Type</th>
          <th>Store Type</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>any</td>
          <td>0</td>
          <td>any</td>
      </tr>
      <tr>
          <td>LS</td>
          <td>1</td>
          <td>1</td>
      </tr>
      <tr>
          <td>RI</td>
          <td>2</td>
          <td>0</td>
      </tr>
      <tr>
          <td>exploratory</td>
          <td>3</td>
          <td>DSRM</td>
      </tr>
      <tr>
          <td>Новые типы:</td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<table>
  <thead>
      <tr>
          <th>NetDB Data</th>
          <th>Lookup Type</th>
          <th>Store Type</th>
          <th>Std. LS2 Header?</th>
          <th>Sent end-to-end?</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>LS2</td>
          <td>1</td>
          <td>3</td>
          <td>yes</td>
          <td>yes</td>
      </tr>
      <tr>
          <td>Encrypted LS2</td>
          <td>1</td>
          <td>5</td>
          <td>no</td>
          <td>no</td>
      </tr>
      <tr>
          <td>Meta LS2</td>
          <td>1</td>
          <td>7</td>
          <td>yes</td>
          <td>no</td>
      </tr>
      <tr>
          <td>Service Record</td>
          <td>n/a</td>
          <td>9</td>
          <td>yes</td>
          <td>no</td>
      </tr>
      <tr>
          <td>Service List</td>
          <td>4</td>
          <td>11</td>
          <td>no</td>
          <td>no</td>
      </tr>
  </tbody>
</table>
<h3 id="не-цели--вне-области-применения">Не-цели / Вне области применения</h3>
<ul>
<li>
<p>Типы поиска в настоящее время находятся в битах 3-2 в сообщении Database Lookup Message.
Любые дополнительные типы потребуют использования бита 4.</p>
</li>
<li>
<p>Все типы хранилищ являются нечетными, поскольку старшие биты в поле типа Database Store Message игнорируются старыми роутерами.
Мы предпочли бы, чтобы парсинг завершался неудачей как LS, а не как сжатый RI.</p>
</li>
<li>
<p>Должен ли тип быть явным или неявным, или ни тем, ни другим в данных, покрываемых подписью?</p>
</li>
</ul>
<h3 id="обоснование">Обоснование</h3>
<p>Типы 3, 5 и 7 могут быть возвращены в ответ на стандартный поиск leaseset (тип 1). Тип 9 никогда не возвращается в ответ на поиск. Тип 11 возвращается в ответ на новый тип поиска службы (тип 11).</p>
<p>Только тип 3 может быть отправлен в Garlic сообщении клиент-клиент.</p>
<h3 id="типы-данных-netdb">Типы данных NetDB</h3>
<p>Типы 3, 7 и 9 имеют общий формат::</p>
<p>Стандартный заголовок LS2   - как определено ниже</p>
<p>Специфичная для типа часть   - как определено ниже в каждой части</p>
<p>Стандартная подпись LS2:   - Длина определяется типом подписи ключа подписания</p>
<p>Тип 5 (Зашифрованный) не начинается с Destination и имеет другой формат. См. ниже.</p>
<p>Тип 11 (Список сервисов) является агрегацией нескольких записей сервисов и имеет другой формат. См. ниже.</p>
<h3 id="примечания">Примечания</h3>
<p>I notice that the text you provided is &ldquo;TBD&rdquo; (To Be Determined), which is typically a placeholder indicating that content hasn&rsquo;t been written yet. Since this is not actual content to translate, I&rsquo;ll return it as-is:</p>
<p>TBD</p>
<h2 id="standard-ls2-header">Standard LS2 Header</h2>
<p>Типы 3, 7 и 9 используют стандартный заголовок LS2, описанный ниже:</p>
<h3 id="процесс-поискасохранения">Процесс поиска/сохранения</h3>
<pre tabindex="0"><code>Standard LS2 Header:
  - Type (1 byte)
    Not actually in header, but part of data covered by signature.
    Take from field in Database Store Message.
  - Destination (387+ bytes)
  - Published timestamp (4 bytes, big endian, seconds since epoch, rolls over in 2106)
  - Expires (2 bytes, big endian) (offset from published timestamp in seconds, 18.2 hours max)
  - Flags (2 bytes)
    Bit order: 15 14 ... 3 2 1 0
    Bit 0: If 0, no offline keys; if 1, offline keys
    Bit 1: If 0, a standard published leaseset.
           If 1, an unpublished leaseset. Should not be flooded, published, or
           sent in response to a query. If this leaseset expires, do not query the
           netdb for a new one, unless bit 2 is set.
    Bit 2: If 0, a standard published leaseset.
           If 1, this unencrypted leaseset will be blinded and encrypted when published.
           If this leaseset expires, query the blinded location in the netdb for a new one.
           If this bit is set to 1, set bit 1 to 1 also.
           As of release 0.9.42.
    Bits 3-15: set to 0 for compatibility with future uses
  - If flag indicates offline keys, the offline signature section:
    Expires timestamp (4 bytes, big endian, seconds since epoch, rolls over in 2106)
    Transient sig type (2 bytes, big endian)
    Transient signing public key (length as implied by sig type)
    Signature of expires timestamp, transient sig type, and public key,
    by the destination public key,
    length as implied by destination public key sig type.
    This section can, and should, be generated offline.
</code></pre><h3 id="формат">Формат</h3>
<ul>
<li>
<p>Unpublished/published: Для использования при отправке database store от конца до конца,
отправляющий router может захотеть указать, что этот leaseset не должен быть
отправлен другим. В настоящее время мы используем эвристику для поддержания этого состояния.</p>
</li>
<li>
<p>Published: Заменяет сложную логику, необходимую для определения &lsquo;версии&rsquo;
leaseset. В настоящее время версия является временем истечения последнего истекающего lease,
и публикующий router должен увеличить это время истечения минимум на 1мс при
публикации leaseset, который только удаляет более старый lease.</p>
</li>
<li>
<p>Expires: Позволяет установить срок истечения записи netDb раньше, чем у её последнего истекающего leaseSet. Может быть не полезно для LS2, где leaseSet&rsquo;ы ожидаются с максимальным сроком истечения в 11 минут, но для других новых типов это необходимо (см. Meta LS и Service Record ниже).</p>
</li>
<li>
<p>Офлайн-ключи являются опциональными, чтобы снизить первоначальную/требуемую сложность реализации.</p>
</li>
</ul>
<h3 id="соображения-конфиденциальностибезопасности">Соображения конфиденциальности/безопасности</h3>
<ul>
<li>
<p>Можно было бы ещё больше снизить точность timestamp (до 10 минут?), но пришлось бы добавить номер версии. Это могло бы нарушить multihoming, если только у нас нет шифрования с сохранением порядка? Вероятно, совсем без timestamp обойтись нельзя.</p>
</li>
<li>
<p>Альтернатива: 3-байтовая временная метка (эпоха / 10 минут), 1-байтовая версия, 2-байтовый срок истечения</p>
</li>
<li>
<p>Является ли тип явным или неявным в данных / подписи? Константы &ldquo;Domain&rdquo; для подписи?</p>
</li>
</ul>
<h3 id="notes">Notes</h3>
<ul>
<li>
<p>Роутеры не должны публиковать leaseSet чаще одного раза в секунду.
Если это происходит, они должны искусственно увеличить временную метку публикации на 1
по сравнению с ранее опубликованным leaseSet.</p>
</li>
<li>
<p>Реализации router могут кэшировать временные ключи и подпись, чтобы
избежать верификации каждый раз. В частности, floodfill и router на
обоих концах долгосрочных соединений могут получить выгоду от этого.</p>
</li>
<li>
<p>Офлайн-ключи и подписи подходят только для долгоживущих destinations,
т.е. серверов, а не клиентов.</p>
</li>
</ul>
<h2 id="new-databaseentry-types">New DatabaseEntry types</h2>
<h3 id="формат-1">Формат</h3>
<p>Изменения по сравнению с существующим LeaseSet:</p>
<ul>
<li>Добавить временную метку публикации, временную метку истечения, флаги и свойства</li>
<li>Добавить тип шифрования</li>
<li>Удалить ключ отзыва</li>
</ul>
<p>Поиск с помощью</p>
<pre><code>Standard LS flag (1)
</code></pre>
<p>Сохранить с</p>
<pre><code>Standard LS2 type (3)
</code></pre>
<p>Хранить в</p>
<pre><code>Hash of destination
This hash is then used to generate the daily &quot;routing key&quot;, as in LS1
</code></pre>
<p>Типичное истечение срока действия</p>
<pre><code>10 minutes, as in a regular LS.
</code></pre>
<p>Опубликовано</p>
<pre><code>Destination
</code></pre>
<h3 id="обоснование-1">Обоснование</h3>
<pre tabindex="0"><code>Standard LS2 Header as specified above

  Standard LS2 Type-Specific Part
  - Properties (Mapping as specified in common structures spec, 2 zero bytes if none)
  - Number of key sections to follow (1 byte, max TBD)
  - Key sections:
    - Encryption type (2 bytes, big endian)
    - Encryption key length (2 bytes, big endian)
      This is explicit, so floodfills can parse LS2 with unknown encryption types.
    - Encryption key (number of bytes specified)
  - Number of lease2s (1 byte)
  - Lease2s (40 bytes each)
    These are leases, but with a 4-byte instead of an 8-byte expiration,
    seconds since the epoch (rolls over in 2106)

  Standard LS2 Signature:
  - Signature
    If flag indicates offline keys, this is signed by the transient pubkey,
    otherwise, by the destination pubkey
    Length as implied by sig type of signing key
    The signature is of everything above.
</code></pre><h3 id="проблемы">Проблемы</h3>
<ul>
<li>
<p>Properties: Будущее расширение и гибкость.
Размещается первым на случай, если это необходимо для парсинга оставшихся данных.</p>
</li>
<li>
<p>Множественные пары типов шифрования/открытых ключей предназначены
для облегчения перехода к новым типам шифрования. Другой способ сделать это —
опубликовать множественные leaseSet, возможно используя те же туннели,
как мы делаем сейчас для DSA и EdDSA назначений.
Идентификация входящего типа шифрования в туннеле
может быть выполнена с помощью существующего механизма session tag,
и/или пробной расшифровки с использованием каждого ключа. Длины входящих
сообщений также могут предоставить подсказку.</p>
</li>
</ul>
<h3 id="примечания-1">Примечания</h3>
<p>Данное предложение продолжает использовать публичный ключ в leaseset для ключа сквозного шифрования и оставляет поле публичного ключа в Destination неиспользуемым, как это происходит сейчас. Тип шифрования не указывается в сертификате ключа Destination, он останется равным 0.</p>
<p>Отклоненной альтернативой является указание типа шифрования в сертификате ключа Destination, использование публичного ключа в Destination и неиспользование публичного ключа в leaseset. Мы не планируем этого делать.</p>
<p>Преимущества LS2:</p>
<ul>
<li>Расположение фактического публичного ключа не изменяется.</li>
<li>Тип шифрования или публичный ключ могут изменяться без изменения Destination.</li>
<li>Удаляет неиспользуемое поле отзыва</li>
<li>Базовая совместимость с другими типами DatabaseEntry в данном предложении</li>
<li>Позволяет использовать несколько типов шифрования</li>
</ul>
<p>Недостатки LS2:</p>
<ul>
<li>Расположение открытого ключа и тип шифрования отличается от RouterInfo</li>
<li>Сохраняет неиспользуемый открытый ключ в leaseset</li>
<li>Требует реализации по всей сети; в качестве альтернативы могут использоваться экспериментальные
типы шифрования, если это разрешено floodfill-узлами
(но см. связанные предложения 136 и 137 о поддержке экспериментальных типов подписей).
Альтернативное предложение может быть проще для реализации и тестирования экспериментальных типов шифрования.</li>
</ul>
<h3 id="new-encryption-issues">New Encryption Issues</h3>
<p>Часть этого выходит за рамки данного предложения, но пока размещаем заметки здесь, поскольку у нас пока нет отдельного предложения по шифрованию. См. также предложения ECIES 144 и 145.</p>
<ul>
<li>
<p>Тип шифрования представляет комбинацию
кривой, длины ключа и сквозной схемы,
включая KDF и MAC, если они есть.</p>
</li>
<li>
<p>Мы включили поле длины ключа, чтобы LS2 можно было
парсить и верифицировать floodfill&rsquo;ом даже для неизвестных типов шифрования.</p>
</li>
<li>
<p>Первым новым типом шифрования, который будет предложен,
вероятно, станет ECIES/X25519. Как он будет использоваться end-to-end
(либо слегка модифицированная версия ElGamal/AES+SessionTag,
либо что-то совершенно новое, например ChaCha/Poly) будет определено
в одном или нескольких отдельных предложениях.
См. также предложения ECIES 144 и 145.</p>
</li>
</ul>
<h3 id="leaseset-2">LeaseSet 2</h3>
<ul>
<li>
<p>Срок действия в 8 байт в lease изменен на 4 байта.</p>
</li>
<li>
<p>Если мы когда-либо реализуем отзыв, мы можем сделать это с полем expires равным нулю,
или нулевыми leases, или и тем, и другим. Нет необходимости в отдельном ключе отзыва.</p>
</li>
<li>
<p>Ключи шифрования расположены в порядке предпочтения сервера, наиболее предпочтительный первым.
Поведение клиента по умолчанию — выбрать первый ключ с
поддерживаемым типом шифрования. Клиенты могут использовать другие алгоритмы выбора
на основе поддержки шифрования, относительной производительности и других факторов.</p>
</li>
</ul>
<h3 id="формат-2">Формат</h3>
<p>Цели:</p>
<ul>
<li>Добавить блайндинг</li>
<li>Разрешить несколько типов подписей</li>
<li>Не требовать новых криптографических примитивов</li>
<li>Опционально шифровать для каждого получателя, с возможностью отзыва</li>
<li>Поддерживать шифрование только Standard LS2 и Meta LS2</li>
</ul>
<p>Зашифрованный LS2 никогда не отправляется в end-to-end garlic сообщении. Используйте стандартный LS2, как описано выше.</p>
<p>Изменения по сравнению с существующим зашифрованным LeaseSet:</p>
<ul>
<li>Зашифровать всё целиком для безопасности</li>
<li>Безопасно зашифровать, не только с помощью AES.</li>
<li>Зашифровать для каждого получателя</li>
</ul>
<p>Поиск с помощью</p>
<pre><code>Standard LS flag (1)
</code></pre>
<p>Сохранить с</p>
<pre><code>Encrypted LS2 type (5)
</code></pre>
<p>Сохранить в</p>
<pre><code>Hash of blinded sig type and blinded public key
Two byte sig type (big endian, e.g. 0x000b) || blinded public key
This hash is then used to generate the daily &quot;routing key&quot;, as in LS1
</code></pre>
<p>Типичный срок действия</p>
<pre><code>10 minutes, as in a regular LS, or hours, as in a meta LS.
</code></pre>
<p>Опубликовано</p>
<pre><code>Destination
</code></pre>
<h3 id="обоснование-2">Обоснование</h3>
<p>Мы определяем следующие функции, соответствующие криптографическим строительным блокам, используемым для зашифрованного LS2:</p>
<p>ГПСЧ(n)</p>
<pre><code>n-byte output from a cryptographically-secure random number generator.

In addition to the requirement of CSRNG being cryptographically-secure (and thus
suitable for generating key material), it MUST be safe
for some n-byte output to be used for key material when the byte sequences immediately
preceding and following it are exposed on the network (such as in a salt, or encrypted
padding). Implementations that rely on a potentially-untrustworthy source should hash
any output that is to be exposed on the network. See [PRNG references](http://projectbullrun.org/dual-ec/ext-rand.html) and [Tor dev discussion](https://lists.torproject.org/pipermail/tor-dev/2015-November/009954.html).
</code></pre>
<p>H(p, d)</p>
<pre><code>SHA-256 hash function that takes a personalization string p and data d, and
produces an output of length 32 bytes.

Use SHA-256 as follows::

    H(p, d) := SHA-256(p || d)
</code></pre>
<p>ПОТОК</p>
<pre><code>The ChaCha20 stream cipher as specified in [RFC 7539 Section 2.4](https://tools.ietf.org/html/rfc7539#section-2.4), with the initial counter
set to 1. S_KEY_LEN = 32 and S_IV_LEN = 12.

ENCRYPT(k, iv, plaintext)
    Encrypts plaintext using the cipher key k, and nonce iv which MUST be unique for
    the key k. Returns a ciphertext that is the same size as the plaintext.

    The entire ciphertext must be indistinguishable from random if the key is secret.

DECRYPT(k, iv, ciphertext)
    Decrypts ciphertext using the cipher key k, and nonce iv. Returns the plaintext.
</code></pre>
<p>SIG</p>
<pre><code>The RedDSA signature scheme (corresponding to SigType 11) with key blinding.
It has the following functions:

DERIVE_PUBLIC(privkey)
    Returns the public key corresponding to the given private key.

SIGN(privkey, m)
    Returns a signature by the private key privkey over the given message m.

VERIFY(pubkey, m, sig)
    Verifies the signature sig against the public key pubkey and message m. Returns
    true if the signature is valid, false otherwise.

It must also support the following key blinding operations:

GENERATE_ALPHA(data, secret)
    Generate alpha for those who know the data and an optional secret.
    The result must be identically distributed as the private keys.

BLIND_PRIVKEY(privkey, alpha)
    Blinds a private key, using a secret alpha.

BLIND_PUBKEY(pubkey, alpha)
    Blinds a public key, using a secret alpha.
    For a given keypair (privkey, pubkey) the following relationship holds::

        BLIND_PUBKEY(pubkey, alpha) ==
        DERIVE_PUBLIC(BLIND_PRIVKEY(privkey, alpha))
</code></pre>
<p>DH</p>
<pre><code>X25519 public key agreement system. Private keys of 32 bytes, public keys of 32
bytes, produces outputs of 32 bytes. It has the following
functions:

GENERATE_PRIVATE()
    Generates a new private key.

DERIVE_PUBLIC(privkey)
    Returns the public key corresponding to the given private key.

DH(privkey, pubkey)
    Generates a shared secret from the given private and public keys.
</code></pre>
<p>HKDF(salt, ikm, info, n)</p>
<pre><code>A cryptographic key derivation function which takes some input key material ikm (which
should have good entropy but is not required to be a uniformly random string), a salt
of length 32 bytes, and a context-specific 'info' value, and produces an output
of n bytes suitable for use as key material.

Use HKDF as specified in [RFC 5869](https://tools.ietf.org/html/rfc5869), using the HMAC hash function SHA-256
as specified in [RFC 2104](https://tools.ietf.org/html/rfc2104). This means that SALT_LEN is 32 bytes max.
</code></pre>
<h3 id="обсуждение">Обсуждение</h3>
<p>Зашифрованный формат LS2 состоит из трех вложенных слоев:</p>
<ul>
<li>Внешний слой, содержащий необходимую информацию в открытом виде для хранения и извлечения.</li>
<li>Средний слой, который обрабатывает аутентификацию клиента.</li>
<li>Внутренний слой, который содержит фактические данные LS2.</li>
</ul>
<p>Общий формат выглядит следующим образом::</p>
<pre><code>Layer 0 data + Enc(layer 1 data + Enc(layer 2 data)) + Signature
</code></pre>
<p>Обратите внимание, что зашифрованный LS2 является замаскированным. Destination не находится в заголовке. Местоположение хранения DHT — SHA-256(sig type || замаскированный публичный ключ) и меняется ежедневно.</p>
<p>НЕ использует стандартный заголовок LS2, указанный выше.</p>
<h4 id="layer-0-outer">Layer 0 (outer)</h4>
<p>Тип</p>
<pre><code>1 byte

Not actually in header, but part of data covered by signature.
Take from field in Database Store Message.
</code></pre>
<p>Тип подписи скрытого открытого ключа</p>
<pre><code>2 bytes, big endian
This will always be type 11, identifying a Red25519 blinded key.
</code></pre>
<p>Затемнённый открытый ключ</p>
<pre><code>Length as implied by sig type
</code></pre>
<p>Временная метка публикации</p>
<pre><code>4 bytes, big endian

Seconds since epoch, rolls over in 2106
</code></pre>
<p>Истекает</p>
<pre><code>2 bytes, big endian

Offset from published timestamp in seconds, 18.2 hours max
</code></pre>
<p>Флаги</p>
<pre><code>2 bytes

Bit order: 15 14 ... 3 2 1 0

Bit 0: If 0, no offline keys; if 1, offline keys

Other bits: set to 0 for compatibility with future uses
</code></pre>
<p>Данные временного ключа</p>
<pre><code>Present if flag indicates offline keys

Expires timestamp
    4 bytes, big endian

    Seconds since epoch, rolls over in 2106

Transient sig type
    2 bytes, big endian

Transient signing public key
    Length as implied by sig type

Signature
    Length as implied by blinded public key sig type

    Over expires timestamp, transient sig type, and transient public key.

    Verified with the blinded public key.
</code></pre>
<p>lenOuterCiphertext</p>
<pre><code>2 bytes, big endian
</code></pre>
<p>outerCiphertext</p>
<pre><code>lenOuterCiphertext bytes

Encrypted layer 1 data. See below for key derivation and encryption algorithms.
</code></pre>
<p>Подпись</p>
<pre><code>Length as implied by sig type of the signing key used

The signature is of everything above.

If the flag indicates offline keys, the signature is verified with the transient
public key. Otherwise, the signature is verified with the blinded public key.
</code></pre>
<h4 id="layer-1-middle">Layer 1 (middle)</h4>
<p>Флаги</p>
<pre><code>1 byte

Bit order: 76543210

Bit 0: 0 for everybody, 1 for per-client, auth section to follow

Bits 3-1: Authentication scheme, only if bit 0 is set to 1 for per-client, otherwise 000
          000: DH client authentication (or no per-client authentication)
          001: PSK client authentication

Bits 7-4: Unused, set to 0 for future compatibility
</code></pre>
<p>DH данные аутентификации клиента</p>
<pre><code>Present if flag bit 0 is set to 1 and flag bits 3-1 are set to 000.

ephemeralPublicKey
    32 bytes

clients
    2 bytes, big endian

    Number of authClient entries to follow, 40 bytes each

authClient
    Authorization data for a single client.
    See below for the per-client authorization algorithm.

    clientID_i
        8 bytes

    clientCookie_i
        32 bytes
</code></pre>
<p>Данные аутентификации клиента PSK</p>
<pre><code>Present if flag bit 0 is set to 1 and flag bits 3-1 are set to 001.

authSalt
    32 bytes

clients
    2 bytes, big endian

    Number of authClient entries to follow, 40 bytes each

authClient
    Authorization data for a single client.
    See below for the per-client authorization algorithm.

    clientID_i
        8 bytes

    clientCookie_i
        32 bytes
</code></pre>
<p>innerCiphertext</p>
<pre><code>Length implied by lenOuterCiphertext (whatever data remains)

Encrypted layer 2 data. See below for key derivation and encryption algorithms.
</code></pre>
<h4 id="layer-2-inner">Layer 2 (inner)</h4>
<p>Тип</p>
<pre><code>1 byte

Either 3 (LS2) or 7 (Meta LS2)
</code></pre>
<p>Данные</p>
<pre><code>LeaseSet2 data for the given type.

Includes the header and signature.
</code></pre>
<h3 id="новые-проблемы-с-шифрованием">Новые проблемы с шифрованием</h3>
<p>Мы используем следующую схему для ослепления ключей, основанную на Ed25519 и <a href="https://github.com/zcash/zips/tree/master/protocol/protocol.pdf">ZCash RedDSA</a>
. Подписи Re25519 работают на кривой Ed25519, используя SHA-512 для хеширования.</p>
<p>Мы не используем <a href="https://spec.torproject.org/rend-spec-v3">Tor&rsquo;s rend-spec-v3.txt appendix A.2</a>
, который имеет схожие цели проектирования, поскольку его затененные публичные ключи могут находиться вне подгруппы простого порядка, что создает неизвестные последствия для безопасности.</p>
<h4 id="goals-1">Goals</h4>
<ul>
<li>Подписывающий открытый ключ в незашифрованном destination должен быть
Ed25519 (тип подписи 7) или Red25519 (тип подписи 11);
другие типы подписей не поддерживаются</li>
<li>Если подписывающий открытый ключ находится в автономном режиме, временный подписывающий открытый ключ также должен быть Ed25519</li>
<li>Blinding является вычислительно простым</li>
<li>Использует существующие криптографические примитивы</li>
<li>Зашифрованные открытые ключи не могут быть расшифрованы</li>
<li>Зашифрованные открытые ключи должны находиться на кривой Ed25519 и подгруппе простого порядка</li>
<li>Необходимо знать подписывающий открытый ключ destination
(полный destination не требуется) для получения зашифрованного открытого ключа</li>
<li>Опционально предоставляет дополнительный секрет, необходимый для получения зашифрованного открытого ключа</li>
</ul>
<h4 id="security">Security</h4>
<p>Безопасность схемы блайндинга требует, чтобы распределение alpha было таким же, как у небланкированных приватных ключей. Однако когда мы блайндим приватный ключ Ed25519 (тип подписи 7) в приватный ключ Red25519 (тип подписи 11), распределение отличается. Для соответствия требованиям <a href="https://github.com/zcash/zips/tree/master/protocol/protocol.pdf">zcash раздел 4.1.6.1</a>
, Red25519 (тип подписи 11) должен использоваться и для небланкированных ключей, чтобы &ldquo;комбинация перерандомизированного публичного ключа и подписи(ей) под этим ключом не раскрывала ключ, из которого он был перерандомизирован.&rdquo; Мы разрешаем тип 7 для существующих destinations, но рекомендуем тип 11 для новых destinations, которые будут зашифрованы.</p>
<h4 id="definitions">Definitions</h4>
<p>Б</p>
<pre><code>The Ed25519 base point (generator) 2^255 - 19 as in [Ed25519](http://cr.yp.to/papers.html#ed25519)
</code></pre>
<p>L</p>
<pre><code>The Ed25519 order 2^252 + 27742317777372353535851937790883648493
as in [Ed25519](http://cr.yp.to/papers.html#ed25519)
</code></pre>
<p>DERIVE_PUBLIC(a)</p>
<pre><code>Convert a private key to public, as in Ed25519 (mulitply by G)
</code></pre>
<p>альфа</p>
<pre><code>A 32-byte random number known to those who know the destination.
</code></pre>
<p>GENERATE_ALPHA(destination, date, secret)</p>
<pre><code>Generate alpha for the current date, for those who know the destination and the secret.
The result must be identically distributed as Ed25519 private keys.
</code></pre>
<p>а</p>
<pre><code>The unblinded 32-byte EdDSA or RedDSA signing private key used to sign the destination
</code></pre>
<p>А</p>
<pre><code>The unblinded 32-byte EdDSA or RedDSA signing public key in the destination,
= DERIVE_PUBLIC(a), as in Ed25519
</code></pre>
<p>a&rsquo;</p>
<pre><code>The blinded 32-byte EdDSA signing private key used to sign the encrypted leaseset
This is a valid EdDSA private key.
</code></pre>
<p>А'</p>
<pre><code>The blinded 32-byte EdDSA signing public key in the Destination,
may be generated with DERIVE_PUBLIC(a'), or from A and alpha.
This is a valid EdDSA public key, on the curve and on the prime-order subgroup.
</code></pre>
<p>LEOS2IP(x)</p>
<pre><code>Flip the order of the input bytes to little-endian
</code></pre>
<p>H*(x)</p>
<pre><code>32 bytes = (LEOS2IP(SHA512(x))) mod B, same as in Ed25519 hash-and-reduce
</code></pre>
<h4 id="blinding-calculations">Blinding Calculations</h4>
<p>Новые секретные alpha и blinded ключи должны генерироваться каждый день (UTC). Секретный alpha и blinded ключи вычисляются следующим образом.</p>
<p>GENERATE_ALPHA(destination, date, secret), для всех сторон:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>// GENERATE_ALPHA(destination, date, secret)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // secret is optional, else zero-length
</span></span><span style="display:flex;"><span>  A = destination&#39;s signing public key
</span></span><span style="display:flex;"><span>  stA = signature type of A, 2 bytes big endian (0x0007 or 0x000b)
</span></span><span style="display:flex;"><span>  stA&#39; = signature type of blinded public key A&#39;, 2 bytes big endian (0x000b)
</span></span><span style="display:flex;"><span>  keydata = A || stA || stA&#39;
</span></span><span style="display:flex;"><span>  datestring = 8 bytes ASCII YYYYMMDD from the current date UTC
</span></span><span style="display:flex;"><span>  secret = UTF-8 encoded string
</span></span><span style="display:flex;"><span>  seed = HKDF(H(&#34;I2PGenerateAlpha&#34;, keydata), datestring || secret, &#34;i2pblinding1&#34;, 64)
</span></span><span style="display:flex;"><span>  // treat seed as a 64 byte little-endian value
</span></span><span style="display:flex;"><span>  alpha = seed mod L
</span></span></code></pre></div><p>BLIND_PRIVKEY(), для владельца, публикующего leaseset:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>// BLIND_PRIVKEY()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  alpha = GENERATE_ALPHA(destination, date, secret)
</span></span><span style="display:flex;"><span>  // If for a Ed25519 private key (type 7)
</span></span><span style="display:flex;"><span>  seed = destination&#39;s signing private key
</span></span><span style="display:flex;"><span>  a = left half of SHA512(seed) and clamped as usual for Ed25519
</span></span><span style="display:flex;"><span>  // else, for a Red25519 private key (type 11)
</span></span><span style="display:flex;"><span>  a = destination&#39;s signing private key
</span></span><span style="display:flex;"><span>  // Addition using scalar arithmentic
</span></span><span style="display:flex;"><span>  blinded signing private key = a&#39; = BLIND_PRIVKEY(a, alpha) = (a + alpha) mod L
</span></span><span style="display:flex;"><span>  blinded signing public key = A&#39; = DERIVE_PUBLIC(a&#39;)
</span></span></code></pre></div><p>BLIND_PUBKEY(), для клиентов, получающих leaseset:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>// BLIND_PUBKEY()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  alpha = GENERATE_ALPHA(destination, date, secret)
</span></span><span style="display:flex;"><span>  A = destination&#39;s signing public key
</span></span><span style="display:flex;"><span>  // Addition using group elements (points on the curve)
</span></span><span style="display:flex;"><span>  blinded public key = A&#39; = BLIND_PUBKEY(A, alpha) = A + DERIVE_PUBLIC(alpha)
</span></span></code></pre></div><p>Оба метода вычисления A&rsquo; дают одинаковый результат, как и требуется.</p>
<h4 id="signing">Signing</h4>
<p>Незашифрованный leaseset подписывается незашифрованным приватным ключом подписи Ed25519 или Red25519 и проверяется незашифрованным публичным ключом подписи Ed25519 или Red25519 (типы подписи 7 или 11) как обычно.</p>
<p>Если публичный ключ подписи находится в автономном режиме, незашифрованный leaseset подписывается незашифрованным временным закрытым ключом подписи Ed25519 или Red25519 и проверяется с помощью незашифрованного временного публичного ключа подписи Ed25519 или Red25519 (типы подписи 7 или 11) как обычно. См. дополнительные примечания по автономным ключам для зашифрованных leasesets ниже.</p>
<p>Для подписи зашифрованного leaseset мы используем Red25519, основанный на <a href="https://github.com/zcash/zips/tree/master/protocol/protocol.pdf">RedDSA</a>
 для подписи и проверки со скрытыми ключами. Подписи Red25519 используют кривую Ed25519 с SHA-512 для хеширования.</p>
<p>Red25519 идентичен стандартному Ed25519 за исключением указанного ниже.</p>
<h4 id="signverify-calculations">Sign/Verify Calculations</h4>
<p>Внешняя часть зашифрованного leaseset использует ключи и подписи Red25519.</p>
<p>Red25519 практически идентичен Ed25519. Существует два различия:</p>
<p>Приватные ключи Red25519 генерируются из случайных чисел и затем должны быть приведены по модулю L, где L определено выше. Приватные ключи Ed25519 генерируются из случайных чисел и затем &ldquo;зажимаются&rdquo; с использованием побитового маскирования байтов 0 и 31. Это не выполняется для Red25519. Функции GENERATE_ALPHA() и BLIND_PRIVKEY(), определенные выше, генерируют правильные приватные ключи Red25519 с использованием mod L.</p>
<p>В Red25519 вычисление r для подписи использует дополнительные случайные данные и использует значение открытого ключа, а не хеш закрытого ключа. Благодаря случайным данным каждая подпись Red25519 отличается, даже при подписании одних и тех же данных одним и тем же ключом.</p>
<p>Подписание:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>T = 80 random bytes
</span></span><span style="display:flex;"><span>  r = H*(T || publickey || message)
</span></span><span style="display:flex;"><span>  // rest is the same as in Ed25519
</span></span></code></pre></div><p>Проверка:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>// same as in Ed25519
</span></span></code></pre></div><h3 id="примечания-2">Примечания</h3>
<h4 id="derivation-of-subcredentials">Derivation of subcredentials</h4>
<p>В рамках процесса ослепления нам необходимо убедиться, что зашифрованный LS2 может быть расшифрован только тем, кто знает соответствующий открытый ключ подписи Destination. Полный Destination не требуется. Для достижения этого мы выводим учетные данные из открытого ключа подписи:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>A = destination&#39;s signing public key
</span></span><span style="display:flex;"><span>  stA = signature type of A, 2 bytes big endian (0x0007 or 0x000b)
</span></span><span style="display:flex;"><span>  stA&#39; = signature type of A&#39;, 2 bytes big endian (0x000b)
</span></span><span style="display:flex;"><span>  keydata = A || stA || stA&#39;
</span></span><span style="display:flex;"><span>  credential = H(&#34;credential&#34;, keydata)
</span></span></code></pre></div><p>Строка персонализации гарантирует, что учетные данные не конфликтуют с любым хешем, используемым в качестве ключа поиска DHT, таким как обычный хеш Destination.</p>
<p>Для данного замаскированного ключа мы затем можем получить подучётные данные:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>subcredential = H(&#34;subcredential&#34;, credential || blindedPublicKey)
</span></span></code></pre></div><p>Субкредентиал включается в процессы вывода ключей ниже, что связывает эти ключи со знанием публичного ключа подписи Destination.</p>
<h4 id="layer-1-encryption">Layer 1 encryption</h4>
<p>Сначала подготавливается входная информация для процесса выведения ключа:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>outerInput = subcredential || publishedTimestamp
</span></span></code></pre></div><p>Далее генерируется случайная соль:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>outerSalt = CSRNG(32)
</span></span></code></pre></div><p>Затем выводится ключ, используемый для шифрования слоя 1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>keys = HKDF(outerSalt, outerInput, &#34;ELS2_L1K&#34;, 44)
</span></span><span style="display:flex;"><span>  outerKey = keys[0:31]
</span></span><span style="display:flex;"><span>  outerIV = keys[32:43]
</span></span></code></pre></div><p>Наконец, открытый текст уровня 1 шифруется и сериализуется:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>outerCiphertext = outerSalt || ENCRYPT(outerKey, outerIV, outerPlaintext)
</span></span></code></pre></div><h4 id="layer-1-decryption">Layer 1 decryption</h4>
<p>Соль извлекается из зашифрованного текста 1-го уровня:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>outerSalt = outerCiphertext[0:31]
</span></span></code></pre></div><p>Затем выводится ключ, используемый для шифрования слоя 1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>outerInput = subcredential || publishedTimestamp
</span></span><span style="display:flex;"><span>  keys = HKDF(outerSalt, outerInput, &#34;ELS2_L1K&#34;, 44)
</span></span><span style="display:flex;"><span>  outerKey = keys[0:31]
</span></span><span style="display:flex;"><span>  outerIV = keys[32:43]
</span></span></code></pre></div><p>Наконец, шифртекст уровня 1 расшифровывается:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>outerPlaintext = DECRYPT(outerKey, outerIV, outerCiphertext[32:end])
</span></span></code></pre></div><h4 id="layer-2-encryption">Layer 2 encryption</h4>
<p>Когда авторизация клиента включена, <code>authCookie</code> вычисляется как описано ниже. Когда авторизация клиента отключена, <code>authCookie</code> представляет собой массив байтов нулевой длины.</p>
<p>Шифрование происходит аналогично уровню 1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>innerInput = authCookie || subcredential || publishedTimestamp
</span></span><span style="display:flex;"><span>  innerSalt = CSRNG(32)
</span></span><span style="display:flex;"><span>  keys = HKDF(innerSalt, innerInput, &#34;ELS2_L2K&#34;, 44)
</span></span><span style="display:flex;"><span>  innerKey = keys[0:31]
</span></span><span style="display:flex;"><span>  innerIV = keys[32:43]
</span></span><span style="display:flex;"><span>  innerCiphertext = innerSalt || ENCRYPT(innerKey, innerIV, innerPlaintext)
</span></span></code></pre></div><h4 id="layer-2-decryption">Layer 2 decryption</h4>
<p>Когда авторизация клиента включена, <code>authCookie</code> вычисляется как описано ниже. Когда авторизация клиента отключена, <code>authCookie</code> является байтовым массивом нулевой длины.</p>
<p>Расшифровка выполняется аналогичным образом, как и для слоя 1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>innerInput = authCookie || subcredential || publishedTimestamp
</span></span><span style="display:flex;"><span>  innerSalt = innerCiphertext[0:31]
</span></span><span style="display:flex;"><span>  keys = HKDF(innerSalt, innerInput, &#34;ELS2_L2K&#34;, 44)
</span></span><span style="display:flex;"><span>  innerKey = keys[0:31]
</span></span><span style="display:flex;"><span>  innerIV = keys[32:43]
</span></span><span style="display:flex;"><span>  innerPlaintext = DECRYPT(innerKey, innerIV, innerCiphertext[32:end])
</span></span></code></pre></div><h3 id="зашифрованная-ls2">Зашифрованная LS2</h3>
<p>Когда авторизация клиентов включена для Destination, сервер поддерживает список клиентов, которым он разрешает расшифровывать зашифрованные данные LS2. Данные, хранящиеся для каждого клиента, зависят от механизма авторизации и включают в себя некую форму ключевого материала, который каждый клиент генерирует и отправляет серверу через безопасный внеполосный механизм.</p>
<p>Существует две альтернативы для реализации авторизации для каждого клиента:</p>
<h4 id="dh-client-authorization">DH client authorization</h4>
<p>Каждый клиент генерирует DH пару ключей <code>[csk_i, cpk_i]</code> и отправляет открытый ключ <code>cpk_i</code> на сервер.</p>
<p>Обработка на сервере
^^^^^^^^^^^^^^^^^</p>
<p>Сервер генерирует новый <code>authCookie</code> и эфемерную DH пару ключей:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>authCookie = CSRNG(32)
</span></span><span style="display:flex;"><span>  esk = GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>  epk = DERIVE_PUBLIC(esk)
</span></span></code></pre></div><p>Затем для каждого авторизованного клиента сервер шифрует <code>authCookie</code> его открытым ключом:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>sharedSecret = DH(esk, cpk_i)
</span></span><span style="display:flex;"><span>  authInput = sharedSecret || cpk_i || subcredential || publishedTimestamp
</span></span><span style="display:flex;"><span>  okm = HKDF(epk, authInput, &#34;ELS2_XCA&#34;, 52)
</span></span><span style="display:flex;"><span>  clientKey_i = okm[0:31]
</span></span><span style="display:flex;"><span>  clientIV_i = okm[32:43]
</span></span><span style="display:flex;"><span>  clientID_i = okm[44:51]
</span></span><span style="display:flex;"><span>  clientCookie_i = ENCRYPT(clientKey_i, clientIV_i, authCookie)
</span></span></code></pre></div><p>Сервер помещает каждый кортеж <code>[clientID_i, clientCookie_i]</code> в слой 1 зашифрованного LS2, вместе с <code>epk</code>.</p>
<p>Обработка клиента
^^^^^^^^^^^^^^^^^</p>
<p>Клиент использует свой закрытый ключ для получения ожидаемого идентификатора клиента <code>clientID_i</code>, ключа шифрования <code>clientKey_i</code> и вектора инициализации шифрования <code>clientIV_i</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>sharedSecret = DH(csk_i, epk)
</span></span><span style="display:flex;"><span>  authInput = sharedSecret || cpk_i || subcredential || publishedTimestamp
</span></span><span style="display:flex;"><span>  okm = HKDF(epk, authInput, &#34;ELS2_XCA&#34;, 52)
</span></span><span style="display:flex;"><span>  clientKey_i = okm[0:31]
</span></span><span style="display:flex;"><span>  clientIV_i = okm[32:43]
</span></span><span style="display:flex;"><span>  clientID_i = okm[44:51]
</span></span></code></pre></div><p>Затем клиент ищет в данных авторизации уровня 1 запись, содержащую <code>clientID_i</code>. Если соответствующая запись существует, клиент расшифровывает её для получения <code>authCookie</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>authCookie = DECRYPT(clientKey_i, clientIV_i, clientCookie_i)
</span></span></code></pre></div><h4 id="pre-shared-key-client-authorization">Pre-shared key client authorization</h4>
<p>Каждый клиент генерирует секретный 32-байтный ключ <code>psk_i</code> и отправляет его на сервер. Альтернативно, сервер может сгенерировать секретный ключ и отправить его одному или нескольким клиентам.</p>
<p>Обработка на сервере
^^^^^^^^^^^^^^^^^</p>
<p>Сервер генерирует новый <code>authCookie</code> и соль:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>authCookie = CSRNG(32)
</span></span><span style="display:flex;"><span>  authSalt = CSRNG(32)
</span></span></code></pre></div><p>Затем для каждого авторизованного клиента сервер шифрует <code>authCookie</code> своим заранее распределенным ключом:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>authInput = psk_i || subcredential || publishedTimestamp
</span></span><span style="display:flex;"><span>  okm = HKDF(authSalt, authInput, &#34;ELS2PSKA&#34;, 52)
</span></span><span style="display:flex;"><span>  clientKey_i = okm[0:31]
</span></span><span style="display:flex;"><span>  clientIV_i = okm[32:43]
</span></span><span style="display:flex;"><span>  clientID_i = okm[44:51]
</span></span><span style="display:flex;"><span>  clientCookie_i = ENCRYPT(clientKey_i, clientIV_i, authCookie)
</span></span></code></pre></div><p>Сервер помещает каждую пару <code>[clientID_i, clientCookie_i]</code> в слой 1 зашифрованного LS2 вместе с <code>authSalt</code>.</p>
<p>Обработка клиента
^^^^^^^^^^^^^^^^^</p>
<p>Клиент использует свой предварительно разделенный ключ для получения ожидаемого идентификатора клиента <code>clientID_i</code>, ключа шифрования <code>clientKey_i</code> и вектора инициализации шифрования <code>clientIV_i</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>authInput = psk_i || subcredential || publishedTimestamp
</span></span><span style="display:flex;"><span>  okm = HKDF(authSalt, authInput, &#34;ELS2PSKA&#34;, 52)
</span></span><span style="display:flex;"><span>  clientKey_i = okm[0:31]
</span></span><span style="display:flex;"><span>  clientIV_i = okm[32:43]
</span></span><span style="display:flex;"><span>  clientID_i = okm[44:51]
</span></span></code></pre></div><p>Затем клиент ищет в данных авторизации уровня 1 запись, которая содержит <code>clientID_i</code>. Если соответствующая запись существует, клиент расшифровывает её для получения <code>authCookie</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>authCookie = DECRYPT(clientKey_i, clientIV_i, clientCookie_i)
</span></span></code></pre></div><h4 id="security-considerations">Security considerations</h4>
<p>Оба механизма авторизации клиентов, описанные выше, обеспечивают приватность членства клиентов. Сущность, которая знает только Destination, может видеть, сколько клиентов подписано в любой момент времени, но не может отслеживать, какие клиенты добавляются или отзываются.</p>
<p>Серверы ДОЛЖНЫ рандомизировать порядок клиентов каждый раз при генерации зашифрованного LS2, чтобы предотвратить возможность клиентов узнать свою позицию в списке и делать выводы о том, когда другие клиенты были добавлены или исключены.</p>
<p>Сервер МОЖЕТ выбрать скрытие количества подписанных клиентов путем вставки случайных записей в список данных авторизации.</p>
<p>Преимущества авторизации клиента DH
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</p>
<ul>
<li>Безопасность схемы не зависит исключительно от внеполосного обмена ключевым   материалом клиента. Приватный ключ клиента никогда не должен покидать его устройство, и поэтому   противник, который способен перехватить внеполосный обмен, но не может взломать   алгоритм DH, не может расшифровать зашифрованный LS2 или определить, как долго клиенту предоставлен   доступ.</li>
</ul>
<p>Недостатки DH авторизации клиентов
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</p>
<ul>
<li>Требует N + 1 DH операций на стороне сервера для N клиентов.</li>
<li>Требует одну DH операцию на стороне клиента.</li>
<li>Требует от клиента генерации секретного ключа.</li>
</ul>
<p>Преимущества PSK авторизации клиента
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</p>
<ul>
<li>Не требует операций DH.</li>
<li>Позволяет серверу генерировать секретный ключ.</li>
<li>Позволяет серверу использовать один и тот же ключ для нескольких клиентов, если это необходимо.</li>
</ul>
<p>Недостатки авторизации клиентов PSK
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</p>
<ul>
<li>Безопасность схемы критически зависит от внеполосного обмена ключевым   материалом клиента. Противник, который перехватывает обмен для конкретного клиента, может расшифровать   любой последующий зашифрованный LS2, для которого этот клиент авторизован, а также определить,   когда доступ клиента отозван.</li>
</ul>
<h3 id="определения">Определения</h3>
<p>См. предложение 149.</p>
<p>Вы не можете использовать зашифрованный LS2 для bittorrent из-за компактных ответов announce, которые составляют 32 байта. Эти 32 байта содержат только хеш. В них нет места для указания того, что leaseSet зашифрован, или типов подписи.</p>
<h3 id="формат-3">Формат</h3>
<p>Для зашифрованных leaseSet с офлайн-ключами, слепые приватные ключи также должны генерироваться офлайн, по одному для каждого дня.</p>
<p>Поскольку необязательный блок оффлайн-подписи находится в открытой части зашифрованного leaseset, любой, кто сканирует floodfill-узлы, может использовать это для отслеживания leaseset (но не для его расшифровки) в течение нескольких дней. Чтобы предотвратить это, владелец ключей должен также генерировать новые временные ключи для каждого дня. Как временные, так и слепые ключи могут быть сгенерированы заранее и переданы в router пакетом.</p>
<p>В данном предложении не определен формат файла для упаковки множественных временных и скрытых ключей и их предоставления клиенту или router. В данном предложении не определено улучшение протокола I2CP для поддержки зашифрованных leaseSet с автономными ключами.</p>
<h3 id="notes-1">Notes</h3>
<ul>
<li>
<p>Сервис, использующий зашифрованные leaseSet&rsquo;ы, будет публиковать зашифрованную версию на
floodfill&rsquo;ы. Однако для эффективности он будет отправлять незашифрованные leaseSet&rsquo;ы
клиентам в обёрнутом garlic-сообщении после аутентификации (например, через whitelist).</p>
</li>
<li>
<p>Floodfill могут ограничивать максимальный размер до разумного значения для предотвращения злоупотреблений.</p>
</li>
<li>
<p>После расшифровки следует выполнить несколько проверок, включая соответствие
внутренней временной метки и срока действия тем, что указаны на верхнем уровне.</p>
</li>
<li>
<p>ChaCha20 был выбран вместо AES. Хотя скорости схожи при наличии аппаратной поддержки AES, ChaCha20 в 2,5-3 раза быстрее, когда аппаратная поддержка AES недоступна, например, на ARM-устройствах начального уровня.</p>
</li>
<li>
<p>Мы недостаточно заботимся о скорости, чтобы использовать keyed BLAKE2b. Он имеет
размер вывода, достаточно большой для размещения наибольшего n, который нам требуется (или мы можем вызвать его один раз для каждого
желаемого ключа с аргументом счётчика). BLAKE2b намного быстрее, чем SHA-256, и
keyed-BLAKE2b уменьшил бы общее количество вызовов хеш-функции.
Однако, см. предложение 148, где предлагается переключиться на BLAKE2b по другим причинам.
См. <a href="https://www.lvh.io/posts/secure-key-derivation-performance.html">Secure key derivation performance</a>
.</p>
</li>
</ul>
<h3 id="meta-ls2">Meta LS2</h3>
<p>Это используется для замены multihoming. Как и любой leaseset, он подписан создателем. Это аутентифицированный список хешей назначений.</p>
<p>Meta LS2 является вершиной и, возможно, промежуточными узлами древовидной структуры. Он содержит несколько записей, каждая из которых указывает на LS, LS2 или другой Meta LS2 для поддержки масштабного multihoming. Meta LS2 может содержать смешанные записи LS, LS2 и Meta LS2. Листьями дерева всегда являются LS или LS2. Дерево представляет собой DAG; циклы запрещены; клиенты, выполняющие поиск, должны обнаруживать циклы и отказываться от их прохождения.</p>
<p>Meta LS2 может иметь значительно более длительный срок действия, чем стандартный LS или LS2. Верхний уровень может иметь срок действия через несколько часов после даты публикации. Максимальное время истечения срока действия будет принудительно применяться floodfill-узлами и клиентами, и пока не определено.</p>
<p>Случай использования для Meta LS2 — это массовый мультихоминг, но без дополнительной защиты от корреляции роутеров с leaseSet&rsquo;ами (во время перезапуска роутера) по сравнению с той, что предоставляется сейчас с LS или LS2. Это эквивалентно случаю использования &ldquo;facebook&rdquo;, который, вероятно, не нуждается в защите от корреляции. Этот случай использования, вероятно, требует offline-ключей, которые предоставляются в стандартном заголовке на каждом узле дерева.</p>
<p>Протокол back-end для координации между leaf router&rsquo;ами, промежуточными и главными подписантами Meta LS здесь не определен. Требования крайне просты - просто проверить, что узел активен, и публиковать новый LS каждые несколько часов. Единственная сложность заключается в выборе новых издателей для Meta LSes верхнего или промежуточного уровня при сбое.</p>
<p>Комбинированные leaseSet-ы, где lease-ы от нескольких роутеров объединяются, подписываются и публикуются в одном leaseSet, описаны в предложении 140 &ldquo;невидимое мультихоминг&rdquo;. Это предложение в написанном виде неосуществимо, поскольку потоковые соединения не будут &ldquo;привязаны&rdquo; к одному роутеру, см. <a href="http://zzz.i">http://zzz.i</a>
2p/topics/2335 .</p>
<p>Протокол бэкенда и взаимодействие с внутренними компонентами router и клиента были бы довольно сложными для невидимого мультихоминга.</p>
<p>Чтобы избежать перегрузки floodfill для Meta LS верхнего уровня, срок истечения должен составлять как минимум несколько часов. Клиенты должны кэшировать Meta LS верхнего уровня и сохранять его при перезапусках, если он не истёк.</p>
<p>Нам нужно определить алгоритм для клиентов по обходу дерева, включая резервные варианты, чтобы использование было распределено. Некоторая функция расстояния хэша, стоимости и случайности. Если узел имеет как LS или LS2, так и Meta LS, нам нужно знать, когда разрешено использовать эти leaseSet&rsquo;ы, а когда продолжать обход дерева.</p>
<p>Поиск с помощью</p>
<pre><code>Standard LS flag (1)
</code></pre>
<p>Хранить с</p>
<pre><code>Meta LS2 type (7)
</code></pre>
<p>Хранить в</p>
<pre><code>Hash of destination
This hash is then used to generate the daily &quot;routing key&quot;, as in LS1
</code></pre>
<p>Типичное истечение срока</p>
<pre><code>Hours. Max 18.2 hours (65535 seconds)
</code></pre>
<p>Опубликовано</p>
<pre><code>&quot;master&quot; Destination or coordinator, or intermediate coordinators
</code></pre>
<h3 id="format">Format</h3>
<pre tabindex="0"><code>Standard LS2 Header as specified above

  Meta LS2 Type-Specific Part
  - Properties (Mapping as specified in common structures spec, 2 zero bytes if none)
  - Number of entries (1 byte) Maximum TBD
  - Entries. Each entry contains: (40 bytes)
    - Hash (32 bytes)
    - Flags (2 bytes)
      TBD. Set all to zero for compatibility with future uses.
    - Type (1 byte) The type of LS it is referencing;
      1 for LS, 3 for LS2, 5 for encrypted, 7 for meta, 0 for unknown.
    - Cost (priority) (1 byte)
    - Expires (4 bytes) (4 bytes, big endian, seconds since epoch, rolls over in 2106)
  - Number of revocations (1 byte) Maximum TBD
  - Revocations: Each revocation contains: (32 bytes)
    - Hash (32 bytes)

  Standard LS2 Signature:
  - Signature (40+ bytes)
    The signature is of everything above.
</code></pre><p>Флаги и свойства: для будущего использования</p>
<h3 id="вывод-ключа-ослепления">Вывод ключа ослепления</h3>
<ul>
<li>
<p>Распределенная служба, использующая это, будет иметь одного или нескольких &ldquo;мастеров&rdquo; с приватным ключом destination службы. Они будут (вне полосы) определять текущий список активных destination и публиковать Meta LS2. Для избыточности несколько мастеров могут использовать multihome (т.е. одновременно публиковать) Meta LS2.</p>
</li>
<li>
<p>Распределённый сервис может начать с одного destination или использовать multihoming старого стиля, затем перейти на Meta LS2. Стандартный LS lookup может вернуть любой из LS, LS2 или Meta LS2.</p>
</li>
<li>
<p>Когда сервис использует Meta LS2, у него нет туннелей (leases).</p>
</li>
</ul>
<h3 id="service-record">Service Record</h3>
<p>Это индивидуальная запись, указывающая, что пункт назначения участвует в сервисе. Она отправляется от участника к floodfill. Она никогда не отправляется индивидуально floodfill-узлом, а только как часть Списка Сервисов. Запись Сервиса также используется для отзыва участия в сервисе путем установки срока истечения в ноль.</p>
<p>Это не LS2, но используется стандартный формат заголовка и подписи LS2.</p>
<p>Поиск с помощью</p>
<pre><code>n/a, see Service List
</code></pre>
<p>Хранить с</p>
<pre><code>Service Record type (9)
</code></pre>
<p>Сохранить в</p>
<pre><code>Hash of service name
This hash is then used to generate the daily &quot;routing key&quot;, as in LS1
</code></pre>
<p>Типичный срок действия</p>
<pre><code>Hours. Max 18.2 hours (65535 seconds)
</code></pre>
<p>Опубликовано</p>
<pre><code>Destination
</code></pre>
<h3 id="format-1">Format</h3>
<pre tabindex="0"><code>Standard LS2 Header as specified above

  Service Record Type-Specific Part
  - Port (2 bytes, big endian) (0 if unspecified)
  - Hash of service name (32 bytes)

  Standard LS2 Signature:
  - Signature (40+ bytes)
    The signature is of everything above.
</code></pre><h3 id="notes-2">Notes</h3>
<ul>
<li>
<p>Если expires содержит только нули, floodfill должен отозвать запись и больше не включать её в список сервисов.</p>
</li>
<li>
<p>Хранение: Floodfill может строго ограничивать хранение этих записей и
лимитировать количество записей, хранимых на один хеш, и время их истечения. Также может
использоваться белый список хешей.</p>
</li>
<li>
<p>Любой другой тип netdb с тем же хешем имеет приоритет, поэтому служебная запись никогда не может перезаписать LS/RI, но LS/RI перезапишет все служебные записи с этим хешем.</p>
</li>
</ul>
<h3 id="service-list">Service List</h3>
<p>Это совершенно не похоже на LS2 и использует другой формат.</p>
<p>Список сервисов создается и подписывается floodfill. Он не аутентифицирован в том смысле, что любой может присоединиться к сервису, опубликовав Service Record на floodfill.</p>
<p>Список Сервисов содержит Краткие Записи Сервисов, а не полные Записи Сервисов. Они содержат подписи, но только хеши, а не полные назначения, поэтому они не могут быть проверены без полного назначения.</p>
<p>Безопасность, если таковая имеется, и целесообразность списков сервисов остается неопределенной (TBD). Floodfill-узлы могли бы ограничить публикацию и поиск белым списком сервисов, но такой белый список может различаться в зависимости от реализации или предпочтений оператора. Возможно, не удастся достичь консенсуса относительно общего базового белого списка между различными реализациями.</p>
<p>Если имя сервиса включено в служебную запись выше, то операторы floodfill могут возразить; если включен только хеш, то проверки нет, и служебная запись может &ldquo;попасть&rdquo; раньше любого другого типа netdb и сохраниться в floodfill.</p>
<p>Поиск с помощью</p>
<pre><code>Service List lookup type (11)
</code></pre>
<p>Сохранить с</p>
<pre><code>Service List type (11)
</code></pre>
<p>Хранить в</p>
<pre><code>Hash of service name
This hash is then used to generate the daily &quot;routing key&quot;, as in LS1
</code></pre>
<p>Типичное истечение срока действия</p>
<pre><code>Hours, not specified in the list itself, up to local policy
</code></pre>
<p>Опубликовано</p>
<pre><code>Nobody, never sent to floodfill, never flooded.
</code></pre>
<h3 id="format-2">Format</h3>
<p>НЕ использует стандартный заголовок LS2, указанный выше.</p>
<pre tabindex="0"><code>- Type (1 byte)
    Not actually in header, but part of data covered by signature.
    Take from field in Database Store Message.
  - Hash of the service name (implicit, in the Database Store message)
  - Hash of the Creator (floodfill) (32 bytes)
  - Published timestamp (8 bytes, big endian)

  - Number of Short Service Records (1 byte)
  - List of Short Service Records:
    Each Short Service Record contains (90+ bytes)
    - Dest hash (32 bytes)
    - Published timestamp (8 bytes, big endian)
    - Expires (4 bytes, big endian) (offset from published in ms)
    - Flags (2 bytes)
    - Port (2 bytes, big endian)
    - Sig length (2 bytes, big endian)
    - Signature of dest (40+ bytes)

  - Number of Revocation Records (1 byte)
  - List of Revocation Records:
    Each Revocation Record contains (86+ bytes)
    - Dest hash (32 bytes)
    - Published timestamp (8 bytes, big endian)
    - Flags (2 bytes)
    - Port (2 bytes, big endian)
    - Sig length (2 bytes, big endian)
    - Signature of dest (40+ bytes)

  - Signature of floodfill (40+ bytes)
    The signature is of everything above.
</code></pre><p>Для проверки подписи Списка Сервисов:</p>
<ul>
<li>добавить в начало хеш имени сервиса</li>
<li>удалить хеш создателя</li>
<li>Проверить подпись измененного содержимого</li>
</ul>
<p>Для проверки подписи каждой записи Short Service Record:</p>
<ul>
<li>Получить назначение</li>
<li>Проверить подпись (опубликованная временная метка + истекает + флаги + порт + хеш имени сервиса)</li>
</ul>
<p>Для проверки подписи каждой записи отзыва:</p>
<ul>
<li>Получить место назначения</li>
<li>Проверить подпись (опубликованная временная метка + 4 нулевых байта + флаги + порт + хеш
имени сервиса)</li>
</ul>
<h3 id="notes-3">Notes</h3>
<ul>
<li>
<p>Мы используем длину подписи вместо типа подписи, чтобы поддерживать неизвестные типы подписей.</p>
</li>
<li>
<p>Список сервисов не имеет срока истечения, получатели могут принимать собственные
решения на основе политики или истечения срока действия отдельных записей.</p>
</li>
<li>
<p>Списки Сервисов не распространяются по всей сети, только отдельные Записи Сервисов. Каждый floodfill создает, подписывает и кэширует Список Сервисов. floodfill использует свою собственную политику для времени кэширования и максимального количества записей сервисов и отзыва.</p>
</li>
</ul>
<h2 id="common-structures-spec-changes-required">Common Structures Spec Changes Required</h2>
<h3 id="шифрование-и-обработка">Шифрование и обработка</h3>
<p>Выходит за рамки данного предложения. Добавить к предложениям ECIES 144 и 145.</p>
<h3 id="new-intermediate-structures">New Intermediate Structures</h3>
<p>Добавить новые структуры для Lease2, MetaLease, LeaseSet2Header и OfflineSignature. Действует начиная с релиза 0.9.38.</p>
<h3 id="new-netdb-types">New NetDB Types</h3>
<p>Добавьте структуры для каждого нового типа leaseset, включенные выше. Для LeaseSet2, EncryptedLeaseSet и MetaLeaseSet действует с версии 0.9.38. Для Service Record и Service List - предварительные и незапланированные.</p>
<h3 id="new-signature-type">New Signature Type</h3>
<p>Добавить RedDSA_SHA512_Ed25519 тип 11. Открытый ключ — 32 байта; закрытый ключ — 32 байта; хеш — 64 байта; подпись — 64 байта.</p>
<h2 id="encryption-spec-changes-required">Encryption Spec Changes Required</h2>
<p>Выходит за рамки данного предложения. См. предложения 144 и 145.</p>
<h2 id="i2np-changes-required">I2NP Changes Required</h2>
<p>Добавить примечание: LS2 может публиковаться только на floodfill с минимальной версией.</p>
<h3 id="database-lookup-message">Database Lookup Message</h3>
<p>Добавьте тип поиска списка сервисов.</p>
<h3 id="changes">Changes</h3>
<pre tabindex="0"><code>Flags byte: Lookup type field, currently bits 3-2, expands to bits 4-2.
  Lookup type 0x04 is defined as the service list lookup.

  Add note: Service list loookup may only be sent to floodfills with a minimum version.
  Minimum version is 0.9.38.
</code></pre><h3 id="авторизация-для-каждого-клиента">Авторизация для каждого клиента</h3>
<p>Добавить все новые типы хранилищ.</p>
<h3 id="changes-1">Changes</h3>
<pre tabindex="0"><code>Type byte: Type field, currently bit 0, expands to bits 3-0.
  Type 3 is defined as a LS2 store.
  Type 5 is defined as a encrypted LS2 store.
  Type 7 is defined as a meta LS2 store.
  Type 9 is defined as a service record store.
  Type 11 is defined as a service list store.
  Other types are undefined and invalid.

  Add note: All new types may only be published to floodfills with a minimum version.
  Minimum version is 0.9.38.
</code></pre><h2 id="i2cp-changes-required">I2CP Changes Required</h2>
<h3 id="i2cp-options">I2CP Options</h3>
<p>Новые опции, интерпретируемые на стороне роутера, отправляемые в SessionConfig Mapping:</p>
<pre tabindex="0"><code>
  i2cp.leaseSetType=nnn       The type of leaseset to be sent in the Create Leaseset Message
                              Value is the same as the netdb store type in the table above.
                              Interpreted client-side, but also passed to the router in the
                              SessionConfig, to declare intent and check support.

  i2cp.leaseSetEncType=nnn[,nnn]  The encryption types to be used.
                                  Interpreted client-side, but also passed to the router in
                                  the SessionConfig, to declare intent and check support.
                                  See proposals 144 and 145.

  i2cp.leaseSetOfflineExpiration=nnn  The expiration of the offline signature, ASCII,
                                      seconds since the epoch.

  i2cp.leaseSetTransientPublicKey=[type:]b64  The base 64 of the transient private key,
                                              prefixed by an optional sig type number
                                              or name, default DSA_SHA1.
                                              Length as inferred from the sig type

  i2cp.leaseSetOfflineSignature=b64   The base 64 of the offline signature.
                                      Length as inferred from the destination
                                      signing public key type

  i2cp.leaseSetSecret=b64     The base 64 of a secret used to blind the
                              address of the leaseset, default &#34;&#34;

  i2cp.leaseSetAuthType=nnn   The type of authentication for encrypted LS2.
                              0 for no per-client authentication (the default)
                              1 for DH per-client authentication
                              2 for PSK per-client authentication

  i2cp.leaseSetPrivKey=b64    A base 64 private key for the router to use to
                              decrypt the encrypted LS2,
                              only if per-client authentication is enabled
</code></pre><p>Новые опции, интерпретируемые на стороне клиента:</p>
<pre tabindex="0"><code>
  i2cp.leaseSetType=nnn     The type of leaseset to be sent in the Create Leaseset Message
                            Value is the same as the netdb store type in the table above.
                            Interpreted client-side, but also passed to the router in the
                            SessionConfig, to declare intent and check support.

  i2cp.leaseSetEncType=nnn[,nnn]  The encryption types to be used.
                                  Interpreted client-side, but also passed to the router in
                                  the SessionConfig, to declare intent and check support.
                                  See proposals 144 and 145.

  i2cp.leaseSetSecret=b64     The base 64 of a secret used to blind the
                              address of the leaseset, default &#34;&#34;

  i2cp.leaseSetAuthType=nnn       The type of authentication for encrypted LS2.
                                  0 for no per-client authentication (the default)
                                  1 for DH per-client authentication
                                  2 for PSK per-client authentication

  i2cp.leaseSetBlindedType=nnn   The sig type of the blinded key for encrypted LS2.
                                 Default depends on the destination sig type.

  i2cp.leaseSetClient.dh.nnn=b64name:b64pubkey   The base 64 of the client name (ignored, UI use only),
                                                 followed by a &#39;:&#39;, followed by the base 64 of the public
                                                 key to use for DH per-client auth. nnn starts with 0

  i2cp.leaseSetClient.psk.nnn=b64name:b64privkey   The base 64 of the client name (ignored, UI use only),
                                                   followed by a &#39;:&#39;, followed by the base 64 of the private
                                                   key to use for PSK per-client auth. nnn starts with 0
</code></pre><h3 id="session-config">Session Config</h3>
<p>Обратите внимание, что для оффлайн подписей требуются опции i2cp.leaseSetOfflineExpiration, i2cp.leaseSetTransientPublicKey и i2cp.leaseSetOfflineSignature, и подпись выполняется временным приватным ключом подписи.</p>
<h3 id="зашифрованные-ls-с-адресами-base-32">Зашифрованные LS с адресами Base 32</h3>
<p>От router к клиенту. Без изменений. Аренды отправляются с 8-байтовыми временными метками, даже если возвращаемый leaseSet будет LS2 с 4-байтовыми временными метками. Обратите внимание, что ответ может быть сообщением Create Leaseset или Create Leaseset2.</p>
<h3 id="зашифрованный-ls-с-офлайн-ключами">Зашифрованный LS с офлайн ключами</h3>
<p>Router к клиенту. Без изменений. Leases отправляются с 8-байтными временными метками, даже если возвращаемый leaseset будет LS2 с 4-байтными временными метками. Обратите внимание, что ответ может быть сообщением Create Leaseset или Create Leaseset2.</p>
<h3 id="примечания-3">Примечания</h3>
<p>Клиент к роутеру. Новое сообщение, используемое вместо сообщения Create Leaseset Message.</p>
<h3 id="meta-ls2-1">Meta LS2</h3>
<ul>
<li>
<p>Чтобы router мог распознать тип хранилища, тип должен быть включен в сообщение,
если только он не был передан router&rsquo;у заранее в конфигурации сессии.
Для общего кода парсинга проще иметь его в самом сообщении.</p>
</li>
<li>
<p>Чтобы router знал тип и длину приватного ключа,
он должен идти после lease set, если только парсер не знает тип заранее
в конфигурации сессии.
Для общего кода парсинга проще узнать это из самого сообщения.</p>
</li>
<li>
<p>Закрытый ключ для подписи, ранее определенный для отзыва и неиспользуемый,
отсутствует в LS2.</p>
</li>
</ul>
<h3 id="формат-4">Формат</h3>
<p>Тип сообщения для сообщения Create Leaseset2 Message равен 41.</p>
<h3 id="примечания-4">Примечания</h3>
<pre tabindex="0"><code>Session ID
  Type byte: Type of lease set to follow
             Type 1 is a LS
             Type 3 is a LS2
             Type 5 is a encrypted LS2
             Type 7 is a meta LS2
  LeaseSet: type specified above
  Number of private keys to follow (1 byte)
  Encryption Private Keys: For each public key in the lease set,
                           in the same order
                           (Not present for Meta LS2)
                           - Encryption type (2 bytes, big endian)
                           - Encryption key length (2 bytes, big endian)
                           - Encryption key (number of bytes specified)
</code></pre><h3 id="запись-службы">Запись службы</h3>
<ul>
<li>Минимальная версия маршрутизатора — 0.9.39.</li>
<li>Предварительная версия с типом сообщения 40 была в версии 0.9.38, но формат был изменен.
Тип 40 заброшен и не поддерживается.</li>
</ul>
<h3 id="формат-5">Формат</h3>
<ul>
<li>Необходимы дополнительные изменения для поддержки зашифрованных и мета LS.</li>
</ul>
<h3 id="примечания-5">Примечания</h3>
<p>Клиент к роутеру. Новое сообщение.</p>
<h3 id="список-сервисов">Список сервисов</h3>
<ul>
<li>
<p>Роутер должен знать, является ли назначение blinded.
Если оно является blinded и использует секретную или per-client аутентификацию,
ему также необходимо иметь эту информацию.</p>
</li>
<li>
<p>Host Lookup нового формата b32-адреса (&ldquo;b33&rdquo;)
сообщает роутеру, что адрес является скрытым (blinded), но не существует механизма
для передачи секретного или приватного ключа роутеру в сообщении Host Lookup.
Хотя мы могли бы расширить сообщение Host Lookup для добавления этой информации,
более правильным решением будет определить новое сообщение.</p>
</li>
<li>
<p>Нам нужен программный способ для клиента сообщить router&rsquo;у.
В противном случае пользователю пришлось бы вручную настраивать каждое назначение.</p>
</li>
</ul>
<h3 id="формат-6">Формат</h3>
<p>Прежде чем клиент отправит сообщение в blinded destination, он должен либо найти &ldquo;b33&rdquo; в сообщении Host Lookup, либо отправить сообщение Blinding Info. Если blinded destination требует секрета или аутентификации для каждого клиента, клиент должен отправить сообщение Blinding Info.</p>
<p>Роутер не отправляет ответ на это сообщение.</p>
<h3 id="примечания-6">Примечания</h3>
<p>Тип сообщения для Blinding Info Message равен 42.</p>
<h3 id="format-3">Format</h3>
<pre tabindex="0"><code>Session ID
  Flags:       1 byte
               Bit order: 76543210
               Bit 0: 0 for everybody, 1 for per-client
               Bits 3-1: Authentication scheme, if bit 0 is set to 1 for per-client, otherwise 000
                         000: DH client authentication (or no per-client authentication)
                         001: PSK client authentication
               Bit 4: 1 if secret required, 0 if no secret required
               Bits 7-5: Unused, set to 0 for future compatibility
  Type byte:   Endpoint type to follow
               Type 0 is a Hash
               Type 1 is a host name String
               Type 2 is a Destination
               Type 3 is a Sig Type and Signing Public Key
  Blind Type:  2 byte blinded sig type (big endian)
  Expiration:  4 bytes, big endian, seconds since epoch
  Endpoint:    Data as specified above
               For type 0: 32 byte binary hash
               For type 1: host name String
               For type 2: binary Destination
               For type 3: 2 byte sig type (big endian)
                           Signing Public Key (length as implied by sig type)
  Private Key: Only if flag bit 0 is set to 1
               A 32-byte ECIES_X25519 private key
  Secret:      Only if flag bit 4 is set to 1
               A secret String
</code></pre><h3 id="ключевые-сертификаты">Ключевые сертификаты</h3>
<ul>
<li>Минимальная версия маршрутизатора router 0.9.43</li>
</ul>
<h3 id="новые-промежуточные-структуры">Новые промежуточные структуры</h3>
<h3 id="новые-типы-netdb">Новые типы NetDB</h3>
<p>Чтобы поддерживать поиск имён хостов &ldquo;b33&rdquo; и возвращать индикацию, если router не имеет необходимой информации, мы определяем дополнительные коды результатов для Host Reply Message следующим образом:</p>
<pre tabindex="0"><code>2: Lookup password required
   3: Private key required
   4: Lookup password and private key required
   5: Leaseset decryption failure
</code></pre><p>Значения 1-255 уже определены как ошибки, поэтому проблем с обратной совместимостью нет.</p>
<h3 id="новый-тип-подписи">Новый тип подписи</h3>
<p>Маршрутизатор к клиенту. Новое сообщение.</p>
<h3 id="justification-1">Justification</h3>
<p>Клиент не знает a priori, что данный хеш будет разрешен в Meta LS.</p>
<p>Если поиск leaseset для Destination возвращает Meta LS, router выполнит рекурсивное разрешение. Для датаграмм клиентская сторона не должна знать об этом; однако для потоковой передачи, где протокол проверяет назначение в SYN ACK, он должен знать, что является &ldquo;реальным&rdquo; назначением. Поэтому нам нужно новое сообщение.</p>
<h3 id="usage">Usage</h3>
<p>Router поддерживает кеш для фактического пункта назначения, который используется из мета-LS. Когда клиент отправляет сообщение на пункт назначения, который разрешается в мета-LS, router проверяет кеш для последнего используемого фактического пункта назначения. Если кеш пуст, router выбирает пункт назначения из мета-LS и ищет leaseSet. Если поиск leaseSet успешен, router добавляет этот пункт назначения в кеш и отправляет клиенту Meta Redirect Message. Это делается только один раз, если только пункт назначения не истекает и не должен быть изменен. Клиент также должен кешировать информацию при необходимости. Meta Redirect Message НЕ отправляется в ответ на каждое SendMessage.</p>
<p>Роутер отправляет это сообщение только клиентам с версией 0.9.47 или выше.</p>
<p>Клиент не отправляет ответ на это сообщение.</p>
<h3 id="сообщение-запроса-базы-данных">Сообщение запроса базы данных</h3>
<p>Тип сообщения для Meta Redirect Message равен 43.</p>
<h3 id="изменения">Изменения</h3>
<pre tabindex="0"><code>Session ID (2 bytes) The value from the Send Message.
  Message ID generated by the router (4 bytes)
  4 byte nonce previously generated by the client
               (the value from the Send Message, may be zero)
  Flags:       2 bytes, bit order 15...0
               Unused, set to 0 for future compatibility
               Bit 0: 0 - the destination is no longer meta
                      1 - the destination is now meta
               Bits 15-1: Unused, set to 0 for future compatibility
  Original Destination (387+ bytes)
  (following fields only present if flags bit 0 is 1)
  MFlags:      2 bytes
               Unused, set to 0 for future compatibility
               From the Meta Lease for the actual Destination
  Expiration:  4 bytes, big endian, seconds since epoch
               From the Meta Lease for the actual Destination
  Cost (priority) 1 byte
               From the Meta Lease for the actual Destination
  Actual (real) Destination (387+ bytes)
</code></pre><h3 id="сообщение-хранилища-базы-данных">Сообщение хранилища базы данных</h3>
<p>Как генерировать и поддерживать Meta, включая межроутерную коммуникацию и координацию, выходит за рамки данного предложения. См. связанное предложение 150.</p>
<h3 id="изменения-1">Изменения</h3>
<p>Офлайн подписи не могут быть проверены в потоковых или отвечаемых датаграммах. См. разделы ниже.</p>
<h2 id="private-key-file-changes-required">Private Key File Changes Required</h2>
<p>Формат файла приватного ключа (eepPriv.dat) не является официальной частью наших спецификаций, но он документирован в <a href="http://idk.i2p/javadoc-i2p/net/i2p/data/PrivateKeyFile.html">Java I2P javadocs</a>
 и другие реализации его поддерживают. Это обеспечивает переносимость приватных ключей между различными реализациями.</p>
<p>Необходимы изменения для хранения временного публичного ключа и информации об автономной подписи.</p>
<h3 id="changes-2">Changes</h3>
<pre tabindex="0"><code>If the signing private key is all zeros, the offline information section follows:

  - Expires timestamp
    (4 bytes, big endian, seconds since epoch, rolls over in 2106)
  - Sig type of transient Signing Public Key (2 bytes, big endian)
  - Transient Signing Public key
    (length as specified by transient sig type)
  - Signature of above three fields by offline key
    (length as specified by destination sig type)
  - Transient Signing Private key
    (length as specified by transient sig type)
</code></pre><h3 id="опции-i2cp">Опции I2CP</h3>
<p>Добавить поддержку следующих опций:</p>
<pre tabindex="0"><code>-d days              (specify expiration in days of offline sig, default 365)
      -o offlinedestfile   (generate the online key file,
                            using the offline key file specified)
      -r sigtype           (specify sig type of transient key, default Ed25519)
</code></pre><h2 id="streaming-changes-required">Streaming Changes Required</h2>
<p>Оффлайн подписи в настоящее время не могут быть проверены в streaming. Изменение ниже добавляет блок оффлайн подписи в опции. Это позволяет избежать необходимости получения этой информации через I2CP.</p>
<h3 id="конфигурация-сессии">Конфигурация сессии</h3>
<pre tabindex="0"><code>Add new option:
  Bit:          11
  Flag:         OFFLINE_SIGNATURE
  Option order: 4
  Option data:  Variable bytes
  Function:     Contains the offline signature section from LS2.
                FROM_INCLUDED must also be set.
                Expires timestamp
                (4 bytes, big endian, seconds since epoch, rolls over in 2106)
                Transient sig type (2 bytes, big endian)
                Transient signing public key (length as implied by sig type)
                Signature of expires timestamp, transient sig type,
                and public key, by the destination public key,
                length as implied by destination public key sig type.

  Change option:
  Bit:          3
  Flag:         SIGNATURE_INCLUDED
  Option order: Change from 4 to 5

  Add information about transient keys to the
  Variable Length Signature Notes section:
  The offline signature option does not needed to be added for a CLOSE packet if
  a SYN packet containing the option was previously acked.
  More info TODO
</code></pre><h3 id="сообщение-запроса-leaseset">Сообщение запроса LeaseSet</h3>
<ul>
<li>Альтернативой является просто добавить флаг и получить транзитный публичный ключ через I2CP
(См. разделы Host Lookup / Host Reply Message выше)</li>
</ul>
<h2 id="стандартный-заголовок-ls2">Стандартный заголовок LS2</h2>
<p>Автономные подписи не могут быть проверены при обработке датаграмм с возможностью ответа. Необходим флаг для указания автономной подписи, но нет места для размещения флага. Потребуется совершенно новый номер протокола и формат.</p>
<h3 id="сообщение-запроса-переменного-leaseset">Сообщение запроса переменного LeaseSet</h3>
<pre tabindex="0"><code>Define new protocol 19 - Repliable datagram with options?
  - Destination (387+ bytes)
  - Flags (2 bytes)
    Bit order: 15 14 ... 3 2 1 0
    Bit 0: If 0, no offline keys; if 1, offline keys
    Bits 1-15: set to 0 for compatibility with future uses
  - If flag indicates offline keys, the offline signature section:
    Expires timestamp
    (4 bytes, big endian, seconds since epoch, rolls over in 2106)
    Transient sig type (2 bytes, big endian)
    Transient signing public key (length as implied by sig type)
    Signature of expires timestamp, transient sig type,
    and public key, by the destination public key,
    length as implied by destination public key sig type.
    This section can, and should, be generated offline.
  - Data
</code></pre><h3 id="создать-сообщение-leaseset2">Создать сообщение Leaseset2</h3>
<ul>
<li>Альтернативный вариант — просто добавить флаг и получить временный публичный ключ через I2CP
(См. разделы Host Lookup / Host Reply Message выше)</li>
<li>Какие-либо другие опции, которые мы должны добавить сейчас, когда у нас есть байты флагов?</li>
</ul>
<h2 id="sam-v3-changes-required">SAM V3 Changes Required</h2>
<p>SAM должен быть улучшен для поддержки офлайн подписей в DESTINATION base 64.</p>
<h3 id="обоснование-3">Обоснование</h3>
<pre tabindex="0"><code>Note that in the SESSION CREATE DESTINATION=$privkey,
  the $privkey raw data (before base64 conversion)
  may be optionally followed by the Offline Signature as specified in the
  Common Structures Specification.

  If the signing private key is all zeros, the offline information section follows:

  - Expires timestamp
    (4 bytes, big endian, seconds since epoch, rolls over in 2106)
  - Sig type of transient Signing Public Key (2 bytes, big endian)
  - Transient Signing Public key
    (length as specified by transient sig type)
  - Signature of above three fields by offline key
    (length as specified by destination sig type)
  - Transient Signing Private key (length as specified by transient sig type)
</code></pre><p>Обратите внимание, что оффлайн-подписи поддерживаются только для STREAM и RAW, но не для DATAGRAM (пока мы не определим новый протокол DATAGRAM).</p>
<p>Обратите внимание, что SESSION STATUS будет возвращать приватный ключ подписи из всех нулей и данные оффлайн-подписи точно в том виде, в каком они были предоставлены в SESSION CREATE.</p>
<p>Обратите внимание, что DEST GENERATE и SESSION CREATE DESTINATION=TRANSIENT нельзя использовать для создания offline подписанного назначения.</p>
<h3 id="тип-сообщения">Тип сообщения</h3>
<p>Повысить версию до 3.4, или оставить её на 3.1/3.2/3.3, чтобы её можно было добавить без необходимости всех компонентов 3.2/3.3?</p>
<p>Другие изменения уточняются. См. раздел I2CP Host Reply Message выше.</p>
<h2 id="bob-changes-required">BOB Changes Required</h2>
<p>BOB должен был бы быть улучшен для поддержки оффлайн подписей и/или Meta LS. Это низкий приоритет и, вероятно, никогда не будет специфицировано или реализовано. SAM V3 является предпочтительным интерфейсом.</p>
<h2 id="publishing-migration-compatibility">Publishing, Migration, Compatibility</h2>
<p>LS2 (кроме зашифрованной LS2) публикуется в том же DHT-расположении, что и LS1. Нет способа опубликовать одновременно LS1 и LS2, если только LS2 не будет находиться в другом расположении.</p>
<p>Зашифрованный LS2 публикуется по хешу типа замаскированного ключа и данных ключа. Этот хеш затем используется для генерации ежедневного &ldquo;routing key&rdquo;, как в LS1.</p>
<p>LS2 будет использоваться только когда требуются новые функции (новая криптография, зашифрованный LS, мета и т.д.). LS2 может публиковаться только на floodfill указанной версии или выше.</p>
<p>Серверы, публикующие LS2, будут знать, что любые подключающиеся клиенты поддерживают LS2. Они могут отправлять LS2 в garlic.</p>
<p>Клиенты отправляли бы LS2 в garlic только при использовании новой криптографии. Общие клиенты использовали бы LS1 бесконечно? TODO: Как иметь общих клиентов, которые поддерживают и старую, и новую криптографию?</p>
<h2 id="rollout">Rollout</h2>
<p>0.9.38 содержит поддержку floodfill для стандартных LS2, включая оффлайн ключи.</p>
<p>0.9.39 содержит поддержку I2CP для LS2 и Encrypted LS2, подписание/верификацию типа подписи 11, поддержку floodfill для Encrypted LS2 (типы подписей 7 и 11, без офлайн ключей), а также шифрование/дешифрование LS2 (без авторизации для отдельных клиентов).</p>
<p>0.9.40 планируется включить поддержку шифрования/расшифровки LS2 с авторизацией для каждого клиента, поддержку floodfill и I2CP для Meta LS2, поддержку зашифрованных LS2 с оффлайн-ключами и поддержку b32 для зашифрованных LS2.</p>
<h2 id="новые-типы-databaseentry">Новые типы DatabaseEntry</h2>
<p>Дизайн зашифрованного LS2 во многом основан на <a href="https://spec.torproject.org/rend-spec-v3">дескрипторах скрытых сервисов v3 Tor</a>
, которые имели схожие цели проектирования.</p>

                </article>

                
                <nav class="page-nav">
                    <a href="../../../ru/proposals/" class="page-nav-link">
                        ← Back to Proposals
                    </a>
                    
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                    <a href="../../../proposals/123-new-netdb-entries.txt" class="page-nav-link" download>
                        Download Source (.txt)
                    </a>
                    
                </nav>
            </div>
        </div>
    </div>
</div>

<style>
.proposals-page {
    min-height: 100vh;
    padding: var(--spacing-xl) 0;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
}

.breadcrumbs a:hover {
    color: var(--color-primary);
}

.separator {
    color: var(--color-border);
}

.current {
    color: var(--color-text);
}

 
.translation-disclaimer {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.dark .translation-disclaimer {
    background: #78350f;
    border-color: #d97706;
}

.disclaimer-message {
    color: #92400e;
    font-size: 0.875rem;
}

.dark .disclaimer-message {
    color: #fde047;
}

.disclaimer-link {
    color: #92400e;
    font-weight: 600;
    text-decoration: underline;
    white-space: nowrap;
}

.dark .disclaimer-link {
    color: #fde047;
}

 
.proposal-header {
    margin-bottom: var(--spacing-2xl);
}

.proposal-title-section {
    margin-bottom: var(--spacing-lg);
}

.proposal-title {
    font-size: 2.5rem;
    margin: 0 0 var(--spacing-sm) 0;
    color: var(--color-text);
}

.proposal-number {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    font-weight: 600;
}

 
.proposal-meta-box {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
}

.proposal-status {
    display: inline-block;
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: var(--spacing-md);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

 
.status-open {
    background: #dbeafe;
    color: #0369a1;
}

.dark .status-open {
    background: #0c4a6e;
    color: #7dd3fc;
}

.status-accepted {
    background: #dbeafe;
    color: #0369a1;
}

.dark .status-accepted {
    background: #0c4a6e;
    color: #7dd3fc;
}

.status-finished {
    background: #dcfce7;
    color: #15803d;
}

.dark .status-finished {
    background: #164e63;
    color: #86efac;
}

.status-closed {
    background: #dcfce7;
    color: #15803d;
}

.dark .status-closed {
    background: #164e63;
    color: #86efac;
}

.status-rejected {
    background: #fee2e2;
    color: #991b1b;
}

.dark .status-rejected {
    background: #7f1d1d;
    color: #fca5a5;
}

.status-draft,
.status-needs-revision,
.status-dead,
.status-needs-research {
    background: #fef3c7;
    color: #92400e;
}

.dark .status-draft,
.dark .status-needs-revision,
.dark .status-dead,
.dark .status-needs-research {
    background: #78350f;
    color: #fde047;
}

.status-meta,
.status-informational,
.status-reserve {
    background: #e9d5ff;
    color: #6b21a8;
}

.dark .status-meta,
.dark .status-informational,
.dark .status-reserve {
    background: #581c87;
    color: #e879f9;
}

 
.proposal-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.info-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
}

.info-value {
    font-size: 0.9375rem;
    color: var(--color-text);
    font-weight: 500;
}

 
.proposal-relationships {
    border-top: 1px solid var(--color-border);
    padding-top: var(--spacing-md);
}

.relationship {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
}

.relationship:last-child {
    margin-bottom: 0;
}

.relationship-label {
    font-weight: 600;
    color: var(--color-text-muted);
    min-width: 120px;
}

.relationship-value {
    color: var(--color-text);
}

 
.proposal-layout {
    display: block;
}

.proposal-layout--with-toc {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

 
.proposal-toc-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.toc-nav {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
}

.toc-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-text);
    padding-bottom: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.toc-content {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
}

.toc-content::-webkit-scrollbar {
    width: 4px;
}

.toc-content::-webkit-scrollbar-track {
    background: transparent;
}

.toc-content::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
}

.toc-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

.toc-nav ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc-nav li {
    margin-bottom: 0.25rem;
}

.toc-nav ul ul {
    padding-left: var(--spacing-md);
    margin-top: 0.25rem;
}

.toc-nav a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.8125rem;
    display: block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    line-height: 1.4;
}

.toc-nav a:hover {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
}

 
.proposal-main {
    min-width: 0;
}

 
.proposal-content {
    line-height: 1.8;
    color: var(--color-text);
    max-width: 900px;
}

.proposal-content h2 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.75rem;
    scroll-margin-top: 100px;
}

.proposal-content h3 {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.375rem;
    scroll-margin-top: 100px;
}

.proposal-content h4 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-xs);
    font-size: 1.125rem;
    scroll-margin-top: 100px;
}

.proposal-content p {
    margin-bottom: var(--spacing-md);
}

.proposal-content ul,
.proposal-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.proposal-content li {
    margin-bottom: var(--spacing-xs);
}

.proposal-content code {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
}

.proposal-content pre {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: var(--spacing-md);
    font-size: 0.875rem;
}

.proposal-content pre code {
    background: none;
    padding: 0;
}

.proposal-content blockquote {
    border-left: 4px solid var(--color-primary);
    padding-left: var(--spacing-md);
    margin-left: 0;
    margin-bottom: var(--spacing-md);
    font-style: italic;
    color: var(--color-text-secondary);
}

.proposal-content a {
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
}

.proposal-content a:hover {
    border-bottom-color: var(--color-primary);
}

.proposal-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: var(--spacing-md);
}

.proposal-content table th {
    background: var(--color-bg-secondary);
    padding: var(--spacing-sm);
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--color-border);
}

.proposal-content table td {
    padding: var(--spacing-sm);
    border-bottom: 1px solid var(--color-border);
}

.proposal-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin: var(--spacing-lg) 0;
    display: block;
}

 
.page-nav {
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.page-nav-link {
    display: inline-block;
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.page-nav-link:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
}

 
@media (max-width: 1024px) {
    .proposal-layout--with-toc {
        grid-template-columns: 1fr;
    }

    .proposal-toc-sidebar {
        position: static;
        max-height: none;
        margin-bottom: var(--spacing-xl);
    }

    .toc-content {
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .proposal-title {
        font-size: 1.75rem;
    }

    .proposal-info-grid {
        grid-template-columns: 1fr;
    }
}
</style>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = [];

    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const heading = document.getElementById(href.slice(1));
            if (heading) {
                headings.push({ element: heading, link: link });
            }
        }
    });

    function updateActiveLink() {
        const scrollPos = window.scrollY + 120;
        let activeIndex = 0;

        for (let i = 0; i < headings.length; i++) {
            if (headings[i].element.offsetTop <= scrollPos) {
                activeIndex = i;
            }
        }

        tocLinks.forEach(link => link.classList.remove('active'));
        if (headings[activeIndex]) {
            headings[activeIndex].link.classList.add('active');
        }
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});
</script>
<style>
.toc-nav a.active {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
    font-weight: 600;
}
</style>



    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">Следите за новостями I2P:</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="Введите ваш email" required>
                            <button type="submit">Подписаться</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>Быстрые ссылки</h3>
                <ul>
                    <li><a href="../../../ru/financial-support/">Пожертвовать</a></li>
                    <li><a href="../../../ru/docs/overview/intro/">Введение в I2P</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Сообщество</h3>
                <ul>
                    <li><a href="../../../ru/get-involved/">Присоединяйтесь</a></li>
                    <li><a href="../../../ru/blog/">Блог</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">Официальные форумы</a></li>
                    <li><a href="../../../ru/contact/">Контакты</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Ресурсы</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">I2P Метрики</a></li>
                    <li><a href="../../../ru/papers/">Исследование</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">StormyCloud</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 Проект Невидимый Интернет. Лицензировано под Creative Commons.</p>
            <div class="footer-links">
                <a href="../../../ru/privacy/">Конфиденциальность</a>
                <a href="../../../ru/terms/">Условия</a>
                <a href="../../../ru/about/media/">Пресса</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="Закрыть">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>Опрос сообщества</h2>
            <p class="modal-subtitle">Мы хотели бы услышать ваше мнение</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                Ваш голос помогает формировать будущее I2P.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
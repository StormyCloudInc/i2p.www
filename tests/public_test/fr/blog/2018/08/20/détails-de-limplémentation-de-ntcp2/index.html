<!DOCTYPE html>
<html lang="fr" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Détails de l&#39;implémentation de NTCP2 | I2P - Le projet Internet invisible</title>

    <meta name="description" content="Détails d&#39;implémentation et spécifications techniques du nouveau protocole de transport d&#39;I2P">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="Détails de l&#39;implémentation de NTCP2 | I2P - Le projet Internet invisible">
    <meta property="og:description" content="Détails d&#39;implémentation et spécifications techniques du nouveau protocole de transport d&#39;I2P">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/fr/blog/2018/08/20/d%C3%A9tails-de-limpl%C3%A9mentation-de-ntcp2/">

    
    <link rel="icon" type="image/svg+xml" href="../../../../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">Site Bêta I2P Maintenant En Ligne Signaler les problèmes e-mail à stormycloud@mail.i2p</span>
            
        </div>
        
        <form method="GET" action="../../../../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="Fermer la bannière" title="Fermer la bannière">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../../../../fr/" class="logo-link">
                    <img src="../../../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../../../../fr/about/" class="">À propos</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../../../fr/about/">Aperçu</a></li>
                            <li><a href="../../../../../../fr/papers/">Articles de recherche</a></li>
                            <li><a href="../../../../../../fr/about/media/">Presse</a></li>
                            <li><a href="../../../../../../fr/contact/">Contactez-nous</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../../../../fr/docs/" class="">Docs</a></li>
                    <li><a href="../../../../../../fr/downloads/" class="">Téléchargements</a></li>
                    <li><a href="../../../../../../fr/blog/" class="active">Blog</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../../../../fr/get-involved/" class="">S&#39;impliquer</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../../../fr/get-involved/">Aperçu</a></li>
                            <li><a href="../../../../../../fr/feedback/">Suggestions de fonctionnalités</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">fr</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../en/blog/2018/08/20/ntcp2-implementation-details/"
                                class="lang-option">Anglais</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../es/blog/2018/08/20/detalles-de-implementaci%C3%B3n-de-ntcp2/"
                                class="lang-option">Espagnol</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../ko/blog/2018/08/20/ntcp2-%EA%B5%AC%ED%98%84-%EC%84%B8%EB%B6%80-%EC%82%AC%ED%95%AD/"
                                class="lang-option">Coréen</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../zh/blog/2018/08/20/ntcp2-%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82/"
                                class="lang-option">Chinois</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../ru/blog/2018/08/20/%D0%BF%D0%BE%D0%B4%D1%80%D0%BE%D0%B1%D0%BD%D0%BE%D1%81%D1%82%D0%B8-%D1%80%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8-ntcp2/"
                                class="lang-option">Russe</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../cs/blog/2018/08/20/podrobnosti-implementace-ntcp2/"
                                class="lang-option">Tchèque</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../de/blog/2018/08/20/ntcp2-implementierungsdetails/"
                                class="lang-option">Allemand</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../fr/blog/2018/08/20/d%C3%A9tails-de-limpl%C3%A9mentation-de-ntcp2/"
                                class="lang-option active">Français</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../tr/blog/2018/08/20/ntcp2-uygulama-ayr%C4%B1nt%C4%B1lar%C4%B1/"
                                class="lang-option">Turc</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../vi/blog/2018/08/20/chi-ti%E1%BA%BFt-tri%E1%BB%83n-khai-ntcp2/"
                                class="lang-option">Vietnamien</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../hi/blog/2018/08/20/ntcp2-%E0%A4%95%E0%A4%BE%E0%A4%B0%E0%A5%8D%E0%A4%AF%E0%A4%BE%E0%A4%A8%E0%A5%8D%E0%A4%B5%E0%A4%AF%E0%A4%A8-%E0%A4%B5%E0%A4%BF%E0%A4%B5%E0%A4%B0%E0%A4%A3/"
                                class="lang-option">Hindi</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../ar/blog/2018/08/20/ntcp2-implementation-details/"
                                class="lang-option">Arabe</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../pt/blog/2018/08/20/detalhes-de-implementa%C3%A7%C3%A3o-do-ntcp2/"
                                class="lang-option">Portugais</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../../../../fr/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../../../../fr/downloads/" class="btn btn-primary">Obtenir I2P</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        
<article class="blog-post">
    <div class="container">
        <div class="post-header">
            <div class="post-meta-row">
                
                <time class="post-date" datetime="2018-08-20">
                    August 20, 2018
                </time>
                

                
                <div class="post-categories">
                    
                    <span class="category-badge">development</span>
                    
                </div>
                
            </div>

            <h1 class="post-title">Détails de l&#39;implémentation de NTCP2</h1>

            
            <div class="post-author">By villain</div>
            
        </div>

        <div class="post-content">
            <p>Les protocoles de transport d’I2P ont été initialement développés il y a environ 15 ans. À l’époque, l’objectif principal était de cacher les données transférées, pas de dissimuler le fait même d’utiliser le protocole. Personne ne pensait sérieusement à se protéger contre la DPI (inspection approfondie des paquets) et la censure des protocoles. Les temps changent, et bien que les protocoles de transport d’origine fournissent toujours une sécurité robuste, une demande s’est fait sentir pour un nouveau protocole de transport. NTCP2 est conçu pour résister aux menaces de censure actuelles. Principalement, l’analyse par DPI de la longueur des paquets. De plus, le nouveau protocole utilise les avancées cryptographiques les plus récentes. NTCP2 est basé sur le <a href="https://noiseprotocol.org/noise.html">Noise Protocol Framework</a>
, avec SHA256 comme fonction de hachage et x25519 comme courbe elliptique pour l’échange de clés Diffie-Hellman (DH).</p>
<p>La spécification complète du protocole NTCP2 peut être <a href="../../../../../../fr/docs/specs/ntcp2/">consultée ici</a>
.</p>
<h2 id="nouvelle-cryptographie">Nouvelle cryptographie</h2>
<p>NTCP2 nécessite l’ajout des algorithmes cryptographiques suivants à une implémentation I2P :</p>
<ul>
<li>x25519</li>
<li>HMAC-SHA256</li>
<li>Chacha20</li>
<li>Poly1305</li>
<li>AEAD</li>
<li>SipHash</li>
</ul>
<p>Par rapport à notre protocole d&rsquo;origine, NTCP, NTCP2 utilise x25519 au lieu d&rsquo;ElGamal pour la fonction DH, AEAD/Chaha20/Poly1305 au lieu d&rsquo;AES-256-CBC/Adler32, et utilise SipHash pour ofusquer la longueur du paquet. La fonction de dérivation de clés utilisée dans NTCP2 est plus complexe, utilisant désormais de nombreux appels HMAC-SHA256.</p>
<p><em>i2pd (C++) note d’implémentation : Tous les algorithmes mentionnés ci‑dessus, à l’exception de SipHash, sont implémentés dans OpenSSL 1.1.0. SipHash sera ajouté dans la prochaine version 1.1.1 d’OpenSSL. Pour assurer la compatibilité avec OpenSSL 1.0.2, utilisé dans la plupart des systèmes actuels, le développeur principal d’i2pd, <a href="https://github.com/majestrate">Jeff Becker</a>
, a fourni des implémentations autonomes des algorithmes cryptographiques manquants.</em></p>
<h2 id="modifications-de-routerinfo">Modifications de RouterInfo</h2>
<p>NTCP2 requiert une troisième clé (x25519) en plus des deux existantes (les clés de chiffrement et de signature). On l’appelle une clé statique et elle doit être ajoutée à chacune des adresses RouterInfo sous forme de paramètre &ldquo;s&rdquo;. Elle est requise tant pour l’initiateur NTCP2 (Alice) que pour le répondant (Bob). Si plus d’une adresse prend en charge NTCP2, par exemple IPv4 et IPv6, &ldquo;s&rdquo; doit être identique pour toutes. L’adresse d’Alice peut n’avoir que le paramètre &ldquo;s&rdquo; sans &ldquo;host&rdquo; ni &ldquo;port&rdquo; définis. Un paramètre &ldquo;v&rdquo; est également requis, actuellement toujours défini à &ldquo;2&rdquo;.</p>
<p>Une adresse NTCP2 peut être déclarée comme une adresse NTCP2 distincte ou comme une adresse NTCP de style ancien avec des paramètres supplémentaires, auquel cas elle acceptera à la fois des connexions NTCP et NTCP2. L’implémentation Java d’I2P utilise la seconde approche, i2pd (implémentation C++) utilise la première.</p>
<p>Si un nœud accepte des connexions NTCP2, il doit publier son RouterInfo avec le paramètre &ldquo;i&rdquo;, qui est utilisé comme vecteur d&rsquo;initialisation (IV) de la clé publique lorsque ce nœud établit de nouvelles connexions.</p>
<h2 id="établir-une-connexion">Établir une connexion</h2>
<p>Pour établir une connexion, les deux parties doivent générer des paires de clés x25519 éphémères. À partir de ces clés et de clés &ldquo;statiques&rdquo;, elles dérivent un ensemble de clés pour le transfert de données. Les deux parties doivent vérifier que l’autre côté possède effectivement une clé privée pour cette clé statique, et que cette clé statique est la même que dans RouterInfo.</p>
<p>Trois messages sont envoyés pour établir une connexion :</p>
<pre tabindex="0"><code>Alice                           Bob

SessionRequest -------------------&gt;
&lt;------------------- SessionCreated
SessionConfirmed -----------------&gt;
</code></pre><p>Une clé partagée x25519, appelée « input key material » (matériel de clé d’entrée), est calculée pour chaque message, après quoi la clé de chiffrement du message est générée à l’aide d’une fonction MixKey. Une valeur ck (chaining key, clé de chaînage) est conservée pendant que les messages sont échangés. Cette valeur est utilisée comme entrée finale lors de la génération des clés pour le transfert de données.</p>
<p>La fonction MixKey ressemble à ceci dans l’implémentation C++ d’I2P :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> NTCP2Establisher<span style="color:#f92672">::</span>MixKey (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span> inputKeyMaterial, <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span> derived)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// temp_key = HMAC-SHA256(ck, input_key_material)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">uint8_t</span> tempKey[<span style="color:#ae81ff">32</span>]; <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> len;
</span></span><span style="display:flex;"><span>    HMAC(EVP_sha256(), m_CK, <span style="color:#ae81ff">32</span>, inputKeyMaterial, <span style="color:#ae81ff">32</span>, tempKey, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ck = HMAC-SHA256(temp_key, byte(0x01))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint8_t</span> one[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span>  { <span style="color:#ae81ff">1</span> };
</span></span><span style="display:flex;"><span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, one, <span style="color:#ae81ff">1</span>, m_CK, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// derived = HMAC-SHA256(temp_key, ck || byte(0x02))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    m_CK[<span style="color:#ae81ff">32</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, m_CK, <span style="color:#ae81ff">33</span>, derived, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Le message <strong>SessionRequest</strong> est composé d’une clé publique x25519 d’Alice (32 octets), d’un bloc de données chiffré avec AEAD/Chacha20/Poly1305 (16 octets), d’un hachage (16 octets) et de quelques données aléatoires à la fin (padding, remplissage). La longueur du padding est définie dans le bloc de données chiffré. Le bloc chiffré contient également la longueur de la seconde partie du message <strong>SessionConfirmed</strong>. Ce bloc de données est chiffré et signé avec une clé dérivée de la clé éphémère d’Alice et de la clé statique de Bob. La valeur initiale de ck pour la fonction MixKey est définie sur SHA256 (Noise_XKaesobfse+hs2+hs3_25519_ChaChaPoly_SHA256).</p>
<p>Étant donné que 32 octets de clé publique x25519 peuvent être détectés par l’inspection approfondie des paquets (DPI), ils sont chiffrés avec l’algorithme AES-256-CBC en utilisant le hachage de l’adresse de Bob comme clé et le paramètre &ldquo;i&rdquo; de RouterInfo comme vecteur d’initialisation (IV).</p>
<p>Le message <strong>SessionCreated</strong> a la même structure que <strong>SessionRequest</strong>, sauf que la clé est calculée à partir des clés éphémères des deux parties. L’IV (vecteur d’initialisation) généré après le chiffrement/déchiffrement de la clé publique du message <strong>SessionRequest</strong> est utilisé comme IV pour le chiffrement/déchiffrement de la clé publique éphémère.</p>
<p>Le message <strong>SessionConfirmed</strong> comporte 2 parties : la clé publique statique et le RouterInfo d&rsquo;Alice. La différence par rapport aux messages précédents est que la clé publique éphémère est chiffrée avec AEAD/Chaha20/Poly1305 en utilisant la même clé que pour <strong>SessionCreated</strong>. Cela a pour effet d&rsquo;augmenter la première partie du message de 32 à 48 octets. La seconde partie est également chiffrée avec AEAD/Chaha20/Poly1305, mais en utilisant une nouvelle clé, calculée à partir de la clé éphémère de Bob et de la clé statique d&rsquo;Alice. La partie RouterInfo peut également être complétée par un bourrage de données aléatoires, mais ce n&rsquo;est pas nécessaire, puisque RouterInfo a généralement une longueur variable.</p>
<h2 id="génération-des-clés-de-transfert-de-données">Génération des clés de transfert de données</h2>
<p>Si toutes les vérifications de hachage et de clé ont réussi, une valeur ck commune doit être présente après la dernière opération MixKey des deux côtés. Cette valeur est utilisée pour générer deux ensembles de clés &lt;k, sipk, sipiv&gt; pour chaque côté d&rsquo;une connexion. &ldquo;k&rdquo; est une clé AEAD/Chaha20/Poly1305, &ldquo;sipk&rdquo; est une clé SipHash, &ldquo;sipiv&rdquo; est une valeur initiale pour l&rsquo;IV SipHash (vecteur d&rsquo;initialisation), qui est modifiée après chaque utilisation.</p>
<p>Le code utilisé pour générer des clés ressemble à ceci dans l’implémentation C++ d’I2P :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> NTCP2Session<span style="color:#f92672">::</span>KeyDerivationFunctionDataPhase ()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint8_t</span> tempKey[<span style="color:#ae81ff">32</span>]; <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> len;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// temp_key = HMAC-SHA256(ck, zerolen)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), m_Establisher<span style="color:#f92672">-&gt;</span>GetCK (), <span style="color:#ae81ff">32</span>, <span style="color:#66d9ef">nullptr</span>, <span style="color:#ae81ff">0</span>, tempKey, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint8_t</span> one[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span>  { <span style="color:#ae81ff">1</span> };
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// k_ab = HMAC-SHA256(temp_key, byte(0x01)).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, one, <span style="color:#ae81ff">1</span>, m_Kab, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    m_Kab[<span style="color:#ae81ff">32</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// k_ba = HMAC-SHA256(temp_key, k_ab || byte(0x02))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, m_Kab, <span style="color:#ae81ff">33</span>, m_Kba, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint8_t</span> ask[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> { <span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;s&#39;</span>, <span style="color:#e6db74">&#39;k&#39;</span>, <span style="color:#ae81ff">1</span> }, master[<span style="color:#ae81ff">32</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ask_master = HMAC-SHA256(temp_key, &#34;ask&#34; || byte(0x01))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, ask, <span style="color:#ae81ff">4</span>, master, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint8_t</span> h[<span style="color:#ae81ff">39</span>];
</span></span><span style="display:flex;"><span>    memcpy (h, m_Establisher<span style="color:#f92672">-&gt;</span>GetH (), <span style="color:#ae81ff">32</span>);
</span></span><span style="display:flex;"><span>    memcpy (h <span style="color:#f92672">+</span> <span style="color:#ae81ff">32</span>, <span style="color:#e6db74">&#34;siphash&#34;</span>, <span style="color:#ae81ff">7</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// temp_key = HMAC-SHA256(ask_master, h || &#34;siphash&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), master, <span style="color:#ae81ff">32</span>, h, <span style="color:#ae81ff">39</span>, tempKey, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sip_master = HMAC-SHA256(temp_key, byte(0x01))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, one, <span style="color:#ae81ff">1</span>, master, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// temp_key = HMAC-SHA256(sip_master, zerolen)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), master, <span style="color:#ae81ff">32</span>, <span style="color:#66d9ef">nullptr</span>, <span style="color:#ae81ff">0</span>, tempKey, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// sipkeys_ab = HMAC-SHA256(temp_key, byte(0x01)).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, one, <span style="color:#ae81ff">1</span>, m_Sipkeysab, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    m_Sipkeysab[<span style="color:#ae81ff">32</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">// sipkeys_ba = HMAC-SHA256(temp_key, sipkeys_ab || byte(0x02))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, m_Sipkeysab, <span style="color:#ae81ff">33</span>, m_Sipkeysba, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><em>i2pd (C++) note d’implémentation : Les 16 premiers octets du tableau &ldquo;sipkeys&rdquo; constituent une clé SipHash, les 8 derniers octets sont l’IV. SipHash nécessite deux clés de 8 octets, mais i2pd les traite comme une seule clé de 16 octets.</em></p>
<h2 id="transfert-de-données">Transfert de données</h2>
<p>Les données sont transférées sous forme de trames, chaque trame comporte 3 parties :</p>
<ul>
<li>2 bytes of frame length obfuscated with SipHash</li>
<li>data encrypted with Chacha20</li>
<li>16 bytes of Poly1305 hash value</li>
</ul>
<p>La longueur maximale des données transférées dans une trame est de 65 519 octets.</p>
<p>La longueur du message est masquée en appliquant la fonction XOR avec les deux premiers octets de l’IV (vecteur d’initialisation) SipHash actuel.</p>
<p>La partie de données chiffrées contient des blocs de données. Chaque bloc est précédé d’un en-tête de 3 octets, qui définit le type et la longueur du bloc. En général, des blocs de type I2NP sont transmis ; il s’agit de messages I2NP dont l’en-tête est modifié. Une trame NTCP2 peut transférer plusieurs blocs I2NP.</p>
<p>L’autre type important de bloc de données est un bloc de données aléatoire. Il est recommandé d’ajouter un bloc de données aléatoire à chaque trame NTCP2. Un seul bloc de données aléatoire peut être ajouté et il doit être le dernier bloc.</p>
<p>Voici d&rsquo;autres blocs de données utilisés dans l&rsquo;implémentation NTCP2 actuelle :</p>
<ul>
<li><strong>RouterInfo</strong> — usually contains Bob&rsquo;s RouterInfo after the connection has been established, but it can also contain RouterInfo of a random node for the purpose of speeding up floodfills (there is a flags field for that case).</li>
<li><strong>Termination</strong> — is used when a host explicitly terminates a connection and specifies a reason for that.</li>
<li><strong>DateTime</strong> — a current time in seconds.</li>
</ul>
<h2 id="résumé">Résumé</h2>
<p>Le nouveau protocole de transport I2P NTCP2 offre une résistance efficace à la censure par inspection approfondie des paquets (DPI). Il en résulte une réduction de la charge du processeur grâce à une cryptographie moderne plus rapide. Cela rend plus probable l’exécution d’I2P sur des appareils d’entrée de gamme, comme les smartphones et les routeurs domestiques. Les deux principales implémentations d’I2P prennent entièrement en charge NTCP2 et rendent NTCP2 disponible à partir des versions 0.9.36 (Java) et 2.20 (i2pd, C++).</p>

        </div>

        <div class="post-navigation">
            <a href="../../../../../../fr/blog" class="back-to-blog">← Back to Blog</a>
        </div>
    </div>
</article>

<style>
.blog-post {
    padding: var(--spacing-2xl) 0;
}

.post-header {
    margin-bottom: var(--spacing-2xl);
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    padding-bottom: var(--spacing-xl);
    border-bottom: 1px solid var(--color-border);
}

.post-meta-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

.post-date {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.post-categories {
    display: flex;
    gap: var(--spacing-xs);
}

.category-badge {
    padding: 0.25rem 0.625rem;
    background-color: var(--color-primary);
    color: white;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.post-title {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-sm);
    line-height: 1.2;
}

.post-author {
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
}

.post-content {
    max-width: 800px;
    margin: 0 auto var(--spacing-2xl);
    line-height: 1.8;
    font-size: 1.0625rem;
}

.post-content h2,
.post-content h3,
.post-content h4 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
}

.post-content h2 {
    font-size: 1.875rem;
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--color-border);
}

.post-content h3 {
    font-size: 1.5rem;
}

.post-content h4 {
    font-size: 1.25rem;
}

.post-content ul,
.post-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.post-content li {
    margin-bottom: var(--spacing-sm);
}

.post-content pre {
    background-color: var(--color-bg-secondary);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    overflow-x: auto;
    margin: var(--spacing-lg) 0;
    border: 1px solid var(--color-border);
}

.post-content code {
    font-family: var(--font-mono);
    font-size: 0.875em;
}

.post-content pre code {
    background-color: transparent;
    padding: 0;
}

.post-content :not(pre) > code {
    background-color: var(--color-bg-tertiary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
}

.post-navigation {
    max-width: 800px;
    margin: var(--spacing-2xl) auto 0;
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
}

.back-to-blog {
    color: var(--color-primary);
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    transition: gap var(--transition-fast);
}

.back-to-blog:hover {
    gap: var(--spacing-sm);
}

@media (max-width: 768px) {
    .post-meta-row {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-xs);
    }

    .post-title {
        font-size: 2rem;
    }

    .post-content {
        font-size: 1rem;
    }
}
</style>

    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">Restez informé des actualités I2P :</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="Entrez votre email" required>
                            <button type="submit">S&#39;abonner</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>Liens Rapides</h3>
                <ul>
                    <li><a href="../../../../../../fr/financial-support/">Faire un don</a></li>
                    <li><a href="../../../../../../fr/docs/overview/intro/">Introduction à I2P</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Communauté</h3>
                <ul>
                    <li><a href="../../../../../../fr/get-involved/">Participez</a></li>
                    <li><a href="../../../../../../fr/blog/">Blog</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">Forums Officiels</a></li>
                    <li><a href="../../../../../../fr/contact/">Contact</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Ressources</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">Mesures I2P</a></li>
                    <li><a href="../../../../../../fr/papers/">Recherche</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">StormyCloud</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 Le Projet Internet Invisible. Sous licence Creative Commons.</p>
            <div class="footer-links">
                <a href="../../../../../../fr/privacy/">Confidentialité</a>
                <a href="../../../../../../fr/terms/">Conditions d&#39;utilisation</a>
                <a href="../../../../../../fr/about/media/">Presse</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="Fermer">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>Sondage de la communauté</h2>
            <p class="modal-subtitle">Nous aimerions avoir de vos nouvelles</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                Votre vote aide à façonner l&#39;avenir d&#39;I2P.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
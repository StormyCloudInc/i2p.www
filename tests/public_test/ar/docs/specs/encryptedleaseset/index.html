<!DOCTYPE html>
<html lang="ar" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>LeaseSet مشفر | I2P - مشروع الإنترنت غير المرئي</title>

    <meta name="description" content="تنسيق LeaseSet خاضع للتحكم في الوصول لـ Destinations الخاصة (وجهات I2P)">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="LeaseSet مشفر | I2P - مشروع الإنترنت غير المرئي">
    <meta property="og:description" content="تنسيق LeaseSet خاضع للتحكم في الوصول لـ Destinations الخاصة (وجهات I2P)">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/ar/docs/specs/encryptedleaseset/">

    
    <link rel="icon" type="image/svg+xml" href="../../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">موقع I2P التجريبي متاح الآن - أرسل المشاكل إلى stormycloud@mail.i2p</span>
            
        </div>
        
        <form method="GET" action="../../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="إغلاق الشريط" title="إغلاق الشريط">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../../ar/" class="logo-link">
                    <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../../ar/about/" class="">حول</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../ar/about/">نظرة عامة</a></li>
                            <li><a href="../../../../ar/papers/">أبحاث</a></li>
                            <li><a href="../../../../ar/about/media/">الصحافة</a></li>
                            <li><a href="../../../../ar/contact/">اتصل بنا</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../../ar/docs/" class="active">المستندات</a></li>
                    <li><a href="../../../../ar/downloads/" class="">التنزيلات</a></li>
                    <li><a href="../../../../ar/blog/" class="">مدونة</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../../ar/get-involved/" class="">شارك معنا</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../ar/get-involved/">نظرة عامة</a></li>
                            <li><a href="../../../../ar/feedback/">اقتراحات الميزات</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">ar</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../en/docs/specs/encryptedleaseset/"
                                class="lang-option">الإنجليزية</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../es/docs/specs/encryptedleaseset/"
                                class="lang-option">الإسبانية</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ko/docs/specs/encryptedleaseset/"
                                class="lang-option">الكورية</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../zh/docs/specs/encryptedleaseset/"
                                class="lang-option">الصينية</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ru/docs/specs/encryptedleaseset/"
                                class="lang-option">الروسية</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../cs/docs/specs/encryptedleaseset/"
                                class="lang-option">التشيكية</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../de/docs/specs/encryptedleaseset/"
                                class="lang-option">الألمانية</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../fr/docs/specs/encryptedleaseset/"
                                class="lang-option">الفرنسية</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../tr/docs/specs/encryptedleaseset/"
                                class="lang-option">التركية</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../vi/docs/specs/encryptedleaseset/"
                                class="lang-option">الفيتنامية</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../hi/docs/specs/encryptedleaseset/"
                                class="lang-option">الهندية</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ar/docs/specs/encryptedleaseset/"
                                class="lang-option active">العربية</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../pt/docs/specs/encryptedleaseset/"
                                class="lang-option">البرتغالية</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../../ar/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../../ar/downloads/" class="btn btn-primary">احصل على I2P</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        




<div class="docs-page">
    <div class="container">
        
        <div class="docs-layout docs-layout--with-toc">
            
            
            <aside class="docs-toc-sidebar">
                <nav class="toc-nav">
                    <div class="toc-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        On This Page
                    </div>
                    <div class="toc-content">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#نظرة-عامة">نظرة عامة</a></li>
    <li><a href="#سجل-الإصدارات-وحالة-التنفيذ">سجل الإصدارات وحالة التنفيذ</a>
      <ul>
        <li><a href="#الجدول-الزمني-لتطوير-البروتوكول">الجدول الزمني لتطوير البروتوكول</a></li>
        <li><a href="#معالم-التنفيذ">معالم التنفيذ</a></li>
      </ul>
    </li>
    <li><a href="#تعريفات-التشفير">تعريفات التشفير</a>
      <ul>
        <li><a href="#الترميز-والاصطلاحات">الترميز والاصطلاحات</a></li>
        <li><a href="#csrngn-مولد-أعداد-عشوائية-آمن-تشفيريا">CSRNG(n) (مولد أعداد عشوائية آمن تشفيرياً)</a></li>
        <li><a href="#hp-d">H(p, d)</a></li>
        <li><a href="#تدفق-chacha20-خوارزمية-تشفير-تيارية">تدفق: ChaCha20 (خوارزمية تشفير تيارية)</a></li>
        <li><a href="#التوقيع-red25519-خوارزمية-توقيع-رقمية">التوقيع: Red25519 (خوارزمية توقيع رقمية)</a></li>
        <li><a href="#dh-تبادل-المفاتيح-ديفي-هيلمان-x25519">DH (تبادل المفاتيح ديفي-هيلمان): X25519</a></li>
        <li><a href="#hkdf-دالة-اشتقاق-المفاتيح-المستندة-إلى-hmac">HKDF (دالة اشتقاق المفاتيح المستندة إلى HMAC)</a></li>
      </ul>
    </li>
    <li><a href="#مواصفة-التنسيق">مواصفة التنسيق</a>
      <ul>
        <li><a href="#الطبقة-0-الخارجية---نص-صريح">الطبقة 0 (الخارجية) - نص صريح</a></li>
        <li><a href="#الطبقة-1-الوسطى---تخويل-العميل">الطبقة 1 (الوسطى) - تخويل العميل</a></li>
        <li><a href="#الطبقة-2-الداخلية---بيانات-leaseset">الطبقة 2 (الداخلية) - بيانات LeaseSet</a></li>
      </ul>
    </li>
    <li><a href="#اشتقاق-مفتاح-الإعماء">اشتقاق مفتاح الإعماء</a>
      <ul>
        <li><a href="#نظرة-عامة-1">نظرة عامة</a></li>
        <li><a href="#التعريفات-الرياضية">التعريفات الرياضية</a></li>
        <li><a href="#جيل-ألفا">جيل ألفا</a></li>
        <li><a href="#إعماء-المفتاح-الخاص">إعماء المفتاح الخاص</a></li>
        <li><a href="#إعماء-المفتاح-العام">إعماء المفتاح العام</a></li>
        <li><a href="#التوقيع-باستخدام-blinded-keys-مفاتيح-مطبق-عليها-الإعماء">التوقيع باستخدام Blinded Keys (مفاتيح مُطبَّق عليها الإعماء)</a></li>
        <li><a href="#اعتبارات-أمنية">اعتبارات أمنية</a></li>
      </ul>
    </li>
    <li><a href="#التشفير-والمعالجة">التشفير والمعالجة</a>
      <ul>
        <li><a href="#اشتقاق-بيانات-الاعتماد-الفرعية">اشتقاق بيانات الاعتماد الفرعية</a></li>
        <li><a href="#تشفير-الطبقة-الأولى">تشفير الطبقة الأولى</a></li>
        <li><a href="#تشفير-الطبقة-الثانية">تشفير الطبقة الثانية</a></li>
        <li><a href="#ملخص-طبقة-التشفير">ملخص طبقة التشفير</a></li>
      </ul>
    </li>
    <li><a href="#تفويض-لكل-عميل">تفويض لكل عميل</a>
      <ul>
        <li><a href="#نظرة-عامة-2">نظرة عامة</a></li>
        <li><a href="#تفويض-عميل-dh-diffie-hellman---تبادل-المفاتيح-ديفي-هيلمان">تفويض عميل DH (Diffie-Hellman - تبادل المفاتيح ديفي-هيلمان)</a></li>
        <li><a href="#تفويض-العميل-عبر-psk-مفتاح-مسبق-المشاركة">تفويض العميل عبر PSK (مفتاح مُسبق المشاركة)</a></li>
        <li><a href="#المقارنة-والتوصيات">المقارنة والتوصيات</a></li>
        <li><a href="#الاعتبارات-الأمنية">الاعتبارات الأمنية</a></li>
      </ul>
    </li>
    <li><a href="#العنونة-بـ-base32-لـ-leasesets-المشفرة">العنونة بـ Base32 لـ LeaseSets المشفرة</a>
      <ul>
        <li><a href="#نظرة-عامة-3">نظرة عامة</a></li>
        <li><a href="#مواصفة-صيغة-العنوان">مواصفة صيغة العنوان</a></li>
        <li><a href="#توليد-العناوين">توليد العناوين</a></li>
        <li><a href="#تحليل-العناوين">تحليل العناوين</a></li>
        <li><a href="#مقارنة-مع-base32-التقليدي">مقارنة مع Base32 التقليدي</a></li>
        <li><a href="#تكامل-دفتر-العناوين">تكامل دفتر العناوين</a></li>
        <li><a href="#أمثلة-على-التنفيذ">أمثلة على التنفيذ</a></li>
        <li><a href="#اعتبارات-الأمان">اعتبارات الأمان</a></li>
      </ul>
    </li>
    <li><a href="#دعم-المفاتيح-غير-المتصلة">دعم المفاتيح غير المتصلة</a>
      <ul>
        <li><a href="#نظرة-عامة-4">نظرة عامة</a></li>
        <li><a href="#بنية-المفاتيح-دون-اتصال">بنية المفاتيح دون اتصال</a></li>
        <li><a href="#عملية-توليد-المفاتيح">عملية توليد المفاتيح</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#security-considerations">Security Considerations</a></li>
        <li><a href="#file-format-todo">File Format (TODO)</a></li>
        <li><a href="#i2cp-protocol-enhancement-todo">I2CP Protocol Enhancement (TODO)</a></li>
        <li><a href="#implementation-status">Implementation Status</a></li>
      </ul>
    </li>
    <li><a href="#security-considerations-1">Security Considerations</a>
      <ul>
        <li><a href="#cryptographic-security">Cryptographic Security</a></li>
        <li><a href="#forward-secrecy">Forward Secrecy</a></li>
        <li><a href="#privacy-properties">Privacy Properties</a></li>
        <li><a href="#threat-model">Threat Model</a></li>
        <li><a href="#attack-scenarios">Attack Scenarios</a></li>
        <li><a href="#operational-security">Operational Security</a></li>
        <li><a href="#implementation-security">Implementation Security</a></li>
        <li><a href="#recommendations">Recommendations</a></li>
      </ul>
    </li>
    <li><a href="#implementation-notes">Implementation Notes</a>
      <ul>
        <li><a href="#java-i2p-implementation">Java I2P Implementation</a></li>
        <li><a href="#i2pd-c-implementation">i2pd (C++) Implementation</a></li>
        <li><a href="#testing-and-debugging">Testing and Debugging</a></li>
        <li><a href="#performance-considerations">Performance Considerations</a></li>
        <li><a href="#compatibility">Compatibility</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a>
      <ul>
        <li><a href="#ietf-rfcs">IETF RFCs</a></li>
        <li><a href="#i2p-specifications">I2P Specifications</a></li>
        <li><a href="#cryptographic-references">Cryptographic References</a></li>
        <li><a href="#security-references">Security References</a></li>
        <li><a href="#implementation-references">Implementation References</a></li>
        <li><a href="#version-history">Version History</a></li>
      </ul>
    </li>
    <li><a href="#appendix-a-cryptographic-constants">Appendix A: Cryptographic Constants</a>
      <ul>
        <li><a href="#ed25519--red25519-constants">Ed25519 / Red25519 Constants</a></li>
        <li><a href="#chacha20-constants">ChaCha20 Constants</a></li>
        <li><a href="#hkdf-constants">HKDF Constants</a></li>
        <li><a href="#hash-personalization-strings">Hash Personalization Strings</a></li>
        <li><a href="#structure-sizes">Structure Sizes</a></li>
      </ul>
    </li>
    <li><a href="#appendix-b-test-vectors">Appendix B: Test Vectors</a>
      <ul>
        <li><a href="#test-vector-1-alpha-generation">Test Vector 1: Alpha Generation</a></li>
        <li><a href="#test-vector-2-chacha20-encryption">Test Vector 2: ChaCha20 Encryption</a></li>
        <li><a href="#test-vector-3-hkdf">Test Vector 3: HKDF</a></li>
        <li><a href="#test-vector-4-base32-address">Test Vector 4: Base32 Address</a></li>
      </ul>
    </li>
    <li><a href="#appendix-c-glossary">Appendix C: Glossary</a></li>
    <li><a href="#document-information">Document Information</a></li>
  </ul>
</nav>
                    </div>
                </nav>
            </aside>
            

            
            <div class="docs-main">
                
                <nav class="breadcrumbs">
                    <a href="../../../../ar/">Home</a>
                    <span class="separator">/</span>
                    <a href="../../../../ar/docs/">Docs</a>
                    
                        
                            <span class="separator">/</span>
                            <a href="../../../../ar/docs/specs/">Specifications</a>
                        
                    
                    <span class="separator">/</span>
                    <span class="current">LeaseSet مشفر</span>
                </nav>

                
<div class="translation-disclaimer" role="note">
    <span class="disclaimer-message">تم إنشاء هذه الترجمة باستخدام التعلم الآلي وقد لا تكون دقيقة بنسبة 100%.</span>
    
    
    <a href="../../../../en/docs/specs/encryptedleaseset/" class="disclaimer-link">عرض النسخة الإنجليزية</a>
    
</div>



                
                <header class="article-header">
                    <h1 class="article-title">LeaseSet مشفر</h1>
                    
                        <p class="article-description">تنسيق LeaseSet خاضع للتحكم في الوصول لـ Destinations الخاصة (وجهات I2P)</p>
                    
                    <div class="article-meta">
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                Updated: 2025-10
                            </span>
                        
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Accurate for: 2.10.0
                            </span>
                        
                    </div>
                </header>

                
                <article class="article-content">
                    <h2 id="نظرة-عامة">نظرة عامة</h2>
<p>تحدد هذه الوثيقة آليات blinding (الإعماء التشفيري)، والتشفير، وفك التشفير لـ LeaseSet2 (LS2) المشفَّر. توفر LeaseSets المشفَّرة نشرًا خاضعًا للتحكم في الوصول لمعلومات الخدمات المخفية في قاعدة بيانات شبكة I2P.</p>
<p><strong>الميزات الأساسية:</strong> - تدوير يومي للمفاتيح لتحقيق السرية الأمامية - ترخيص العملاء ثنائي المستويات (DH-based القائم على Diffie-Hellman، وPSK-based المعتمد على المفتاح المُشترك مسبقاً) - تشفير ChaCha20 لتحسين الأداء على الأجهزة التي تفتقر إلى عتاد AES - تواقيع Red25519 مع key blinding (إعماء المفتاح) - عضوية عملاء تحافظ على الخصوصية</p>
<p><strong>الوثائق ذات الصلة:</strong> - <a href="../../../../ar/docs/specs/common-structures/">مواصفة الهياكل المشتركة</a>
 - بنية LeaseSet المشفرة - <a href="../../../../ar/proposals/123-new-netdb-entries/">الاقتراح 123: إدخالات netDB الجديدة</a>
 - خلفية حول LeaseSets المشفرة - <a href="../../../../ar/docs/specs/common-structures/">وثائق قاعدة بيانات الشبكة</a>
 - استخدام NetDB</p>
<hr>
<h2 id="سجل-الإصدارات-وحالة-التنفيذ">سجل الإصدارات وحالة التنفيذ</h2>
<h3 id="الجدول-الزمني-لتطوير-البروتوكول">الجدول الزمني لتطوير البروتوكول</h3>
<p><strong>ملاحظة مهمة حول ترقيم الإصدارات:</strong>   تستخدم I2P مخططين منفصلين لترقيم الإصدارات: - <strong>إصدار API/Router:</strong> سلسلة 0.9.x (يُستخدم في المواصفات التقنية) - <strong>إصدار المنتج:</strong> سلسلة 2.x.x (يُستخدم للإصدارات العامة)</p>
<p>تشير المواصفات التقنية إلى إصدارات واجهة برمجة التطبيقات (API) (مثل 0.9.41)، في حين يرى المستخدمون النهائيون إصدارات المنتج (مثل 2.10.0).</p>
<h3 id="معالم-التنفيذ">معالم التنفيذ</h3>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Version</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Release Date</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Features</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>0.9.38</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">January 2019</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Floodfill support for standard LS2, offline keys</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>0.9.39</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">March 2019</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Full encrypted LS2 support, Red25519 (sig type&nbsp;11)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>0.9.40</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">May 2019</td><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Per-client authorization, encrypted LS2 with offline keys, B32 support</strong></td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>0.9.41</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">June 2019</td><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Protocol finalized as stable</strong></td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>2.10.0</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">September 2025</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Latest Java implementation (API version 0.9.61)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>i2pd 2.58.0</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">September 2025</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Full C++ implementation compatibility</td></tr>
  </tbody>
</table>
### الحالة الحالية
<ul>
<li>✅ <strong>حالة البروتوكول:</strong> مستقر ولم يتغير منذ يونيو 2019</li>
<li>✅ <strong>Java I2P:</strong> مُنفّذ بالكامل في الإصدار 0.9.40+</li>
<li>✅ <strong>i2pd (C++):</strong> مُنفّذ بالكامل في الإصدار 2.58.0+</li>
<li>✅ <strong>التشغيل البيني:</strong> كامل بين التنفيذات</li>
<li>✅ <strong>نشر الشبكة:</strong> جاهز للإنتاج مع خبرة تشغيلية تزيد على 6 سنوات</li>
</ul>
<hr>
<h2 id="تعريفات-التشفير">تعريفات التشفير</h2>
<h3 id="الترميز-والاصطلاحات">الترميز والاصطلاحات</h3>
<ul>
<li><code>||</code> يدل على الربط</li>
<li><code>mod L</code> يدل على الاختزال المعياري وفق رتبة Ed25519</li>
<li>جميع مصفوفات البايت تكون بترتيب بايت الشبكة (big-endian: البايت الأكثر أهمية أولاً) ما لم يُنص على خلاف ذلك</li>
<li>القيم ذات الترتيب little-endian (البايت الأقل أهمية أولاً) يُشار إليها صراحة</li>
</ul>
<h3 id="csrngn-مولد-أعداد-عشوائية-آمن-تشفيريا">CSRNG(n) (مولد أعداد عشوائية آمن تشفيرياً)</h3>
<p><strong>مولِّد أرقام عشوائية آمن تشفيرياً</strong></p>
<p>يُنتج <code>n</code> بايتًا من بيانات عشوائية آمنة من الناحية التشفيرية، مناسبة لتوليد مادة المفتاح.</p>
<p><strong>متطلبات الأمان:</strong> - يجب أن يكون آمناً تشفيرياً (مناسب لتوليد المفاتيح) - يجب أن يكون آمناً عند انكشاف تسلسلات بايت متجاورة على الشبكة - ينبغي لعمليات التنفيذ أن تقوم بتجزئة المخرجات القادمة من مصادر قد لا يُوثَق بها</p>
<p><strong>المراجع:</strong> - <a href="http://projectbullrun.org/dual-ec/ext-rand.html">اعتبارات أمان PRNG</a>
 - <a href="https://lists.torproject.org/pipermail/tor-dev/2015-November/009954.html">مناقشة مطوري Tor</a>
</p>
<h3 id="hp-d">H(p, d)</h3>
<p><strong>تجزئة SHA-256 مع التخصيص</strong></p>
<p>دالة تجزئة مع domain separation (فصل النطاقات) تأخذ: - <code>p</code>: سلسلة التخصيص (توفّر فصل النطاقات) - <code>d</code>: البيانات المطلوب تجزئتها</p>
<p><strong>التنفيذ:</strong></p>
<pre tabindex="0"><code>H(p, d) := SHA-256(p || d)
</code></pre><p><strong>الاستخدام:</strong> يوفّر فصلًا تشفيريًا للمجالات لمنع هجمات التصادم بين الاستخدامات البروتوكولية المختلفة لـ SHA-256.</p>
<h3 id="تدفق-chacha20-خوارزمية-تشفير-تيارية">تدفق: ChaCha20 (خوارزمية تشفير تيارية)</h3>
<p><strong>شفرة تدفقية: ChaCha20 كما هو محدد في RFC 7539 القسم 2.4</strong></p>
<p><strong>المعلمات:</strong> - <code>S_KEY_LEN = 32</code> (مفتاح بطول 256-بت) - <code>S_IV_LEN = 12</code> (nonce (عدد فريد لمرة واحدة) بطول 96-بت) - العداد الابتدائي: <code>1</code> (تسمح RFC 7539 بالقيمة 0 أو 1؛ يوصى باستخدام 1 لسياقات AEAD (مصادقة وتشفير البيانات المقترنة))</p>
<p><strong>ENCRYPT(k, iv, plaintext)</strong></p>
<p>يشفّر النص الصريح باستخدام: - <code>k</code>: مفتاح تشفير بطول 32 بايت - <code>iv</code>: nonce (قيمة تُستخدم مرة واحدة) بطول 12 بايت (يجب أن تكون فريدة لكل مفتاح) - يعيد نصاً مُشفّراً بنفس حجم النص الصريح</p>
<p><strong>خاصية أمنية:</strong> يجب أن يكون كامل النص المشفّر غير قابل للتمييز عن العشوائية إذا كان المفتاح سريًا.</p>
<p><strong>فك التشفير(k, iv, ciphertext)</strong></p>
<p>يفك تشفير النص المُشفّر باستخدام: - <code>k</code>: مفتاح تشفير بطول 32 بايت - <code>iv</code>: عدد يُستخدم مرة واحدة بطول 12 بايت - يُرجع النص الصريح</p>
<p><strong>مبررات التصميم:</strong> تم اختيار ChaCha20 بدلًا من AES للأسباب التالية:</p>
<ul>
<li>أسرع بمقدار 2.5-3x من AES على الأجهزة التي لا يتوفر فيها تسريع عتادي</li>
<li>يسهل تحقيق تنفيذ بزمن ثابت (constant-time)</li>
<li>أمان وسرعة قابِلان للمقارنة عند توفر AES-NI</li>
</ul>
<p><strong>المراجع:</strong> - <a href="https://datatracker.ietf.org/doc/html/rfc7539">RFC 7539</a>
 - ChaCha20 و Poly1305 لبروتوكولات IETF</p>
<h3 id="التوقيع-red25519-خوارزمية-توقيع-رقمية">التوقيع: Red25519 (خوارزمية توقيع رقمية)</h3>
<p><strong>مخطط التوقيع: Red25519 (SigType 11) مع إعماء المفتاح</strong></p>
<p>Red25519 مبني على تواقيع Ed25519 على منحنى Ed25519، باستخدام SHA-512 للتجزئة، مع دعم key blinding (إعماء المفتاح) كما هو محدد في ZCash RedDSA.</p>
<p><strong>الدوال:</strong></p>
<h4 id="derive_publicprivkey">DERIVE_PUBLIC(privkey)</h4>
<p>يُعيد المفتاح العام المقابل للمفتاح الخاص المُعطى. - يستخدم الضرب العددي القياسي في Ed25519 على النقطة الأساسية</p>
<h4 id="signprivkey-m">SIGN(privkey, m)</h4>
<p>يُرجِع توقيعًا باستخدام المفتاح الخاص <code>privkey</code> على الرسالة <code>m</code>.</p>
<p><strong>اختلافات توقيع Red25519 عن Ed25519:</strong> 1. <strong>Nonce عشوائي (عدد يُستخدم مرة واحدة):</strong> يستخدم 80 بايتًا من البيانات العشوائية الإضافية</p>
<pre tabindex="0"><code>T = CSRNG(80)  // 80 random bytes
r = H*(T || publickey || message)
</code></pre><p>هذا يجعل كل توقيع Red25519 (خوارزمية توقيع) فريدًا، حتى مع الرسالة والمفتاح نفسيهما.</p>
<ol start="2">
<li><strong>توليد المفاتيح الخاصة:</strong> تُولَّد مفاتيح Red25519 الخاصة من أعداد عشوائية وتُختزَل وفق <code>mod L</code>، بدلاً من استخدام نهج bit-clamping الخاص بـ Ed25519.</li>
</ol>
<h4 id="تحققpubkey-m-sig">تحقق(pubkey, m, sig)</h4>
<p>يتحقق من التوقيع <code>sig</code> مقابل المفتاح العام <code>pubkey</code> والرسالة <code>m</code>. - يُرجع <code>true</code> إذا كان التوقيع صالحًا، و<code>false</code> خلاف ذلك - عملية التحقق مطابقة لـ Ed25519</p>
<p><strong>عمليات إعماء المفاتيح:</strong></p>
<h4 id="generate_alphadata-secret">GENERATE_ALPHA(data, secret)</h4>
<p>يولّد قيمة ألفا لأجل key blinding (إعماء المفتاح). - <code>data</code>: يحتوي عادةً على المفتاح العام للتوقيع وأنواع التوقيع - <code>secret</code>: سر إضافي اختياري (بطول صفري إذا لم يُستخدم) - النتيجة موزَّعة بنفس توزيع مفاتيح Ed25519 الخاصة (بعد إجراء اختزال mod L)</p>
<h4 id="blind_privkeyprivkey-alpha">BLIND_PRIVKEY(privkey, alpha)</h4>
<p>يُعمّي مفتاحاً خاصاً باستخدام السر <code>alpha</code>. - التنفيذ: <code>blinded_privkey = (privkey + alpha) mod L</code> - يستخدم حسابات scalar (عدد قياسي) ضمن الحقل</p>
<h4 id="blind_pubkeypubkey-alpha">BLIND_PUBKEY(pubkey, alpha)</h4>
<p>يُعمّي مفتاحاً عاماً باستخدام السر <code>alpha</code>. - التنفيذ: <code>blinded_pubkey = pubkey + DERIVE_PUBLIC(alpha)</code> - يستخدم جمع عناصر المجموعة (النقاط) على المنحنى</p>
<p><strong>خاصية حرجة:</strong></p>
<pre tabindex="0"><code>BLIND_PUBKEY(pubkey, alpha) == DERIVE_PUBLIC(BLIND_PRIVKEY(privkey, alpha))
</code></pre><p><strong>اعتبارات أمنية:</strong></p>
<p>من مواصفة بروتوكول ZCash القسم 5.4.6.1: لأسباب أمنية، يجب أن يكون توزيع alpha مطابقاً لتوزيع unblinded private keys (المفاتيح الخاصة بعد إزالة الإعماء). وهذا يضمن أن &ldquo;مزيج مفتاح عام أُعيدت عشوائيته والتوقيع أو التوقيعات المُولَّدة باستخدام ذلك المفتاح لا يكشف المفتاح الذي أُعيدت عشوائيته منه&rdquo;.</p>
<p><strong>أنواع التواقيع المدعومة:</strong> - <strong>النوع 7 (Ed25519):</strong> مدعوم للوجهات الحالية (للتوافق مع الإصدارات الأقدم) - <strong>النوع 11 (Red25519):</strong> موصى به للوجهات الجديدة التي تستخدم التشفير - <strong>Blinded keys (مفاتيح معمية):</strong> استخدم دائمًا النوع 11 (Red25519)</p>
<p><strong>المراجع:</strong> - <a href="https://zips.z.cash/protocol/protocol.pdf">مواصفة بروتوكول ZCash</a>
 - القسم 5.4.6 RedDSA - <a href="../../../../ar/docs/specs/red25519-signature-scheme/">مواصفة I2P Red25519</a>
</p>
<h3 id="dh-تبادل-المفاتيح-ديفي-هيلمان-x25519">DH (تبادل المفاتيح ديفي-هيلمان): X25519</h3>
<p><strong>ديفي-هيلمان على المنحنيات الإهليلجية: X25519</strong></p>
<p>نظام اتفاق مفاتيح بالمفتاح العام قائم على Curve25519.</p>
<p><strong>المعلمات:</strong> - المفاتيح الخاصة: 32 بايت - المفاتيح العامة: 32 بايت - مخرجات السرّ المشترك: 32 بايت</p>
<p><strong>الدوال:</strong></p>
<h4 id="generate_private">GENERATE_PRIVATE()</h4>
<p>يُولِّد مفتاحاً خاصاً جديداً بطول 32 بايت باستخدام CSRNG (مولّد أرقام عشوائية آمن تشفيرياً).</p>
<h4 id="derive_publicprivkey-1">DERIVE_PUBLIC(privkey)</h4>
<p>يشتق مفتاحًا عامًا بطول 32 بايت من المفتاح الخاص المُعطى. - يستخدم الضرب العددي على Curve25519 (منحنى بيضوي للتشفير)</p>
<h4 id="dhprivkey-pubkey">DH(privkey, pubkey)</h4>
<p>ينفّذ اتفاقية تبادل المفاتيح Diffie-Hellman. - <code>privkey</code>: مفتاح خاص محلي بطول 32 بايت - <code>pubkey</code>: مفتاح عام بعيد بطول 32 بايت - يعيد: سر مشترك بطول 32 بايت</p>
<p><strong>خصائص الأمان:</strong> - افتراض ديفي-هيلمان الحسابي على Curve25519 - السرية الأمامية عند استخدام المفاتيح المؤقتة - يتطلب تنفيذًا بزمن ثابت لمنع هجمات التوقيت</p>
<p><strong>المراجع:</strong> - <a href="https://datatracker.ietf.org/doc/html/rfc7748">RFC 7748</a>
 - المنحنيات البيضوية للأمن</p>
<h3 id="hkdf-دالة-اشتقاق-المفاتيح-المستندة-إلى-hmac">HKDF (دالة اشتقاق المفاتيح المستندة إلى HMAC)</h3>
<p><strong>دالة اشتقاق المفاتيح المستندة إلى HMAC</strong></p>
<p>يستخلص ويُوسِّع المادة المفتاحية من المادة المفتاحية المُدخلة.</p>
<p><strong>المعلمات:</strong> - <code>salt</code>: بحد أقصى 32 بايت (عادةً 32 بايت لـ SHA-256) - <code>ikm</code>: مادة مفتاح الإدخال (أي طول، ينبغي أن تتمتع بإنتروبيا جيدة) - <code>info</code>: معلومات خاصة بالسياق (فصل المجالات) - <code>n</code>: طول المخرجات بالبايت</p>
<p><strong>التنفيذ:</strong></p>
<p>يستخدم HKDF (مشتق المفاتيح القائم على HMAC) كما هو محدد في RFC 5869 مع: - <strong>دالة التجزئة:</strong> SHA-256 - <strong>HMAC:</strong> كما هو محدد في RFC 2104 - <strong>طول الملح (Salt):</strong> بحد أقصى 32 بايت (HashLen، أي طول ناتج التجزئة، لـ SHA-256)</p>
<p><strong>نمط الاستخدام:</strong></p>
<pre tabindex="0"><code>keys = HKDF(salt, ikm, info, n)
</code></pre><p><strong>فصل المجالات:</strong> يوفر معامل <code>info</code> فصلًا تشفيريًا للمجالات بين الاستخدامات المختلفة لـ HKDF (دالة اشتقاق المفاتيح المعتمدة على HMAC) في البروتوكول.</p>
<p><strong>قيم معلومات مُتحقَّق منها:</strong> - <code>&quot;ELS2_L1K&quot;</code> - تشفير الطبقة 1 (الخارجية) - <code>&quot;ELS2_L2K&quot;</code> - تشفير الطبقة 2 (الداخلية) - <code>&quot;ELS2_XCA&quot;</code> - تفويض العميل DH (تبادل المفاتيح ديفي-هيلمان) - <code>&quot;ELS2PSKA&quot;</code> - تفويض العميل PSK (مفتاح مُشترك مُسبقًا) - <code>&quot;i2pblinding1&quot;</code> - توليد ألفا</p>
<p><strong>المراجع:</strong> - <a href="https://datatracker.ietf.org/doc/html/rfc5869">RFC 5869</a>
 - مواصفة HKDF - <a href="https://datatracker.ietf.org/doc/html/rfc2104">RFC 2104</a>
 - مواصفة HMAC</p>
<hr>
<h2 id="مواصفة-التنسيق">مواصفة التنسيق</h2>
<p>يتكوّن LS2 (الإصدار الثاني من leaseSet) المشفّر من ثلاث طبقات متداخلة:</p>
<ol>
<li><strong>الطبقة 0 (الخارجية):</strong> معلومات نصية صريحة للتخزين والاسترجاع</li>
<li><strong>الطبقة 1 (الوسطى):</strong> بيانات مصادقة العميل (مشفرة)</li>
<li><strong>الطبقة 2 (الداخلية):</strong> بيانات LeaseSet2 الفعلية (مشفرة)</li>
</ol>
<p><strong>الهيكل العام:</strong></p>
<pre tabindex="0"><code>Layer 0 data + Enc(layer 1 data + Enc(layer 2 data)) + Signature
</code></pre><p><strong>مهم:</strong> تستخدم LS2 المُشفَّرة مفاتيح مُعمّاة بالإعماء. Destination (الوجهة) ليست في الترويسة. موقع التخزين في DHT هو <code>SHA-256(sig type || blinded public key)</code>، ويُدوَّر يومياً.</p>
<h3 id="الطبقة-0-الخارجية---نص-صريح">الطبقة 0 (الخارجية) - نص صريح</h3>
<p>لا تستخدم الطبقة 0 ترويسة LS2 القياسية. لديها تنسيق مخصص محسّن لـ blinded keys (مفاتيح مُعمّاة بطريقة التعمية العمياء).</p>
<p><strong>البنية:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Field</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Type</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1 byte</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Not in header, from DatabaseStore message field</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Blinded Public Key Sig Type</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, always <code>0x000b</code> (Red25519 type 11)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Blinded Public Key</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">32 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Red25519 blinded public key</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Published Timestamp</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, seconds since epoch (rolls over in 2106)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Expires</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, offset from published in seconds (max 65,535 &asymp; 18.2 hours)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Flags</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Bit flags (see below)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">[Optional] Transient Key Data</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">Variable</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Present if flag bit&nbsp;0 is set</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">lenOuterCiphertext</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, length of outer ciphertext</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">outerCiphertext</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">lenOuterCiphertext</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Encrypted Layer&nbsp;1 data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Signature</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">64 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Red25519 signature over all preceding data</td></tr>
  </tbody>
</table>
**حقل الأعلام (2 بايت، البتات 15-0):** - **البت 0:** مؤشر المفاتيح غير المتصلة   - `0` = لا توجد مفاتيح غير متصلة   - `1` = توجد مفاتيح غير متصلة (تليها بيانات مفاتيح مؤقتة) - **البتات 1-15:** محجوزة، يجب أن تكون 0 لضمان التوافق المستقبلي
<p><strong>بيانات مفتاح مؤقتة (موجودة إذا كان البت 0 في العلم يساوي 1):</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Field</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Expires Timestamp</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, seconds since epoch</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Transient Sig Type</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, signature type</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Transient Signing Public Key</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">Variable</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Length implied by signature type</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Signature</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">64 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Signed by blinded public key; covers expires timestamp, transient sig type, and transient public key</td></tr>
  </tbody>
</table>
**التحقق من التوقيع:** - **من دون مفاتيح غير متصلة:** تحقق باستخدام blinded public key (مفتاح عام أعمى) - **مع مفاتيح غير متصلة:** تحقق باستخدام مفتاح عام مؤقت
<p>يغطي التوقيع جميع البيانات من Type وحتى outerCiphertext (شاملًا الطرفين).</p>
<h3 id="الطبقة-1-الوسطى---تخويل-العميل">الطبقة 1 (الوسطى) - تخويل العميل</h3>
<p><strong>فك التشفير:</strong> انظر قسم <a href="#layer-1-encryption">تشفير الطبقة 1</a>
.</p>
<p><strong>البنية:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Field</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Flags</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1 byte</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Authorization flags (see below)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">[Optional] Auth Data</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">Variable</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Present based on flags</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">innerCiphertext</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">Variable</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Encrypted Layer&nbsp;2 data (remainder)</td></tr>
  </tbody>
</table>
**حقل الأعلام (1 بايت، البتات 7-0):** - **البت 0:** وضع التخويل   - `0` = بدون تخويل لكل عميل (الجميع)   - `1` = تخويل لكل عميل (يتبع قسم التخويل) - **البتات 3-1:** مخطط المصادقة (فقط إذا كان البت 0 = 1)   - `000` = مصادقة عميل DH (Diffie-Hellman)   - `001` = مصادقة عميل PSK (مفتاح مُشترك مسبقًا)   - البقية محجوزة - **البتات 7-4:** غير مستخدمة، يجب أن تكون 0
<p><strong>بيانات تفويض العميل DH (الأعلام = 0x01, البتات 3-1 = 000):</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Field</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">ephemeralPublicKey</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">32 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Server's ephemeral X25519 public key</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">clients</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, number of client entries</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">authClient[]</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">40 bytes each</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Array of client authorization entries</td></tr>
  </tbody>
</table>
**مدخلة authClient (40 بايت):** - `clientID_i`: 8 بايت - `clientCookie_i`: 32 بايت (authCookie مشفّر)
<p><strong>بيانات تفويض عميل PSK (مفتاح مُشترك مُسبقاً) (الأعلام = 0x03، البتات 3-1 = 001):</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Field</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">authSalt</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">32 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Salt for PSK key derivation</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">clients</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Big endian, number of client entries</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">authClient[]</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">40 bytes each</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Array of client authorization entries</td></tr>
  </tbody>
</table>
**مدخلة authClient (40 بايت):** - `clientID_i`: 8 بايت - `clientCookie_i`: 32 بايت (authCookie مشفّر)
<h3 id="الطبقة-2-الداخلية---بيانات-leaseset">الطبقة 2 (الداخلية) - بيانات LeaseSet</h3>
<p><strong>فك التشفير:</strong> راجع قسم <a href="#layer-2-encryption">Layer 2 Encryption</a>
.</p>
<p><strong>البنية:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Field</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Type</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1 byte</td><td style="border:1px solid var(--color-border); padding:0.5rem;"><code>3</code> (LS2) or <code>7</code> (Meta LS2)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">Variable</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Complete LeaseSet2 or MetaLeaseSet2</td></tr>
  </tbody>
</table>
تحتوي الطبقة الداخلية على البنية الكاملة لـ LeaseSet2 بما في ذلك: - ترويسة LS2 - معلومات الـ Lease (سجل اتصال مؤقت في I2P) - توقيع LS2
<p><strong>متطلبات التحقق:</strong> بعد فك التشفير، يجب على التنفيذات التحقق مما يلي: 1. أن الطابع الزمني الداخلي يطابق الطابع الزمني الخارجي المنشور 2. أن وقت الانتهاء الداخلي يطابق وقت الانتهاء الخارجي 3. أن يكون توقيع LS2 صالحًا (الإصدار الثاني من LeaseSet) 4. أن تكون بيانات الـ Lease مكوّنة بشكل سليم</p>
<p><strong>المراجع:</strong> - <a href="../../../../ar/docs/specs/common-structures/">مواصفات الهياكل المشتركة</a>
 - تفاصيل تنسيق LeaseSet2</p>
<hr>
<h2 id="اشتقاق-مفتاح-الإعماء">اشتقاق مفتاح الإعماء</h2>
<h3 id="نظرة-عامة-1">نظرة عامة</h3>
<p>يستخدم I2P مخططاً جمعياً لإعماء المفاتيح مبنياً على Ed25519 (خوارزمية توقيع بيضوية Ed25519) وZCash RedDSA (متغير EdDSA المستخدم في ZCash). تُدوَّر المفاتيح المُعمّاة يومياً (منتصف الليل بتوقيت UTC) لتحقيق السرية الأمامية.</p>
<p><strong>الأساس المنطقي للتصميم:</strong></p>
<p>اختارت I2P صراحةً عدم استخدام نهج الملحق A.2 في ملف rend-spec-v3.txt الخاص بـ Tor. وفقًا للمواصفة:</p>
<blockquote>
<p>&ldquo;نحن لا نستخدم الملحق A.2 من ملف المواصفات rend-spec-v3.txt الخاص بـ Tor، الذي له أهداف تصميم مشابهة، لأن مفاتيحه العامة المُعمّاة (blinded) قد تكون خارج المجموعة الفرعية ذات الرتبة الأولية، مع تبعات أمنية غير معروفة.&rdquo;</p></blockquote>
<p>الإعماء الجمعي في I2P يضمن بقاء المفاتيح المُعمّاة بأسلوب الإعماء ضمن المجموعة الفرعية ذات الرتبة الأولية لمنحنى Ed25519.</p>
<h3 id="التعريفات-الرياضية">التعريفات الرياضية</h3>
<p><strong>معاملات Ed25519:</strong> - <code>B</code>: نقطة الأساس في Ed25519 (المولِّد) = <code>2^255 - 19</code> - <code>L</code>: رتبة Ed25519 = <code>2^252 + 27742317777372353535851937790883648493</code></p>
<p><strong>المتغيرات الأساسية:</strong> - <code>A</code>: مفتاح توقيع عام بطول 32 بايت غير أعمى (داخل Destination، أي الوجهة في I2P) - <code>a</code>: مفتاح توقيع خاص بطول 32 بايت غير أعمى - <code>A'</code>: مفتاح توقيع عام بطول 32 بايت أعمى (يُستخدم في LeaseSet مُشفّر) - <code>a'</code>: مفتاح توقيع خاص بطول 32 بايت أعمى - <code>alpha</code>: عامل العمى بطول 32 بايت (سري)</p>
<p><strong>الدوال المساعدة:</strong></p>
<h4 id="leos2ipx">LEOS2IP(x)</h4>
<p>&ldquo;من سلسلة بايتات بتنسيق Little-Endian (النهاية الصغرى) إلى عدد صحيح&rdquo;</p>
<p>يحوّل مصفوفة بايت مُرتّبة وفق little-endian إلى تمثيل عدد صحيح.</p>
<h4 id="hx">H*(x)</h4>
<p>&ldquo;التجزئة والاختزال&rdquo;</p>
<pre tabindex="0"><code>H*(x) = (LEOS2IP(SHA512(x))) mod L
</code></pre><p>نفس العملية كما في توليد مفاتيح Ed25519 (خوارزمية توقيع رقمية على منحنى بيضوي).</p>
<h3 id="جيل-ألفا">جيل ألفا</h3>
<p><strong>التدوير اليومي:</strong> يجب توليد alpha جديدة و blinded keys (مفاتيح مُعمّاة بتقنية الإعماء) كل يوم عند منتصف الليل حسب UTC (00:00:00 UTC).</p>
<p><strong>خوارزمية GENERATE_ALPHA(destination, date, secret):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Input parameters</span>
</span></span><span style="display:flex;"><span>A <span style="color:#f92672">=</span> destination<span style="color:#e6db74">&#39;s signing public key (32 bytes)</span>
</span></span><span style="display:flex;"><span>stA <span style="color:#f92672">=</span> signature type of A (<span style="color:#ae81ff">2</span> bytes, big endian)
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># 0x0007 for Ed25519 or 0x000b for Red25519</span>
</span></span><span style="display:flex;"><span>stA<span style="color:#e6db74">&#39; = signature type of blinded key A&#39;</span> (<span style="color:#ae81ff">2</span> bytes, big endian) 
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># Always 0x000b (Red25519)</span>
</span></span><span style="display:flex;"><span>datestring <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;YYYYMMDD&#34;</span> (<span style="color:#ae81ff">8</span> bytes ASCII <span style="color:#f92672">from</span> current UTC date)
</span></span><span style="display:flex;"><span>secret <span style="color:#f92672">=</span> optional UTF<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span> encoded string (zero<span style="color:#f92672">-</span>length <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> used)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Computation</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> A <span style="color:#f92672">||</span> stA <span style="color:#f92672">||</span> stA<span style="color:#e6db74">&#39;  # 36 bytes total</span>
</span></span><span style="display:flex;"><span>seed <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>    salt<span style="color:#f92672">=</span>H(<span style="color:#e6db74">&#34;I2PGenerateAlpha&#34;</span>, keydata),
</span></span><span style="display:flex;"><span>    ikm<span style="color:#f92672">=</span>datestring <span style="color:#f92672">||</span> secret,
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;i2pblinding1&#34;</span>,
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Treat seed as 64-byte little-endian integer and reduce</span>
</span></span><span style="display:flex;"><span>alpha <span style="color:#f92672">=</span> seed mod L
</span></span></code></pre></div><p><strong>تم التحقق من البارامترات:</strong> - تخصيص الملح: &ldquo;I2PGenerateAlpha&rdquo; - قيمة info في HKDF: &ldquo;i2pblinding1&rdquo; - المخرجات: 64 بايت قبل الاختزال - توزيع Alpha: بنفس توزيع مفاتيح Ed25519 الخاصة بعد <code>mod L</code></p>
<h3 id="إعماء-المفتاح-الخاص">إعماء المفتاح الخاص</h3>
<p><strong>خوارزمية BLIND_PRIVKEY(a, alpha):</strong></p>
<p>بالنسبة لمالك الوجهة الذي ينشر LeaseSet المُشفَّرة:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># For Ed25519 private key (type 7)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> sigtype <span style="color:#f92672">==</span> <span style="color:#ae81ff">7</span>:
</span></span><span style="display:flex;"><span>    seed <span style="color:#f92672">=</span> destination<span style="color:#e6db74">&#39;s signing private key (32 bytes)</span>
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">=</span> left_half(SHA512(seed))  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">=</span> clamp(a)  <span style="color:#75715e"># Ed25519 clamping</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For Red25519 private key (type 11)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">elif</span> sigtype <span style="color:#f92672">==</span> <span style="color:#ae81ff">11</span>:
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">=</span> destination<span style="color:#e6db74">&#39;s signing private key (32 bytes)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># No clamping for Red25519</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Additive blinding using scalar arithmetic</span>
</span></span><span style="display:flex;"><span>blinded_privkey <span style="color:#f92672">=</span> a<span style="color:#e6db74">&#39; = (a + alpha) mod L</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive blinded public key</span>
</span></span><span style="display:flex;"><span>blinded_pubkey <span style="color:#f92672">=</span> A<span style="color:#e6db74">&#39; = DERIVE_PUBLIC(a&#39;</span>)
</span></span></code></pre></div><p><strong>حاسم:</strong> إن اختزال <code>mod L</code> ضروري للحفاظ على العلاقة الجبرية الصحيحة بين المفتاحين الخاص والعام.</p>
<h3 id="إعماء-المفتاح-العام">إعماء المفتاح العام</h3>
<p><strong>خوارزمية BLIND_PUBKEY(A, alpha):</strong></p>
<p>بالنسبة للعملاء الذين يسترجعون ويتحققون من LeaseSet المشفَّر:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>alpha <span style="color:#f92672">=</span> GENERATE_ALPHA(destination, date, secret)
</span></span><span style="display:flex;"><span>A <span style="color:#f92672">=</span> destination<span style="color:#e6db74">&#39;s signing public key (32 bytes)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Additive blinding using group elements (curve points)</span>
</span></span><span style="display:flex;"><span>blinded_pubkey <span style="color:#f92672">=</span> A<span style="color:#e6db74">&#39; = A + DERIVE_PUBLIC(alpha)</span>
</span></span></code></pre></div><p><strong>التكافؤ الرياضي:</strong></p>
<p>كلتا الطريقتين تعطيان النتيجة نفسها:</p>
<pre tabindex="0"><code>BLIND_PUBKEY(A, alpha) == DERIVE_PUBLIC(BLIND_PRIVKEY(a, alpha))
</code></pre><p>وذلك لأن:</p>
<pre tabindex="0"><code>A&#39; = A + [alpha]B
   = [a]B + [alpha]B
   = [a + alpha]B  (group operation)
   = DERIVE_PUBLIC(a + alpha mod L)
</code></pre><h3 id="التوقيع-باستخدام-blinded-keys-مفاتيح-مطبق-عليها-الإعماء">التوقيع باستخدام Blinded Keys (مفاتيح مُطبَّق عليها الإعماء)</h3>
<p><strong>توقيع LeaseSet غير أعمى:</strong></p>
<p>يتم توقيع الـ unblinded (غير مُعمّى) LeaseSet (المُرسَل مباشرةً إلى العملاء الموثَّقين) باستخدام: - توقيع Standard Ed25519 (النوع 7) أو Red25519 (النوع 11) - مفتاح توقيع خاص unblinded - يتم التحقق باستخدام مفتاح عام unblinded</p>
<p><strong>باستخدام المفاتيح غير المتصلة:</strong> - موقّع بواسطة مفتاح خاص مؤقت unblinded (مزال العمى في سياق التوقيعات العمياء) - يُتحقَّق منه باستخدام مفتاح عام مؤقت unblinded - يجب أن يكون كلاهما من النوع 7 أو 11</p>
<p><strong>توقيع LeaseSet المشفرة:</strong></p>
<p>الجزء الخارجي من LeaseSet المشفَّر يستخدم تواقيع Red25519 مع blinded keys (مفاتيح مُعمّاة بالإعماء).</p>
<p><strong>خوارزمية التوقيع Red25519:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate per-signature random nonce</span>
</span></span><span style="display:flex;"><span>T <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">80</span>)  <span style="color:#75715e"># 80 random bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Calculate r (differs from Ed25519)</span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> H<span style="color:#f92672">*</span>(T <span style="color:#f92672">||</span> blinded_pubkey <span style="color:#f92672">||</span> message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Rest is same as Ed25519</span>
</span></span><span style="display:flex;"><span>R <span style="color:#f92672">=</span> [r]B
</span></span><span style="display:flex;"><span>S <span style="color:#f92672">=</span> (r <span style="color:#f92672">+</span> H(R <span style="color:#f92672">||</span> A<span style="color:#e6db74">&#39; || message) * a&#39;</span>) mod L
</span></span><span style="display:flex;"><span>signature <span style="color:#f92672">=</span> R <span style="color:#f92672">||</span> S  <span style="color:#75715e"># 64 bytes total</span>
</span></span></code></pre></div><p><strong>الاختلافات الأساسية عن Ed25519:</strong> 1. يستخدم 80 بايت من البيانات العشوائية <code>T</code> (وليس تجزئة المفتاح الخاص) 2. يستخدم قيمة المفتاح العام مباشرةً (وليس تجزئة المفتاح الخاص) 3. كل توقيع فريد حتى مع نفس الرسالة والمفتاح</p>
<p><strong>التحقق:</strong></p>
<p>مماثل لـ Ed25519:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Parse signature</span>
</span></span><span style="display:flex;"><span>R <span style="color:#f92672">=</span> signature[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">32</span>]
</span></span><span style="display:flex;"><span>S <span style="color:#f92672">=</span> signature[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">64</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Verify equation: [S]B = R + [H(R || A&#39; || message)]A&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> [S]B <span style="color:#f92672">==</span> R <span style="color:#f92672">+</span> [H(R <span style="color:#f92672">||</span> A<span style="color:#e6db74">&#39; || message)]A&#39;</span>
</span></span></code></pre></div><h3 id="اعتبارات-أمنية">اعتبارات أمنية</h3>
<p><strong>توزيع ألفا:</strong></p>
<p>من أجل الأمان، يجب أن يكون توزيع alpha مطابقاً لتوزيع المفاتيح الخاصة غير المعمية. عند إجراء blinding (تقنية الإعماء في التشفير) من Ed25519 (type 7) إلى Red25519 (type 11)، تختلف التوزيعات قليلاً.</p>
<p><strong>توصية:</strong> استخدم Red25519 (type 11) لكلٍ من المفاتيح غير المُعمّاة (بالإعماء) والمفاتيح المُعمّاة (بالإعماء) لتلبية متطلبات ZCash: &ldquo;إن اقتران مفتاح عام أُعيدت عشوائيته والتوقيع(ات) باستخدام ذلك المفتاح لا يكشف المفتاح الذي أُعيدت منه عشوائيته.&rdquo;</p>
<p><strong>دعم النوع 7:</strong> Ed25519 (خوارزمية توقيع رقمية بيضوية) مدعوم للتوافق مع الإصدارات السابقة للوجهات القائمة، لكن يُوصى باستخدام النوع 11 للوجهات المشفّرة الجديدة.</p>
<p><strong>فوائد التدوير اليومي:</strong> - السرية المستقبلية: اختراق blinded key (المفتاح المُعمّى) اليوم لا يكشف مفتاح الأمس - عدم قابلية الربط: التدوير اليومي يمنع التتبع طويل الأمد عبر DHT - فصل المفاتيح: مفاتيح مختلفة لفترات زمنية مختلفة</p>
<p><strong>المراجع:</strong> - <a href="https://zips.z.cash/protocol/protocol.pdf">ZCash Protocol Specification</a>
 - القسم 5.4.6.1 - <a href="https://lists.torproject.org/pipermail/tor-dev/2013-December/005943.html">Tor Key Blinding Discussion</a>
 - <a href="https://trac.torproject.org/projects/tor/ticket/8106">Tor Ticket #8106</a>
</p>
<hr>
<h2 id="التشفير-والمعالجة">التشفير والمعالجة</h2>
<h3 id="اشتقاق-بيانات-الاعتماد-الفرعية">اشتقاق بيانات الاعتماد الفرعية</h3>
<p>قبل التشفير، نشتق credential (بيانات اعتماد) وsubcredential (بيانات اعتماد فرعية) لربط الطبقات المشفرة بشرط معرفة المفتاح العام للتوقيع الخاص بالوجهة.</p>
<p><strong>الهدف:</strong> ضمان أن فك تشفير LeaseSet المُشفَّر لا يمكن إلا لمن يعرفون المفتاح العام للتوقيع الخاص بالوجهة. لا حاجة إلى الوجهة الكاملة.</p>
<h4 id="حساب-بيانات-الاعتماد">حساب بيانات الاعتماد</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>A <span style="color:#f92672">=</span> destination<span style="color:#e6db74">&#39;s signing public key (32 bytes)</span>
</span></span><span style="display:flex;"><span>stA <span style="color:#f92672">=</span> signature type of A (<span style="color:#ae81ff">2</span> bytes big endian)
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># 0x0007 for Ed25519 or 0x000b for Red25519</span>
</span></span><span style="display:flex;"><span>stA<span style="color:#e6db74">&#39; = signature type of blinded key A&#39;</span> (<span style="color:#ae81ff">2</span> bytes big endian)
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># Always 0x000b (Red25519)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> A <span style="color:#f92672">||</span> stA <span style="color:#f92672">||</span> stA<span style="color:#e6db74">&#39;  # 36 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>credential <span style="color:#f92672">=</span> H(<span style="color:#e6db74">&#34;credential&#34;</span>, keydata)  <span style="color:#75715e"># 32 bytes</span>
</span></span></code></pre></div><p><strong>فصل المجالات:</strong> تضمن سلسلة التخصيص <code>&quot;credential&quot;</code> ألا تتصادم قيمة التجزئة هذه مع أي مفاتيح استعلام في DHT (جدول تجزئة موزع) أو مع استخدامات أخرى للبروتوكول.</p>
<h4 id="حساب-بيانات-الاعتماد-الفرعية">حساب بيانات الاعتماد الفرعية</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>blindedPublicKey <span style="color:#f92672">=</span> A<span style="color:#e6db74">&#39; (32 bytes, from blinding process)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>subcredential <span style="color:#f92672">=</span> H(<span style="color:#e6db74">&#34;subcredential&#34;</span>, credential <span style="color:#f92672">||</span> blindedPublicKey)  <span style="color:#75715e"># 32 bytes</span>
</span></span></code></pre></div><p><strong>الغرض:</strong> يقوم subcredential (اعتماد فرعي) بربط الـ LeaseSet المشفّر بـ: 1. Destination (الوجهة) المحددة (عبر credential) 2. blinded key (مفتاح مُعمّى بالإعماء) المحدد (عبر blindedPublicKey) 3. اليوم المحدد (عبر التدوير اليومي لـ blindedPublicKey)</p>
<p>هذا يمنع هجمات إعادة الإرسال والربط عبر أيام مختلفة.</p>
<h3 id="تشفير-الطبقة-الأولى">تشفير الطبقة الأولى</h3>
<p><strong>السياق:</strong> تحتوي الطبقة 1 على بيانات تفويض العميل ويتم تشفيرها باستخدام مفتاح مشتق من subcredential (بيانات اعتماد فرعية).</p>
<h4 id="خوارزمية-التشفير">خوارزمية التشفير</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Prepare input</span>
</span></span><span style="display:flex;"><span>outerInput <span style="color:#f92672">=</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span><span style="color:#75715e"># publishedTimestamp: 4 bytes from Layer 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate random salt</span>
</span></span><span style="display:flex;"><span>outerSalt <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive encryption key and IV</span>
</span></span><span style="display:flex;"><span>keys <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>    salt<span style="color:#f92672">=</span>outerSalt,
</span></span><span style="display:flex;"><span>    ikm<span style="color:#f92672">=</span>outerInput,
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2_L1K&#34;</span>,  <span style="color:#75715e"># Domain separation</span>
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">=</span><span style="color:#ae81ff">44</span>  <span style="color:#75715e"># 32 bytes key + 12 bytes IV</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>outerKey <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes (indices 0-31 inclusive)</span>
</span></span><span style="display:flex;"><span>outerIV <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes (indices 32-43 inclusive)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt and prepend salt</span>
</span></span><span style="display:flex;"><span>outerPlaintext <span style="color:#f92672">=</span> [Layer <span style="color:#ae81ff">1</span> data]
</span></span><span style="display:flex;"><span>outerCiphertext <span style="color:#f92672">=</span> outerSalt <span style="color:#f92672">||</span> ENCRYPT(outerKey, outerIV, outerPlaintext)
</span></span></code></pre></div><p><strong>الناتج:</strong> <code>outerCiphertext</code> هو <code>32 + len(outerPlaintext)</code> بايت.</p>
<p><strong>خصائص الأمان:</strong> - الملح يضمن أزواج مفتاح/متجه تهيئة (IV) فريدة حتى مع نفس بيانات الاعتماد الفرعية - سلسلة السياق <code>&quot;ELS2_L1K&quot;</code> توفّر فصل المجالات - ChaCha20 يوفّر أمانًا دلاليًا (نصًا مشفّرًا غير قابل للتمييز عن العشوائي)</p>
<h4 id="خوارزمية-فك-التشفير">خوارزمية فك التشفير</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Parse salt from ciphertext</span>
</span></span><span style="display:flex;"><span>outerSalt <span style="color:#f92672">=</span> outerCiphertext[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># First 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive decryption key and IV (same process as encryption)</span>
</span></span><span style="display:flex;"><span>outerInput <span style="color:#f92672">=</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span>keys <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>    salt<span style="color:#f92672">=</span>outerSalt,
</span></span><span style="display:flex;"><span>    ikm<span style="color:#f92672">=</span>outerInput,
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2_L1K&#34;</span>,
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">=</span><span style="color:#ae81ff">44</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>outerKey <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>outerIV <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Decrypt (skip salt bytes)</span>
</span></span><span style="display:flex;"><span>outerPlaintext <span style="color:#f92672">=</span> DECRYPT(outerKey, outerIV, outerCiphertext[<span style="color:#ae81ff">32</span>:end])
</span></span></code></pre></div><p><strong>التحقق:</strong> بعد فك التشفير، تحقّق من أن بنية الطبقة 1 مُشكّلة بشكل صحيح قبل المتابعة إلى الطبقة 2.</p>
<h3 id="تشفير-الطبقة-الثانية">تشفير الطبقة الثانية</h3>
<p><strong>السياق:</strong> تحتوي الطبقة 2 على بيانات LeaseSet2 الفعلية وتكون مشفّرة بمفتاح مشتق من authCookie (إذا كانت المصادقة لكل عميل مفعّلة) أو سلسلة فارغة (إذا لم تكن كذلك).</p>
<h4 id="خوارزمية-التشفير-1">خوارزمية التشفير</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Determine authCookie based on authorization mode</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> per_client_auth_enabled:
</span></span><span style="display:flex;"><span>    authCookie <span style="color:#f92672">=</span> [<span style="color:#ae81ff">32</span><span style="color:#f92672">-</span>byte cookie <span style="color:#f92672">from</span> client authorization process]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    authCookie <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>  <span style="color:#75715e"># Zero-length byte array</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Prepare input</span>
</span></span><span style="display:flex;"><span>innerInput <span style="color:#f92672">=</span> authCookie <span style="color:#f92672">||</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate random salt</span>
</span></span><span style="display:flex;"><span>innerSalt <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive encryption key and IV</span>
</span></span><span style="display:flex;"><span>keys <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>    salt<span style="color:#f92672">=</span>innerSalt,
</span></span><span style="display:flex;"><span>    ikm<span style="color:#f92672">=</span>innerInput,
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2_L2K&#34;</span>,  <span style="color:#75715e"># Domain separation</span>
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">=</span><span style="color:#ae81ff">44</span>  <span style="color:#75715e"># 32 bytes key + 12 bytes IV</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>innerKey <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>innerIV <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt and prepend salt</span>
</span></span><span style="display:flex;"><span>innerPlaintext <span style="color:#f92672">=</span> [Layer <span style="color:#ae81ff">2</span> data: LS2 type byte <span style="color:#f92672">+</span> LeaseSet2 data]
</span></span><span style="display:flex;"><span>innerCiphertext <span style="color:#f92672">=</span> innerSalt <span style="color:#f92672">||</span> ENCRYPT(innerKey, innerIV, innerPlaintext)
</span></span></code></pre></div><p><strong>المخرجات:</strong> <code>innerCiphertext</code> طوله <code>32 + len(innerPlaintext)</code> بايتًا.</p>
<p><strong>ربط المفتاح:</strong> - إذا لم تكن هناك مصادقة للعميل: يكون الارتباط فقط بـ subcredential و timestamp - إذا كانت مصادقة العميل مفعّلة: يكون الارتباط أيضاً بـ authCookie (مختلف لكل عميل مخوّل)</p>
<h4 id="خوارزمية-فك-التشفير-1">خوارزمية فك التشفير</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Determine authCookie (same as encryption)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> per_client_auth_enabled:
</span></span><span style="display:flex;"><span>    authCookie <span style="color:#f92672">=</span> [<span style="color:#ae81ff">32</span><span style="color:#f92672">-</span>byte cookie <span style="color:#f92672">from</span> client authorization process]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    authCookie <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>  <span style="color:#75715e"># Zero-length byte array</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Parse salt from ciphertext</span>
</span></span><span style="display:flex;"><span>innerSalt <span style="color:#f92672">=</span> innerCiphertext[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># First 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive decryption key and IV</span>
</span></span><span style="display:flex;"><span>innerInput <span style="color:#f92672">=</span> authCookie <span style="color:#f92672">||</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span>keys <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>    salt<span style="color:#f92672">=</span>innerSalt,
</span></span><span style="display:flex;"><span>    ikm<span style="color:#f92672">=</span>innerInput,
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2_L2K&#34;</span>,
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">=</span><span style="color:#ae81ff">44</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>innerKey <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>innerIV <span style="color:#f92672">=</span> keys[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Decrypt (skip salt bytes)</span>
</span></span><span style="display:flex;"><span>innerPlaintext <span style="color:#f92672">=</span> DECRYPT(innerKey, innerIV, innerCiphertext[<span style="color:#ae81ff">32</span>:end])
</span></span></code></pre></div><p><strong>التحقق:</strong> بعد فك التشفير: 1. التحقق من أن بايت نوع LS2 صالح (3 أو 7) 2. تحليل بنية LeaseSet2 3. التحقق من أن الطابع الزمني الداخلي يطابق الطابع الزمني المنشور الخارجي 4. التحقق من أن تاريخ الانقضاء الداخلي يطابق تاريخ الانقضاء الخارجي 5. التحقق من توقيع LeaseSet2</p>
<h3 id="ملخص-طبقة-التشفير">ملخص طبقة التشفير</h3>
<pre tabindex="0"><code>┌─────────────────────────────────────────────────┐
│ Layer 0 (Plaintext)                             │
│ - Blinded public key                            │
│ - Timestamps                                    │
│ - Signature                                     │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ Layer 1 (Encrypted with subcredential)  │   │
│  │ - Authorization flags                   │   │
│  │ - Client auth data (if enabled)         │   │
│  │                                          │   │
│  │  ┌────────────────────────────────┐     │   │
│  │  │ Layer 2 (Encrypted with        │     │   │
│  │  │          authCookie + subcred) │     │   │
│  │  │ - LeaseSet2 type               │     │   │
│  │  │ - LeaseSet2 data               │     │   │
│  │  │ - Leases                       │     │   │
│  │  │ - LS2 signature                │     │   │
│  │  └────────────────────────────────┘     │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
</code></pre><p><strong>تدفق فك التشفير:</strong> 1. تحقّق من توقيع الطبقة 0 باستخدام blinded public key (مفتاح عام بتعمية عمياء) 2. فك تشفير الطبقة 1 باستخدام subcredential (اعتماد فرعي) 3. قم بمعالجة بيانات التفويض (إن وُجدت) للحصول على authCookie (ملف تعريف ارتباط المصادقة) 4. فك تشفير الطبقة 2 باستخدام authCookie وsubcredential 5. تحقّق وحلّل LeaseSet2</p>
<hr>
<h2 id="تفويض-لكل-عميل">تفويض لكل عميل</h2>
<h3 id="نظرة-عامة-2">نظرة عامة</h3>
<p>عند تمكين التفويض على مستوى العميل، يحتفظ الخادم بقائمة بالعملاء المخوَّلين. يمتلك كل عميل بيانات مفاتيح يجب نقلها بأمان عبر out-of-band (خارج القناة الاعتيادية).</p>
<p><strong>آليتان للتخويل:</strong> 1. <strong>تخويل العميل بطريقة DH (Diffie-Hellman):</strong> أكثر أمانًا، يستخدم اتفاقية تبادل المفاتيح X25519 2. <strong>تخويل باستخدام PSK (Pre-Shared Key):</strong> أبسط، يستخدم مفاتيح متناظرة</p>
<p><strong>خصائص الأمان الشائعة:</strong> - خصوصية عضوية العملاء: يمكن للمراقبين رؤية عدد العملاء لكن لا يمكنهم تحديد عملاء بعينهم - إضافة/سحب العملاء بشكل مجهول: لا يمكن تتبّع وقت إضافة عملاء محدّدين أو إزالتهم - احتمال تصادم معرّف العميل المكوّن من 8 بايت: ~1 من كل 18 كوينتيليون (مهمل)</p>
<h3 id="تفويض-عميل-dh-diffie-hellman---تبادل-المفاتيح-ديفي-هيلمان">تفويض عميل DH (Diffie-Hellman - تبادل المفاتيح ديفي-هيلمان)</h3>
<p><strong>نظرة عامة:</strong> يولّد كل عميل زوج مفاتيح X25519 ويرسل مفتاحه العام إلى الخادم عبر قناة آمنة خارج النطاق. يستخدم الخادم تبادل مفاتيح ديفي-هيلمان المؤقت لتشفير قيمة authCookie فريدة لكل عميل.</p>
<h4 id="توليد-مفاتيح-العميل">توليد مفاتيح العميل</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Client generates keypair</span>
</span></span><span style="display:flex;"><span>csk_i <span style="color:#f92672">=</span> GENERATE_PRIVATE()  <span style="color:#75715e"># 32-byte X25519 private key</span>
</span></span><span style="display:flex;"><span>cpk_i <span style="color:#f92672">=</span> DERIVE_PUBLIC(csk_i)  <span style="color:#75715e"># 32-byte X25519 public key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Client sends cpk_i to server via secure out-of-band channel</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Client KEEPS csk_i secret (never transmitted)</span>
</span></span></code></pre></div><p><strong>ميزة أمنية:</strong> لا يغادر المفتاح الخاص للعميل جهازه مطلقًا. لا يستطيع خصمٌ يعترض الإرسال خارج القناة فك تشفير LeaseSets المُشفَّرة المستقبلية من دون كسر X25519 DH (خوارزمية تبادل المفاتيح ديفي-هيلمان X25519).</p>
<h4 id="المعالجة-على-الخادم">المعالجة على الخادم</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Server generates new auth cookie and ephemeral keypair</span>
</span></span><span style="display:flex;"><span>authCookie <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># 32-byte cookie</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>esk <span style="color:#f92672">=</span> GENERATE_PRIVATE()  <span style="color:#75715e"># 32-byte ephemeral private key</span>
</span></span><span style="display:flex;"><span>epk <span style="color:#f92672">=</span> DERIVE_PUBLIC(esk)  <span style="color:#75715e"># 32-byte ephemeral public key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For each authorized client i</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> cpk_i <span style="color:#f92672">in</span> authorized_clients:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform DH key agreement</span>
</span></span><span style="display:flex;"><span>    sharedSecret <span style="color:#f92672">=</span> DH(esk, cpk_i)  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive client-specific encryption key</span>
</span></span><span style="display:flex;"><span>    authInput <span style="color:#f92672">=</span> sharedSecret <span style="color:#f92672">||</span> cpk_i <span style="color:#f92672">||</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span>    okm <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>        salt<span style="color:#f92672">=</span>epk,  <span style="color:#75715e"># Ephemeral public key as salt</span>
</span></span><span style="display:flex;"><span>        ikm<span style="color:#f92672">=</span>authInput,
</span></span><span style="display:flex;"><span>        info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2_XCA&#34;</span>,  <span style="color:#75715e"># Domain separation</span>
</span></span><span style="display:flex;"><span>        n<span style="color:#f92672">=</span><span style="color:#ae81ff">52</span>  <span style="color:#75715e"># 32 key + 12 IV + 8 ID</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract components</span>
</span></span><span style="display:flex;"><span>    clientKey_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>    clientIV_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes</span>
</span></span><span style="display:flex;"><span>    clientID_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">44</span>:<span style="color:#ae81ff">51</span>]    <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Encrypt authCookie for this client</span>
</span></span><span style="display:flex;"><span>    clientCookie_i <span style="color:#f92672">=</span> ENCRYPT(clientKey_i, clientIV_i, authCookie)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Store [clientID_i, clientCookie_i] entry in Layer 1</span>
</span></span></code></pre></div><p><strong>بنية بيانات الطبقة 1:</strong></p>
<pre tabindex="0"><code>ephemeralPublicKey (32 bytes)
clients (2 bytes) = N
[clientID_1 (8 bytes) || clientCookie_1 (32 bytes)]
[clientID_2 (8 bytes) || clientCookie_2 (32 bytes)]
...
[clientID_N (8 bytes) || clientCookie_N (32 bytes)]
</code></pre><p><strong>توصيات الخادم:</strong> - أنشئ زوج مفاتيح مؤقت جديد لكل LeaseSet مشفّر منشور - اجعل ترتيب العملاء عشوائياً لمنع التتبع القائم على الموضع - فكّر في إضافة إدخالات وهمية لإخفاء العدد الحقيقي للعملاء</p>
<h4 id="معالجة-العميل">معالجة العميل</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Client has: csk_i (their private key), destination, date, secret</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Client receives: encrypted LeaseSet with epk in Layer 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Perform DH key agreement with server&#39;s ephemeral public key</span>
</span></span><span style="display:flex;"><span>sharedSecret <span style="color:#f92672">=</span> DH(csk_i, epk)  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive expected client identifier and decryption key</span>
</span></span><span style="display:flex;"><span>cpk_i <span style="color:#f92672">=</span> DERIVE_PUBLIC(csk_i)  <span style="color:#75715e"># Client&#39;s own public key</span>
</span></span><span style="display:flex;"><span>authInput <span style="color:#f92672">=</span> sharedSecret <span style="color:#f92672">||</span> cpk_i <span style="color:#f92672">||</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>okm <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>    salt<span style="color:#f92672">=</span>epk,
</span></span><span style="display:flex;"><span>    ikm<span style="color:#f92672">=</span>authInput,
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2_XCA&#34;</span>,
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">=</span><span style="color:#ae81ff">52</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clientKey_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>clientIV_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes</span>
</span></span><span style="display:flex;"><span>clientID_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">44</span>:<span style="color:#ae81ff">51</span>]    <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Search Layer 1 authorization data for clientID_i</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (clientID, clientCookie) <span style="color:#f92672">in</span> layer1_auth_entries:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> clientID <span style="color:#f92672">==</span> clientID_i:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Found matching entry, decrypt authCookie</span>
</span></span><span style="display:flex;"><span>        authCookie <span style="color:#f92672">=</span> DECRYPT(clientKey_i, clientIV_i, clientCookie)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Use authCookie to decrypt Layer 2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># No matching entry - client not authorized or revoked</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> AuthorizationError(<span style="color:#e6db74">&#34;Client not authorized&#34;</span>)
</span></span></code></pre></div><p><strong>التعامل مع أخطاء العميل:</strong> - إذا لم يتم العثور على <code>clientID_i</code>: تم سحب تفويض العميل أو لم يُخوَّل قط - إذا فشل فك التشفير: بيانات تالفة أو مفاتيح غير صحيحة (نادر جدًا) - ينبغي للعملاء إعادة الجلب دوريًا لاكتشاف سحب التفويض</p>
<h3 id="تفويض-العميل-عبر-psk-مفتاح-مسبق-المشاركة">تفويض العميل عبر PSK (مفتاح مُسبق المشاركة)</h3>
<p><strong>نظرة عامة:</strong> يمتلك كل عميل مفتاحاً متناظراً مشتركاً مسبقاً بطول 32 بايت. يقوم الخادم بتشفير نفس authCookie باستخدام PSK (مفتاح مشترك مسبقاً) الخاص بكل عميل.</p>
<h4 id="توليد-المفاتيح">توليد المفاتيح</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Option 1: Client generates key</span>
</span></span><span style="display:flex;"><span>psk_i <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># 32-byte pre-shared key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Client sends psk_i to server via secure out-of-band channel</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Option 2: Server generates key</span>
</span></span><span style="display:flex;"><span>psk_i <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># 32-byte pre-shared key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Server sends psk_i to one or more clients via secure out-of-band channel</span>
</span></span></code></pre></div><p><strong>ملاحظة أمنية:</strong> يمكن مشاركة PSK (مفتاح مشترك مُسبقًا) نفسه بين عدة عملاء عند الرغبة (مما يُنشئ تفويضًا من نوع &ldquo;مجموعة&rdquo;).</p>
<h4 id="معالجة-الخادم">معالجة الخادم</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Server generates new auth cookie and salt</span>
</span></span><span style="display:flex;"><span>authCookie <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># 32-byte cookie</span>
</span></span><span style="display:flex;"><span>authSalt <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)     <span style="color:#75715e"># 32-byte salt</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For each authorized client i</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> psk_i <span style="color:#f92672">in</span> authorized_clients:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive client-specific encryption key</span>
</span></span><span style="display:flex;"><span>    authInput <span style="color:#f92672">=</span> psk_i <span style="color:#f92672">||</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    okm <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>        salt<span style="color:#f92672">=</span>authSalt,
</span></span><span style="display:flex;"><span>        ikm<span style="color:#f92672">=</span>authInput,
</span></span><span style="display:flex;"><span>        info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2PSKA&#34;</span>,  <span style="color:#75715e"># Domain separation</span>
</span></span><span style="display:flex;"><span>        n<span style="color:#f92672">=</span><span style="color:#ae81ff">52</span>  <span style="color:#75715e"># 32 key + 12 IV + 8 ID</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract components</span>
</span></span><span style="display:flex;"><span>    clientKey_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>    clientIV_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes</span>
</span></span><span style="display:flex;"><span>    clientID_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">44</span>:<span style="color:#ae81ff">51</span>]    <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Encrypt authCookie for this client</span>
</span></span><span style="display:flex;"><span>    clientCookie_i <span style="color:#f92672">=</span> ENCRYPT(clientKey_i, clientIV_i, authCookie)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Store [clientID_i, clientCookie_i] entry in Layer 1</span>
</span></span></code></pre></div><p><strong>بنية بيانات الطبقة 1:</strong></p>
<pre tabindex="0"><code>authSalt (32 bytes)
clients (2 bytes) = N
[clientID_1 (8 bytes) || clientCookie_1 (32 bytes)]
[clientID_2 (8 bytes) || clientCookie_2 (32 bytes)]
...
[clientID_N (8 bytes) || clientCookie_N (32 bytes)]
</code></pre><h4 id="معالجة-العميل-1">معالجة العميل</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Client has: psk_i (their pre-shared key), destination, date, secret</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Client receives: encrypted LeaseSet with authSalt in Layer 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive expected client identifier and decryption key</span>
</span></span><span style="display:flex;"><span>authInput <span style="color:#f92672">=</span> psk_i <span style="color:#f92672">||</span> subcredential <span style="color:#f92672">||</span> publishedTimestamp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>okm <span style="color:#f92672">=</span> HKDF(
</span></span><span style="display:flex;"><span>    salt<span style="color:#f92672">=</span>authSalt,
</span></span><span style="display:flex;"><span>    ikm<span style="color:#f92672">=</span>authInput,
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ELS2PSKA&#34;</span>,
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">=</span><span style="color:#ae81ff">52</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clientKey_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>clientIV_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">43</span>]    <span style="color:#75715e"># 12 bytes</span>
</span></span><span style="display:flex;"><span>clientID_i <span style="color:#f92672">=</span> okm[<span style="color:#ae81ff">44</span>:<span style="color:#ae81ff">51</span>]    <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Search Layer 1 authorization data for clientID_i</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (clientID, clientCookie) <span style="color:#f92672">in</span> layer1_auth_entries:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> clientID <span style="color:#f92672">==</span> clientID_i:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Found matching entry, decrypt authCookie</span>
</span></span><span style="display:flex;"><span>        authCookie <span style="color:#f92672">=</span> DECRYPT(clientKey_i, clientIV_i, clientCookie)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Use authCookie to decrypt Layer 2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># No matching entry - client not authorized or revoked</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> AuthorizationError(<span style="color:#e6db74">&#34;Client not authorized&#34;</span>)
</span></span></code></pre></div><h3 id="المقارنة-والتوصيات">المقارنة والتوصيات</h3>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Feature</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">DH Authorization</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">PSK Authorization</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Key Exchange</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Asymmetric (X25519)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Symmetric (shared secret)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Security</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Higher (forward secrecy)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Lower (depends on PSK secrecy)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Client Privacy</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Private key never transmitted</td><td style="border:1px solid var(--color-border); padding:0.5rem;">PSK must be transmitted securely</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Performance</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">N+1 DH operations</td><td style="border:1px solid var(--color-border); padding:0.5rem;">No DH operations</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Key Sharing</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">One key per client</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Can share key among multiple clients</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Revocation Detection</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Adversary cannot tell when revoked</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Adversary can track revocation if PSK intercepted</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Use Case</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">High security requirements</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Performance-critical or group access</td></tr>
  </tbody>
</table>
**التوصية:** - **Use DH authorization** (تفويض باستخدام Diffie-Hellman) للتطبيقات عالية الأمان حيث تكون السرية الأمامية مهمة - **Use PSK authorization** (تفويض بالمفتاح المشترك مسبقاً) عندما يكون الأداء بالغ الأهمية أو عند إدارة مجموعات العملاء - **لا تُعِد استخدام PSKs** عبر خدمات مختلفة أو فترات زمنية مختلفة - **استخدم دائمًا قنوات آمنة** لتوزيع المفاتيح (مثل Signal, OTR, PGP)
<h3 id="الاعتبارات-الأمنية">الاعتبارات الأمنية</h3>
<p><strong>خصوصية عضوية العميل:</strong></p>
<p>كلتا الآليتين توفّران الخصوصية لعضوية العميل من خلال: 1. <strong>معرّفات العميل المشفّرة:</strong> clientID بطول 8 بايت مُشتق من ناتج HKDF (دالة اشتقاق مفاتيح مستندة إلى HMAC) 2. <strong>ملفات تعريف الارتباط غير القابلة للتمييز:</strong> تبدو جميع قيم clientCookie بطول 32 بايت عشوائية 3. <strong>لا توجد بيانات وصفية خاصة بعميل معيّن:</strong> لا توجد طريقة لتحديد أي إدخال يعود إلى أي عميل</p>
<p>يمكن للمراقب أن يرى:</p>
<ul>
<li>عدد العملاء المصرّح لهم (من الحقل <code>clients</code>)</li>
<li>التغيرات في عدد العملاء مع مرور الوقت</li>
</ul>
<p>لا يمكن للمراقب رؤية: - أي العملاء المحددين مخولون - متى تتم إضافة عملاء محددين أو حذفهم (إذا بقي العدد كما هو) - أي معلومات تحدد هوية العميل</p>
<p><strong>توصيات بشأن العشوائية:</strong></p>
<p>يُستحسن أن تُعيد الخوادم ترتيب العملاء بصورة عشوائية في كل مرة تُولِّد فيها LeaseSet مُشفّراً:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Before serializing</span>
</span></span><span style="display:flex;"><span>auth_entries <span style="color:#f92672">=</span> [(clientID_i, clientCookie_i) <span style="color:#66d9ef">for</span> each client]
</span></span><span style="display:flex;"><span>random<span style="color:#f92672">.</span>shuffle(auth_entries)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Now serialize in randomized order</span>
</span></span></code></pre></div><p><strong>الفوائد:</strong> - يمنع العملاء من معرفة موقعهم في القائمة - يمنع هجمات الاستدلال القائمة على التغيرات في الموضع - يجعل إضافة/إبطال العملاء غير قابلة للتمييز</p>
<p><strong>إخفاء عدد العملاء:</strong></p>
<p>يجوز أن تقوم الخوادم بإدراج إدخالات وهمية عشوائية:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Add dummy entries</span>
</span></span><span style="display:flex;"><span>num_dummies <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, max_dummies)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(num_dummies):
</span></span><span style="display:flex;"><span>    dummy_id <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>    dummy_cookie <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    auth_entries<span style="color:#f92672">.</span>append((dummy_id, dummy_cookie))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Randomize all entries (real + dummy)</span>
</span></span><span style="display:flex;"><span>random<span style="color:#f92672">.</span>shuffle(auth_entries)
</span></span></code></pre></div><p><strong>التكلفة:</strong> تزيد المدخلات الوهمية حجم LeaseSet المشفّر (40 بايت لكلٍّ منها).</p>
<p><strong>تدوير AuthCookie (ملف تعريف الارتباط الخاص بالمصادقة):</strong></p>
<p>ينبغي أن تقوم الخوادم بإنشاء authCookie جديد: - في كل مرة يتم فيها نشر LeaseSet مشفر (كل بضع ساعات عادة) - مباشرة بعد إلغاء تفويض عميل - وفق جدول منتظم (مثلاً يومياً) حتى إن لم تطرأ أي تغييرات على العملاء</p>
<p><strong>الفوائد:</strong> - يحد من التعرض إذا تم اختراق authCookie - يضمن أن العملاء الذين أُلغيت صلاحياتهم يفقدون الوصول بسرعة - يوفر سرية أمامية للطبقة الثانية</p>
<hr>
<h2 id="العنونة-بـ-base32-لـ-leasesets-المشفرة">العنونة بـ Base32 لـ LeaseSets المشفرة</h2>
<h3 id="نظرة-عامة-3">نظرة عامة</h3>
<p>عناوين I2P التقليدية بصيغة base32 تحتوي فقط على تجزئة Destination (الوجهة) (32 بايت → 52 حرفًا). وهذا غير كافٍ بالنسبة إلى LeaseSets المشفّرة للأسباب التالية:</p>
<ol>
<li>يحتاج العملاء إلى <strong>المفتاح العام غير المُعمّى (non-blinded public key)</strong> لاشتقاق المفتاح العام المُعمّى (blinded public key)</li>
<li>يحتاج العملاء إلى <strong>أنواع التوقيع (signature types)</strong> (غير مُعمّى ومُعمّى) للاشتقاق الصحيح للمفاتيح</li>
<li>لا توفّر التجزئة وحدها هذه المعلومات</li>
</ol>
<p><strong>الحل:</strong> صيغة base32 (ترميز بقاعدة 32) جديدة تتضمن المفتاح العام وأنواع التوقيع.</p>
<h3 id="مواصفة-صيغة-العنوان">مواصفة صيغة العنوان</h3>
<p><strong>البنية بعد فك الترميز (35 بايت):</strong></p>
<pre tabindex="0"><code>┌─────────────────────────────────────────────────────┐
│ Byte 0   │ Byte 1  │ Byte 2  │ Bytes 3-34          │
│ Flags    │ Unblind │ Blinded │ Public Key          │
│ (XOR)    │ SigType │ SigType │ (32 bytes)          │
│          │ (XOR)   │ (XOR)   │                     │
└─────────────────────────────────────────────────────┘
</code></pre><p><strong>أول 3 بايتات (XOR (أو الحصري) مع المجموع الاختباري):</strong></p>
<p>تحتوي أول 3 بايتات على بيانات وصفية طُبِّق عليها XOR (أو الحصري) مع أجزاء من قيمة فحص CRC-32:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Data structure before XOR</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00</span>           <span style="color:#75715e"># 1 byte (reserved for future use)</span>
</span></span><span style="display:flex;"><span>unblinded_sigtype <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x07</span> <span style="color:#f92672">or</span> <span style="color:#ae81ff">0x0b</span>  <span style="color:#75715e"># 1 byte (7 or 11)</span>
</span></span><span style="display:flex;"><span>blinded_sigtype <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0b</span>  <span style="color:#75715e"># 1 byte (always 11)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Compute CRC-32 checksum of public key</span>
</span></span><span style="display:flex;"><span>checksum <span style="color:#f92672">=</span> crc32(pubkey)  <span style="color:#75715e"># 4-byte CRC-32 of bytes 3-34</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># XOR first 3 bytes with parts of checksum</span>
</span></span><span style="display:flex;"><span>data[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> flags XOR (checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>
</span></span><span style="display:flex;"><span>data[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> unblinded_sigtype XOR (checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>  
</span></span><span style="display:flex;"><span>data[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> blinded_sigtype XOR (checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bytes 3-34 contain the unmodified 32-byte public key</span>
</span></span><span style="display:flex;"><span>data[<span style="color:#ae81ff">3</span>:<span style="color:#ae81ff">34</span>] <span style="color:#f92672">=</span> pubkey
</span></span></code></pre></div><p><strong>خصائص المجموع الاختباري:</strong> - يستخدم متعدد الحدود القياسي CRC-32 - معدل السلبية الكاذبة: ~1 من كل 16 مليون - يكتشف أخطاء الكتابة في العناوين - لا يمكن استخدامه للمصادقة (غير آمن تشفيرياً)</p>
<p><strong>التنسيق المُرمَّز:</strong></p>
<pre tabindex="0"><code>Base32Encode(35 bytes) || &#34;.b32.i2p&#34;
</code></pre><p><strong>الخصائص:</strong> - إجمالي عدد الأحرف: 56 (35 بايت × 8 بت ÷ 5 بت لكل حرف) - اللاحقة: &ldquo;.b32.i2p&rdquo; (مطابقة لـ base32 التقليدية) - الطول الإجمالي: 56 + 8 = 64 حرفًا (باستثناء null terminator (محرف الإنهاء الفارغ))</p>
<p><strong>ترميز Base32:</strong> - الأبجدية: <code>abcdefghijklmnopqrstuvwxyz234567</code> (المعيار RFC 4648) - يجب أن تكون 5 بتات غير مستخدمة في النهاية تساوي 0 - غير حساس لحالة الأحرف (تقليدياً بالأحرف الصغيرة)</p>
<h3 id="توليد-العناوين">توليد العناوين</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> struct
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> zlib <span style="color:#f92672">import</span> crc32
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_encrypted_b32_address</span>(pubkey, unblinded_sigtype, blinded_sigtype):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Generate base32 address for encrypted LeaseSet.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pubkey: 32-byte public key (bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        unblinded_sigtype: Unblinded signature type (7 or 11)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        blinded_sigtype: Blinded signature type (always 11)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        String address ending in .b32.i2p
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Verify inputs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> len(pubkey) <span style="color:#f92672">==</span> <span style="color:#ae81ff">32</span>, <span style="color:#e6db74">&#34;Public key must be 32 bytes&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> unblinded_sigtype <span style="color:#f92672">in</span> [<span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">11</span>], <span style="color:#e6db74">&#34;Unblinded sigtype must be 7 or 11&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> blinded_sigtype <span style="color:#f92672">==</span> <span style="color:#ae81ff">11</span>, <span style="color:#e6db74">&#34;Blinded sigtype must be 11&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Compute CRC-32 of public key</span>
</span></span><span style="display:flex;"><span>    checksum <span style="color:#f92672">=</span> crc32(pubkey) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFF</span>  <span style="color:#75715e"># Ensure 32-bit unsigned</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Prepare metadata bytes</span>
</span></span><span style="display:flex;"><span>    flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># XOR metadata with checksum parts</span>
</span></span><span style="display:flex;"><span>    byte0 <span style="color:#f92672">=</span> flags <span style="color:#f92672">^</span> ((checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>)
</span></span><span style="display:flex;"><span>    byte1 <span style="color:#f92672">=</span> unblinded_sigtype <span style="color:#f92672">^</span> ((checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>)
</span></span><span style="display:flex;"><span>    byte2 <span style="color:#f92672">=</span> blinded_sigtype <span style="color:#f92672">^</span> ((checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Construct 35-byte data</span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> bytes([byte0, byte1, byte2]) <span style="color:#f92672">+</span> pubkey
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Base32 encode (standard alphabet)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Python&#39;s base64 module uses uppercase by default</span>
</span></span><span style="display:flex;"><span>    b32 <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b32encode(data)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;ascii&#39;</span>)<span style="color:#f92672">.</span>lower()<span style="color:#f92672">.</span>rstrip(<span style="color:#e6db74">&#39;=&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Construct full address</span>
</span></span><span style="display:flex;"><span>    address <span style="color:#f92672">=</span> b32 <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.b32.i2p&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> address
</span></span></code></pre></div><h3 id="تحليل-العناوين">تحليل العناوين</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> struct
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> zlib <span style="color:#f92672">import</span> crc32
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse_encrypted_b32_address</span>(address):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Parse base32 address for encrypted LeaseSet.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        address: String address ending in .b32.i2p
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Tuple of (pubkey, unblinded_sigtype, blinded_sigtype)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Raises:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ValueError: If address is invalid or checksum fails
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Remove suffix</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> address<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#39;.b32.i2p&#39;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Invalid address suffix&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    b32 <span style="color:#f92672">=</span> address[:<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>]  <span style="color:#75715e"># Remove &#34;.b32.i2p&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Verify length (56 characters for 35 bytes)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(b32) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">56</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid length: </span><span style="color:#e6db74">{</span>len(b32)<span style="color:#e6db74">}</span><span style="color:#e6db74"> (expected 56)&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Base32 decode</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Add padding if needed</span>
</span></span><span style="display:flex;"><span>    padding_needed <span style="color:#f92672">=</span> (<span style="color:#ae81ff">8</span> <span style="color:#f92672">-</span> (len(b32) <span style="color:#f92672">%</span> <span style="color:#ae81ff">8</span>)) <span style="color:#f92672">%</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    b32_padded <span style="color:#f92672">=</span> b32<span style="color:#f92672">.</span>upper() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;=&#39;</span> <span style="color:#f92672">*</span> padding_needed
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b32decode(b32_padded)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid base32 encoding: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Verify decoded length</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(data) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">35</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid decoded length: </span><span style="color:#e6db74">{</span>len(data)<span style="color:#e6db74">}</span><span style="color:#e6db74"> (expected 35)&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract public key</span>
</span></span><span style="display:flex;"><span>    pubkey <span style="color:#f92672">=</span> data[<span style="color:#ae81ff">3</span>:<span style="color:#ae81ff">35</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Compute CRC-32 for verification</span>
</span></span><span style="display:flex;"><span>    checksum <span style="color:#f92672">=</span> crc32(pubkey) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFF</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Un-XOR metadata bytes</span>
</span></span><span style="display:flex;"><span>    flags <span style="color:#f92672">=</span> data[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">^</span> ((checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>)
</span></span><span style="display:flex;"><span>    unblinded_sigtype <span style="color:#f92672">=</span> data[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">^</span> ((checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>)
</span></span><span style="display:flex;"><span>    blinded_sigtype <span style="color:#f92672">=</span> data[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">^</span> ((checksum <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Verify expected values</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> flags <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x00</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid flags: </span><span style="color:#e6db74">{</span>flags<span style="color:#e6db74">:</span><span style="color:#e6db74">#x</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> (expected 0x00)&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> unblinded_sigtype <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> [<span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">11</span>]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid unblinded sigtype: </span><span style="color:#e6db74">{</span>unblinded_sigtype<span style="color:#e6db74">}</span><span style="color:#e6db74"> (expected 7 or 11)&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> blinded_sigtype <span style="color:#f92672">!=</span> <span style="color:#ae81ff">11</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid blinded sigtype: </span><span style="color:#e6db74">{</span>blinded_sigtype<span style="color:#e6db74">}</span><span style="color:#e6db74"> (expected 11)&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pubkey, unblinded_sigtype, blinded_sigtype
</span></span></code></pre></div><h3 id="مقارنة-مع-base32-التقليدي">مقارنة مع Base32 التقليدي</h3>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Feature</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Traditional B32</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Encrypted LS2 B32</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Content</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">SHA-256 hash of Destination</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Public key + signature types</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Decoded Size</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">32 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">35 bytes</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Encoded Length</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">52 characters</td><td style="border:1px solid var(--color-border); padding:0.5rem;">56 characters</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Suffix</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">.b32.i2p</td><td style="border:1px solid var(--color-border); padding:0.5rem;">.b32.i2p</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Total Length</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">60 chars</td><td style="border:1px solid var(--color-border); padding:0.5rem;">64 chars</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Checksum</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">None</td><td style="border:1px solid var(--color-border); padding:0.5rem;">CRC-32 (XOR'd into first 3 bytes)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>Use Case</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Regular destinations</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Encrypted LeaseSet destinations</td></tr>
  </tbody>
</table>
### قيود الاستخدام
<p><strong>عدم التوافق مع BitTorrent:</strong></p>
<p>لا يمكن استخدام عناوين LS2 المشفّرة مع ردود الإعلان المدمجة الخاصة بـ BitTorrent:</p>
<pre tabindex="0"><code>Compact announce reply format:
┌────────────────────────────┐
│ 32-byte destination hash   │  ← Only hash, no signature types
│ 2-byte port                │
└────────────────────────────┘
</code></pre><p><strong>المشكلة:</strong> التنسيق الموجز يحتوي فقط على التجزئة (32 بايت)، ولا يوفّر مساحة لأنواع التوقيع أو معلومات المفتاح العام.</p>
<p><strong>الحل:</strong> استخدم ردود announce (رسالة الإعلان في متتبّع BitTorrent) الكاملة أو متتبّعات قائمة على HTTP تدعم العناوين الكاملة.</p>
<h3 id="تكامل-دفتر-العناوين">تكامل دفتر العناوين</h3>
<p>إذا كان لدى عميل Destination الكامل (معرّف الوجهة في I2P) في دفتر عناوين:</p>
<ol>
<li>خزّن Destination (الوجهة) الكامل (يتضمن المفتاح العام)</li>
<li>ادعم البحث العكسي حسب التجزئة</li>
<li>عند مواجهة LS2 مشفّر، استرجع المفتاح العام من دفتر العناوين</li>
<li>لا حاجة إلى صيغة base32 جديدة إذا كان Destination الكامل معروف مسبقًا</li>
</ol>
<p><strong>تنسيقات دفتر العناوين التي تدعم LS2 المُشفَّر:</strong> - hosts.txt مع سلاسل الوجهة الكاملة - قواعد بيانات SQLite مع عمود الوجهة - تنسيقات JSON/XML مع بيانات الوجهة الكاملة</p>
<h3 id="أمثلة-على-التنفيذ">أمثلة على التنفيذ</h3>
<p><strong>مثال 1: توليد عنوان</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Ed25519 destination example</span>
</span></span><span style="display:flex;"><span>pubkey <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">64</span>)  <span style="color:#75715e"># 32-byte public key</span>
</span></span><span style="display:flex;"><span>unblinded_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>   <span style="color:#75715e"># Ed25519</span>
</span></span><span style="display:flex;"><span>blinded_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>    <span style="color:#75715e"># Red25519 (always)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>address <span style="color:#f92672">=</span> generate_encrypted_b32_address(pubkey, unblinded_type, blinded_type)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Address: </span><span style="color:#e6db74">{</span>address<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Output: 56 base32 characters + .b32.i2p</span>
</span></span></code></pre></div><p><strong>مثال 2: التحليل والتحقق</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>address <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;abc...xyz.b32.i2p&#34;</span>  <span style="color:#75715e"># 56 chars + suffix</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    pubkey, unblinded, blinded <span style="color:#f92672">=</span> parse_encrypted_b32_address(address)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Public Key: </span><span style="color:#e6db74">{</span>pubkey<span style="color:#f92672">.</span>hex()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Unblinded SigType: </span><span style="color:#e6db74">{</span>unblinded<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Blinded SigType: </span><span style="color:#e6db74">{</span>blinded<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ValueError</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid address: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p><strong>مثال 3: التحويل من Destination (الوجهة في I2P)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">destination_to_encrypted_b32</span>(destination):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Convert full Destination to encrypted LS2 base32 address.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        destination: I2P Destination object
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Base32 address string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract public key and signature type from destination</span>
</span></span><span style="display:flex;"><span>    pubkey <span style="color:#f92672">=</span> destination<span style="color:#f92672">.</span>signing_public_key  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>    sigtype <span style="color:#f92672">=</span> destination<span style="color:#f92672">.</span>sig_type  <span style="color:#75715e"># 7 or 11</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Blinded type is always 11 (Red25519)</span>
</span></span><span style="display:flex;"><span>    blinded_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate address</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> generate_encrypted_b32_address(pubkey, sigtype, blinded_type)
</span></span></code></pre></div><h3 id="اعتبارات-الأمان">اعتبارات الأمان</h3>
<p><strong>الخصوصية:</strong> - يكشف عنوان Base32 المفتاح العام - هذا مقصود ومطلوب من أجل البروتوكول - لا يكشف المفتاح الخاص ولا يعرّض الأمان للخطر - المفاتيح العامة معلومات علنية بطبيعتها</p>
<p><strong>مقاومة التصادم:</strong> - يوفر CRC-32 32 بتًا فقط من مقاومة التصادم - غير آمن من الناحية التشفيرية (يُستخدم للكشف عن الأخطاء فقط) - لا تعتمد إطلاقًا على المجموع الاختباري للمصادقة - لا يزال التحقق الكامل من الوجهة مطلوبًا</p>
<p><strong>التحقق من صحة العنوان:</strong> - تحقق دائمًا من المجموع الاختباري (checksum) قبل الاستخدام - ارفض العناوين ذات أنواع التوقيع غير الصالحة - تحقق من أن المفتاح العام يقع على المنحنى (خاص بالتنفيذ)</p>
<p><strong>المراجع:</strong> - <a href="../../../../ar/proposals/149-b32-encrypted-ls2/">المقترح 149: B32 لـ LS2 المشفّر</a>
 - <a href="../../../../ar/docs/specs/b32-for-encrypted-leasesets/">مواصفة عنونة B32</a>
 - <a href="../../../../ar/docs/overview/naming/">مواصفة التسمية لـ I2P</a>
</p>
<hr>
<h2 id="دعم-المفاتيح-غير-المتصلة">دعم المفاتيح غير المتصلة</h2>
<h3 id="نظرة-عامة-4">نظرة عامة</h3>
<p>تتيح المفاتيح غير المتصلة بالإنترنت إبقاء مفتاح التوقيع الرئيسي غير متصل بالإنترنت (التخزين البارد)، بينما يُستخدم مفتاح توقيع مؤقت للعمليات اليومية. يُعدّ ذلك بالغ الأهمية للخدمات عالية الأمان.</p>
<p><strong>متطلبات خاصة بـ LS2 المشفّر:</strong> - يجب توليد المفاتيح المؤقتة دون اتصال بالإنترنت - يجب توليد المفاتيح الخاصة المُعمّاة (blinded) مسبقاً (مفتاح واحد يومياً) - تُسلَّم كلّ من المفاتيح المؤقتة والمفاتيح المُعمّاة على دفعات - لم يُحدَّد بعد معيار موحّد لصيغة الملف (TODO في المواصفة)</p>
<h3 id="بنية-المفاتيح-دون-اتصال">بنية المفاتيح دون اتصال</h3>
<p><strong>بيانات المفتاح المؤقتة للطبقة 0 (عندما يكون بت العلم 0 = 1):</strong></p>
<pre tabindex="0"><code>┌───────────────────────────────────────────────────┐
│ Expires Timestamp       │ 4 bytes (seconds)       │
│ Transient Sig Type      │ 2 bytes (big endian)    │
│ Transient Signing Pubkey│ Variable (sigtype len)  │
│ Signature (by blinded)  │ 64 bytes (Red25519)     │
└───────────────────────────────────────────────────┘
</code></pre><p><strong>تغطية التوقيع:</strong> يغطي التوقيع في كتلة المفتاح غير المتصل: - الطابع الزمني لانتهاء الصلاحية (4 بايتات) - نوع التوقيع المؤقت (2 بايتين)   - مفتاح التوقيع العام المؤقت (متغير)</p>
<p>يتم التحقق من هذا التوقيع باستخدام <strong>blinded public key</strong> (مفتاح عام خضع لتقنية التعمية العمياء)، مما يثبت أن الكيان الذي يمتلك blinded private key (مفتاح خاص خضع لتقنية التعمية العمياء) قد أجاز هذا المفتاح المؤقت.</p>
<h3 id="عملية-توليد-المفاتيح">عملية توليد المفاتيح</h3>
<p><strong>بالنسبة إلى LeaseSet مُشفَّر بمفاتيح غير متصلة:</strong></p>
<ol>
<li>
<p><strong>أنشئ أزواج مفاتيح مؤقتة</strong> (بدون اتصال، في التخزين البارد):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># For each day in future</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> date <span style="color:#f92672">in</span> future_dates:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate daily transient keypair</span>
</span></span><span style="display:flex;"><span>    transient_privkey <span style="color:#f92672">=</span> generate_red25519_privkey()  <span style="color:#75715e"># Type 11</span>
</span></span><span style="display:flex;"><span>    transient_pubkey <span style="color:#f92672">=</span> derive_public(transient_privkey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Store for later delivery</span>
</span></span><span style="display:flex;"><span>    keys[date] <span style="color:#f92672">=</span> (transient_privkey, transient_pubkey)
</span></span></code></pre></div></li>
<li>
<p><strong>Generate daily blinded keypairs</strong> (offline, in cold storage):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div></li>
</ol>
<h1 id="لكل-يوم----for-date-in-future_dates">لكل يوم    for date in future_dates:</h1>
<pre><code>   # Derive alpha for this date
   datestring = date.strftime(&quot;%Y%m%d&quot;)  # &quot;YYYYMMDD&quot;
   alpha = GENERATE_ALPHA(destination, datestring, secret)
   
   # Blind the signing private key
   a = destination_signing_privkey  # Type 7 or 11
   blinded_privkey = BLIND_PRIVKEY(a, alpha)  # Result is type 11
   blinded_pubkey = DERIVE_PUBLIC(blinded_privkey)
   
   # Store for later delivery
   blinded_keys[date] = (blinded_privkey, blinded_pubkey)
</code></pre>
<pre tabindex="0"><code>
3. **Sign transient keys with blinded keys** (offline):
```python
for date in future_dates:

    transient_pubkey = keys[date][1]
    blinded_privkey = blinded_keys[date][0]
    
    # Create signature data
    expires = int((date + timedelta(days=1)).timestamp())
    sig_data = struct.pack(&#39;&gt;I&#39;, expires)  # 4 bytes
    sig_data += struct.pack(&#39;&gt;H&#39;, 11)     # Transient type (Red25519)
    sig_data += transient_pubkey          # 32 bytes
    
    # Sign with blinded private key
    signature = RED25519_SIGN(blinded_privkey, sig_data)
    
    # Package for delivery
    offline_sig_blocks[date] = {
        &#39;expires&#39;: expires,
        &#39;transient_type&#39;: 11,
        &#39;transient_pubkey&#39;: transient_pubkey,
        &#39;signature&#39;: signature
    }
</code></pre><ol start="4">
<li><strong>Package for delivery to router:</strong>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div></li>
</ol>
<h1 id="لكل-تاريخ----delivery_packagedate--">لكل تاريخ    delivery_package[date] = {</h1>
<pre><code>   'transient_privkey': keys[date][0],
   'transient_pubkey': keys[date][1],
   'blinded_privkey': blinded_keys[date][0],
   'blinded_pubkey': blinded_keys[date][1],
   'offline_sig_block': offline_sig_blocks[date]
</code></pre>
<p>}</p>
<pre tabindex="0"><code>
### Router Usage

**Daily Key Loading:**

```python
# عند منتصف الليل بتوقيت UTC (أو قبل النشر)

date = datetime.utcnow().date()

# حمّل مفاتيح اليوم

today_keys = load_delivery_package(date)

transient_privkey = today_keys[&#39;transient_privkey&#39;] transient_pubkey = today_keys[&#39;transient_pubkey&#39;] blinded_privkey = today_keys[&#39;blinded_privkey&#39;] blinded_pubkey = today_keys[&#39;blinded_pubkey&#39;] offline_sig_block = today_keys[&#39;offline_sig_block&#39;]

# استخدم هذه المفاتيح لـ LeaseSet المشفّر لهذا اليوم
</code></pre><p><strong>Publishing Process:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 1. أنشئ LeaseSet2 داخلي</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>inner_ls2 <span style="color:#f92672">=</span> create_leaseset2(
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    destinations, leases, expires, 
</span></span><span style="display:flex;"><span>    signing_key<span style="color:#f92672">=</span>transient_privkey  <span style="color:#75715e"># Use transient key</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. تشفير الطبقة الثانية</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>layer2_ciphertext <span style="color:#f92672">=</span> encrypt_layer2(inner_ls2, authCookie, subcredential, timestamp)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. أنشئ الطبقة الأولى مع بيانات التخويل</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>layer1_plaintext <span style="color:#f92672">=</span> create_layer1(authorization_data, layer2_ciphertext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. شفّر الطبقة 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>layer1_ciphertext <span style="color:#f92672">=</span> encrypt_layer1(layer1_plaintext, subcredential, timestamp)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. أنشئ الطبقة 0 مع كتلة توقيع دون اتصال</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>layer0 <span style="color:#f92672">=</span> create_layer0(
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    blinded_pubkey,
</span></span><span style="display:flex;"><span>    timestamp,
</span></span><span style="display:flex;"><span>    expires,
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0001</span>,  <span style="color:#75715e"># Bit 0 set (offline keys present)</span>
</span></span><span style="display:flex;"><span>    offline_sig_block<span style="color:#f92672">=</span>offline_sig_block,
</span></span><span style="display:flex;"><span>    layer1_ciphertext<span style="color:#f92672">=</span>layer1_ciphertext
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6. وقّع الطبقة 0 باستخدام مفتاح خاص مؤقت</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>signature <span style="color:#f92672">=</span> RED25519_SIGN(transient_privkey, layer0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 7. ألحِق التوقيع ثم انشر</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>encrypted_leaseset <span style="color:#f92672">=</span> layer0 <span style="color:#f92672">+</span> signature publish_to_netdb(encrypted_leaseset)
</span></span></code></pre></div><h3 id="security-considerations">Security Considerations</h3>
<p><strong>Tracking via Offline Signature Block:</strong></p>
<p>The offline signature block is in plaintext (Layer 0). An adversary scraping floodfills could:</p>
<ul>
<li>Track the same encrypted LeaseSet across multiple days</li>
<li>Correlate encrypted LeaseSets even though blinded keys change daily</li>
</ul>
<p><strong>Mitigation:</strong> Generate new transient keys daily (in addition to blinded keys):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ولّد كلاً من المفاتيح المؤقتة الجديدة والمفاتيح المُعمّاة الجديدة يومياً</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> date <span style="color:#f92672">in</span> future_dates:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># New transient keypair for this day</span>
</span></span><span style="display:flex;"><span>    transient_privkey <span style="color:#f92672">=</span> generate_red25519_privkey()
</span></span><span style="display:flex;"><span>    transient_pubkey <span style="color:#f92672">=</span> derive_public(transient_privkey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># New blinded keypair for this day</span>
</span></span><span style="display:flex;"><span>    alpha <span style="color:#f92672">=</span> GENERATE_ALPHA(destination, datestring, secret)
</span></span><span style="display:flex;"><span>    blinded_privkey <span style="color:#f92672">=</span> BLIND_PRIVKEY(signing_privkey, alpha)
</span></span><span style="display:flex;"><span>    blinded_pubkey <span style="color:#f92672">=</span> DERIVE_PUBLIC(blinded_privkey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Sign new transient key with new blinded key</span>
</span></span><span style="display:flex;"><span>    sig <span style="color:#f92672">=</span> RED25519_SIGN(blinded_privkey, transient_pubkey <span style="color:#f92672">||</span> metadata)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Now offline sig block changes daily</span>
</span></span></code></pre></div><p><strong>Benefits:</strong></p>
<ul>
<li>Prevents tracking across days via offline signature block</li>
<li>Provides same security as encrypted LS2 without offline keys</li>
<li>Each day appears completely independent</li>
</ul>
<p><strong>Cost:</strong></p>
<ul>
<li>More keys to generate and store</li>
<li>More complex key management</li>
</ul>
<h3 id="file-format-todo">File Format (TODO)</h3>
<p><strong>Current Status:</strong> No standardized file format defined for batch key delivery.</p>
<p><strong>Requirements for Future Format:</strong></p>
<ol>
<li>
<p><strong>Must support multiple dates:</strong></p>
<ul>
<li>Batch delivery of 30+ days worth of keys</li>
<li>Clear date association for each key set</li>
</ul>
</li>
<li>
<p><strong>Must include all necessary data:</strong></p>
<ul>
<li>Transient private key</li>
<li>Transient public key</li>
<li>Blinded private key</li>
<li>Blinded public key</li>
<li>Pre-computed offline signature block</li>
<li>Expiration timestamps</li>
</ul>
</li>
<li>
<p><strong>Should be tamper-evident:</strong></p>
<ul>
<li>Checksums or signatures over entire file</li>
<li>Integrity verification before loading</li>
</ul>
</li>
<li>
<p><strong>Should be encrypted:</strong></p>
<ul>
<li>Keys are sensitive material</li>
<li>Encrypt file with router&rsquo;s key or passphrase</li>
</ul>
</li>
</ol>
<p><strong>Proposed Format Example (JSON, encrypted):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{   <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#ae81ff">1</span>,   <span style="color:#f92672">&#34;destination_hash&#34;</span>: <span style="color:#e6db74">&#34;base64...&#34;</span>,   <span style="color:#f92672">&#34;keys&#34;</span>: [
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;date&#34;</span>: <span style="color:#e6db74">&#34;2025-10-15&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;transient&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#ae81ff">11</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;privkey&#34;</span>: <span style="color:#e6db74">&#34;base64...&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;pubkey&#34;</span>: <span style="color:#e6db74">&#34;base64...&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;blinded&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;privkey&#34;</span>: <span style="color:#e6db74">&#34;base64...&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;pubkey&#34;</span>: <span style="color:#e6db74">&#34;base64...&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;offline_sig_block&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;expires&#34;</span>: <span style="color:#ae81ff">1729123200</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;signature&#34;</span>: <span style="color:#e6db74">&#34;base64...&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>],   <span style="color:#f92672">&#34;signature&#34;</span>: <span style="color:#e6db74">&#34;base64...&#34;</span>  <span style="color:#75715e">// Signature over entire structure }
</span></span></span></code></pre></div><h3 id="i2cp-protocol-enhancement-todo">I2CP Protocol Enhancement (TODO)</h3>
<p><strong>Current Status:</strong> No I2CP protocol enhancement defined for offline keys with encrypted LeaseSet.</p>
<p><strong>Requirements:</strong></p>
<ol>
<li>
<p><strong>Key delivery mechanism:</strong></p>
<ul>
<li>Upload batch of keys from client to router</li>
<li>Acknowledgment of successful key loading</li>
</ul>
</li>
<li>
<p><strong>Key expiration notification:</strong></p>
<ul>
<li>Router notifies client when keys running low</li>
<li>Client can generate and upload new batch</li>
</ul>
</li>
<li>
<p><strong>Key revocation:</strong></p>
<ul>
<li>Emergency revocation of future keys if compromise suspected</li>
</ul>
</li>
</ol>
<p><strong>Proposed I2CP Messages:</strong></p>
<pre tabindex="0"><code>UPLOAD_OFFLINE_KEYS   - مجموعة من بيانات المفاتيح المشفّرة   - الفترة الزمنية المشمولة

OFFLINE_KEY_STATUS   - عدد الأيام المتبقية   - تاريخ انتهاء صلاحية المفتاح التالي

REVOKE_OFFLINE_KEYS     - نطاق التواريخ للإلغاء   - مفاتيح جديدة للاستبدال (اختياري)
</code></pre><h3 id="implementation-status">Implementation Status</h3>
<p><strong>Java I2P:</strong></p>
<ul>
<li>✅ Offline keys for standard LS2: Fully supported (since 0.9.38)</li>
<li>⚠️ Offline keys for encrypted LS2: Implemented (since 0.9.40)</li>
<li>❌ File format: Not standardized</li>
<li>❌ I2CP protocol: Not enhanced</li>
</ul>
<p><strong>i2pd (C++):</strong></p>
<ul>
<li>✅ Offline keys for standard LS2: Fully supported</li>
<li>✅ Offline keys for encrypted LS2: Fully supported (since 2.58.0)</li>
<li>❌ File format: Not standardized</li>
<li>❌ I2CP protocol: Not enhanced</li>
</ul>
<p><strong>References:</strong></p>
<ul>
<li><a href="../../../../ar/proposals/123-new-netdb-entries/">Offline Signatures Proposal</a>
</li>
<li><a href="../../../../ar/docs/specs/i2cp/">I2CP Specification</a>
</li>
</ul>
<hr>
<h2 id="security-considerations-1">Security Considerations</h2>
<h3 id="cryptographic-security">Cryptographic Security</h3>
<p><strong>Algorithm Selection:</strong></p>
<p>All cryptographic primitives are based on well-studied algorithms:</p>
<ul>
<li><strong>ChaCha20:</strong> Modern stream cipher, constant-time, no timing attacks</li>
<li><strong>SHA-256:</strong> NIST-approved hash, 128-bit security level</li>
<li><strong>HKDF:</strong> RFC 5869 standard, proven security bounds</li>
<li><strong>Ed25519/Red25519:</strong> Curve25519-based, ~128-bit security level</li>
<li><strong>X25519:</strong> Diffie-Hellman over Curve25519, ~128-bit security level</li>
</ul>
<p><strong>Key Sizes:</strong></p>
<ul>
<li>All symmetric keys: 256 bits (32 bytes)</li>
<li>All public/private keys: 256 bits (32 bytes)</li>
<li>All nonces/IVs: 96 bits (12 bytes)</li>
<li>All signatures: 512 bits (64 bytes)</li>
</ul>
<p>These sizes provide adequate security margins against current and near-future attacks.</p>
<h3 id="forward-secrecy">Forward Secrecy</h3>
<p><strong>Daily Key Rotation:</strong></p>
<p>Encrypted LeaseSets rotate keys daily (UTC midnight):</p>
<ul>
<li>New blinded public/private key pair</li>
<li>New storage location in DHT</li>
<li>New encryption keys for both layers</li>
</ul>
<p><strong>Benefits:</strong></p>
<ul>
<li>Compromising today&rsquo;s blinded key doesn&rsquo;t reveal yesterday&rsquo;s</li>
<li>Limits exposure window to 24 hours</li>
<li>Prevents long-term tracking via DHT</li>
</ul>
<p><strong>Enhanced with Ephemeral Keys:</strong></p>
<p>DH client authorization uses ephemeral keys:</p>
<ul>
<li>Server generates new ephemeral DH keypair for each publication</li>
<li>Compromising ephemeral key only affects that publication</li>
<li>True forward secrecy even if long-term keys compromised</li>
</ul>
<h3 id="privacy-properties">Privacy Properties</h3>
<p><strong>Destination Blinding:</strong></p>
<p>The blinded public key:</p>
<ul>
<li>Is unlinkable to the original destination (without knowing the secret)</li>
<li>Changes daily, preventing long-term correlation</li>
<li>Cannot be reversed to find the original public key</li>
</ul>
<p><strong>Client Membership Privacy:</strong></p>
<p>Per-client authorization provides:</p>
<ul>
<li><strong>Anonymity:</strong> No way to identify which clients are authorized</li>
<li><strong>Untraceability:</strong> Cannot track when specific clients added/revoked</li>
<li><strong>Size obfuscation:</strong> Can add dummy entries to hide true count</li>
</ul>
<p><strong>DHT Privacy:</strong></p>
<p>Storage location rotates daily:</p>
<pre tabindex="0"><code>location = SHA-256(sig_type || blinded_public_key)
</code></pre><p>This prevents:</p>
<ul>
<li>Correlation across days via DHT lookups</li>
<li>Long-term monitoring of service availability</li>
<li>Traffic analysis of DHT queries</li>
</ul>
<h3 id="threat-model">Threat Model</h3>
<p><strong>Adversary Capabilities:</strong></p>
<ol>
<li>
<p><strong>Network Adversary:</strong></p>
<ul>
<li>Can monitor all DHT traffic</li>
<li>Can observe encrypted LeaseSet publications</li>
<li>Cannot decrypt without proper keys</li>
</ul>
</li>
<li>
<p><strong>Floodfill Adversary:</strong></p>
<ul>
<li>Can store and analyze all encrypted LeaseSets</li>
<li>Can track publication patterns over time</li>
<li>Cannot decrypt Layer 1 or Layer 2</li>
<li>Can see client count (but not identities)</li>
</ul>
</li>
<li>
<p><strong>Authorized Client Adversary:</strong></p>
<ul>
<li>Can decrypt specific encrypted LeaseSets</li>
<li>Can access inner LeaseSet2 data</li>
<li>Cannot determine other clients&rsquo; identities</li>
<li>Cannot decrypt past LeaseSets (with ephemeral keys)</li>
</ul>
</li>
</ol>
<p><strong>Out of Scope:</strong></p>
<ul>
<li>Malicious router implementations</li>
<li>Compromised router host systems</li>
<li>Side-channel attacks (timing, power analysis)</li>
<li>Physical access to keys</li>
<li>Social engineering attacks</li>
</ul>
<h3 id="attack-scenarios">Attack Scenarios</h3>
<p><strong>1. Offline Keys Tracking Attack:</strong></p>
<p><strong>Attack:</strong> Adversary tracks encrypted LeaseSets via unchanging offline signature block.</p>
<p><strong>Mitigation:</strong> Generate new transient keys daily (in addition to blinded keys).</p>
<p><strong>Status:</strong> Documented recommendation, implementation-specific.</p>
<p><strong>2. Client Position Inference Attack:</strong></p>
<p><strong>Attack:</strong> If client order is static, clients can infer their position and detect when other clients added/removed.</p>
<p><strong>Mitigation:</strong> Randomize client order in authorization list for each publication.</p>
<p><strong>Status:</strong> Documented recommendation in specification.</p>
<p><strong>3. Client Count Analysis Attack:</strong></p>
<p><strong>Attack:</strong> Adversary monitors client count changes over time to infer service popularity or client churn.</p>
<p><strong>Mitigation:</strong> Add random dummy entries to authorization list.</p>
<p><strong>Status:</strong> Optional feature, deployment-specific trade-off (size vs. privacy).</p>
<p><strong>4. PSK Interception Attack:</strong></p>
<p><strong>Attack:</strong> Adversary intercepts PSK during out-of-band exchange and can decrypt all future encrypted LeaseSets.</p>
<p><strong>Mitigation:</strong> Use DH client authorization instead, or ensure secure key exchange (Signal, OTR, PGP).</p>
<p><strong>Status:</strong> Known limitation of PSK approach, documented in specification.</p>
<p><strong>5. Timing Correlation Attack:</strong></p>
<p><strong>Attack:</strong> Adversary correlates publication times across days to link encrypted LeaseSets.</p>
<p><strong>Mitigation:</strong> Randomize publication times, use delayed publishing.</p>
<p><strong>Status:</strong> Implementation-specific, not addressed in core specification.</p>
<p><strong>6. Long-term Secret Compromise:</strong></p>
<p><strong>Attack:</strong> Adversary compromises the blinding secret and can compute all past and future blinded keys.</p>
<p><strong>Mitigation:</strong></p>
<ul>
<li>Use optional secret parameter (not empty)</li>
<li>Rotate secret periodically</li>
<li>Use different secrets for different services</li>
</ul>
<p><strong>Status:</strong> Secret parameter is optional; using it is highly recommended.</p>
<h3 id="operational-security">Operational Security</h3>
<p><strong>Key Management:</strong></p>
<ol>
<li>
<p><strong>Signing Private Key:</strong></p>
<ul>
<li>Store offline in cold storage</li>
<li>Use only for generating blinded keys (batch process)</li>
<li>Never expose to online router</li>
</ul>
</li>
<li>
<p><strong>Blinded Private Keys:</strong></p>
<ul>
<li>Generate offline, deliver in batches</li>
<li>Rotate daily automatically</li>
<li>Delete after use (forward secrecy)</li>
</ul>
</li>
<li>
<p><strong>Transient Private Keys (with offline keys):</strong></p>
<ul>
<li>Generate offline, deliver in batches</li>
<li>Can be longer-lived (days/weeks)</li>
<li>Rotate regularly for enhanced privacy</li>
</ul>
</li>
<li>
<p><strong>Client Authorization Keys:</strong></p>
<ul>
<li>DH: Client private keys never leave client device</li>
<li>PSK: Use unique keys per client, secure exchange</li>
<li>Revoke immediately upon client removal</li>
</ul>
</li>
</ol>
<p><strong>Secret Management:</strong></p>
<p>The optional secret parameter in <code>GENERATE_ALPHA</code>:</p>
<ul>
<li>SHOULD be used for high-security services</li>
<li>MUST be transmitted securely to authorized clients</li>
<li>SHOULD be rotated periodically (e.g., monthly)</li>
<li>CAN be different for different client groups</li>
</ul>
<p><strong>Monitoring and Auditing:</strong></p>
<ol>
<li>
<p><strong>Publication Monitoring:</strong></p>
<ul>
<li>Verify encrypted LeaseSets published successfully</li>
<li>Monitor floodfill acceptance rates</li>
<li>Alert on publication failures</li>
</ul>
</li>
<li>
<p><strong>Client Access Monitoring:</strong></p>
<ul>
<li>Log client authorization attempts (without identifying clients)</li>
<li>Monitor for unusual patterns</li>
<li>Detect potential attacks early</li>
</ul>
</li>
<li>
<p><strong>Key Rotation Auditing:</strong></p>
<ul>
<li>Verify daily key rotation occurs</li>
<li>Check blinded key changes daily</li>
<li>Ensure old keys are deleted</li>
</ul>
</li>
</ol>
<h3 id="implementation-security">Implementation Security</h3>
<p><strong>Constant-Time Operations:</strong></p>
<p>Implementations MUST use constant-time operations for:</p>
<ul>
<li>All scalar arithmetic (mod L operations)</li>
<li>Private key comparisons</li>
<li>Signature verification</li>
<li>DH key agreement</li>
</ul>
<p><strong>Memory Security:</strong></p>
<ul>
<li>Zero sensitive key material after use</li>
<li>Use secure memory allocation for keys</li>
<li>Prevent keys from being paged to disk</li>
<li>Clear stack variables containing key material</li>
</ul>
<p><strong>Random Number Generation:</strong></p>
<ul>
<li>Use cryptographically secure RNG (CSRNG)</li>
<li>Properly seed RNG from OS entropy source</li>
<li>Do not use predictable RNGs for key material</li>
<li>Verify RNG output quality periodically</li>
</ul>
<p><strong>Input Validation:</strong></p>
<ul>
<li>Validate all public keys are on the curve</li>
<li>Check all signature types are supported</li>
<li>Verify all lengths before parsing</li>
<li>Reject malformed encrypted LeaseSets early</li>
</ul>
<p><strong>Error Handling:</strong></p>
<ul>
<li>Do not leak information via error messages</li>
<li>Use constant-time comparison for authentication</li>
<li>Do not expose timing differences in decryption</li>
<li>Log security-relevant events properly</li>
</ul>
<h3 id="recommendations">Recommendations</h3>
<p><strong>For Service Operators:</strong></p>
<ol>
<li>✅ <strong>Use Red25519 (type 11)</strong> for new destinations</li>
<li>✅ <strong>Use DH client authorization</strong> for high-security services</li>
<li>✅ <strong>Generate new transient keys daily</strong> when using offline keys</li>
<li>✅ <strong>Use the optional secret parameter</strong> in GENERATE_ALPHA</li>
<li>✅ <strong>Randomize client order</strong> in authorization lists</li>
<li>✅ <strong>Monitor publication success</strong> and investigate failures</li>
<li>⚠️ <strong>Consider dummy entries</strong> to hide client count (size trade-off)</li>
</ol>
<p><strong>For Client Implementers:</strong></p>
<ol>
<li>✅ <strong>Validate blinded public keys</strong> are on prime-order subgroup</li>
<li>✅ <strong>Verify all signatures</strong> before trusting data</li>
<li>✅ <strong>Use constant-time operations</strong> for cryptographic primitives</li>
<li>✅ <strong>Zero key material</strong> immediately after use</li>
<li>✅ <strong>Implement proper error handling</strong> without information leaks</li>
<li>✅ <strong>Support both Ed25519 and Red25519</strong> destination types</li>
</ol>
<p><strong>For Network Operators:</strong></p>
<ol>
<li>✅ <strong>Accept encrypted LeaseSets</strong> in floodfill routers</li>
<li>✅ <strong>Enforce reasonable size limits</strong> to prevent abuse</li>
<li>✅ <strong>Monitor for anomalous patterns</strong> (extremely large, frequent updates)</li>
<li>⚠️ <strong>Consider rate limiting</strong> encrypted LeaseSet publications</li>
</ol>
<hr>
<h2 id="implementation-notes">Implementation Notes</h2>
<h3 id="java-i2p-implementation">Java I2P Implementation</h3>
<p><strong>Repository:</strong> <a href="https://github.com/i2p/i2p.i2p">https://github.com/i2p/i2p.i2p</a>
</p>
<p><strong>Key Classes:</strong></p>
<ul>
<li><code>net.i2p.data.LeaseSet2</code> - LeaseSet2 structure</li>
<li><code>net.i2p.data.EncryptedLeaseSet</code> - Encrypted LS2 implementation</li>
<li><code>net.i2p.crypto.eddsa.EdDSAEngine</code> - Ed25519/Red25519 signatures</li>
<li><code>net.i2p.crypto.HKDF</code> - HKDF implementation</li>
<li><code>net.i2p.crypto.ChaCha20</code> - ChaCha20 cipher</li>
</ul>
<p><strong>Configuration:</strong></p>
<p>Enable encrypted LeaseSet in <code>clients.config</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># تفعيل LeaseSet المشفّر (بنية بيانات تنشر معلومات الاتصال الخاصة بوجهة داخل I2P)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.encryptLeaseSet</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># اختياري: تمكين تخويل العميل</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.enableAccessList</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># اختياري: استخدم DH authorization (مصادقة باستخدام تبادل المفاتيح ديفي–هيلمان؛ الإعداد الافتراضي هو PSK (مفتاح مُشترك مُسبقاً))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.accessListType</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># اختياري: سر الإعماء (موصى به بشدة)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.blindingSecret</span><span style="color:#f92672">=</span><span style="color:#e6db74">your-secret-here</span>
</span></span></code></pre></div><p><strong>API Usage Example:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// أنشئ LeaseSet مشفّر EncryptedLeaseSet els = new EncryptedLeaseSet();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// تعيين الوجهة els.setDestination(destination);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// تمكين التخويل لكل عميل على حدة els.setAuthorizationEnabled(true); els.setAuthType(EncryptedLeaseSet.AUTH_DH);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// أضف العملاء المصرّح لهم (مفاتيح DH العامة — خوارزمية ديفي-هيلمان) for (byte[] clientPubKey : authorizedClients) {</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    els.<span style="color:#a6e22e">addClient</span>(clientPubKey);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// اضبط معلمات الإعماء (blinding) els.setBlindingSecret(&#34;your-secret&#34;);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// وقّع وانشر els.sign(signingPrivateKey); netDb.publish(els);</span>
</span></span></code></pre></div><h3 id="i2pd-c-implementation">i2pd (C++) Implementation</h3>
<p><strong>Repository:</strong> <a href="https://github.com/PurpleI2P/i2pd">https://github.com/PurpleI2P/i2pd</a>
</p>
<p><strong>Key Files:</strong></p>
<ul>
<li><code>libi2pd/LeaseSet.h/cpp</code> - LeaseSet implementations</li>
<li><code>libi2pd/Crypto.h/cpp</code> - Cryptographic primitives</li>
<li><code>libi2pd/Ed25519.h/cpp</code> - Ed25519/Red25519 signatures</li>
<li><code>libi2pd/ChaCha20.h/cpp</code> - ChaCha20 cipher</li>
</ul>
<p><strong>Configuration:</strong></p>
<p>Enable in tunnel configuration (<code>tunnels.conf</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">[my-hidden-service] type</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http host = 127.0.0.1 port = 8080 keys = my-service-keys.dat</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># تفعيل LeaseSet المشفّر</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">encryptleaseset</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># اختياري: نوع تخويل العميل (0=DH, 1=PSK)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">authtype</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># اختياري: Blinding secret (سر الإعماء)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">secret</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">السر-الخاص-بك-هنا</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># اختياري: العملاء المصرح لهم (واحد في كل سطر، مفاتيح عامة مرمزة بترميز base64)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">client.1</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">base64-encoded-client-pubkey-1 client.2 = base64-encoded-client-pubkey-2</span>
</span></span></code></pre></div><p><strong>API Usage Example:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// إنشاء LeaseSet مشفّر auto encryptedLS = std::make_shared&lt;i2p::data::EncryptedLeaseSet&gt;(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    destination,
</span></span><span style="display:flex;"><span>    blindingSecret
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// تفعيل التخويل لكل عميل
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>encryptedLS<span style="color:#f92672">-&gt;</span>SetAuthType(i2p<span style="color:#f92672">::</span>data<span style="color:#f92672">::</span>AUTH_TYPE_DH);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// إضافة العملاء المصرح لهم for (const auto&amp; clientPubKey : authorizedClients) {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    encryptedLS<span style="color:#f92672">-&gt;</span>AddClient(clientPubKey);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// وقّع وانشر encryptedLS-&gt;Sign(signingPrivKey); netdb.Publish(encryptedLS);
</span></span></span></code></pre></div><h3 id="testing-and-debugging">Testing and Debugging</h3>
<p><strong>Test Vectors:</strong></p>
<p>Generate test vectors for implementation verification:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># متجه الاختبار 1: Key blinding (إعماء المفتاح)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>destination_pubkey <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">64</span>) sigtype <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span> blinded_sigtype <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span> date <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;20251015&#34;</span> secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>alpha <span style="color:#f92672">=</span> generate_alpha(destination_pubkey, sigtype, blinded_sigtype, date, secret) print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Alpha: </span><span style="color:#e6db74">{</span>alpha<span style="color:#f92672">.</span>hex()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># المتوقع: (تحقق بالمقارنة مع التنفيذ المرجعي)</span>
</span></span></code></pre></div><p><strong>Unit Tests:</strong></p>
<p>Key areas to test:</p>
<ol>
<li>HKDF derivation with various inputs</li>
<li>ChaCha20 encryption/decryption</li>
<li>Red25519 signature generation and verification</li>
<li>Key blinding (private and public)</li>
<li>Layer 1/2 encryption/decryption</li>
<li>Client authorization (DH and PSK)</li>
<li>Base32 address generation and parsing</li>
</ol>
<p><strong>Integration Tests:</strong></p>
<ol>
<li>Publish encrypted LeaseSet to test network</li>
<li>Retrieve and decrypt from client</li>
<li>Verify daily key rotation</li>
<li>Test client authorization (add/remove clients)</li>
<li>Test offline keys (if supported)</li>
</ol>
<p><strong>Common Implementation Errors:</strong></p>
<ol>
<li><strong>Incorrect mod L reduction:</strong> Must use proper modular arithmetic</li>
<li><strong>Endianness errors:</strong> Most fields are big-endian, but some crypto uses little-endian</li>
<li><strong>Off-by-one in array slicing:</strong> Verify indices are inclusive/exclusive as needed</li>
<li><strong>Missing constant-time comparisons:</strong> Use constant-time for all sensitive comparisons</li>
<li><strong>Not zeroing key material:</strong> Always zero keys after use</li>
</ol>
<h3 id="performance-considerations">Performance Considerations</h3>
<p><strong>Computational Costs:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Operation</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Cost</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Key blinding (server)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">1 scalar mult</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per publication</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Key blinding (client)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">1 point add + 1 scalar mult</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per retrieval</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Layer 1 encryption</td><td style="border:1px solid var(--color-border); padding:0.5rem;">1 HKDF + 1 ChaCha20</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Fast</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Layer 2 encryption</td><td style="border:1px solid var(--color-border); padding:0.5rem;">1 HKDF + 1 ChaCha20</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Fast</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">DH client auth (server)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">N+1 X25519 ops</td><td style="border:1px solid var(--color-border); padding:0.5rem;">N = number of clients</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">DH client auth (client)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">1 X25519 op</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per retrieval</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">PSK client auth</td><td style="border:1px solid var(--color-border); padding:0.5rem;">0 DH ops</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Only HKDF + ChaCha20</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Signature (Red25519)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">1 signature op</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Similar cost to Ed25519</td></tr>
  </tbody>
</table>
<p><strong>Size Overhead:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Component</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Frequency</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Blinded public key</td><td style="border:1px solid var(--color-border); padding:0.5rem;">32 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per LeaseSet</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Layer 1 encryption overhead</td><td style="border:1px solid var(--color-border); padding:0.5rem;">32 bytes (salt)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per LeaseSet</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Layer 2 encryption overhead</td><td style="border:1px solid var(--color-border); padding:0.5rem;">32 bytes (salt)</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per LeaseSet</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">DH auth per client</td><td style="border:1px solid var(--color-border); padding:0.5rem;">40 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per client per LeaseSet</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">DH ephemeral pubkey</td><td style="border:1px solid var(--color-border); padding:0.5rem;">32 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per LeaseSet (if DH auth)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">PSK auth per client</td><td style="border:1px solid var(--color-border); padding:0.5rem;">40 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per client per LeaseSet</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">PSK salt</td><td style="border:1px solid var(--color-border); padding:0.5rem;">32 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per LeaseSet (if PSK auth)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Signature</td><td style="border:1px solid var(--color-border); padding:0.5rem;">64 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per LeaseSet</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Offline sig block</td><td style="border:1px solid var(--color-border); padding:0.5rem;">≈100 bytes</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Per LeaseSet (if offline keys)</td></tr>
  </tbody>
</table>
<p><strong>Typical Sizes:</strong></p>
<ul>
<li><strong>No client auth:</strong> ~200 bytes overhead</li>
<li><strong>With 10 DH clients:</strong> ~600 bytes overhead</li>
<li><strong>With 100 DH clients:</strong> ~4200 bytes overhead</li>
</ul>
<p><strong>Optimization Tips:</strong></p>
<ol>
<li><strong>Batch key generation:</strong> Generate blinded keys for multiple days in advance</li>
<li><strong>Cache subcredentials:</strong> Compute once per day, reuse for all publications</li>
<li><strong>Reuse ephemeral keys:</strong> Can reuse ephemeral DH key for short period (minutes)</li>
<li><strong>Parallel client encryption:</strong> Encrypt client cookies in parallel</li>
<li><strong>Fast path for no auth:</strong> Skip authorization layer entirely when disabled</li>
</ol>
<h3 id="compatibility">Compatibility</h3>
<p><strong>Backward Compatibility:</strong></p>
<ul>
<li>Ed25519 (type 7) destinations supported for unblinded keys</li>
<li>Red25519 (type 11) required for blinded keys</li>
<li>Traditional LeaseSets still fully supported</li>
<li>Encrypted LeaseSets do not break existing network</li>
</ul>
<p><strong>Forward Compatibility:</strong></p>
<ul>
<li>Reserved flag bits for future features</li>
<li>Extensible authorization scheme (3 bits allow 8 types)</li>
<li>Version field in various structures</li>
</ul>
<p><strong>Interoperability:</strong></p>
<ul>
<li>Java I2P and i2pd fully interoperable since:
<ul>
<li>Java I2P 0.9.40 (May 2019)</li>
<li>i2pd 2.58.0 (September 2025)</li>
</ul>
</li>
<li>Encrypted LeaseSets work across implementations</li>
<li>Client authorization works across implementations</li>
</ul>
<hr>
<h2 id="references">References</h2>
<h3 id="ietf-rfcs">IETF RFCs</h3>
<ul>
<li><strong><a href="https://datatracker.ietf.org/doc/html/rfc2104">RFC 2104</a>
</strong> - HMAC: Keyed-Hashing for Message Authentication (February 1997)</li>
<li><strong><a href="https://datatracker.ietf.org/doc/html/rfc5869">RFC 5869</a>
</strong> - HMAC-based Extract-and-Expand Key Derivation Function (HKDF) (May 2010)</li>
<li><strong><a href="https://datatracker.ietf.org/doc/html/rfc7539">RFC 7539</a>
</strong> - ChaCha20 and Poly1305 for IETF Protocols (May 2015)</li>
<li><strong><a href="https://datatracker.ietf.org/doc/html/rfc7748">RFC 7748</a>
</strong> - Elliptic Curves for Security (January 2016)</li>
</ul>
<h3 id="i2p-specifications">I2P Specifications</h3>
<ul>
<li><strong><a href="../../../../ar/docs/specs/common-structures/">Common Structures Specification</a>
</strong> - LeaseSet2 and EncryptedLeaseSet structures</li>
<li><strong><a href="../../../../ar/proposals/123-new-netdb-entries/">Proposal 123: New netDB Entries</a>
</strong> - Background and design of LeaseSet2</li>
<li><strong><a href="../../../../ar/proposals/146-red25519/">Proposal 146: Red25519</a>
</strong> - Red25519 signature scheme specification</li>
<li><strong><a href="../../../../ar/proposals/149-b32-encrypted-ls2/">Proposal 149: B32 for Encrypted LS2</a>
</strong> - Base32 addressing for encrypted LeaseSets</li>
<li><strong><a href="../../../../ar/docs/specs/red25519-signature-scheme/">Red25519 Specification</a>
</strong> - Detailed Red25519 implementation</li>
<li><strong><a href="../../../../ar/docs/specs/b32-for-encrypted-leasesets/">B32 Addressing Specification</a>
</strong> - Base32 address format</li>
<li><strong><a href="../../../../ar/docs/specs/common-structures/">Network Database Documentation</a>
</strong> - NetDB usage and operations</li>
<li><strong><a href="../../../../ar/docs/specs/i2cp/">I2CP Specification</a>
</strong> - I2P Client Protocol</li>
</ul>
<h3 id="cryptographic-references">Cryptographic References</h3>
<ul>
<li><strong><a href="http://cr.yp.to/papers.html#ed25519">Ed25519 Paper</a>
</strong> - &ldquo;High-speed high-security signatures&rdquo; by Bernstein et al.</li>
<li><strong><a href="https://zips.z.cash/protocol/protocol.pdf">ZCash Protocol Specification</a>
</strong> - Section 5.4.6: RedDSA signature scheme</li>
<li><strong><a href="https://spec.torproject.org/rend-spec">Tor Rendezvous Specification v3</a>
</strong> - Tor&rsquo;s onion service specification (for comparison)</li>
</ul>
<h3 id="security-references">Security References</h3>
<ul>
<li><strong><a href="https://lists.torproject.org/pipermail/tor-dev/2013-December/005943.html">Key Blinding Security Discussion</a>
</strong> - Tor Project mailing list discussion</li>
<li><strong><a href="https://trac.torproject.org/projects/tor/ticket/8106">Tor Ticket #8106</a>
</strong> - Key blinding implementation discussion</li>
<li><strong><a href="http://projectbullrun.org/dual-ec/ext-rand.html">PRNG Security</a>
</strong> - Random number generator security considerations</li>
<li><strong><a href="https://lists.torproject.org/pipermail/tor-dev/2015-November/009954.html">Tor PRNG Discussion</a>
</strong> - Discussion of PRNG usage in Tor</li>
</ul>
<h3 id="implementation-references">Implementation References</h3>
<ul>
<li><strong><a href="https://github.com/i2p/i2p.i2p">Java I2P Repository</a>
</strong> - Official Java implementation</li>
<li><strong><a href="https://github.com/PurpleI2P/i2pd">i2pd Repository</a>
</strong> - C++ implementation</li>
<li><strong><a href="../../../../ar/">I2P Website</a>
</strong> - Official I2P project website</li>
<li><strong><a href="../../../../ar/docs/specs/">I2P Specifications</a>
</strong> - Complete specification index</li>
</ul>
<h3 id="version-history">Version History</h3>
<ul>
<li><strong><a href="../../../../en/blog">I2P Release Notes</a>
</strong> - Official release announcements</li>
<li><strong><a href="https://github.com/i2p/i2p.i2p/releases">Java I2P Releases</a>
</strong> - GitHub release history</li>
<li><strong><a href="https://github.com/PurpleI2P/i2pd/releases">i2pd Releases</a>
</strong> - GitHub release history</li>
</ul>
<hr>
<h2 id="appendix-a-cryptographic-constants">Appendix A: Cryptographic Constants</h2>
<h3 id="ed25519--red25519-constants">Ed25519 / Red25519 Constants</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># نقطة الأساس لـ Ed25519 (المولِّد)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>B <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">255</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">19</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># رتبة Ed25519 (حجم الحقل العددي)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>L <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">252</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">27742317777372353535851937790883648493</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># قيم أنواع التوقيع</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SIGTYPE_ED25519 <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>    <span style="color:#75715e"># 0x0007 SIGTYPE_RED25519 = 11  # 0x000b</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># أحجام المفاتيح</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PRIVKEY_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>  <span style="color:#75715e"># بايت PUBKEY_SIZE = 32   # بايت SIGNATURE_SIZE = 64  # بايت</span>
</span></span></code></pre></div><h3 id="chacha20-constants">ChaCha20 Constants</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># معاملات ChaCha20 (خوارزمية تشفير تياري)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CHACHA20_KEY_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>   <span style="color:#75715e"># bytes (256 bits) CHACHA20_NONCE_SIZE = 12  # bytes (96 bits) CHACHA20_INITIAL_COUNTER = 1  # RFC 7539 permits 0 or 1</span>
</span></span></code></pre></div><h3 id="hkdf-constants">HKDF Constants</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># معاملات HKDF (دالة اشتقاق المفاتيح المعتمدة على HMAC)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HKDF_HASH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SHA-256&#34;</span> HKDF_SALT_MAX <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>  <span style="color:#75715e"># بايت (HashLen)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># سلاسل info النصية الخاصة بـ HKDF (دالة اشتقاق مفاتيح مستندة إلى HMAC) (فصل المجالات)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HKDF_INFO_ALPHA <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;i2pblinding1&#34;</span> HKDF_INFO_LAYER1 <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;ELS2_L1K&#34;</span> HKDF_INFO_LAYER2 <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;ELS2_L2K&#34;</span> HKDF_INFO_DH_AUTH <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;ELS2_XCA&#34;</span> HKDF_INFO_PSK_AUTH <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;ELS2PSKA&#34;</span>
</span></span></code></pre></div><h3 id="hash-personalization-strings">Hash Personalization Strings</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># سلاسل تخصيص SHA-256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HASH_PERS_ALPHA <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;I2PGenerateAlpha&#34;</span> HASH_PERS_RED25519 <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;I2P_Red25519H(x)&#34;</span> HASH_PERS_CREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;credential&#34;</span> HASH_PERS_SUBCREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;subcredential&#34;</span>
</span></span></code></pre></div><h3 id="structure-sizes">Structure Sizes</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># أحجام الطبقة 0 (الخارجية)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BLINDED_SIGTYPE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>   <span style="color:#75715e"># بايت BLINDED_PUBKEY_SIZE = 32   # بايت (خاصة بـ Red25519) PUBLISHED_TS_SIZE = 4      # بايت EXPIRES_SIZE = 2           # بايت FLAGS_SIZE = 2             # بايت LEN_OUTER_CIPHER_SIZE = 2  # بايت SIGNATURE_SIZE = 64        # بايت (Red25519)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># أحجام كتل المفاتيح في وضع عدم الاتصال</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OFFLINE_EXPIRES_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>   <span style="color:#75715e"># بايت OFFLINE_SIGTYPE_SIZE = 2   # بايت OFFLINE_SIGNATURE_SIZE = 64  # بايت</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># أحجام الطبقة 1 (الوسطى)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>AUTH_FLAGS_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>        <span style="color:#75715e"># بايت EPHEMERAL_PUBKEY_SIZE = 32  # بايتات (مصادقة DH) AUTH_SALT_SIZE = 32        # بايتات (مصادقة PSK) NUM_CLIENTS_SIZE = 2       # بايتات CLIENT_ID_SIZE = 8         # بايتات CLIENT_COOKIE_SIZE = 32    # بايتات AUTH_CLIENT_ENTRY_SIZE = 40  # بايتات (CLIENT_ID + CLIENT_COOKIE)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># العبء الإضافي للتشفير</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SALT_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>  <span style="color:#75715e"># بايت (يُضاف في المقدمة إلى كل طبقة مُشفّرة)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># عنوان Base32 (ترميز أساس 32)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>B32_ENCRYPTED_DECODED_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">35</span>  <span style="color:#75715e"># بايت B32_ENCRYPTED_ENCODED_LEN = 56   # محارف B32_SUFFIX = &#34;.b32.i2p&#34;</span>
</span></span></code></pre></div><hr>
<h2 id="appendix-b-test-vectors">Appendix B: Test Vectors</h2>
<h3 id="test-vector-1-alpha-generation">Test Vector 1: Alpha Generation</h3>
<p><strong>Input:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># المفتاح العام للوجهة (Ed25519)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>A <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#39;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#39;</span>) stA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0007</span>  <span style="color:#75715e"># Ed25519 stA_prime = 0x000b  # Red25519 date = &#34;20251015&#34; secret = &#34;&#34;  # Empty secret</span>
</span></span></code></pre></div><p><strong>Computation:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> A <span style="color:#f92672">||</span> bytes([<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x07</span>]) <span style="color:#f92672">||</span> bytes([<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x0b</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># keydata = 36 بايت</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>salt <span style="color:#f92672">=</span> SHA256(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;I2PGenerateAlpha&#34;</span> <span style="color:#f92672">+</span> keydata) ikm <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;20251015&#34;</span> info <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;i2pblinding1&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>seed <span style="color:#f92672">=</span> HKDF(salt, ikm, info, <span style="color:#ae81ff">64</span>) alpha <span style="color:#f92672">=</span> LEOS2IP(seed) mod L
</span></span></code></pre></div><p><strong>Expected Output:</strong></p>
<pre tabindex="0"><code>(تحقق مقابل التنفيذ المرجعي) alpha = [قيمة سداسية عشرية بطول 64 بايت]
</code></pre><h3 id="test-vector-2-chacha20-encryption">Test Vector 2: ChaCha20 Encryption</h3>
<p><strong>Input:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>key <span style="color:#f92672">=</span> bytes([i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">32</span>)])  <span style="color:#75715e"># 0x00..0x1f nonce = bytes([i for i in range(12)])  # 0x00..0x0b plaintext = b&#34;Hello, I2P!&#34;</span>
</span></span></code></pre></div><p><strong>Computation:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ChaCha20_Encrypt(key, nonce, plaintext, counter<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span></code></pre></div><p><strong>Expected Output:</strong></p>
<pre tabindex="0"><code>النص المشفّر = [تحقّق بمطابقته مع متجهات الاختبار الخاصة بـ RFC 7539]
</code></pre><h3 id="test-vector-3-hkdf">Test Vector 3: HKDF</h3>
<p><strong>Input:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>salt <span style="color:#f92672">=</span> bytes(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># كلها أصفار ikm = b&#34;test input keying material&#34; info = b&#34;ELS2_L1K&#34; n = 44</span>
</span></span></code></pre></div><p><strong>Computation:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>keys <span style="color:#f92672">=</span> HKDF(salt, ikm, info, n)
</span></span></code></pre></div><p><strong>Expected Output:</strong></p>
<pre tabindex="0"><code>keys = [قيمة سداسية عشرية بطول 44 بايت]
</code></pre><h3 id="test-vector-4-base32-address">Test Vector 4: Base32 Address</h3>
<p><strong>Input:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pubkey <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#39;bbbb&#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;bb&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">30</span>)  <span style="color:#75715e"># 32 بايت unblinded_sigtype = 11  # Red25519 blinded_sigtype = 11    # Red25519</span>
</span></span></code></pre></div><p><strong>Computation:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>address <span style="color:#f92672">=</span> generate_encrypted_b32_address(pubkey, unblinded_sigtype, blinded_sigtype)
</span></span></code></pre></div><p><strong>Expected Output:</strong></p>
<pre tabindex="0"><code>address = [56 محارف base32].b32.i2p

# تحقّق من أن التحقق من المجموع الاختباري يتم بشكل صحيح
</code></pre><hr>
<h2 id="appendix-c-glossary">Appendix C: Glossary</h2>
<p><strong>Alpha (α):</strong> The secret blinding factor used to blind public and private keys. Generated from the destination, date, and optional secret.</p>
<p><strong>AuthCookie:</strong> A 32-byte random value encrypted for each authorized client, used as input to Layer 2 encryption.</p>
<p><strong>B (Base Point):</strong> The generator point for the Ed25519 elliptic curve.</p>
<p><strong>Blinded Key:</strong> A public or private key that has been transformed using the alpha blinding factor. Blinded keys cannot be linked to the original keys without knowing alpha.</p>
<p><strong>ChaCha20:</strong> A stream cipher providing fast, secure encryption without requiring AES hardware support.</p>
<p><strong>ClientID:</strong> An 8-byte identifier derived from HKDF output, used to identify authorization entries for clients.</p>
<p><strong>ClientCookie:</strong> A 32-byte encrypted value containing the authCookie for a specific client.</p>
<p><strong>Credential:</strong> A 32-byte value derived from the destination&rsquo;s public key and signature types, binding encryption to knowledge of the destination.</p>
<p><strong>CSRNG:</strong> Cryptographically Secure Random Number Generator. Must provide unpredictable output suitable for key generation.</p>
<p><strong>DH (Diffie-Hellman):</strong> A cryptographic protocol for securely establishing shared secrets. I2P uses X25519.</p>
<p><strong>Ed25519:</strong> An elliptic curve signature scheme providing fast signatures with 128-bit security level.</p>
<p><strong>Ephemeral Key:</strong> A short-lived cryptographic key, typically used once and then discarded.</p>
<p><strong>Floodfill:</strong> I2P routers that store and serve network database entries, including encrypted LeaseSets.</p>
<p><strong>HKDF:</strong> HMAC-based Key Derivation Function, used to derive multiple cryptographic keys from a single source.</p>
<p><strong>L (Order):</strong> The order of the Ed25519 scalar field (approximately 2^252).</p>
<p><strong>Layer 0 (Outer):</strong> The plaintext portion of an encrypted LeaseSet, containing blinded key and metadata.</p>
<p><strong>Layer 1 (Middle):</strong> The first encrypted layer, containing client authorization data.</p>
<p><strong>Layer 2 (Inner):</strong> The innermost encrypted layer, containing the actual LeaseSet2 data.</p>
<p><strong>LeaseSet2 (LS2):</strong> Second version of I2P&rsquo;s network database entry format, introducing encrypted variants.</p>
<p><strong>NetDB:</strong> The I2P network database, a distributed hash table storing router and destination information.</p>
<p><strong>Offline Keys:</strong> A feature allowing the main signing key to remain in cold storage while a transient key handles daily operations.</p>
<p><strong>PSK (Pre-Shared Key):</strong> A symmetric key shared in advance between two parties, used for PSK client authorization.</p>
<p><strong>Red25519:</strong> An Ed25519-based signature scheme with key blinding support, based on ZCash RedDSA.</p>
<p><strong>Salt:</strong> Random data used as input to key derivation functions to ensure unique outputs.</p>
<p><strong>SigType:</strong> A numeric identifier for signature algorithms (e.g., 7 = Ed25519, 11 = Red25519).</p>
<p><strong>Subcredential:</strong> A 32-byte value derived from the credential and blinded public key, binding encryption to a specific encrypted LeaseSet.</p>
<p><strong>Transient Key:</strong> A temporary signing key used with offline keys, with a limited validity period.</p>
<p><strong>X25519:</strong> An elliptic curve Diffie-Hellman protocol over Curve25519, providing key agreement.</p>
<hr>
<h2 id="document-information">Document Information</h2>
<p><strong>Status:</strong> This document represents the current stable encrypted LeaseSet specification as implemented in I2P since June 2019. The protocol is mature and widely deployed.</p>
<p><strong>Contributing:</strong> For corrections or improvements to this documentation, please submit issues or pull requests to the I2P specifications repository.</p>
<p><strong>Support:</strong> For questions about implementing encrypted LeaseSets:</p>
<ul>
<li>I2P Forum: <a href="https://i2pforum.net/">https://i2pforum.net/</a>
</li>
<li>IRC: #i2p-dev on OFTC</li>
<li>Matrix: #i2p-dev:matrix.org</li>
</ul>
<p><strong>Acknowledgments:</strong> This specification builds on work by the I2P development team, ZCash cryptography research, and Tor Project&rsquo;s key blinding research.</p>

                </article>

                
                <nav class="page-nav">
                    
                        <a href="../../../../ar/docs/specs/subscription/" class="page-nav-link prev">
                            <span class="nav-label">← Previous</span>
                            <span class="nav-title">أوامر خلاصة اشتراك العناوين</span>
                        </a>
                    
                    
                        <a href="../../../../ar/docs/specs/b32-for-encrypted-leasesets/" class="page-nav-link next">
                            <span class="nav-label">Next →</span>
                            <span class="nav-title">B32 لـ leaseSets (مجموعات نقاط الدخول للأنفاق في I2P) المشفّرة</span>
                        </a>
                    
                </nav>

                
                <div class="docs-feedback">
                    <p>Was this page helpful?</p>
                    <div class="feedback-buttons" id="feedback-buttons">
                        <button class="feedback-btn" id="feedback-yes">👍 Yes</button>
                        <button class="feedback-btn" id="feedback-no">👎 No</button>
                    </div>

                    
                    <div class="feedback-form-container" id="feedback-form-container" style="display: none;">
                        <p class="feedback-form-title">We're sorry to hear that. How can we improve this page?</p>
                        <form id="feedback-form">
                            <div class="form-group">
                                <label for="feedback-email">Email (optional - if you'd like a response)</label>
                                <input type="email" id="feedback-email" name="email" placeholder="your@email.com">
                            </div>
                            <div class="form-group">
                                <label for="feedback-message">Feedback *</label>
                                <textarea id="feedback-message" name="message" rows="4" required placeholder="Tell us what we can improve..."></textarea>
                            </div>
                            <button type="submit" class="btn-submit-feedback" id="feedback-submit-btn">
                                <span class="btn-text">Submit Feedback</span>
                                <span class="btn-loading" style="display: none;">Sending...</span>
                            </button>
                        </form>
                    </div>

                    
                    <div class="feedback-message" id="feedback-success" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/>
                        </svg>
                        <span id="feedback-success-text">Thanks for your feedback!</span>
                    </div>
                    <div class="feedback-message feedback-error" id="feedback-error" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path d="M12 8v4M12 16h.01" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span id="feedback-error-text">Something went wrong. Please try again.</span>
                    </div>

                    <p class="feedback-note">
                        Found an issue? <a href="https://gitlab.com/stormycloud-group/i-2-p-www-v-2/-/blob/main/hugo-site/content/ar/docs/specs/encryptedleaseset.md?ref_type=heads" target="_blank">Edit this page on GitLab</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.docs-page {
    min-height: 100vh;
    padding: var(--spacing-xl) 0;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
}

.breadcrumbs a:hover {
    color: var(--color-primary);
}

.separator {
    color: var(--color-border);
}

.current {
    color: var(--color-text);
}

 
.translation-disclaimer {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.dark .translation-disclaimer {
    background: #78350f;
    border-color: #d97706;
}

.disclaimer-message {
    color: #92400e;
    font-size: 0.875rem;
}

.dark .disclaimer-message {
    color: #fde047;
}

.disclaimer-link {
    color: #92400e;
    font-weight: 600;
    text-decoration: underline;
    white-space: nowrap;
}

.dark .disclaimer-link {
    color: #fde047;
}

 
.article-header {
    margin-bottom: var(--spacing-2xl);
}

.article-title {
    font-size: 2.5rem;
    margin: 0 0 var(--spacing-md) 0;
    color: var(--color-text);
}

.article-description {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-md);
}

.article-meta {
    display: flex;
    gap: var(--spacing-lg);
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.meta-item svg {
    color: var(--color-primary);
}

 
.docs-layout {
    display: block;
}

.docs-layout--with-toc {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

 
.docs-toc-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.toc-nav {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
}

.toc-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-text);
    padding-bottom: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.toc-content {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
}

.toc-content::-webkit-scrollbar {
    width: 4px;
}

.toc-content::-webkit-scrollbar-track {
    background: transparent;
}

.toc-content::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
}

.toc-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

.toc-nav ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc-nav li {
    margin-bottom: 0.25rem;
}

.toc-nav ul ul {
    padding-left: var(--spacing-md);
    margin-top: 0.25rem;
}

.toc-nav a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.8125rem;
    display: block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    line-height: 1.4;
}

.toc-nav a:hover {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
}

 
.docs-main {
    min-width: 0;
    max-width: 900px;
}

 
.article-content {
    line-height: 1.8;
    color: var(--color-text);
}

.article-content h2 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.75rem;
    scroll-margin-top: 100px;
}

.article-content h3 {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.375rem;
    scroll-margin-top: 100px;
}

.article-content h4 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-xs);
    font-size: 1.125rem;
    scroll-margin-top: 100px;
}

.article-content p {
    margin-bottom: var(--spacing-md);
}

.article-content ul,
.article-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.article-content li {
    margin-bottom: var(--spacing-xs);
}

.article-content code {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
}

.article-content pre {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: var(--spacing-md);
}

.article-content pre code {
    background: none;
    padding: 0;
}

.article-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin: var(--spacing-lg) 0;
    display: block;
}

.article-content a {
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
}

.article-content a:hover {
    border-bottom-color: var(--color-primary);
}

 
.page-nav {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
}

.page-nav-link {
    display: flex;
    flex-direction: column;
    padding: var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.page-nav-link:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
}

.page-nav-link.next {
    text-align: right;
}

.nav-label {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xs);
}

.nav-title {
    font-weight: 600;
    color: var(--color-text);
}

 
.docs-feedback {
    margin-top: var(--spacing-2xl);
    padding: var(--spacing-lg);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    text-align: center;
}

.feedback-buttons {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    margin: var(--spacing-md) 0;
}

.feedback-btn {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.feedback-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-primary);
    color: white;
}

.feedback-note {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-top: var(--spacing-md);
}

.feedback-note a {
    color: var(--color-primary);
    text-decoration: none;
}

.feedback-note a:hover {
    text-decoration: underline;
}

 
.feedback-form-container {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-align: left;
}

.feedback-form-title {
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--color-text);
}

.form-group {
    margin-bottom: var(--spacing-md);
}

.form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
    color: var(--color-text);
}

.form-group input[type="email"],
.form-group textarea {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    color: var(--color-text);
    font-family: inherit;
    font-size: 0.9375rem;
    transition: border-color var(--transition-fast);
}

.form-group input[type="email"]:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.btn-submit-feedback {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-submit-feedback:hover:not(:disabled) {
    background: var(--color-primary-dark);
    transform: translateY(-1px);
}

.btn-submit-feedback:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

 
.feedback-message {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: #d1fae5;
    color: #065f46;
    border-radius: var(--radius-md);
    margin-top: var(--spacing-md);
}

.feedback-message.feedback-error {
    background: #fee2e2;
    color: #991b1b;
}

.feedback-message svg {
    flex-shrink: 0;
}

 
@media (max-width: 1024px) {
    .docs-layout--with-toc {
        grid-template-columns: 1fr;
    }

    .docs-toc-sidebar {
        position: static;
        max-height: none;
        margin-bottom: var(--spacing-xl);
    }

    .toc-content {
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .article-title {
        font-size: 1.75rem;
    }
}
</style>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = [];

    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const heading = document.getElementById(href.slice(1));
            if (heading) {
                headings.push({ element: heading, link: link });
            }
        }
    });

    function updateActiveLink() {
        const scrollPos = window.scrollY + 120;
        let activeIndex = 0;

        for (let i = 0; i < headings.length; i++) {
            if (headings[i].element.offsetTop <= scrollPos) {
                activeIndex = i;
            }
        }

        tocLinks.forEach(link => link.classList.remove('active'));
        if (headings[activeIndex]) {
            headings[activeIndex].link.classList.add('active');
        }
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});
</script>
<style>
.toc-nav a.active {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
    font-weight: 600;
}
</style>



<script>
(function() {
    'use strict';
    
    
    let baseUrl = window.feedbackBaseUrl;
    if (!baseUrl) {
        const hostname = window.location.hostname;
        
        if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
            baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
        } else if (hostname.endsWith('.onion')) {
            baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
        } else {
            baseUrl = 'https://feedback.i2p.net';
        }
    }
    
    const script = document.createElement('script');
    script.src = baseUrl + '/widgets/docs-feedback.js';
    script.async = true;
    script.onerror = function() {
        console.error('[Docs Feedback] Failed to load docs-feedback.js from:', baseUrl);
    };
    document.body.appendChild(script);
})();
</script>


    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">ابقَ على اطلاع بأخبار I2P:</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="أدخل بريدك الإلكتروني" required>
                            <button type="submit">اشترك</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>روابط سريعة</h3>
                <ul>
                    <li><a href="../../../../ar/financial-support/">تبرع</a></li>
                    <li><a href="../../../../ar/docs/overview/intro/">مقدمة I2P</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>المجتمع</h3>
                <ul>
                    <li><a href="../../../../ar/get-involved/">شارك معنا</a></li>
                    <li><a href="../../../../ar/blog/">مدونة</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">المنتديات الرسمية</a></li>
                    <li><a href="../../../../ar/contact/">اتصل بنا</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>الموارد</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">إحصائيات I2P</a></li>
                    <li><a href="../../../../ar/papers/">بحث</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">ستورمي كلاود</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 مشروع الإنترنت الخفي. مرخص تحت Creative Commons.</p>
            <div class="footer-links">
                <a href="../../../../ar/privacy/">الخصوصية</a>
                <a href="../../../../ar/terms/">الشروط</a>
                <a href="../../../../ar/about/media/">الصحافة</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="إغلاق">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>استطلاع المجتمع</h2>
            <p class="modal-subtitle">نود أن نسمع منك</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                يساعد تصويتك في تشكيل مستقبل I2P.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
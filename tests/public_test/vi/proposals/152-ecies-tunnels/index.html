<!DOCTYPE html>
<html lang="vi" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Các tunnel ECIES | I2P - Dự án Internet vô hình</title>

    <meta name="description" content="The Invisible Internet Project - A privacy-focused, anonymous network layer">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="Các tunnel ECIES | I2P - Dự án Internet vô hình">
    <meta property="og:description" content="The Invisible Internet Project - A privacy-focused, anonymous network layer">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/vi/proposals/152-ecies-tunnels/">

    
    <link rel="icon" type="image/svg+xml" href="../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">Trang I2P Beta Đã Hoạt Động Gửi báo cáo lỗi tới stormycloud@mail.i2p</span>
            
        </div>
        
        <form method="GET" action="../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="Đóng banner" title="Đóng banner">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../vi/" class="logo-link">
                    <img src="../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../vi/about/" class="">Giới thiệu</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../vi/about/">Tổng quan</a></li>
                            <li><a href="../../../vi/papers/">Bài Nghiên Cứu</a></li>
                            <li><a href="../../../vi/about/media/">Báo chí</a></li>
                            <li><a href="../../../vi/contact/">Liên hệ</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../vi/docs/" class="">Tài liệu</a></li>
                    <li><a href="../../../vi/downloads/" class="">Tải xuống</a></li>
                    <li><a href="../../../vi/blog/" class="">Blog</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../vi/get-involved/" class="">Tham gia</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../vi/get-involved/">Tổng quan</a></li>
                            <li><a href="../../../vi/feedback/">Đề xuất Tính năng</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">vi</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../en/proposals/152-ecies-tunnels/"
                                class="lang-option">Tiếng Anh</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../es/proposals/152-ecies-tunnels/"
                                class="lang-option">Tiếng Tây Ban Nha</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ko/proposals/152-ecies-tunnels/"
                                class="lang-option">Tiếng Hàn</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../zh/proposals/152-ecies-tunnels/"
                                class="lang-option">Tiếng Trung</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ru/proposals/152-ecies-tunnels/"
                                class="lang-option">Tiếng Nga</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../cs/proposals/152-ecies-tunnels/"
                                class="lang-option">Tiếng Séc</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../de/proposals/152-ecies-tunnels/"
                                class="lang-option">Tiếng Đức</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../fr/proposals/152-ecies-tunnels/"
                                class="lang-option">Tiếng Pháp</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../tr/proposals/152-ecies-tunnels/"
                                class="lang-option">Tiếng Thổ Nhĩ Kỳ</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../vi/proposals/152-ecies-tunnels/"
                                class="lang-option active">Tiếng Việt</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../hi/proposals/152-ecies-tunnels/"
                                class="lang-option">Tiếng Hindi</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ar/proposals/152-ecies-tunnels/"
                                class="lang-option">Tiếng Ả Rập</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../pt/proposals/152-ecies-tunnels/"
                                class="lang-option">Tiếng Bồ Đào Nha</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../vi/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../vi/downloads/" class="btn btn-primary">Tải I2P</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        



<div class="proposals-page">
    <div class="container">
        
        <nav class="breadcrumbs">
            <a href="../../../vi/">Home</a>
            <span class="separator">/</span>
            <a href="../../../vi/proposals/">Proposals</a>
            <span class="separator">/</span>
            <span class="current">Các tunnel ECIES</span>
        </nav>

        
<div class="translation-disclaimer" role="note">
    <span class="disclaimer-message">Bản dịch này được tạo bằng máy học và có thể không chính xác 100%.</span>
    
    
    <a href="../../../en/proposals/152-ecies-tunnels/" class="disclaimer-link">Xem phiên bản tiếng Anh</a>
    
</div>



        
        <header class="proposal-header">
            <div class="proposal-title-section">
                <h1 class="proposal-title">Các tunnel ECIES</h1>
                <div class="proposal-number">Proposal 152</div>
            </div>

            
            <div class="proposal-meta-box">
                <div class="proposal-status status-đã đóng">
                    Đã đóng
                </div>

                
                <div class="proposal-info-grid">
                    
                    <div class="info-item">
                        <span class="info-label">Author</span>
                        <span class="info-value">chisana, zzz, orignal</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Created</span>
                        <span class="info-value">2019-07-04</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Last Updated</span>
                        <span class="info-value">2025-03-05</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Target Version</span>
                        <span class="info-value">0.9.48</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Implemented In</span>
                        <span class="info-value">0.9.48</span>
                    </div>
                    
                </div>

                
                
            </div>
        </header>

        
        <div class="proposal-layout proposal-layout--with-toc">
            
            
            <aside class="proposal-toc-sidebar">
                <nav class="toc-nav">
                    <div class="toc-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        On This Page
                    </div>
                    <div class="toc-content">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#lưu-ý">Lưu ý</a></li>
    <li><a href="#tổng-quan">Tổng quan</a>
      <ul>
        <li><a href="#các-nguyên-thủy-mật-mã">Các nguyên thủy mật mã</a></li>
        <li><a href="#mục-tiêu">Mục tiêu</a></li>
        <li><a href="#các-mục-tiêu-không-đặt-ra">Các mục tiêu không đặt ra</a></li>
      </ul>
    </li>
    <li><a href="#mô-hình-đe-dọa">Mô hình đe dọa</a>
      <ul>
        <li><a href="#mục-tiêu-thiết-kế">Mục tiêu thiết kế</a></li>
        <li><a href="#các-cuộc-tấn-công-gắn-thẻ-tagging-attacks">Các cuộc tấn công gắn thẻ (tagging attacks)</a></li>
      </ul>
    </li>
    <li><a href="#thiết-kế">Thiết kế</a>
      <ul>
        <li><a href="#noise-protocol-framework-khung-giao-thức-noise">Noise Protocol Framework (khung giao thức Noise)</a></li>
        <li><a href="#các-mẫu-bắt-tay">Các mẫu bắt tay</a></li>
        <li><a href="#mã-hóa-yêu-cầu">Mã hóa yêu cầu</a></li>
        <li><a href="#mã-hóa-phản-hồi">Mã hóa phản hồi</a></li>
        <li><a href="#lý-do">Lý do</a></li>
      </ul>
    </li>
    <li><a href="#đặc-tả">Đặc tả</a>
      <ul>
        <li><a href="#bản-ghi-yêu-cầu-xây-dựng">Bản ghi yêu cầu xây dựng</a></li>
        <li><a href="#các-bản-ghi-phản-hồi-xây-dựng">Các bản ghi phản hồi xây dựng</a></li>
        <li><a href="#mã-hóa-đối-xứng-cho-các-bản-ghi">Mã hóa đối xứng cho các bản ghi</a></li>
        <li><a href="#các-khóa-của-request-record-ecies">Các khóa của Request Record (ECIES)</a></li>
        <li><a href="#mã-hóa-bản-ghi-yêu-cầu-elgamal-thuật-toán-mật-mã-khóa-công-khai">Mã hóa bản ghi yêu cầu (ElGamal, thuật toán mật mã khóa công khai)</a></li>
        <li><a href="#mã-hóa-bản-ghi-phản-hồi-ecies---lược-đồ-mã-hóa-tích-hợp-dùng-đường-cong-elliptic">Mã hóa bản ghi phản hồi (ECIES - lược đồ mã hóa tích hợp dùng đường cong elliptic)</a></li>
        <li><a href="#mã-hóa-bản-ghi-phản-hồi-elgamal">Mã hóa bản ghi phản hồi (ElGamal)</a></li>
        <li><a href="#phân-tích-bảo-mật">Phân tích bảo mật</a></li>
      </ul>
    </li>
    <li><a href="#lý-do-1">Lý do</a></li>
    <li><a href="#ghi-chú-triển-khai">Ghi chú triển khai</a></li>
    <li><a href="#vấn-đề">Vấn đề</a></li>
    <li><a href="#di-chuyển">Di chuyển</a></li>
    <li><a href="#tài-liệu-tham-khảo">Tài liệu tham khảo</a></li>
  </ul>
</nav>
                    </div>
                </nav>
            </aside>
            

            
            <div class="proposal-main">
                <article class="proposal-content">
                    <h2 id="lưu-ý">Lưu ý</h2>
<p>Việc triển khai và kiểm thử mạng đang được tiến hành. Có thể sẽ có các điều chỉnh nhỏ. Xem <a href="../../../vi/docs/specs/implementation/">SPEC</a>
 để biết đặc tả chính thức.</p>
<h2 id="tổng-quan">Tổng quan</h2>
<p>Tài liệu này đề xuất các thay đổi đối với việc mã hóa thông điệp Tunnel Build bằng cách sử dụng các nguyên thủy mật mã được giới thiệu bởi <a href="../../../vi/docs/specs/ecies/">ECIES-X25519</a>
. Đây là một phần của đề xuất tổng thể <a href="../../../vi/proposals/156-ecies-routers">Proposal 156</a>
 nhằm chuyển đổi routers từ ElGamal sang các khóa ECIES-X25519.</p>
<p>Để phục vụ việc chuyển đổi mạng từ ElGamal + AES256 sang ECIES + ChaCha20, các tunnels với các routers ElGamal và ECIES trộn lẫn là cần thiết. Các đặc tả kỹ thuật để xử lý các hop (chặng) trong tunnel hỗn hợp được cung cấp. Sẽ không có thay đổi nào đối với định dạng, xử lý hoặc mã hóa của các hop ElGamal.</p>
<p>Những người tạo tunnel ElGamal sẽ cần tạo các cặp khóa X25519 tạm thời cho mỗi hop (bước nhảy), và tuân theo đặc tả này để tạo các tunnel chứa các hop ECIES.</p>
<p>Đề xuất này nêu rõ các thay đổi cần thiết cho việc xây dựng Tunnel bằng ECIES-X25519. Để có cái nhìn tổng quan về tất cả các thay đổi cần thiết cho ECIES routers, xem đề xuất 156 <a href="../../../vi/proposals/156-ecies-routers">Đề xuất 156</a>
.</p>
<p>Đề xuất này giữ nguyên kích thước của các bản ghi xây dựng tunnel, theo yêu cầu để đảm bảo khả năng tương thích. Các bản ghi xây dựng và thông điệp nhỏ hơn sẽ được triển khai sau - xem <a href="../../../vi/proposals/157-new-tbm">Proposal 157</a>
.</p>
<h3 id="các-nguyên-thủy-mật-mã">Các nguyên thủy mật mã</h3>
<p>Không có phép nguyên thủy mật mã mới nào được giới thiệu. Các phép nguyên thủy cần thiết để triển khai đề xuất này là:</p>
<ul>
<li>AES-256-CBC như trong <a href="../../../vi/docs/specs/cryptography/">Mật mã học</a>
</li>
<li>Các hàm STREAM ChaCha20/Poly1305:
ENCRYPT(k, n, plaintext, ad) và DECRYPT(k, n, ciphertext, ad) - như trong <a href="../../../vi/docs/specs/ntcp2/">NTCP2</a>
 <a href="../../../vi/docs/specs/ecies/">ECIES-X25519</a>
 và <a href="https://tools.ietf.org/html/rfc7539">RFC-7539</a>
</li>
<li>Các hàm DH X25519 - như trong <a href="../../../vi/docs/specs/ntcp2/">NTCP2</a>
 và <a href="../../../vi/docs/specs/ecies/">ECIES-X25519</a>
</li>
<li>HKDF(salt, ikm, info, n) (hàm dẫn xuất khóa dựa trên HMAC) - như trong <a href="../../../vi/docs/specs/ntcp2/">NTCP2</a>
 và <a href="../../../vi/docs/specs/ecies/">ECIES-X25519</a>
</li>
</ul>
<p>Các hàm Noise (khuôn khổ giao thức mật mã) khác được định nghĩa ở nơi khác:</p>
<ul>
<li>MixHash(d) (hàm trộn băm) - như trong <a href="../../../vi/docs/specs/ntcp2/">NTCP2</a>
 và <a href="../../../vi/docs/specs/ecies/">ECIES-X25519</a>
</li>
<li>MixKey(d) (hàm trộn khóa) - như trong <a href="../../../vi/docs/specs/ntcp2/">NTCP2</a>
 và <a href="../../../vi/docs/specs/ecies/">ECIES-X25519</a>
</li>
</ul>
<h3 id="mục-tiêu">Mục tiêu</h3>
<h3 id="các-mục-tiêu-không-đặt-ra">Các mục tiêu không đặt ra</h3>
<ul>
<li>Thiết kế lại hoàn toàn các thông điệp dựng tunnel, yêu cầu một &ldquo;flag day&rdquo; (thời điểm chuyển đổi đồng loạt không tương thích ngược).</li>
<li>Thu nhỏ các thông điệp dựng tunnel (yêu cầu các hop (chặng trung gian) đều dùng ECIES và một đề xuất mới)</li>
<li>Sử dụng các tùy chọn dựng tunnel như được định nghĩa trong <a href="../../../vi/proposals/143-build-message-options">Proposal 143</a>
, chỉ bắt buộc đối với các thông điệp nhỏ</li>
<li>Các tunnel hai chiều - xem <a href="../../../vi/proposals/119-bidirectional-tunnels">Proposal 119</a>
</li>
<li>Các thông điệp dựng tunnel nhỏ hơn - xem <a href="../../../vi/proposals/157-new-tbm">Proposal 157</a>
</li>
</ul>
<h2 id="mô-hình-đe-dọa">Mô hình đe dọa</h2>
<h3 id="mục-tiêu-thiết-kế">Mục tiêu thiết kế</h3>
<ul>
<li>
<p>Không có nút trung gian nào có thể xác định được bên khởi tạo của tunnel.</p>
</li>
<li>
<p>Các hop (chặng) trung gian không thể xác định hướng của tunnel
hoặc vị trí của mình trong tunnel.</p>
</li>
<li>
<p>Không chặng nào có thể đọc bất kỳ nội dung nào của các bản ghi yêu cầu hoặc phản hồi khác, ngoại trừ
hash router đã bị cắt ngắn và khóa tạm thời cho chặng tiếp theo</p>
</li>
<li>
<p>Không thành viên nào của tunnel phản hồi dùng cho outbound build (quá trình dựng tunnel đi ra) có thể đọc bất kỳ bản ghi phản hồi nào.</p>
</li>
<li>
<p>Không thành viên nào của tunnel đi ra dùng cho việc xây dựng tunnel đi vào có thể đọc bất kỳ bản ghi yêu cầu nào,
ngoại trừ việc OBEP (Outbound Endpoint - nút cuối của outbound tunnel) có thể thấy hash router bị cắt ngắn và khóa tạm thời dành cho IBGW (Inbound Gateway - cổng vào của inbound tunnel)</p>
</li>
</ul>
<h3 id="các-cuộc-tấn-công-gắn-thẻ-tagging-attacks">Các cuộc tấn công gắn thẻ (tagging attacks)</h3>
<p>Một mục tiêu quan trọng của thiết kế xây dựng tunnel là khiến việc các router X và Y thông đồng biết rằng chúng đang ở trong cùng một tunnel trở nên khó khăn hơn. Nếu router X ở bước nhảy m và router Y ở bước nhảy m+1, hiển nhiên chúng sẽ biết. Nhưng nếu router X ở bước nhảy m và router Y ở bước nhảy m+n với n&gt;1, thì điều đó sẽ khó hơn nhiều.</p>
<p>Tấn công gắn thẻ là khi router ở chặng trung gian X sửa đổi thông điệp xây dựng tunnel theo cách để router Y có thể phát hiện sự sửa đổi đó khi thông điệp đến nơi. Mục tiêu là mọi thông điệp đã bị sửa đổi sẽ bị một router nằm giữa X và Y loại bỏ trước khi nó tới router Y. Đối với các sửa đổi không bị loại bỏ trước router Y, router tạo tunnel phải phát hiện dữ liệu bị hỏng trong phản hồi và hủy bỏ tunnel.</p>
<p>Các cuộc tấn công có thể xảy ra:</p>
<ul>
<li>Sửa đổi một build record (bản ghi xây dựng)</li>
<li>Thay thế một build record</li>
<li>Thêm hoặc xóa một build record</li>
<li>Sắp xếp lại các build record</li>
</ul>
<p>TODO: Thiết kế hiện tại có ngăn chặn tất cả các cuộc tấn công này không?</p>
<h2 id="thiết-kế">Thiết kế</h2>
<h3 id="noise-protocol-framework-khung-giao-thức-noise">Noise Protocol Framework (khung giao thức Noise)</h3>
<p>Đề xuất này nêu các yêu cầu dựa trên Noise Protocol Framework <a href="https://noiseprotocol.org/noise.html">NOISE</a>
 (Bản sửa đổi 34, 2018-07-11). Theo thuật ngữ của Noise, Alice là bên khởi tạo (initiator), và Bob là bên phản hồi (responder).</p>
<p>Đề xuất này dựa trên giao thức Noise Noise_N_25519_ChaChaPoly_SHA256. Giao thức Noise này sử dụng các nguyên thủy mật mã sau:</p>
<ul>
<li>
<p>Mẫu bắt tay một chiều: N
Alice không gửi khóa tĩnh của mình cho Bob (N)</p>
</li>
<li>
<p>Hàm DH: X25519
X25519 DH với độ dài khóa 32 byte như được quy định trong <a href="https://tools.ietf.org/html/rfc7748">RFC-7748</a>
.</p>
</li>
<li>
<p>Hàm mật mã: ChaChaPoly
AEAD_CHACHA20_POLY1305 như được quy định trong <a href="https://tools.ietf.org/html/rfc7539">RFC-7539</a>
 Mục 2.8.
Nonce (giá trị dùng một lần) 12 byte, với 4 byte đầu được đặt về 0.
Giống hệt như trong <a href="../../../vi/docs/specs/ntcp2/">NTCP2</a>
.</p>
</li>
<li>
<p>Hàm băm: SHA256
Mã băm tiêu chuẩn 32 byte, đã được sử dụng rộng rãi trong I2P.</p>
</li>
</ul>
<h4 id="bổ-sung-cho-khung-làm-việc">Bổ sung cho khung làm việc</h4>
<p>Không có.</p>
<h3 id="các-mẫu-bắt-tay">Các mẫu bắt tay</h3>
<p>Các quy trình bắt tay sử dụng các mẫu bắt tay <a href="https://noiseprotocol.org/noise.html">Noise</a>
.</p>
<p>Bảng ánh xạ chữ cái sau đây được sử dụng:</p>
<ul>
<li>e = khóa tạm thời dùng một lần</li>
<li>s = khóa tĩnh</li>
<li>p = phần tải của thông điệp</li>
</ul>
<p>Yêu cầu xây dựng giống hệt với Noise N pattern (mẫu Noise N). Điều này cũng giống hệt với thông điệp đầu tiên (Session Request) trong XK pattern (mẫu XK) được sử dụng trong <a href="../../../vi/docs/specs/ntcp2/">NTCP2</a>
.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>&lt;- s
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  e es p -&gt;
</span></span></code></pre></div><h3 id="mã-hóa-yêu-cầu">Mã hóa yêu cầu</h3>
<p>Các bản ghi yêu cầu xây dựng được tạo bởi người tạo tunnel và được mã hóa bất đối xứng cho từng hop (bước nhảy qua một nút trung gian). Việc mã hóa bất đối xứng các bản ghi yêu cầu hiện sử dụng ElGamal như được định nghĩa trong <a href="../../../vi/docs/specs/cryptography/">Cryptography</a>
 và bao gồm một checksum SHA-256. Thiết kế này không có forward secrecy (tính bảo mật chuyển tiếp).</p>
<p>Thiết kế mới sẽ sử dụng mẫu Noise một chiều &ldquo;N&rdquo; với ECIES-X25519 Diffie–Hellman tạm–tĩnh (ephemeral-static), cùng HKDF và ChaCha20/Poly1305 AEAD để đạt bí mật chuyển tiếp, tính toàn vẹn và xác thực. Alice là bên yêu cầu xây dựng tunnel. Mỗi chặng (hop) trong tunnel là một Bob.</p>
<p>(Các thuộc tính bảo mật của Payload (phần dữ liệu))</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>N:                      Authentication   Confidentiality
</span></span><span style="display:flex;"><span>    -&gt; e, es                  0                2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Authentication: None (0).
</span></span><span style="display:flex;"><span>    This payload may have been sent by any party, including an active attacker.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Confidentiality: 2.
</span></span><span style="display:flex;"><span>    Encryption to a known recipient, forward secrecy for sender compromise
</span></span><span style="display:flex;"><span>    only, vulnerable to replay.  This payload is encrypted based only on DHs
</span></span><span style="display:flex;"><span>    involving the recipient&#39;s static key pair.  If the recipient&#39;s static
</span></span><span style="display:flex;"><span>    private key is compromised, even at a later date, this payload can be
</span></span><span style="display:flex;"><span>    decrypted.  This message can also be replayed, since there&#39;s no ephemeral
</span></span><span style="display:flex;"><span>    contribution from the recipient.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    &#34;e&#34;: Alice generates a new ephemeral key pair and stores it in the e
</span></span><span style="display:flex;"><span>         variable, writes the ephemeral public key as cleartext into the
</span></span><span style="display:flex;"><span>         message buffer, and hashes the public key along with the old h to
</span></span><span style="display:flex;"><span>         derive a new h.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    &#34;es&#34;: A DH is performed between the Alice&#39;s ephemeral key pair and the
</span></span><span style="display:flex;"><span>          Bob&#39;s static key pair.  The result is hashed along with the old ck to
</span></span><span style="display:flex;"><span>          derive a new ck and k, and n is set to zero.
</span></span></code></pre></div><h3 id="mã-hóa-phản-hồi">Mã hóa phản hồi</h3>
<p>Các bản ghi phản hồi xây dựng được tạo bởi người tạo hop (nút trung gian) và được mã hóa đối xứng cho người tạo. Việc mã hóa đối xứng các bản ghi phản hồi này hiện sử dụng AES, với một checksum SHA-256 được chèn ở đầu. Thiết kế này không có tính bảo mật chuyển tiếp (forward secrecy).</p>
<p>Thiết kế mới sẽ sử dụng ChaCha20/Poly1305 AEAD (mã hóa xác thực kèm dữ liệu) để bảo đảm tính toàn vẹn và xác thực.</p>
<h3 id="lý-do">Lý do</h3>
<p>Khóa công khai tạm thời trong yêu cầu không cần phải được che giấu bằng AES hoặc Elligator2 (kỹ thuật ánh xạ điểm trên đường cong elliptic thành dữ liệu trông ngẫu nhiên). Chỉ chặng trước đó mới có thể thấy nó, và chặng đó biết rằng chặng kế tiếp sử dụng ECIES (lược đồ mã hóa tích hợp dựa trên đường cong elliptic).</p>
<p>Các bản ghi phản hồi không cần mã hóa bất đối xứng đầy đủ với một lần DH (Diffie–Hellman, trao đổi khóa) khác.</p>
<h2 id="đặc-tả">Đặc tả</h2>
<h3 id="bản-ghi-yêu-cầu-xây-dựng">Bản ghi yêu cầu xây dựng</h3>
<p>BuildRequestRecords (các bản ghi yêu cầu xây dựng) được mã hóa có kích thước 528 byte cho cả ElGamal và ECIES, để đảm bảo tính tương thích.</p>
<h4 id="bản-ghi-yêu-cầu-không-mã-hóa-elgamal">Bản ghi yêu cầu không mã hóa (ElGamal)</h4>
<p>Để tham khảo, đây là đặc tả hiện tại của tunnel BuildRequestRecord (bản ghi yêu cầu xây dựng) dành cho các router ElGamal, trích từ <a href="../../../vi/docs/specs/i2np/">I2NP</a>
. Dữ liệu chưa mã hóa được thêm ở đầu một byte khác 0 và giá trị băm SHA-256 của dữ liệu trước khi mã hóa, như được định nghĩa trong <a href="../../../vi/docs/specs/cryptography/">Cryptography</a>
.</p>
<p>Tất cả các trường đều ở dạng big-endian (thứ tự byte lớn trước).</p>
<p>Kích thước chưa mã hóa: 222 byte</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bytes     0-3: tunnel ID to receive messages as, nonzero
</span></span><span style="display:flex;"><span>  bytes    4-35: local router identity hash
</span></span><span style="display:flex;"><span>  bytes   36-39: next tunnel ID, nonzero
</span></span><span style="display:flex;"><span>  bytes   40-71: next router identity hash
</span></span><span style="display:flex;"><span>  bytes  72-103: AES-256 tunnel layer key
</span></span><span style="display:flex;"><span>  bytes 104-135: AES-256 tunnel IV key
</span></span><span style="display:flex;"><span>  bytes 136-167: AES-256 reply key
</span></span><span style="display:flex;"><span>  bytes 168-183: AES-256 reply IV
</span></span><span style="display:flex;"><span>  byte      184: flags
</span></span><span style="display:flex;"><span>  bytes 185-188: request time (in hours since the epoch, rounded down)
</span></span><span style="display:flex;"><span>  bytes 189-192: next message ID
</span></span><span style="display:flex;"><span>  bytes 193-221: uninterpreted / random padding
</span></span></code></pre></div><h4 id="bản-ghi-yêu-cầu-được-mã-hóa-elgamal">Bản ghi yêu cầu được mã hóa (ElGamal)</h4>
<p>Để tham khảo, đây là đặc tả hiện tại của BuildRequestRecord (bản ghi yêu cầu xây dựng) trong tunnel dành cho các router ElGamal, được lấy từ <a href="../../../vi/docs/specs/i2np/">I2NP</a>
.</p>
<p>Kích thước đã mã hóa: 528 byte</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bytes    0-15: Hop&#39;s truncated identity hash
</span></span><span style="display:flex;"><span>  bytes  16-528: ElGamal encrypted BuildRequestRecord
</span></span></code></pre></div><h4 id="bản-ghi-yêu-cầu-không-mã-hóa-ecies---sơ-đồ-mã-hóa-tích-hợp-dùng-đường-cong-elliptic">Bản ghi yêu cầu không mã hóa (ECIES - sơ đồ mã hóa tích hợp dùng đường cong elliptic)</h4>
<p>Đây là bản đặc tả được đề xuất cho BuildRequestRecord (bản ghi yêu cầu xây dựng) của tunnel dành cho các router ECIES-X25519. Tóm tắt các thay đổi:</p>
<ul>
<li>Loại bỏ băm router 32 byte không dùng</li>
<li>Thay đổi thời gian yêu cầu từ giờ sang phút</li>
<li>Thêm trường hết hạn cho thời gian tunnel biến đổi trong tương lai</li>
<li>Tăng dung lượng dành cho các cờ</li>
<li>Thêm Mapping cho các tùy chọn dựng bổ sung</li>
<li>Khóa phản hồi AES-256 và IV không được dùng cho bản ghi phản hồi của chính hop (chặng)</li>
<li>Bản ghi không được mã hóa dài hơn vì phần phụ trội mã hóa ít hơn</li>
</ul>
<p>Bản ghi yêu cầu không chứa bất kỳ khóa trả lời ChaCha nào. Những khóa đó được dẫn xuất từ một KDF (hàm dẫn xuất khóa). Xem bên dưới.</p>
<p>Tất cả các trường đều theo big-endian (byte có trọng số cao đứng trước).</p>
<p>Kích thước chưa mã hóa: 464 byte</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bytes     0-3: tunnel ID to receive messages as, nonzero
</span></span><span style="display:flex;"><span>  bytes     4-7: next tunnel ID, nonzero
</span></span><span style="display:flex;"><span>  bytes    8-39: next router identity hash
</span></span><span style="display:flex;"><span>  bytes   40-71: AES-256 tunnel layer key
</span></span><span style="display:flex;"><span>  bytes  72-103: AES-256 tunnel IV key
</span></span><span style="display:flex;"><span>  bytes 104-135: AES-256 reply key
</span></span><span style="display:flex;"><span>  bytes 136-151: AES-256 reply IV
</span></span><span style="display:flex;"><span>  byte      152: flags
</span></span><span style="display:flex;"><span>  bytes 153-155: more flags, unused, set to 0 for compatibility
</span></span><span style="display:flex;"><span>  bytes 156-159: request time (in minutes since the epoch, rounded down)
</span></span><span style="display:flex;"><span>  bytes 160-163: request expiration (in seconds since creation)
</span></span><span style="display:flex;"><span>  bytes 164-167: next message ID
</span></span><span style="display:flex;"><span>  bytes   168-x: tunnel build options (Mapping)
</span></span><span style="display:flex;"><span>  bytes     x-x: other data as implied by flags or options
</span></span><span style="display:flex;"><span>  bytes   x-463: random padding
</span></span></code></pre></div><p>Trường flags giống như được định nghĩa trong <a href="../../../vi/docs/specs/implementation/">Tạo Tunnel</a>
 và chứa các nội dung sau đây::</p>
<p>Thứ tự bit: 76543210 (bit 7 là MSB (bit có ý nghĩa lớn nhất))  bit 7: nếu được đặt, cho phép nhận thông điệp từ bất kỳ ai  bit 6: nếu được đặt, cho phép gửi thông điệp tới bất kỳ ai, và gửi phản hồi tới</p>
<pre><code>    specified next hop in a Tunnel Build Reply Message
</code></pre>
<p>các bit 5-0: Không xác định, phải đặt thành 0 để đảm bảo khả năng tương thích với các tùy chọn trong tương lai</p>
<p>Bit 7 cho biết chặng sẽ là một inbound gateway (IBGW).  Bit 6 cho biết chặng sẽ là một outbound endpoint (OBEP).  Nếu không bit nào được đặt, chặng sẽ là một chặng trung gian.  Không thể đặt cả hai cùng lúc.</p>
<p>Request expiration (thời điểm hết hạn của yêu cầu) được dùng cho tính năng thời lượng tunnel thay đổi trong tương lai. Hiện tại, giá trị duy nhất được hỗ trợ là 600 (10 phút).</p>
<p>Tùy chọn xây dựng tunnel là một cấu trúc Mapping (ánh xạ) như được định nghĩa trong <a href="../../../vi/docs/specs/common-structures/">Common Structures</a>
. Phần này dành cho việc sử dụng trong tương lai. Hiện chưa có tùy chọn nào được định nghĩa. Nếu cấu trúc Mapping trống, thì phần này là hai byte 0x00 0x00. Kích thước tối đa của Mapping (bao gồm cả trường độ dài) là 296 byte, và giá trị tối đa của trường độ dài Mapping là 294.</p>
<h4 id="bản-ghi-yêu-cầu-được-mã-hóa-ecies-lược-đồ-mã-hóa-tích-hợp-trên-đường-cong-elliptic">Bản ghi yêu cầu được mã hóa (ECIES, lược đồ mã hóa tích hợp trên đường cong elliptic)</h4>
<p>Tất cả các trường đều ở dạng big-endian (thứ tự byte lớn trước), ngoại trừ khóa công khai tạm thời, vốn ở dạng little-endian (thứ tự byte nhỏ trước).</p>
<p>Kích thước đã mã hóa: 528 byte</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bytes    0-15: Hop&#39;s truncated identity hash
</span></span><span style="display:flex;"><span>  bytes   16-47: Sender&#39;s ephemeral X25519 public key
</span></span><span style="display:flex;"><span>  bytes  48-511: ChaCha20 encrypted BuildRequestRecord
</span></span><span style="display:flex;"><span>  bytes 512-527: Poly1305 MAC
</span></span></code></pre></div><h3 id="các-bản-ghi-phản-hồi-xây-dựng">Các bản ghi phản hồi xây dựng</h3>
<p>BuildReplyRecords được mã hóa (các bản ghi phản hồi xây dựng) có kích thước 528 byte cho cả ElGamal và ECIES, để đảm bảo khả năng tương thích.</p>
<h4 id="bản-ghi-phản-hồi-không-mã-hóa-elgamal">Bản ghi phản hồi không mã hóa (ElGamal)</h4>
<p>Các phản hồi ElGamal (một thuật toán mã hóa khóa công khai) được mã hóa bằng AES (chuẩn mã hóa đối xứng).</p>
<p>Tất cả các trường sử dụng big-endian (thứ tự byte từ cao đến thấp).</p>
<p>Kích thước chưa mã hóa: 528 byte</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bytes   0-31: SHA-256 Hash of bytes 32-527
</span></span><span style="display:flex;"><span>  bytes 32-526: random data
</span></span><span style="display:flex;"><span>  byte     527: reply
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  total length: 528
</span></span></code></pre></div><h4 id="bản-ghi-phản-hồi-không-được-mã-hóa-ecies---lược-đồ-mã-hóa-tích-hợp-dựa-trên-đường-cong-elliptic">Bản ghi phản hồi không được mã hóa (ECIES - lược đồ mã hóa tích hợp dựa trên đường cong elliptic)</h4>
<p>Đây là bản đặc tả được đề xuất cho BuildReplyRecord của tunnel áp dụng cho các routers ECIES-X25519. Tóm tắt các thay đổi:</p>
<ul>
<li>Thêm ánh xạ cho các tùy chọn Build Reply (phản hồi xây dựng)</li>
<li>Bản ghi không được mã hóa dài hơn vì có ít phụ phí mã hóa hơn</li>
</ul>
<p>Các phản hồi ECIES (lược đồ mã hóa tích hợp đường cong elliptic) được mã hóa bằng ChaCha20/Poly1305.</p>
<p>Tất cả các trường theo big-endian (thứ tự byte có ý nghĩa cao trước).</p>
<p>Kích thước chưa mã hóa: 512 byte</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bytes    0-x: Tunnel Build Reply Options (Mapping)
</span></span><span style="display:flex;"><span>  bytes    x-x: other data as implied by options
</span></span><span style="display:flex;"><span>  bytes  x-510: Random padding
</span></span><span style="display:flex;"><span>  byte     511: Reply byte
</span></span></code></pre></div><p>Các tùy chọn phản hồi xây dựng tunnel là một cấu trúc Mapping (ánh xạ) như được định nghĩa trong <a href="../../../vi/docs/specs/common-structures/">Common Structures</a>
. Đây là để sử dụng trong tương lai. Hiện chưa có tùy chọn nào được định nghĩa. Nếu cấu trúc Mapping trống, thì nó là hai byte 0x00 0x00. Kích thước tối đa của Mapping (bao gồm cả trường độ dài) là 511 byte, và giá trị tối đa của trường độ dài của Mapping là 509.</p>
<p>Byte phản hồi là một trong các giá trị sau đây, như được định nghĩa trong <a href="../../../vi/docs/specs/implementation/">Tunnel Creation</a>
 để tránh bị nhận dạng qua dấu vân tay:</p>
<ul>
<li>0x00 (chấp nhận)</li>
<li>30 (TUNNEL_REJECT_BANDWIDTH)</li>
</ul>
<h4 id="bản-ghi-phản-hồi-được-mã-hóa-ecies-lược-đồ-mã-hóa-tích-hợp-dựa-trên-đường-cong-elliptic">Bản ghi phản hồi được mã hóa (ECIES, lược đồ mã hóa tích hợp dựa trên đường cong elliptic)</h4>
<p>Kích thước đã mã hóa: 528 byte</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bytes   0-511: ChaCha20 encrypted BuildReplyRecord
</span></span><span style="display:flex;"><span>  bytes 512-527: Poly1305 MAC
</span></span></code></pre></div><p>Sau khi chuyển đổi hoàn toàn sang các bản ghi ECIES (Elliptic Curve Integrated Encryption Scheme - sơ đồ mã hóa tích hợp đường cong elliptic), các quy tắc đệm theo phạm vi giống như đối với các bản ghi yêu cầu.</p>
<h3 id="mã-hóa-đối-xứng-cho-các-bản-ghi">Mã hóa đối xứng cho các bản ghi</h3>
<p>Các tunnels hỗn hợp được phép và là cần thiết để chuyển đổi từ ElGamal sang ECIES. Trong giai đoạn chuyển tiếp, ngày càng nhiều routers sẽ sử dụng khóa ECIES.</p>
<p>Tiền xử lý mật mã đối xứng sẽ chạy theo cùng một cách:</p>
<ul>
<li>
<p>&ldquo;encryption&rdquo;:</p>
</li>
<li>
<p>thuật toán mật mã chạy ở chế độ giải mã</p>
<ul>
<li>các bản ghi yêu cầu được giải mã sớm trong bước tiền xử lý (nhằm che giấu các bản ghi yêu cầu đã mã hóa)</li>
</ul>
</li>
<li>
<p>&ldquo;giải mã&rdquo;:</p>
</li>
<li>
<p>thuật toán mật mã chạy ở chế độ mã hóa</p>
<ul>
<li>các bản ghi yêu cầu được mã hóa (làm lộ bản ghi yêu cầu ở dạng bản rõ tiếp theo) bởi các hop (bước nhảy) tham gia</li>
</ul>
</li>
<li>
<p>ChaCha20 không có &ldquo;chế độ&rdquo;, vì vậy nó chỉ đơn giản được chạy ba lần:</p>
</li>
<li>
<p>một lần trong bước tiền xử lý</p>
<ul>
<li>một lần do hop (nút trung gian) thực hiện</li>
<li>một lần trong bước xử lý phản hồi cuối cùng</li>
</ul>
</li>
</ul>
<p>Khi sử dụng các tunnel hỗn hợp, bên tạo tunnel sẽ cần cấu hình việc mã hóa đối xứng của BuildRequestRecord (bản ghi yêu cầu xây dựng) dựa vào loại mã hóa của chặng hiện tại và chặng liền trước.</p>
<p>Mỗi hop (chặng) sẽ sử dụng kiểu mã hóa riêng của nó để mã hóa BuildReplyRecords và các bản ghi khác trong VariableTunnelBuildMessage (VTBM).</p>
<p>Trên đường đi phản hồi, điểm cuối (người gửi) sẽ cần gỡ bỏ <a href="https://en.wikipedia.org/wiki/Multiple_encryption">Mã hóa nhiều lần</a>
, bằng cách sử dụng khóa phản hồi của từng hop (bước nhảy).</p>
<p>Để minh họa rõ hơn, hãy xem một tunnel đi ra với ECIES được bao bọc bởi ElGamal:</p>
<ul>
<li>Người gửi (OBGW) -&gt; ElGamal (H1) -&gt; ECIES (H2) -&gt; ElGamal (H3)</li>
</ul>
<p>Tất cả BuildRequestRecords đều ở trạng thái được mã hóa (sử dụng ElGamal hoặc ECIES).</p>
<p>Mật mã AES256/CBC, khi được sử dụng, vẫn được áp dụng cho từng bản ghi, không xâu chuỗi qua nhiều bản ghi.</p>
<p>Tương tự, ChaCha20 sẽ được dùng để mã hóa từng bản ghi, không mã hóa theo luồng trên toàn bộ VTBM (thông điệp VTBM).</p>
<p>Các bản ghi yêu cầu được tiền xử lý bởi bên gửi (OBGW):</p>
<ul>
<li>
<p>Bản ghi của H3 được &ldquo;mã hóa&rdquo; bằng:</p>
</li>
<li>
<p>Khóa phản hồi của H2 (ChaCha20)</p>
<ul>
<li>Khóa phản hồi của H1 (AES256/CBC)</li>
</ul>
</li>
<li>
<p>Bản ghi của H2 được &ldquo;mã hóa&rdquo; bằng:</p>
</li>
<li>
<p>khóa phản hồi của H1 (AES256/CBC)</p>
</li>
<li>
<p>Bản ghi của H1 được gửi đi mà không có mã hóa đối xứng</p>
</li>
</ul>
<p>Chỉ H2 kiểm tra cờ mã hóa phản hồi, và nhận thấy nó được theo sau bởi AES256/CBC.</p>
<p>Sau khi được xử lý qua từng hop (nút chuyển tiếp), các bản ghi ở trạng thái &ldquo;decrypted&rdquo;:</p>
<ul>
<li>
<p>Bản ghi của H3 được &ldquo;giải mã&rdquo; bằng:</p>
</li>
<li>
<p>Khóa hồi đáp của H3 (AES256/CBC)</p>
</li>
<li>
<p>Bản ghi của H2 được &ldquo;giải mã&rdquo; bằng:</p>
</li>
<li>
<p>Khóa phản hồi của H3 (AES256/CBC)</p>
<ul>
<li>Khóa phản hồi của H2 (ChaCha20-Poly1305)</li>
</ul>
</li>
<li>
<p>Bản ghi của H1 được &ldquo;giải mã&rdquo; bằng:</p>
</li>
<li>
<p>Khóa phản hồi của H3 (AES256/CBC)</p>
<ul>
<li>Khóa phản hồi của H2 (ChaCha20)</li>
<li>Khóa phản hồi của H1 (AES256/CBC)</li>
</ul>
</li>
</ul>
<p>Trình tạo tunnel, còn gọi là Inbound Endpoint (IBEP) (điểm cuối vào), thực hiện hậu xử lý đối với phản hồi:</p>
<ul>
<li>
<p>Bản ghi của H3 được &ldquo;mã hóa&rdquo; bằng:</p>
</li>
<li>
<p>Khóa phản hồi của H3 (AES256/CBC)</p>
</li>
<li>
<p>Bản ghi của H2 được &ldquo;mã hóa&rdquo; bằng:</p>
</li>
<li>
<p>Khóa phản hồi của H3 (AES256/CBC)</p>
<ul>
<li>Khóa phản hồi của H2 (ChaCha20-Poly1305)</li>
</ul>
</li>
<li>
<p>Bản ghi của H1 được &ldquo;mã hóa&rdquo; bằng:</p>
</li>
<li>
<p>Khóa phản hồi của H3 (AES256/CBC)</p>
<ul>
<li>Khóa phản hồi của H2 (ChaCha20)</li>
<li>Khóa phản hồi của H1 (AES256/CBC)</li>
</ul>
</li>
</ul>
<h3 id="các-khóa-của-request-record-ecies">Các khóa của Request Record (ECIES)</h3>
<p>Những khóa này được bao gồm tường minh trong ElGamal BuildRequestRecords (bản ghi yêu cầu xây dựng). Đối với ECIES BuildRequestRecords, các khóa tunnel và khóa phản hồi AES được bao gồm, nhưng các khóa phản hồi ChaCha được dẫn xuất từ DH exchange (trao đổi khóa Diffie–Hellman). Xem <a href="../../../vi/proposals/156-ecies-routers">Đề xuất 156</a>
 để biết chi tiết về các khóa ECIES tĩnh của router.</p>
<p>Dưới đây là mô tả về cách dẫn xuất các khóa đã được truyền trước đó trong các bản ghi yêu cầu.</p>
<h4 id="kdf-hàm-dẫn-xuất-khóa-cho-ck-và-h-khởi-tạo">KDF (hàm dẫn xuất khóa) cho ck và h khởi tạo</h4>
<p>Đây là <a href="https://noiseprotocol.org/noise.html">NOISE</a>
 tiêu chuẩn cho mẫu &ldquo;N&rdquo; với tên giao thức tiêu chuẩn.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>This is the &#34;e&#34; message pattern:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // Define protocol_name.
</span></span><span style="display:flex;"><span>  Set protocol_name = &#34;Noise_N_25519_ChaChaPoly_SHA256&#34;
</span></span><span style="display:flex;"><span>  (31 bytes, US-ASCII encoded, no NULL termination).
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // Define Hash h = 32 bytes
</span></span><span style="display:flex;"><span>  // Pad to 32 bytes. Do NOT hash it, because it is not more than 32 bytes.
</span></span><span style="display:flex;"><span>  h = protocol_name || 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Define ck = 32 byte chaining key. Copy the h data to ck.
</span></span><span style="display:flex;"><span>  Set chainKey = h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // MixHash(null prologue)
</span></span><span style="display:flex;"><span>  h = SHA256(h);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // up until here, can all be precalculated by all routers.
</span></span></code></pre></div><h4 id="hàm-dẫn-xuất-khóa-kdf-cho-bản-ghi-yêu-cầu">Hàm dẫn xuất khóa (KDF) cho bản ghi yêu cầu</h4>
<p>Các bên tạo tunnel dùng ElGamal (thuật toán mật mã ElGamal) tạo ra một cặp khóa X25519 (thuật toán trao đổi khóa dựa trên đường cong elliptic) tạm thời cho mỗi chặng ECIES (hệ mã dựa trên đường cong elliptic) trong tunnel, và dùng lược đồ ở trên để mã hóa BuildRequestRecord của họ. Các bên tạo tunnel dùng ElGamal sẽ dùng lược đồ trước đặc tả này để mã hóa tới các chặng ElGamal.</p>
<p>Các bên tạo tunnel ECIES sẽ cần mã hóa bằng khóa công khai của từng hop (nút trung gian) ElGamal theo sơ đồ được định nghĩa trong <a href="../../../vi/docs/specs/implementation/">Tunnel Creation</a>
. Các bên tạo tunnel ECIES sẽ sử dụng sơ đồ trên để mã hóa cho các hop ECIES.</p>
<p>Điều này có nghĩa là các hop (chặng trung gian) của tunnel sẽ chỉ nhìn thấy các bản ghi được mã hóa bằng cùng kiểu mã hóa như của chúng.</p>
<p>Đối với các trình tạo tunnel dùng ElGamal và ECIES, họ sẽ tạo các cặp khóa X25519 tạm thời, duy nhất cho mỗi hop (chặng) để mã hóa khi gửi tới các hop ECIES.</p>
<p><strong>QUAN TRỌNG</strong>: Khóa tạm thời phải là duy nhất cho mỗi hop ECIES (nút trung gian) và cho mỗi bản ghi xây dựng. Không dùng khóa duy nhất sẽ mở ra một hướng tấn công để các hop thông đồng xác nhận rằng chúng đang ở trong cùng một tunnel.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>// Each hop&#39;s X25519 static keypair (hesk, hepk) from the Router Identity
</span></span><span style="display:flex;"><span>  hesk = GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>  hepk = DERIVE_PUBLIC(hesk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // MixHash(hepk)
</span></span><span style="display:flex;"><span>  // || below means append
</span></span><span style="display:flex;"><span>  h = SHA256(h || hepk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // up until here, can all be precalculated by each router
</span></span><span style="display:flex;"><span>  // for all incoming build requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // Sender generates an X25519 ephemeral keypair per ECIES hop in the VTBM (sesk, sepk)
</span></span><span style="display:flex;"><span>  sesk = GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>  sepk = DERIVE_PUBLIC(sesk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // MixHash(sepk)
</span></span><span style="display:flex;"><span>  h = SHA256(h || sepk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  End of &#34;e&#34; message pattern.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  This is the &#34;es&#34; message pattern:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // Noise es
</span></span><span style="display:flex;"><span>  // Sender performs an X25519 DH with Hop&#39;s static public key.
</span></span><span style="display:flex;"><span>  // Each Hop, finds the record w/ their truncated identity hash,
</span></span><span style="display:flex;"><span>  // and extracts the Sender&#39;s ephemeral key preceding the encrypted record.
</span></span><span style="display:flex;"><span>  sharedSecret = DH(sesk, hepk) = DH(hesk, sepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // MixKey(DH())
</span></span><span style="display:flex;"><span>  //[chainKey, k] = MixKey(sharedSecret)
</span></span><span style="display:flex;"><span>  // ChaChaPoly parameters to encrypt/decrypt
</span></span><span style="display:flex;"><span>  keydata = HKDF(chainKey, sharedSecret, &#34;&#34;, 64)
</span></span><span style="display:flex;"><span>  // Save for Reply Record KDF
</span></span><span style="display:flex;"><span>  chainKey = keydata[0:31]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // AEAD parameters
</span></span><span style="display:flex;"><span>  k = keydata[32:63]
</span></span><span style="display:flex;"><span>  n = 0
</span></span><span style="display:flex;"><span>  plaintext = 464 byte build request record
</span></span><span style="display:flex;"><span>  ad = h
</span></span><span style="display:flex;"><span>  ciphertext = ENCRYPT(k, n, plaintext, ad)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  End of &#34;es&#34; message pattern.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // MixHash(ciphertext)
</span></span><span style="display:flex;"><span>  // Save for Reply Record KDF
</span></span><span style="display:flex;"><span>  h = SHA256(h || ciphertext)
</span></span></code></pre></div><p><code>replyKey</code>, <code>layerKey</code> và <code>layerIV</code> vẫn phải được bao gồm trong các bản ghi ElGamal (mật mã bất đối xứng ElGamal) và có thể được tạo ngẫu nhiên.</p>
<h3 id="mã-hóa-bản-ghi-yêu-cầu-elgamal-thuật-toán-mật-mã-khóa-công-khai">Mã hóa bản ghi yêu cầu (ElGamal, thuật toán mật mã khóa công khai)</h3>
<p>Như được định nghĩa trong <a href="../../../vi/docs/specs/implementation/">Tunnel Creation</a>
. Không có thay đổi nào đối với mã hóa cho các hop ElGamal.</p>
<h3 id="mã-hóa-bản-ghi-phản-hồi-ecies---lược-đồ-mã-hóa-tích-hợp-dùng-đường-cong-elliptic">Mã hóa bản ghi phản hồi (ECIES - lược đồ mã hóa tích hợp dùng đường cong elliptic)</h3>
<p>Bản ghi phản hồi được mã hóa bằng ChaCha20/Poly1305.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>// AEAD parameters
</span></span><span style="display:flex;"><span>  k = chainkey from build request
</span></span><span style="display:flex;"><span>  n = 0
</span></span><span style="display:flex;"><span>  plaintext = 512 byte build reply record
</span></span><span style="display:flex;"><span>  ad = h from build request
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ciphertext = ENCRYPT(k, n, plaintext, ad)
</span></span></code></pre></div><h3 id="mã-hóa-bản-ghi-phản-hồi-elgamal">Mã hóa bản ghi phản hồi (ElGamal)</h3>
<p>Như được định nghĩa trong <a href="../../../vi/docs/specs/implementation/">Tạo Tunnel</a>
. Không có thay đổi nào đối với việc mã hóa cho các chặng ElGamal.</p>
<h3 id="phân-tích-bảo-mật">Phân tích bảo mật</h3>
<p>ElGamal không cung cấp bảo mật chuyển tiếp (forward secrecy) cho các thông điệp xây dựng Tunnel.</p>
<p>AES256/CBC ở vị thế tốt hơn một chút, chỉ dễ bị suy yếu mang tính lý thuyết bởi một cuộc tấn công <code>biclique</code> (một kỹ thuật dùng cấu trúc hai phía hoàn chỉnh trong phân tích mật mã) dựa trên bản rõ đã biết.</p>
<p>Kiểu tấn công thực tế duy nhất đã biết nhằm vào AES256/CBC là padding oracle attack (khai thác phản hồi kiểm tra phần đệm), khi kẻ tấn công biết được IV (vector khởi tạo).</p>
<p>Kẻ tấn công sẽ cần phá vỡ mã hóa ElGamal của nút kế tiếp để thu được thông tin khóa AES256/CBC (khóa phản hồi và IV (vector khởi tạo)).</p>
<p>ElGamal (thuật toán mật mã khóa công khai ElGamal) tiêu tốn CPU hơn đáng kể so với ECIES (hệ mã hóa dựa trên đường cong elliptic ECIES), dẫn đến nguy cơ cạn kiệt tài nguyên.</p>
<p>ECIES (sơ đồ mã hóa tích hợp trên đường cong elliptic), khi được sử dụng với các khóa tạm thời mới cho mỗi BuildRequestRecord (bản ghi yêu cầu xây dựng) hoặc VariableTunnelBuildMessage (thông điệp xây dựng tunnel biến đổi), cung cấp tính bảo mật chuyển tiếp.</p>
<p>ChaCha20Poly1305 cung cấp AEAD encryption (mã hóa xác thực kèm dữ liệu liên kết), cho phép bên nhận xác minh tính toàn vẹn của thông điệp trước khi tiến hành giải mã.</p>
<h2 id="lý-do-1">Lý do</h2>
<p>Thiết kế này tối đa hóa việc tái sử dụng các nguyên thủy mật mã, các giao thức và mã nguồn hiện có. Thiết kế này giảm thiểu rủi ro.</p>
<h2 id="ghi-chú-triển-khai">Ghi chú triển khai</h2>
<ul>
<li>Các router cũ không kiểm tra loại mã hóa của hop (bước nhảy) và sẽ gửi các bản ghi được mã hóa bằng ElGamal
bản ghi. Một số router gần đây có lỗi và sẽ gửi nhiều loại bản ghi sai định dạng.
Những người triển khai nên phát hiện và loại bỏ các bản ghi này trước khi thực hiện thao tác DH (trao đổi khóa Diffie-Hellman)
nếu có thể, để giảm mức sử dụng CPU.</li>
</ul>
<h2 id="vấn-đề">Vấn đề</h2>
<h2 id="di-chuyển">Di chuyển</h2>
<p>Xem <a href="../../../vi/proposals/156-ecies-routers">Đề xuất 156</a>
.</p>
<h2 id="tài-liệu-tham-khảo">Tài liệu tham khảo</h2>
<ul>
<li><a href="../../../vi/docs/specs/common-structures/">Chung</a>
</li>
<li><a href="../../../vi/docs/specs/cryptography/">Mật mã học</a>
</li>
<li><a href="../../../vi/docs/specs/ecies/">ECIES-X25519</a>
</li>
<li><a href="../../../vi/docs/specs/i2np/">I2NP</a>
</li>
<li><a href="https://noiseprotocol.org/noise.html">NOISE</a>
</li>
<li><a href="../../../vi/docs/specs/ntcp2/">NTCP2</a>
</li>
<li><a href="../../../vi/proposals/119-bidirectional-tunnels/">Đề xuất 119</a>
</li>
<li><a href="../../../vi/proposals/143-build-message-options/">Đề xuất 143</a>
</li>
<li><a href="../../../vi/proposals/153-chacha20-layer-encryption/">Đề xuất 153</a>
</li>
<li><a href="../../../vi/proposals/156-ecies-routers/">Đề xuất 156</a>
</li>
<li><a href="../../../vi/proposals/157-new-tbm/">Đề xuất 157</a>
</li>
<li><a href="../../../vi/docs/specs/implementation/#tunnel-creation-ecies">Đặc tả</a>
</li>
<li><a href="../../../vi/docs/specs/implementation/">Tạo tunnel</a>
</li>
<li><a href="https://en.wikipedia.org/wiki/Multiple_encryption">Mã hóa nhiều lần</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc7539">RFC-7539</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc7748">RFC-7748</a>
</li>
</ul>

                </article>

                
                <nav class="page-nav">
                    <a href="../../../vi/proposals/" class="page-nav-link">
                        ← Back to Proposals
                    </a>
                    
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                    <a href="../../../proposals/152-ecies-tunnels.txt" class="page-nav-link" download>
                        Download Source (.txt)
                    </a>
                    
                </nav>
            </div>
        </div>
    </div>
</div>

<style>
.proposals-page {
    min-height: 100vh;
    padding: var(--spacing-xl) 0;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
}

.breadcrumbs a:hover {
    color: var(--color-primary);
}

.separator {
    color: var(--color-border);
}

.current {
    color: var(--color-text);
}

 
.translation-disclaimer {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.dark .translation-disclaimer {
    background: #78350f;
    border-color: #d97706;
}

.disclaimer-message {
    color: #92400e;
    font-size: 0.875rem;
}

.dark .disclaimer-message {
    color: #fde047;
}

.disclaimer-link {
    color: #92400e;
    font-weight: 600;
    text-decoration: underline;
    white-space: nowrap;
}

.dark .disclaimer-link {
    color: #fde047;
}

 
.proposal-header {
    margin-bottom: var(--spacing-2xl);
}

.proposal-title-section {
    margin-bottom: var(--spacing-lg);
}

.proposal-title {
    font-size: 2.5rem;
    margin: 0 0 var(--spacing-sm) 0;
    color: var(--color-text);
}

.proposal-number {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    font-weight: 600;
}

 
.proposal-meta-box {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
}

.proposal-status {
    display: inline-block;
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: var(--spacing-md);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

 
.status-open {
    background: #dbeafe;
    color: #0369a1;
}

.dark .status-open {
    background: #0c4a6e;
    color: #7dd3fc;
}

.status-accepted {
    background: #dbeafe;
    color: #0369a1;
}

.dark .status-accepted {
    background: #0c4a6e;
    color: #7dd3fc;
}

.status-finished {
    background: #dcfce7;
    color: #15803d;
}

.dark .status-finished {
    background: #164e63;
    color: #86efac;
}

.status-closed {
    background: #dcfce7;
    color: #15803d;
}

.dark .status-closed {
    background: #164e63;
    color: #86efac;
}

.status-rejected {
    background: #fee2e2;
    color: #991b1b;
}

.dark .status-rejected {
    background: #7f1d1d;
    color: #fca5a5;
}

.status-draft,
.status-needs-revision,
.status-dead,
.status-needs-research {
    background: #fef3c7;
    color: #92400e;
}

.dark .status-draft,
.dark .status-needs-revision,
.dark .status-dead,
.dark .status-needs-research {
    background: #78350f;
    color: #fde047;
}

.status-meta,
.status-informational,
.status-reserve {
    background: #e9d5ff;
    color: #6b21a8;
}

.dark .status-meta,
.dark .status-informational,
.dark .status-reserve {
    background: #581c87;
    color: #e879f9;
}

 
.proposal-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.info-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
}

.info-value {
    font-size: 0.9375rem;
    color: var(--color-text);
    font-weight: 500;
}

 
.proposal-relationships {
    border-top: 1px solid var(--color-border);
    padding-top: var(--spacing-md);
}

.relationship {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
}

.relationship:last-child {
    margin-bottom: 0;
}

.relationship-label {
    font-weight: 600;
    color: var(--color-text-muted);
    min-width: 120px;
}

.relationship-value {
    color: var(--color-text);
}

 
.proposal-layout {
    display: block;
}

.proposal-layout--with-toc {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

 
.proposal-toc-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.toc-nav {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
}

.toc-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-text);
    padding-bottom: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.toc-content {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
}

.toc-content::-webkit-scrollbar {
    width: 4px;
}

.toc-content::-webkit-scrollbar-track {
    background: transparent;
}

.toc-content::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
}

.toc-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

.toc-nav ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc-nav li {
    margin-bottom: 0.25rem;
}

.toc-nav ul ul {
    padding-left: var(--spacing-md);
    margin-top: 0.25rem;
}

.toc-nav a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.8125rem;
    display: block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    line-height: 1.4;
}

.toc-nav a:hover {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
}

 
.proposal-main {
    min-width: 0;
}

 
.proposal-content {
    line-height: 1.8;
    color: var(--color-text);
    max-width: 900px;
}

.proposal-content h2 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.75rem;
    scroll-margin-top: 100px;
}

.proposal-content h3 {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.375rem;
    scroll-margin-top: 100px;
}

.proposal-content h4 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-xs);
    font-size: 1.125rem;
    scroll-margin-top: 100px;
}

.proposal-content p {
    margin-bottom: var(--spacing-md);
}

.proposal-content ul,
.proposal-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.proposal-content li {
    margin-bottom: var(--spacing-xs);
}

.proposal-content code {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
}

.proposal-content pre {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: var(--spacing-md);
    font-size: 0.875rem;
}

.proposal-content pre code {
    background: none;
    padding: 0;
}

.proposal-content blockquote {
    border-left: 4px solid var(--color-primary);
    padding-left: var(--spacing-md);
    margin-left: 0;
    margin-bottom: var(--spacing-md);
    font-style: italic;
    color: var(--color-text-secondary);
}

.proposal-content a {
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
}

.proposal-content a:hover {
    border-bottom-color: var(--color-primary);
}

.proposal-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: var(--spacing-md);
}

.proposal-content table th {
    background: var(--color-bg-secondary);
    padding: var(--spacing-sm);
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--color-border);
}

.proposal-content table td {
    padding: var(--spacing-sm);
    border-bottom: 1px solid var(--color-border);
}

.proposal-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin: var(--spacing-lg) 0;
    display: block;
}

 
.page-nav {
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.page-nav-link {
    display: inline-block;
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.page-nav-link:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
}

 
@media (max-width: 1024px) {
    .proposal-layout--with-toc {
        grid-template-columns: 1fr;
    }

    .proposal-toc-sidebar {
        position: static;
        max-height: none;
        margin-bottom: var(--spacing-xl);
    }

    .toc-content {
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .proposal-title {
        font-size: 1.75rem;
    }

    .proposal-info-grid {
        grid-template-columns: 1fr;
    }
}
</style>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = [];

    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const heading = document.getElementById(href.slice(1));
            if (heading) {
                headings.push({ element: heading, link: link });
            }
        }
    });

    function updateActiveLink() {
        const scrollPos = window.scrollY + 120;
        let activeIndex = 0;

        for (let i = 0; i < headings.length; i++) {
            if (headings[i].element.offsetTop <= scrollPos) {
                activeIndex = i;
            }
        }

        tocLinks.forEach(link => link.classList.remove('active'));
        if (headings[activeIndex]) {
            headings[activeIndex].link.classList.add('active');
        }
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});
</script>
<style>
.toc-nav a.active {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
    font-weight: 600;
}
</style>



    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">Cập nhật tin tức I2P:</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="Nhập email của bạn" required>
                            <button type="submit">Đăng ký</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>Liên kết nhanh</h3>
                <ul>
                    <li><a href="../../../vi/financial-support/">Quyên góp</a></li>
                    <li><a href="../../../vi/docs/overview/intro/">Giới thiệu I2P</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Cộng đồng</h3>
                <ul>
                    <li><a href="../../../vi/get-involved/">Tham Gia</a></li>
                    <li><a href="../../../vi/blog/">Blog</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">Diễn đàn chính thức</a></li>
                    <li><a href="../../../vi/contact/">Liên hệ</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Tài nguyên</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">Thống kê I2P</a></li>
                    <li><a href="../../../vi/papers/">Nghiên cứu</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">StormyCloud</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 Dự án Internet Vô hình. Được cấp phép theo Creative Commons.</p>
            <div class="footer-links">
                <a href="../../../vi/privacy/">Quyền riêng tư</a>
                <a href="../../../vi/terms/">Điều khoản</a>
                <a href="../../../vi/about/media/">Báo chí</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="Đóng">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>Thăm dò ý kiến cộng đồng</h2>
            <p class="modal-subtitle">Chúng tôi rất muốn nghe ý kiến từ bạn</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                Phiếu bầu của bạn giúp định hình tương lai của I2P.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
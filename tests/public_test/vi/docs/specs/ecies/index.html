<!DOCTYPE html>
<html lang="vi" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Đặc tả mã hóa ECIES-X25519-AEAD-Ratchet (cơ chế bánh cóc) | I2P - Dự án Internet vô hình</title>

    <meta name="description" content="Lược đồ mã hóa tích hợp dựa trên đường cong elliptic cho I2P (X25519 &#43; AEAD)">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="Đặc tả mã hóa ECIES-X25519-AEAD-Ratchet (cơ chế bánh cóc) | I2P - Dự án Internet vô hình">
    <meta property="og:description" content="Lược đồ mã hóa tích hợp dựa trên đường cong elliptic cho I2P (X25519 &#43; AEAD)">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/vi/docs/specs/ecies/">

    
    <link rel="icon" type="image/svg+xml" href="../../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">Trang I2P Beta Đã Hoạt Động Gửi báo cáo lỗi tới stormycloud@mail.i2p</span>
            
        </div>
        
        <form method="GET" action="../../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="Đóng banner" title="Đóng banner">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../../vi/" class="logo-link">
                    <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../../vi/about/" class="">Giới thiệu</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../vi/about/">Tổng quan</a></li>
                            <li><a href="../../../../vi/papers/">Bài Nghiên Cứu</a></li>
                            <li><a href="../../../../vi/about/media/">Báo chí</a></li>
                            <li><a href="../../../../vi/contact/">Liên hệ</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../../vi/docs/" class="active">Tài liệu</a></li>
                    <li><a href="../../../../vi/downloads/" class="">Tải xuống</a></li>
                    <li><a href="../../../../vi/blog/" class="">Blog</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../../vi/get-involved/" class="">Tham gia</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../vi/get-involved/">Tổng quan</a></li>
                            <li><a href="../../../../vi/feedback/">Đề xuất Tính năng</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">vi</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../en/docs/specs/ecies/"
                                class="lang-option">Tiếng Anh</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../es/docs/specs/ecies/"
                                class="lang-option">Tiếng Tây Ban Nha</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ko/docs/specs/ecies/"
                                class="lang-option">Tiếng Hàn</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../zh/docs/specs/ecies/"
                                class="lang-option">Tiếng Trung</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ru/docs/specs/ecies/"
                                class="lang-option">Tiếng Nga</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../cs/docs/specs/ecies/"
                                class="lang-option">Tiếng Séc</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../de/docs/specs/ecies/"
                                class="lang-option">Tiếng Đức</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../fr/docs/specs/ecies/"
                                class="lang-option">Tiếng Pháp</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../tr/docs/specs/ecies/"
                                class="lang-option">Tiếng Thổ Nhĩ Kỳ</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../vi/docs/specs/ecies/"
                                class="lang-option active">Tiếng Việt</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../hi/docs/specs/ecies/"
                                class="lang-option">Tiếng Hindi</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ar/docs/specs/ecies/"
                                class="lang-option">Tiếng Ả Rập</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../pt/docs/specs/ecies/"
                                class="lang-option">Tiếng Bồ Đào Nha</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../../vi/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../../vi/downloads/" class="btn btn-primary">Tải I2P</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        




<div class="docs-page">
    <div class="container">
        
        <div class="docs-layout docs-layout--with-toc">
            
            
            <aside class="docs-toc-sidebar">
                <nav class="toc-nav">
                    <div class="toc-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        On This Page
                    </div>
                    <div class="toc-content">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#tổng-quan">Tổng quan</a>
      <ul>
        <li><a href="#mục-đích">Mục đích</a></li>
        <li><a href="#những-cải-tiến-chính-so-với-elgamalaessessiontags">Những cải tiến chính so với ElGamal/AES+SessionTags</a></li>
        <li><a href="#trạng-thái-triển-khai">Trạng thái triển khai</a></li>
        <li><a href="#trạng-thái-triển-khai-1">Trạng thái triển khai</a></li>
      </ul>
    </li>
    <li><a href="#nền-tảng-giao-thức">Nền tảng giao thức</a>
      <ul>
        <li><a href="#khung-giao-thức-noise">Khung giao thức Noise</a></li>
        <li><a href="#định-danh-giao-thức-noise">Định danh Giao thức Noise</a></li>
        <li><a href="#mẫu-bắt-tay-noise">Mẫu bắt tay Noise</a></li>
        <li><a href="#các-thuộc-tính-bảo-mật-của-noise-khung-giao-thức-mật-mã">Các thuộc tính bảo mật của Noise (khung giao thức mật mã)</a></li>
        <li><a href="#sự-khác-biệt-giữa-ik-và-xk">Sự khác biệt giữa IK và XK</a></li>
        <li><a href="#các-khái-niệm-về-double-ratchet-cơ-chế-bánh-cóc-kép-của-signal">Các khái niệm về Double Ratchet (cơ chế bánh cóc kép) của Signal</a></li>
        <li><a href="#các-phần-mở-rộng-i2p-cho-noise-khung-giao-thức">Các phần mở rộng I2P cho Noise (khung giao thức)</a></li>
      </ul>
    </li>
    <li><a href="#các-nguyên-thủy-mật-mã">Các nguyên thủy mật mã</a>
      <ul>
        <li><a href="#trao-đổi-khóa-diffie-hellman-x25519">Trao đổi khóa Diffie-Hellman X25519</a></li>
        <li><a href="#x25519-generate_private">X25519 GENERATE_PRIVATE()</a></li>
        <li><a href="#x25519-derive_publicprivkey">X25519 DERIVE_PUBLIC(privkey)</a></li>
        <li><a href="#x25519-dhprivkey-pubkey">X25519 DH(privkey, pubkey)</a></li>
        <li><a href="#chacha20-poly1305-aead-mã-hóa-xác-thực-kèm-dữ-liệu">ChaCha20-Poly1305 AEAD (mã hóa xác thực kèm dữ liệu)</a></li>
        <li><a href="#chacha20-poly1305-mã-hóak-n-plaintext-ad">ChaCha20-Poly1305 MÃ HÓA(k, n, plaintext, ad)</a></li>
        <li><a href="#chacha20-poly1305-decryptk-n-ciphertext-ad">ChaCha20-Poly1305 DECRYPT(k, n, ciphertext, ad)</a></li>
        <li><a href="#hàm-băm-sha-256">Hàm băm SHA-256</a></li>
        <li><a href="#sha-256-hp-d">SHA-256 H(p, d)</a></li>
        <li><a href="#sha-256-mixhashd">SHA-256 MixHash(d)</a></li>
        <li><a href="#dẫn-xuất-khóa-hkdf">Dẫn xuất khóa HKDF</a></li>
        <li><a href="#mã-hóa-elligator2">Mã hóa Elligator2</a></li>
        <li><a href="#elligator2-generate_private_elg2">Elligator2 GENERATE_PRIVATE_ELG2()</a></li>
        <li><a href="#elligator2-encode_elg2pubkey">Elligator2 ENCODE_ELG2(pubkey)</a></li>
        <li><a href="#elligator2-decode_elg2encodedkey">Elligator2 DECODE_ELG2(encodedKey)</a></li>
      </ul>
    </li>
    <li><a href="#định-dạng-thông-điệp">Định dạng thông điệp</a>
      <ul>
        <li><a href="#tổng-quan-1">Tổng quan</a></li>
        <li><a href="#bộ-chứa-thông-điệp-garlic-của-i2np">Bộ chứa thông điệp Garlic của I2NP</a></li>
        <li><a href="#thông-điệp-phiên-mới-ns">Thông điệp Phiên mới (NS)</a></li>
        <li><a href="#thông-điệp-ns-có-ràng-buộc-loại-1b">Thông điệp NS có ràng buộc (Loại 1b)</a></li>
        <li><a href="#thông-điệp-ns-không-có-ràng-buộc-loại-1c">Thông điệp NS không có ràng buộc (Loại 1c)</a></li>
        <li><a href="#thông-điệp-ns-dùng-một-lần-loại-1d">Thông điệp NS dùng một lần (Loại 1d)</a></li>
        <li><a href="#thông-điệp-phản-hồi-phiên-mới-nsr">Thông điệp Phản hồi Phiên Mới (NSR)</a></li>
        <li><a href="#thông-điệp-phiên-hiện-có-es">Thông điệp Phiên hiện có (ES)</a></li>
      </ul>
    </li>
    <li><a href="#các-hàm-dẫn-xuất-khóa">Các hàm dẫn xuất khóa</a>
      <ul>
        <li><a href="#ký-hiệu-và-hằng-số">Ký hiệu và Hằng số</a></li>
        <li><a href="#các-kdf-hàm-dẫn-xuất-khóa-cho-thông-điệp-ns">Các KDF (hàm dẫn xuất khóa) cho thông điệp NS</a></li>
        <li><a href="#kdf-hàm-dẫn-xuất-khóa-1-khóa-chuỗi-ban-đầu">KDF (hàm dẫn xuất khóa) 1: Khóa chuỗi ban đầu</a></li>
        <li><a href="#kdf-2-trộn-khóa-tĩnh-của-bob">KDF 2: Trộn khóa tĩnh của Bob</a></li>
        <li><a href="#kdf-3-sinh-khóa-tạm-thời-của-alice">KDF 3: Sinh khóa tạm thời của Alice</a></li>
        <li><a href="#kdf-4-phần-khóa-tĩnh-ns-es-dh">KDF 4: Phần khóa tĩnh NS (es DH)</a></li>
        <li><a href="#kdf-5-hàm-dẫn-xuất-khóa-phần-ns-payload-ss-dh-chỉ-ràng-buộc">KDF 5 (hàm dẫn xuất khóa): Phần NS Payload (ss DH, chỉ ràng buộc)</a></li>
        <li><a href="#kdf-hàm-dẫn-xuất-khóa-cho-tập-thẻ-phản-hồi-nsr-một-cơ-chế-trong-i2p-viết-tắt-giữ-nguyên">KDF (hàm dẫn xuất khóa) cho tập thẻ phản hồi NSR (một cơ chế trong I2P; viết tắt, giữ nguyên)</a></li>
        <li><a href="#các-hàm-dẫn-xuất-khóa-kdf-cho-thông-điệp-nsr">Các hàm dẫn xuất khóa (KDF) cho thông điệp NSR</a></li>
        <li><a href="#kdf-6-sinh-khóa-tạm-thời-cho-nsr">KDF 6: Sinh khóa tạm thời cho NSR</a></li>
        <li><a href="#kdf-7-phần-khóa-nsr-ee-và-se-dh">KDF 7: Phần khóa NSR (ee và se DH)</a></li>
        <li><a href="#kdf-hàm-dẫn-xuất-khóa-8-phần-tải-trọng-nsr">KDF (hàm dẫn xuất khóa) 8: Phần tải trọng NSR</a></li>
        <li><a href="#kdfs-hàm-dẫn-xuất-khóa-cho-thông-điệp-es">KDFs (hàm dẫn xuất khóa) cho thông điệp ES</a></li>
        <li><a href="#hàm-dh_initialize">Hàm DH_INITIALIZE</a></li>
      </ul>
    </li>
    <li><a href="#các-cơ-chế-ratchet-cơ-chế-bánh-cóc">Các cơ chế Ratchet (cơ chế bánh cóc)</a>
      <ul>
        <li><a href="#tổng-quan-về-ratchet-cơ-chế-ratchet-trong-mật-mã">Tổng quan về Ratchet (cơ chế ratchet trong mật mã)</a></li>
        <li><a href="#dh-ratchet-cơ-chế-bánh-cóc-diffiehellman">DH Ratchet (cơ chế bánh cóc Diffie–Hellman)</a></li>
        <li><a href="#tần-suất-dh-ratchet-cơ-chế-ratchet-diffie-hellman">Tần suất DH Ratchet (cơ chế ratchet Diffie-Hellman)</a></li>
        <li><a href="#nhãn-và-id-khóa-trong-dh-ratchet-cơ-chế-bánh-cóc-diffie-hellman">Nhãn và ID khóa trong DH Ratchet (cơ chế bánh cóc Diffie-Hellman)</a></li>
        <li><a href="#luồng-thông-điệp-của-dh-ratchet-cơ-chế-bánh-cóc-diffie-hellman">Luồng thông điệp của DH Ratchet (cơ chế bánh cóc Diffie-Hellman)</a></li>
        <li><a href="#định-dạng-khối-nextkey-khóa-tiếp-theo">Định dạng khối NextKey (khóa tiếp theo)</a></li>
        <li><a href="#hàm-dẫn-xuất-khóa-kdf-của-dh-ratchet-cơ-chế-bánh-cóc-diffiehellman">Hàm dẫn xuất khóa (KDF) của DH Ratchet (cơ chế bánh cóc Diffie–Hellman)</a></li>
        <li><a href="#quản-lý-trạng-thái-dh-ratchet-cơ-chế-bánh-cóc-diffie-hellman">Quản lý trạng thái DH Ratchet (cơ chế bánh cóc Diffie-Hellman)</a></li>
        <li><a href="#session-tag-ratchet-cơ-chế-ratchet-cho-session-tag">Session Tag Ratchet (Cơ chế ratchet cho Session Tag)</a></li>
        <li><a href="#mục-đích-của-session-tag-ratchet-cơ-chế-ratchet-cho-thẻ-phiên">Mục đích của Session Tag Ratchet (cơ chế ratchet cho thẻ phiên)</a></li>
        <li><a href="#công-thức-ratchet-cơ-chế-bánh-cóc-trong-mật-mã-cho-nhãn-phiên">Công thức ratchet (cơ chế bánh cóc trong mật mã) cho nhãn phiên</a></li>
        <li><a href="#triển-khai-phía-gửi-của-session-tag-ratchet-cơ-chế-ratchet-cho-thẻ-phiên">Triển khai phía gửi của Session Tag Ratchet (cơ chế ratchet cho thẻ phiên)</a></li>
        <li><a href="#triển-khai-phía-nhận-của-session-tag-ratchet-cơ-chế-ratchet-cho-thẻ-phiên">Triển khai phía nhận của Session Tag Ratchet (cơ chế ratchet cho thẻ phiên)</a></li>
        <li><a href="#chiến-lược-nhìn-trước-cho-thẻ-phiên">Chiến lược nhìn trước cho thẻ phiên</a></li>
        <li><a href="#xử-lý-session-tag-thẻ-phiên-khi-đến-không-theo-thứ-tự">Xử lý Session Tag (thẻ phiên) khi đến không theo thứ tự</a></li>
        <li><a href="#cơ-chế-bánh-cóc-khóa-đối-xứng">Cơ chế bánh cóc khóa đối xứng</a></li>
        <li><a href="#mục-đích-của-cơ-chế-bánh-cóc-khóa-đối-xứng">Mục đích của cơ chế bánh cóc khóa đối xứng</a></li>
        <li><a href="#công-thức-ratchet-cơ-chế-bánh-cóc-cho-khóa-đối-xứng">Công thức Ratchet (cơ chế bánh cóc) cho khóa đối xứng</a></li>
        <li><a href="#hiện-thực-phía-gửi-của-symmetric-key-ratchet-cơ-chế-bánh-cóc-dùng-khóa-đối-xứng">Hiện thực phía gửi của Symmetric Key Ratchet (cơ chế bánh cóc dùng khóa đối xứng)</a></li>
        <li><a href="#triển-khai-phía-nhận-symmetric-key-ratchet-cơ-chế-bánh-cóc-cho-khóa-đối-xứng">Triển khai phía nhận Symmetric Key Ratchet (cơ chế bánh cóc cho khóa đối xứng)</a></li>
        <li><a href="#đồng-bộ-hóa-ratchet-đối-xứng-với-session-tags-thẻ-phiên">Đồng bộ hóa ratchet đối xứng với Session Tags (thẻ phiên)</a></li>
        <li><a href="#thiết-kế-nonce-số-dùng-một-lần-cho-symmetric-ratchet-ratchet-đối-xứng">Thiết kế Nonce (số dùng một lần) cho Symmetric Ratchet (ratchet đối xứng)</a></li>
      </ul>
    </li>
    <li><a href="#quản-lý-phiên">Quản lý phiên</a>
      <ul>
        <li><a href="#ngữ-cảnh-phiên">Ngữ cảnh phiên</a></li>
        <li><a href="#ràng-buộc-phiên">Ràng buộc phiên</a></li>
        <li><a href="#các-phiên-ràng-buộc">Các phiên ràng buộc</a></li>
        <li><a href="#các-phiên-chưa-ràng-buộc">Các phiên chưa ràng buộc</a></li>
        <li><a href="#ghép-cặp-phiên">Ghép cặp phiên</a></li>
        <li><a href="#tạo-phiên-ghép-cặp">Tạo phiên ghép cặp</a></li>
        <li><a href="#lợi-ích-của-việc-ghép-cặp-phiên">Lợi ích của việc ghép cặp phiên</a></li>
        <li><a href="#các-quy-tắc-ghép-cặp-phiên">Các quy tắc ghép cặp phiên</a></li>
        <li><a href="#vòng-đời-phiên">Vòng đời phiên</a></li>
        <li><a href="#vòng-đời-phiên-giai-đoạn-khởi-tạo">Vòng đời phiên: Giai đoạn khởi tạo</a></li>
        <li><a href="#vòng-đời-phiên-giai-đoạn-hoạt-động">Vòng đời phiên: Giai đoạn hoạt động</a></li>
        <li><a href="#vòng-đời-phiên-giai-đoạn-hết-hạn">Vòng đời phiên: Giai đoạn hết hạn</a></li>
        <li><a href="#nhiều-thông-điệp-ns">Nhiều thông điệp NS</a></li>
        <li><a href="#nhiều-thông-điệp-nsr">Nhiều thông điệp NSR</a></li>
        <li><a href="#máy-trạng-thái-phiên">Máy trạng thái phiên</a></li>
      </ul>
    </li>
    <li><a href="#định-dạng-dữ-liệu-tải">Định dạng dữ liệu tải</a>
      <ul>
        <li><a href="#cấu-trúc-khối">Cấu trúc khối</a></li>
        <li><a href="#các-loại-khối">Các loại khối</a></li>
        <li><a href="#quy-tắc-sắp-xếp-các-khối">Quy tắc sắp xếp các khối</a></li>
        <li><a href="#thứ-tự-thông-điệp-ns">Thứ tự thông điệp NS</a></li>
        <li><a href="#thứ-tự-thông-điệp-nsr-viết-tắt-không-dịch">Thứ tự thông điệp NSR (viết tắt, không dịch)</a></li>
        <li><a href="#thứ-tự-thông-điệp-es">Thứ tự thông điệp ES</a></li>
        <li><a href="#datetime-block-khối-ngày-giờ-loại-0">DateTime Block (khối ngày giờ) (Loại 0)</a></li>
        <li><a href="#garlic-clove-block-khối-nhánh-tỏi-type-11">Garlic Clove Block (khối nhánh tỏi) (Type 11)</a></li>
        <li><a href="#khối-nextkey-khóa-kế-tiếp-loại-7">Khối NextKey (khóa kế tiếp) (Loại 7)</a></li>
        <li><a href="#khối-ack-loại-8">Khối ACK (Loại 8)</a></li>
        <li><a href="#khối-yêu-cầu-ack-loại-9">Khối yêu cầu ACK (Loại 9)</a></li>
        <li><a href="#khối-kết-thúc-loại-4">Khối Kết thúc (Loại 4)</a></li>
        <li><a href="#khối-tùy-chọn-loại-5">Khối tùy chọn (Loại 5)</a></li>
        <li><a href="#khối-messagenumbers-loại-6">Khối MessageNumbers (Loại 6)</a></li>
        <li><a href="#khối-đệm-loại-254">Khối đệm (Loại 254)</a></li>
      </ul>
    </li>
    <li><a href="#hướng-dẫn-triển-khai">Hướng dẫn triển khai</a>
      <ul>
        <li><a href="#điều-kiện-tiên-quyết">Điều kiện tiên quyết</a></li>
        <li><a href="#thứ-tự-triển-khai-được-khuyến-nghị">Thứ tự triển khai được khuyến nghị</a></li>
        <li><a href="#triển-khai-phía-gửi">Triển khai phía gửi</a></li>
        <li><a href="#hiện-thực-phía-nhận">Hiện thực phía nhận</a></li>
        <li><a href="#phân-loại-thông-điệp">Phân loại thông điệp</a></li>
        <li><a href="#thông-lệ-tốt-nhất-về-quản-lý-phiên">Thông lệ tốt nhất về quản lý phiên</a></li>
        <li><a href="#chiến-lược-kiểm-thử">Chiến lược kiểm thử</a></li>
        <li><a href="#những-cân-nhắc-về-hiệu-năng">Những cân nhắc về hiệu năng</a></li>
      </ul>
    </li>
    <li><a href="#các-cân-nhắc-bảo-mật">Các cân nhắc bảo mật</a>
      <ul>
        <li><a href="#mô-hình-đe-dọa">Mô hình đe dọa</a></li>
        <li><a href="#các-giả-định-mật-mã">Các giả định mật mã</a></li>
        <li><a href="#quản-lý-khóa">Quản lý khóa</a></li>
        <li><a href="#các-biện-pháp-giảm-thiểu-tấn-công">Các biện pháp giảm thiểu tấn công</a></li>
        <li><a href="#các-biện-pháp-giảm-thiểu-tấn-công-phát-lại">Các biện pháp giảm thiểu tấn công phát lại</a></li>
        <li><a href="#các-biện-pháp-giảm-thiểu-mạo-danh-do-lộ-khóa-key-compromise-impersonation-kci">Các biện pháp giảm thiểu mạo danh do lộ khóa (Key Compromise Impersonation, KCI)</a></li>
        <li><a href="#các-biện-pháp-giảm-thiểu-tấn-công-từ-chối-dịch-vụ">Các biện pháp giảm thiểu tấn công từ chối dịch vụ</a></li>
        <li><a href="#khả-năng-chống-phân-tích-lưu-lượng">Khả năng chống phân tích lưu lượng</a></li>
        <li><a href="#những-cạm-bẫy-khi-hiện-thực">Những cạm bẫy khi hiện thực</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#security-audits">Security Audits</a></li>
      </ul>
    </li>
    <li><a href="#configuration-and-deployment">Configuration and Deployment</a>
      <ul>
        <li><a href="#i2cp-configuration">I2CP Configuration</a></li>
        <li><a href="#java-i2p-configuration">Java I2P Configuration</a></li>
        <li><a href="#i2pd-configuration">i2pd Configuration</a></li>
        <li><a href="#compatibility-matrix">Compatibility Matrix</a></li>
        <li><a href="#migration-guide">Migration Guide</a></li>
        <li><a href="#performance-tuning">Performance Tuning</a></li>
        <li><a href="#monitoring-and-debugging">Monitoring and Debugging</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a>
      <ul>
        <li><a href="#specifications">Specifications</a></li>
        <li><a href="#cryptographic-standards">Cryptographic Standards</a></li>
        <li><a href="#implementation-resources">Implementation Resources</a></li>
        <li><a href="#additional-information">Additional Information</a></li>
      </ul>
    </li>
    <li><a href="#appendix-a-kdf-summary">Appendix A: KDF Summary</a></li>
    <li><a href="#appendix-b-message-size-calculator">Appendix B: Message Size Calculator</a></li>
    <li><a href="#appendix-c-glossary">Appendix C: Glossary</a></li>
  </ul>
</nav>
                    </div>
                </nav>
            </aside>
            

            
            <div class="docs-main">
                
                <nav class="breadcrumbs">
                    <a href="../../../../vi/">Home</a>
                    <span class="separator">/</span>
                    <a href="../../../../vi/docs/">Docs</a>
                    
                        
                            <span class="separator">/</span>
                            <a href="../../../../vi/docs/specs/">Specifications</a>
                        
                    
                    <span class="separator">/</span>
                    <span class="current">Đặc tả mã hóa ECIES-X25519-AEAD-Ratchet (cơ chế bánh cóc)</span>
                </nav>

                
<div class="translation-disclaimer" role="note">
    <span class="disclaimer-message">Bản dịch này được tạo bằng máy học và có thể không chính xác 100%.</span>
    
    
    <a href="../../../../en/docs/specs/ecies/" class="disclaimer-link">Xem phiên bản tiếng Anh</a>
    
</div>



                
                <header class="article-header">
                    <h1 class="article-title">Đặc tả mã hóa ECIES-X25519-AEAD-Ratchet (cơ chế bánh cóc)</h1>
                    
                        <p class="article-description">Lược đồ mã hóa tích hợp dựa trên đường cong elliptic cho I2P (X25519 &#43; AEAD)</p>
                    
                    <div class="article-meta">
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                Updated: 2025-10
                            </span>
                        
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Accurate for: 2.10.0
                            </span>
                        
                    </div>
                </header>

                
                <article class="article-content">
                    <h2 id="tổng-quan">Tổng quan</h2>
<h3 id="mục-đích">Mục đích</h3>
<p>ECIES-X25519-AEAD-Ratchet là giao thức mã hóa đầu-cuối hiện đại của I2P, thay thế hệ thống ElGamal/AES+SessionTags cũ. Nó cung cấp tính bí mật chuyển tiếp, mã hóa xác thực, và những cải tiến đáng kể về hiệu năng và bảo mật.</p>
<h3 id="những-cải-tiến-chính-so-với-elgamalaessessiontags">Những cải tiến chính so với ElGamal/AES+SessionTags</h3>
<ul>
<li><strong>Khóa nhỏ hơn</strong>: Khóa 32-byte so với khóa công khai ElGamal 256-byte (giảm 87.5%)</li>
<li><strong>Bảo mật chuyển tiếp</strong>: Đạt được thông qua DH ratcheting (cơ chế bánh cóc) (không có trong giao thức cũ)</li>
<li><strong>Mật mã hiện đại</strong>: X25519 DH, ChaCha20-Poly1305 AEAD, SHA-256</li>
<li><strong>Mã hóa kèm xác thực</strong>: Xác thực tích hợp thông qua cấu trúc AEAD</li>
<li><strong>Giao thức hai chiều</strong>: Các phiên vào/ra được ghép cặp so với giao thức cũ một chiều</li>
<li><strong>Thẻ phiên hiệu quả</strong>: Thẻ phiên 8-byte so với thẻ 32-byte (giảm 75%)</li>
<li><strong>Che giấu lưu lượng</strong>: Mã hóa Elligator2 khiến các bắt tay không thể phân biệt với dữ liệu ngẫu nhiên</li>
</ul>
<h3 id="trạng-thái-triển-khai">Trạng thái triển khai</h3>
<ul>
<li><strong>Phát hành ban đầu</strong>: Phiên bản 0.9.46 (25 tháng 5, 2020)</li>
<li><strong>Triển khai mạng</strong>: Hoàn tất tính đến năm 2020</li>
<li><strong>Trạng thái hiện tại</strong>: Trưởng thành, được triển khai rộng rãi (hơn 5 năm trong môi trường sản xuất)</li>
<li><strong>Hỗ trợ router</strong>: Yêu cầu phiên bản 0.9.46 hoặc cao hơn</li>
<li><strong>Yêu cầu Floodfill</strong>: Mức độ áp dụng gần 100% cho các tra cứu được mã hóa</li>
</ul>
<h3 id="trạng-thái-triển-khai-1">Trạng thái triển khai</h3>
<p><strong>Đã triển khai đầy đủ:</strong> - các thông điệp New Session (NS) có ràng buộc - các thông điệp New Session Reply (NSR) - các thông điệp Existing Session (ES) - cơ chế DH ratchet (cơ chế thay đổi khóa tăng dần) - các ratchet cho session tag (thẻ phiên) và khóa đối xứng - các khối DateTime, NextKey, ACK, ACK Request, Garlic Clove (nhánh tỏi - thành phần của thông điệp &lsquo;garlic&rsquo; trong I2P), và Padding</p>
<p><strong>Chưa được triển khai (tính đến phiên bản 0.9.50):</strong> - khối MessageNumbers (loại 6) - khối Options (loại 5) - khối Termination (loại 4) - phản hồi tự động ở tầng giao thức - Zero static key mode (chế độ không dùng khóa tĩnh) - các phiên multicast</p>
<p><strong>Lưu ý</strong>: Tình trạng triển khai cho các phiên bản từ 1.5.0 đến 2.10.0 (2021–2025) cần được xác minh vì có thể một số tính năng đã được bổ sung.</p>
<hr>
<h2 id="nền-tảng-giao-thức">Nền tảng giao thức</h2>
<h3 id="khung-giao-thức-noise">Khung giao thức Noise</h3>
<p>ECIES-X25519-AEAD-Ratchet dựa trên <a href="https://noiseprotocol.org/">Noise Protocol Framework</a>
 (Bản sửa đổi 34, 2018-07-11), cụ thể là mẫu bắt tay <strong>IK</strong> (tương tác, khóa tĩnh từ xa đã biết) với các phần mở rộng dành riêng cho I2P.</p>
<h3 id="định-danh-giao-thức-noise">Định danh Giao thức Noise</h3>
<pre tabindex="0"><code>Noise_IKelg2+hs2_25519_ChaChaPoly_SHA256
</code></pre><p><strong>Các thành phần định danh:</strong> - <code>Noise</code> - Khung cơ bản - <code>IK</code> - Mẫu bắt tay tương tác với khóa tĩnh từ xa đã biết - <code>elg2</code> - Mã hóa Elligator2 cho khóa tạm thời (phần mở rộng I2P) - <code>+hs2</code> - MixHash được gọi trước thông điệp thứ hai để trộn tag (phần mở rộng I2P) - <code>25519</code> - Hàm Diffie-Hellman X25519 - <code>ChaChaPoly</code> - Thuật toán mã hóa AEAD ChaCha20-Poly1305 - <code>SHA256</code> - Hàm băm SHA-256</p>
<h3 id="mẫu-bắt-tay-noise">Mẫu bắt tay Noise</h3>
<p><strong>Ký hiệu mẫu IK:</strong></p>
<pre tabindex="0"><code>&lt;- s                    (Bob&#39;s static key known to Alice)
...
-&gt; e, es, s, ss         (Alice sends ephemeral, DH es, static key, DH ss)
&lt;- e, ee, se            (Bob sends ephemeral, DH ee, DH se)
</code></pre><p><strong>Ý nghĩa các token:</strong> - <code>e</code> - Truyền khóa tạm thời - <code>s</code> - Truyền khóa tĩnh - <code>es</code> - DH giữa khóa tạm thời của Alice và khóa tĩnh của Bob - <code>ss</code> - DH giữa khóa tĩnh của Alice và khóa tĩnh của Bob - <code>ee</code> - DH giữa khóa tạm thời của Alice và khóa tạm thời của Bob - <code>se</code> - DH giữa khóa tĩnh của Bob và khóa tạm thời của Alice</p>
<h3 id="các-thuộc-tính-bảo-mật-của-noise-khung-giao-thức-mật-mã">Các thuộc tính bảo mật của Noise (khung giao thức mật mã)</h3>
<p>Sử dụng thuật ngữ của Noise (khung giao thức mật mã), mẫu IK cung cấp:</p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Message</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Authentication Level</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Confidentiality Level</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Message&nbsp;1 (NS)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;1 (sender auth, KCI vulnerable)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;2 (weak forward secrecy)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Message&nbsp;2 (NSR)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;2 (mutual auth)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;4 (weak forward secrecy)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Transport (ES)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;2 (mutual auth)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Level&nbsp;5 (strong forward secrecy)</td>
    </tr>
  </tbody>
</table>
**Các cấp độ xác thực:** - **Cấp 1**: Tải dữ liệu được xác thực là thuộc về chủ sở hữu khóa tĩnh của bên gửi, nhưng dễ bị tấn công Key Compromise Impersonation (KCI, mạo danh do lộ khóa) - **Cấp 2**: Kháng các cuộc tấn công KCI sau NSR
<p><strong>Các cấp độ bảo mật:</strong> - <strong>Cấp 2</strong>: Bí mật chuyển tiếp (forward secrecy) nếu khóa tĩnh của người gửi bị xâm phạm về sau - <strong>Cấp 4</strong>: Bí mật chuyển tiếp nếu khóa tạm thời của người gửi bị xâm phạm về sau - <strong>Cấp 5</strong>: Bí mật chuyển tiếp đầy đủ sau khi cả hai khóa tạm thời được xóa</p>
<h3 id="sự-khác-biệt-giữa-ik-và-xk">Sự khác biệt giữa IK và XK</h3>
<p>Mẫu IK khác với mẫu XK được dùng trong NTCP2 và SSU2:</p>
<ol>
<li><strong>Bốn phép DH (Diffie-Hellman)</strong>: IK sử dụng 4 phép DH (es, ss, ee, se) so với 3 trong XK</li>
<li><strong>Xác thực ngay lập tức</strong>: Alice được xác thực trong thông điệp đầu tiên (Mức xác thực 1)</li>
<li><strong>Bảo mật chuyển tiếp nhanh hơn</strong>: Bảo mật chuyển tiếp đầy đủ (Mức 5) đạt được sau thông điệp thứ hai (1-RTT)</li>
<li><strong>Đánh đổi</strong>: Tải trọng của thông điệp đầu tiên không có bảo mật chuyển tiếp (so với XK, nơi mọi tải trọng đều có bảo mật chuyển tiếp)</li>
</ol>
<p><strong>Tóm tắt</strong>: IK (một mẫu bắt tay) cho phép phản hồi của Bob được nhận chỉ trong 1-RTT (một vòng khứ hồi) với đầy đủ bảo mật chuyển tiếp, đổi lại yêu cầu ban đầu không có bảo mật chuyển tiếp.</p>
<h3 id="các-khái-niệm-về-double-ratchet-cơ-chế-bánh-cóc-kép-của-signal">Các khái niệm về Double Ratchet (cơ chế bánh cóc kép) của Signal</h3>
<p>ECIES (lược đồ mã hóa tích hợp trên đường cong elliptic) kết hợp các khái niệm từ <a href="https://signal.org/docs/specifications/doubleratchet/">Signal Double Ratchet Algorithm</a>
:</p>
<ul>
<li><strong>DH Ratchet</strong>: (cơ chế bánh cóc DH) Đảm bảo bí mật chuyển tiếp bằng cách trao đổi định kỳ các khóa DH mới</li>
<li><strong>Symmetric Key Ratchet</strong>: (cơ chế bánh cóc khóa đối xứng) Dẫn xuất các khóa phiên mới cho mỗi thông điệp</li>
<li><strong>Session Tag Ratchet</strong>: (cơ chế bánh cóc Session Tag) Tạo session tags (thẻ phiên) dùng một lần một cách tất định</li>
</ul>
<p><strong>Những khác biệt chính so với Signal:</strong> - <strong>Ratcheting (cơ chế tăng tiến khóa theo từng bước) ít thường xuyên hơn</strong>: I2P chỉ thực hiện ratchet khi cần (gần cạn tag hoặc theo chính sách) - <strong>Session Tags (thẻ phiên) thay cho mã hóa tiêu đề</strong>: Sử dụng các tag có tính xác định thay vì các tiêu đề được mã hóa - <strong>ACK rõ ràng</strong>: Sử dụng các khối ACK trong-băng thay vì chỉ dựa vào lưu lượng ngược chiều - <strong>Tách biệt ratchet cho tag và khóa</strong>: Hiệu quả hơn cho bên nhận (có thể hoãn việc tính toán khóa)</p>
<h3 id="các-phần-mở-rộng-i2p-cho-noise-khung-giao-thức">Các phần mở rộng I2P cho Noise (khung giao thức)</h3>
<ol>
<li><strong>Mã hóa Elligator2</strong>: Khóa tạm thời được mã hóa để không thể phân biệt với dữ liệu ngẫu nhiên</li>
<li><strong>Thẻ được chèn ở đầu NSR</strong>: Thẻ phiên được thêm trước thông điệp NSR để phục vụ mục đích tương quan</li>
<li><strong>Định dạng tải tin được xác định</strong>: Cấu trúc tải tin dạng khối cho mọi loại thông điệp</li>
<li><strong>Bao gói I2NP</strong>: Tất cả thông điệp được bọc trong các tiêu đề Thông điệp Garlic của I2NP</li>
<li><strong>Giai đoạn dữ liệu tách biệt</strong>: Thông điệp truyền tải (ES) khác với giai đoạn dữ liệu tiêu chuẩn của Noise (khung giao thức mật mã)</li>
</ol>
<hr>
<h2 id="các-nguyên-thủy-mật-mã">Các nguyên thủy mật mã</h2>
<h3 id="trao-đổi-khóa-diffie-hellman-x25519">Trao đổi khóa Diffie-Hellman X25519</h3>
<p><strong>Đặc tả</strong>: <a href="https://tools.ietf.org/html/rfc7748">RFC 7748</a>
</p>
<p><strong>Thuộc tính chính:</strong> - <strong>Kích thước khóa riêng</strong>: 32 byte - <strong>Kích thước khóa công khai</strong>: 32 byte - <strong>Kích thước bí mật chung</strong>: 32 byte - <strong>Thứ tự byte</strong>: Little-endian - <strong>Đường cong</strong>: Curve25519</p>
<p><strong>Vận hành:</strong></p>
<h3 id="x25519-generate_private">X25519 GENERATE_PRIVATE()</h3>
<p>Tạo một khóa riêng 32 byte ngẫu nhiên:</p>
<pre tabindex="0"><code>privkey = CSRNG(32)
</code></pre><h3 id="x25519-derive_publicprivkey">X25519 DERIVE_PUBLIC(privkey)</h3>
<p>Suy ra khóa công khai tương ứng:</p>
<pre tabindex="0"><code>pubkey = curve25519_scalarmult_base(privkey)
</code></pre><p>Trả về khóa công khai 32 byte ở dạng little-endian (thứ tự byte nhỏ trước).</p>
<h3 id="x25519-dhprivkey-pubkey">X25519 DH(privkey, pubkey)</h3>
<p>Thực hiện Diffie-Hellman key agreement (thỏa thuận khóa Diffie-Hellman):</p>
<pre tabindex="0"><code>sharedSecret = curve25519_scalarmult(privkey, pubkey)
</code></pre><p>Trả về một bí mật dùng chung dài 32 byte.</p>
<p><strong>Ghi chú bảo mật</strong>: Người triển khai phải xác minh rằng bí mật chia sẻ không phải toàn là số 0 (khóa yếu). Hãy từ chối và hủy bỏ quá trình bắt tay nếu điều này xảy ra.</p>
<h3 id="chacha20-poly1305-aead-mã-hóa-xác-thực-kèm-dữ-liệu">ChaCha20-Poly1305 AEAD (mã hóa xác thực kèm dữ liệu)</h3>
<p><strong>Đặc tả</strong>: <a href="https://tools.ietf.org/html/rfc7539">RFC 7539</a>
 mục 2.8</p>
<p><strong>Tham số:</strong> - <strong>Kích thước khóa</strong>: 32 byte (256 bit) - <strong>Kích thước Nonce (số dùng một lần)</strong>: 12 byte (96 bit) - <strong>Kích thước MAC</strong>: 16 byte (128 bit) - <strong>Kích thước khối</strong>: 64 byte (nội bộ)</p>
<p><strong>Định dạng Nonce (số dùng một lần):</strong></p>
<pre tabindex="0"><code>Byte 0-3:   0x00 0x00 0x00 0x00  (always zero)
Byte 4-11:  Little-endian counter (message number N)
</code></pre><p><strong>Cấu trúc AEAD:</strong></p>
<p>AEAD (mã hóa xác thực kèm dữ liệu liên kết) kết hợp mật mã dòng ChaCha20 với MAC Poly1305:</p>
<ol>
<li>Tạo luồng khóa ChaCha20 từ khóa và nonce (số dùng một lần)</li>
<li>Mã hóa bản rõ bằng cách XOR với luồng khóa</li>
<li>Tính MAC (mã xác thực thông điệp) Poly1305 trên (dữ liệu liên kết || bản mã)</li>
<li>Thêm MAC 16 byte vào bản mã</li>
</ol>
<h3 id="chacha20-poly1305-mã-hóak-n-plaintext-ad">ChaCha20-Poly1305 MÃ HÓA(k, n, plaintext, ad)</h3>
<p>Mã hóa bản rõ kèm xác thực:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Inputs</span>
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span><span style="color:#f92672">-</span>byte cipher key
</span></span><span style="display:flex;"><span>n <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span><span style="color:#f92672">-</span>byte nonce (first <span style="color:#ae81ff">4</span> bytes zero, last <span style="color:#ae81ff">8</span> bytes <span style="color:#f92672">=</span> message number)
</span></span><span style="display:flex;"><span>plaintext <span style="color:#f92672">=</span> data to encrypt (<span style="color:#ae81ff">0</span> to <span style="color:#ae81ff">65519</span> bytes)
</span></span><span style="display:flex;"><span>ad <span style="color:#f92672">=</span> associated data (optional, used <span style="color:#f92672">in</span> MAC calculation)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Output</span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> chacha20_encrypt(k, n, plaintext)
</span></span><span style="display:flex;"><span>mac <span style="color:#f92672">=</span> poly1305(ad <span style="color:#f92672">||</span> ciphertext, poly1305_key_gen(k, n))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> ciphertext <span style="color:#f92672">||</span> mac  <span style="color:#75715e"># Total length = len(plaintext) + 16</span>
</span></span></code></pre></div><p><strong>Thuộc tính:</strong> - Bản mã có cùng độ dài với bản rõ (mật mã dòng) - Đầu ra là plaintext_length + 16 byte (bao gồm MAC) - Toàn bộ đầu ra không thể phân biệt với ngẫu nhiên nếu khóa được giữ bí mật - MAC xác thực cả dữ liệu liên kết và bản mã</p>
<h3 id="chacha20-poly1305-decryptk-n-ciphertext-ad">ChaCha20-Poly1305 DECRYPT(k, n, ciphertext, ad)</h3>
<p>Giải mã và kiểm tra xác thực:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Split ciphertext and MAC</span>
</span></span><span style="display:flex;"><span>ct_without_mac <span style="color:#f92672">=</span> ciphertext[<span style="color:#ae81ff">0</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>received_mac <span style="color:#f92672">=</span> ciphertext[<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Verify MAC</span>
</span></span><span style="display:flex;"><span>expected_mac <span style="color:#f92672">=</span> poly1305(ad <span style="color:#f92672">||</span> ct_without_mac, poly1305_key_gen(k, n))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> constant_time_compare(received_mac, expected_mac):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> AuthenticationError(<span style="color:#e6db74">&#34;MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Decrypt</span>
</span></span><span style="display:flex;"><span>plaintext <span style="color:#f92672">=</span> chacha20_decrypt(k, n, ct_without_mac)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> plaintext
</span></span></code></pre></div><p><strong>Các yêu cầu bảo mật quan trọng:</strong> - Nonces (giá trị dùng một lần) PHẢI là duy nhất cho mỗi thông điệp dùng cùng một khóa - Nonces KHÔNG ĐƯỢC tái sử dụng (hậu quả thảm khốc nếu tái sử dụng) - Việc kiểm tra MAC (mã xác thực thông điệp) PHẢI sử dụng so sánh thời gian cố định để ngăn chặn các cuộc tấn công dựa trên thời gian - Việc kiểm tra MAC thất bại PHẢI dẫn đến việc từ chối toàn bộ thông điệp (không có giải mã từng phần)</p>
<h3 id="hàm-băm-sha-256">Hàm băm SHA-256</h3>
<p><strong>Đặc tả</strong>: NIST FIPS 180-4</p>
<p><strong>Thuộc tính:</strong> - <strong>Kích thước đầu ra</strong>: 32 byte (256 bit) - <strong>Kích thước khối</strong>: 64 byte (512 bit) - <strong>Mức độ bảo mật</strong>: 128 bit (khả năng chống va chạm)</p>
<p><strong>Vận hành:</strong></p>
<h3 id="sha-256-hp-d">SHA-256 H(p, d)</h3>
<p>Mã băm SHA-256 với chuỗi cá nhân hóa:</p>
<pre tabindex="0"><code>H(p, d) := SHA256(p || d)
</code></pre><p>Trong đó <code>||</code> biểu thị phép nối (concatenation), <code>p</code> là chuỗi cá nhân hóa (personalization string), <code>d</code> là dữ liệu.</p>
<h3 id="sha-256-mixhashd">SHA-256 MixHash(d)</h3>
<p>Cập nhật giá trị băm hiện tại với dữ liệu mới:</p>
<pre tabindex="0"><code>h = SHA256(h || d)
</code></pre><p>Được sử dụng xuyên suốt Noise handshake (quá trình bắt tay của giao thức Noise) để duy trì transcript hash (hàm băm bản ghi bắt tay).</p>
<h3 id="dẫn-xuất-khóa-hkdf">Dẫn xuất khóa HKDF</h3>
<p><strong>Đặc tả</strong>: <a href="https://tools.ietf.org/html/rfc5869">RFC 5869</a>
</p>
<p><strong>Mô tả</strong>: Hàm dẫn xuất khóa dựa trên HMAC sử dụng SHA-256</p>
<p><strong>Tham số:</strong> - <strong>Hàm băm</strong>: HMAC-SHA256 - <strong>Độ dài salt (chuỗi ngẫu nhiên)</strong>: Tối đa 32 byte (kích thước đầu ra SHA-256) - <strong>Độ dài đầu ra</strong>: Biến thiên (tối đa 255 * 32 byte)</p>
<p><strong>Hàm HKDF (hàm dẫn xuất khóa dựa trên HMAC):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">HKDF</span>(salt, ikm, info, length):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        salt: Salt value (32 bytes max for SHA-256)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ikm: Input key material (any length)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        info: Context-specific info string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        length: Desired output length in bytes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        output: Derived key material (length bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract phase</span>
</span></span><span style="display:flex;"><span>    prk <span style="color:#f92672">=</span> HMAC<span style="color:#f92672">-</span>SHA256(salt, ikm)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Expand phase</span>
</span></span><span style="display:flex;"><span>    n <span style="color:#f92672">=</span> ceil(length <span style="color:#f92672">/</span> <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    okm <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, n <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> HMAC<span style="color:#f92672">-</span>SHA256(prk, t <span style="color:#f92672">||</span> info <span style="color:#f92672">||</span> byte(i))
</span></span><span style="display:flex;"><span>        okm <span style="color:#f92672">=</span> okm <span style="color:#f92672">||</span> t
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> okm[<span style="color:#ae81ff">0</span>:length]
</span></span></code></pre></div><p><strong>Các mẫu sử dụng phổ biến:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate two keys (64 bytes total)</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret, <span style="color:#e6db74">&#34;KDFDHRatchetStep&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>nextRootKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate session tag (8 bytes)</span>
</span></span><span style="display:flex;"><span>tagdata <span style="color:#f92672">=</span> HKDF(chainKey, CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>nextChainKey <span style="color:#f92672">=</span> tagdata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>sessionTag <span style="color:#f92672">=</span> tagdata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate symmetric key (32 bytes)</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>nextChainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>sessionKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span></code></pre></div><p><strong>Chuỗi thông tin dùng trong ECIES:</strong> - <code>&quot;KDFDHRatchetStep&quot;</code> - dẫn xuất khóa cho DH ratchet (cơ chế bánh cóc) - <code>&quot;TagAndKeyGenKeys&quot;</code> - khởi tạo các khóa của chuỗi thẻ và chuỗi khóa - <code>&quot;STInitialization&quot;</code> - khởi tạo ratchet thẻ phiên - <code>&quot;SessionTagKeyGen&quot;</code> - sinh thẻ phiên - <code>&quot;SymmetricRatchet&quot;</code> - sinh khóa đối xứng - <code>&quot;XDHRatchetTagSet&quot;</code> - khóa tập thẻ cho DH ratchet - <code>&quot;SessionReplyTags&quot;</code> - sinh tập thẻ NSR - <code>&quot;AttachPayloadKDF&quot;</code> - dẫn xuất khóa payload NSR</p>
<h3 id="mã-hóa-elligator2">Mã hóa Elligator2</h3>
<p><strong>Mục đích</strong>: Mã hóa các khóa công khai X25519 để chúng không thể phân biệt được với các chuỗi 32 byte ngẫu nhiên phân phối đều.</p>
<p><strong>Đặc tả</strong>: <a href="https://elligator.cr.yp.to/elligator-20130828.pdf">Bài báo Elligator2</a>
</p>
<p><strong>Vấn đề</strong>: Các khóa công khai X25519 (thuật toán trao đổi khóa trên đường cong elliptic) tiêu chuẩn có cấu trúc dễ nhận diện. Một người quan sát có thể nhận diện các thông điệp bắt tay bằng cách phát hiện các khóa này, ngay cả khi nội dung được mã hóa.</p>
<p><strong>Giải pháp</strong>: Elligator2 cung cấp một ánh xạ song ánh giữa ~50% số khóa công khai X25519 hợp lệ và các chuỗi 254-bit trông như ngẫu nhiên.</p>
<p><strong>Sinh khóa với Elligator2 (kỹ thuật ẩn dạng khóa công khai):</strong></p>
<h3 id="elligator2-generate_private_elg2">Elligator2 GENERATE_PRIVATE_ELG2()</h3>
<p>Tạo một khóa riêng tương ứng với một khóa công khai có thể mã hóa theo Elligator2 (kỹ thuật ẩn dạng khóa công khai):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>    privkey <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    pubkey <span style="color:#f92672">=</span> DERIVE_PUBLIC(privkey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Test if public key is Elligator2-encodable</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        encoded <span style="color:#f92672">=</span> ENCODE_ELG2(pubkey)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Success - this key pair is suitable</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> privkey
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> NotEncodableError:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Try again with new random key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>
</span></span></code></pre></div><p><strong>Quan trọng</strong>: Khoảng 50% khóa riêng được tạo ngẫu nhiên sẽ tạo ra khóa công khai không thể mã hóa. Những khóa đó phải được loại bỏ và thử tạo lại.</p>
<p><strong>Tối ưu hóa hiệu năng</strong>: Tạo khóa trước trong một luồng nền để duy trì một pool (tập hợp dự trữ) các cặp khóa phù hợp, tránh độ trễ trong quá trình bắt tay.</p>
<h3 id="elligator2-encode_elg2pubkey">Elligator2 ENCODE_ELG2(pubkey)</h3>
<p>Mã hóa một khóa công khai thành 32 byte trông ngẫu nhiên:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ENCODE_ELG2</span>(pubkey):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Encodes X25519 public key using Elligator2.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pubkey: 32-byte X25519 public key (little-endian)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        encoded: 32-byte encoded key indistinguishable from random
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Raises:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        NotEncodableError: If pubkey cannot be encoded
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform Elligator2 representative calculation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Returns 254-bit value (31.75 bytes)</span>
</span></span><span style="display:flex;"><span>    encodedKey <span style="color:#f92672">=</span> elligator2_encode(pubkey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Add 2 random bits to MSB to make full 32 bytes</span>
</span></span><span style="display:flex;"><span>    randomByte <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    encodedKey[<span style="color:#ae81ff">31</span>] <span style="color:#f92672">|=</span> (randomByte <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xc0</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> encodedKey
</span></span></code></pre></div><p><strong>Chi tiết mã hóa:</strong> - Elligator2 (kỹ thuật ánh xạ điểm trên đường cong elliptic thành chuỗi byte trông ngẫu nhiên) tạo ra 254 bit (không đủ 256) - 2 bit cao nhất của byte 31 là phần đệm ngẫu nhiên - Kết quả được phân bố đều trên toàn bộ không gian 32 byte - Mã hóa thành công khoảng 50% khóa công khai X25519 (thuật toán trao đổi khóa ECDH trên Curve25519) hợp lệ</p>
<h3 id="elligator2-decode_elg2encodedkey">Elligator2 DECODE_ELG2(encodedKey)</h3>
<p>Giải mã trở lại khóa công khai ban đầu:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">DECODE_ELG2</span>(encodedKey):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Decodes Elligator2-encoded key back to X25519 public key.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        encodedKey: 32-byte encoded key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pubkey: 32-byte X25519 public key (little-endian)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Mask out 2 random padding bits from MSB</span>
</span></span><span style="display:flex;"><span>    encodedKey[<span style="color:#ae81ff">31</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0x3f</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform Elligator2 representative inversion</span>
</span></span><span style="display:flex;"><span>    pubkey <span style="color:#f92672">=</span> elligator2_decode(encodedKey)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pubkey
</span></span></code></pre></div><p><strong>Thuộc tính bảo mật:</strong> - Các khóa được mã hóa không thể phân biệt được về mặt tính toán so với các byte ngẫu nhiên - Không có phép kiểm định thống kê nào có thể phát hiện một cách đáng tin cậy các khóa được mã hóa theo Elligator2 (kỹ thuật ánh xạ giúp biểu diễn khóa trông như ngẫu nhiên) - Giải mã là tất định (cùng một khóa đã mã hóa luôn tạo ra cùng một khóa công khai) - Việc mã hóa là song ánh đối với khoảng ~50% số khóa thuộc tập con có thể mã hóa</p>
<p><strong>Ghi chú triển khai:</strong> - Lưu các khóa đã mã hóa trong giai đoạn tạo sinh để tránh mã hóa lại trong lúc bắt tay - Các khóa không phù hợp từ quá trình tạo bằng Elligator2 (kỹ thuật ẩn dạng khóa công khai) vẫn có thể dùng cho NTCP2 (không yêu cầu Elligator2) - Tạo khóa chạy nền là thiết yếu cho hiệu năng - Thời gian tạo trung bình tăng gấp đôi do tỷ lệ loại bỏ 50%</p>
<hr>
<h2 id="định-dạng-thông-điệp">Định dạng thông điệp</h2>
<h3 id="tổng-quan-1">Tổng quan</h3>
<p>ECIES (lược đồ mã hóa tích hợp trên đường cong elliptic) định nghĩa ba loại thông điệp:</p>
<ol>
<li><strong>New Session (NS)</strong> (Phiên mới): Thông điệp bắt tay ban đầu từ Alice đến Bob</li>
<li><strong>New Session Reply (NSR)</strong> (Phản hồi phiên mới): Phản hồi bắt tay của Bob gửi cho Alice</li>
<li><strong>Existing Session (ES)</strong> (Phiên hiện có): Tất cả các thông điệp tiếp theo ở cả hai chiều</li>
</ol>
<p>Tất cả thông điệp đều được đóng gói theo định dạng I2NP Garlic Message với các lớp mã hóa bổ sung.</p>
<h3 id="bộ-chứa-thông-điệp-garlic-của-i2np">Bộ chứa thông điệp Garlic của I2NP</h3>
<p>Tất cả các thông điệp ECIES (lược đồ mã hóa tích hợp dùng đường cong elliptic) đều được bọc trong các header tiêu chuẩn của I2NP Garlic Message:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|type|      msg_id       |  expiration   |
+----+----+----+----+----+----+----+----+
                         |  size   |chks|
+----+----+----+----+----+----+----+----+
|      length       |                   |
+----+----+----+----+                   +
|          encrypted data               |
~                                       ~
</code></pre><p><strong>Trường:</strong> - <code>type</code>: 0x26 (Garlic Message, thông điệp Garlic) - <code>msg_id</code>: ID thông điệp I2NP 4 byte - <code>expiration</code>: dấu thời gian Unix 8 byte (mili giây) - <code>size</code>: kích thước payload 2 byte - <code>chks</code>: checksum 1 byte - <code>length</code>: độ dài dữ liệu đã mã hóa 4 byte - <code>encrypted data</code>: payload được mã hóa bằng ECIES</p>
<p><strong>Mục đích</strong>: Cung cấp nhận dạng thông điệp và định tuyến ở tầng I2NP. Trường <code>length</code> cho phép bên nhận biết được tổng kích thước tải trọng đã mã hóa.</p>
<h3 id="thông-điệp-phiên-mới-ns">Thông điệp Phiên mới (NS)</h3>
<p>Thông điệp New Session (thông điệp mở phiên) khởi tạo một phiên mới từ Alice đến Bob. Nó có ba biến thể:</p>
<ol>
<li><strong>Có ràng buộc</strong> (1b): Bao gồm khóa tĩnh của Alice để giao tiếp hai chiều</li>
<li><strong>Không ràng buộc</strong> (1c): Không kèm khóa tĩnh để giao tiếp một chiều</li>
<li><strong>Dùng một lần</strong> (1d): Chế độ một thông điệp, không thiết lập phiên</li>
</ol>
<h3 id="thông-điệp-ns-có-ràng-buộc-loại-1b">Thông điệp NS có ràng buộc (Loại 1b)</h3>
<p><strong>Trường hợp sử dụng</strong>: Truyền phát, datagram (gói dữ liệu không kết nối) có thể phản hồi, bất kỳ giao thức nào yêu cầu phản hồi</p>
<p><strong>Tổng độ dài</strong>: 96 + payload_length byte</p>
<p><strong>Định dạng</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+                                       +
|   New Session Ephemeral Public Key    |
+             32 bytes                  +
|     Encoded with Elligator2           |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+         Static Key Section            +
|       ChaCha20 encrypted data         |
+            32 bytes                   +
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+    (MAC) for Static Key Section       +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for Payload Section     +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Chi tiết trường:</strong></p>
<p><strong>Khóa công khai tạm thời</strong> (32 byte, dạng rõ): - Khóa công khai X25519 sử dụng một lần của Alice - Được mã hóa bằng Elligator2 (không thể phân biệt với ngẫu nhiên) - Được tạo mới cho mỗi thông điệp NS (không bao giờ tái sử dụng) - Định dạng little-endian</p>
<p><strong>Phần Khóa Tĩnh</strong> (mã hóa 32 byte, 48 byte kèm MAC): - Chứa khóa công khai tĩnh X25519 của Alice (32 byte) - Được mã hóa bằng ChaCha20 - Được xác thực bằng Poly1305 MAC (16 byte) - Được Bob dùng để ràng buộc phiên với đích (destination) của Alice</p>
<p><strong>Phần Payload</strong> (mã hóa có độ dài biến đổi, +16 byte MAC): - Chứa các garlic cloves (đơn vị thông điệp trong I2P) và các khối khác - Phải bao gồm khối DateTime là khối đầu tiên - Thường bao gồm các khối Garlic Clove chứa dữ liệu ứng dụng - Có thể bao gồm khối NextKey cho ratchet ngay lập tức (cơ chế cập nhật khóa) - Mã hóa bằng ChaCha20 - Xác thực bằng Poly1305 MAC (16 byte)</p>
<p><strong>Thuộc tính bảo mật:</strong> - Khóa tạm thời cung cấp thành phần đảm bảo bí mật chuyển tiếp - Khóa tĩnh xác thực Alice (ràng buộc với đích) - Cả hai phần đều có MAC riêng để tách miền (domain separation) - Toàn bộ quy trình bắt tay thực hiện 2 phép toán DH (es, ss)</p>
<h3 id="thông-điệp-ns-không-có-ràng-buộc-loại-1c">Thông điệp NS không có ràng buộc (Loại 1c)</h3>
<p><strong>Trường hợp sử dụng</strong>: Các datagram thô (gói tin không kết nối) trong đó không kỳ vọng hoặc không mong muốn phản hồi</p>
<p><strong>Tổng độ dài</strong>: 96 + payload_length byte</p>
<p><strong>Định dạng</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+                                       +
|   New Session Ephemeral Public Key    |
+             32 bytes                  +
|     Encoded with Elligator2           |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+           Flags Section               +
|       ChaCha20 encrypted data         |
+            32 bytes                   +
|           All zeros                   |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for above section       +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for Payload Section     +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Khác biệt chính</strong>: Phần Flags chứa 32 byte toàn số 0 thay vì khóa tĩnh.</p>
<p><strong>Phát hiện</strong>: Bob xác định loại thông điệp bằng cách giải mã phần 32 byte và kiểm tra xem tất cả các byte có bằng 0 hay không: - Tất cả các byte bằng 0 → phiên không ràng buộc (loại 1c) - Khác 0 → phiên ràng buộc với khóa tĩnh (loại 1b)</p>
<p><strong>Thuộc tính:</strong> - Không có khóa tĩnh đồng nghĩa không ràng buộc với đích của Alice - Bob không thể gửi phản hồi (không biết đích) - Chỉ thực hiện 1 phép toán DH (Diffie–Hellman) (es) - Theo mẫu Noise &ldquo;N&rdquo; thay vì &ldquo;IK&rdquo; - Hiệu quả hơn khi không bao giờ cần phản hồi</p>
<p><strong>Phần cờ</strong> (dành cho sử dụng trong tương lai): Hiện tại tất cả là 0. Có thể được dùng để thương lượng tính năng trong các phiên bản tương lai.</p>
<h3 id="thông-điệp-ns-dùng-một-lần-loại-1d">Thông điệp NS dùng một lần (Loại 1d)</h3>
<p><strong>Trường hợp sử dụng</strong>: Thông điệp ẩn danh đơn lẻ không kỳ vọng phiên hoặc phản hồi</p>
<p><strong>Tổng độ dài</strong>: 96 + payload_length byte</p>
<p><strong>Định dạng</strong>: Giống hệt NS không có ràng buộc (loại 1c)</p>
<p><strong>Phân biệt</strong>:  - Type 1c có thể gửi nhiều thông điệp trong cùng một phiên (các thông điệp ES theo sau) - Type 1d gửi đúng một thông điệp mà không thiết lập phiên - Trên thực tế, các triển khai có thể coi chúng giống hệt nhau ban đầu</p>
<p><strong>Thuộc tính:</strong> - Ẩn danh tối đa (không có khóa tĩnh, không có phiên) - Không bên nào lưu giữ trạng thái phiên - Tuân theo mẫu &ldquo;N&rdquo; của Noise (bộ khung giao thức mật mã) - Một phép DH (es)</p>
<h3 id="thông-điệp-phản-hồi-phiên-mới-nsr">Thông điệp Phản hồi Phiên Mới (NSR)</h3>
<p>Bob gửi một hoặc nhiều thông điệp NSR (thông điệp &lsquo;Session Created&rsquo;) để đáp lại thông điệp NS (thông điệp &lsquo;Session Request&rsquo;) của Alice. NSR hoàn tất thủ tục bắt tay Noise IK (mẫu bắt tay IK trong giao thức Noise) và thiết lập một phiên giao tiếp hai chiều.</p>
<p><strong>Tổng độ dài</strong>: 72 + payload_length byte</p>
<p><strong>Định dạng</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|       Session Tag   8 bytes           |
+----+----+----+----+----+----+----+----+
|                                       |
+        Ephemeral Public Key           +
|                                       |
+            32 bytes                   +
|     Encoded with Elligator2           |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+  (MAC) for Key Section (empty)        +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+         (MAC) for Payload Section     +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Chi tiết trường:</strong></p>
<p><strong>Thẻ phiên</strong> (8 byte, bản rõ):</p>
<ul>
<li>Được tạo từ bộ thẻ NSR (xem các phần KDF)</li>
<li>Liên kết phản hồi này với thông điệp NS của Alice</li>
<li>Cho phép Alice xác định NS nào mà NSR này phản hồi</li>
<li>Chỉ dùng một lần (không bao giờ tái sử dụng)</li>
</ul>
<p><strong>Khóa công khai tạm thời</strong> (32 byte, dạng rõ): - Khóa công khai X25519 dùng một lần của Bob - Được mã hóa (biểu diễn) bằng Elligator2 (kỹ thuật ánh xạ ngụy trang khóa công khai thành dữ liệu trông như ngẫu nhiên) - Được tạo mới cho mỗi thông điệp NSR - Phải khác nhau cho mỗi NSR được gửi</p>
<p><strong>Key Section MAC</strong> (16 byte): - Xác thực dữ liệu rỗng (ZEROLEN) - Là một phần của giao thức Noise IK (mẫu se) - Sử dụng hash transcript (bản ghi băm) làm dữ liệu liên kết - Tối quan trọng để ràng buộc NSR với NS</p>
<p><strong>Phần tải</strong> (độ dài biến đổi): - Chứa garlic cloves (các thành phần con trong thông điệp garlic) và các khối - Thường bao gồm các phản hồi ở tầng ứng dụng - Có thể để trống (ACK-only NSR) - Kích thước tối đa: 65519 byte (65535 - 16 byte MAC)</p>
<p><strong>Nhiều thông điệp NSR:</strong></p>
<p>Bob có thể gửi nhiều thông điệp NSR để đáp lại một NS: - Mỗi NSR có khóa tạm thời duy nhất - Mỗi NSR có thẻ phiên duy nhất - Alice sử dụng NSR đầu tiên nhận được để hoàn tất bắt tay - Các NSR còn lại là dự phòng (trong trường hợp mất gói)</p>
<p><strong>Thời điểm then chốt:</strong> - Alice phải nhận được một NSR trước khi gửi các thông điệp ES - Bob phải nhận được một thông điệp ES trước khi gửi các thông điệp ES - NSR thiết lập các khóa phiên song hướng thông qua thao tác split()</p>
<p><strong>Thuộc tính bảo mật:</strong> - Hoàn tất Noise IK handshake (thủ tục bắt tay Noise IK) - Thực hiện thêm 2 phép toán DH (Diffie-Hellman) (ee, se) - Tổng cộng 4 phép toán DH trên NS+NSR - Đạt xác thực lẫn nhau (Cấp 2) - Cung cấp bảo mật chuyển tiếp yếu (Cấp 4) cho payload NSR</p>
<h3 id="thông-điệp-phiên-hiện-có-es">Thông điệp Phiên hiện có (ES)</h3>
<p>Tất cả các thông điệp sau NS/NSR handshake (bắt tay NS/NSR) sử dụng Existing Session format (định dạng Phiên hiện có). ES messages (các thông điệp ES) được sử dụng hai chiều bởi cả Alice và Bob.</p>
<p><strong>Tổng độ dài</strong>: 8 + payload_length + 16 byte (tối thiểu 24 byte)</p>
<p><strong>Định dạng</strong>:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|       Session Tag   8 bytes           |
+----+----+----+----+----+----+----+----+
|                                       |
+            Payload Section            +
|       ChaCha20 encrypted data         |
~          Variable length              ~
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|  Poly1305 Message Authentication Code |
+              (MAC)                    +
|             16 bytes                  |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Chi tiết trường:</strong></p>
<p><strong>Thẻ phiên (Session Tag)</strong> (8 byte, bản rõ): - Được tạo từ tập thẻ gửi đi hiện tại - Xác định phiên và số thông điệp - Bên nhận tra cứu thẻ để tìm khóa phiên và nonce (giá trị dùng một lần) - Chỉ dùng một lần (mỗi thẻ được dùng đúng một lần) - Định dạng: 8 byte đầu tiên của đầu ra HKDF</p>
<p><strong>Phần tải</strong> (độ dài thay đổi): - Chứa các garlic cloves (thông điệp con trong mô hình garlic) và các khối - Không có khối bắt buộc (có thể rỗng) - Các khối thường gặp: Garlic Clove, NextKey, ACK, ACK Request, Padding - Kích thước tối đa: 65519 byte (65535 - 16 byte MAC)</p>
<p><strong>MAC</strong> (16 bytes): - Thẻ xác thực Poly1305 - Được tính trên toàn bộ payload - Dữ liệu liên kết: thẻ phiên 8-byte - Phải được xác minh chính xác; nếu không, thông điệp sẽ bị từ chối</p>
<p><strong>Quy trình tra cứu thẻ:</strong></p>
<ol>
<li>Bên nhận trích xuất tag 8 byte</li>
<li>Tra cứu tag trong tất cả các inbound tagset (bộ thẻ vào) hiện tại</li>
<li>Truy xuất khóa phiên tương ứng và số thông điệp N</li>
<li>Dựng nonce (giá trị dùng một lần): <code>[0x00, 0x00, 0x00, 0x00, N (8 bytes little-endian)]</code></li>
<li>Giải mã payload (dữ liệu tải) bằng AEAD (mã hóa xác thực kèm dữ liệu liên kết) với tag làm dữ liệu liên kết</li>
<li>Xóa tag khỏi tagset (dùng một lần)</li>
<li>Xử lý các khối đã giải mã</li>
</ol>
<p><strong>Không tìm thấy thẻ phiên:</strong></p>
<p>Nếu không tìm thấy thẻ trong bất kỳ tagset (bộ thẻ) nào: - Có thể là một thông điệp NS → thử giải mã NS - Có thể là thông điệp NSR → thử giải mã NSR - Có thể là ES đến sai thứ tự → chờ một chút để tagset được cập nhật - Có thể là tấn công phát lại → từ chối - Có thể là dữ liệu bị hỏng → từ chối</p>
<p><strong>Payload rỗng:</strong></p>
<p>ES messages (thông điệp ES) có thể có payload (tải dữ liệu) rỗng (0 byte): - Đóng vai trò như một ACK (xác nhận) rõ ràng khi đã nhận được ACK Request - Cung cấp phản hồi ở tầng giao thức mà không có dữ liệu ứng dụng - Vẫn tiêu tốn một session tag (thẻ phiên) - Hữu ích khi tầng cao hơn không có dữ liệu cần gửi ngay</p>
<p><strong>Thuộc tính bảo mật:</strong> - Tính bí mật chuyển tiếp đầy đủ (Mức 5) sau khi nhận NSR - Mã hóa có xác thực thông qua AEAD - Tag (thẻ) đóng vai trò như dữ liệu liên kết bổ sung - Tối đa 65535 thông điệp cho mỗi tagset (tập thẻ) trước khi cần ratchet (cơ chế nấc)</p>
<hr>
<h2 id="các-hàm-dẫn-xuất-khóa">Các hàm dẫn xuất khóa</h2>
<p>Phần này mô tả tất cả các thao tác KDF (hàm dẫn xuất khóa) được sử dụng trong ECIES (sơ đồ mã hóa tích hợp trên đường cong elliptic), và trình bày đầy đủ các suy diễn mật mã.</p>
<h3 id="ký-hiệu-và-hằng-số">Ký hiệu và Hằng số</h3>
<p><strong>Hằng số:</strong> - <code>ZEROLEN</code> - Mảng byte độ dài 0 (chuỗi rỗng) - <code>||</code> - Toán tử nối</p>
<p><strong>Biến:</strong> - <code>h</code> - Băm tích lũy của bản ghi (32 byte) - <code>chainKey</code> - Khóa chuỗi cho HKDF (32 byte) - <code>k</code> - Khóa mã hóa đối xứng (32 byte) - <code>n</code> - Nonce / số thứ tự thông điệp</p>
<p><strong>Các khóa:</strong> - <code>ask</code> / <code>apk</code> - khóa riêng/công khai tĩnh của Alice - <code>aesk</code> / <code>aepk</code> - khóa riêng/công khai tạm thời của Alice - <code>bsk</code> / <code>bpk</code> - khóa riêng/công khai tĩnh của Bob - <code>besk</code> / <code>bepk</code> - khóa riêng/công khai tạm thời của Bob</p>
<h3 id="các-kdf-hàm-dẫn-xuất-khóa-cho-thông-điệp-ns">Các KDF (hàm dẫn xuất khóa) cho thông điệp NS</h3>
<h3 id="kdf-hàm-dẫn-xuất-khóa-1-khóa-chuỗi-ban-đầu">KDF (hàm dẫn xuất khóa) 1: Khóa chuỗi ban đầu</h3>
<p>Thực hiện một lần khi khởi tạo giao thức (có thể tính trước):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Protocol name (40 bytes, ASCII, no null termination)</span>
</span></span><span style="display:flex;"><span>protocol_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Noise_IKelg2+hs2_25519_ChaChaPoly_SHA256&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(protocol_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize chaining key</span>
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># MixHash with empty prologue</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: chainKey and h initialized</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Can be precalculated for all outbound sessions</span>
</span></span></code></pre></div><p><strong>Kết quả:</strong> - <code>chainKey</code> = Khóa chuỗi ban đầu cho tất cả các KDF tiếp theo - <code>h</code> = Bản ghi băm ban đầu</p>
<h3 id="kdf-2-trộn-khóa-tĩnh-của-bob">KDF 2: Trộn khóa tĩnh của Bob</h3>
<p>Bob thực hiện điều này một lần (có thể tính trước cho tất cả các phiên inbound (phiên vào)):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Bob&#39;s static keys (published in LeaseSet)</span>
</span></span><span style="display:flex;"><span>bsk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>bpk <span style="color:#f92672">=</span> DERIVE_PUBLIC(bsk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix Bob&#39;s public key into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bpk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: h updated with Bob&#39;s identity</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Can be precalculated by Bob for all inbound sessions</span>
</span></span></code></pre></div><h3 id="kdf-3-sinh-khóa-tạm-thời-của-alice">KDF 3: Sinh khóa tạm thời của Alice</h3>
<p>Alice sinh các khóa mới cho mỗi thông điệp NS:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate ephemeral key pair suitable for Elligator2</span>
</span></span><span style="display:flex;"><span>aesk <span style="color:#f92672">=</span> GENERATE_PRIVATE_ELG2()
</span></span><span style="display:flex;"><span>aepk <span style="color:#f92672">=</span> DERIVE_PUBLIC(aesk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ephemeral public key into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> aepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Elligator2 encode for transmission</span>
</span></span><span style="display:flex;"><span>elg2_aepk <span style="color:#f92672">=</span> ENCODE_ELG2(aepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: h updated with Alice&#39;s ephemeral key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send elg2_aepk as first 32 bytes of NS message</span>
</span></span></code></pre></div><h3 id="kdf-4-phần-khóa-tĩnh-ns-es-dh">KDF 4: Phần khóa tĩnh NS (es DH)</h3>
<p>Dẫn xuất các khóa để mã hóa khóa tĩnh của Alice:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Perform first DH (ephemeral-static)</span>
</span></span><span style="display:flex;"><span>sharedSecret <span style="color:#f92672">=</span> DH(aesk, bpk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Equivalent: sharedSecret = DH(bsk, aepk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive cipher key from shared secret</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD encryption parameters</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> h  <span style="color:#75715e"># Current hash transcript</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt static key section</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> binding_requested:
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> apk  <span style="color:#75715e"># Alice&#39;s static public key (32 bytes)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> bytes(<span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># All zeros for unbound</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, plaintext, associated_data)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ciphertext = 32 bytes encrypted + 16 bytes MAC = 48 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ciphertext into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> ciphertext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Static key section encrypted, h updated</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext (48 bytes) as next part of NS message</span>
</span></span></code></pre></div><h3 id="kdf-5-hàm-dẫn-xuất-khóa-phần-ns-payload-ss-dh-chỉ-ràng-buộc">KDF 5 (hàm dẫn xuất khóa): Phần NS Payload (ss DH, chỉ ràng buộc)</h3>
<p>Đối với các phiên đã ràng buộc, thực hiện DH lần thứ hai (trao đổi khóa Diffie–Hellman) để mã hóa payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> binding_requested:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice&#39;s static keys</span>
</span></span><span style="display:flex;"><span>    ask <span style="color:#f92672">=</span> GENERATE_PRIVATE()  <span style="color:#75715e"># Alice&#39;s long-term key</span>
</span></span><span style="display:flex;"><span>    apk <span style="color:#f92672">=</span> DERIVE_PUBLIC(ask)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform second DH (static-static)</span>
</span></span><span style="display:flex;"><span>    sharedSecret <span style="color:#f92672">=</span> DH(ask, bpk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Equivalent: sharedSecret = DH(bsk, apk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive cipher key</span>
</span></span><span style="display:flex;"><span>    keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>    k <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    associated_data <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Unbound: reuse keys from static key section</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># chainKey and k unchanged</span>
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># Increment nonce (reusing same key)</span>
</span></span><span style="display:flex;"><span>    associated_data <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt payload</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> build_payload()  <span style="color:#75715e"># DateTime + Garlic Cloves + etc.</span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, payload, associated_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ciphertext into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> ciphertext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Payload encrypted, h contains complete NS transcript</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Save chainKey and h for NSR processing</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext as final part of NS message</span>
</span></span></code></pre></div><p><strong>Lưu ý quan trọng:</strong></p>
<ol>
<li>
<p><strong>Bound (ràng buộc) vs Unbound (không ràng buộc)</strong>:</p>
<ul>
<li>Bound thực hiện 2 phép toán DH (es + ss)</li>
<li>Unbound thực hiện 1 phép toán DH (chỉ es)</li>
<li>Unbound tăng nonce (giá trị dùng một lần) thay vì dẫn xuất khóa mới</li>
</ul>
</li>
<li>
<p><strong>An toàn khi tái sử dụng khóa</strong>:</p>
<ul>
<li>Các nonce (giá trị dùng một lần) khác nhau (0 so với 1) ngăn chặn việc tái sử dụng khóa/nonce</li>
<li>Dữ liệu liên kết khác nhau (h khác) đảm bảo phân tách miền</li>
</ul>
</li>
<li>
<p><strong>Hash Transcript (bản ghi băm)</strong>:</p>
<ul>
<li><code>h</code> hiện chứa: protocol_name, empty prologue, bpk, aepk, static_key_ciphertext, payload_ciphertext</li>
<li>Bản ghi này ràng buộc tất cả các phần của NS message (thông điệp NS) lại với nhau</li>
</ul>
</li>
</ol>
<h3 id="kdf-hàm-dẫn-xuất-khóa-cho-tập-thẻ-phản-hồi-nsr-một-cơ-chế-trong-i2p-viết-tắt-giữ-nguyên">KDF (hàm dẫn xuất khóa) cho tập thẻ phản hồi NSR (một cơ chế trong I2P; viết tắt, giữ nguyên)</h3>
<p>Bob tạo thẻ cho các thông điệp NSR:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Chain key from NS payload section</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># chainKey = final chainKey from NS KDF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate tagset key</span>
</span></span><span style="display:flex;"><span>tagsetKey <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SessionReplyTags&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize NSR tagset (see DH_INITIALIZE below)</span>
</span></span><span style="display:flex;"><span>tagset_nsr <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, tagsetKey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get tag for this NSR</span>
</span></span><span style="display:flex;"><span>tagsetEntry <span style="color:#f92672">=</span> tagset_nsr<span style="color:#f92672">.</span>GET_NEXT_ENTRY()
</span></span><span style="display:flex;"><span>tag <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_TAG  <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: tag available for NSR message</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send tag as first 8 bytes of NSR</span>
</span></span></code></pre></div><h3 id="các-hàm-dẫn-xuất-khóa-kdf-cho-thông-điệp-nsr">Các hàm dẫn xuất khóa (KDF) cho thông điệp NSR</h3>
<h3 id="kdf-6-sinh-khóa-tạm-thời-cho-nsr">KDF 6: Sinh khóa tạm thời cho NSR</h3>
<p>Bob tạo một khóa phiên tạm thời mới cho mỗi NSR:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Mix tag into hash (I2P extension to Noise)</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> tag)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate ephemeral key pair</span>
</span></span><span style="display:flex;"><span>besk <span style="color:#f92672">=</span> GENERATE_PRIVATE_ELG2()
</span></span><span style="display:flex;"><span>bepk <span style="color:#f92672">=</span> DERIVE_PUBLIC(besk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ephemeral public key into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Elligator2 encode for transmission</span>
</span></span><span style="display:flex;"><span>elg2_bepk <span style="color:#f92672">=</span> ENCODE_ELG2(bepk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: h updated with tag and Bob&#39;s ephemeral key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send elg2_bepk as bytes 9-40 of NSR message</span>
</span></span></code></pre></div><h3 id="kdf-7-phần-khóa-nsr-ee-và-se-dh">KDF 7: Phần khóa NSR (ee và se DH)</h3>
<p>Dẫn xuất các khóa cho phần khóa NSR:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Perform third DH (ephemeral-ephemeral)</span>
</span></span><span style="display:flex;"><span>sharedSecret_ee <span style="color:#f92672">=</span> DH(aesk, bepk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Equivalent: sharedSecret_ee = DH(besk, aepk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ee into chain</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret_ee, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Perform fourth DH (static-ephemeral)</span>
</span></span><span style="display:flex;"><span>sharedSecret_se <span style="color:#f92672">=</span> DH(ask, bepk)  <span style="color:#75715e"># Alice computes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Equivalent: sharedSecret_se = DH(besk, apk)  # Bob computes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive cipher key from se</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, sharedSecret_se, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD encryption of empty data (key section has no payload)</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, ZEROLEN, associated_data)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ciphertext = 16 bytes (MAC only, no plaintext)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mix ciphertext into hash</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> ciphertext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Key section encrypted, chainKey contains all 4 DH results</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext (16 bytes MAC) as bytes 41-56 of NSR</span>
</span></span></code></pre></div><p><strong>Quan trọng</strong>: Điều này hoàn tất Noise IK handshake (thủ tục bắt tay theo giao thức Noise IK). <code>chainKey</code> hiện đã bao gồm phần đóng góp từ cả 4 phép toán DH (es, ss, ee, se).</p>
<h3 id="kdf-hàm-dẫn-xuất-khóa-8-phần-tải-trọng-nsr">KDF (hàm dẫn xuất khóa) 8: Phần tải trọng NSR</h3>
<p>Dẫn xuất các khóa để mã hóa phần tải NSR:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Split chainKey into bidirectional keys</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>k_ab <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]   <span style="color:#75715e"># Alice → Bob key</span>
</span></span><span style="display:flex;"><span>k_ba <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Bob → Alice key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize ES tagsets for both directions</span>
</span></span><span style="display:flex;"><span>tagset_ab <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ab)  <span style="color:#75715e"># Alice → Bob</span>
</span></span><span style="display:flex;"><span>tagset_ba <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ba)  <span style="color:#75715e"># Bob → Alice</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive NSR payload key (Bob → Alice)</span>
</span></span><span style="display:flex;"><span>k_nsr <span style="color:#f92672">=</span> HKDF(k_ba, ZEROLEN, <span style="color:#e6db74">&#34;AttachPayloadKDF&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt NSR payload</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> h  <span style="color:#75715e"># Binds payload to entire NSR</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> build_payload()  <span style="color:#75715e"># Usually application reply</span>
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_nsr, nonce, payload, associated_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># State: Bidirectional ES sessions established</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tagset_ab and tagset_ba ready for ES messages</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send ciphertext as bytes 57+ of NSR message</span>
</span></span></code></pre></div><p><strong>Lưu ý quan trọng:</strong></p>
<ol>
<li>
<p><strong>Split Operation</strong> (thao tác tách):</p>
<ul>
<li>Tạo các khóa độc lập cho từng hướng</li>
<li>Ngăn việc tái sử dụng khóa giữa Alice→Bob và Bob→Alice</li>
</ul>
</li>
<li>
<p><strong>NSR Payload Binding</strong>:</p>
<ul>
<li>Sử dụng <code>h</code> làm dữ liệu liên kết để ràng buộc payload với quá trình bắt tay</li>
<li>Một KDF (hàm dẫn xuất khóa) tách biệt (&ldquo;AttachPayloadKDF&rdquo;) cung cấp phân tách miền (domain separation)</li>
</ul>
</li>
<li>
<p><strong>Sẵn sàng ES</strong>:</p>
<ul>
<li>Sau NSR, cả hai bên có thể gửi thông điệp ES</li>
<li>Alice phải nhận NSR trước khi gửi ES</li>
<li>Bob phải nhận ES trước khi gửi ES</li>
</ul>
</li>
</ol>
<h3 id="kdfs-hàm-dẫn-xuất-khóa-cho-thông-điệp-es">KDFs (hàm dẫn xuất khóa) cho thông điệp ES</h3>
<p>Các thông điệp ES sử dụng các khóa phiên được tạo sẵn từ các tagset (tập thẻ phiên):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Sender gets next tag and key</span>
</span></span><span style="display:flex;"><span>tagsetEntry <span style="color:#f92672">=</span> outbound_tagset<span style="color:#f92672">.</span>GET_NEXT_ENTRY()
</span></span><span style="display:flex;"><span>tag <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_TAG     <span style="color:#75715e"># 8 bytes</span>
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_KEY       <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>N <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>INDEX             <span style="color:#75715e"># Message number</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Construct nonce (12 bytes)</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>] <span style="color:#f92672">+</span> little_endian_8_bytes(N)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD encryption</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> tag  <span style="color:#75715e"># Tag is associated data</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> build_payload()
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(k, nonce, payload, associated_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send: tag || ciphertext (8 + len(ciphertext) bytes)</span>
</span></span></code></pre></div><p><strong>Tiến trình nhận:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Extract tag</span>
</span></span><span style="display:flex;"><span>tag <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Look up tag in inbound tagsets</span>
</span></span><span style="display:flex;"><span>tagsetEntry <span style="color:#f92672">=</span> inbound_tagset<span style="color:#f92672">.</span>GET_SESSION_KEY(tag)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> tagsetEntry <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Not an ES message, try NS/NSR decryption</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> try_handshake_decryption(message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>SESSION_KEY
</span></span><span style="display:flex;"><span>N <span style="color:#f92672">=</span> tagsetEntry<span style="color:#f92672">.</span>INDEX
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Construct nonce</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>] <span style="color:#f92672">+</span> little_endian_8_bytes(N)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AEAD decryption</span>
</span></span><span style="display:flex;"><span>associated_data <span style="color:#f92672">=</span> tag
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">8</span>:]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> DECRYPT(k, nonce, ciphertext, associated_data)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># MAC verification failed, reject message</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> reject_message()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Process payload blocks</span>
</span></span><span style="display:flex;"><span>process_payload(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remove tag from tagset (one-time use)</span>
</span></span><span style="display:flex;"><span>inbound_tagset<span style="color:#f92672">.</span>remove(tag)
</span></span></code></pre></div><h3 id="hàm-dh_initialize">Hàm DH_INITIALIZE</h3>
<p>Tạo một tagset (tập thẻ) cho một chiều:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">DH_INITIALIZE</span>(rootKey, k):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Initializes a tagset with session tag and symmetric key ratchets.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        rootKey: Chain key from previous DH ratchet (32 bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        k: Key material from split() or DH ratchet (32 bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        tagset: Initialized tagset object
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive next root key and chain key</span>
</span></span><span style="display:flex;"><span>    keydata <span style="color:#f92672">=</span> HKDF(rootKey, k, <span style="color:#e6db74">&#34;KDFDHRatchetStep&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    nextRootKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>    chainKey_tagset <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Derive separate chain keys for tags and keys</span>
</span></span><span style="display:flex;"><span>    keydata <span style="color:#f92672">=</span> HKDF(chainKey_tagset, ZEROLEN, <span style="color:#e6db74">&#34;TagAndKeyGenKeys&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    sessTag_ck <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]   <span style="color:#75715e"># Session tag chain key</span>
</span></span><span style="display:flex;"><span>    symmKey_ck <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Symmetric key chain key</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create tagset object</span>
</span></span><span style="display:flex;"><span>    tagset <span style="color:#f92672">=</span> Tagset()
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>nextRootKey <span style="color:#f92672">=</span> nextRootKey
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>sessTag_chainKey <span style="color:#f92672">=</span> sessTag_ck
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>symmKey_chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>lastIndex <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tagset
</span></span></code></pre></div><p><strong>Ngữ cảnh sử dụng:</strong></p>
<ol>
<li><strong>NSR Tagset (tập thẻ)</strong>: <code>DH_INITIALIZE(chainKey_from_NS, tagsetKey_NSR)</code></li>
<li><strong>ES Tagsets</strong>: <code>DH_INITIALIZE(chainKey_from_NSR, k_ab or k_ba)</code></li>
<li><strong>Ratcheted Tagsets (theo cơ chế bánh cóc)</strong>: <code>DH_INITIALIZE(nextRootKey_from_previous, tagsetKey_from_DH)</code></li>
</ol>
<hr>
<h2 id="các-cơ-chế-ratchet-cơ-chế-bánh-cóc">Các cơ chế Ratchet (cơ chế bánh cóc)</h2>
<p>ECIES (Sơ đồ mã hóa tích hợp trên đường cong elliptic) sử dụng ba cơ chế ratchet đồng bộ (cơ chế cập nhật khóa từng bước) để cung cấp tính bí mật chuyển tiếp và quản lý phiên hiệu quả.</p>
<h3 id="tổng-quan-về-ratchet-cơ-chế-ratchet-trong-mật-mã">Tổng quan về Ratchet (cơ chế ratchet trong mật mã)</h3>
<p><strong>Ba loại Ratchet (cơ chế bánh cóc):</strong></p>
<ol>
<li><strong>DH Ratchet (cơ chế ratchet - cơ chế tiến hóa khóa)</strong>: Thực hiện các trao đổi khóa Diffie–Hellman để tạo ra các khóa gốc mới</li>
<li><strong>Session Tag Ratchet</strong>: Dẫn xuất các thẻ phiên dùng một lần một cách xác định</li>
<li><strong>Symmetric Key Ratchet</strong>: Dẫn xuất các khóa phiên để mã hóa thông điệp</li>
</ol>
<p><strong>Mối quan hệ:</strong></p>
<pre tabindex="0"><code>DH Ratchet (periodic)
    ↓
Creates new tagset
    ↓
Session Tag Ratchet (per message) ← synchronized → Symmetric Key Ratchet (per message)
    ↓                                                      ↓
Session Tags (8 bytes each)                      Session Keys (32 bytes each)
</code></pre><p><strong>Các thuộc tính chính:</strong></p>
<ul>
<li><strong>Bên gửi</strong>: Tạo thẻ và khóa theo nhu cầu (không cần lưu trữ)</li>
<li><strong>Bên nhận</strong>: Tạo sẵn thẻ cho cửa sổ nhìn trước (cần lưu trữ)</li>
<li><strong>Đồng bộ hóa</strong>: Chỉ số thẻ xác định chỉ số khóa (N_tag = N_key)</li>
<li><strong>Bí mật chuyển tiếp</strong>: Đạt được thông qua DH ratchet (cơ chế bánh cóc Diffie–Hellman để luân phiên khóa) định kỳ</li>
<li><strong>Hiệu quả</strong>: Bên nhận có thể hoãn việc tính toán khóa cho đến khi nhận được thẻ</li>
</ul>
<h3 id="dh-ratchet-cơ-chế-bánh-cóc-diffiehellman">DH Ratchet (cơ chế bánh cóc Diffie–Hellman)</h3>
<p>DH ratchet (cơ chế “bánh cóc” Diffie–Hellman) cung cấp tính bí mật chuyển tiếp (forward secrecy) bằng cách định kỳ trao đổi các khóa tạm thời mới.</p>
<h3 id="tần-suất-dh-ratchet-cơ-chế-ratchet-diffie-hellman">Tần suất DH Ratchet (cơ chế ratchet Diffie-Hellman)</h3>
<p><strong>Các điều kiện Ratchet (cơ chế xoay khóa) bắt buộc:</strong> - Tập thẻ sắp cạn (thẻ 65535 là tối đa) - Các chính sách cụ thể theo triển khai:   - Ngưỡng số lượng thông điệp (ví dụ, cứ 4096 thông điệp)   - Ngưỡng thời gian (ví dụ, cứ 10 phút)   - Ngưỡng dung lượng dữ liệu (ví dụ, cứ 100 MB)</p>
<p><strong>Khuyến nghị về First Ratchet (cơ chế bánh cóc trong mật mã)</strong>: Khoảng nhãn số 4096 để tránh đạt tới giới hạn</p>
<p><strong>Giá trị tối đa:</strong> - <strong>ID tập thẻ tối đa</strong>: 65535 - <strong>ID khóa tối đa</strong>: 32767 - <strong>Số thông điệp tối đa trên mỗi tập thẻ</strong>: 65535 - <strong>Dung lượng dữ liệu tối đa theo lý thuyết mỗi phiên</strong>: ~6.9 TB (64K tập thẻ × 64K thông điệp × 1730 byte trung bình)</p>
<h3 id="nhãn-và-id-khóa-trong-dh-ratchet-cơ-chế-bánh-cóc-diffie-hellman">Nhãn và ID khóa trong DH Ratchet (cơ chế bánh cóc Diffie-Hellman)</h3>
<p><strong>Tag set ban đầu (tập thẻ)</strong> (sau bắt tay): - Tag set ID: 0 - Chưa có khối NextKey nào được gửi - Chưa gán ID khóa nào</p>
<p><strong>Sau Ratchet (cơ chế bánh cóc mật mã) đầu tiên</strong>: - ID tập thẻ: 1 = (1 + ID khóa của Alice + ID khóa của Bob) = (1 + 0 + 0) - Alice gửi NextKey với ID khóa 0 - Bob phản hồi bằng NextKey với ID khóa 0</p>
<p><strong>Các tập nhãn tiếp theo</strong>: - ID tập nhãn = 1 + ID khóa của bên gửi + ID khóa của bên nhận - Ví dụ: Tập nhãn 5 = (1 + sender_key_2 + receiver_key_2)</p>
<p><strong>Bảng tiến triển của tập thẻ:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Tag Set ID</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Sender Key ID</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Receiver Key ID</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">n/a</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">n/a</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial tag set (post-NSR)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">First ratchet (both generate new keys)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Sender generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">3</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Receiver generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">4</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Sender generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">5</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Receiver generates new key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">...</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">...</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">...</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Pattern repeats</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">65534</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32767 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32766</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Second-to-last tag set</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">65535</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32767</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">32767 *</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Final tag set</td>
    </tr>
  </tbody>
</table>
\* = Khóa mới được tạo trong bước ratchet (cơ chế bánh cóc đổi khóa) này
<p><strong>Quy tắc ID khóa:</strong> - ID theo thứ tự tăng dần, bắt đầu từ 0 - ID chỉ tăng khi tạo khóa mới - ID khóa tối đa là 32767 (15 bit) - Sau ID khóa 32767, cần phiên mới</p>
<h3 id="luồng-thông-điệp-của-dh-ratchet-cơ-chế-bánh-cóc-diffie-hellman">Luồng thông điệp của DH Ratchet (cơ chế bánh cóc Diffie-Hellman)</h3>
<p><strong>Vai trò:</strong> - <strong>Tag Sender</strong> (Bên gửi tag): Sở hữu bộ tag hướng ra, gửi thông điệp - <strong>Tag Receiver</strong> (Bên nhận tag): Sở hữu bộ tag hướng vào, nhận thông điệp</p>
<p><strong>Pattern:</strong> Bên gửi thẻ khởi động ratchet (cơ chế cập nhật khóa) khi tập thẻ gần cạn.</p>
<p><strong>Sơ đồ luồng thông điệp:</strong></p>
<pre tabindex="0"><code>Tag Sender                         Tag Receiver

       ... using tag set #0 ...

(Tag set #0 approaching exhaustion)
(Generate new key #0)

NextKey forward, request reverse, with key #0  --------&gt;
(Repeat until NextKey ACK received)
                                   (Generate new key #0)
                                   (Perform DH: sender_key_0 × receiver_key_0)
                                   (Create inbound tag set #1)

        &lt;---------------           NextKey reverse, with key #0
                                   (Repeat until tag from tag set #1 received)

(Receive NextKey with key #0)
(Perform DH: sender_key_0 × receiver_key_0)
(Create outbound tag set #1)


       ... using tag set #1 ...


(Tag set #1 approaching exhaustion)
(Generate new key #1)

NextKey forward, with key #1        --------&gt;
(Repeat until NextKey ACK received)
                                   (Reuse existing key #0)
                                   (Perform DH: sender_key_1 × receiver_key_0)
                                   (Create inbound tag set #2)

        &lt;--------------            NextKey reverse, id 0 (ACK)
                                   (Repeat until tag from tag set #2 received)

(Receive NextKey with id 0)
(Perform DH: sender_key_1 × receiver_key_0)
(Create outbound tag set #2)


       ... using tag set #2 ...


(Tag set #2 approaching exhaustion)
(Reuse existing key #1)

NextKey forward, request reverse, id 1  --------&gt;
(Repeat until NextKey received)
                                   (Generate new key #1)
                                   (Perform DH: sender_key_1 × receiver_key_1)
                                   (Create inbound tag set #3)

        &lt;--------------            NextKey reverse, with key #1

(Receive NextKey with key #1)
(Perform DH: sender_key_1 × receiver_key_1)
(Create outbound tag set #3)


       ... using tag set #3 ...

       (Pattern repeats: even-numbered tag sets
        use forward key, odd-numbered use reverse key)
</code></pre><p><strong>Các mẫu Ratchet (cơ chế cập nhật khóa một chiều):</strong></p>
<p><strong>Tạo các bộ thẻ đánh số chẵn</strong> (2, 4, 6, &hellip;): 1. Người gửi sinh khóa mới 2. Người gửi gửi khối NextKey kèm khóa mới 3. Người nhận gửi khối NextKey kèm ID khóa cũ (ACK - xác nhận) 4. Cả hai thực hiện DH (trao đổi khóa Diffie-Hellman) với (khóa người gửi mới × khóa người nhận cũ)</p>
<p><strong>Tạo các tập thẻ số lẻ</strong> (3, 5, 7, &hellip;): 1. Người gửi yêu cầu khóa đảo chiều (gửi NextKey với cờ yêu cầu) 2. Người nhận tạo khóa mới 3. Người nhận gửi khối NextKey với khóa mới 4. Cả hai thực hiện DH (Diffie-Hellman) với (khóa người gửi cũ × khóa người nhận mới)</p>
<h3 id="định-dạng-khối-nextkey-khóa-tiếp-theo">Định dạng khối NextKey (khóa tiếp theo)</h3>
<p>Xem phần Payload Format để biết đặc tả chi tiết của khối NextKey.</p>
<p><strong>Các thành phần chính:</strong> - <strong>Byte cờ</strong>:   - Bit 0: Có khóa (1) hoặc chỉ ID (0)   - Bit 1: Khóa ngược (1) hoặc khóa xuôi (0)   - Bit 2: Yêu cầu khóa ngược (1) hoặc không yêu cầu (0) - <strong>ID khóa</strong>: 2 byte, big-endian (0-32767) - <strong>Khóa công khai</strong>: 32 byte X25519 (nếu bit 0 = 1)</p>
<p><strong>Ví dụ về NextKey Blocks (các khối khóa kế tiếp):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Sender initiates ratchet with new key (key ID 0, tag set 1)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, pubkey<span style="color:#f92672">=</span>sender_key_0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver replies with new key (key ID 0, tag set 1)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, pubkey<span style="color:#f92672">=</span>receiver_key_0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sender ratchets again with new key (key ID 1, tag set 2)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, pubkey<span style="color:#f92672">=</span>sender_key_1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver ACKs with old key ID (tag set 2)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x02</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sender requests reverse key (tag set 3)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x04</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver sends new reverse key (key ID 1, tag set 3)</span>
</span></span><span style="display:flex;"><span>NextKey(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, pubkey<span style="color:#f92672">=</span>receiver_key_1)
</span></span></code></pre></div><h3 id="hàm-dẫn-xuất-khóa-kdf-của-dh-ratchet-cơ-chế-bánh-cóc-diffiehellman">Hàm dẫn xuất khóa (KDF) của DH Ratchet (cơ chế bánh cóc Diffie–Hellman)</h3>
<p>Khi các khóa mới được trao đổi:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Tag sender generates or reuses key</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> generating_new:
</span></span><span style="display:flex;"><span>    sender_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    sender_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(sender_sk)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Reuse existing key pair</span>
</span></span><span style="display:flex;"><span>    sender_pk <span style="color:#f92672">=</span> existing_sender_pk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag receiver generates or reuses key</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> generating_new:
</span></span><span style="display:flex;"><span>    receiver_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    receiver_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(receiver_sk)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Reuse existing key pair</span>
</span></span><span style="display:flex;"><span>    receiver_pk <span style="color:#f92672">=</span> existing_receiver_pk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Both parties perform DH</span>
</span></span><span style="display:flex;"><span>sharedSecret <span style="color:#f92672">=</span> DH(sender_sk, receiver_pk)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Derive tagset key</span>
</span></span><span style="display:flex;"><span>tagsetKey <span style="color:#f92672">=</span> HKDF(sharedSecret, ZEROLEN, <span style="color:#e6db74">&#34;XDHRatchetTagSet&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get next root key from previous tagset</span>
</span></span><span style="display:flex;"><span>rootKey <span style="color:#f92672">=</span> previous_tagset<span style="color:#f92672">.</span>nextRootKey
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize new tagset</span>
</span></span><span style="display:flex;"><span>new_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(rootKey, tagsetKey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag sender: outbound tagset</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag receiver: inbound tagset</span>
</span></span></code></pre></div><p><strong>Thời điểm then chốt:</strong></p>
<p><strong>Tag Sender (bên gửi tag):</strong> - Tạo bộ tag đầu ra mới ngay lập tức - Bắt đầu sử dụng các tag mới ngay lập tức - Xóa bộ tag đầu ra cũ</p>
<p><strong>Tag Receiver (bộ nhận tag):</strong> - Tạo tập thẻ đến mới - Giữ lại tập thẻ đến cũ trong khoảng ân hạn (3 phút) - Chấp nhận các thẻ từ cả hai tập thẻ cũ và mới trong khoảng ân hạn - Xóa tập thẻ đến cũ sau khi hết khoảng ân hạn</p>
<h3 id="quản-lý-trạng-thái-dh-ratchet-cơ-chế-bánh-cóc-diffie-hellman">Quản lý trạng thái DH Ratchet (cơ chế bánh cóc Diffie-Hellman)</h3>
<p><strong>Trạng thái bên gửi:</strong> - Tập thẻ (tag) gửi đi hiện tại - ID tập thẻ và các ID khóa - Khóa gốc kế tiếp (cho ratchet (cơ chế bánh cóc trong mật mã) kế tiếp) - Số lượng thông điệp trong tập thẻ hiện tại</p>
<p><strong>Trạng thái bên nhận:</strong> - Tập thẻ đến hiện tại (có thể có 2 trong thời gian ân hạn) - Các số thứ tự thông điệp trước đó (PN) để phát hiện khoảng trống - Cửa sổ nhìn trước của các thẻ được tạo trước - Khóa gốc tiếp theo (cho ratchet (cơ chế bánh cóc) tiếp theo)</p>
<p><strong>Quy tắc chuyển trạng thái:</strong></p>
<ol>
<li>
<p><strong>Trước lần Ratchet (cơ chế bánh cóc thay đổi khóa) đầu tiên</strong>:</p>
<ul>
<li>Sử dụng tag set 0 (từ NSR)</li>
<li>Chưa gán ID khóa nào</li>
</ul>
</li>
<li>
<p><strong>Khởi tạo Ratchet (cơ chế bánh cóc mã hóa)</strong>:</p>
<ul>
<li>Tạo khóa mới (nếu bên gửi là bên tạo trong vòng này)</li>
<li>Gửi NextKey block (khối thông báo khóa kế tiếp) trong ES message (thông điệp ES)</li>
<li>Chờ phản hồi NextKey trước khi tạo tag set (tập thẻ) gửi đi mới</li>
</ul>
</li>
<li>
<p><strong>Receiving Ratchet Request (yêu cầu ratchet - cơ chế xoay/luân phiên khóa)</strong>:</p>
<ul>
<li>Tạo khóa mới (nếu bên nhận là bên tạo trong vòng này)</li>
<li>Thực hiện DH (Diffie-Hellman) với khóa nhận được</li>
<li>Tạo bộ thẻ vào mới</li>
<li>Gửi phản hồi NextKey</li>
<li>Giữ lại bộ thẻ vào cũ trong một khoảng ân hạn</li>
</ul>
</li>
<li>
<p><strong>Hoàn tất Ratchet (cơ chế chuyển khóa trong mật mã)</strong>:</p>
<ul>
<li>Nhận phản hồi NextKey</li>
<li>Thực hiện DH (Diffie–Hellman)</li>
<li>Tạo tập thẻ gửi đi mới</li>
<li>Bắt đầu sử dụng các thẻ mới</li>
</ul>
</li>
</ol>
<h3 id="session-tag-ratchet-cơ-chế-ratchet-cho-session-tag">Session Tag Ratchet (Cơ chế ratchet cho Session Tag)</h3>
<p>Cơ chế ratchet (cơ chế bánh cóc) của thẻ phiên tạo ra các thẻ phiên 8 byte chỉ dùng một lần theo cách xác định.</p>
<h3 id="mục-đích-của-session-tag-ratchet-cơ-chế-ratchet-cho-thẻ-phiên">Mục đích của Session Tag Ratchet (cơ chế ratchet cho thẻ phiên)</h3>
<ul>
<li>Thay thế việc truyền thẻ tường minh (ElGamal gửi các thẻ 32 byte)</li>
<li>Cho phép bên nhận tạo trước các thẻ cho cửa sổ nhìn trước</li>
<li>Bên gửi tạo theo nhu cầu (không cần lưu trữ)</li>
<li>Đồng bộ với symmetric key ratchet (cơ chế ratchet khóa đối xứng) thông qua chỉ mục</li>
</ul>
<h3 id="công-thức-ratchet-cơ-chế-bánh-cóc-trong-mật-mã-cho-nhãn-phiên">Công thức ratchet (cơ chế bánh cóc trong mật mã) cho nhãn phiên</h3>
<p><strong>Khởi tạo:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># From DH_INITIALIZE</span>
</span></span><span style="display:flex;"><span>sessTag_ck <span style="color:#f92672">=</span> initial_chain_key  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize session tag ratchet</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(sessTag_ck, ZEROLEN, <span style="color:#e6db74">&#34;STInitialization&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]    <span style="color:#75715e"># First chain key</span>
</span></span><span style="display:flex;"><span>SESSTAG_CONSTANT <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]   <span style="color:#75715e"># Constant for all tags in this tagset</span>
</span></span></code></pre></div><p><strong>Sinh Tag (nhãn) (cho tag N):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate tag N</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(sessTag_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Chain key for next tag</span>
</span></span><span style="display:flex;"><span>tag_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]              <span style="color:#75715e"># Session tag (8 bytes)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Chain continues for each tag</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tag_0, tag_1, tag_2, ..., tag_65535</span>
</span></span></code></pre></div><p><strong>Trình tự đầy đủ:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Tag 0</span>
</span></span><span style="display:flex;"><span>keydata_0 <span style="color:#f92672">=</span> HKDF(sessTag_chainKey, SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>tag_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag 1</span>
</span></span><span style="display:flex;"><span>keydata_1 <span style="color:#f92672">=</span> HKDF(sessTag_chainKey_0, SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>tag_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag N</span>
</span></span><span style="display:flex;"><span>keydata_N <span style="color:#f92672">=</span> HKDF(sessTag_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), SESSTAG_CONSTANT, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>sessTag_chainKey_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>tag_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span></code></pre></div><h3 id="triển-khai-phía-gửi-của-session-tag-ratchet-cơ-chế-ratchet-cho-thẻ-phiên">Triển khai phía gửi của Session Tag Ratchet (cơ chế ratchet cho thẻ phiên)</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundTagset</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, sessTag_ck):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(sessTag_ck, ZEROLEN, <span style="color:#e6db74">&#34;STInitialization&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>constant <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_next_tag</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Increment index</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">65535</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> TagsetExhausted(<span style="color:#e6db74">&#34;Ratchet required&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate tag</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, self<span style="color:#f92672">.</span>constant, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (tag, self<span style="color:#f92672">.</span>index)
</span></span></code></pre></div><p><strong>Quy trình gửi:</strong> 1. Gọi <code>get_next_tag()</code> cho mỗi thông điệp 2. Sử dụng thẻ được trả về trong thông điệp ES 3. Lưu chỉ mục N để có thể theo dõi ACK (xác nhận) 4. Không cần lưu trữ thẻ (được tạo theo yêu cầu)</p>
<h3 id="triển-khai-phía-nhận-của-session-tag-ratchet-cơ-chế-ratchet-cho-thẻ-phiên">Triển khai phía nhận của Session Tag Ratchet (cơ chế ratchet cho thẻ phiên)</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundTagset</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, sessTag_ck, look_ahead<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(sessTag_ck, ZEROLEN, <span style="color:#e6db74">&#34;STInitialization&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>constant <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">=</span> look_ahead
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tags <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Dictionary: tag -&gt; index</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Pre-generate initial tags</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>extend(look_ahead)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extend</span>(self, count):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Generate &#39;count&#39; more tags&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(count):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">65535</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>  <span style="color:#75715e"># Cannot exceed maximum</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Generate tag</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, self<span style="color:#f92672">.</span>constant, <span style="color:#e6db74">&#34;SessionTagKeyGen&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            tag <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Store tag</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>tags[tag] <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>index
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lookup_tag</span>(self, tag):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Look up tag and return index&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> tag <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>tags:
</span></span><span style="display:flex;"><span>            index <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>tags[tag]
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Remove tag (one-time use)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>tags[tag]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> index
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_and_extend</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Extend if tag count is low&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        current_count <span style="color:#f92672">=</span> len(self<span style="color:#f92672">.</span>tags)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> current_count <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Extend to restore window</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>extend(self<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">-</span> current_count)
</span></span></code></pre></div><p><strong>Quy trình phía nhận:</strong> 1. Tạo sẵn tag (thẻ) cho cửa sổ nhìn trước (ví dụ: 32 tag) 2. Lưu các tag trong bảng băm hoặc từ điển 3. Khi thông điệp đến, tra cứu tag để lấy chỉ số N 4. Xóa tag khỏi bộ lưu trữ (dùng một lần) 5. Mở rộng cửa sổ nếu số lượng tag giảm xuống dưới ngưỡng</p>
<h3 id="chiến-lược-nhìn-trước-cho-thẻ-phiên">Chiến lược nhìn trước cho thẻ phiên</h3>
<p><strong>Mục đích</strong>: Cân bằng việc sử dụng bộ nhớ với việc xử lý thông điệp không theo thứ tự</p>
<p><strong>Kích thước Look-Ahead (xem trước) được khuyến nghị:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Tagset Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Initial Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Maximum Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">12</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">12</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Short-lived</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">24</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">160</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial ES tagset</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 1+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">160</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">160</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Ratcheted tagsets</td>
    </tr>
  </tbody>
</table>
**Nhìn trước thích ứng:**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Dynamic look-ahead based on highest tag received</span>
</span></span><span style="display:flex;"><span>look_ahead <span style="color:#f92672">=</span> min(tsmax, tsmin <span style="color:#f92672">+</span> N <span style="color:#f92672">//</span> <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Example:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tsmin = 24, tsmax = 160</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 0:   look_ahead = min(160, 24 + 0/4) = 24</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 100: look_ahead = min(160, 24 + 100/4) = 49</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 500: look_ahead = min(160, 24 + 500/4) = 149</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N = 544: look_ahead = min(160, 24 + 544/4) = 160</span>
</span></span></code></pre></div><p><strong>Cắt bớt phía sau:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Trim tags far behind highest received</span>
</span></span><span style="display:flex;"><span>trim_behind <span style="color:#f92672">=</span> look_ahead <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If highest received tag is N=100, trim tags below N=50</span>
</span></span></code></pre></div><p><strong>Tính toán bộ nhớ:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Per tag: 8 bytes (tag) + 2 bytes (index) + overhead ≈ 16 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Look-ahead of 160 tags ≈ 2.5 KB per inbound tagset</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># With multiple sessions:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 100 inbound sessions × 2.5 KB = 250 KB total</span>
</span></span></code></pre></div><h3 id="xử-lý-session-tag-thẻ-phiên-khi-đến-không-theo-thứ-tự">Xử lý Session Tag (thẻ phiên) khi đến không theo thứ tự</h3>
<p><strong>Kịch bản</strong>: Thông điệp đến không theo đúng thứ tự</p>
<pre tabindex="0"><code>Expected: tag_5, tag_6, tag_7, tag_8
Received: tag_5, tag_7, tag_6, tag_8
</code></pre><p><strong>Hành vi phía nhận:</strong></p>
<ol>
<li>
<p>Nhận tag_5:</p>
<ul>
<li>Tra cứu: tìm thấy tại chỉ mục 5</li>
<li>Xử lý thông điệp</li>
<li>Xóa tag_5</li>
<li>Giá trị nhận cao nhất: 5</li>
</ul>
</li>
<li>
<p>Nhận tag_7 (không theo thứ tự):</p>
<ul>
<li>Tra cứu: tìm thấy tại chỉ mục 7</li>
<li>Xử lý thông điệp</li>
<li>Xóa tag_7</li>
<li>Lớn nhất đã nhận: 7</li>
<li>Lưu ý: tag_6 vẫn còn trong bộ nhớ lưu trữ (chưa nhận)</li>
</ul>
</li>
<li>
<p>Nhận tag_6 (bị trễ):</p>
<ul>
<li>Tra cứu: tìm thấy tại chỉ mục 6</li>
<li>Xử lý thông điệp</li>
<li>Xóa tag_6</li>
<li>Giá trị cao nhất đã nhận: 7 (không thay đổi)</li>
</ul>
</li>
<li>
<p>Nhận tag_8:</p>
<ul>
<li>Tra cứu: tìm thấy tại chỉ mục 8</li>
<li>Xử lý thông điệp</li>
<li>Xóa tag_8</li>
<li>Mức cao nhất đã nhận: 8</li>
</ul>
</li>
</ol>
<p><strong>Bảo trì cửa sổ:</strong> - Theo dõi chỉ số nhận được cao nhất - Duy trì danh sách các chỉ số bị thiếu (khoảng trống) - Mở rộng cửa sổ dựa trên chỉ số cao nhất - Tùy chọn: Cho các khoảng trống cũ hết hạn sau khi quá thời gian chờ</p>
<h3 id="cơ-chế-bánh-cóc-khóa-đối-xứng">Cơ chế bánh cóc khóa đối xứng</h3>
<p>Cơ chế symmetric key ratchet (cơ chế bánh cóc khóa đối xứng) tạo ra các khóa mã hóa 32 byte được đồng bộ với các thẻ phiên.</p>
<h3 id="mục-đích-của-cơ-chế-bánh-cóc-khóa-đối-xứng">Mục đích của cơ chế bánh cóc khóa đối xứng</h3>
<ul>
<li>Cung cấp khóa mã hóa duy nhất cho từng thông điệp</li>
<li>Đồng bộ với session tag ratchet (cơ chế &ldquo;ratchet&rdquo; của thẻ phiên) (cùng chỉ mục)</li>
<li>Bên gửi có thể tạo theo yêu cầu</li>
<li>Bên nhận có thể hoãn việc tạo cho đến khi thẻ được nhận</li>
</ul>
<h3 id="công-thức-ratchet-cơ-chế-bánh-cóc-cho-khóa-đối-xứng">Công thức Ratchet (cơ chế bánh cóc) cho khóa đối xứng</h3>
<p><strong>Khởi tạo:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># From DH_INITIALIZE</span>
</span></span><span style="display:flex;"><span>symmKey_ck <span style="color:#f92672">=</span> initial_chain_key  <span style="color:#75715e"># 32 bytes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># No additional initialization needed</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Unlike session tag ratchet, no constant is derived</span>
</span></span></code></pre></div><p><strong>Sinh khóa (cho khóa N):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Generate key N</span>
</span></span><span style="display:flex;"><span>SYMMKEY_CONSTANT <span style="color:#f92672">=</span> ZEROLEN  <span style="color:#75715e"># Empty string</span>
</span></span><span style="display:flex;"><span>keydata <span style="color:#f92672">=</span> HKDF(symmKey_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), SYMMKEY_CONSTANT, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Chain key for next key</span>
</span></span><span style="display:flex;"><span>key_N <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]              <span style="color:#75715e"># Session key (32 bytes)</span>
</span></span></code></pre></div><p><strong>Trình tự hoàn chỉnh:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Key 0</span>
</span></span><span style="display:flex;"><span>keydata_0 <span style="color:#f92672">=</span> HKDF(symmKey_ck, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>key_0 <span style="color:#f92672">=</span> keydata_0[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Key 1</span>
</span></span><span style="display:flex;"><span>keydata_1 <span style="color:#f92672">=</span> HKDF(symmKey_chainKey_0, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>key_1 <span style="color:#f92672">=</span> keydata_1[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Key N</span>
</span></span><span style="display:flex;"><span>keydata_N <span style="color:#f92672">=</span> HKDF(symmKey_chainKey_(N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>symmKey_chainKey_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>key_N <span style="color:#f92672">=</span> keydata_N[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span></code></pre></div><h3 id="hiện-thực-phía-gửi-của-symmetric-key-ratchet-cơ-chế-bánh-cóc-dùng-khóa-đối-xứng">Hiện thực phía gửi của Symmetric Key Ratchet (cơ chế bánh cóc dùng khóa đối xứng)</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Generate key for specific index&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Fast-forward to desired index if needed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&lt;</span> index:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">==</span> index:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Should not reach here if called correctly</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Key already generated&#34;</span>)
</span></span></code></pre></div><p><strong>Quy trình phía người gửi:</strong> 1. Lấy tag (thẻ) tiếp theo và chỉ số của nó N 2. Tạo khóa cho chỉ số N 3. Dùng khóa để mã hóa thông điệp 4. Không cần lưu trữ khóa</p>
<h3 id="triển-khai-phía-nhận-symmetric-key-ratchet-cơ-chế-bánh-cóc-cho-khóa-đối-xứng">Triển khai phía nhận Symmetric Key Ratchet (cơ chế bánh cóc cho khóa đối xứng)</h3>
<p><strong>Chiến lược 1: Deferred Generation (sinh trì hoãn) (Khuyến nghị)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cache <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Optional: cache recently used keys</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Generate key for specific index&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check cache first (optional optimization)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>cache:
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cache[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>cache[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> key
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Fast-forward to desired index</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&lt;</span> index:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">==</span> index:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Index already passed&#34;</span>)
</span></span></code></pre></div><p><strong>Quy trình tạo trì hoãn:</strong> 1. Nhận ES message có tag 2. Tra cứu tag để lấy chỉ số N 3. Sinh các khóa từ 0 đến N (nếu chưa được sinh) 4. Dùng khóa N để giải mã thông điệp 5. Chain key (khóa chuỗi) hiện ở vị trí chỉ số N</p>
<p><strong>Ưu điểm:</strong> - Mức sử dụng bộ nhớ tối thiểu - Khóa chỉ được tạo khi cần - Triển khai đơn giản</p>
<p><strong>Nhược điểm:</strong> - Phải tạo tất cả các khóa từ 0 đến N khi sử dụng lần đầu - Không thể xử lý các thông điệp đến không theo thứ tự nếu không có bộ nhớ đệm</p>
<p><strong>Chiến lược 2: Tạo trước với Tag Window (cửa sổ thẻ) (Phương án thay thế)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>keys <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Dictionary: index -&gt; key</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extend</span>(self, count):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Pre-generate &#39;count&#39; more keys&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(count):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>keys[self<span style="color:#f92672">.</span>index] <span style="color:#f92672">=</span> key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Retrieve pre-generated key&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>keys:
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>keys[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>keys[index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> key
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><p><strong>Quy trình tạo trước:</strong> 1. Tạo trước các khóa khớp với tag window (cửa sổ thẻ) (ví dụ, 32 khóa) 2. Lưu các khóa được lập chỉ mục theo số thứ tự thông điệp 3. Khi nhận thẻ, tra cứu khóa tương ứng 4. Mở rộng cửa sổ khi các thẻ được sử dụng</p>
<p><strong>Ưu điểm:</strong> - Xử lý các thông điệp không theo thứ tự một cách tự nhiên - Truy xuất khóa nhanh (không có độ trễ tạo)</p>
<p><strong>Nhược điểm:</strong> - Mức sử dụng bộ nhớ cao hơn (32 byte mỗi key (khóa) so với 8 byte mỗi tag (thẻ)) - Phải giữ các key (khóa) đồng bộ với các tag (thẻ)</p>
<p><strong>So sánh bộ nhớ:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Look-ahead of 160:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags only:  160 × 16 bytes = 2.5 KB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags+Keys:  160 × (16 + 32) bytes = 7.5 KB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For 100 sessions:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags only:  250 KB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tags+Keys:  750 KB</span>
</span></span></code></pre></div><h3 id="đồng-bộ-hóa-ratchet-đối-xứng-với-session-tags-thẻ-phiên">Đồng bộ hóa ratchet đối xứng với Session Tags (thẻ phiên)</h3>
<p><strong>Yêu cầu quan trọng</strong>: Chỉ mục Session tag (thẻ phiên) PHẢI bằng chỉ mục khóa đối xứng</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Sender</span>
</span></span><span style="display:flex;"><span>tag, index <span style="color:#f92672">=</span> outbound_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> outbound_keyratchet<span style="color:#f92672">.</span>get_key(index)  <span style="color:#75715e"># Same index</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, payload, tag)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> inbound_tagset<span style="color:#f92672">.</span>lookup_tag(tag)
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> inbound_keyratchet<span style="color:#f92672">.</span>get_key(index)  <span style="color:#75715e"># Same index</span>
</span></span><span style="display:flex;"><span>nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>plaintext <span style="color:#f92672">=</span> DECRYPT(key, nonce, ciphertext, tag)
</span></span></code></pre></div><p><strong>Các chế độ hỏng hóc:</strong></p>
<p>Nếu việc đồng bộ hóa bị gián đoạn: - Dùng sai khóa để giải mã - Việc xác minh MAC (mã xác thực thông điệp) thất bại - Thông điệp bị từ chối</p>
<p><strong>Phòng ngừa:</strong> - Luôn dùng cùng một chỉ mục cho thẻ và khóa - Không bao giờ bỏ qua các chỉ mục trong bất kỳ ratchet (cơ chế cập nhật khóa dần) nào - Xử lý cẩn thận các thông điệp không theo thứ tự</p>
<h3 id="thiết-kế-nonce-số-dùng-một-lần-cho-symmetric-ratchet-ratchet-đối-xứng">Thiết kế Nonce (số dùng một lần) cho Symmetric Ratchet (ratchet đối xứng)</h3>
<p>Nonce (giá trị chỉ dùng một lần) được suy ra từ số thứ tự thông điệp:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">construct_nonce</span>(index):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Construct 12-byte nonce for ChaCha20-Poly1305
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        index: Message number (0-65535)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        nonce: 12-byte nonce
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># First 4 bytes are always zero</span>
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> bytearray(<span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>    nonce[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00\x00\x00\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Last 8 bytes are little-endian message number</span>
</span></span><span style="display:flex;"><span>    nonce[<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> index<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">8</span>, byteorder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> bytes(nonce)
</span></span></code></pre></div><p><strong>Ví dụ:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>:     nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> <span style="color:#ae81ff">0000000000000000</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>:     nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> <span style="color:#ae81ff">0100000000000000</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>:   nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> FF00000000000000
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span>:   nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> <span style="color:#ae81ff">0001000000000000</span>
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">=</span> <span style="color:#ae81ff">65535</span>: nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span> FFFF000000000000
</span></span></code></pre></div><p><strong>Các thuộc tính quan trọng:</strong> - Nonce (giá trị số dùng một lần) là duy nhất cho mỗi thông điệp trong một bộ thẻ - Nonce không bao giờ lặp lại (các thẻ dùng một lần đảm bảo điều này) - Bộ đếm 8 byte cho phép 2^64 thông điệp (chúng tôi chỉ dùng 2^16) - Định dạng nonce khớp với phương pháp xây dựng dựa trên bộ đếm của RFC 7539</p>
<hr>
<h2 id="quản-lý-phiên">Quản lý phiên</h2>
<h3 id="ngữ-cảnh-phiên">Ngữ cảnh phiên</h3>
<p>Tất cả các phiên vào và ra phải thuộc về một ngữ cảnh cụ thể:</p>
<ol>
<li><strong>Ngữ cảnh Router</strong>: Các phiên dành cho chính router</li>
<li><strong>Ngữ cảnh Destination</strong> (đích I2P): Các phiên dành cho một destination cục bộ cụ thể (ứng dụng khách)</li>
</ol>
<p><strong>Quy tắc quan trọng</strong>: Tuyệt đối không được chia sẻ phiên giữa các ngữ cảnh để ngăn chặn các cuộc tấn công tương quan.</p>
<p><strong>Triển khai:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SessionKeyManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Context for managing sessions (router or destination)&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, context_id):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>context_id <span style="color:#f92672">=</span> context_id
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions <span style="color:#f92672">=</span> {}   <span style="color:#75715e"># far_end_dest -&gt; [sessions]</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_sessions <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># far_end_dest -&gt; session</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>static_keypair <span style="color:#f92672">=</span> generate_keypair()  <span style="color:#75715e"># Context&#39;s identity</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_outbound_session</span>(self, destination):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get or create outbound session to destination&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> destination <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>outbound_sessions:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>outbound_sessions[destination] <span style="color:#f92672">=</span> create_outbound_session(destination)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>outbound_sessions[destination]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_inbound_session</span>(self, session, destination<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Add inbound session, optionally bound to destination&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> destination:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> destination <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>inbound_sessions:
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>inbound_sessions[destination] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>inbound_sessions[destination]<span style="color:#f92672">.</span>append(session)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Unbound session</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>inbound_sessions[<span style="color:#66d9ef">None</span>]<span style="color:#f92672">.</span>append(session)
</span></span></code></pre></div><p><strong>Triển khai I2P bằng Java:</strong></p>
<p>Trong Java I2P, lớp <code>SessionKeyManager</code> cung cấp các chức năng sau: - Một <code>SessionKeyManager</code> cho mỗi router - Một <code>SessionKeyManager</code> cho mỗi đích cục bộ - Quản lý tách biệt các phiên ECIES và ElGamal trong từng ngữ cảnh</p>
<h3 id="ràng-buộc-phiên">Ràng buộc phiên</h3>
<p><strong>Binding</strong> (ràng buộc) thiết lập mối liên hệ giữa một phiên và một đích đầu xa cụ thể.</p>
<h3 id="các-phiên-ràng-buộc">Các phiên ràng buộc</h3>
<p><strong>Đặc điểm:</strong> - Bao gồm khóa tĩnh của người gửi trong NS message (thông điệp NS) - Người nhận có thể nhận diện destination (đích) của người gửi - Cho phép giao tiếp hai chiều - Một phiên đi cho mỗi destination - Có thể có nhiều phiên đến (trong quá trình chuyển đổi)</p>
<p><strong>Trường hợp sử dụng:</strong> - Kết nối dạng streaming (tương tự TCP) - Các datagram (gói tin) có thể phản hồi - Bất kỳ giao thức nào đòi hỏi mô hình yêu cầu/đáp ứng</p>
<p><strong>Quy trình liên kết:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Alice creates bound outbound session</span>
</span></span><span style="display:flex;"><span>outbound_session <span style="color:#f92672">=</span> OutboundSession(
</span></span><span style="display:flex;"><span>    destination<span style="color:#f92672">=</span>bob_destination,
</span></span><span style="display:flex;"><span>    static_key<span style="color:#f92672">=</span>alice_static_key,
</span></span><span style="display:flex;"><span>    bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Alice sends NS with static key</span>
</span></span><span style="display:flex;"><span>ns_message <span style="color:#f92672">=</span> build_ns_message(
</span></span><span style="display:flex;"><span>    ephemeral_key<span style="color:#f92672">=</span>alice_ephemeral_key,
</span></span><span style="display:flex;"><span>    static_key<span style="color:#f92672">=</span>alice_static_key,  <span style="color:#75715e"># Included for binding</span>
</span></span><span style="display:flex;"><span>    payload<span style="color:#f92672">=</span>data
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob receives NS</span>
</span></span><span style="display:flex;"><span>bob_receives_ns(ns_message)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob extracts Alice&#39;s static key</span>
</span></span><span style="display:flex;"><span>alice_static_key <span style="color:#f92672">=</span> decrypt_static_key_section(ns_message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob looks up Alice&#39;s destination (from bundled LeaseSet)</span>
</span></span><span style="display:flex;"><span>alice_destination <span style="color:#f92672">=</span> lookup_destination_by_static_key(alice_static_key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob creates bound inbound session</span>
</span></span><span style="display:flex;"><span>inbound_session <span style="color:#f92672">=</span> InboundSession(
</span></span><span style="display:flex;"><span>    destination<span style="color:#f92672">=</span>alice_destination,
</span></span><span style="display:flex;"><span>    bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bob pairs with outbound session</span>
</span></span><span style="display:flex;"><span>outbound_session <span style="color:#f92672">=</span> OutboundSession(
</span></span><span style="display:flex;"><span>    destination<span style="color:#f92672">=</span>alice_destination,
</span></span><span style="display:flex;"><span>    bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>Lợi ích:</strong> 1. <strong>Ephemeral-Ephemeral DH (cả hai bên dùng khóa Diffie-Hellman tạm thời)</strong>: Phản hồi sử dụng ee DH (bảo mật chuyển tiếp đầy đủ) 2. <strong>Tính liên tục của phiên</strong>: Ratchets (cơ chế cập nhật khóa một chiều) duy trì ràng buộc tới cùng một đích 3. <strong>Bảo mật</strong>: Ngăn chiếm quyền phiên (xác thực bằng khóa tĩnh) 4. <strong>Hiệu quả</strong>: Một phiên cho mỗi đích (không trùng lặp)</p>
<h3 id="các-phiên-chưa-ràng-buộc">Các phiên chưa ràng buộc</h3>
<p><strong>Đặc điểm:</strong> - Không có khóa tĩnh trong NS message (phần cờ (flags) đều là số 0) - Người nhận không thể xác định người gửi - Chỉ liên lạc một chiều - Cho phép nhiều phiên đến cùng một đích</p>
<p><strong>Các trường hợp sử dụng:</strong> - Gói datagram thô (gửi rồi quên) - Xuất bản ẩn danh - Nhắn tin kiểu phát quảng bá</p>
<p><strong>Đặc tính:</strong> - Ẩn danh hơn (không thể xác định người gửi) - Hiệu quả hơn (1 DH (Diffie-Hellman - trao đổi khóa) so với 2 DH trong handshake (quy trình bắt tay)) - Không thể trả lời (người nhận không biết trả lời tới đâu) - Không có session ratcheting (cơ chế tăng dần khóa phiên; dùng một lần hoặc giới hạn)</p>
<h3 id="ghép-cặp-phiên">Ghép cặp phiên</h3>
<p><strong>Ghép cặp</strong> kết nối một phiên đến với một phiên đi để giao tiếp hai chiều.</p>
<h3 id="tạo-phiên-ghép-cặp">Tạo phiên ghép cặp</h3>
<p><strong>Góc nhìn của Alice (bên khởi tạo):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Create outbound session to Bob</span>
</span></span><span style="display:flex;"><span>outbound_session <span style="color:#f92672">=</span> create_outbound_session(bob_destination)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create paired inbound session</span>
</span></span><span style="display:flex;"><span>inbound_session <span style="color:#f92672">=</span> create_inbound_session(
</span></span><span style="display:flex;"><span>    paired_with<span style="color:#f92672">=</span>outbound_session,
</span></span><span style="display:flex;"><span>    bound_to<span style="color:#f92672">=</span>bob_destination
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Link them</span>
</span></span><span style="display:flex;"><span>outbound_session<span style="color:#f92672">.</span>paired_inbound <span style="color:#f92672">=</span> inbound_session
</span></span><span style="display:flex;"><span>inbound_session<span style="color:#f92672">.</span>paired_outbound <span style="color:#f92672">=</span> outbound_session
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send NS message</span>
</span></span><span style="display:flex;"><span>send_ns_message(outbound_session, payload)
</span></span></code></pre></div><p><strong>Góc nhìn của Bob (responder - bên phản hồi):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Receive NS message</span>
</span></span><span style="display:flex;"><span>ns_message <span style="color:#f92672">=</span> receive_ns_message()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create inbound session</span>
</span></span><span style="display:flex;"><span>inbound_session <span style="color:#f92672">=</span> create_inbound_session_from_ns(ns_message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If NS contains static key (bound):</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ns_message<span style="color:#f92672">.</span>has_static_key():
</span></span><span style="display:flex;"><span>    alice_destination <span style="color:#f92672">=</span> extract_destination(ns_message)
</span></span><span style="display:flex;"><span>    inbound_session<span style="color:#f92672">.</span>bind_to(alice_destination)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create paired outbound session</span>
</span></span><span style="display:flex;"><span>    outbound_session <span style="color:#f92672">=</span> create_outbound_session(alice_destination)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Link them</span>
</span></span><span style="display:flex;"><span>    outbound_session<span style="color:#f92672">.</span>paired_inbound <span style="color:#f92672">=</span> inbound_session
</span></span><span style="display:flex;"><span>    inbound_session<span style="color:#f92672">.</span>paired_outbound <span style="color:#f92672">=</span> outbound_session
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send NSR</span>
</span></span><span style="display:flex;"><span>send_nsr_message(inbound_session, outbound_session, payload)
</span></span></code></pre></div><h3 id="lợi-ích-của-việc-ghép-cặp-phiên">Lợi ích của việc ghép cặp phiên</h3>
<ol>
<li><strong>ACKs trong băng</strong> (ACK = acknowledgement - xác nhận): Có thể xác nhận thông điệp mà không cần clove riêng biệt (clove: “nhánh” trong garlic message)</li>
<li><strong>Ratcheting hiệu quả</strong> (cơ chế “bánh cóc” mật mã): Cả hai hướng ratchet đồng bộ</li>
<li><strong>Điều khiển luồng</strong>: Có thể triển khai back-pressure (cơ chế áp lực ngược) trên các phiên ghép cặp</li>
<li><strong>Tính nhất quán trạng thái</strong>: Dễ dàng duy trì trạng thái đồng bộ</li>
</ol>
<h3 id="các-quy-tắc-ghép-cặp-phiên">Các quy tắc ghép cặp phiên</h3>
<ul>
<li>Phiên đi ra có thể không được ghép cặp (NS chưa ràng buộc)</li>
<li>Phiên đi vào đối với NS đã ràng buộc nên được ghép cặp</li>
<li>Việc ghép cặp diễn ra khi tạo phiên, không phải sau đó</li>
<li>Các phiên đã ghép cặp có cùng ràng buộc đích</li>
<li>Các cơ chế ratchet (cơ chế then cài mật mã) diễn ra độc lập nhưng được điều phối</li>
</ul>
<h3 id="vòng-đời-phiên">Vòng đời phiên</h3>
<h3 id="vòng-đời-phiên-giai-đoạn-khởi-tạo">Vòng đời phiên: Giai đoạn khởi tạo</h3>
<p><strong>Khởi tạo phiên gửi đi (Alice):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_outbound_session</span>(destination, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> OutboundSession()
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> destination
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> bound
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>NEW
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate keys for NS message</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> bound:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>static_key <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Will be populated after NSR received</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> session
</span></span></code></pre></div><p><strong>Khởi tạo phiên đến (Bob):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_inbound_session_from_ns</span>(ns_message):
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> InboundSession()
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract from NS</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>remote_ephemeral_key <span style="color:#f92672">=</span> ns_message<span style="color:#f92672">.</span>ephemeral_key
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>remote_static_key <span style="color:#f92672">=</span> ns_message<span style="color:#f92672">.</span>static_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>remote_static_key:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> lookup_destination(session<span style="color:#f92672">.</span>remote_static_key)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate keys for NSR</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create tagsets from KDF</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> create_tagset_from_nsr()
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> create_tagset_from_nsr()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> session
</span></span></code></pre></div><h3 id="vòng-đời-phiên-giai-đoạn-hoạt-động">Vòng đời phiên: Giai đoạn hoạt động</h3>
<p><strong>Các chuyển trạng thái:</strong></p>
<pre tabindex="0"><code>NEW (outbound only)
  ↓
  NS sent
  ↓
PENDING_REPLY (outbound only)
  ↓
  NSR received
  ↓
ESTABLISHED
  ↓
  ES messages exchanged
  ↓
ESTABLISHED (ongoing)
  ↓
  (optional) RATCHETING
  ↓
ESTABLISHED
</code></pre><p><strong>Duy trì phiên hoạt động:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">maintain_active_session</span>(session):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Update last activity time</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for ratchet needed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>needs_ratchet():
</span></span><span style="display:flex;"><span>        initiate_ratchet(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for incoming ratchet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> received_nextkey_block():
</span></span><span style="display:flex;"><span>        process_ratchet(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Trim old tags from inbound tagset</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>expire_old_tags()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check session health</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time() <span style="color:#f92672">&gt;</span> SESSION_TIMEOUT:
</span></span><span style="display:flex;"><span>        mark_session_idle(session)
</span></span></code></pre></div><h3 id="vòng-đời-phiên-giai-đoạn-hết-hạn">Vòng đời phiên: Giai đoạn hết hạn</h3>
<p><strong>Các giá trị thời gian chờ của phiên:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Session Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Sender Timeout</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Receiver Timeout</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Short-lived</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">8 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">10 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ES tagset 1+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">8 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">10 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Ratcheted</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Old tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3 minutes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">After ratchet</td>
    </tr>
  </tbody>
</table>
**Cơ chế hết hạn:**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_session_expiration</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> active_sessions:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Outbound session expiration (sender)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>is_outbound():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:  <span style="color:#75715e"># 8 minutes</span>
</span></span><span style="display:flex;"><span>                expire_outbound_session(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Inbound session expiration (receiver)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:  <span style="color:#75715e"># 10 minutes</span>
</span></span><span style="display:flex;"><span>                expire_inbound_session(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Old tagsets (after ratchet)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tagset <span style="color:#f92672">in</span> old_tagsets:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> tagset<span style="color:#f92672">.</span>age() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:  <span style="color:#75715e"># 3 minutes</span>
</span></span><span style="display:flex;"><span>            delete_tagset(tagset)
</span></span></code></pre></div><p><strong>Quy tắc trọng yếu</strong>: Các phiên ra PHẢI hết hạn trước các phiên vào để tránh mất đồng bộ.</p>
<p><strong>Kết thúc an toàn:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">terminate_session</span>(session, reason<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send Termination block (if implemented)</span>
</span></span><span style="display:flex;"><span>    send_termination_block(session, reason)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Mark session for deletion</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>TERMINATED
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Keep session briefly for final messages</span>
</span></span><span style="display:flex;"><span>    schedule_deletion(session, delay<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>)  <span style="color:#75715e"># 30 seconds</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Notify paired session</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>paired_session:
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>paired_session<span style="color:#f92672">.</span>mark_remote_terminated()
</span></span></code></pre></div><h3 id="nhiều-thông-điệp-ns">Nhiều thông điệp NS</h3>
<p><strong>Kịch bản</strong>: Thông điệp NS của Alice bị mất hoặc phản hồi NSR bị mất.</p>
<p><strong>Hành vi của Alice:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_messages_sent <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_ns_attempts <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_ns_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate new ephemeral key for each NS</span>
</span></span><span style="display:flex;"><span>        ephemeral_key <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        ns_message <span style="color:#f92672">=</span> build_ns_message(
</span></span><span style="display:flex;"><span>            ephemeral_key<span style="color:#f92672">=</span>ephemeral_key,
</span></span><span style="display:flex;"><span>            static_key<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>static_key,
</span></span><span style="display:flex;"><span>            payload<span style="color:#f92672">=</span>payload
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Store state for this NS</span>
</span></span><span style="display:flex;"><span>        ns_state <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;ephemeral_key&#39;</span>: ephemeral_key,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;chainkey&#39;</span>: compute_chainkey(ns_message),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;hash&#39;</span>: compute_hash(ns_message),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;tagset&#39;</span>: derive_nsr_tagset(ns_message),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;sent_time&#39;</span>: now()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_messages_sent<span style="color:#f92672">.</span>append(ns_state)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send message</span>
</span></span><span style="display:flex;"><span>        send_message(ns_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Set timer for retry</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>ns_timer:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> set_timer(<span style="color:#ae81ff">1.0</span>, self<span style="color:#f92672">.</span>on_ns_timeout)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_ns_timeout</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(self<span style="color:#f92672">.</span>ns_messages_sent) <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_ns_attempts:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Give up</span>
</span></span><span style="display:flex;"><span>            fail_session(<span style="color:#e6db74">&#34;No NSR received after </span><span style="color:#e6db74">{self.max_ns_attempts}</span><span style="color:#e6db74"> attempts&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Retry with new NS message</span>
</span></span><span style="display:flex;"><span>        send_ns_message(self<span style="color:#f92672">.</span>payload)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_nsr_received</span>(self, nsr_message):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Cancel timer</span>
</span></span><span style="display:flex;"><span>        cancel_timer(self<span style="color:#f92672">.</span>ns_timer)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Find which NS this NSR responds to</span>
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> nsr_message<span style="color:#f92672">.</span>tag
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> ns_state <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>ns_messages_sent:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tag <span style="color:#f92672">in</span> ns_state[<span style="color:#e6db74">&#39;tagset&#39;</span>]:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># This NSR corresponds to this NS</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>active_ns_state <span style="color:#f92672">=</span> ns_state
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process NSR and complete handshake</span>
</span></span><span style="display:flex;"><span>        complete_handshake(nsr_message, self<span style="color:#f92672">.</span>active_ns_state)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Discard other NS states</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_messages_sent <span style="color:#f92672">=</span> []
</span></span></code></pre></div><p><strong>Các thuộc tính quan trọng:</strong></p>
<ol>
<li><strong>Khóa tạm thời riêng biệt</strong>: Mỗi NS sử dụng một khóa tạm thời khác nhau</li>
<li><strong>Bắt tay độc lập</strong>: Mỗi NS tạo trạng thái bắt tay riêng biệt</li>
<li><strong>Tương quan NSR</strong>: Thẻ NSR xác định NS mà nó phản hồi</li>
<li><strong>Dọn dẹp trạng thái</strong>: Các trạng thái NS không dùng sẽ bị loại bỏ sau khi NSR thành công</li>
</ol>
<p><strong>Phòng ngừa tấn công:</strong></p>
<p>Để ngăn ngừa cạn kiệt tài nguyên:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Limit NS sending rate</span>
</span></span><span style="display:flex;"><span>max_ns_rate <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> per <span style="color:#ae81ff">10</span> seconds per destination
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Limit total NS attempts</span>
</span></span><span style="display:flex;"><span>max_ns_attempts <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Limit total pending NS states</span>
</span></span><span style="display:flex;"><span>max_pending_ns <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> per context
</span></span></code></pre></div><h3 id="nhiều-thông-điệp-nsr">Nhiều thông điệp NSR</h3>
<p><strong>Kịch bản</strong>: Bob gửi nhiều NSR (ví dụ: dữ liệu phản hồi được chia nhỏ thành nhiều thông điệp).</p>
<p><strong>Hành vi của Bob:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_nsr_replies</span>(self, payload_chunks):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># One NS received, multiple NSRs to send</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> chunk <span style="color:#f92672">in</span> payload_chunks:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Generate new ephemeral key for each NSR</span>
</span></span><span style="display:flex;"><span>            ephemeral_key <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Get next tag from NSR tagset</span>
</span></span><span style="display:flex;"><span>            tag <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>nsr_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            nsr_message <span style="color:#f92672">=</span> build_nsr_message(
</span></span><span style="display:flex;"><span>                tag<span style="color:#f92672">=</span>tag,
</span></span><span style="display:flex;"><span>                ephemeral_key<span style="color:#f92672">=</span>ephemeral_key,
</span></span><span style="display:flex;"><span>                payload<span style="color:#f92672">=</span>chunk
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            send_message(nsr_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Wait for ES message from Alice</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>AWAITING_ES
</span></span></code></pre></div><p><strong>Hành vi của Alice:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_nsr_received</span>(self, nsr_message):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>PENDING_REPLY:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># First NSR received</span>
</span></span><span style="display:flex;"><span>            complete_handshake(nsr_message)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Create ES sessions</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>es_outbound_tagset <span style="color:#f92672">=</span> derive_es_outbound_tagset()
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>es_inbound_tagset <span style="color:#f92672">=</span> derive_es_inbound_tagset()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Send ES message (ACK)</span>
</span></span><span style="display:flex;"><span>            send_es_message(empty_payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Additional NSR received</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Decrypt and process payload</span>
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> decrypt_nsr_payload(nsr_message)
</span></span><span style="display:flex;"><span>            process_payload(payload)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># These NSRs are from other NS attempts, ignore handshake</span>
</span></span></code></pre></div><p><strong>Dọn dẹp của Bob:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_es_received</span>(self, es_message):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># First ES received from Alice</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># This confirms which NSR Alice used</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Clean up other handshake states</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> other_ns_state <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>pending_ns_states:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> other_ns_state <span style="color:#f92672">!=</span> self<span style="color:#f92672">.</span>active_ns_state:
</span></span><span style="display:flex;"><span>                delete_ns_state(other_ns_state)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Delete unused NSR tagsets</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> tagset <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>nsr_tagsets:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tagset <span style="color:#f92672">!=</span> self<span style="color:#f92672">.</span>active_nsr_tagset:
</span></span><span style="display:flex;"><span>                delete_tagset(tagset)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span></code></pre></div><p><strong>Các thuộc tính quan trọng:</strong></p>
<ol>
<li><strong>Cho phép nhiều NSR</strong>: Bob có thể gửi nhiều NSR cho mỗi NS</li>
<li><strong>Khóa tạm thời khác nhau</strong>: Mỗi NSR nên sử dụng một khóa tạm thời duy nhất</li>
<li><strong>Cùng một tagset cho NSR</strong>: Tất cả các NSR cho một NS sử dụng cùng một tagset (tập thẻ)</li>
<li><strong>ES đầu tiên sẽ thắng</strong>: ES đầu tiên của Alice quyết định NSR nào thành công</li>
<li><strong>Dọn dẹp sau ES</strong>: Bob loại bỏ các trạng thái chưa dùng sau khi nhận ES</li>
</ol>
<h3 id="máy-trạng-thái-phiên">Máy trạng thái phiên</h3>
<p><strong>Sơ đồ trạng thái đầy đủ:</strong></p>
<pre tabindex="0"><code>                    Outbound Session                    Inbound Session

                         NEW
                          |
                     send NS
                          |
                   PENDING_REPLY -------------------- receive NS ---&gt; ESTABLISHED
                          |                                                |
                   receive NSR                                        send NSR
                          |                                                |
                    ESTABLISHED &lt;---------- receive ES ------------- AWAITING_ES
                          |                     |                          |
                    ┌─────┴─────┐               |                    receive ES
                    |           |               |                          |
              send ES      receive ES           |                    ESTABLISHED
                    |           |               |                          |
                    └─────┬─────┘               |                ┌─────────┴─────────┐
                          |                     |                |                   |
                          |                     |          send ES              receive ES
                          |                     |                |                   |
                          |                     |                └─────────┬─────────┘
                          |                     |                          |
                          └─────────────────────┴──────────────────────────┘
                                              ACTIVE
                                                |
                                         idle timeout
                                                |
                                             EXPIRED
</code></pre><p><strong>Mô tả trạng thái:</strong></p>
<ul>
<li><strong>NEW</strong>: Phiên gửi đi đã được tạo, chưa gửi NS</li>
<li><strong>PENDING_REPLY</strong>: Đã gửi NS, đang chờ NSR</li>
<li><strong>AWAITING_ES</strong>: Đã gửi NSR, đang chờ ES đầu tiên từ Alice</li>
<li><strong>ESTABLISHED</strong>: Bắt tay đã hoàn tất, có thể gửi/nhận ES</li>
<li><strong>ACTIVE</strong>: Đang tích cực trao đổi các thông điệp ES</li>
<li><strong>RATCHETING</strong>: DH ratchet (cơ chế bánh cóc Diffie-Hellman) đang diễn ra (trạng thái con của ACTIVE)</li>
<li><strong>EXPIRED</strong>: Phiên đã hết hạn, đang chờ xóa</li>
<li><strong>TERMINATED</strong>: Phiên đã bị kết thúc tường minh</li>
</ul>
<hr>
<h2 id="định-dạng-dữ-liệu-tải">Định dạng dữ liệu tải</h2>
<p>Phần tải của tất cả các thông điệp ECIES (lược đồ mã hóa tích hợp trên đường cong elliptic) (NS, NSR, ES) sử dụng một định dạng dựa trên khối tương tự NTCP2.</p>
<h3 id="cấu-trúc-khối">Cấu trúc khối</h3>
<p><strong>Định dạng chung:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|blk |  size   |       data             |
+----+----+----+                        +
|                                       |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
|blk |  size   |       data             |
+----+----+----+                        +
|                                       |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Các trường:</strong></p>
<ul>
<li><code>blk</code>: 1 byte - Số kiểu khối</li>
<li><code>size</code>: 2 byte - Kích thước big-endian (thứ tự byte lớn trước) của trường dữ liệu (0-65516)</li>
<li><code>data</code>: Độ dài thay đổi - Dữ liệu dành riêng cho khối</li>
</ul>
<p><strong>Các ràng buộc:</strong></p>
<ul>
<li>Khung ChaChaPoly tối đa: 65535 byte</li>
<li>MAC Poly1305: 16 byte</li>
<li>Tổng số khối tối đa: 65519 byte (65535 - 16)</li>
<li>Khối đơn tối đa: 65519 byte (bao gồm phần đầu 3 byte)</li>
<li>Dữ liệu khối đơn tối đa: 65516 byte</li>
</ul>
<h3 id="các-loại-khối">Các loại khối</h3>
<p><strong>Các loại khối được định nghĩa:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Name</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Size</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Status</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Usage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DateTime</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">7 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Required in NS</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1-3</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future use</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Termination</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">9+ bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Unimplemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session termination</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">5</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Options</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">21+ bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Unimplemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session options</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">6</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">MessageNumbers</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">5 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Unimplemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">PN value</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">7</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NextKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">3 or 35 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DH ratchet</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">8</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ACK</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">4+ bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Message acknowledgment</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">9</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ACK Request</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">3 bytes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Request ACK</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">10</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future use</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">11</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Garlic Clove</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Variable</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Application data</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">12-223</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future use</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">224-253</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Experimental</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Variable</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Testing features</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">254</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Padding</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Variable</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implemented</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Traffic shaping</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">255</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">-</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Future extension</td>
    </tr>
  </tbody>
</table>
**Xử lý khối không xác định:**
<p>Các triển khai PHẢI bỏ qua các khối có mã kiểu không xác định và coi chúng như phần đệm. Điều này đảm bảo khả năng tương thích tiến.</p>
<h3 id="quy-tắc-sắp-xếp-các-khối">Quy tắc sắp xếp các khối</h3>
<h3 id="thứ-tự-thông-điệp-ns">Thứ tự thông điệp NS</h3>
<p><strong>Bắt buộc:</strong> - Khối DateTime PHẢI đứng đầu tiên</p>
<p><strong>Được phép:</strong> - Garlic Clove (tiểu thông điệp trong garlic encryption) (type 11) - Tùy chọn (type 5) - nếu được triển khai - Đệm (type 254)</p>
<p><strong>Bị cấm:</strong> - NextKey, ACK, ACK Request, Termination, MessageNumbers</p>
<p><strong>Ví dụ về payload NS hợp lệ:</strong></p>
<pre tabindex="0"><code>DateTime (0) | Garlic Clove (11) | Garlic Clove (11) | Padding (254)
</code></pre><h3 id="thứ-tự-thông-điệp-nsr-viết-tắt-không-dịch">Thứ tự thông điệp NSR (viết tắt, không dịch)</h3>
<p><strong>Bắt buộc:</strong> - Không có (payload (dữ liệu tải) có thể rỗng)</p>
<p><strong>Được phép:</strong> - Garlic Clove (đơn vị thông điệp con trong garlic encryption) (loại 11) - Tùy chọn (loại 5) - nếu được triển khai - Đệm (loại 254)</p>
<p><strong>Không được phép:</strong> - DateTime, NextKey, ACK, ACK Request, Termination, MessageNumbers</p>
<p><strong>Ví dụ về payload (nội dung dữ liệu) NSR hợp lệ:</strong></p>
<pre tabindex="0"><code>Garlic Clove (11) | Garlic Clove (11) | Padding (254)
</code></pre><p>hoặc</p>
<pre tabindex="0"><code>(empty - ACK only)
</code></pre><h3 id="thứ-tự-thông-điệp-es">Thứ tự thông điệp ES</h3>
<p><strong>Bắt buộc:</strong> - Không có (payload có thể để trống)</p>
<p><strong>Được phép (theo bất kỳ thứ tự nào):</strong> - Garlic Clove (type 11) - NextKey (type 7) - ACK (type 8) - ACK Request (type 9) - Termination (type 4) - nếu được triển khai - MessageNumbers (type 6) - nếu được triển khai - Options (type 5) - nếu được triển khai - Padding (type 254)</p>
<p><strong>Quy tắc đặc biệt:</strong> - Termination PHẢI là khối cuối cùng (trừ Padding) - Padding PHẢI là khối cuối cùng - Cho phép nhiều Garlic Cloves - Cho phép tối đa 2 khối NextKey (xuôi và ngược) - KHÔNG cho phép nhiều khối Padding</p>
<p><strong>Ví dụ các payload ES hợp lệ:</strong></p>
<pre tabindex="0"><code>Garlic Clove (11) | ACK (8) | Padding (254)
</code></pre><pre tabindex="0"><code>NextKey (7) | Garlic Clove (11) | Garlic Clove (11)
</code></pre><pre tabindex="0"><code>NextKey (7) forward | NextKey (7) reverse | Garlic Clove (11)
</code></pre><pre tabindex="0"><code>ACK Request (9) | Garlic Clove (11) | Termination (4) | Padding (254)
</code></pre><h3 id="datetime-block-khối-ngày-giờ-loại-0">DateTime Block (khối ngày giờ) (Loại 0)</h3>
<p><strong>Mục đích</strong>: Dấu thời gian để ngăn chặn phát lại và xác thực độ lệch đồng hồ</p>
<p><strong>Kích thước</strong>: 7 byte (tiêu đề 3 byte + dữ liệu 4 byte)</p>
<p><strong>Định dạng:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+
| 0  |    4    |     timestamp     |
+----+----+----+----+----+----+----+
</code></pre><p><strong>Các trường:</strong></p>
<ul>
<li><code>blk</code>: 0</li>
<li><code>size</code>: 4 (big-endian - byte có trọng số lớn nhất trước)</li>
<li><code>timestamp</code>: 4 byte - dấu thời gian Unix tính bằng giây (không dấu, big-endian)</li>
</ul>
<p><strong>Định dạng dấu thời gian:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>timestamp <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())  <span style="color:#75715e"># Seconds since 1970-01-01 00:00:00 UTC</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wraps around in year 2106 (4-byte unsigned maximum)</span>
</span></span></code></pre></div><p><strong>Quy tắc kiểm tra hợp lệ:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>MAX_CLOCK_SKEW_PAST <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>      <span style="color:#75715e"># 5 minutes</span>
</span></span><span style="display:flex;"><span>MAX_CLOCK_SKEW_FUTURE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>    <span style="color:#75715e"># 2 minutes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_datetime</span>(timestamp):
</span></span><span style="display:flex;"><span>    now <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span>    age <span style="color:#f92672">=</span> now <span style="color:#f92672">-</span> timestamp
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span>MAX_CLOCK_SKEW_FUTURE:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Too far in future</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&gt;</span> MAX_CLOCK_SKEW_PAST:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Too old</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><p><strong>Ngăn chặn phát lại:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReplayFilter</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, duration<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>duration <span style="color:#f92672">=</span> duration  <span style="color:#75715e"># 5 minutes</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>seen_messages <span style="color:#f92672">=</span> BloomFilter(size<span style="color:#f92672">=</span><span style="color:#ae81ff">100000</span>, false_positive_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cleanup_timer <span style="color:#f92672">=</span> RepeatTimer(<span style="color:#ae81ff">60</span>, self<span style="color:#f92672">.</span>cleanup)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_replay</span>(self, ephemeral_key, timestamp):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check timestamp validity</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> validate_datetime(timestamp):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if ephemeral key seen recently</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ephemeral_key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>seen_messages:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Replay attack</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add to seen messages</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>seen_messages<span style="color:#f92672">.</span>add(ephemeral_key)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cleanup</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire old entries (Bloom filter automatically ages out)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p><strong>Ghi chú triển khai:</strong></p>
<ol>
<li><strong>NS Messages</strong>: DateTime PHẢI là khối đầu tiên</li>
<li><strong>NSR/ES Messages</strong>: Thông thường không bao gồm DateTime</li>
<li><strong>Cửa sổ phát lại</strong>: 5 phút là mức tối thiểu được khuyến nghị</li>
<li><strong>Bộ lọc Bloom</strong>: Được khuyến nghị để phát hiện phát lại hiệu quả</li>
<li><strong>Độ lệch đồng hồ</strong>: Cho phép muộn 5 phút, sớm 2 phút</li>
</ol>
<h3 id="garlic-clove-block-khối-nhánh-tỏi-type-11">Garlic Clove Block (khối nhánh tỏi) (Type 11)</h3>
<p><strong>Mục đích</strong>: Đóng gói các thông điệp I2NP để chuyển giao</p>
<p><strong>Định dạng:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 11 |  size   |                        |
+----+----+----+                        +
|      Delivery Instructions            |
~                                       ~
|                                       |
+----+----+----+----+----+----+----+----+
|type|  Message_ID       | Expiration  |
+----+----+----+----+----+----+----+----+
     |      I2NP Message body           |
+----+                                  +
~                                       ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Các trường:</strong></p>
<ul>
<li><code>blk</code>: 11</li>
<li><code>size</code>: Tổng kích thước của clove (nhánh trong thông điệp garlic) (biến đổi)</li>
<li><code>Delivery Instructions</code>: Như được quy định trong đặc tả I2NP</li>
<li><code>type</code>: Kiểu thông điệp I2NP (1 byte)</li>
<li><code>Message_ID</code>: ID thông điệp I2NP (4 byte)</li>
<li><code>Expiration</code>: Dấu thời gian Unix tính bằng giây (4 byte)</li>
<li><code>I2NP Message body</code>: Dữ liệu thông điệp có độ dài biến đổi</li>
</ul>
<p><strong>Định dạng hướng dẫn chuyển phát:</strong></p>
<p><strong>Phân phối cục bộ</strong> (1 byte):</p>
<pre tabindex="0"><code>+----+
|0x00|
+----+
</code></pre><p><strong>Giao tới Destination (đích)</strong> (33 byte):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|0x01|                                  |
+----+        Destination Hash         +
|              32 bytes                 |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Router Delivery</strong> (33 byte):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|0x02|                                  |
+----+         Router Hash              +
|              32 bytes                 |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Chuyển giao qua Tunnel</strong> (37 bytes):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|0x03|         Tunnel ID                |
+----+----+----+----+----+              +
|           Router Hash                 |
+              32 bytes                 +
|                                       |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Tiêu đề thông điệp I2NP</strong> (tổng cộng 9 byte):</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|type|      msg_id       |  expiration   |
+----+----+----+----+----+----+----+----+
     |                                   |
</code></pre><ul>
<li><code>type</code>: loại thông điệp I2NP (Database Store, Database Lookup, Data, v.v.)</li>
<li><code>msg_id</code>: định danh thông điệp 4 byte</li>
<li><code>expiration</code>: dấu thời gian Unix 4 byte (giây)</li>
</ul>
<p><strong>Những khác biệt quan trọng so với Định dạng Clove ElGamal (Clove: nhánh trong garlic encryption):</strong></p>
<ol>
<li><strong>Không có Chứng chỉ</strong>: Trường Chứng chỉ bị lược bỏ (không dùng trong ElGamal)</li>
<li><strong>Không có Clove ID</strong>: Clove ID bị lược bỏ (Clove: tiểu thông điệp trong garlic encryption; vốn luôn là 0)</li>
<li><strong>Không có thời điểm hết hạn của Clove</strong>: Thay vào đó dùng thời điểm hết hạn của thông điệp I2NP</li>
<li><strong>Header gọn</strong>: Header I2NP 9-byte so với định dạng ElGamal lớn hơn</li>
<li><strong>Mỗi Clove là một khối riêng biệt</strong>: Không có cấu trúc CloveSet (tập hợp các Clove)</li>
</ol>
<p><strong>Nhiều Clove (thành phần con của thông điệp trong garlic encryption):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Multiple Garlic Cloves in one message</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    build_datetime_block(),
</span></span><span style="display:flex;"><span>    build_garlic_clove(i2np_message_1),
</span></span><span style="display:flex;"><span>    build_garlic_clove(i2np_message_2),
</span></span><span style="display:flex;"><span>    build_garlic_clove(i2np_message_3),
</span></span><span style="display:flex;"><span>    build_padding_block()
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>Các kiểu thông điệp I2NP phổ biến trong Cloves (tép tỏi):</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Name</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Usage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DatabaseStore</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Publishing LeaseSet</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DatabaseLookup</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Requesting LeaseSet</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">5</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DeliveryStatus</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ACK (legacy, avoid in ECIES)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">20</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Streaming data</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">21</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Garlic</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Nested garlic messages</td>
    </tr>
  </tbody>
</table>
**Xử lý Clove (thông điệp con trong 'garlic' message):**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_garlic_clove</span>(clove_data):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Parse delivery instructions</span>
</span></span><span style="display:flex;"><span>    delivery_type <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x00</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Local delivery</span>
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x01</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Destination delivery</span>
</span></span><span style="display:flex;"><span>        dest_hash <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">33</span>]
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x02</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Router delivery</span>
</span></span><span style="display:flex;"><span>        router_hash <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">33</span>]
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> delivery_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x03</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Tunnel delivery</span>
</span></span><span style="display:flex;"><span>        tunnel_id <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;I&#39;</span>, clove_data[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">5</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        router_hash <span style="color:#f92672">=</span> clove_data[<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">37</span>]
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">37</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Parse I2NP header</span>
</span></span><span style="display:flex;"><span>    i2np_type <span style="color:#f92672">=</span> clove_data[offset]
</span></span><span style="display:flex;"><span>    msg_id <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;I&#39;</span>, clove_data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">5</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    expiration <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;I&#39;</span>, clove_data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">5</span>:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract I2NP body</span>
</span></span><span style="display:flex;"><span>    i2np_body <span style="color:#f92672">=</span> clove_data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span>:]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Process message</span>
</span></span><span style="display:flex;"><span>    process_i2np_message(i2np_type, msg_id, expiration, i2np_body)
</span></span></code></pre></div><h3 id="khối-nextkey-khóa-kế-tiếp-loại-7">Khối NextKey (khóa kế tiếp) (Loại 7)</h3>
<p><strong>Mục đích</strong>: trao đổi khóa DH ratchet (cơ chế bánh cóc)</p>
<p><strong>Định dạng (Có khóa - 38 byte):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 7  |   35    |flag|  key ID |         |
+----+----+----+----+----+----+         +
|                                       |
+     Next DH Ratchet Public Key        +
|              32 bytes                 |
+                                       +
|                                       |
+                             +----+----+
|                             |
+----+----+----+----+----+----+
</code></pre><p><strong>Định dạng (Chỉ Key ID - 6 byte):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+
| 7  |    3    |flag|  key ID |
+----+----+----+----+----+----+
</code></pre><p><strong>Các trường:</strong></p>
<ul>
<li><code>blk</code>: 7</li>
<li><code>size</code>: 3 (chỉ ID) hoặc 35 (kèm khóa)</li>
<li><code>flag</code>: 1 byte - các bit cờ</li>
<li><code>key ID</code>: 2 byte - định danh khóa theo Big-endian (thứ tự byte có trọng số lớn trước) (0-32767)</li>
<li><code>Public Key</code>: 32 byte - khóa công khai X25519 (little-endian - thứ tự byte có trọng số nhỏ trước), nếu bit cờ 0 = 1</li>
</ul>
<p><strong>Các bit cờ:</strong></p>
<pre tabindex="0"><code>Bit 7 6 5 4 3 2 1 0
    | | | | | | | |
    | | | | | | | +-- Bit 0: Key present (1) or ID only (0)
    | | | | | | +---- Bit 1: Reverse key (1) or forward key (0)
    | | | | | +------ Bit 2: Request reverse key (1) or no request (0)
    | | | | |
    +-+-+-+-+-------- Bits 3-7: Reserved (set to 0)
</code></pre><p><strong>Ví dụ về cờ:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Forward key present</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x01</span>  <span style="color:#75715e"># Binary: 00000001</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Reverse key present</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x03</span>  <span style="color:#75715e"># Binary: 00000011</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Forward key ID only (ACK)</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00</span>  <span style="color:#75715e"># Binary: 00000000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Reverse key ID only (ACK)</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x02</span>  <span style="color:#75715e"># Binary: 00000010</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Forward key ID with reverse request</span>
</span></span><span style="display:flex;"><span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x04</span>  <span style="color:#75715e"># Binary: 00000100</span>
</span></span></code></pre></div><p><strong>Quy tắc ID khóa:</strong></p>
<ul>
<li>Các ID tăng dần liên tiếp: 0, 1, 2, &hellip;, 32767</li>
<li>ID chỉ tăng khi tạo khóa mới</li>
<li>Cùng một ID được dùng cho nhiều thông điệp cho đến lần ratchet (cơ chế xoay vòng khóa) tiếp theo</li>
<li>ID tối đa là 32767 (sau đó phải bắt đầu phiên mới)</li>
</ul>
<p><strong>Ví dụ sử dụng:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Initiating ratchet (sender generates new key)</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>,           <span style="color:#75715e"># Key present, forward</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    public_key<span style="color:#f92672">=</span>sender_new_pk
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Replying to ratchet (receiver generates new key)</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>,           <span style="color:#75715e"># Key present, reverse</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    public_key<span style="color:#f92672">=</span>receiver_new_pk
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Acknowledging ratchet (no new key from sender)</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x02</span>,           <span style="color:#75715e"># ID only, reverse</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Requesting reverse ratchet</span>
</span></span><span style="display:flex;"><span>nextkey <span style="color:#f92672">=</span> NextKeyBlock(
</span></span><span style="display:flex;"><span>    flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x04</span>,           <span style="color:#75715e"># Request reverse, forward ID</span>
</span></span><span style="display:flex;"><span>    key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>Logic xử lý:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_nextkey_block</span>(block):
</span></span><span style="display:flex;"><span>    flags <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>flags
</span></span><span style="display:flex;"><span>    key_id <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>key_id
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    key_present <span style="color:#f92672">=</span> (flags <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x01</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    is_reverse <span style="color:#f92672">=</span> (flags <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x02</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    request_reverse <span style="color:#f92672">=</span> (flags <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x04</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> key_present:
</span></span><span style="display:flex;"><span>        public_key <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_reverse:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Reverse key received</span>
</span></span><span style="display:flex;"><span>            perform_dh_ratchet(receiver_key<span style="color:#f92672">=</span>public_key, key_id<span style="color:#f92672">=</span>key_id)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Sender should ACK with own key ID</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Forward key received</span>
</span></span><span style="display:flex;"><span>            perform_dh_ratchet(sender_key<span style="color:#f92672">=</span>public_key, key_id<span style="color:#f92672">=</span>key_id)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Receiver should reply with reverse key</span>
</span></span><span style="display:flex;"><span>            send_reverse_key(generate_new_key())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Key ID only (ACK)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_reverse:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Reverse key ACK</span>
</span></span><span style="display:flex;"><span>            confirm_reverse_ratchet(key_id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Forward key ACK</span>
</span></span><span style="display:flex;"><span>            confirm_forward_ratchet(key_id)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request_reverse:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Sender requests receiver to generate new key</span>
</span></span><span style="display:flex;"><span>        send_reverse_key(generate_new_key())
</span></span></code></pre></div><p><strong>Nhiều khối NextKey:</strong></p>
<p>Một thông điệp ES có thể chứa tối đa 2 khối NextKey khi cả hai chiều cùng thực hiện ratcheting (cơ chế ratchet tăng bậc khóa) đồng thời:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Both directions ratcheting</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    NextKeyBlock(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, public_key<span style="color:#f92672">=</span>forward_key),  <span style="color:#75715e"># Forward</span>
</span></span><span style="display:flex;"><span>    NextKeyBlock(flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>, key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, public_key<span style="color:#f92672">=</span>reverse_key),  <span style="color:#75715e"># Reverse</span>
</span></span><span style="display:flex;"><span>    build_garlic_clove(data)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><h3 id="khối-ack-loại-8">Khối ACK (Loại 8)</h3>
<p><strong>Mục đích</strong>: Xác nhận các thông điệp đã nhận in-band (trong cùng kênh)</p>
<p><strong>Định dạng (ACK đơn - 7 byte):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+
| 8  |    4    |tagsetid |   N     |
+----+----+----+----+----+----+----+
</code></pre><p><strong>Định dạng (nhiều ACK):</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 8  |  size   |tagsetid |   N     |    |
+----+----+----+----+----+----+----+    +
|            more ACKs                  |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Các trường:</strong></p>
<ul>
<li><code>blk</code>: 8</li>
<li><code>size</code>: 4 * số lượng ACK (gói xác nhận) (tối thiểu 4)</li>
<li>Đối với mỗi ACK:
<ul>
<li><code>tagsetid</code>: 2 byte - ID tập thẻ Big-endian (thứ tự byte lớn trước) (0-65535)</li>
<li><code>N</code>: 2 byte - số thông điệp Big-endian (0-65535)</li>
</ul>
</li>
</ul>
<p><strong>Xác định ID của tập thẻ:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Tag set 0 (initial, after NSR)</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># After first ratchet (tag set 1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Both Alice and Bob sent key ID 0</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># After second ratchet (tag set 2)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Alice sent key ID 1, Bob still using key ID 0</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># After third ratchet (tag set 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Alice still using key ID 1, Bob sent key ID 1</span>
</span></span><span style="display:flex;"><span>tagset_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span></code></pre></div><p><strong>Ví dụ về ACK đơn lẻ:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ACK message from tag set 5, message number 127</span>
</span></span><span style="display:flex;"><span>ack_block <span style="color:#f92672">=</span> ACKBlock(
</span></span><span style="display:flex;"><span>    tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>    message_number<span style="color:#f92672">=</span><span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wire format (7 bytes):</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 08 00 04 00 05 00 7F</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  |  |  |  |</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  |  |  |  +-- N (127)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  |  +--------- N high byte</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  |  +------------ tagset_id (5)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  |  +--------------- tagset_id high byte</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># |  +------------------ size (4)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># +--------------------- type (8)</span>
</span></span></code></pre></div><p><strong>Ví dụ về nhiều ACK (thông điệp xác nhận):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ACK three messages</span>
</span></span><span style="display:flex;"><span>ack_block <span style="color:#f92672">=</span> ACKBlock([
</span></span><span style="display:flex;"><span>    (tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, N<span style="color:#f92672">=</span><span style="color:#ae81ff">42</span>),
</span></span><span style="display:flex;"><span>    (tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, N<span style="color:#f92672">=</span><span style="color:#ae81ff">43</span>),
</span></span><span style="display:flex;"><span>    (tagset_id<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>, N<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wire format (15 bytes):</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 08 00 0C 00 03 00 2A 00 03 00 2B 00 04 00 00</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#                (ts=3, N=42) (ts=3, N=43) (ts=4, N=0)</span>
</span></span></code></pre></div><p><strong>Xử lý:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_ack_block</span>(block):
</span></span><span style="display:flex;"><span>    num_acks <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>size <span style="color:#f92672">//</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_acks):
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> i <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>        tagset_id <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;H&#39;</span>, block<span style="color:#f92672">.</span>data[offset:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        message_num <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;H&#39;</span>, block<span style="color:#f92672">.</span>data[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>:offset<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mark message as acknowledged</span>
</span></span><span style="display:flex;"><span>        mark_acked(tagset_id, message_num)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># May trigger retransmission timeout cancellation</span>
</span></span><span style="display:flex;"><span>        cancel_retransmit_timer(tagset_id, message_num)
</span></span></code></pre></div><p><strong>Khi nào cần gửi ACKs (thông báo xác nhận):</strong></p>
<ol>
<li><strong>Yêu cầu ACK (xác nhận) tường minh</strong>: Luôn phản hồi khối ACK Request</li>
<li><strong>Chuyển giao LeaseSet</strong>: Khi bên gửi bao gồm LeaseSet trong thông điệp</li>
<li><strong>Thiết lập phiên</strong>: Có thể ACK NS/NSR (dù giao thức ưu tiên ACK ngầm qua ES)</li>
<li><strong>Xác nhận Ratchet</strong>: Có thể ACK việc nhận NextKey</li>
<li><strong>Tầng ứng dụng</strong>: Theo yêu cầu của giao thức tầng cao hơn (ví dụ: Streaming)</li>
</ol>
<p><strong>Thời gian ACK (gói xác nhận):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ACKManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pending_acks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ack_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">request_ack</span>(self, tagset_id, message_num):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pending_acks<span style="color:#f92672">.</span>append((tagset_id, message_num))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>ack_timer:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Delay ACK briefly to allow higher layer to respond</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>ack_timer <span style="color:#f92672">=</span> set_timer(<span style="color:#ae81ff">0.1</span>, self<span style="color:#f92672">.</span>send_acks)  <span style="color:#75715e"># 100ms</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_acks</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>pending_acks <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> has_outbound_data():
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># No higher layer data, send explicit ACK</span>
</span></span><span style="display:flex;"><span>            send_es_message(build_ack_block(self<span style="color:#f92672">.</span>pending_acks))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Otherwise, ACK will piggyback on next ES message</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pending_acks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ack_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><h3 id="khối-yêu-cầu-ack-loại-9">Khối yêu cầu ACK (Loại 9)</h3>
<p><strong>Mục đích</strong>: Yêu cầu in-band acknowledgment (xác nhận cùng kênh) cho thông điệp hiện tại</p>
<p><strong>Định dạng:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+
| 9  |    1    |flg |
+----+----+----+----+
</code></pre><p><strong>Các trường:</strong></p>
<ul>
<li><code>blk</code>: 9</li>
<li><code>size</code>: 1</li>
<li><code>flg</code>: 1 byte - Cờ (tất cả các bit hiện không sử dụng, đặt về 0)</li>
</ul>
<p><strong>Cách sử dụng:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Request ACK for this message</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    build_ack_request_block(),
</span></span><span style="display:flex;"><span>    build_garlic_clove(important_data)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>Phản hồi của phía nhận:</strong></p>
<p>Khi nhận được yêu cầu ACK (xác nhận):</p>
<ol>
<li><strong>Có dữ liệu tức thời</strong>: Bao gồm khối ACK trong phản hồi tức thời</li>
<li><strong>Không có dữ liệu tức thời</strong>: Khởi động bộ đếm thời gian (ví dụ, 100ms) và gửi ES rỗng kèm ACK nếu bộ đếm hết hạn</li>
<li><strong>Tag Set ID (mã định danh tập thẻ)</strong>: Sử dụng Tag Set ID của tập thẻ vào hiện tại</li>
<li><strong>Message Number (số hiệu thông điệp)</strong>: Sử dụng Message Number gắn với session tag (thẻ phiên) đã nhận</li>
</ol>
<p><strong>Xử lý:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_ack_request</span>(message):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract message identification</span>
</span></span><span style="display:flex;"><span>    tagset_id <span style="color:#f92672">=</span> message<span style="color:#f92672">.</span>tagset_id
</span></span><span style="display:flex;"><span>    message_num <span style="color:#f92672">=</span> message<span style="color:#f92672">.</span>message_num
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Schedule ACK</span>
</span></span><span style="display:flex;"><span>    schedule_ack(tagset_id, message_num)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># If no data to send immediately, start timer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> has_pending_data():
</span></span><span style="display:flex;"><span>        set_timer(<span style="color:#ae81ff">0.1</span>, <span style="color:#66d9ef">lambda</span>: send_ack_only(tagset_id, message_num))
</span></span></code></pre></div><p><strong>Khi nào nên sử dụng ACK Request (yêu cầu xác nhận):</strong></p>
<ol>
<li><strong>Thông điệp trọng yếu</strong>: Các thông điệp bắt buộc phải được xác nhận</li>
<li><strong>Chuyển giao LeaseSet</strong>: Khi đóng gói kèm một LeaseSet</li>
<li><strong>Session Ratchet (cơ chế gài răng phiên – thay khóa liên tục)</strong>: Sau khi gửi khối NextKey (khối chứa khóa tiếp theo)</li>
<li><strong>Kết thúc truyền</strong>: Khi bên gửi không còn dữ liệu để gửi nhưng vẫn muốn nhận xác nhận</li>
</ol>
<p><strong>Khi KHÔNG nên sử dụng:</strong></p>
<ol>
<li><strong>Giao thức Streaming</strong>: Lớp streaming xử lý ACK (gói xác nhận)</li>
<li><strong>Thông điệp tần suất cao</strong>: Tránh yêu cầu ACK trên mọi thông điệp (chi phí phụ trội)</li>
<li><strong>Các datagram không quan trọng</strong>: Các datagram thô thường không cần ACK</li>
</ol>
<h3 id="khối-kết-thúc-loại-4">Khối Kết thúc (Loại 4)</h3>
<p><strong>Trạng thái</strong>: Chưa được triển khai</p>
<p><strong>Mục đích</strong>: Kết thúc phiên một cách an toàn</p>
<p><strong>Định dạng:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 4  |  size   | rsn|     addl data     |
+----+----+----+----+                   +
~               ...                     ~
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Các trường:</strong></p>
<ul>
<li><code>blk</code>: 4</li>
<li><code>size</code>: từ 1 byte trở lên</li>
<li><code>rsn</code>: 1 byte - Mã lý do</li>
<li><code>addl data</code>: Dữ liệu bổ sung tùy chọn (định dạng tùy thuộc vào lý do)</li>
</ul>
<p><strong>Mã lý do:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Code</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Meaning</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Additional Data</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">0</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Normal close / unspecified</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Termination received</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Idle timeout</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None (implementation-specific)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Resource exhaustion</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">None (implementation-specific)</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Implementation-specific</td>
    </tr>
  </tbody>
</table>
**Cách sử dụng (khi được triển khai):**
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Normal session close</span>
</span></span><span style="display:flex;"><span>termination <span style="color:#f92672">=</span> TerminationBlock(
</span></span><span style="display:flex;"><span>    reason<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    additional_data<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Session termination due to received termination</span>
</span></span><span style="display:flex;"><span>termination <span style="color:#f92672">=</span> TerminationBlock(
</span></span><span style="display:flex;"><span>    reason<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    additional_data<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>Quy tắc:</strong></p>
<ul>
<li>PHẢI là khối cuối cùng, ngoại trừ Padding (đệm)</li>
<li>Padding PHẢI theo sau Termination (kết thúc) nếu có</li>
<li>Không được phép trong các thông điệp NS hoặc NSR</li>
<li>Chỉ được phép trong các thông điệp ES</li>
</ul>
<h3 id="khối-tùy-chọn-loại-5">Khối tùy chọn (Loại 5)</h3>
<p><strong>Trạng thái</strong>: CHƯA TRIỂN KHAI</p>
<p><strong>Mục đích</strong>: Thương lượng các tham số phiên</p>
<p><strong>Định dạng:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 5  |  size   |ver |flg |STL |STimeout |
+----+----+----+----+----+----+----+----+
|  SOTW   |  RITW   |tmin|tmax|rmin|rmax|
+----+----+----+----+----+----+----+----+
|  tdmy   |  rdmy   |  tdelay |  rdelay |
+----+----+----+----+----+----+----+----+
|              more_options             |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Các trường:</strong></p>
<ul>
<li><code>blk</code>: 5</li>
<li><code>size</code>: 21 byte trở lên</li>
<li><code>ver</code>: 1 byte - Phiên bản giao thức (phải là 0)</li>
<li><code>flg</code>: 1 byte - Cờ (hiện tại tất cả các bit chưa được sử dụng)</li>
<li><code>STL</code>: 1 byte - Độ dài thẻ phiên (phải là 8)</li>
<li><code>STimeout</code>: 2 byte - Thời gian chờ không hoạt động của phiên tính bằng giây (big-endian (thứ tự byte lớn trước))</li>
<li><code>SOTW</code>: 2 byte - Cửa sổ thẻ gửi đi của phía gửi (big-endian)</li>
<li><code>RITW</code>: 2 byte - Cửa sổ thẻ nhận vào của phía nhận (big-endian)</li>
<li><code>tmin</code>, <code>tmax</code>, <code>rmin</code>, <code>rmax</code>: mỗi cái 1 byte - Các tham số đệm (4.4 fixed-point (định dạng số dấu phẩy cố định 4.4))</li>
<li><code>tdmy</code>: 2 byte - Lưu lượng giả tối đa sẵn sàng gửi (byte/giây, big-endian)</li>
<li><code>rdmy</code>: 2 byte - Lưu lượng giả được yêu cầu (byte/giây, big-endian)</li>
<li><code>tdelay</code>: 2 byte - Độ trễ tối đa bên trong thông điệp sẵn sàng chèn (msec, big-endian)</li>
<li><code>rdelay</code>: 2 byte - Độ trễ bên trong thông điệp được yêu cầu (msec, big-endian)</li>
<li><code>more_options</code>: Biến (độ dài thay đổi) - Các phần mở rộng trong tương lai</li>
</ul>
<p><strong>Tham số đệm (dạng dấu phẩy cố định 4.4):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encode_padding_ratio</span>(ratio):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Encode padding ratio as 4.4 fixed-point
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ratio: 0.0 to 15.9375
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    returns: 0x00 to 0xFF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> int(ratio <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decode_padding_ratio</span>(encoded):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Decode 4.4 fixed-point to ratio
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    encoded: 0x00 to 0xFF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    returns: 0.0 to 15.9375
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> encoded <span style="color:#f92672">/</span> <span style="color:#ae81ff">16.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Examples:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x00 = 0.0 (no padding)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x01 = 0.0625 (6.25% padding)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x10 = 1.0 (100% padding - double traffic)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0x80 = 8.0 (800% padding - 9x traffic)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0xFF = 15.9375 (1593.75% padding)</span>
</span></span></code></pre></div><p><strong>Thương lượng Tag Window (cửa sổ thẻ):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># SOTW: Sender&#39;s recommendation for receiver&#39;s inbound window</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RITW: Sender&#39;s declaration of own inbound window</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receiver calculates actual inbound window:</span>
</span></span><span style="display:flex;"><span>inbound_window <span style="color:#f92672">=</span> calculate_window(
</span></span><span style="display:flex;"><span>    sender_suggestion<span style="color:#f92672">=</span>SOTW,
</span></span><span style="display:flex;"><span>    own_constraints<span style="color:#f92672">=</span>MAX_INBOUND_TAGS,
</span></span><span style="display:flex;"><span>    own_resources<span style="color:#f92672">=</span>available_memory()
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sender uses:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - RITW to know how far ahead receiver will accept</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Own SOTW to hint optimal window size</span>
</span></span></code></pre></div><p><strong>Giá trị mặc định (khi các tùy chọn không được đàm phán):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>DEFAULT_OPTIONS <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;version&#39;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;session_tag_length&#39;</span>: <span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">600</span>,  <span style="color:#75715e"># 10 minutes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;sender_outbound_tag_window&#39;</span>: <span style="color:#ae81ff">160</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;receiver_inbound_tag_window&#39;</span>: <span style="color:#ae81ff">160</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tmin&#39;</span>: <span style="color:#ae81ff">0x00</span>,  <span style="color:#75715e"># No minimum padding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tmax&#39;</span>: <span style="color:#ae81ff">0x10</span>,  <span style="color:#75715e"># Up to 100% padding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rmin&#39;</span>: <span style="color:#ae81ff">0x00</span>,  <span style="color:#75715e"># No minimum requested</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rmax&#39;</span>: <span style="color:#ae81ff">0x10</span>,  <span style="color:#75715e"># Up to 100% requested</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tdmy&#39;</span>: <span style="color:#ae81ff">0</span>,     <span style="color:#75715e"># No dummy traffic</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rdmy&#39;</span>: <span style="color:#ae81ff">0</span>,     <span style="color:#75715e"># No dummy traffic requested</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;tdelay&#39;</span>: <span style="color:#ae81ff">0</span>,   <span style="color:#75715e"># No delay</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;rdelay&#39;</span>: <span style="color:#ae81ff">0</span>    <span style="color:#75715e"># No delay requested</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="khối-messagenumbers-loại-6">Khối MessageNumbers (Loại 6)</h3>
<p><strong>Trạng thái</strong>: CHƯA TRIỂN KHAI</p>
<p><strong>Mục đích</strong>: Chỉ ra tin nhắn cuối cùng được gửi trong tập thẻ trước đó (cho phép phát hiện khoảng trống)</p>
<p><strong>Định dạng:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+
| 6  |    2    |  PN    |
+----+----+----+----+----+
</code></pre><p><strong>Các trường:</strong></p>
<ul>
<li><code>blk</code>: 6</li>
<li><code>size</code>: 2</li>
<li><code>PN</code>: 2 byte - Số thứ tự thông điệp cuối cùng của tập thẻ trước (big-endian (thứ tự byte lớn trước), 0-65535)</li>
</ul>
<p><strong>Định nghĩa PN (Previous Number):</strong></p>
<p>PN là chỉ số của thẻ cuối cùng đã được gửi trong tập thẻ trước đó.</p>
<p><strong>Cách sử dụng (khi được triển khai):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># After ratcheting to new tag set</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Old tag set: sent messages 0-4095</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># New tag set: sending first message</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    MessageNumbersBlock(PN<span style="color:#f92672">=</span><span style="color:#ae81ff">4095</span>),
</span></span><span style="display:flex;"><span>    build_garlic_clove(data)
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>Lợi ích cho bên nhận:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_message_numbers</span>(pn_value):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Receiver can now:</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1. Determine if any messages were skipped</span>
</span></span><span style="display:flex;"><span>    highest_received_in_old_tagset <span style="color:#f92672">=</span> <span style="color:#ae81ff">4090</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> pn_value <span style="color:#f92672">&gt;</span> highest_received_in_old_tagset:
</span></span><span style="display:flex;"><span>        missing_count <span style="color:#f92672">=</span> pn_value <span style="color:#f92672">-</span> highest_received_in_old_tagset
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 5 messages were never received</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 2. Delete tags higher than PN from old tagset</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tag_index <span style="color:#f92672">in</span> range(pn_value <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, MAX_TAG_INDEX):
</span></span><span style="display:flex;"><span>        delete_tag(old_tagset, tag_index)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 3. Expire tags ≤ PN after grace period (e.g., 2 minutes)</span>
</span></span><span style="display:flex;"><span>    schedule_deletion(old_tagset, delay<span style="color:#f92672">=</span><span style="color:#ae81ff">120</span>)
</span></span></code></pre></div><p><strong>Quy tắc:</strong></p>
<ul>
<li>KHÔNG ĐƯỢC gửi trong tag set (nhóm thẻ) 0 (không có tag set trước đó)</li>
<li>Chỉ được gửi trong ES messages (thông điệp ES)</li>
<li>Chỉ được gửi trong những thông điệp đầu tiên của tag set mới</li>
<li>Giá trị PN là từ góc nhìn của người gửi (tag (thẻ) cuối cùng mà người gửi đã gửi)</li>
</ul>
<p><strong>Mối quan hệ với Signal:</strong></p>
<p>Trong Signal Double Ratchet (giao thức Double Ratchet của Signal), PN nằm trong phần đầu của thông điệp. Trong ECIES (lược đồ mã hóa tích hợp trên đường cong elliptic), PN nằm trong payload đã mã hóa và là tùy chọn.</p>
<h3 id="khối-đệm-loại-254">Khối đệm (Loại 254)</h3>
<p><strong>Mục đích</strong>: Khả năng chống phân tích lưu lượng và che giấu kích thước thông điệp</p>
<p><strong>Định dạng:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|254 |  size   |      padding           |
+----+----+----+                        +
|                                       |
~               ...                     ~
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Các trường:</strong></p>
<ul>
<li><code>blk</code>: 254</li>
<li><code>size</code>: 0-65516 byte (big-endian: thứ tự byte lớn trước)</li>
<li><code>padding</code>: Dữ liệu ngẫu nhiên hoặc bằng 0</li>
</ul>
<p><strong>Quy tắc:</strong></p>
<ul>
<li>PHẢI là khối cuối cùng trong thông điệp</li>
<li>KHÔNG được phép có nhiều khối Padding (đệm)</li>
<li>Có thể có độ dài bằng 0 (chỉ có phần đầu 3 byte)</li>
<li>Dữ liệu Padding có thể là các số 0 hoặc các byte ngẫu nhiên</li>
</ul>
<p><strong>Đệm mặc định:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>DEFAULT_PADDING_MIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>DEFAULT_PADDING_MAX <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_default_padding</span>():
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(DEFAULT_PADDING_MIN, DEFAULT_PADDING_MAX)
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>bytes(size)  <span style="color:#75715e"># or zeros</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> PaddingBlock(size, data)
</span></span></code></pre></div><p><strong>Chiến lược chống phân tích lưu lượng:</strong></p>
<p><strong>Chiến lược 1: Kích thước ngẫu nhiên (Mặc định)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Add 0-15 bytes random padding to each message</span>
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">15</span>)
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>Chiến lược 2: Làm tròn đến bội số</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Round total message size to next multiple of 64</span>
</span></span><span style="display:flex;"><span>target_size <span style="color:#f92672">=</span> ((message_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">63</span>) <span style="color:#f92672">//</span> <span style="color:#ae81ff">64</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> target_size <span style="color:#f92672">-</span> message_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>  <span style="color:#75715e"># -3 for block header</span>
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>Chiến lược 3: Kích thước thông điệp cố định</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Always send 1KB messages</span>
</span></span><span style="display:flex;"><span>TARGET_MESSAGE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> TARGET_MESSAGE_SIZE <span style="color:#f92672">-</span> message_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>Chiến lược 4: Đệm được đàm phán (khối Options)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Calculate padding based on negotiated parameters</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tmin, tmax from Options block</span>
</span></span><span style="display:flex;"><span>min_padding <span style="color:#f92672">=</span> int(payload_size <span style="color:#f92672">*</span> tmin_ratio)
</span></span><span style="display:flex;"><span>max_padding <span style="color:#f92672">=</span> int(payload_size <span style="color:#f92672">*</span> tmax_ratio)
</span></span><span style="display:flex;"><span>padding_size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(min_padding, max_padding)
</span></span><span style="display:flex;"><span>padding_block <span style="color:#f92672">=</span> PaddingBlock(padding_size, random<span style="color:#f92672">.</span>bytes(padding_size))
</span></span></code></pre></div><p><strong>Padding-Only Messages (các thông điệp chỉ chứa đệm):</strong></p>
<p>Thông điệp có thể chỉ gồm phần đệm (không có dữ liệu ứng dụng):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Dummy traffic message</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    PaddingBlock(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">500</span>), random<span style="color:#f92672">.</span>bytes(<span style="color:#f92672">...</span>))
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>Ghi chú triển khai:</strong></p>
<ol>
<li><strong>Đệm toàn số 0</strong>: Chấp nhận được (sẽ được ChaCha20 mã hóa)</li>
<li><strong>Đệm ngẫu nhiên</strong>: Không cung cấp thêm bảo mật sau khi đã mã hóa nhưng tiêu tốn nhiều entropy (độ ngẫu nhiên) hơn</li>
<li><strong>Hiệu năng</strong>: Việc tạo đệm ngẫu nhiên có thể tốn kém; cân nhắc dùng đệm toàn số 0</li>
<li><strong>Bộ nhớ</strong>: Khối đệm lớn tiêu tốn băng thông; hãy thận trọng với kích thước tối đa</li>
</ol>
<hr>
<h2 id="hướng-dẫn-triển-khai">Hướng dẫn triển khai</h2>
<h3 id="điều-kiện-tiên-quyết">Điều kiện tiên quyết</h3>
<p><strong>Thư viện mật mã:</strong></p>
<ul>
<li><strong>X25519</strong>: libsodium, NaCl, hoặc Bouncy Castle</li>
<li><strong>ChaCha20-Poly1305</strong>: libsodium, OpenSSL 1.1.0+, hoặc Bouncy Castle</li>
<li><strong>SHA-256</strong>: OpenSSL, Bouncy Castle, hoặc hỗ trợ tích hợp sẵn trong ngôn ngữ</li>
<li><strong>Elligator2</strong>: Hỗ trợ thư viện hạn chế; có thể cần triển khai tùy chỉnh</li>
</ul>
<p><strong>Triển khai Elligator2 (kỹ thuật che giấu điểm trên đường cong elliptic):</strong></p>
<p>Elligator2 (kỹ thuật ánh xạ điểm trên đường cong elliptic thành chuỗi trông ngẫu nhiên) không được triển khai rộng rãi. Các lựa chọn:</p>
<ol>
<li><strong>OBFS4</strong>: pluggable transport (cơ chế vận chuyển cắm thêm) obfs4 của Tor bao gồm triển khai Elligator2 (kỹ thuật ánh xạ trên đường cong elliptic để ngụy trang khóa công khai)</li>
<li><strong>Triển khai tùy chỉnh</strong>: Dựa trên <a href="https://elligator.cr.yp.to/elligator-20130828.pdf">bài báo Elligator2</a>
</li>
<li><strong>kleshni/Elligator</strong>: Triển khai tham chiếu trên GitHub</li>
</ol>
<p><strong>Ghi chú Java I2P:</strong> Java I2P sử dụng thư viện net.i2p.crypto.eddsa với các phần bổ sung Elligator2 (kỹ thuật ánh xạ điểm trên đường cong elliptic trông ngẫu nhiên) tùy chỉnh.</p>
<h3 id="thứ-tự-triển-khai-được-khuyến-nghị">Thứ tự triển khai được khuyến nghị</h3>
<p><strong>Giai đoạn 1: Mật mã cốt lõi</strong> 1. Tạo và trao đổi khóa X25519 DH (Diffie–Hellman) 2. Mã hóa/giải mã ChaCha20-Poly1305 AEAD (mã hóa xác thực kèm dữ liệu bổ sung) 3. Băm SHA-256 và MixHash (hàm băm trộn) 4. Dẫn xuất khóa với HKDF (hàm dẫn xuất khóa) 5. Mã hóa/giải mã Elligator2 (kỹ thuật ánh xạ ngụy trang) (có thể dùng test vectors (bộ dữ liệu kiểm thử) ban đầu)</p>
<p><strong>Giai đoạn 2: Định dạng thông điệp</strong> 1. Thông điệp NS (không ràng buộc) - định dạng đơn giản nhất 2. Thông điệp NS (ràng buộc) - bổ sung khóa tĩnh 3. Thông điệp NSR 4. Thông điệp ES 5. Phân tích cú pháp khối và tạo khối</p>
<p><strong>Giai đoạn 3: Quản lý phiên</strong> 1. Tạo và lưu trữ phiên 2. Quản lý tập thẻ (người gửi và người nhận) 3. Ratchet (cơ chế bánh cóc) thẻ phiên 4. Ratchet khóa đối xứng 5. Tra cứu thẻ và quản lý cửa sổ</p>
<p><strong>Giai đoạn 4: DH Ratcheting (cơ chế bánh cóc Diffie–Hellman)</strong> 1. Xử lý khối NextKey 2. KDF (hàm dẫn xuất khóa) cho DH ratchet 3. Tạo tag set (tập thẻ) sau khi ratchet 4. Quản lý nhiều tag set</p>
<p><strong>Giai đoạn 5: Logic giao thức</strong> 1. Máy trạng thái NS/NSR/ES 2. Ngăn phát lại (DateTime, bộ lọc Bloom) 3. Logic truyền lại (nhiều NS/NSR) 4. Xử lý ACK</p>
<p><strong>Giai đoạn 6: Tích hợp</strong> 1. Xử lý I2NP Garlic Clove (tép trong thông điệp garlic của I2NP) 2. Đính kèm LeaseSet 3. Tích hợp giao thức truyền luồng 4. Tích hợp giao thức datagram</p>
<h3 id="triển-khai-phía-gửi">Triển khai phía gửi</h3>
<p><strong>Vòng đời của phiên gửi đi:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OutboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, destination, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> destination
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> bound
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>NEW
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Keys for NS message</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> bound:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>static_key <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>static_keypair
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Will be populated after NSR</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_keyratchet <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_keyratchet <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Timing</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Retransmission</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_attempts <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_initial_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Send NS message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build NS message</span>
</span></span><span style="display:flex;"><span>        ns_message <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>build_ns_message(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send</span>
</span></span><span style="display:flex;"><span>        send_to_network(self<span style="color:#f92672">.</span>destination, ns_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Track for retransmission</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_attempts<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;message&#39;</span>: ns_message,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;time&#39;</span>: now(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;ephemeral_key&#39;</span>: self<span style="color:#f92672">.</span>ephemeral_keypair,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;kdf_state&#39;</span>: self<span style="color:#f92672">.</span>save_kdf_state()
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Start timer</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timer <span style="color:#f92672">=</span> set_timer(<span style="color:#ae81ff">1.0</span>, self<span style="color:#f92672">.</span>on_ns_timeout)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>PENDING_REPLY
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_ns_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Construct NS message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># KDF initialization</span>
</span></span><span style="display:flex;"><span>        chainKey, h <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>initialize_kdf()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Ephemeral key section</span>
</span></span><span style="display:flex;"><span>        elg2_ephemeral <span style="color:#f92672">=</span> ENCODE_ELG2(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> self<span style="color:#f92672">.</span>destination<span style="color:#f92672">.</span>static_key)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># es DH</span>
</span></span><span style="display:flex;"><span>        es_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                       self<span style="color:#f92672">.</span>destination<span style="color:#f92672">.</span>static_key)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, es_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_static <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt static key section</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>bound:
</span></span><span style="display:flex;"><span>            static_section <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>static_key<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            static_section <span style="color:#f92672">=</span> bytes(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        static_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_static, <span style="color:#ae81ff">0</span>, static_section, h)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> static_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ss DH (if bound)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>bound:
</span></span><span style="display:flex;"><span>            ss_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>static_key<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                          self<span style="color:#f92672">.</span>destination<span style="color:#f92672">.</span>static_key)
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(chainKey, ss_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> k_static
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build payload blocks</span>
</span></span><span style="display:flex;"><span>        payload_data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>build_ns_payload(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt payload</span>
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_payload, nonce, payload_data, h)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> payload_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Save KDF state for NSR processing</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_chainkey <span style="color:#f92672">=</span> chainKey
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_hash <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Assemble message</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> elg2_ephemeral <span style="color:#f92672">+</span> static_ciphertext <span style="color:#f92672">+</span> payload_ciphertext
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_ns_payload</span>(self, application_data):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Build NS payload blocks&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        blocks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># DateTime block (required, first)</span>
</span></span><span style="display:flex;"><span>        blocks<span style="color:#f92672">.</span>append(build_datetime_block())
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Garlic Clove(s) with application data</span>
</span></span><span style="display:flex;"><span>        blocks<span style="color:#f92672">.</span>append(build_garlic_clove(application_data))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Optionally bundle LeaseSet</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> should_send_leaseset():
</span></span><span style="display:flex;"><span>            blocks<span style="color:#f92672">.</span>append(build_garlic_clove(build_leaseset_store()))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Padding</span>
</span></span><span style="display:flex;"><span>        blocks<span style="color:#f92672">.</span>append(build_padding_block(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">15</span>)))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> encode_blocks(blocks)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_nsr_received</span>(self, nsr_message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Process NSR and establish ES session&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Cancel retransmission timer</span>
</span></span><span style="display:flex;"><span>        cancel_timer(self<span style="color:#f92672">.</span>ns_timer)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Parse NSR</span>
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>        elg2_bob_ephemeral <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">40</span>]
</span></span><span style="display:flex;"><span>        key_section_mac <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">40</span>:<span style="color:#ae81ff">56</span>]
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> nsr_message[<span style="color:#ae81ff">56</span>:]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Find corresponding NS attempt</span>
</span></span><span style="display:flex;"><span>        ns_state <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>find_ns_by_tag(tag)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> ns_state:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;NSR tag doesn&#39;t match any NS&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Restore KDF state</span>
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> ns_state[<span style="color:#e6db74">&#39;chainkey&#39;</span>]
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> ns_state[<span style="color:#e6db74">&#39;hash&#39;</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decode Bob&#39;s ephemeral key</span>
</span></span><span style="display:flex;"><span>        bob_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(elg2_bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix tag and Bob&#39;s ephemeral into hash</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> tag)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ee DH</span>
</span></span><span style="display:flex;"><span>        ee_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>private_key, bob_ephemeral)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ee_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># se DH</span>
</span></span><span style="display:flex;"><span>        se_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>static_key<span style="color:#f92672">.</span>private_key, bob_ephemeral)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, se_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_key_section <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify key section MAC</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            DECRYPT(k_key_section, <span style="color:#ae81ff">0</span>, key_section_mac, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;NSR key section MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> key_section_mac)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Split for bidirectional ES</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        k_ab <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Alice → Bob</span>
</span></span><span style="display:flex;"><span>        k_ba <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Bob → Alice</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize ES tagsets</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ab)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ba)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt NSR payload</span>
</span></span><span style="display:flex;"><span>        k_nsr <span style="color:#f92672">=</span> HKDF(k_ba, ZEROLEN, <span style="color:#e6db74">&#34;AttachPayloadKDF&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> DECRYPT(k_nsr, <span style="color:#ae81ff">0</span>, payload_ciphertext, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;NSR payload MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process NSR payload blocks</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>process_payload_blocks(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Session established</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send ES message (implicit ACK)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>send_es_ack()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_es_message</span>(self, payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Send ES message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">!=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Session not established&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get next tag and key</span>
</span></span><span style="display:flex;"><span>        tag, index <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>outbound_keyratchet<span style="color:#f92672">.</span>get_key(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Construct nonce</span>
</span></span><span style="display:flex;"><span>        nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build payload blocks</span>
</span></span><span style="display:flex;"><span>        payload_data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>build_es_payload(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># AEAD encryption</span>
</span></span><span style="display:flex;"><span>        ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, payload_data, tag)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Assemble message</span>
</span></span><span style="display:flex;"><span>        es_message <span style="color:#f92672">=</span> tag <span style="color:#f92672">+</span> ciphertext
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send</span>
</span></span><span style="display:flex;"><span>        send_to_network(self<span style="color:#f92672">.</span>destination, es_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update activity</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if ratchet needed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>should_ratchet():
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>initiate_ratchet()
</span></span></code></pre></div><h3 id="hiện-thực-phía-nhận">Hiện thực phía nhận</h3>
<p><strong>Vòng đời phiên đến:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InboundSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Keys</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>remote_ephemeral_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>remote_static_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Tagsets</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Timing</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Paired session</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>paired_outbound <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">try_decrypt_ns</span>(message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Attempt to decrypt as NS message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Parse NS structure</span>
</span></span><span style="display:flex;"><span>        elg2_ephemeral <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">32</span>]
</span></span><span style="display:flex;"><span>        static_ciphertext <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">80</span>]  <span style="color:#75715e"># 32 + 16</span>
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">80</span>:]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decode ephemeral key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            alice_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(elg2_ephemeral)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Not a valid Elligator2 encoding</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check replay</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> is_replay(alice_ephemeral):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># KDF initialization</span>
</span></span><span style="display:flex;"><span>        chainKey, h <span style="color:#f92672">=</span> initialize_kdf()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix keys</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> alice_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># es DH</span>
</span></span><span style="display:flex;"><span>        es_shared <span style="color:#f92672">=</span> DH(context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>private_key, alice_ephemeral)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, es_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_static <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt static key section</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            static_data <span style="color:#f92672">=</span> DECRYPT(k_static, <span style="color:#ae81ff">0</span>, static_ciphertext, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Not a valid NS message</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> static_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if bound or unbound</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> static_data <span style="color:#f92672">==</span> bytes(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Unbound</span>
</span></span><span style="display:flex;"><span>            alice_static_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> k_static
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Bound - perform ss DH</span>
</span></span><span style="display:flex;"><span>            alice_static_key <span style="color:#f92672">=</span> static_data
</span></span><span style="display:flex;"><span>            ss_shared <span style="color:#f92672">=</span> DH(context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>private_key, alice_static_key)
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(chainKey, ss_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            k_payload <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt payload</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> DECRYPT(k_payload, nonce, payload_ciphertext, h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> payload_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create session</span>
</span></span><span style="display:flex;"><span>        session <span style="color:#f92672">=</span> InboundSession()
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>created_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>remote_ephemeral_key <span style="color:#f92672">=</span> alice_ephemeral
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>remote_static_key <span style="color:#f92672">=</span> alice_static_key
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>bound <span style="color:#f92672">=</span> (alice_static_key <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>ns_chainkey <span style="color:#f92672">=</span> chainKey
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>ns_hash <span style="color:#f92672">=</span> h
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Extract destination if bound</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>bound:
</span></span><span style="display:flex;"><span>            session<span style="color:#f92672">.</span>destination <span style="color:#f92672">=</span> extract_destination_from_payload(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process payload</span>
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>process_payload_blocks(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> session
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_nsr_reply</span>(self, reply_payload):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Send NSR message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate NSR tagset</span>
</span></span><span style="display:flex;"><span>        tagsetKey <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>ns_chainkey, ZEROLEN, <span style="color:#e6db74">&#34;SessionReplyTags&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        nsr_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(self<span style="color:#f92672">.</span>ns_chainkey, tagsetKey)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get tag</span>
</span></span><span style="display:flex;"><span>        tag, _ <span style="color:#f92672">=</span> nsr_tagset<span style="color:#f92672">.</span>get_next_tag()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix tag into hash</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(self<span style="color:#f92672">.</span>ns_hash <span style="color:#f92672">||</span> tag)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate ephemeral key</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ephemeral_keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>        bob_ephemeral <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>public_key
</span></span><span style="display:flex;"><span>        elg2_bob_ephemeral <span style="color:#f92672">=</span> ENCODE_ELG2(bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mix ephemeral key</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> bob_ephemeral)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>ns_chainkey
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ee DH</span>
</span></span><span style="display:flex;"><span>        ee_shared <span style="color:#f92672">=</span> DH(self<span style="color:#f92672">.</span>ephemeral_keypair<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                      self<span style="color:#f92672">.</span>remote_ephemeral_key)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ee_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># se DH</span>
</span></span><span style="display:flex;"><span>        se_shared <span style="color:#f92672">=</span> DH(context<span style="color:#f92672">.</span>static_keypair<span style="color:#f92672">.</span>private_key, 
</span></span><span style="display:flex;"><span>                      self<span style="color:#f92672">.</span>remote_ephemeral_key)
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, se_shared, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>        k_key_section <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt key section (empty)</span>
</span></span><span style="display:flex;"><span>        key_section_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_key_section, <span style="color:#ae81ff">0</span>, ZEROLEN, h)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> SHA256(h <span style="color:#f92672">||</span> key_section_ciphertext)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Split for bidirectional ES</span>
</span></span><span style="display:flex;"><span>        keydata <span style="color:#f92672">=</span> HKDF(chainKey, ZEROLEN, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>        k_ab <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]  <span style="color:#75715e"># Alice → Bob</span>
</span></span><span style="display:flex;"><span>        k_ba <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]  <span style="color:#75715e"># Bob → Alice</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialize ES tagsets</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ab)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_tagset <span style="color:#f92672">=</span> DH_INITIALIZE(chainKey, k_ba)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build reply payload</span>
</span></span><span style="display:flex;"><span>        payload_data <span style="color:#f92672">=</span> build_payload_blocks(reply_payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Encrypt payload</span>
</span></span><span style="display:flex;"><span>        k_nsr <span style="color:#f92672">=</span> HKDF(k_ba, ZEROLEN, <span style="color:#e6db74">&#34;AttachPayloadKDF&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        payload_ciphertext <span style="color:#f92672">=</span> ENCRYPT(k_nsr, <span style="color:#ae81ff">0</span>, payload_data, h)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Assemble NSR</span>
</span></span><span style="display:flex;"><span>        nsr_message <span style="color:#f92672">=</span> tag <span style="color:#f92672">+</span> elg2_bob_ephemeral <span style="color:#f92672">+</span> key_section_ciphertext <span style="color:#f92672">+</span> payload_ciphertext
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send</span>
</span></span><span style="display:flex;"><span>        send_to_network(self<span style="color:#f92672">.</span>destination, nsr_message)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Wait for ES</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>AWAITING_ES
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_es_received</span>(self, es_message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Process first ES message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>AWAITING_ES:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># First ES received, confirms session</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process ES message</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>process_es_message(es_message)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_es_message</span>(self, es_message):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Decrypt and process ES message&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Extract tag</span>
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> es_message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>        ciphertext <span style="color:#f92672">=</span> es_message[<span style="color:#ae81ff">8</span>:]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Look up tag</span>
</span></span><span style="display:flex;"><span>        index <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>lookup_tag(tag)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Tag not found&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get key</span>
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>inbound_keyratchet<span style="color:#f92672">.</span>get_key(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Construct nonce</span>
</span></span><span style="display:flex;"><span>        nonce <span style="color:#f92672">=</span> construct_nonce(index)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrypt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> DECRYPT(key, nonce, ciphertext, tag)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> AuthenticationError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;ES MAC verification failed&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process blocks</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>process_payload_blocks(payload)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update activity</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>last_activity <span style="color:#f92672">=</span> now()
</span></span></code></pre></div><h3 id="phân-loại-thông-điệp">Phân loại thông điệp</h3>
<p><strong>Phân biệt các loại thông điệp:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">classify_message</span>(message):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Determine message type&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Minimum lengths</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">24</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Too short</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for session tag (8 bytes)</span>
</span></span><span style="display:flex;"><span>    tag <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Try ES decryption first (most common)</span>
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> lookup_session_by_tag(tag)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;ES&#39;</span>, session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Try NSR decryption (tag + Elligator2 key)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">72</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if bytes 8-40 are valid Elligator2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            nsr_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(message[<span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">40</span>])
</span></span><span style="display:flex;"><span>            nsr_session <span style="color:#f92672">=</span> find_pending_nsr_by_tag(tag)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> nsr_session:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;NSR&#39;</span>, nsr_session)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Try NS decryption (starts with Elligator2 key)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">96</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            ns_ephemeral <span style="color:#f92672">=</span> DECODE_ELG2(message[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">32</span>])
</span></span><span style="display:flex;"><span>            ns_session <span style="color:#f92672">=</span> InboundSession<span style="color:#f92672">.</span>try_decrypt_ns(message)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ns_session:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;NS&#39;</span>, ns_session)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check ElGamal/AES (for dual-key compatibility)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">514</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (len(message) <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Might be ElGamal NS</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;ELGAMAL_NS&#39;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> len(message) <span style="color:#f92672">%</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Might be ElGamal ES</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;ELGAMAL_ES&#39;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># Unknown message type</span>
</span></span></code></pre></div><h3 id="thông-lệ-tốt-nhất-về-quản-lý-phiên">Thông lệ tốt nhất về quản lý phiên</h3>
<p><strong>Bộ nhớ phiên:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SessionKeyManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Outbound sessions (one per destination)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>outbound_sessions <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># destination -&gt; OutboundSession</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Inbound sessions (multiple per destination during transition)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions <span style="color:#f92672">=</span> []  <span style="color:#75715e"># [InboundSession]</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Session tag lookup (fast path for ES messages)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tag_to_session <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># tag -&gt; InboundSession</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Limits</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_inbound_sessions <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tags_per_session <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_outbound_session</span>(self, destination):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get or create outbound session&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> destination <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>outbound_sessions:
</span></span><span style="display:flex;"><span>            session <span style="color:#f92672">=</span> OutboundSession(destination)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>outbound_sessions[destination] <span style="color:#f92672">=</span> session
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>outbound_sessions[destination]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_inbound_session</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Add new inbound session&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check limits</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(self<span style="color:#f92672">.</span>inbound_sessions) <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_inbound_sessions:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>expire_oldest_session()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions<span style="color:#f92672">.</span>append(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add tags to lookup table</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>register_session_tags(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_session_tags</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Register session&#39;s tags in lookup table&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>get_all_tags():
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>tag_to_session[tag] <span style="color:#f92672">=</span> session
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lookup_tag</span>(self, tag):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Fast tag lookup&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>tag_to_session<span style="color:#f92672">.</span>get(tag)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">expire_sessions</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Periodic session expiration&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        now_time <span style="color:#f92672">=</span> now()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire outbound sessions</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> dest, session <span style="color:#f92672">in</span> list(self<span style="color:#f92672">.</span>outbound_sessions<span style="color:#f92672">.</span>items()):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time(now_time) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>outbound_sessions[dest]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire inbound sessions</span>
</span></span><span style="display:flex;"><span>        expired <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>inbound_sessions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>idle_time(now_time) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:
</span></span><span style="display:flex;"><span>                expired<span style="color:#f92672">.</span>append(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> expired:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>remove_inbound_session(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_inbound_session</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Remove inbound session and clean up tags&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>inbound_sessions<span style="color:#f92672">.</span>remove(session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Remove tags from lookup</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>get_all_tags():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tag <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>tag_to_session:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>tag_to_session[tag]
</span></span></code></pre></div><p><strong>Quản lý bộ nhớ:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TagMemoryManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, max_memory_kb<span style="color:#f92672">=</span><span style="color:#ae81ff">10240</span>):  <span style="color:#75715e"># 10 MB default</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_memory <span style="color:#f92672">=</span> max_memory_kb <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_memory <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tags_per_session <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>min_tags_per_session <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_tag_memory</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Calculate memory used by session tags&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        tag_count <span style="color:#f92672">=</span> len(session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>tags)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Each tag: 8 bytes (tag) + 2 bytes (index) + 32 bytes (key, optional)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># + overhead</span>
</span></span><span style="display:flex;"><span>        bytes_per_tag <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span> <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>defer_keys <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> tag_count <span style="color:#f92672">*</span> bytes_per_tag
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_pressure</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Check if under memory pressure&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>current_memory <span style="color:#f92672">&gt;</span> (self<span style="color:#f92672">.</span>max_memory <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.9</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_pressure</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Reduce memory usage when under pressure&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>check_pressure():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 1: Reduce look-ahead windows</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> all_sessions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>look_ahead <span style="color:#f92672">&gt;</span> self<span style="color:#f92672">.</span>min_tags_per_session:
</span></span><span style="display:flex;"><span>                session<span style="color:#f92672">.</span>reduce_look_ahead(self<span style="color:#f92672">.</span>min_tags_per_session)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 2: Trim old tags aggressively</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> all_sessions:
</span></span><span style="display:flex;"><span>            session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>trim_behind(aggressive<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 3: Refuse new ratchets</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> session <span style="color:#f92672">in</span> all_sessions:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>should_ratchet():
</span></span><span style="display:flex;"><span>                session<span style="color:#f92672">.</span>defer_ratchet <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Strategy 4: Expire idle sessions early</span>
</span></span><span style="display:flex;"><span>        expire_idle_sessions(threshold<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span>)  <span style="color:#75715e"># 5 min instead of 10</span>
</span></span></code></pre></div><h3 id="chiến-lược-kiểm-thử">Chiến lược kiểm thử</h3>
<p><strong>Kiểm thử đơn vị:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_x25519_dh</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test X25519 key exchange&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    alice_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    alice_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(alice_sk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    bob_sk <span style="color:#f92672">=</span> GENERATE_PRIVATE()
</span></span><span style="display:flex;"><span>    bob_pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(bob_sk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Both sides compute same shared secret</span>
</span></span><span style="display:flex;"><span>    alice_shared <span style="color:#f92672">=</span> DH(alice_sk, bob_pk)
</span></span><span style="display:flex;"><span>    bob_shared <span style="color:#f92672">=</span> DH(bob_sk, alice_pk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> alice_shared <span style="color:#f92672">==</span> bob_shared
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_elligator2_encode_decode</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test Elligator2 roundtrip&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    sk <span style="color:#f92672">=</span> GENERATE_PRIVATE_ELG2()
</span></span><span style="display:flex;"><span>    pk <span style="color:#f92672">=</span> DERIVE_PUBLIC(sk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    encoded <span style="color:#f92672">=</span> ENCODE_ELG2(pk)
</span></span><span style="display:flex;"><span>    decoded <span style="color:#f92672">=</span> DECODE_ELG2(encoded)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> decoded <span style="color:#f92672">==</span> pk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_chacha_poly_encrypt_decrypt</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test ChaCha20-Poly1305 AEAD&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> construct_nonce(<span style="color:#ae81ff">42</span>)
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello, I2P!&#34;</span>
</span></span><span style="display:flex;"><span>    ad <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;associated_data&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext, ad)
</span></span><span style="display:flex;"><span>    decrypted <span style="color:#f92672">=</span> DECRYPT(key, nonce, ciphertext, ad)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> decrypted <span style="color:#f92672">==</span> plaintext
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_session_tag_ratchet</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test session tag generation&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    sessTag_ck <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    tagset <span style="color:#f92672">=</span> SessionTagRatchet(sessTag_ck)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Generate 100 tags</span>
</span></span><span style="display:flex;"><span>    tags <span style="color:#f92672">=</span> [tagset<span style="color:#f92672">.</span>get_next_tag() <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>)]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># All tags should be unique</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> len(set(tags)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Each tag should be 8 bytes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> tags:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(tag) <span style="color:#f92672">==</span> <span style="color:#ae81ff">8</span>
</span></span></code></pre></div><p><strong>Kiểm thử tích hợp:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_ns_nsr_handshake</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test NS/NSR handshake&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice creates outbound session</span>
</span></span><span style="display:flex;"><span>    alice_session <span style="color:#f92672">=</span> OutboundSession(bob_destination, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice sends NS</span>
</span></span><span style="display:flex;"><span>    ns_message <span style="color:#f92672">=</span> alice_session<span style="color:#f92672">.</span>build_ns_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello Bob&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob receives NS</span>
</span></span><span style="display:flex;"><span>    bob_session <span style="color:#f92672">=</span> InboundSession<span style="color:#f92672">.</span>try_decrypt_ns(ns_message)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> bob_session <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> bob_session<span style="color:#f92672">.</span>bound <span style="color:#f92672">==</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob sends NSR</span>
</span></span><span style="display:flex;"><span>    nsr_message <span style="color:#f92672">=</span> bob_session<span style="color:#f92672">.</span>build_nsr_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Hello Alice&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice receives NSR</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>on_nsr_received(nsr_message)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> alice_session<span style="color:#f92672">.</span>state <span style="color:#f92672">==</span> SessionState<span style="color:#f92672">.</span>ESTABLISHED
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Both should have matching ES tagsets</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># (Cannot directly compare, but can test by sending ES messages)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_es_bidirectional</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test ES messages in both directions&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># (After NS/NSR handshake)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice sends ES to Bob</span>
</span></span><span style="display:flex;"><span>    es_alice_to_bob <span style="color:#f92672">=</span> alice_session<span style="color:#f92672">.</span>send_es_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Data from Alice&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob receives ES</span>
</span></span><span style="display:flex;"><span>    bob_session<span style="color:#f92672">.</span>process_es_message(es_alice_to_bob)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob sends ES to Alice</span>
</span></span><span style="display:flex;"><span>    es_bob_to_alice <span style="color:#f92672">=</span> bob_session<span style="color:#f92672">.</span>send_es_message(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Data from Bob&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice receives ES</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>process_es_message(es_bob_to_alice)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_dh_ratchet</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test DH ratchet&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># (After established session)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alice initiates ratchet</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>initiate_ratchet()
</span></span><span style="display:flex;"><span>    nextkey_alice <span style="color:#f92672">=</span> build_nextkey_block(
</span></span><span style="display:flex;"><span>        flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x01</span>,
</span></span><span style="display:flex;"><span>        key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        public_key<span style="color:#f92672">=</span>alice_new_key
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send to Bob</span>
</span></span><span style="display:flex;"><span>    bob_session<span style="color:#f92672">.</span>process_nextkey_block(nextkey_alice)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bob replies</span>
</span></span><span style="display:flex;"><span>    nextkey_bob <span style="color:#f92672">=</span> build_nextkey_block(
</span></span><span style="display:flex;"><span>        flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0x03</span>,
</span></span><span style="display:flex;"><span>        key_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        public_key<span style="color:#f92672">=</span>bob_new_key
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send to Alice</span>
</span></span><span style="display:flex;"><span>    alice_session<span style="color:#f92672">.</span>process_nextkey_block(nextkey_bob)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Both should now be using new tagsets</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> alice_session<span style="color:#f92672">.</span>outbound_tagset<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> bob_session<span style="color:#f92672">.</span>inbound_tagset<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>Các véc-tơ kiểm thử:</strong></p>
<p>Hiện thực các vector kiểm thử từ đặc tả:</p>
<ol>
<li><strong>Noise IK Handshake</strong> (bắt tay Noise IK): Sử dụng các vector kiểm thử chuẩn của Noise</li>
<li><strong>HKDF</strong> (hàm dẫn xuất khóa dựa trên HMAC): Sử dụng các vector kiểm thử theo RFC 5869</li>
<li><strong>ChaCha20-Poly1305</strong> (mã hóa xác thực AEAD): Sử dụng các vector kiểm thử theo RFC 7539</li>
<li><strong>Elligator2</strong> (kỹ thuật ánh xạ Elligator2): Sử dụng các vector kiểm thử từ bài báo về Elligator2 hoặc OBFS4 (transport che giấu OBFS4)</li>
</ol>
<p><strong>Kiểm thử khả năng tương tác:</strong></p>
<ol>
<li><strong>Java I2P</strong>: Kiểm thử đối chiếu với bản triển khai tham chiếu của Java I2P</li>
<li><strong>i2pd</strong>: Kiểm thử đối chiếu với bản triển khai i2pd bằng C++</li>
<li><strong>Ghi bắt gói tin</strong>: Sử dụng Wireshark dissector (trình phân tích giao thức) (nếu có) để xác minh định dạng thông điệp</li>
<li><strong>Tương tác giữa các triển khai</strong>: Tạo khung kiểm thử có thể gửi/nhận giữa các bản triển khai</li>
</ol>
<h3 id="những-cân-nhắc-về-hiệu-năng">Những cân nhắc về hiệu năng</h3>
<p><strong>Sinh khóa:</strong></p>
<p>Việc sinh khóa Elligator2 (kỹ thuật che giấu khóa công khai) tốn kém (tỷ lệ loại bỏ 50%):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KeyPool</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Pre-generate keys in background thread&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, pool_size<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pool <span style="color:#f92672">=</span> Queue(maxsize<span style="color:#f92672">=</span>pool_size)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>generator_thread <span style="color:#f92672">=</span> Thread(target<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>generate_keys, daemon<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>generator_thread<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_keys</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>full():
</span></span><span style="display:flex;"><span>                keypair <span style="color:#f92672">=</span> generate_elg2_keypair()
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Also compute encoded form</span>
</span></span><span style="display:flex;"><span>                encoded <span style="color:#f92672">=</span> ENCODE_ELG2(keypair<span style="color:#f92672">.</span>public_key)
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>put((keypair, encoded))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_keypair</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>get(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1.0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> Empty:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Pool exhausted, generate inline</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> generate_elg2_keypair()
</span></span></code></pre></div><p><strong>Tra cứu thẻ:</strong></p>
<p>Sử dụng bảng băm để tra cứu thẻ với độ phức tạp O(1):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FastTagLookup</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tag_to_session <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Python dict is hash table</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_tag</span>(self, tag, session, index):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 8-byte tag as bytes is hashable</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tag_to_session[tag] <span style="color:#f92672">=</span> (session, index)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lookup_tag</span>(self, tag):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>tag_to_session<span style="color:#f92672">.</span>get(tag)
</span></span></code></pre></div><p><strong>Tối ưu hóa bộ nhớ:</strong></p>
<p>Trì hoãn việc tạo khóa đối xứng:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DeferredKeyRatchet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Only generate keys when needed&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, symmKey_ck):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> symmKey_ck
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cache <span style="color:#f92672">=</span> LRUCache(maxsize<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>)  <span style="color:#75715e"># Cache recent keys</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_key</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check cache first</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>cache:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>cache[index]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate keys up to index</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">&lt;</span> index:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            keydata <span style="color:#f92672">=</span> HKDF(self<span style="color:#f92672">.</span>chainKey, ZEROLEN, <span style="color:#e6db74">&#34;SymmetricRatchet&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>chainKey <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>index <span style="color:#f92672">==</span> index:
</span></span><span style="display:flex;"><span>                key <span style="color:#f92672">=</span> keydata[<span style="color:#ae81ff">32</span>:<span style="color:#ae81ff">63</span>]
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>cache[index] <span style="color:#f92672">=</span> key
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> key
</span></span></code></pre></div><p><strong>Xử lý theo lô:</strong></p>
<p>Xử lý nhiều thông điệp theo lô:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_message_batch</span>(messages):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Process multiple messages efficiently&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    results <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Group by type</span>
</span></span><span style="display:flex;"><span>    ns_messages <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    nsr_messages <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    es_messages <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> messages:
</span></span><span style="display:flex;"><span>        msg_type <span style="color:#f92672">=</span> classify_message(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> msg_type[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;NS&#39;</span>:
</span></span><span style="display:flex;"><span>            ns_messages<span style="color:#f92672">.</span>append(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> msg_type[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;NSR&#39;</span>:
</span></span><span style="display:flex;"><span>            nsr_messages<span style="color:#f92672">.</span>append(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> msg_type[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ES&#39;</span>:
</span></span><span style="display:flex;"><span>            es_messages<span style="color:#f92672">.</span>append(msg)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Process in batches</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ES messages are most common, process first</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> es_messages:
</span></span><span style="display:flex;"><span>        results<span style="color:#f92672">.</span>append(process_es_message(msg))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> nsr_messages:
</span></span><span style="display:flex;"><span>        results<span style="color:#f92672">.</span>append(process_nsr_message(msg))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> ns_messages:
</span></span><span style="display:flex;"><span>        results<span style="color:#f92672">.</span>append(process_ns_message(msg))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> results
</span></span></code></pre></div><hr>
<h2 id="các-cân-nhắc-bảo-mật">Các cân nhắc bảo mật</h2>
<h3 id="mô-hình-đe-dọa">Mô hình đe dọa</h3>
<p><strong>Khả năng của đối thủ tấn công:</strong></p>
<ol>
<li><strong>Người quan sát thụ động</strong>: Có thể quan sát toàn bộ lưu lượng mạng</li>
<li><strong>Kẻ tấn công chủ động</strong>: Có thể chèn, sửa đổi, loại bỏ, phát lại thông điệp</li>
<li><strong>Nút bị xâm nhập</strong>: Có thể xâm nhập một router hoặc điểm đích</li>
<li><strong>Phân tích lưu lượng</strong>: Có thể thực hiện phân tích thống kê về các mẫu lưu lượng</li>
</ol>
<p><strong>Mục tiêu bảo mật:</strong></p>
<ol>
<li><strong>Tính bảo mật</strong>: Nội dung thông điệp được ẩn khỏi người quan sát</li>
<li><strong>Xác thực</strong>: Danh tính người gửi được xác minh (trong các phiên ràng buộc)</li>
<li><strong>Tính bí mật chuyển tiếp</strong>: Các thông điệp trước đây vẫn giữ bí mật ngay cả khi khóa bị lộ</li>
<li><strong>Chống phát lại</strong>: Không thể phát lại các thông điệp cũ</li>
<li><strong>Ngụy trang lưu lượng</strong>: Quá trình bắt tay không thể phân biệt với dữ liệu ngẫu nhiên</li>
</ol>
<h3 id="các-giả-định-mật-mã">Các giả định mật mã</h3>
<p><strong>Các giả định về độ khó:</strong></p>
<ol>
<li><strong>X25519 CDH</strong>: Bài toán Diffie–Hellman dạng tính toán là khó trên Curve25519</li>
<li><strong>ChaCha20 PRF</strong>: ChaCha20 là một hàm giả ngẫu nhiên</li>
<li><strong>Poly1305 MAC</strong>: Poly1305 không thể bị giả mạo dưới tấn công chọn thông điệp</li>
<li><strong>SHA-256 CR</strong>: SHA-256 kháng va chạm</li>
<li><strong>HKDF Security</strong>: HKDF trích xuất và mở rộng các khóa được phân bố đồng đều</li>
</ol>
<p><strong>Mức độ bảo mật:</strong></p>
<ul>
<li><strong>X25519</strong>: ~128-bit mức an toàn (bậc đường cong 2^252)</li>
<li><strong>ChaCha20</strong>: khóa 256-bit, mức an toàn 256-bit</li>
<li><strong>Poly1305</strong>: mức an toàn 128-bit (xác suất va chạm)</li>
<li><strong>SHA-256</strong>: khả năng chống va chạm 128-bit, khả năng chống tiền ảnh 256-bit</li>
</ul>
<h3 id="quản-lý-khóa">Quản lý khóa</h3>
<p><strong>Sinh khóa:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Use cryptographically secure RNG</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">CSRNG</span>(length):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># GOOD: os.urandom, secrets.token_bytes (Python)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># GOOD: /dev/urandom (Linux)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># GOOD: BCryptGenRandom (Windows)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># BAD: random.random(), Math.random() (NOT cryptographically secure)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> os<span style="color:#f92672">.</span>urandom(length)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Validate keys</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_x25519_key</span>(pubkey):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for weak keys (all zeros, small order points)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> pubkey <span style="color:#f92672">==</span> bytes(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> WeakKeyError(<span style="color:#e6db74">&#34;All-zero public key&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform DH to check for weak shared secrets</span>
</span></span><span style="display:flex;"><span>    test_shared <span style="color:#f92672">=</span> DH(test_private_key, pubkey)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> test_shared <span style="color:#f92672">==</span> bytes(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> WeakKeyError(<span style="color:#e6db74">&#34;Results in zero shared secret&#34;</span>)
</span></span></code></pre></div><p><strong>Lưu trữ khóa:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Protect private keys</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecureKeyStorage</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Store in memory with protection</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>keys <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Option 1: Memory locking (prevent swapping to disk)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># mlock(self.keys)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Option 2: Encrypted storage</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># self.encryption_key = derive_from_password()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">store_key</span>(self, key_id, private_key):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Option: Encrypt before storage</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># encrypted = encrypt(private_key, self.encryption_key)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># self.keys[key_id] = encrypted</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>keys[key_id] <span style="color:#f92672">=</span> private_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_key</span>(self, key_id):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Securely wipe memory</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> key_id <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>keys:
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>keys[key_id]
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Overwrite with zeros before deletion</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(key)):
</span></span><span style="display:flex;"><span>                key[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>keys[key_id]
</span></span></code></pre></div><p><strong>Luân chuyển khóa:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Rotate keys regularly</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KeyRotationPolicy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_messages_per_tagset <span style="color:#f92672">=</span> <span style="color:#ae81ff">4096</span>  <span style="color:#75715e"># Ratchet before 65535</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tagset_age <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>       <span style="color:#75715e"># 10 minutes</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_session_age <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>      <span style="color:#75715e"># 1 hour</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">should_ratchet</span>(self, tagset):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (tagset<span style="color:#f92672">.</span>messages_sent <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_messages_per_tagset <span style="color:#f92672">or</span>
</span></span><span style="display:flex;"><span>                tagset<span style="color:#f92672">.</span>age() <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_tagset_age)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">should_replace_session</span>(self, session):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> session<span style="color:#f92672">.</span>age() <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_session_age
</span></span></code></pre></div><h3 id="các-biện-pháp-giảm-thiểu-tấn-công">Các biện pháp giảm thiểu tấn công</h3>
<h3 id="các-biện-pháp-giảm-thiểu-tấn-công-phát-lại">Các biện pháp giảm thiểu tấn công phát lại</h3>
<p><strong>Xác thực DateTime (ngày giờ):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>MAX_CLOCK_SKEW_PAST <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>MAX_CLOCK_SKEW_FUTURE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_datetime</span>(timestamp):
</span></span><span style="display:flex;"><span>    now <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span>    age <span style="color:#f92672">=</span> now <span style="color:#f92672">-</span> timestamp
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span>MAX_CLOCK_SKEW_FUTURE:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> ReplayError(<span style="color:#e6db74">&#34;Timestamp too far in future&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&gt;</span> MAX_CLOCK_SKEW_PAST:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> ReplayError(<span style="color:#e6db74">&#34;Timestamp too old&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><p><strong>Bộ lọc Bloom cho các thông điệp NS:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReplayFilter</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, capacity<span style="color:#f92672">=</span><span style="color:#ae81ff">100000</span>, error_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>, duration<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bloom <span style="color:#f92672">=</span> BloomFilter(capacity<span style="color:#f92672">=</span>capacity, error_rate<span style="color:#f92672">=</span>error_rate)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>duration <span style="color:#f92672">=</span> duration
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>entries <span style="color:#f92672">=</span> []  <span style="color:#75715e"># (timestamp, ephemeral_key)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_replay</span>(self, ephemeral_key, timestamp):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Validate timestamp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> validate_datetime(timestamp):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check Bloom filter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ephemeral_key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>bloom:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Potential replay (or false positive)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Check exact match in entries</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> ts, key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>entries:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> key <span style="color:#f92672">==</span> ephemeral_key:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># Definite replay</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add to filter</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>bloom<span style="color:#f92672">.</span>add(ephemeral_key)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>entries<span style="color:#f92672">.</span>append((timestamp, ephemeral_key))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Expire old entries</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>expire_old_entries()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">expire_old_entries</span>(self):
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>entries <span style="color:#f92672">=</span> [(ts, key) <span style="color:#66d9ef">for</span> ts, key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>entries
</span></span><span style="display:flex;"><span>                       <span style="color:#66d9ef">if</span> now <span style="color:#f92672">-</span> ts <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>duration]
</span></span></code></pre></div><p><strong>Session Tag (thẻ phiên) dùng một lần:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_session_tag</span>(tag):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Look up tag</span>
</span></span><span style="display:flex;"><span>    entry <span style="color:#f92672">=</span> tagset<span style="color:#f92672">.</span>lookup_tag(tag)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> entry <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Invalid session tag&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># CRITICAL: Remove tag immediately (one-time use)</span>
</span></span><span style="display:flex;"><span>    tagset<span style="color:#f92672">.</span>remove_tag(tag)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Use associated key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> entry<span style="color:#f92672">.</span>key, entry<span style="color:#f92672">.</span>index
</span></span></code></pre></div><h3 id="các-biện-pháp-giảm-thiểu-mạo-danh-do-lộ-khóa-key-compromise-impersonation-kci">Các biện pháp giảm thiểu mạo danh do lộ khóa (Key Compromise Impersonation, KCI)</h3>
<p><strong>Vấn đề</strong>: Việc xác thực thông điệp của NS dễ bị tấn công KCI (Key Compromise Impersonation - giả mạo do lộ khóa) (Mức xác thực 1)</p>
<p><strong>Biện pháp giảm thiểu</strong>:</p>
<ol>
<li>Chuyển sang NSR (Cấp xác thực 2) càng nhanh càng tốt</li>
<li>Đừng tin cậy NS payload cho các thao tác trọng yếu về bảo mật</li>
<li>Chờ xác nhận NSR trước khi thực hiện các hành động không thể hoàn tác</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_ns_message</span>(ns_message):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># NS authenticated at Level 1 (KCI vulnerable)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Do NOT perform security-critical operations yet</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract sender&#39;s static key</span>
</span></span><span style="display:flex;"><span>    sender_key <span style="color:#f92672">=</span> ns_message<span style="color:#f92672">.</span>static_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Mark session as pending Level 2 authentication</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>auth_level <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>sender_key <span style="color:#f92672">=</span> sender_key
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Send NSR</span>
</span></span><span style="display:flex;"><span>    send_nsr_reply(session)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_first_es_message</span>(es_message):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Now we have Level 2 authentication (KCI resistant)</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>auth_level <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Safe to perform security-critical operations</span>
</span></span><span style="display:flex;"><span>    process_security_critical_operation(es_message)
</span></span></code></pre></div><h3 id="các-biện-pháp-giảm-thiểu-tấn-công-từ-chối-dịch-vụ">Các biện pháp giảm thiểu tấn công từ chối dịch vụ</h3>
<p><strong>Bảo vệ chống flood cho NS:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NSFloodProtection</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_count <span style="color:#f92672">=</span> defaultdict(int)  <span style="color:#75715e"># source -&gt; count</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timestamps <span style="color:#f92672">=</span> defaultdict(list)  <span style="color:#75715e"># source -&gt; [timestamps]</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_ns_per_source <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>rate_window <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># seconds</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_concurrent_ns <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_ns_allowed</span>(self, source):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Global limit</span>
</span></span><span style="display:flex;"><span>        total_pending <span style="color:#f92672">=</span> sum(self<span style="color:#f92672">.</span>ns_count<span style="color:#f92672">.</span>values())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> total_pending <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_concurrent_ns:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Per-source rate limit</span>
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        timestamps <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>ns_timestamps[source]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Remove old timestamps</span>
</span></span><span style="display:flex;"><span>        timestamps <span style="color:#f92672">=</span> [ts <span style="color:#66d9ef">for</span> ts <span style="color:#f92672">in</span> timestamps <span style="color:#66d9ef">if</span> now <span style="color:#f92672">-</span> ts <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>rate_window]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_timestamps[source] <span style="color:#f92672">=</span> timestamps
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check rate</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(timestamps) <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_ns_per_source:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Allow NS</span>
</span></span><span style="display:flex;"><span>        timestamps<span style="color:#f92672">.</span>append(now)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ns_count[source] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_session_established</span>(self, source):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decrease pending count</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>ns_count[source] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>ns_count[source] <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>Giới hạn lưu trữ thẻ:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TagStorageLimit</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, max_tags<span style="color:#f92672">=</span><span style="color:#ae81ff">1000000</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_tags <span style="color:#f92672">=</span> max_tags
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">can_create_session</span>(self, look_ahead):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">+</span> look_ahead <span style="color:#f92672">&gt;</span> self<span style="color:#f92672">.</span>max_tags:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_tags</span>(self, count):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">+=</span> count
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_tags</span>(self, count):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>current_tags <span style="color:#f92672">-=</span> count
</span></span></code></pre></div><p><strong>Quản lý tài nguyên thích ứng:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AdaptiveResourceManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>  <span style="color:#75715e"># 0 = low, 1 = medium, 2 = high, 3 = critical</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">adjust_parameters</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Normal operation</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">160</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Moderate load</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">80</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">800</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>load_level <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># High load</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">32</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">500</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:  <span style="color:#75715e"># load_level == 3</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Critical load</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_look_ahead&#39;</span>: <span style="color:#ae81ff">16</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;max_sessions&#39;</span>: <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;session_timeout&#39;</span>: <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>            }
</span></span></code></pre></div><h3 id="khả-năng-chống-phân-tích-lưu-lượng">Khả năng chống phân tích lưu lượng</h3>
<p><strong>Mã hóa Elligator2 (kỹ thuật biểu diễn điểm trên đường cong elliptic thành chuỗi trông ngẫu nhiên):</strong></p>
<p>Đảm bảo các thông điệp bắt tay không thể phân biệt được so với dữ liệu ngẫu nhiên:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># NS and NSR start with Elligator2-encoded ephemeral keys</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Observer cannot distinguish from random 32-byte string</span>
</span></span></code></pre></div><p><strong>Chiến lược đệm:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Resist message size fingerprinting</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_padding</span>(payload, strategy<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;random&#39;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> strategy <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;random&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Random padding 0-15 bytes</span>
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">15</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> strategy <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;round&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Round to next 64-byte boundary</span>
</span></span><span style="display:flex;"><span>        target <span style="color:#f92672">=</span> ((len(payload) <span style="color:#f92672">+</span> <span style="color:#ae81ff">63</span>) <span style="color:#f92672">//</span> <span style="color:#ae81ff">64</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> target <span style="color:#f92672">-</span> len(payload) <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>  <span style="color:#75715e"># -3 for block header</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> strategy <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;fixed&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Always 1KB messages</span>
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">-</span> len(payload) <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> build_padding_block(size)
</span></span></code></pre></div><p><strong>Tấn công thời gian:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Use constant-time operations</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">constant_time_compare</span>(a, b):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Constant-time byte string comparison&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(a) <span style="color:#f92672">!=</span> len(b):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x, y <span style="color:#f92672">in</span> zip(a, b):
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">|=</span> x <span style="color:#f92672">^</span> y
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CRITICAL: Constant-time MAC verification</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">verify_mac</span>(computed_mac, received_mac):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> constant_time_compare(computed_mac, received_mac):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Always take same time regardless of where comparison fails</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> AuthenticationError(<span style="color:#e6db74">&#34;MAC verification failed&#34;</span>)
</span></span></code></pre></div><h3 id="những-cạm-bẫy-khi-hiện-thực">Những cạm bẫy khi hiện thực</h3>
<p><strong>Các lỗi thường gặp:</strong></p>
<ol>
<li><strong>Tái sử dụng nonce (số dùng một lần)</strong>: KHÔNG BAO GIỜ tái sử dụng các cặp (key, nonce)
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># BAD: Reusing nonce with same key</span>
</span></span><span style="display:flex;"><span>ciphertext1 <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext1, ad1)
</span></span><span style="display:flex;"><span>ciphertext2 <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext2, ad2)  <span style="color:#75715e"># CATASTROPHIC</span>
</span></span></code></pre></div></li>
</ol>
<h1 id="tốt-nonce-giá-trị-dùng-một-lần-duy-nhất-cho-mỗi-thông-điệp----ciphertext1--encryptkey-nonce1-plaintext1-ad1----ciphertext2--encryptkey-nonce2-plaintext2-ad2">TỐT: Nonce (giá trị dùng một lần) duy nhất cho mỗi thông điệp    ciphertext1 = ENCRYPT(key, nonce1, plaintext1, ad1)    ciphertext2 = ENCRYPT(key, nonce2, plaintext2, ad2)</h1>
<pre tabindex="0"><code>
2. **Ephemeral Key Reuse**: Generate fresh ephemeral key for each NS/NSR
```python
# KHÔNG NÊN: Tái sử dụng khóa tạm thời    ephemeral_key = generate_elg2_keypair()    send_ns_message(ephemeral_key)    send_ns_message(ephemeral_key)  # KHÔNG NÊN

# TỐT: Khóa mới cho mỗi thông điệp    send_ns_message(generate_elg2_keypair())    send_ns_message(generate_elg2_keypair())
</code></pre><ol start="3">
<li><strong>Weak RNG</strong>: Use cryptographically secure random number generator
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div></li>
</ol>
<h1 id="không-nên-bộ-sinh-số-ngẫu-nhiên-không-dùng-cho-mật-mã----import-random----key--bytesrandomrandint0-255-for-_-in-range32---không-an-toàn">KHÔNG NÊN: Bộ sinh số ngẫu nhiên không dùng cho mật mã    import random    key = bytes([random.randint(0, 255) for _ in range(32)])  # KHÔNG AN TOÀN</h1>
<h1 id="tốt-bộ-sinh-số-ngẫu-nhiên-an-toàn-mật-mã----import-os----key--osurandom32">TỐT: Bộ sinh số ngẫu nhiên an toàn mật mã    import os    key = os.urandom(32)</h1>
<pre tabindex="0"><code>
4. **Timing Attacks**: Use constant-time comparisons
```python
# KHÔNG NÊN: So sánh thoát sớm    if computed_mac == received_mac:  # Rò rỉ thời gian

    pass

# TỐT: So sánh thời gian không đổi    if constant_time_compare(computed_mac, received_mac):

    pass
</code></pre><ol start="5">
<li><strong>Incomplete MAC Verification</strong>: Always verify before using data
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div></li>
</ol>
<h1 id="sai-giải-mã-trước-khi-xác-minh----plaintext--chacha20_decryptkey-nonce-ciphertext----mac_ok--verify_macmac-plaintext---quá-muộn----if-not-mac_ok">SAI: Giải mã trước khi xác minh    plaintext = chacha20_decrypt(key, nonce, ciphertext)    mac_ok = verify_mac(mac, plaintext)  # QUÁ MUỘN    if not mac_ok:</h1>
<pre><code>   return error
</code></pre>
<h1 id="tốt-aead-mã-hóa-xác-thực-kèm-dữ-liệu-kiểm-tra-tính-xác-thực-trước-khi-giải-mã----try">TỐT: AEAD (mã hóa xác thực kèm dữ liệu) kiểm tra tính xác thực trước khi giải mã    try:</h1>
<pre><code>   plaintext = DECRYPT(key, nonce, ciphertext, ad)  # Verifies MAC first
</code></pre>
<p>except AuthenticationError:</p>
<pre><code>   return error
</code></pre>
<pre tabindex="0"><code>
6. **Key Deletion**: Securely wipe keys from memory
```python
# KHÔNG NÊN: Xóa đơn giản    del private_key  # Vẫn còn trong bộ nhớ

# TỐT: Ghi đè trước khi xóa    for i in range(len(private_key)):

    private_key[i] = 0
del private_key
</code></pre><h3 id="security-audits">Security Audits</h3>
<p><strong>Recommended Audits:</strong></p>
<ol>
<li><strong>Cryptographic Review</strong>: Expert review of KDF chains and DH operations</li>
<li><strong>Implementation Audit</strong>: Code review for timing attacks, key management, RNG usage</li>
<li><strong>Protocol Analysis</strong>: Formal verification of handshake security properties</li>
<li><strong>Side-Channel Analysis</strong>: Timing, power, and cache attacks</li>
<li><strong>Fuzzing</strong>: Random input testing for parser robustness</li>
</ol>
<p><strong>Test Cases:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Các trường hợp kiểm thử trọng yếu về bảo mật</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_nonce_uniqueness</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure nonces are never reused&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    nonces <span style="color:#f92672">=</span> set()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10000</span>):
</span></span><span style="display:flex;"><span>        nonce <span style="color:#f92672">=</span> construct_nonce(i)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> nonce <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> nonces
</span></span><span style="display:flex;"><span>        nonces<span style="color:#f92672">.</span>add(nonce)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_key_isolation</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure sessions don&#39;t share keys&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    session1 <span style="color:#f92672">=</span> create_session(destination1)
</span></span><span style="display:flex;"><span>    session2 <span style="color:#f92672">=</span> create_session(destination2)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> session1<span style="color:#f92672">.</span>key <span style="color:#f92672">!=</span> session2<span style="color:#f92672">.</span>key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_replay_prevention</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure replay attacks are detected&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    ns_message <span style="color:#f92672">=</span> create_ns_message()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># First delivery succeeds</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> process_ns_message(ns_message) <span style="color:#f92672">==</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Replay fails</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> process_ns_message(ns_message) <span style="color:#f92672">==</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_mac_verification</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Ensure MAC verification is enforced&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> CSRNG(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> construct_nonce(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    plaintext <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>    ad <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;test_ad&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ciphertext <span style="color:#f92672">=</span> ENCRYPT(key, nonce, plaintext, ad)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Correct MAC verifies</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> DECRYPT(key, nonce, ciphertext, ad) <span style="color:#f92672">==</span> plaintext
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Corrupted MAC fails</span>
</span></span><span style="display:flex;"><span>    corrupted <span style="color:#f92672">=</span> ciphertext[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> bytes([ciphertext[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">^</span> <span style="color:#ae81ff">0xFF</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> pytest<span style="color:#f92672">.</span>raises(AuthenticationError):
</span></span><span style="display:flex;"><span>        DECRYPT(key, nonce, corrupted, ad)
</span></span></code></pre></div><hr>
<h2 id="configuration-and-deployment">Configuration and Deployment</h2>
<h3 id="i2cp-configuration">I2CP Configuration</h3>
<p><strong>Enable ECIES Encryption:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Chỉ ECIES (lược đồ mã hóa tích hợp đường cong elliptic) (được khuyến nghị cho các triển khai mới)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Khóa kép (ECIES + ElGamal để tương thích)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4,0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Chỉ ElGamal (lỗi thời, không khuyến nghị)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
</span></span></code></pre></div><p><strong>LeaseSet Type:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># LS2 tiêu chuẩn (phổ biến nhất)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetType</span><span style="color:#f92672">=</span><span style="color:#e6db74">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># LS2 được mã hóa (blinded destinations - điểm đến bị làm mù)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetType</span><span style="color:#f92672">=</span><span style="color:#e6db74">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Meta LS2 (nhiều đích đến)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetType</span><span style="color:#f92672">=</span><span style="color:#e6db74">7</span>
</span></span></code></pre></div><p><strong>Additional Options:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Khóa tĩnh cho ECIES (tùy chọn, được tạo tự động nếu không được chỉ định)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Khóa công khai X25519 dài 32 byte, được mã hóa Base64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetPrivateKey</span><span style="color:#f92672">=</span><span style="color:#e6db74">&lt;base64-encoded-key&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Loại chữ ký (cho LeaseSet)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetSigningPrivateKey</span><span style="color:#f92672">=</span><span style="color:#e6db74">&lt;base64-encoded-key&gt; i2cp.leaseSetSigningType=7  # Ed25519</span>
</span></span></code></pre></div><h3 id="java-i2p-configuration">Java I2P Configuration</h3>
<p><strong>router.config:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># ECIES (lược đồ mã hóa tích hợp dựa trên đường cong elliptic) giữa các router</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.useECIES</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span></code></pre></div><p><strong>Build Properties:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// For I2CP clients (Java) Properties props = new Properties(); props.setProperty(&#34;i2cp.leaseSetEncType&#34;, &#34;4&#34;); props.setProperty(&#34;i2cp.leaseSetType&#34;, &#34;3&#34;);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>I2PSession session <span style="color:#f92672">=</span> i2pClient.<span style="color:#a6e22e">createSession</span>(props);
</span></span></code></pre></div><h3 id="i2pd-configuration">i2pd Configuration</h3>
<p><strong>i2pd.conf:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[giới hạn]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Giới hạn bộ nhớ cho các phiên ECIES (lược đồ mã hóa tích hợp đường cong elliptic)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ecies.memory</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">128M</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[ecies (lược đồ mã hóa tích hợp đường cong elliptic)]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Bật ECIES (lược đồ mã hóa tích hợp trên đường cong elliptic)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">enabled</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Chỉ ECIES (sơ đồ mã hóa tích hợp dùng đường cong elliptic) hoặc khóa kép</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">compatibility</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true  # true = hai khóa, false = chỉ ECIES</span>
</span></span></code></pre></div><p><strong>Tunnels Configuration:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">[my-service] type</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">http host = 127.0.0.1 port = 8080 keys = my-service-keys.dat</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Chỉ ECIES (sơ đồ mã hóa tích hợp đường cong elliptic)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ecies</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span></code></pre></div><h3 id="compatibility-matrix">Compatibility Matrix</h3>
<p><strong>Router Version Support:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Version</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">ECIES Support</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">LS2 Support</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Dual-Key</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">&lt; 0.9.38</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">❌ No</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">❌ No</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Legacy only</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0.9.38-0.9.45</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">❌ No</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">N/A</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">LS2 only</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">0.9.46-0.9.50</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Initial ECIES</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">1.5.0+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Current</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">2.0.0+</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">✅ Yes</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Current</td>
    </tr>
  </tbody>
</table>
<p><strong>Destination Compatibility:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Destination Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Can Connect To</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ECIES-only</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ECIES-only, Dual-key</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Requires 0.9.46+ routers</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Dual-key</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Any</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Maximum compatibility</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ElGamal-only</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">ElGamal-only, Dual-key</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Legacy</td>
    </tr>
  </tbody>
</table>
<p><strong>FloodFill Requirements:</strong></p>
<ul>
<li><strong>ECIES-only destinations</strong>: Require majority of floodfills on 0.9.46+ for encrypted lookups</li>
<li><strong>Dual-key destinations</strong>: Work with any floodfill version</li>
<li><strong>Current status</strong>: Near 100% floodfill adoption as of 2025</li>
</ul>
<h3 id="migration-guide">Migration Guide</h3>
<p><strong>Migrating from ElGamal to ECIES:</strong></p>
<p><strong>Step 1: Enable Dual-Key Mode</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Thêm ECIES (lược đồ mã hóa tích hợp trên đường cong elliptic) trong khi vẫn giữ ElGamal (lược đồ mã hóa ElGamal)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4,0</span>
</span></span></code></pre></div><p><strong>Step 2: Monitor Connections</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Kiểm tra các loại kết nối</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>i2prouter.exe status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># hoặc</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http://127.0.0.1:7657/peers
</span></span></code></pre></div><p><strong>Step 3: Switch to ECIES-Only (after testing)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Loại bỏ ElGamal</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">4</span>
</span></span></code></pre></div><p><strong>Step 4: Restart Application</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Khởi động lại router I2P hoặc ứng dụng</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl restart i2p
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># hoặc</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>i2prouter.exe restart
</span></span></code></pre></div><p><strong>Rollback Plan:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Quay lại chỉ dùng ElGamal (thuật toán mật mã ElGamal) nếu có vấn đề</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2cp.leaseSetEncType</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
</span></span></code></pre></div><h3 id="performance-tuning">Performance Tuning</h3>
<p><strong>Session Limits:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Số phiên đến tối đa</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.maxInboundSessions</span><span style="color:#f92672">=</span><span style="color:#e6db74">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Số phiên gửi đi tối đa</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.maxOutboundSessions</span><span style="color:#f92672">=</span><span style="color:#e6db74">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Thời gian chờ phiên (giây)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.router.sessionTimeout</span><span style="color:#f92672">=</span><span style="color:#e6db74">600</span>
</span></span></code></pre></div><p><strong>Memory Limits:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Giới hạn dung lượng lưu trữ thẻ (KB)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.maxTagMemory</span><span style="color:#f92672">=</span><span style="color:#e6db74">10240  # 10 MB</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cửa sổ nhìn trước</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.tagLookAhead</span><span style="color:#f92672">=</span><span style="color:#e6db74">160 i2p.ecies.tagLookAheadMin=32</span>
</span></span></code></pre></div><p><strong>Ratchet Policy:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Thông điệp trước khi ratchet (cơ chế luân chuyển khóa tăng dần)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.ratchetThreshold</span><span style="color:#f92672">=</span><span style="color:#e6db74">4096</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Thời gian trước khi kích hoạt ratchet (cơ chế cập nhật khóa liên tục trong mật mã) (giây)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i2p.ecies.ratchetTimeout</span><span style="color:#f92672">=</span><span style="color:#e6db74">600  # 10 phút</span>
</span></span></code></pre></div><h3 id="monitoring-and-debugging">Monitoring and Debugging</h3>
<p><strong>Logging:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#75715e"># Bật ghi nhật ký gỡ lỗi ECIES (lược đồ mã hóa tích hợp đường cong elliptic)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">logger.i2p.router.transport.ecies</span><span style="color:#f92672">=</span><span style="color:#e6db74">DEBUG</span>
</span></span></code></pre></div><p><strong>Metrics:</strong></p>
<p>Monitor these metrics:</p>
<ol>
<li><strong>NS Success Rate</strong>: Percentage of NS messages receiving NSR</li>
<li><strong>Session Establishment Time</strong>: Time from NS to first ES</li>
<li><strong>Tag Storage Usage</strong>: Current memory usage for tags</li>
<li><strong>Ratchet Frequency</strong>: How often sessions ratchet</li>
<li><strong>Session Lifetime</strong>: Average session duration</li>
</ol>
<p><strong>Common Issues:</strong></p>
<ol>
<li>
<p><strong>NS Timeout</strong>: No NSR received</p>
<ul>
<li>Check destination is online</li>
<li>Check floodfill availability</li>
<li>Verify LeaseSet published correctly</li>
</ul>
</li>
<li>
<p><strong>High Memory Usage</strong>: Too many tags stored</p>
<ul>
<li>Reduce look-ahead window</li>
<li>Decrease session timeout</li>
<li>Implement aggressive expiration</li>
</ul>
</li>
<li>
<p><strong>Frequent Ratchets</strong>: Sessions ratcheting too often</p>
<ul>
<li>Increase ratchet threshold</li>
<li>Check for retransmissions</li>
</ul>
</li>
<li>
<p><strong>Session Failures</strong>: ES messages failing to decrypt</p>
<ul>
<li>Verify tag synchronization</li>
<li>Check for replay attacks</li>
<li>Validate nonce construction</li>
</ul>
</li>
</ol>
<hr>
<h2 id="references">References</h2>
<h3 id="specifications">Specifications</h3>
<ol>
<li><strong>ECIES Proposal</strong>: <a href="../../../../vi/proposals/144-ecies-x25519-aead-ratchet/">Proposal 144</a>
</li>
<li><strong>I2NP</strong>: <a href="../../../../vi/docs/specs/i2np/">I2NP Specification</a>
</li>
<li><strong>Common Structures</strong>: <a href="../../../../vi/docs/specs/common-structures/">Common Structures Specification</a>
</li>
<li><strong>NTCP2</strong>: <a href="../../../../vi/docs/specs/ntcp2/">NTCP2 Specification</a>
</li>
<li><strong>SSU2</strong>: <a href="../../../../vi/docs/specs/ssu2/">SSU2 Specification</a>
</li>
<li><strong>I2CP</strong>: <a href="../../../../vi/docs/specs/i2cp/">I2CP Specification</a>
</li>
<li><strong>ElGamal/AES+SessionTags</strong>: <a href="../../../../vi/docs/legacy/elgamal-aes/">ElGamal/AES Specification</a>
</li>
</ol>
<h3 id="cryptographic-standards">Cryptographic Standards</h3>
<ol>
<li><strong>Noise Protocol Framework</strong>: <a href="https://noiseprotocol.org/noise.html">Noise Specification</a>
 (Revision 34, 2018-07-11)</li>
<li><strong>Signal Double Ratchet</strong>: <a href="https://signal.org/docs/specifications/doubleratchet/">Signal Specification</a>
</li>
<li><strong>RFC 7748</strong>: <a href="https://tools.ietf.org/html/rfc7748">Elliptic Curves for Security (X25519)</a>
</li>
<li><strong>RFC 7539</strong>: <a href="https://tools.ietf.org/html/rfc7539">ChaCha20 and Poly1305 for IETF Protocols</a>
</li>
<li><strong>RFC 5869</strong>: <a href="https://tools.ietf.org/html/rfc5869">HKDF (HMAC-based Key Derivation Function)</a>
</li>
<li><strong>RFC 2104</strong>: <a href="https://tools.ietf.org/html/rfc2104">HMAC: Keyed-Hashing for Message Authentication</a>
</li>
<li><strong>Elligator2</strong>: <a href="https://elligator.cr.yp.to/elligator-20130828.pdf">Elligator Paper</a>
</li>
</ol>
<h3 id="implementation-resources">Implementation Resources</h3>
<ol>
<li><strong>Java I2P</strong>: <a href="https://github.com/i2p/i2p.i2p">i2p.i2p Repository</a>
</li>
<li><strong>i2pd (C++)</strong>: <a href="https://github.com/PurpleI2P/i2pd">i2pd Repository</a>
</li>
<li><strong>OBFS4 (Elligator2)</strong>: <a href="https://gitlab.com/yawning/obfs4">obfs4proxy Repository</a>
</li>
</ol>
<h3 id="additional-information">Additional Information</h3>
<ol>
<li><strong>I2P Website</strong>: <a href="../../../../vi/">/</a>
</li>
<li><strong>I2P Forum</strong>: <a href="https://i2pforum.net">https://i2pforum.net</a>
</li>
<li><strong>I2P Wiki</strong>: <a href="https://wiki.i2p-projekt.de">https://wiki.i2p-projekt.de</a>
</li>
</ol>
<hr>
<h2 id="appendix-a-kdf-summary">Appendix A: KDF Summary</h2>
<p><strong>All KDF Operations in ECIES:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Operation</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Input</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Info String</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Output</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NS Initial ChainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">protocol_name</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">(none - SHA256)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">h, chainKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NS Static Key Section</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, es_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, k</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NS Payload Section (bound)</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, ss_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, k</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR Tagset</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"SessionReplyTags"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">tagsetKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR ee DH</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, ee_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR se DH</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, se_shared</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, k</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR Split</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">""</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">k_ab, k_ba</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">NSR Payload</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">k_ba</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"AttachPayloadKDF"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">k_nsr</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DH Initialize</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">rootKey, k</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"KDFDHRatchetStep"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">nextRootKey, chainKey</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Tag and Key Chain Keys</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"TagAndKeyGenKeys"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">sessTag_ck, symmKey_ck</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session Tag Init</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">sessTag_ck</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"STInitialization"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, CONSTANT</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Session Tag Gen</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, CONSTANT</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"SessionTagKeyGen"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, tag</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">Symmetric Key Gen</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"SymmetricRatchet"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">chainKey, key</td>
    </tr>
    <tr>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">DH Ratchet</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">sharedSecret</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">"XDHRatchetTagSet"</td>
      <td style="border:1px solid var(--color-border); padding:0.5rem;">tagsetKey</td>
    </tr>
  </tbody>
</table>
<hr>
<h2 id="appendix-b-message-size-calculator">Appendix B: Message Size Calculator</h2>
<p><strong>Calculate message sizes for capacity planning:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_ns_size</span>(payload_size, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Calculate New Session message size&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    ephemeral_key <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    static_section <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># encrypted + MAC</span>
</span></span><span style="display:flex;"><span>    payload_encrypted <span style="color:#f92672">=</span> payload_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># + MAC</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ephemeral_key <span style="color:#f92672">+</span> static_section <span style="color:#f92672">+</span> payload_encrypted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_nsr_size</span>(payload_size):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Calculate New Session Reply message size&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    tag <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    ephemeral_key <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    key_section_mac <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>    payload_encrypted <span style="color:#f92672">=</span> payload_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># + MAC</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tag <span style="color:#f92672">+</span> ephemeral_key <span style="color:#f92672">+</span> key_section_mac <span style="color:#f92672">+</span> payload_encrypted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_es_size</span>(payload_size):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Calculate Existing Session message size&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    tag <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    payload_encrypted <span style="color:#f92672">=</span> payload_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>  <span style="color:#75715e"># + MAC</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tag <span style="color:#f92672">+</span> payload_encrypted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Ví dụ</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;NS (bound, 1KB payload):&#34;</span>, calculate_ns_size(<span style="color:#ae81ff">1024</span>, bound<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>), <span style="color:#e6db74">&#34;bytes&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Đầu ra: 1120 byte</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;NSR (1KB payload):&#34;</span>, calculate_nsr_size(<span style="color:#ae81ff">1024</span>), <span style="color:#e6db74">&#34;bytes&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Đầu ra: 1096 byte</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;ES (tải trọng 1KB):&#34;</span>, calculate_es_size(<span style="color:#ae81ff">1024</span>), <span style="color:#e6db74">&#34;byte&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Đầu ra: 1048 byte</span>
</span></span></code></pre></div><hr>
<h2 id="appendix-c-glossary">Appendix C: Glossary</h2>
<p><strong>AEAD</strong>: Authenticated Encryption with Associated Data - encryption mode that provides both confidentiality and authenticity</p>
<p><strong>Authentication Level</strong>: Noise protocol security property indicating strength of sender identity verification</p>
<p><strong>Binding</strong>: Association of a session with a specific far-end destination</p>
<p><strong>ChaCha20</strong>: Stream cipher designed by Daniel J. Bernstein</p>
<p><strong>ChainKey</strong>: Cryptographic key used in HKDF chains to derive subsequent keys</p>
<p><strong>Confidentiality Level</strong>: Noise protocol security property indicating strength of forward secrecy</p>
<p><strong>DH</strong>: Diffie-Hellman key agreement protocol</p>
<p><strong>Elligator2</strong>: Encoding technique to make elliptic curve points indistinguishable from random</p>
<p><strong>Ephemeral Key</strong>: Short-lived key used only for a single handshake</p>
<p><strong>ES</strong>: Existing Session message (used after handshake completion)</p>
<p><strong>Forward Secrecy</strong>: Property ensuring past communications remain secure if keys are compromised</p>
<p><strong>Garlic Clove</strong>: I2NP message container for end-to-end delivery</p>
<p><strong>HKDF</strong>: HMAC-based Key Derivation Function</p>
<p><strong>IK Pattern</strong>: Noise handshake pattern where initiator sends static key immediately</p>
<p><strong>KCI</strong>: Key Compromise Impersonation attack</p>
<p><strong>KDF</strong>: Key Derivation Function - cryptographic function for generating keys from other keys</p>
<p><strong>LeaseSet</strong>: I2P structure containing a destination&rsquo;s public keys and tunnel information</p>
<p><strong>LS2</strong>: LeaseSet version 2 with encryption type support</p>
<p><strong>MAC</strong>: Message Authentication Code - cryptographic checksum proving authenticity</p>
<p><strong>MixHash</strong>: Noise protocol function for maintaining running hash transcript</p>
<p><strong>NS</strong>: New Session message (initiates new session)</p>
<p><strong>NSR</strong>: New Session Reply message (response to NS)</p>
<p><strong>Nonce</strong>: Number used once - ensures unique encryption even with same key</p>
<p><strong>Pairing</strong>: Linking an inbound session with an outbound session for bidirectional communication</p>
<p><strong>Poly1305</strong>: Message authentication code designed by Daniel J. Bernstein</p>
<p><strong>Ratchet</strong>: Cryptographic mechanism for deriving sequential keys</p>
<p><strong>Session Tag</strong>: 8-byte one-time identifier for existing session messages</p>
<p><strong>Static Key</strong>: Long-term key associated with a destination&rsquo;s identity</p>
<p><strong>Tag Set</strong>: Collection of session tags derived from a common root</p>
<p><strong>X25519</strong>: Elliptic curve Diffie-Hellman key agreement using Curve25519</p>
<hr>

                </article>

                
                <nav class="page-nav">
                    
                        <a href="../../../../vi/docs/specs/ssu2/" class="page-nav-link prev">
                            <span class="nav-label">← Previous</span>
                            <span class="nav-title">Đặc tả SSU2</span>
                        </a>
                    
                    
                        <a href="../../../../vi/docs/specs/updates/" class="page-nav-link next">
                            <span class="nav-label">Next →</span>
                            <span class="nav-title">Đặc tả cập nhật phần mềm</span>
                        </a>
                    
                </nav>

                
                <div class="docs-feedback">
                    <p>Was this page helpful?</p>
                    <div class="feedback-buttons" id="feedback-buttons">
                        <button class="feedback-btn" id="feedback-yes">👍 Yes</button>
                        <button class="feedback-btn" id="feedback-no">👎 No</button>
                    </div>

                    
                    <div class="feedback-form-container" id="feedback-form-container" style="display: none;">
                        <p class="feedback-form-title">We're sorry to hear that. How can we improve this page?</p>
                        <form id="feedback-form">
                            <div class="form-group">
                                <label for="feedback-email">Email (optional - if you'd like a response)</label>
                                <input type="email" id="feedback-email" name="email" placeholder="your@email.com">
                            </div>
                            <div class="form-group">
                                <label for="feedback-message">Feedback *</label>
                                <textarea id="feedback-message" name="message" rows="4" required placeholder="Tell us what we can improve..."></textarea>
                            </div>
                            <button type="submit" class="btn-submit-feedback" id="feedback-submit-btn">
                                <span class="btn-text">Submit Feedback</span>
                                <span class="btn-loading" style="display: none;">Sending...</span>
                            </button>
                        </form>
                    </div>

                    
                    <div class="feedback-message" id="feedback-success" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/>
                        </svg>
                        <span id="feedback-success-text">Thanks for your feedback!</span>
                    </div>
                    <div class="feedback-message feedback-error" id="feedback-error" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path d="M12 8v4M12 16h.01" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span id="feedback-error-text">Something went wrong. Please try again.</span>
                    </div>

                    <p class="feedback-note">
                        Found an issue? <a href="https://gitlab.com/stormycloud-group/i-2-p-www-v-2/-/blob/main/hugo-site/content/vi/docs/specs/ecies.md?ref_type=heads" target="_blank">Edit this page on GitLab</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.docs-page {
    min-height: 100vh;
    padding: var(--spacing-xl) 0;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
}

.breadcrumbs a:hover {
    color: var(--color-primary);
}

.separator {
    color: var(--color-border);
}

.current {
    color: var(--color-text);
}

 
.translation-disclaimer {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.dark .translation-disclaimer {
    background: #78350f;
    border-color: #d97706;
}

.disclaimer-message {
    color: #92400e;
    font-size: 0.875rem;
}

.dark .disclaimer-message {
    color: #fde047;
}

.disclaimer-link {
    color: #92400e;
    font-weight: 600;
    text-decoration: underline;
    white-space: nowrap;
}

.dark .disclaimer-link {
    color: #fde047;
}

 
.article-header {
    margin-bottom: var(--spacing-2xl);
}

.article-title {
    font-size: 2.5rem;
    margin: 0 0 var(--spacing-md) 0;
    color: var(--color-text);
}

.article-description {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-md);
}

.article-meta {
    display: flex;
    gap: var(--spacing-lg);
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.meta-item svg {
    color: var(--color-primary);
}

 
.docs-layout {
    display: block;
}

.docs-layout--with-toc {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

 
.docs-toc-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.toc-nav {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
}

.toc-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-text);
    padding-bottom: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.toc-content {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
}

.toc-content::-webkit-scrollbar {
    width: 4px;
}

.toc-content::-webkit-scrollbar-track {
    background: transparent;
}

.toc-content::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
}

.toc-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

.toc-nav ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc-nav li {
    margin-bottom: 0.25rem;
}

.toc-nav ul ul {
    padding-left: var(--spacing-md);
    margin-top: 0.25rem;
}

.toc-nav a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.8125rem;
    display: block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    line-height: 1.4;
}

.toc-nav a:hover {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
}

 
.docs-main {
    min-width: 0;
    max-width: 900px;
}

 
.article-content {
    line-height: 1.8;
    color: var(--color-text);
}

.article-content h2 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.75rem;
    scroll-margin-top: 100px;
}

.article-content h3 {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.375rem;
    scroll-margin-top: 100px;
}

.article-content h4 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-xs);
    font-size: 1.125rem;
    scroll-margin-top: 100px;
}

.article-content p {
    margin-bottom: var(--spacing-md);
}

.article-content ul,
.article-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.article-content li {
    margin-bottom: var(--spacing-xs);
}

.article-content code {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
}

.article-content pre {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: var(--spacing-md);
}

.article-content pre code {
    background: none;
    padding: 0;
}

.article-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin: var(--spacing-lg) 0;
    display: block;
}

.article-content a {
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
}

.article-content a:hover {
    border-bottom-color: var(--color-primary);
}

 
.page-nav {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
}

.page-nav-link {
    display: flex;
    flex-direction: column;
    padding: var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.page-nav-link:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
}

.page-nav-link.next {
    text-align: right;
}

.nav-label {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xs);
}

.nav-title {
    font-weight: 600;
    color: var(--color-text);
}

 
.docs-feedback {
    margin-top: var(--spacing-2xl);
    padding: var(--spacing-lg);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    text-align: center;
}

.feedback-buttons {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    margin: var(--spacing-md) 0;
}

.feedback-btn {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.feedback-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-primary);
    color: white;
}

.feedback-note {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-top: var(--spacing-md);
}

.feedback-note a {
    color: var(--color-primary);
    text-decoration: none;
}

.feedback-note a:hover {
    text-decoration: underline;
}

 
.feedback-form-container {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-align: left;
}

.feedback-form-title {
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--color-text);
}

.form-group {
    margin-bottom: var(--spacing-md);
}

.form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
    color: var(--color-text);
}

.form-group input[type="email"],
.form-group textarea {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    color: var(--color-text);
    font-family: inherit;
    font-size: 0.9375rem;
    transition: border-color var(--transition-fast);
}

.form-group input[type="email"]:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.btn-submit-feedback {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-submit-feedback:hover:not(:disabled) {
    background: var(--color-primary-dark);
    transform: translateY(-1px);
}

.btn-submit-feedback:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

 
.feedback-message {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: #d1fae5;
    color: #065f46;
    border-radius: var(--radius-md);
    margin-top: var(--spacing-md);
}

.feedback-message.feedback-error {
    background: #fee2e2;
    color: #991b1b;
}

.feedback-message svg {
    flex-shrink: 0;
}

 
@media (max-width: 1024px) {
    .docs-layout--with-toc {
        grid-template-columns: 1fr;
    }

    .docs-toc-sidebar {
        position: static;
        max-height: none;
        margin-bottom: var(--spacing-xl);
    }

    .toc-content {
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .article-title {
        font-size: 1.75rem;
    }
}
</style>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = [];

    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const heading = document.getElementById(href.slice(1));
            if (heading) {
                headings.push({ element: heading, link: link });
            }
        }
    });

    function updateActiveLink() {
        const scrollPos = window.scrollY + 120;
        let activeIndex = 0;

        for (let i = 0; i < headings.length; i++) {
            if (headings[i].element.offsetTop <= scrollPos) {
                activeIndex = i;
            }
        }

        tocLinks.forEach(link => link.classList.remove('active'));
        if (headings[activeIndex]) {
            headings[activeIndex].link.classList.add('active');
        }
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});
</script>
<style>
.toc-nav a.active {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
    font-weight: 600;
}
</style>



<script>
(function() {
    'use strict';
    
    
    let baseUrl = window.feedbackBaseUrl;
    if (!baseUrl) {
        const hostname = window.location.hostname;
        
        if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
            baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
        } else if (hostname.endsWith('.onion')) {
            baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
        } else {
            baseUrl = 'https://feedback.i2p.net';
        }
    }
    
    const script = document.createElement('script');
    script.src = baseUrl + '/widgets/docs-feedback.js';
    script.async = true;
    script.onerror = function() {
        console.error('[Docs Feedback] Failed to load docs-feedback.js from:', baseUrl);
    };
    document.body.appendChild(script);
})();
</script>


    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">Cập nhật tin tức I2P:</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="Nhập email của bạn" required>
                            <button type="submit">Đăng ký</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>Liên kết nhanh</h3>
                <ul>
                    <li><a href="../../../../vi/financial-support/">Quyên góp</a></li>
                    <li><a href="../../../../vi/docs/overview/intro/">Giới thiệu I2P</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Cộng đồng</h3>
                <ul>
                    <li><a href="../../../../vi/get-involved/">Tham Gia</a></li>
                    <li><a href="../../../../vi/blog/">Blog</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">Diễn đàn chính thức</a></li>
                    <li><a href="../../../../vi/contact/">Liên hệ</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Tài nguyên</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">Thống kê I2P</a></li>
                    <li><a href="../../../../vi/papers/">Nghiên cứu</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">StormyCloud</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 Dự án Internet Vô hình. Được cấp phép theo Creative Commons.</p>
            <div class="footer-links">
                <a href="../../../../vi/privacy/">Quyền riêng tư</a>
                <a href="../../../../vi/terms/">Điều khoản</a>
                <a href="../../../../vi/about/media/">Báo chí</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="Đóng">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>Thăm dò ý kiến cộng đồng</h2>
            <p class="modal-subtitle">Chúng tôi rất muốn nghe ý kiến từ bạn</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                Phiếu bầu của bạn giúp định hình tương lai của I2P.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
<!DOCTYPE html>
<html lang="zh" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>后量子密码协议 | I2P - 隐形互联网项目</title>

    <meta name="description" content="The Invisible Internet Project - A privacy-focused, anonymous network layer">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="后量子密码协议 | I2P - 隐形互联网项目">
    <meta property="og:description" content="The Invisible Internet Project - A privacy-focused, anonymous network layer">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/zh/proposals/169-pq-crypto/">

    
    <link rel="icon" type="image/svg+xml" href="../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">I2P 测试版网站现已上线 电子邮件问题请发送至 stormycloud@mail.i2p</span>
            
        </div>
        
        <form method="GET" action="../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="关闭横幅" title="关闭横幅">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../zh/" class="logo-link">
                    <img src="../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../zh/about/" class="">关于</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../zh/about/">概览</a></li>
                            <li><a href="../../../zh/papers/">研究论文</a></li>
                            <li><a href="../../../zh/about/media/">媒体</a></li>
                            <li><a href="../../../zh/contact/">联系我们</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../zh/docs/" class="">文档</a></li>
                    <li><a href="../../../zh/downloads/" class="">下载</a></li>
                    <li><a href="../../../zh/blog/" class="">博客</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../zh/get-involved/" class="">参与其中</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../zh/get-involved/">概览</a></li>
                            <li><a href="../../../zh/feedback/">功能建议</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">zh</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../en/proposals/169-pq-crypto/"
                                class="lang-option">英语</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../es/proposals/169-pq-crypto/"
                                class="lang-option">西班牙语</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ko/proposals/169-pq-crypto/"
                                class="lang-option">韩语</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../zh/proposals/169-pq-crypto/"
                                class="lang-option active">中文</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ru/proposals/169-pq-crypto/"
                                class="lang-option">俄语</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../cs/proposals/169-pq-crypto/"
                                class="lang-option">捷克语</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../de/proposals/169-pq-crypto/"
                                class="lang-option">德语</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../fr/proposals/169-pq-crypto/"
                                class="lang-option">法语</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../tr/proposals/169-pq-crypto/"
                                class="lang-option">土耳其语</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../vi/proposals/169-pq-crypto/"
                                class="lang-option">越南语</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../hi/proposals/169-pq-crypto/"
                                class="lang-option">印地语</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../ar/proposals/169-pq-crypto/"
                                class="lang-option">阿拉伯语</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../pt/proposals/169-pq-crypto/"
                                class="lang-option">葡萄牙语</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../zh/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../zh/downloads/" class="btn btn-primary">获取I2P</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        



<div class="proposals-page">
    <div class="container">
        
        <nav class="breadcrumbs">
            <a href="../../../zh/">Home</a>
            <span class="separator">/</span>
            <a href="../../../zh/proposals/">Proposals</a>
            <span class="separator">/</span>
            <span class="current">后量子密码协议</span>
        </nav>

        
<div class="translation-disclaimer" role="note">
    <span class="disclaimer-message">此翻译是使用机器学习生成的，可能不是100%准确。</span>
    
    
    <a href="../../../en/proposals/169-pq-crypto/" class="disclaimer-link">查看英文版本</a>
    
</div>



        
        <header class="proposal-header">
            <div class="proposal-title-section">
                <h1 class="proposal-title">后量子密码协议</h1>
                <div class="proposal-number">Proposal 169</div>
            </div>

            
            <div class="proposal-meta-box">
                <div class="proposal-status status-打开">
                    打开
                </div>

                
                <div class="proposal-info-grid">
                    
                    <div class="info-item">
                        <span class="info-label">Author</span>
                        <span class="info-value">zzz, orignal, drzed, eyedeekay</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Created</span>
                        <span class="info-value">2025-01-21</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Last Updated</span>
                        <span class="info-value">2025-06-12</span>
                    </div>
                    

                    
                    <div class="info-item">
                        <span class="info-label">Target Version</span>
                        <span class="info-value">0.9.80</span>
                    </div>
                    

                    
                </div>

                
                
            </div>
        </header>

        
        <div class="proposal-layout proposal-layout--with-toc">
            
            
            <aside class="proposal-toc-sidebar">
                <nav class="toc-nav">
                    <div class="toc-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        On This Page
                    </div>
                    <div class="toc-content">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#概述">概述</a></li>
    <li><a href="#目标">目标</a></li>
    <li><a href="#非目标">非目标</a></li>
    <li><a href="#威胁模型">威胁模型</a></li>
    <li><a href="#受影响的协议">受影响的协议</a></li>
    <li><a href="#设计">设计</a>
      <ul>
        <li><a href="#key-exchange">Key Exchange</a></li>
        <li><a href="#signatures">Signatures</a></li>
        <li><a href="#legal-combinations">Legal Combinations</a></li>
        <li><a href="#new-crypto-required">New Crypto Required</a></li>
        <li><a href="#alternatives">Alternatives</a></li>
        <li><a href="#rosenpass">Rosenpass</a></li>
      </ul>
    </li>
    <li><a href="#specification">Specification</a>
      <ul>
        <li><a href="#密钥交换">密钥交换</a></li>
        <li><a href="#签名">签名</a></li>
        <li><a href="#合法组合">合法组合</a></li>
        <li><a href="#需要新的加密算法">需要新的加密算法</a></li>
        <li><a href="#替代方案">替代方案</a></li>
        <li><a href="#rosenpass-1">Rosenpass</a></li>
        <li><a href="#key-certificates">Key Certificates</a></li>
        <li><a href="#通用结构">通用结构</a></li>
        <li><a href="#publickey">PublicKey</a></li>
        <li><a href="#私钥">私钥</a></li>
        <li><a href="#signingpublickey">SigningPublicKey</a></li>
        <li><a href="#signingprivatekey签名私钥">SigningPrivateKey（签名私钥）</a></li>
        <li><a href="#签名-1">签名</a></li>
        <li><a href="#密钥证书">密钥证书</a></li>
        <li><a href="#目标地址大小">目标地址大小</a></li>
        <li><a href="#routerident-大小">RouterIdent 大小</a></li>
        <li><a href="#握手模式">握手模式</a></li>
      </ul>
    </li>
    <li><a href="#overhead-analysis">Overhead Analysis</a>
      <ul>
        <li><a href="#noise-握手密钥派生函数">Noise 握手密钥派生函数</a></li>
        <li><a href="#signatures-1">Signatures</a></li>
      </ul>
    </li>
    <li><a href="#security-analysis">Security Analysis</a>
      <ul>
        <li><a href="#handshakes">Handshakes</a></li>
        <li><a href="#signatures-2">Signatures</a></li>
      </ul>
    </li>
    <li><a href="#type-preferences">Type Preferences</a></li>
    <li><a href="#implementation-notes">Implementation Notes</a>
      <ul>
        <li><a href="#library-support">Library Support</a></li>
        <li><a href="#signing-variants">Signing Variants</a></li>
        <li><a href="#reliability">Reliability</a></li>
        <li><a href="#structure-sizes">Structure Sizes</a></li>
        <li><a href="#netdb">NetDB</a></li>
        <li><a href="#ratchet">Ratchet</a></li>
        <li><a href="#ratchet-1">Ratchet</a></li>
        <li><a href="#ssu2">SSU2</a></li>
      </ul>
    </li>
    <li><a href="#router-compatibility">Router Compatibility</a>
      <ul>
        <li><a href="#transport-names">Transport Names</a></li>
        <li><a href="#router-enc-types">Router Enc. Types</a></li>
        <li><a href="#ntcp2">NTCP2</a></li>
        <li><a href="#ls-enc-types">LS Enc. Types</a></li>
        <li><a href="#dest-sig-types">Dest. Sig. Types</a></li>
      </ul>
    </li>
    <li><a href="#规范">规范</a></li>
    <li><a href="#migration">Migration</a></li>
    <li><a href="#issues-1">Issues</a></li>
  </ul>
</nav>
                    </div>
                </nav>
            </aside>
            

            
            <div class="proposal-main">
                <article class="proposal-content">
                    <h2 id="概述">概述</h2>
<p>虽然对合适的后量子(PQ)密码学的研究和竞争已经进行了十年，但直到最近选择才变得明确。</p>
<p>我们在 2022 年开始研究 PQ 密码学的影响 <a href="http://zzz.i2p/topics/3294">zzz.i2p</a>
。</p>
<p>在过去两年中，TLS 标准增加了混合加密支持，由于 Chrome 和 Firefox 的支持，现在它已被用于互联网上很大一部分的加密流量 <a href="https://blog.cloudflare.com/pq-2024/">Cloudflare</a>
。</p>
<p>美国国家标准与技术研究院（NIST）最近完成并发布了后量子密码学的推荐算法 <a href="https://www.nist.gov/news-events/news/2024/08/nist-releases-first-3-finalized-post-quantum-encryption-standards">NIST</a>
。多个常见的密码学库现已支持NIST标准，或将在不久的将来发布相关支持。</p>
<p><a href="https://blog.cloudflare.com/pq-2024/">Cloudflare</a>
 和 <a href="https://www.nist.gov/news-events/news/2024/08/nist-releases-first-3-finalized-post-quantum-encryption-standards">NIST</a>
 都建议立即开始迁移。另请参阅2022年NSA后量子常见问题解答 <a href="https://media.defense.gov/2022/Sep/07/2003071836/-1/-1/0/CSI_CNSA_2.0_FAQ_.PDF">NSA</a>
。I2P应该在安全和密码学方面成为领导者。现在是实施推荐算法的时候了。使用我们灵活的加密类型和签名类型系统，我们将为混合加密以及后量子和混合签名添加类型。</p>
<h2 id="目标">目标</h2>
<ul>
<li>选择抗量子算法</li>
<li>在适当的 I2P 协议中添加纯量子和混合算法</li>
<li>定义多个变体</li>
<li>在实施、测试、分析和研究后选择最佳变体</li>
<li>增量添加支持并保持向后兼容性</li>
</ul>
<h2 id="非目标">非目标</h2>
<ul>
<li>不要更改单向（Noise N）加密协议</li>
<li>不要放弃 SHA256，它在近期内不会受到 PQ 的威胁</li>
<li>目前不要选择最终的首选变体</li>
</ul>
<h2 id="威胁模型">威胁模型</h2>
<ul>
<li>OBEP 或 IBGW 处的 router，可能串通合作，
存储 garlic 消息以供后续解密（前向保密）</li>
<li>网络观察者
存储传输消息以供后续解密（前向保密）</li>
<li>网络参与者为 RI、LS、流传输、数据报
或其他结构伪造签名</li>
</ul>
<h2 id="受影响的协议">受影响的协议</h2>
<p>我们将按照大致的开发顺序修改以下协议。整体推广时间可能从2025年底到2027年中期。详情请参见下面的优先级和推广部分。</p>
<table>
  <thead>
      <tr>
          <th>Protocol / Feature</th>
          <th>Status</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Hybrid MLKEM Ratchet and LS</td>
          <td>Approved 2026-06; beta target 2025-08; release target 2025-11</td>
      </tr>
      <tr>
          <td>Hybrid MLKEM NTCP2</td>
          <td>Some details to be finalized</td>
      </tr>
      <tr>
          <td>Hybrid MLKEM SSU2</td>
          <td>Some details to be finalized</td>
      </tr>
      <tr>
          <td>MLDSA SigTypes 12-14</td>
          <td>Proposal is stable but may not be finalized until 2026</td>
      </tr>
      <tr>
          <td>MLDSA Dests</td>
          <td>Tested on live net, requires net upgrade for floodfill support</td>
      </tr>
      <tr>
          <td>Hybrid SigTypes 15-17</td>
          <td>Preliminary</td>
      </tr>
      <tr>
          <td>Hybrid Dests</td>
          <td></td>
      </tr>
  </tbody>
</table>
<h2 id="设计">设计</h2>
<p>我们将支持 NIST FIPS 203 和 204 标准 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf">FIPS 203</a>
 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf">FIPS 204</a>
，这些标准基于 CRYSTALS-Kyber 和 CRYSTALS-Dilithium（版本 3.1、3 及更早版本），但与其不兼容。</p>
<h3 id="key-exchange">Key Exchange</h3>
<p>我们将在以下协议中支持混合密钥交换：</p>
<table>
  <thead>
      <tr>
          <th>Proto</th>
          <th>Noise Type</th>
          <th>Support PQ only?</th>
          <th>Support Hybrid?</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>NTCP2</td>
          <td>XK</td>
          <td>no</td>
          <td>yes</td>
      </tr>
      <tr>
          <td>SSU2</td>
          <td>XK</td>
          <td>no</td>
          <td>yes</td>
      </tr>
      <tr>
          <td>Ratchet</td>
          <td>IK</td>
          <td>no</td>
          <td>yes</td>
      </tr>
      <tr>
          <td>TBM</td>
          <td>N</td>
          <td>no</td>
          <td>no</td>
      </tr>
      <tr>
          <td>NetDB</td>
          <td>N</td>
          <td>no</td>
          <td>no</td>
      </tr>
      <tr>
          <td>PQ KEM 仅提供临时密钥，不直接支持静态密钥握手，如 Noise XK 和 IK。</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>Noise N 不使用双向密钥交换，因此不适用于混合加密。</p>
<p>因此，我们将仅支持混合加密，用于 NTCP2、SSU2 和 Ratchet。我们将按照 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf">FIPS 203</a>
 中的定义来定义三种 ML-KEM 变体，总共新增 3 种加密类型。混合类型仅与 X25519 结合定义。</p>
<p>新的加密类型包括：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Code</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MLKEM512_X25519</td>
          <td>5</td>
      </tr>
      <tr>
          <td>MLKEM768_X25519</td>
          <td>6</td>
      </tr>
      <tr>
          <td>MLKEM1024_X25519</td>
          <td>7</td>
      </tr>
      <tr>
          <td>开销将会很大。典型的消息 1 和 2 大小（对于 XK 和 IK）目前约为 100 字节（在任何额外载荷之前）。根据算法不同，这将增加 8 到 15 倍。</td>
          <td></td>
      </tr>
  </tbody>
</table>
<h3 id="signatures">Signatures</h3>
<p>我们将在以下结构中支持 PQ 和混合签名：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Support PQ only?</th>
          <th>Support Hybrid?</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>RouterInfo</td>
          <td>yes</td>
          <td>yes</td>
      </tr>
      <tr>
          <td>LeaseSet</td>
          <td>yes</td>
          <td>yes</td>
      </tr>
      <tr>
          <td>Streaming SYN/SYNACK/Close</td>
          <td>yes</td>
          <td>yes</td>
      </tr>
      <tr>
          <td>Repliable Datagrams</td>
          <td>yes</td>
          <td>yes</td>
      </tr>
      <tr>
          <td>Datagram2 (prop. 163)</td>
          <td>yes</td>
          <td>yes</td>
      </tr>
      <tr>
          <td>I2CP create session msg</td>
          <td>yes</td>
          <td>yes</td>
      </tr>
      <tr>
          <td>SU3 files</td>
          <td>yes</td>
          <td>yes</td>
      </tr>
      <tr>
          <td>X.509 certificates</td>
          <td>yes</td>
          <td>yes</td>
      </tr>
      <tr>
          <td>Java keystores</td>
          <td>yes</td>
          <td>yes</td>
      </tr>
      <tr>
          <td>因此我们将支持仅PQ和混合签名两种方式。我们将定义三个ML-DSA变体，如<a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf">FIPS 204</a>
中所述，三个与Ed25519结合的混合变体，以及三个仅用于SU3文件的带预哈希的仅PQ变体，总共9种新的签名类型。混合类型仅与Ed25519结合定义。我们将使用标准ML-DSA，而非预哈希变体(HashML-DSA)，除了SU3文件。</td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>我们将使用&quot;对冲&quot;或随机化签名变体，而不是&quot;确定性&quot;变体，如 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf">FIPS 204</a>
 第3.4节所定义。这确保了每个签名都是不同的，即使是对相同数据进行签名，并提供了针对侧信道攻击的额外保护。有关算法选择（包括编码和上下文）的更多详细信息，请参阅下面的实现说明部分。</p>
<p>新的签名类型包括：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Code</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MLDSA44</td>
          <td>12</td>
      </tr>
      <tr>
          <td>MLDSA65</td>
          <td>13</td>
      </tr>
      <tr>
          <td>MLDSA87</td>
          <td>14</td>
      </tr>
      <tr>
          <td>MLDSA44_EdDSA_SHA512_Ed25519</td>
          <td>15</td>
      </tr>
      <tr>
          <td>MLDSA65_EdDSA_SHA512_Ed25519</td>
          <td>16</td>
      </tr>
      <tr>
          <td>MLDSA87_EdDSA_SHA512_Ed25519</td>
          <td>17</td>
      </tr>
      <tr>
          <td>MLDSA44ph</td>
          <td>18</td>
      </tr>
      <tr>
          <td>MLDSA65ph</td>
          <td>19</td>
      </tr>
      <tr>
          <td>MLDSA87ph</td>
          <td>20</td>
      </tr>
      <tr>
          <td>X.509证书和其他DER编码将使用<a href="https://datatracker.ietf.org/doc/draft-ietf-lamps-pq-composite-sigs/">IETF draft</a>
中定义的复合结构和OID。</td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>开销将会相当大。典型的 Ed25519 destination 和 router identity 大小为 391 字节。根据算法不同，这些将增加 3.5 倍到 6.8 倍。Ed25519 签名为 64 字节。根据算法不同，这些将增加 38 倍到 76 倍。典型的已签名 RouterInfo、LeaseSet、可回复数据报和已签名流消息约为 1KB。根据算法不同，这些将增加 3 倍到 8 倍。</p>
<p>由于新的目标地址和 router 身份类型将不包含填充，它们将不可压缩。在传输过程中经过 gzip 压缩的目标地址和 router 身份的大小将根据算法增加 12 倍至 38 倍。</p>
<h3 id="legal-combinations">Legal Combinations</h3>
<p>对于 Destinations，新的签名类型支持 leaseset 中的所有加密类型。将密钥证书中的加密类型设置为 NONE (255)。</p>
<p>对于 RouterIdentities，ElGamal 加密类型已被弃用。新的签名类型仅支持 X25519（类型 4）加密。新的加密类型将在 RouterAddresses 中标明。密钥证书中的加密类型将继续为类型 4。</p>
<h3 id="new-crypto-required">New Crypto Required</h3>
<ul>
<li>ML-KEM（原名 CRYSTALS-Kyber）<a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf">FIPS 203</a>
</li>
<li>ML-DSA（原名 CRYSTALS-Dilithium）<a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf">FIPS 204</a>
</li>
<li>SHA3-128（原名 Keccak-256）<a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.202.pdf">FIPS 202</a>
 仅用于 SHAKE128</li>
<li>SHA3-256（原名 Keccak-512）<a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.202.pdf">FIPS 202</a>
</li>
<li>SHAKE128 和 SHAKE256（SHA3-128 和 SHA3-256 的 XOF 扩展）<a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.202.pdf">FIPS 202</a>
</li>
</ul>
<p>SHA3-256、SHAKE128 和 SHAKE256 的测试向量可在 <a href="https://csrc.nist.gov/projects/cryptographic-standards-and-guidelines/example-values">NIST</a>
 找到。</p>
<p>请注意，Java bouncycastle库支持以上所有功能。C++库支持已包含在OpenSSL 3.5中<a href="https://openssl-library.org/post/2025-02-04-release-announcement-3.5/">OpenSSL</a>
。</p>
<h3 id="alternatives">Alternatives</h3>
<p>我们不会支持 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.205.pdf">FIPS 205</a>
 (Sphincs+)，它比 ML-DSA 慢得多且体积大得多。我们不会支持即将推出的 FIPS206 (Falcon)，它尚未标准化。我们不会支持 NTRU 或其他未被 NIST 标准化的 PQ 候选方案。</p>
<h3 id="rosenpass">Rosenpass</h3>
<p>有一些研究 <a href="https://eprint.iacr.org/2020/379.pdf">paper</a>
 关于将 Wireguard (IK) 适配为纯后量子密码学，但该论文中存在几个开放性问题。后来，这种方法被实现为 Rosenpass <a href="https://rosenpass.eu/">Rosenpass</a>
 <a href="https://raw.githubusercontent.com/rosenpass/rosenpass/papers-pdf/whitepaper.pdf">whitepaper</a>
，用于后量子 Wireguard。</p>
<p>Rosenpass 使用类似 Noise KK 的握手，配合预共享的 Classic McEliece 460896 静态密钥（每个 500 KB）和 Kyber-512（本质上是 MLKEM-512）临时密钥。由于 Classic McEliece 密文只有 188 字节，而 Kyber-512 公钥和密文大小合理，两个握手消息都能适合标准 UDP MTU。PQ KK 握手输出的共享密钥（osk）被用作标准 Wireguard IK 握手的输入预共享密钥（psk）。因此总共有两个完整的握手过程，一个是纯 PQ 的，一个是纯 X25519 的。</p>
<p>我们无法用这些方法来替换我们的XK和IK握手，因为：</p>
<ul>
<li>我们无法进行 KK，Bob 没有 Alice 的静态密钥</li>
<li>500KB 的静态密钥太大了</li>
<li>我们不希望有额外的往返通信</li>
</ul>
<p>白皮书中包含了很多有价值的信息，我们会审阅它以获取想法和灵感。待办事项。</p>
<h2 id="specification">Specification</h2>
<h3 id="密钥交换">密钥交换</h3>
<p>按照以下方式更新通用结构文档 <a href="../../../zh/docs/specs/common-structures/">/docs/specs/common-structures/</a>
 中的章节和表格：</p>
<h3 id="签名">签名</h3>
<p>新的公钥类型包括：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Public Key Length</th>
          <th>Since</th>
          <th>Usage</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MLKEM512_X25519</td>
          <td>32</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for Leasesets only, not for RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM768_X25519</td>
          <td>32</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for Leasesets only, not for RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM1024_X25519</td>
          <td>32</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for Leasesets only, not for RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM512</td>
          <td>800</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for handshakes only, not for Leasesets, RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM768</td>
          <td>1184</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for handshakes only, not for Leasesets, RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM1024</td>
          <td>1568</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for handshakes only, not for Leasesets, RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM512_CT</td>
          <td>768</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for handshakes only, not for Leasesets, RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM768_CT</td>
          <td>1088</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for handshakes only, not for Leasesets, RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM1024_CT</td>
          <td>1568</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for handshakes only, not for Leasesets, RIs or Destinations</td>
      </tr>
      <tr>
          <td>NONE</td>
          <td>0</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for destinations with PQ sig types only, not for RIs or Leasesets</td>
      </tr>
      <tr>
          <td>混合公钥是 X25519 密钥。KEM 公钥是从 Alice 发送到 Bob 的临时 PQ 密钥。编码和字节序在 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf">FIPS 203</a>
 中定义。</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>MLKEM*_CT 密钥实际上并不是公钥，它们是在 Noise 握手过程中从 Bob 发送给 Alice 的&quot;密文&quot;。这里列出它们是为了完整性。</p>
<h3 id="合法组合">合法组合</h3>
<p>新的私钥类型包括：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Private Key Length</th>
          <th>Since</th>
          <th>Usage</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MLKEM512_X25519</td>
          <td>32</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for Leasesets only, not for RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM768_X25519</td>
          <td>32</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for Leasesets only, not for RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM1024_X25519</td>
          <td>32</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for Leasesets only, not for RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM512</td>
          <td>1632</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for handshakes only, not for Leasesets, RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM768</td>
          <td>2400</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for handshakes only, not for Leasesets, RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM1024</td>
          <td>3168</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for handshakes only, not for Leasesets, RIs or Destinations</td>
      </tr>
      <tr>
          <td>混合私钥是 X25519 密钥。KEM 私钥仅供 Alice 使用。KEM 编码和字节序在 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf">FIPS 203</a>
 中定义。</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<h3 id="需要新的加密算法">需要新的加密算法</h3>
<p>新的签名公钥类型包括：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Length (bytes)</th>
          <th>Since</th>
          <th>Usage</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MLDSA44</td>
          <td>1312</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA65</td>
          <td>1952</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA87</td>
          <td>2592</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA44_EdDSA_SHA512_Ed25519</td>
          <td>1344</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA65_EdDSA_SHA512_Ed25519</td>
          <td>1984</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA87_EdDSA_SHA512_Ed25519</td>
          <td>2624</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA44ph</td>
          <td>1344</td>
          <td>0.9.xx</td>
          <td>Only for SU3 files, not for netdb structures</td>
      </tr>
      <tr>
          <td>MLDSA65ph</td>
          <td>1984</td>
          <td>0.9.xx</td>
          <td>Only for SU3 files, not for netdb structures</td>
      </tr>
      <tr>
          <td>MLDSA87ph</td>
          <td>2624</td>
          <td>0.9.xx</td>
          <td>Only for SU3 files, not for netdb structures</td>
      </tr>
      <tr>
          <td>混合签名公钥是 Ed25519 密钥后跟 PQ 密钥，如 <a href="https://datatracker.ietf.org/doc/draft-ietf-lamps-pq-composite-sigs/">IETF draft</a>
 中所述。编码和字节顺序在 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf">FIPS 204</a>
 中定义。</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<h3 id="替代方案">替代方案</h3>
<p>新的签名私钥类型包括：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Length (bytes)</th>
          <th>Since</th>
          <th>Usage</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MLDSA44</td>
          <td>2560</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA65</td>
          <td>4032</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA87</td>
          <td>4896</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA44_EdDSA_SHA512_Ed25519</td>
          <td>2592</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA65_EdDSA_SHA512_Ed25519</td>
          <td>4064</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA87_EdDSA_SHA512_Ed25519</td>
          <td>4928</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA44ph</td>
          <td>2592</td>
          <td>0.9.xx</td>
          <td>Only for SU3 files, not for netdb structures. See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA65ph</td>
          <td>4064</td>
          <td>0.9.xx</td>
          <td>Only for SU3 files, not for netdb structures. See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA87ph</td>
          <td>4928</td>
          <td>0.9.xx</td>
          <td>Only for SU3 files, not for netdb structures. See proposal 169</td>
      </tr>
      <tr>
          <td>混合签名私钥是 Ed25519 密钥后跟 PQ 密钥，如 <a href="https://datatracker.ietf.org/doc/draft-ietf-lamps-pq-composite-sigs/">IETF draft</a>
 所述。编码和字节序在 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf">FIPS 204</a>
 中定义。</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<h3 id="rosenpass-1">Rosenpass</h3>
<p>新的签名类型包括：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Length (bytes)</th>
          <th>Since</th>
          <th>Usage</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MLDSA44</td>
          <td>2420</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA65</td>
          <td>3309</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA87</td>
          <td>4627</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA44_EdDSA_SHA512_Ed25519</td>
          <td>2484</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA65_EdDSA_SHA512_Ed25519</td>
          <td>3373</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA87_EdDSA_SHA512_Ed25519</td>
          <td>4691</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA44ph</td>
          <td>2484</td>
          <td>0.9.xx</td>
          <td>Only for SU3 files, not for netdb structures. See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA65ph</td>
          <td>3373</td>
          <td>0.9.xx</td>
          <td>Only for SU3 files, not for netdb structures. See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA87ph</td>
          <td>4691</td>
          <td>0.9.xx</td>
          <td>Only for SU3 files, not for netdb structures. See proposal 169</td>
      </tr>
      <tr>
          <td>混合签名是 Ed25519 签名后跟 PQ 签名，如 <a href="https://datatracker.ietf.org/doc/draft-ietf-lamps-pq-composite-sigs/">IETF draft</a>
 中所述。混合签名通过验证两个签名来进行验证，如果其中任何一个失败则验证失败。编码和字节顺序在 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf">FIPS 204</a>
 中定义。</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<h3 id="key-certificates">Key Certificates</h3>
<p>新的签名公钥类型包括：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Type Code</th>
          <th>Total Public Key Length</th>
          <th>Since</th>
          <th>Usage</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MLDSA44</td>
          <td>12</td>
          <td>1312</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA65</td>
          <td>13</td>
          <td>1952</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA87</td>
          <td>14</td>
          <td>2592</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA44_EdDSA_SHA512_Ed25519</td>
          <td>15</td>
          <td>1344</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA65_EdDSA_SHA512_Ed25519</td>
          <td>16</td>
          <td>1984</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA87_EdDSA_SHA512_Ed25519</td>
          <td>17</td>
          <td>2624</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>MLDSA44ph</td>
          <td>18</td>
          <td>n/a</td>
          <td>0.9.xx</td>
          <td>Only for SU3 files</td>
      </tr>
      <tr>
          <td>MLDSA65ph</td>
          <td>19</td>
          <td>n/a</td>
          <td>0.9.xx</td>
          <td>Only for SU3 files</td>
      </tr>
      <tr>
          <td>MLDSA87ph</td>
          <td>20</td>
          <td>n/a</td>
          <td>0.9.xx</td>
          <td>Only for SU3 files</td>
      </tr>
      <tr>
          <td>新的加密公钥类型包括：</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Type Code</th>
          <th>Total Public Key Length</th>
          <th>Since</th>
          <th>Usage</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MLKEM512_X25519</td>
          <td>5</td>
          <td>32</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for Leasesets only, not for RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM768_X25519</td>
          <td>6</td>
          <td>32</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for Leasesets only, not for RIs or Destinations</td>
      </tr>
      <tr>
          <td>MLKEM1024_X25519</td>
          <td>7</td>
          <td>32</td>
          <td>0.9.xx</td>
          <td>See proposal 169, for Leasesets only, not for RIs or Destinations</td>
      </tr>
      <tr>
          <td>NONE</td>
          <td>255</td>
          <td>0</td>
          <td>0.9.xx</td>
          <td>See proposal 169</td>
      </tr>
      <tr>
          <td>混合密钥类型绝不包含在密钥证书中；仅包含在 leaseSet 中。</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>对于具有 Hybrid 或 PQ 签名类型的目标，加密类型使用 NONE（类型 255），但没有加密密钥，整个 384 字节的主要部分都用于签名密钥。</p>
<h3 id="通用结构">通用结构</h3>
<p>以下是新 Destination 类型的长度。所有类型的加密类型都是 NONE（类型 255），加密密钥长度被视为 0。整个 384 字节部分用于签名公钥的第一部分。注意：这与 ECDSA_SHA512_P521 和 RSA 签名类型的规范不同，在那些类型中我们在 destination 中保留了 256 字节的 ElGamal 密钥，即使它未被使用。</p>
<p>无填充。总长度为 7 + 总密钥长度。密钥证书长度为 4 + 超额密钥长度。</p>
<p>MLDSA44 的示例 1319 字节目标字节流：</p>
<p>skey[0:383] 5 (932 &raquo; 8) (932 &amp; 0xff) 00 12 00 255 skey[384:1311]</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Type Code</th>
          <th>Total Public Key Length</th>
          <th>Main</th>
          <th>Excess</th>
          <th>Total Dest Length</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MLDSA44</td>
          <td>12</td>
          <td>1312</td>
          <td>384</td>
          <td>928</td>
          <td>1319</td>
      </tr>
      <tr>
          <td>MLDSA65</td>
          <td>13</td>
          <td>1952</td>
          <td>384</td>
          <td>1568</td>
          <td>1959</td>
      </tr>
      <tr>
          <td>MLDSA87</td>
          <td>14</td>
          <td>2592</td>
          <td>384</td>
          <td>2208</td>
          <td>2599</td>
      </tr>
      <tr>
          <td>MLDSA44_EdDSA_SHA512_Ed25519</td>
          <td>15</td>
          <td>1344</td>
          <td>384</td>
          <td>960</td>
          <td>1351</td>
      </tr>
      <tr>
          <td>MLDSA65_EdDSA_SHA512_Ed25519</td>
          <td>16</td>
          <td>1984</td>
          <td>384</td>
          <td>1600</td>
          <td>1991</td>
      </tr>
      <tr>
          <td>MLDSA87_EdDSA_SHA512_Ed25519</td>
          <td>17</td>
          <td>2624</td>
          <td>384</td>
          <td>2240</td>
          <td>2631</td>
      </tr>
  </tbody>
</table>
<h3 id="publickey">PublicKey</h3>
<p>以下是新 Destination 类型的长度。所有类型的加密类型都是 X25519（类型 4）。X28819 公钥后的整个 352 字节部分用于签名公钥的第一部分。无填充。总长度为 39 + 总密钥长度。密钥证书长度为 4 + 多余密钥长度。</p>
<p>MLDSA44 的 1351 字节 router identity 字节流示例：</p>
<p>enckey[0:31] skey[0:351] 5 (960 &raquo; 8) (960 &amp; 0xff) 00 12 00 4 skey[352:1311]</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Type Code</th>
          <th>Total Public Key Length</th>
          <th>Main</th>
          <th>Excess</th>
          <th>Total RouterIdent Length</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MLDSA44</td>
          <td>12</td>
          <td>1312</td>
          <td>352</td>
          <td>960</td>
          <td>1351</td>
      </tr>
      <tr>
          <td>MLDSA65</td>
          <td>13</td>
          <td>1952</td>
          <td>352</td>
          <td>1600</td>
          <td>1991</td>
      </tr>
      <tr>
          <td>MLDSA87</td>
          <td>14</td>
          <td>2592</td>
          <td>352</td>
          <td>2240</td>
          <td>2631</td>
      </tr>
      <tr>
          <td>MLDSA44_EdDSA_SHA512_Ed25519</td>
          <td>15</td>
          <td>1344</td>
          <td>352</td>
          <td>992</td>
          <td>1383</td>
      </tr>
      <tr>
          <td>MLDSA65_EdDSA_SHA512_Ed25519</td>
          <td>16</td>
          <td>1984</td>
          <td>352</td>
          <td>1632</td>
          <td>2023</td>
      </tr>
      <tr>
          <td>MLDSA87_EdDSA_SHA512_Ed25519</td>
          <td>17</td>
          <td>2624</td>
          <td>352</td>
          <td>2272</td>
          <td>2663</td>
      </tr>
  </tbody>
</table>
<h3 id="私钥">私钥</h3>
<p>握手使用 <a href="https://noiseprotocol.org/noise.html">Noise Protocol</a>
 握手模式。</p>
<p>使用以下字母映射：</p>
<ul>
<li>e = 一次性临时密钥</li>
<li>s = 静态密钥</li>
<li>p = 消息载荷</li>
<li>e1 = 一次性临时 PQ 密钥，从 Alice 发送到 Bob</li>
<li>ekem1 = KEM 密文，从 Bob 发送到 Alice</li>
</ul>
<p>针对混合前向保密 (hfs) 对 XK 和 IK 的以下修改如 <a href="https://github.com/noiseprotocol/noise_hfs_spec/blob/master/output/noise_hfs.pdf">Noise HFS spec</a>
 第 5 节所述：</p>
<pre tabindex="0"><code>XK:                       XKhfs:
  &lt;- s                      &lt;- s
  ...                       ...
  -&gt; e, es, p               -&gt; e, es, e1, p
  &lt;- e, ee, p               &lt;- e, ee, ekem1, p
  -&gt; s, se                  -&gt; s, se
  &lt;- p                      &lt;- p
  p -&gt;                      p -&gt;


  IK:                       IKhfs:
  &lt;- s                      &lt;- s
  ...                       ...
  -&gt; e, es, s, ss, p       -&gt; e, es, e1, s, ss, p
  &lt;- tag, e, ee, se, p     &lt;- tag, e, ee, ekem1, se, p
  &lt;- p                     &lt;- p
  p -&gt;                     p -&gt;

  e1 and ekem1 are encrypted. See pattern definitions below.
  NOTE: e1 and ekem1 are different sizes (unlike X25519)
</code></pre><p>e1 模式定义如下，如 <a href="https://github.com/noiseprotocol/noise_hfs_spec/blob/master/output/noise_hfs.pdf">Noise HFS spec</a>
 第 4 节所述：</p>
<pre tabindex="0"><code>For Alice:
  (encap_key, decap_key) = PQ_KEYGEN()

  // EncryptAndHash(encap_key)
  ciphertext = ENCRYPT(k, n, encap_key, ad)
  n++
  MixHash(ciphertext)

  For Bob:

  // DecryptAndHash(ciphertext)
  encap_key = DECRYPT(k, n, ciphertext, ad)
  n++
  MixHash(ciphertext)
</code></pre><p>ekem1 模式定义如下，具体规范见 <a href="https://github.com/noiseprotocol/noise_hfs_spec/blob/master/output/noise_hfs.pdf">Noise HFS spec</a>
 第 4 节：</p>
<pre tabindex="0"><code>For Bob:

  (kem_ciphertext, kem_shared_key) = ENCAPS(encap_key)

  // EncryptAndHash(kem_ciphertext)
  ciphertext = ENCRYPT(k, n, kem_ciphertext, ad)
  MixHash(ciphertext)

  // MixKey
  MixKey(kem_shared_key)


  For Alice:

  // DecryptAndHash(ciphertext)
  kem_ciphertext = DECRYPT(k, n, ciphertext, ad)
  MixHash(ciphertext)

  // MixKey
  kem_shared_key = DECAPS(kem_ciphertext, decap_key)
  MixKey(kem_shared_key)
</code></pre><h3 id="signingpublickey">SigningPublicKey</h3>
<h4 id="issues">Issues</h4>
<ul>
<li>我们是否应该更改握手哈希函数？参见 <a href="https://kerkour.com/fast-secure-hash-function-sha256-sha512-sha3-blake3">comparison</a>
。
SHA256 对后量子攻击并不脆弱，但如果我们确实想升级
哈希函数，现在是时候了，趁着我们正在更改其他东西。
当前的 IETF SSH 提案 <a href="https://datatracker.ietf.org/doc/draft-ietf-sshm-mlkem-hybrid-kex/">IETF draft</a>
 是使用 MLKEM768
配合 SHA256，以及 MLKEM1024 配合 SHA384。该提案包含
安全考虑的讨论。</li>
<li>我们是否应该停止发送 0-RTT ratchet 数据（除了 leaseSet）？</li>
<li>如果我们不发送 0-RTT 数据，是否应该将 ratchet 从 IK 切换到 XK？</li>
</ul>
<h4 id="overview">Overview</h4>
<p>本节适用于 IK 和 XK 协议。</p>
<p>混合握手在 <a href="https://github.com/noiseprotocol/noise_hfs_spec/blob/master/output/noise_hfs.pdf">Noise HFS spec</a>
 中定义。第一条消息从 Alice 发送到 Bob，在消息载荷之前包含 e1（封装密钥）。这被视为额外的静态密钥；对其调用 EncryptAndHash()（作为 Alice）或 DecryptAndHash()（作为 Bob）。然后按常规方式处理消息载荷。</p>
<p>第二条消息，从 Bob 到 Alice，在消息载荷之前包含 ekem1 和密文。这被视为一个额外的静态密钥；对其调用 EncryptAndHash()（作为 Bob）或 DecryptAndHash()（作为 Alice）。然后，计算 kem_shared_key 并调用 MixKey(kem_shared_key)。接着按常规方式处理消息载荷。</p>
<h4 id="defined-ml-kem-operations">Defined ML-KEM Operations</h4>
<p>我们定义以下函数，对应于 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf">FIPS 203</a>
 中定义的密码学构建块。</p>
<p>(encap_key, decap_key) = PQ_KEYGEN()</p>
<pre><code>Alice creates the encapsulation and decapsulation keys
The encapsulation key is sent in message 1.
encap_key and decap_key sizes vary based on ML-KEM variant.
</code></pre>
<p>(ciphertext, kem_shared_key) = ENCAPS(encap_key)</p>
<pre><code>Bob calculates the ciphertext and shared key,
using the ciphertext received in message 1.
The ciphertext is sent in message 2.
ciphertext size varies based on ML-KEM variant.
The kem_shared_key is always 32 bytes.
</code></pre>
<p>kem_shared_key = DECAPS(ciphertext, decap_key)</p>
<pre><code>Alice calculates the shared key,
using the ciphertext received in message 2.
The kem_shared_key is always 32 bytes.
</code></pre>
<p>注意，encap_key 和 ciphertext 都在 Noise 握手消息 1 和 2 的 ChaCha/Poly 块内进行了加密。它们将作为握手过程的一部分被解密。</p>
<p>kem_shared_key 通过 MixHash() 混合到链式密钥中。详细信息请参见下文。</p>
<h4 id="alice-kdf-for-message-1">Alice KDF for Message 1</h4>
<p>对于 XK：在 &rsquo;es&rsquo; 消息模式之后和载荷之前，添加：</p>
<p>或者</p>
<p>对于 IK：在 &rsquo;es&rsquo; 消息模式之后和 &rsquo;s&rsquo; 消息模式之前，添加：</p>
<pre tabindex="0"><code>This is the &#34;e1&#34; message pattern:
  (encap_key, decap_key) = PQ_KEYGEN()

  // EncryptAndHash(encap_key)
  // AEAD parameters
  k = keydata[32:63]
  n = 0
  ad = h
  ciphertext = ENCRYPT(k, n, encap_key, ad)
  n++

  // MixHash(ciphertext)
  h = SHA256(h || ciphertext)


  End of &#34;e1&#34; message pattern.

  NOTE: For the next section (payload for XK or static key for IK),
  the keydata and chain key remain the same,
  and n now equals 1 (instead of 0 for non-hybrid).
</code></pre><h4 id="bob-kdf-for-message-1">Bob KDF for Message 1</h4>
<p>对于 XK：在 &rsquo;es&rsquo; 消息模式之后、载荷之前，添加：</p>
<p>或者</p>
<p>对于 IK：在 &rsquo;es&rsquo; 消息模式之后和 &rsquo;s&rsquo; 消息模式之前，添加：</p>
<pre tabindex="0"><code>This is the &#34;e1&#34; message pattern:

  // DecryptAndHash(encap_key_section)
  // AEAD parameters
  k = keydata[32:63]
  n = 0
  ad = h
  encap_key = DECRYPT(k, n, encap_key_section, ad)
  n++

  // MixHash(encap_key_section)
  h = SHA256(h || encap_key_section)

  End of &#34;e1&#34; message pattern.

  NOTE: For the next section (payload for XK or static key for IK),
  the keydata and chain key remain the same,
  and n now equals 1 (instead of 0 for non-hybrid).
</code></pre><h4 id="bob-kdf-for-message-2">Bob KDF for Message 2</h4>
<p>对于 XK：在 &rsquo;ee&rsquo; 消息模式之后和载荷之前，添加：</p>
<p>或者</p>
<p>对于 IK：在 &rsquo;ee&rsquo; 消息模式之后和 &lsquo;se&rsquo; 消息模式之前，添加：</p>
<pre tabindex="0"><code>This is the &#34;ekem1&#34; message pattern:

  (kem_ciphertext, kem_shared_key) = ENCAPS(encap_key)

  // EncryptAndHash(kem_ciphertext)
  // AEAD parameters
  k = keydata[32:63]
  n = 0
  ad = h
  ciphertext = ENCRYPT(k, n, kem_ciphertext, ad)

  // MixHash(ciphertext)
  h = SHA256(h || ciphertext)

  // MixKey(kem_shared_key)
  keydata = HKDF(chainKey, kem_shared_key, &#34;&#34;, 64)
  chainKey = keydata[0:31]

  End of &#34;ekem1&#34; message pattern.
</code></pre><h4 id="alice-kdf-for-message-2">Alice KDF for Message 2</h4>
<p>在 &rsquo;ee&rsquo; 消息模式之后（对于 IK，在 &lsquo;ss&rsquo; 消息模式之前），添加：</p>
<pre tabindex="0"><code>This is the &#34;ekem1&#34; message pattern:

  // DecryptAndHash(kem_ciphertext_section)
  // AEAD parameters
  k = keydata[32:63]
  n = 0
  ad = h
  kem_ciphertext = DECRYPT(k, n, kem_ciphertext_section, ad)

  // MixHash(kem_ciphertext_section)
  h = SHA256(h || kem_ciphertext_section)

  // MixKey(kem_shared_key)
  kem_shared_key = DECAPS(kem_ciphertext, decap_key)
  keydata = HKDF(chainKey, kem_shared_key, &#34;&#34;, 64)
  chainKey = keydata[0:31]

  End of &#34;ekem1&#34; message pattern.
</code></pre><h4 id="kdf-for-message-3-xk-only">KDF for Message 3 (XK only)</h4>
<p>未更改</p>
<h4 id="kdf-for-split">KDF for split()</h4>
<p>未更改</p>
<h3 id="signingprivatekey签名私钥">SigningPrivateKey（签名私钥）</h3>
<p>按以下方式更新ECIES-Ratchet规范 <a href="../../../zh/docs/specs/ecies/">/docs/specs/ecies/</a>
：</p>
<h4 id="noise-identifiers">Noise identifiers</h4>
<ul>
<li>&ldquo;Noise_IKhfselg2_25519+MLKEM512_ChaChaPoly_SHA256&rdquo;</li>
<li>&ldquo;Noise_IKhfselg2_25519+MLKEM768_ChaChaPoly_SHA256&rdquo;</li>
<li>&ldquo;Noise_IKhfselg2_25519+MLKEM1024_ChaChaPoly_SHA256&rdquo;</li>
</ul>
<h4 id="1b-new-session-format-with-binding">1b) New session format (with binding)</h4>
<p>变更：当前的 ratchet 在第一个 ChaCha 部分包含静态密钥，在第二部分包含有效载荷。使用 ML-KEM 后，现在有三个部分。第一部分包含加密的 PQ 公钥。第二部分包含静态密钥。第三部分包含有效载荷。</p>
<p>加密格式：</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   New Session Ephemeral Public Key    |
  +             32 bytes                  +
  |     Encoded with Elligator2           |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +           ML-KEM encap_key            +
  |       ChaCha20 encrypted data         |
  +      (see table below for length)     +
  |                                       |
  ~                                       ~
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Poly1305 Message Authentication Code |
  +    (MAC) for encap_key Section        +
  |             16 bytes                  |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +           X25519 Static Key           +
  |       ChaCha20 encrypted data         |
  +             32 bytes                  +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Poly1305 Message Authentication Code |
  +    (MAC) for Static Key Section       +
  |             16 bytes                  |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +            Payload Section            +
  |       ChaCha20 encrypted data         |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Poly1305 Message Authentication Code |
  +         (MAC) for Payload Section     +
  |             16 bytes                  |
  +----+----+----+----+----+----+----+----+
</code></pre><p>解密格式：</p>
<pre tabindex="0"><code>Payload Part 1:

  +----+----+----+----+----+----+----+----+
  |                                       |
  +       ML-KEM encap_key                +
  |                                       |
  +      (see table below for length)     +
  |                                       |
  ~                                       ~
  |                                       |
  +----+----+----+----+----+----+----+----+

  Payload Part 2:

  +----+----+----+----+----+----+----+----+
  |                                       |
  +       X25519 Static Key               +
  |                                       |
  +      (32 bytes)                       +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+

  Payload Part 3:

  +----+----+----+----+----+----+----+----+
  |                                       |
  +            Payload Section            +
  |                                       |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
</code></pre><p>大小：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Type Code</th>
          <th>X len</th>
          <th>Msg 1 len</th>
          <th>Msg 1 Enc len</th>
          <th>Msg 1 Dec len</th>
          <th>PQ key len</th>
          <th>pl len</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>X25519</td>
          <td>4</td>
          <td>32</td>
          <td>96+pl</td>
          <td>64+pl</td>
          <td>pl</td>
          <td>&ndash;</td>
          <td>pl</td>
      </tr>
      <tr>
          <td>MLKEM512_X25519</td>
          <td>5</td>
          <td>32</td>
          <td>912+pl</td>
          <td>880+pl</td>
          <td>800+pl</td>
          <td>800</td>
          <td>pl</td>
      </tr>
      <tr>
          <td>MLKEM768_X25519</td>
          <td>6</td>
          <td>32</td>
          <td>1296+pl</td>
          <td>1360+pl</td>
          <td>1184+pl</td>
          <td>1184</td>
          <td>pl</td>
      </tr>
      <tr>
          <td>MLKEM1024_X25519</td>
          <td>7</td>
          <td>32</td>
          <td>1680+pl</td>
          <td>1648+pl</td>
          <td>1568+pl</td>
          <td>1568</td>
          <td>pl</td>
      </tr>
      <tr>
          <td>请注意，负载必须包含一个 DateTime 块，因此最小负载大小为 7。可以据此计算最小消息 1 大小。</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<h4 id="1g-new-session-reply-format">1g) New Session Reply format</h4>
<p>变更：当前的 ratchet 在第一个 ChaCha 部分有空载荷，载荷在第二部分中。使用 ML-KEM 时，现在有三个部分。第一部分包含加密的 PQ 密文。第二部分有空载荷。第三部分包含载荷。</p>
<p>加密格式：</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
  |       Session Tag   8 bytes           |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +        Ephemeral Public Key           +
  |                                       |
  +            32 bytes                   +
  |     Encoded with Elligator2           |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  | ChaCha20 encrypted ML-KEM ciphertext  |
  +      (see table below for length)     +
  ~                                       ~
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Poly1305 Message Authentication Code |
  +  (MAC) for ciphertext Section         +
  |             16 bytes                  |
  +----+----+----+----+----+----+----+----+
  |  Poly1305 Message Authentication Code |
  +  (MAC) for key Section (no data)      +
  |             16 bytes                  |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +            Payload Section            +
  |       ChaCha20 encrypted data         |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |  Poly1305 Message Authentication Code |
  +         (MAC) for Payload Section     +
  |             16 bytes                  |
  +----+----+----+----+----+----+----+----+
</code></pre><p>解密格式：</p>
<pre tabindex="0"><code>Payload Part 1:


  +----+----+----+----+----+----+----+----+
  |                                       |
  +       ML-KEM ciphertext               +
  |                                       |
  +      (see table below for length)     +
  |                                       |
  ~                                       ~
  |                                       |
  +----+----+----+----+----+----+----+----+

  Payload Part 2:

  empty

  Payload Part 3:

  +----+----+----+----+----+----+----+----+
  |                                       |
  +            Payload Section            +
  |                                       |
  ~                                       ~
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
</code></pre><p>大小：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Type Code</th>
          <th>Y len</th>
          <th>Msg 2 len</th>
          <th>Msg 2 Enc len</th>
          <th>Msg 2 Dec len</th>
          <th>PQ CT len</th>
          <th>opt len</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>X25519</td>
          <td>4</td>
          <td>32</td>
          <td>72+pl</td>
          <td>32+pl</td>
          <td>pl</td>
          <td>&ndash;</td>
          <td>pl</td>
      </tr>
      <tr>
          <td>MLKEM512_X25519</td>
          <td>5</td>
          <td>32</td>
          <td>856+pl</td>
          <td>816+pl</td>
          <td>768+pl</td>
          <td>768</td>
          <td>pl</td>
      </tr>
      <tr>
          <td>MLKEM768_X25519</td>
          <td>6</td>
          <td>32</td>
          <td>1176+pl</td>
          <td>1136+pl</td>
          <td>1088+pl</td>
          <td>1088</td>
          <td>pl</td>
      </tr>
      <tr>
          <td>MLKEM1024_X25519</td>
          <td>7</td>
          <td>32</td>
          <td>1656+pl</td>
          <td>1616+pl</td>
          <td>1568+pl</td>
          <td>1568</td>
          <td>pl</td>
      </tr>
      <tr>
          <td>请注意，虽然消息2通常会有非零载荷，但ratchet规范<a href="../../../zh/docs/specs/ecies/">/docs/specs/ecies/</a>
并不要求如此，因此最小载荷大小为0。可以相应地计算消息2的最小大小。</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<h3 id="签名-1">签名</h3>
<p>按如下方式更新 NTCP2 规范 <a href="../../../zh/docs/specs/ntcp2/">/docs/specs/ntcp2/</a>
：</p>
<h4 id="noise-identifiers-1">Noise identifiers</h4>
<ul>
<li>&ldquo;Noise_XKhfsaesobfse+hs2+hs3_25519+MLKEM512_ChaChaPoly_SHA256&rdquo;</li>
<li>&ldquo;Noise_XKhfsaesobfse+hs2+hs3_25519+MLKEM768_ChaChaPoly_SHA256&rdquo;</li>
<li>&ldquo;Noise_XKhfsaesobfse+hs2+hs3_25519+MLKEM1024_ChaChaPoly_SHA256&rdquo;</li>
</ul>
<h4 id="1-sessionrequest">1) SessionRequest</h4>
<p>变更：当前的 NTCP2 仅包含 ChaCha 部分中的选项。使用 ML-KEM 后，ChaCha 部分还将包含加密的 PQ 公钥。</p>
<p>原始内容：</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
  |                                       |
  +        obfuscated with RH_B           +
  |       AES-CBC-256 encrypted X         |
  +             (32 bytes)                +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   ChaChaPoly frame (MLKEM)            |
  +      (see table below for length)     +
  |   k defined in KDF for message 1      |
  +   n = 0                               +
  |   see KDF for associated data         |
  ~   n = 0                               ~
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   ChaChaPoly frame (options)          |
  +         32 bytes                      +
  |   k defined in KDF for message 1      |
  +   n = 0                               +
  |   see KDF for associated data         |
  +----+----+----+----+----+----+----+----+
  |     unencrypted authenticated         |
  ~         padding (optional)            ~
  |     length defined in options block   |
  +----+----+----+----+----+----+----+----+

  Same as before except add a second ChaChaPoly frame
</code></pre><p>未加密数据（未显示 Poly1305 认证标签）：</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |                   X                   |
  +              (32 bytes)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |           ML-KEM encap_key            |
  +      (see table below for length)     +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |               options                 |
  +              (16 bytes)               +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     unencrypted authenticated         |
  +         padding (optional)            +
  |     length defined in options block   |
  ~               .   .   .               ~
  |                                       |
  +----+----+----+----+----+----+----+----+
</code></pre><p>大小：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Type Code</th>
          <th>X len</th>
          <th>Msg 1 len</th>
          <th>Msg 1 Enc len</th>
          <th>Msg 1 Dec len</th>
          <th>PQ key len</th>
          <th>opt len</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>X25519</td>
          <td>4</td>
          <td>32</td>
          <td>64+pad</td>
          <td>32</td>
          <td>16</td>
          <td>&ndash;</td>
          <td>16</td>
      </tr>
      <tr>
          <td>MLKEM512_X25519</td>
          <td>5</td>
          <td>32</td>
          <td>880+pad</td>
          <td>848</td>
          <td>816</td>
          <td>800</td>
          <td>16</td>
      </tr>
      <tr>
          <td>MLKEM768_X25519</td>
          <td>6</td>
          <td>32</td>
          <td>1264+pad</td>
          <td>1232</td>
          <td>1200</td>
          <td>1184</td>
          <td>16</td>
      </tr>
      <tr>
          <td>MLKEM1024_X25519</td>
          <td>7</td>
          <td>32</td>
          <td>1648+pad</td>
          <td>1616</td>
          <td>1584</td>
          <td>1568</td>
          <td>16</td>
      </tr>
      <tr>
          <td>注意：类型代码仅供内部使用。Router 将保持类型 4，支持情况将在 router 地址中指示。</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<h4 id="2-sessioncreated">2) SessionCreated</h4>
<p>变更：当前的 NTCP2 只包含 ChaCha 部分中的选项。使用 ML-KEM 后，ChaCha 部分还将包含加密的 PQ 公钥。</p>
<p>原始内容：</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
  |                                       |
  +        obfuscated with RH_B           +
  |       AES-CBC-256 encrypted Y         |
  +              (32 bytes)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   ChaChaPoly frame (MLKEM)            |
  +   Encrypted and authenticated data    +
  -      (see table below for length)     -
  +   k defined in KDF for message 2      +
  |   n = 0; see KDF for associated data  |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   ChaChaPoly frame (options)          |
  +   Encrypted and authenticated data    +
  -           32 bytes                    -
  +   k defined in KDF for message 2      +
  |   n = 0; see KDF for associated data  |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     unencrypted authenticated         |
  +         padding (optional)            +
  |     length defined in options block   |
  ~               .   .   .               ~
  |                                       |
  +----+----+----+----+----+----+----+----+

  Same as before except add a second ChaChaPoly frame
</code></pre><p>未加密数据（未显示 Poly1305 认证标签）：</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |                  Y                    |
  +              (32 bytes)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |           ML-KEM Ciphertext           |
  +      (see table below for length)     +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |               options                 |
  +              (16 bytes)               +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     unencrypted authenticated         |
  +         padding (optional)            +
  |     length defined in options block   |
  ~               .   .   .               ~
  |                                       |
  +----+----+----+----+----+----+----+----+
</code></pre><p>大小：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Type Code</th>
          <th>Y len</th>
          <th>Msg 2 len</th>
          <th>Msg 2 Enc len</th>
          <th>Msg 2 Dec len</th>
          <th>PQ CT len</th>
          <th>opt len</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>X25519</td>
          <td>4</td>
          <td>32</td>
          <td>64+pad</td>
          <td>32</td>
          <td>16</td>
          <td>&ndash;</td>
          <td>16</td>
      </tr>
      <tr>
          <td>MLKEM512_X25519</td>
          <td>5</td>
          <td>32</td>
          <td>848+pad</td>
          <td>816</td>
          <td>784</td>
          <td>768</td>
          <td>16</td>
      </tr>
      <tr>
          <td>MLKEM768_X25519</td>
          <td>6</td>
          <td>32</td>
          <td>1136+pad</td>
          <td>1104</td>
          <td>1104</td>
          <td>1088</td>
          <td>16</td>
      </tr>
      <tr>
          <td>MLKEM1024_X25519</td>
          <td>7</td>
          <td>32</td>
          <td>1616+pad</td>
          <td>1584</td>
          <td>1584</td>
          <td>1568</td>
          <td>16</td>
      </tr>
      <tr>
          <td>注意：类型代码仅供内部使用。Router 将保持类型 4，支持情况将在 router 地址中指示。</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<h4 id="3-sessionconfirmed">3) SessionConfirmed</h4>
<p>未更改</p>
<h4 id="key-derivation-function-kdf-for-data-phase">Key Derivation Function (KDF) (for data phase)</h4>
<p>未改变</p>
<h3 id="密钥证书">密钥证书</h3>
<p>按以下方式更新 SSU2 规范 <a href="../../../zh/docs/specs/ssu2/">/docs/specs/ssu2/</a>
：</p>
<h4 id="noise-identifiers-2">Noise identifiers</h4>
<ul>
<li>&ldquo;Noise_XKhfschaobfse+hs1+hs2+hs3_25519+MLKEM512_ChaChaPoly_SHA256&rdquo;</li>
<li>&ldquo;Noise_XKhfschaobfse+hs1+hs2+hs3_25519+MLKEM768_ChaChaPoly_SHA256&rdquo;</li>
<li>&ldquo;Noise_XKhfschaobfse+hs1+hs2+hs3_25519+MLKEM1024_ChaChaPoly_SHA256&rdquo;</li>
</ul>
<h4 id="long-header">Long Header</h4>
<p>长头部为32字节。它在会话创建之前使用，用于Token请求、SessionRequest、SessionCreated和重试。它也用于会话外的Peer Test和Hole Punch消息。</p>
<p>TODO：我们可以在内部使用版本字段，对MLKEM512使用3，对MLKEM768使用4。我们是仅对类型0和1这样做，还是对所有6种类型都这样做？</p>
<p>头部加密之前：</p>
<pre tabindex="0"><code>
+----+----+----+----+----+----+----+----+
  |      Destination Connection ID        |
  +----+----+----+----+----+----+----+----+
  |   Packet Number   |type| ver| id |flag|
  +----+----+----+----+----+----+----+----+
  |        Source Connection ID           |
  +----+----+----+----+----+----+----+----+
  |                 Token                 |
  +----+----+----+----+----+----+----+----+

  Destination Connection ID :: 8 bytes, unsigned big endian integer

  Packet Number :: 4 bytes, unsigned big endian integer

  type :: The message type = 0, 1, 7, 9, 10, or 11

  ver :: The protocol version, equal to 2
         TODO We could internally use the version field and use 3 for MLKEM512 and 4 for MLKEM768.

  id :: 1 byte, the network ID (currently 2, except for test networks)

  flag :: 1 byte, unused, set to 0 for future compatibility

  Source Connection ID :: 8 bytes, unsigned big endian integer

  Token :: 8 bytes, unsigned big endian integer
</code></pre><h4 id="short-header">Short Header</h4>
<p>未更改</p>
<h4 id="sessionrequest-type-0">SessionRequest (Type 0)</h4>
<p>变更：当前的 SSU2 在 ChaCha 部分仅包含块数据。使用 ML-KEM 后，ChaCha 部分还将包含加密的 PQ 公钥。</p>
<p>原始内容：</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
  |  Long Header bytes 0-15, ChaCha20     |
  +  encrypted with Bob intro key         +
  |    See Header Encryption KDF          |
  +----+----+----+----+----+----+----+----+
  |  Long Header bytes 16-31, ChaCha20    |
  +  encrypted with Bob intro key n=0     +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +       X, ChaCha20 encrypted           +
  |       with Bob intro key n=0          |
  +              (32 bytes)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   ChaCha20 encrypted data (MLKEM)     |
  +          (length varies)              +
  |  k defined in KDF for Session Request |
  +  n = 0                                +
  |  see KDF for associated data          |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |   ChaCha20 encrypted data (payload)   |
  +          (length varies)              +
  |  k defined in KDF for Session Request |
  +  n = 0                                +
  |  see KDF for associated data          |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +        Poly1305 MAC (16 bytes)        +
  |                                       |
  +----+----+----+----+----+----+----+----+
</code></pre><p>未加密数据（未显示 Poly1305 身份验证标签）：</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
  |      Destination Connection ID        |
  +----+----+----+----+----+----+----+----+
  |   Packet Number   |type| ver| id |flag|
  +----+----+----+----+----+----+----+----+
  |        Source Connection ID           |
  +----+----+----+----+----+----+----+----+
  |                 Token                 |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |                   X                   |
  +              (32 bytes)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |           ML-KEM encap_key            |
  +      (see table below for length)     +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     Noise payload (block data)        |
  +          (length varies)              +
  |     see below for allowed blocks      |
  +----+----+----+----+----+----+----+----+
</code></pre><p>大小，不包括 IP 开销：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Type Code</th>
          <th>X len</th>
          <th>Msg 1 len</th>
          <th>Msg 1 Enc len</th>
          <th>Msg 1 Dec len</th>
          <th>PQ key len</th>
          <th>pl len</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>X25519</td>
          <td>4</td>
          <td>32</td>
          <td>80+pl</td>
          <td>16+pl</td>
          <td>pl</td>
          <td>&ndash;</td>
          <td>pl</td>
      </tr>
      <tr>
          <td>MLKEM512_X25519</td>
          <td>5</td>
          <td>32</td>
          <td>896+pl</td>
          <td>832+pl</td>
          <td>800+pl</td>
          <td>800</td>
          <td>pl</td>
      </tr>
      <tr>
          <td>MLKEM768_X25519</td>
          <td>6</td>
          <td>32</td>
          <td>1280+pl</td>
          <td>1216+pl</td>
          <td>1184+pl</td>
          <td>1184</td>
          <td>pl</td>
      </tr>
      <tr>
          <td>MLKEM1024_X25519</td>
          <td>7</td>
          <td>n/a</td>
          <td>too big</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>注意：类型代码仅供内部使用。Router 将保持类型 4，支持将在 router 地址中指示。</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>MLKEM768_X25519的最小MTU：IPv4约为1316，IPv6约为1336。</p>
<h4 id="sessioncreated-type-1">SessionCreated (Type 1)</h4>
<p>变更：当前的 SSU2 在 ChaCha 部分只包含块数据。使用 ML-KEM 后，ChaCha 部分还将包含加密的 PQ 公钥。</p>
<p>原始内容：</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
  |  Long Header bytes 0-15, ChaCha20     |
  +  encrypted with Bob intro key and     +
  | derived key, see Header Encryption KDF|
  +----+----+----+----+----+----+----+----+
  |  Long Header bytes 16-31, ChaCha20    |
  +  encrypted with derived key n=0       +
  |  See Header Encryption KDF            |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +       Y, ChaCha20 encrypted           +
  |       with derived key n=0            |
  +              (32 bytes)               +
  |       See Header Encryption KDF       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   ChaCha20 data (MLKEM)               |
  +   Encrypted and authenticated data    +
  |  length varies                        |
  +  k defined in KDF for Session Created +
  |  n = 0; see KDF for associated data   |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |   ChaCha20 data (payload)             |
  +   Encrypted and authenticated data    +
  |  length varies                        |
  +  k defined in KDF for Session Created +
  |  n = 0; see KDF for associated data   |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +        Poly1305 MAC (16 bytes)        +
  |                                       |
  +----+----+----+----+----+----+----+----+
</code></pre><p>未加密数据（未显示 Poly1305 认证标签）：</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
  |      Destination Connection ID        |
  +----+----+----+----+----+----+----+----+
  |   Packet Number   |type| ver| id |flag|
  +----+----+----+----+----+----+----+----+
  |        Source Connection ID           |
  +----+----+----+----+----+----+----+----+
  |                 Token                 |
  +----+----+----+----+----+----+----+----+
  |                                       |
  +                                       +
  |                  Y                    |
  +              (32 bytes)               +
  |                                       |
  +                                       +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |           ML-KEM Ciphertext           |
  +      (see table below for length)     +
  |                                       |
  +----+----+----+----+----+----+----+----+
  |     Noise payload (block data)        |
  +          (length varies)              +
  |      see below for allowed blocks     |
  +----+----+----+----+----+----+----+----+
</code></pre><p>大小，不包括 IP 开销：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Type Code</th>
          <th>Y len</th>
          <th>Msg 2 len</th>
          <th>Msg 2 Enc len</th>
          <th>Msg 2 Dec len</th>
          <th>PQ CT len</th>
          <th>pl len</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>X25519</td>
          <td>4</td>
          <td>32</td>
          <td>80+pl</td>
          <td>16+pl</td>
          <td>pl</td>
          <td>&ndash;</td>
          <td>pl</td>
      </tr>
      <tr>
          <td>MLKEM512_X25519</td>
          <td>5</td>
          <td>32</td>
          <td>864+pl</td>
          <td>800+pl</td>
          <td>768+pl</td>
          <td>768</td>
          <td>pl</td>
      </tr>
      <tr>
          <td>MLKEM768_X25519</td>
          <td>6</td>
          <td>32</td>
          <td>1184+pl</td>
          <td>1118+pl</td>
          <td>1088+pl</td>
          <td>1088</td>
          <td>pl</td>
      </tr>
      <tr>
          <td>MLKEM1024_X25519</td>
          <td>7</td>
          <td>n/a</td>
          <td>too big</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>注意：类型代码仅供内部使用。Router将保持类型4，支持情况将在router地址中显示。</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>MLKEM768_X25519 的最小 MTU：IPv4 约为 1316，IPv6 约为 1336。</p>
<h4 id="sessionconfirmed-type-2">SessionConfirmed (Type 2)</h4>
<p>未更改</p>
<h4 id="kdf-for-data-phase">KDF for data phase</h4>
<p>未更改</p>
<h4 id="问题">问题</h4>
<p>Relay 块、Peer Test 块和 Peer Test 消息都包含签名。不幸的是，PQ 签名比 MTU 更大。目前没有机制可以将 Relay 或 Peer Test 块或消息分片到多个 UDP 数据包中。必须扩展协议以支持分片。这将在单独的待定提案中完成。在此之前，将不支持 Relay 和 Peer Test。</p>
<h4 id="概述-1">概述</h4>
<p>我们可以在内部使用版本字段，对 MLKEM512 使用 3，对 MLKEM768 使用 4。</p>
<p>对于消息 1 和 2，MLKEM768 会使数据包大小超过 1280 字节的最小 MTU。如果 MTU 过低，可能就不支持该连接。</p>
<p>对于消息 1 和 2，MLKEM1024 会使数据包大小超出 1500 的最大 MTU。这将需要对消息 1 和 2 进行分片，这会是一个很大的复杂化问题。可能不会这样做。</p>
<p>中继和对等测试：见上文</p>
<h3 id="目标地址大小">目标地址大小</h3>
<p>TODO: 是否有更高效的方式来定义签名/验证以避免复制签名？</p>
<h3 id="routerident-大小">RouterIdent 大小</h3>
<p>待办事项</p>
<p><a href="https://datatracker.ietf.org/doc/draft-ietf-lamps-dilithium-certificates/">IETF draft</a>
 第 8.1 节不允许在 X.509 证书中使用 HashML-DSA，并且不为 HashML-DSA 分配 OID，这是由于实现复杂性和安全性降低的原因。</p>
<p>对于 SU3 文件的 PQ-only 签名，使用证书中定义在 <a href="https://datatracker.ietf.org/doc/draft-ietf-lamps-dilithium-certificates/">IETF draft</a>
 的非预哈希变体的 OID。我们不定义 SU3 文件的混合签名，因为我们可能需要对文件进行两次哈希（尽管 HashML-DSA 和 X2559 使用相同的哈希函数 SHA512）。此外，在 X.509 证书中连接两个密钥和签名将是完全非标准的。</p>
<p>请注意，我们不允许对 SU3 文件进行 Ed25519 签名，虽然我们已经定义了 Ed25519ph 签名，但我们从未就其 OID 达成一致，也从未使用过它。</p>
<p>普通的签名类型不允许用于 SU3 文件；请使用 ph（预哈希）变体。</p>
<h3 id="握手模式">握手模式</h3>
<p>新的最大 Destination 大小将是 2599（base 64 格式为 3468）。</p>
<p>更新其他提供Destination大小指导的文档，包括：</p>
<ul>
<li>SAMv3</li>
<li>Bittorrent</li>
<li>开发者指南</li>
<li>命名 / 地址簿 / 跳转服务器</li>
<li>其他文档</li>
</ul>
<h2 id="overhead-analysis">Overhead Analysis</h2>
<h3 id="noise-握手密钥派生函数">Noise 握手密钥派生函数</h3>
<p>大小增加（字节）：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Pubkey (Msg 1)</th>
          <th>Cipertext (Msg 2)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MLKEM512_X25519</td>
          <td>+816</td>
          <td>+784</td>
      </tr>
      <tr>
          <td>MLKEM768_X25519</td>
          <td>+1200</td>
          <td>+1104</td>
      </tr>
      <tr>
          <td>MLKEM1024_X25519</td>
          <td>+1584</td>
          <td>+1584</td>
      </tr>
      <tr>
          <td>速度：</td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>根据 <a href="https://blog.cloudflare.com/pq-2024/">Cloudflare</a>
 报告的速度：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Relative speed</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>X25519 DH/keygen</td>
          <td>baseline</td>
      </tr>
      <tr>
          <td>MLKEM512</td>
          <td>2.25x faster</td>
      </tr>
      <tr>
          <td>MLKEM768</td>
          <td>1.5x faster</td>
      </tr>
      <tr>
          <td>MLKEM1024</td>
          <td>1x (same)</td>
      </tr>
      <tr>
          <td>XK</td>
          <td>4x DH (keygen + 3 DH)</td>
      </tr>
      <tr>
          <td>MLKEM512_X25519</td>
          <td>4x DH + 2x PQ (keygen + enc/dec) = 4.9x DH = 22% slower</td>
      </tr>
      <tr>
          <td>MLKEM768_X25519</td>
          <td>4x DH + 2x PQ (keygen + enc/dec) = 5.3x DH = 32% slower</td>
      </tr>
      <tr>
          <td>MLKEM1024_X25519</td>
          <td>4x DH + 2x PQ (keygen + enc/dec) = 6x DH = 50% slower</td>
      </tr>
      <tr>
          <td>Java 中的初步测试结果：</td>
          <td></td>
      </tr>
  </tbody>
</table>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Relative DH/encaps</th>
          <th>DH/decaps</th>
          <th>keygen</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>X25519</td>
          <td>baseline</td>
          <td>baseline</td>
          <td>baseline</td>
      </tr>
      <tr>
          <td>MLKEM512</td>
          <td>29x faster</td>
          <td>22x faster</td>
          <td>17x faster</td>
      </tr>
      <tr>
          <td>MLKEM768</td>
          <td>17x faster</td>
          <td>14x faster</td>
          <td>9x faster</td>
      </tr>
      <tr>
          <td>MLKEM1024</td>
          <td>12x faster</td>
          <td>10x faster</td>
          <td>6x faster</td>
      </tr>
  </tbody>
</table>
<h3 id="signatures-1">Signatures</h3>
<p>大小：</p>
<p>假设 RIs 使用 X25519 加密类型的典型密钥、签名、RIdent、Dest 大小或大小增加（包含 Ed25519 作为参考）。列出的 Router Info、LeaseSet、可回复数据报以及两个流传输（SYN 和 SYN ACK）数据包的增加大小。当前的 Destinations 和 Leasesets 包含重复填充，在传输过程中可以压缩。新类型不包含填充且无法压缩，导致传输中的大小增加幅度更大。请参见上面的设计部分。</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Pubkey</th>
          <th>Sig</th>
          <th>Key+Sig</th>
          <th>RIdent</th>
          <th>Dest</th>
          <th>RInfo</th>
          <th>LS/Streaming/Datagram (each msg)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>EdDSA_SHA512_Ed25519</td>
          <td>32</td>
          <td>64</td>
          <td>96</td>
          <td>391</td>
          <td>391</td>
          <td>baseline</td>
          <td>baseline</td>
      </tr>
      <tr>
          <td>MLDSA44</td>
          <td>1312</td>
          <td>2420</td>
          <td>3732</td>
          <td>1351</td>
          <td>1319</td>
          <td>+3316</td>
          <td>+3284</td>
      </tr>
      <tr>
          <td>MLDSA65</td>
          <td>1952</td>
          <td>3309</td>
          <td>5261</td>
          <td>1991</td>
          <td>1959</td>
          <td>+5668</td>
          <td>+5636</td>
      </tr>
      <tr>
          <td>MLDSA87</td>
          <td>2592</td>
          <td>4627</td>
          <td>7219</td>
          <td>2631</td>
          <td>2599</td>
          <td>+7072</td>
          <td>+7040</td>
      </tr>
      <tr>
          <td>MLDSA44_EdDSA_SHA512_Ed25519</td>
          <td>1344</td>
          <td>2484</td>
          <td>3828</td>
          <td>1383</td>
          <td>1351</td>
          <td>+3412</td>
          <td>+3380</td>
      </tr>
      <tr>
          <td>MLDSA65_EdDSA_SHA512_Ed25519</td>
          <td>1984</td>
          <td>3373</td>
          <td>5357</td>
          <td>2023</td>
          <td>1991</td>
          <td>+5668</td>
          <td>+5636</td>
      </tr>
      <tr>
          <td>MLDSA87_EdDSA_SHA512_Ed25519</td>
          <td>2624</td>
          <td>4691</td>
          <td>7315</td>
          <td>2663</td>
          <td>2631</td>
          <td>+7488</td>
          <td>+7456</td>
      </tr>
      <tr>
          <td>速度：</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>据 <a href="https://blog.cloudflare.com/pq-2024/">Cloudflare</a>
 报告的速度：</p>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Relative speed sign</th>
          <th>verify</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>EdDSA_SHA512_Ed25519</td>
          <td>baseline</td>
          <td>baseline</td>
      </tr>
      <tr>
          <td>MLDSA44</td>
          <td>5x slower</td>
          <td>2x faster</td>
      </tr>
      <tr>
          <td>MLDSA65</td>
          <td>???</td>
          <td>???</td>
      </tr>
      <tr>
          <td>MLDSA87</td>
          <td>???</td>
          <td>???</td>
      </tr>
      <tr>
          <td>Java 初步测试结果：</td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Relative speed sign</th>
          <th>verify</th>
          <th>keygen</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>EdDSA_SHA512_Ed25519</td>
          <td>baseline</td>
          <td>baseline</td>
          <td>baseline</td>
      </tr>
      <tr>
          <td>MLDSA44</td>
          <td>4.6x slower</td>
          <td>1.7x faster</td>
          <td>2.6x faster</td>
      </tr>
      <tr>
          <td>MLDSA65</td>
          <td>8.1x slower</td>
          <td>same</td>
          <td>1.5x faster</td>
      </tr>
      <tr>
          <td>MLDSA87</td>
          <td>11.1x slower</td>
          <td>1.5x slower</td>
          <td>same</td>
      </tr>
  </tbody>
</table>
<h2 id="security-analysis">Security Analysis</h2>
<p>NIST 安全类别在 <a href="https://www.nccoe.nist.gov/sites/default/files/2023-08/pqc-light-at-the-end-of-the-tunnel-presentation.pdf">NIST presentation</a>
 第 10 页幻灯片中有总结。初步标准：对于混合协议，我们的最低 NIST 安全类别应为 2 级，对于纯 PQ 协议应为 3 级。</p>
<table>
  <thead>
      <tr>
          <th>Category</th>
          <th>As Secure As</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td>AES128</td>
      </tr>
      <tr>
          <td>2</td>
          <td>SHA256</td>
      </tr>
      <tr>
          <td>3</td>
          <td>AES192</td>
      </tr>
      <tr>
          <td>4</td>
          <td>SHA384</td>
      </tr>
      <tr>
          <td>5</td>
          <td>AES256</td>
      </tr>
  </tbody>
</table>
<h3 id="handshakes">Handshakes</h3>
<p>这些都是混合协议。可能需要优先选择 MLKEM768；MLKEM512 的安全性不够。</p>
<p>NIST 安全类别 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.203.pdf">FIPS 203</a>
:</p>
<table>
  <thead>
      <tr>
          <th>Algorithm</th>
          <th>Security Category</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MLKEM512</td>
          <td>1</td>
      </tr>
      <tr>
          <td>MLKEM768</td>
          <td>3</td>
      </tr>
      <tr>
          <td>MLKEM1024</td>
          <td>5</td>
      </tr>
  </tbody>
</table>
<h3 id="signatures-2">Signatures</h3>
<p>该提案定义了混合和仅 PQ 的签名类型。MLDSA44 混合类型比 MLDSA65 仅 PQ 类型更可取。MLDSA65 和 MLDSA87 的密钥和签名大小对我们来说可能太大了，至少在最初阶段是如此。</p>
<p>NIST 安全类别 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf">FIPS 204</a>
：</p>
<table>
  <thead>
      <tr>
          <th>Algorithm</th>
          <th>Security Category</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MLDSA44</td>
          <td>2</td>
      </tr>
      <tr>
          <td>MLKEM67</td>
          <td>3</td>
      </tr>
      <tr>
          <td>MLKEM87</td>
          <td>5</td>
      </tr>
  </tbody>
</table>
<h2 id="type-preferences">Type Preferences</h2>
<p>虽然我们将定义并实现3种加密和9种签名类型，但我们计划在开发过程中测量性能，并进一步分析增加的结构大小所带来的影响。我们还将继续研究和监测其他项目和协议的发展情况。</p>
<p>经过一年或更长时间的开发后，我们将尝试为每个使用场景确定首选类型或默认设置。选择时需要在带宽、CPU和预估安全级别之间进行权衡。并非所有类型都适用或允许用于所有使用场景。</p>
<p>初步偏好设置如下，可能会有变更：</p>
<p>加密：MLKEM768_X25519</p>
<p>签名：MLDSA44_EdDSA_SHA512_Ed25519</p>
<p>初步限制如下，可能会有变更：</p>
<p>加密：SSU2 不允许使用 MLKEM1024_X25519</p>
<p>签名：MLDSA87和混合变体可能过大；MLDSA65和混合变体可能过大</p>
<h2 id="implementation-notes">Implementation Notes</h2>
<h3 id="library-support">Library Support</h3>
<p>Bouncycastle、BoringSSL 和 WolfSSL 库现在支持 MLKEM 和 MLDSA。OpenSSL 支持将在 2025 年 4 月 8 日的 3.5 版本中提供 <a href="https://openssl-library.org/post/2025-02-04-release-announcement-3.5/">OpenSSL</a>
。</p>
<p>Java I2P 所采用的 southernstorm.com Noise 库包含了对混合握手的初步支持，但我们将其作为未使用功能删除了；我们将需要重新添加并更新它以匹配 <a href="https://github.com/noiseprotocol/noise_hfs_spec/blob/master/output/noise_hfs.pdf">Noise HFS spec</a>
。</p>
<h3 id="signing-variants">Signing Variants</h3>
<p>我们将使用&quot;对冲&quot;或随机化签名变体，而不是&quot;确定性&quot;变体，如 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf">FIPS 204</a>
 第3.4节所定义。这确保了每个签名都是不同的，即使对相同数据进行签名，并提供针对侧信道攻击的额外保护。虽然 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf">FIPS 204</a>
 规定&quot;对冲&quot;变体是默认值，但在各种库中这可能是也可能不是真实情况。实现者必须确保使用&quot;对冲&quot;变体进行签名。</p>
<p>我们使用标准签名过程（称为 Pure ML-DSA Signature Generation），该过程内部将消息编码为 0x00 || len(ctx) || ctx || message，其中 ctx 是一些大小为 0x00..0xFF 的可选值。我们没有使用任何可选上下文。len(ctx) == 0。此过程在 <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.204.pdf">FIPS 204</a>
 算法 2 第 10 步和算法 3 第 5 步中定义。注意，某些已发布的测试向量可能需要设置一种模式，其中消息不被编码。</p>
<h3 id="reliability">Reliability</h3>
<p>大小增加将导致 NetDB 存储、流式握手和其他消息的隧道分片大幅增加。请检查性能和可靠性变化。</p>
<h3 id="structure-sizes">Structure Sizes</h3>
<p>查找并检查任何限制 router info 和 leaseSet 字节大小的代码。</p>
<h3 id="netdb">NetDB</h3>
<p>检查并可能减少存储在RAM或磁盘上的最大LS/RI数量，以限制存储增长。提高floodfill的最低带宽要求？</p>
<h3 id="ratchet">Ratchet</h3>
<h4 id="已定义的-ml-kem-操作">已定义的 ML-KEM 操作</h4>
<p>基于对消息1（新会话消息）的长度检查，应该可以在同一tunnel上自动分类/检测多种协议。以MLKEM512_X25519为例，消息1的长度比当前ratchet协议大816字节，最小消息1大小（仅包含DateTime载荷）为919字节。当前ratchet的大多数消息1大小的载荷都小于816字节，因此可以将它们分类为非混合ratchet。大消息可能是POST请求，这种情况比较少见。</p>
<p>因此推荐的策略是：</p>
<ul>
<li>如果消息 1 小于 919 字节，则为当前的 ratchet 协议。</li>
<li>如果消息 1 大于或等于 919 字节，则可能是 MLKEM512_X25519。
先尝试 MLKEM512_X25519，如果失败，则尝试当前的 ratchet 协议。</li>
</ul>
<p>这应该允许我们在同一个destination上高效支持标准ratchet和混合ratchet，就像我们之前在同一个destination上支持ElGamal和ratchet一样。因此，我们可以比无法为同一个destination支持双协议的情况下更快地迁移到MLKEM混合协议，因为我们可以向现有的destination添加MLKEM支持。</p>
<p>必需支持的组合有：</p>
<ul>
<li>X25519 + MLKEM512</li>
<li>X25519 + MLKEM768</li>
<li>X25519 + MLKEM1024</li>
</ul>
<p>以下组合可能较为复杂，不要求必须支持，但可能会支持，这取决于具体实现：</p>
<ul>
<li>多于一个 MLKEM</li>
<li>ElG + 一个或多个 MLKEM</li>
<li>X25519 + 一个或多个 MLKEM</li>
<li>ElG + X25519 + 一个或多个 MLKEM</li>
</ul>
<p>我们可能不会尝试在同一个目标上支持多种 MLKEM 算法（例如，MLKEM512_X25519 和 MLKEM_768_X25519）。只选择一种；然而，这取决于我们选择首选的 MLKEM 变体，这样 HTTP 客户端 tunnel 就可以使用其中一种。依赖于具体实现。</p>
<p>我们可能会尝试在同一个目标上支持三种算法（例如 X25519、MLKEM512_X25519 和 MLKEM769_X25519）。分类和重试策略可能过于复杂。配置和配置界面可能过于复杂。依赖于具体实现。</p>
<p>我们可能不会尝试在同一个目标上支持 ElGamal 和混合算法。ElGamal 已经过时，而且仅支持 ElGamal + 混合（没有 X25519）没有太大意义。此外，ElGamal 和混合新会话消息都很大，因此分类策略通常必须尝试两种解密方式，这会很低效。具体实现方式依赖于实现。</p>
<p>客户端可以在相同的隧道上对 X25519 和混合协议使用相同或不同的 X25519 静态密钥，具体取决于实现。</p>
<h4 id="alice-kdf-for-message-1alice-消息-1-的密钥派生函数">Alice KDF for Message 1（Alice 消息 1 的密钥派生函数）</h4>
<p>ECIES 规范允许在 New Session Message 载荷中包含 Garlic Messages，这使得初始流数据包（通常是 HTTP GET）能够与客户端的 leaseset 一起进行 0-RTT 传输。然而，New Session Message 载荷不具备前向保密性。由于本提案强调为 ratchet 增强前向保密性，实现可能会或应该推迟包含流载荷或完整流消息，直到第一个 Existing Session Message。这将以牺牲 0-RTT 传输为代价。策略也可能取决于流量类型或隧道类型，或者例如取决于 GET 与 POST 的区别。具体实现相关。</p>
<h4 id="消息-1-的-bob-kdf">消息 1 的 Bob KDF</h4>
<p>在同一目标上使用 MLKEM、MLDSA 或两者都使用，将大幅增加新会话消息的大小，如上所述。这可能会显著降低新会话消息通过 tunnel 传递的可靠性，因为它们必须被分片成多个 1024 字节的 tunnel 消息。传递成功率与分片数量成指数关系。实现可以使用各种策略来限制消息大小，但代价是牺牲 0-RTT 传递。取决于具体实现。</p>
<h3 id="ratchet-1">Ratchet</h3>
<p>我们可以在会话请求中设置临时密钥的最高有效位（key[31] &amp; 0x80）来表示这是一个混合连接。这将允许我们在同一端口上同时运行标准 NTCP 和混合 NTCP。只支持一种混合变体，并在 router 地址中公告。例如，v=2,3 或 v=2,4 或 v=2,5。</p>
<p>如果我们不这样做，我们需要不同的传输地址/端口，以及一个新的协议名称，例如&quot;NTCP1PQ1&quot;。</p>
<p>注意：类型代码仅供内部使用。Router将保持类型4，支持情况将在router地址中指示。</p>
<p>待办事项</p>
<h3 id="ssu2">SSU2</h3>
<p>可能需要不同的传输地址/端口，但希望不需要，我们有一个带有消息1标志的头部。我们可以在内部使用版本字段，对MLKEM512使用3，对MLKEM768使用4。也许地址中只用v=2,3,4就足够了。但我们需要为两个新算法提供标识符：3a, 3b？</p>
<p>检查并验证 SSU2 是否能够处理跨多个数据包分片的 RI（6-8 个？）。i2pd 目前最多只支持 2 个分片？</p>
<p>注意：类型码仅供内部使用。Router 将保持类型 4，支持情况将在 router 地址中指示。</p>
<p>待办事项</p>
<h2 id="router-compatibility">Router Compatibility</h2>
<h3 id="transport-names">Transport Names</h3>
<p>如果我们可以在同一端口上运行标准和混合版本，并使用版本标志，我们可能不需要新的传输名称。</p>
<p>如果我们确实需要新的传输名称，它们将是：</p>
<table>
  <thead>
      <tr>
          <th>Transport</th>
          <th>Type</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>NTCP2PQ1</td>
          <td>MLKEM512_X25519</td>
      </tr>
      <tr>
          <td>NTCP2PQ2</td>
          <td>MLKEM768_X25519</td>
      </tr>
      <tr>
          <td>NTCP2PQ3</td>
          <td>MLKEM1024_X25519</td>
      </tr>
      <tr>
          <td>SSU2PQ1</td>
          <td>MLKEM512_X25519</td>
      </tr>
      <tr>
          <td>SSU2PQ2</td>
          <td>MLKEM768_X25519</td>
      </tr>
      <tr>
          <td>请注意，SSU2 无法支持 MLKEM1024，它太大了。</td>
          <td></td>
      </tr>
  </tbody>
</table>
<h3 id="router-enc-types">Router Enc. Types</h3>
<p>我们有几个备选方案需要考虑：</p>
<h4 id="bob-kdf-for-message-2-的密钥派生函数">Bob KDF for Message 2 的密钥派生函数</h4>
<p>不推荐。仅使用上述与 router 类型匹配的新传输协议。较旧的 router 无法连接、通过其构建隧道或向其发送 netDb 消息。需要数个发布周期来调试并确保支持后才能默认启用。相比下面的替代方案，可能会延长推广时间一年或更久。</p>
<h4 id="alice-kdf-for-message-2alice-密钥派生函数用于消息-2">Alice KDF for Message 2（Alice 密钥派生函数用于消息 2）</h4>
<p>推荐。由于PQ不会影响X25519静态密钥或N握手协议，我们可以保持router为类型4，只是宣告新的传输方式。较旧的router仍然可以连接、通过其构建tunnel或向其发送netDb消息。</p>
<h4 id="kdf-for-message-3仅限-xk">KDF for Message 3（仅限 XK）</h4>
<p>类型 4 router 可以同时公布 NTCP2 和 NTCP2PQ* 地址。这些地址可以使用相同的静态密钥和其他参数，也可以不使用。这些协议可能需要使用不同的端口；在同一个端口上同时支持 NTCP2 和 NTCP2PQ* 协议会非常困难，因为没有头部或帧结构能够让 Bob 对传入的 Session Request 消息进行分类和成帧。</p>
<p>分离端口和地址对于 Java 来说会比较困难，但对于 i2pd 来说则很直接。</p>
<h4 id="split-的-kdf">split() 的 KDF</h4>
<p>Type 4 router可以同时广播SSU2和SSU2PQ<em>地址。通过添加的头部标志，Bob可以在第一条消息中识别传入的传输类型。因此，我们可以在同一端口上同时支持SSU2和SSUPQ</em>。</p>
<p>这些可以作为单独的地址发布（如 i2pd 在之前的过渡中所做的那样），或者在同一个地址中使用参数来表示 PQ 支持（如 Java i2p 在之前的过渡中所做的那样）。</p>
<p>如果在相同地址，或在不同地址的相同端口上，这些将使用相同的静态密钥和其他参数。如果在不同地址的不同端口上，这些可以使用相同的静态密钥和其他参数，也可以不使用。</p>
<p>对于 Java 来说，分离端口和地址会比较困难，但对于 i2pd 来说则很简单。</p>
<h4 id="recommendations">Recommendations</h4>
<p>待办事项</p>
<h3 id="ntcp2">NTCP2</h3>
<h4 id="noise-标识符">Noise 标识符</h4>
<p>较旧的 router 会验证 RI，因此无法连接、通过其构建隧道或向其发送 netDb 消息。需要几个发布周期来调试并确保支持后才能默认启用。会遇到与 enc. type 5/6/7 部署相同的问题；相比上述列出的 type 4 enc. type 部署替代方案，可能会将部署时间延长一年或更久。</p>
<p>没有替代方案。</p>
<h3 id="ls-enc-types">LS Enc. Types</h3>
<h4 id="1b-新会话格式带绑定">1b) 新会话格式（带绑定）</h4>
<p>这些可能会在使用较旧的 type 4 X25519 密钥的 LS 中出现。较旧的 router 会忽略未知的密钥。</p>
<p>目的地可以支持多种密钥类型，但只能通过对消息1使用每个密钥进行试验性解密来实现。可以通过维护每个密钥成功解密的计数，并首先尝试使用最常用的密钥来减轻开销。Java I2P在同一目的地上对ElGamal+X25519使用这种策略。</p>
<h3 id="dest-sig-types">Dest. Sig. Types</h3>
<h4 id="1g-新会话回复格式">1g) 新会话回复格式</h4>
<p>Router 验证 leaseSet 签名，因此无法连接或接收类型 12-17 目标的 leaseSet。需要几个发布周期来调试并确保支持后才能默认启用。</p>
<p>无替代方案。</p>
<h2 id="规范">规范</h2>
<p>最有价值的数据是端到端流量，使用 ratchet 加密。作为 tunnel 跳之间的外部观察者，数据会再被加密两次，分别是 tunnel 加密和传输加密。作为 OBEP 和 IBGW 之间的外部观察者，数据只会再被加密一次，即传输加密。作为 OBEP 或 IBGW 参与者，ratchet 是唯一的加密。然而，由于 tunnel 是单向的，要捕获 ratchet 握手中的两条消息需要 router 之间的串通，除非 tunnel 的构建将 OBEP 和 IBGW 放在同一个 router 上。</p>
<p>目前最令人担忧的后量子威胁模型是现在存储流量，以便在多年后进行解密（前向保密）。混合方法可以提供保护。</p>
<p>PQ威胁模型是在合理时间内（比如几个月内）破解认证密钥，然后冒充认证或近乎实时地进行解密，这种威胁还很遥远？而这正是我们希望迁移到PQC静态密钥的时机。</p>
<p>因此，最早的PQ威胁模型是OBEP/IBGW存储流量以备后续解密。我们应该首先实现混合棘轮机制。</p>
<p>Ratchet 是最高优先级。传输协议次之。签名是最低优先级。</p>
<p>签名推出也将比加密推出晚一年或更长时间，因为无法实现向后兼容性。此外，MLDSA在行业中的采用将由CA/Browser Forum和证书颁发机构标准化。CA首先需要硬件安全模块(HSM)支持，但目前尚不可用 <a href="https://cabforum.org/2024/10/10/2024-10-10-minutes-of-the-code-signing-certificate-working-group/">CA/Browser Forum</a>
。我们期望CA/Browser Forum推动特定参数选择的决策，包括是否支持或要求复合签名 <a href="https://datatracker.ietf.org/doc/draft-ietf-lamps-pq-composite-sigs/">IETF draft</a>
。</p>
<table>
  <thead>
      <tr>
          <th>Milestone</th>
          <th>Target</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Ratchet beta</td>
          <td>Late 2025</td>
      </tr>
      <tr>
          <td>Select best enc type</td>
          <td>Early 2026</td>
      </tr>
      <tr>
          <td>NTCP2 beta</td>
          <td>Early 2026</td>
      </tr>
      <tr>
          <td>SSU2 beta</td>
          <td>Mid 2026</td>
      </tr>
      <tr>
          <td>Ratchet production</td>
          <td>Mid 2026</td>
      </tr>
      <tr>
          <td>Ratchet default</td>
          <td>Late 2026</td>
      </tr>
      <tr>
          <td>Signature beta</td>
          <td>Late 2026</td>
      </tr>
      <tr>
          <td>NTCP2 production</td>
          <td>Late 2026</td>
      </tr>
      <tr>
          <td>SSU2 production</td>
          <td>Early 2027</td>
      </tr>
      <tr>
          <td>Select best sig type</td>
          <td>Early 2027</td>
      </tr>
      <tr>
          <td>NTCP2 default</td>
          <td>Early 2027</td>
      </tr>
      <tr>
          <td>SSU2 default</td>
          <td>Mid 2027</td>
      </tr>
      <tr>
          <td>Signature production</td>
          <td>Mid 2027</td>
      </tr>
  </tbody>
</table>
<h2 id="migration">Migration</h2>
<p>如果我们无法在相同的tunnel上同时支持旧的和新的ratchet协议，迁移将会变得更加困难。</p>
<p>我们应该能够像处理X25519时那样，逐一尝试这两种方法来验证。</p>
<h2 id="issues-1">Issues</h2>
<ul>
<li>Noise 哈希选择 - 继续使用 SHA256 还是升级？
SHA256 在未来 20-30 年应该都是安全的，不会受到后量子算法威胁，
参见 <a href="https://csrc.nist.gov/csrc/media/Presentations/2022/update-on-post-quantum-encryption-and-cryptographi/Day%202%20-%20230pm%20Chen%20PQC%20ISPAB.pdf">NIST presentation</a>
 和 <a href="https://www.nccoe.nist.gov/sites/default/files/2023-08/pqc-light-at-the-end-of-the-tunnel-presentation.pdf">NIST presentation</a>
。
如果 SHA256 被破解，我们面临的问题会更严重（netdb）。</li>
<li>NTCP2 独立端口，独立 router 地址</li>
<li>SSU2 中继 / 节点测试</li>
<li>SSU2 版本字段</li>
<li>SSU2 router 地址版本</li>
</ul>

                </article>

                
                <nav class="page-nav">
                    <a href="../../../zh/proposals/" class="page-nav-link">
                        ← Back to Proposals
                    </a>
                    
                    
                    
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                    <a href="../../../proposals/169-pq-crypto.txt" class="page-nav-link" download>
                        Download Source (.txt)
                    </a>
                    
                </nav>
            </div>
        </div>
    </div>
</div>

<style>
.proposals-page {
    min-height: 100vh;
    padding: var(--spacing-xl) 0;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
}

.breadcrumbs a:hover {
    color: var(--color-primary);
}

.separator {
    color: var(--color-border);
}

.current {
    color: var(--color-text);
}

 
.translation-disclaimer {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.dark .translation-disclaimer {
    background: #78350f;
    border-color: #d97706;
}

.disclaimer-message {
    color: #92400e;
    font-size: 0.875rem;
}

.dark .disclaimer-message {
    color: #fde047;
}

.disclaimer-link {
    color: #92400e;
    font-weight: 600;
    text-decoration: underline;
    white-space: nowrap;
}

.dark .disclaimer-link {
    color: #fde047;
}

 
.proposal-header {
    margin-bottom: var(--spacing-2xl);
}

.proposal-title-section {
    margin-bottom: var(--spacing-lg);
}

.proposal-title {
    font-size: 2.5rem;
    margin: 0 0 var(--spacing-sm) 0;
    color: var(--color-text);
}

.proposal-number {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    font-weight: 600;
}

 
.proposal-meta-box {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
}

.proposal-status {
    display: inline-block;
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: var(--spacing-md);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

 
.status-open {
    background: #dbeafe;
    color: #0369a1;
}

.dark .status-open {
    background: #0c4a6e;
    color: #7dd3fc;
}

.status-accepted {
    background: #dbeafe;
    color: #0369a1;
}

.dark .status-accepted {
    background: #0c4a6e;
    color: #7dd3fc;
}

.status-finished {
    background: #dcfce7;
    color: #15803d;
}

.dark .status-finished {
    background: #164e63;
    color: #86efac;
}

.status-closed {
    background: #dcfce7;
    color: #15803d;
}

.dark .status-closed {
    background: #164e63;
    color: #86efac;
}

.status-rejected {
    background: #fee2e2;
    color: #991b1b;
}

.dark .status-rejected {
    background: #7f1d1d;
    color: #fca5a5;
}

.status-draft,
.status-needs-revision,
.status-dead,
.status-needs-research {
    background: #fef3c7;
    color: #92400e;
}

.dark .status-draft,
.dark .status-needs-revision,
.dark .status-dead,
.dark .status-needs-research {
    background: #78350f;
    color: #fde047;
}

.status-meta,
.status-informational,
.status-reserve {
    background: #e9d5ff;
    color: #6b21a8;
}

.dark .status-meta,
.dark .status-informational,
.dark .status-reserve {
    background: #581c87;
    color: #e879f9;
}

 
.proposal-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.info-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
}

.info-value {
    font-size: 0.9375rem;
    color: var(--color-text);
    font-weight: 500;
}

 
.proposal-relationships {
    border-top: 1px solid var(--color-border);
    padding-top: var(--spacing-md);
}

.relationship {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
}

.relationship:last-child {
    margin-bottom: 0;
}

.relationship-label {
    font-weight: 600;
    color: var(--color-text-muted);
    min-width: 120px;
}

.relationship-value {
    color: var(--color-text);
}

 
.proposal-layout {
    display: block;
}

.proposal-layout--with-toc {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

 
.proposal-toc-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.toc-nav {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
}

.toc-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-text);
    padding-bottom: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.toc-content {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
}

.toc-content::-webkit-scrollbar {
    width: 4px;
}

.toc-content::-webkit-scrollbar-track {
    background: transparent;
}

.toc-content::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
}

.toc-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

.toc-nav ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc-nav li {
    margin-bottom: 0.25rem;
}

.toc-nav ul ul {
    padding-left: var(--spacing-md);
    margin-top: 0.25rem;
}

.toc-nav a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.8125rem;
    display: block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    line-height: 1.4;
}

.toc-nav a:hover {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
}

 
.proposal-main {
    min-width: 0;
}

 
.proposal-content {
    line-height: 1.8;
    color: var(--color-text);
    max-width: 900px;
}

.proposal-content h2 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.75rem;
    scroll-margin-top: 100px;
}

.proposal-content h3 {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.375rem;
    scroll-margin-top: 100px;
}

.proposal-content h4 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-xs);
    font-size: 1.125rem;
    scroll-margin-top: 100px;
}

.proposal-content p {
    margin-bottom: var(--spacing-md);
}

.proposal-content ul,
.proposal-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.proposal-content li {
    margin-bottom: var(--spacing-xs);
}

.proposal-content code {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
}

.proposal-content pre {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: var(--spacing-md);
    font-size: 0.875rem;
}

.proposal-content pre code {
    background: none;
    padding: 0;
}

.proposal-content blockquote {
    border-left: 4px solid var(--color-primary);
    padding-left: var(--spacing-md);
    margin-left: 0;
    margin-bottom: var(--spacing-md);
    font-style: italic;
    color: var(--color-text-secondary);
}

.proposal-content a {
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
}

.proposal-content a:hover {
    border-bottom-color: var(--color-primary);
}

.proposal-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: var(--spacing-md);
}

.proposal-content table th {
    background: var(--color-bg-secondary);
    padding: var(--spacing-sm);
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--color-border);
}

.proposal-content table td {
    padding: var(--spacing-sm);
    border-bottom: 1px solid var(--color-border);
}

.proposal-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin: var(--spacing-lg) 0;
    display: block;
}

 
.page-nav {
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.page-nav-link {
    display: inline-block;
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.page-nav-link:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
}

 
@media (max-width: 1024px) {
    .proposal-layout--with-toc {
        grid-template-columns: 1fr;
    }

    .proposal-toc-sidebar {
        position: static;
        max-height: none;
        margin-bottom: var(--spacing-xl);
    }

    .toc-content {
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .proposal-title {
        font-size: 1.75rem;
    }

    .proposal-info-grid {
        grid-template-columns: 1fr;
    }
}
</style>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = [];

    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const heading = document.getElementById(href.slice(1));
            if (heading) {
                headings.push({ element: heading, link: link });
            }
        }
    });

    function updateActiveLink() {
        const scrollPos = window.scrollY + 120;
        let activeIndex = 0;

        for (let i = 0; i < headings.length; i++) {
            if (headings[i].element.offsetTop <= scrollPos) {
                activeIndex = i;
            }
        }

        tocLinks.forEach(link => link.classList.remove('active'));
        if (headings[activeIndex]) {
            headings[activeIndex].link.classList.add('active');
        }
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});
</script>
<style>
.toc-nav a.active {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
    font-weight: 600;
}
</style>



    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">保持关注 I2P 新闻：</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="输入您的邮箱" required>
                            <button type="submit">订阅</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>快速链接</h3>
                <ul>
                    <li><a href="../../../zh/financial-support/">捐赠</a></li>
                    <li><a href="../../../zh/docs/overview/intro/">I2P介绍</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>社区</h3>
                <ul>
                    <li><a href="../../../zh/get-involved/">参与其中</a></li>
                    <li><a href="../../../zh/blog/">博客</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">官方论坛</a></li>
                    <li><a href="../../../zh/contact/">联系我们</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>资源</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">I2P 指标</a></li>
                    <li><a href="../../../zh/papers/">研究</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">StormyCloud</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 隐形互联网计划。在 Creative Commons 许可下。</p>
            <div class="footer-links">
                <a href="../../../zh/privacy/">隐私</a>
                <a href="../../../zh/terms/">条款</a>
                <a href="../../../zh/about/media/">媒体</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="关闭">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>社区投票</h2>
            <p class="modal-subtitle">我们很想听听您的意见</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                您的投票将帮助塑造 I2P 的未来。
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
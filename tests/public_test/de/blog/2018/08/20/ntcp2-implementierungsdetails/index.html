<!DOCTYPE html>
<html lang="de" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>NTCP2-Implementierungsdetails | I2P - Das unsichtbare Internet-Projekt</title>

    <meta name="description" content="Implementierungsdetails und technische Spezifikationen des neuen I2P-Transportprotokolls">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="NTCP2-Implementierungsdetails | I2P - Das unsichtbare Internet-Projekt">
    <meta property="og:description" content="Implementierungsdetails und technische Spezifikationen des neuen I2P-Transportprotokolls">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/de/blog/2018/08/20/ntcp2-implementierungsdetails/">

    
    <link rel="icon" type="image/svg+xml" href="../../../../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">I2P Beta-Seite jetzt live E-Mail-Probleme an stormycloud@mail.i2p</span>
            
        </div>
        
        <form method="GET" action="../../../../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="Banner schließen" title="Banner schließen">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../../../../de/" class="logo-link">
                    <img src="../../../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../../../../de/about/" class="">Über</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../../../de/about/">Übersicht</a></li>
                            <li><a href="../../../../../../de/papers/">Forschungspapiere</a></li>
                            <li><a href="../../../../../../de/about/media/">Presse</a></li>
                            <li><a href="../../../../../../de/contact/">Kontakt</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../../../../de/docs/" class="">Dokumente</a></li>
                    <li><a href="../../../../../../de/downloads/" class="">Downloads</a></li>
                    <li><a href="../../../../../../de/blog/" class="active">Blog</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../../../../de/get-involved/" class="">Mitmachen</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../../../de/get-involved/">Übersicht</a></li>
                            <li><a href="../../../../../../de/feedback/">Funktionsvorschläge</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">de</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../en/blog/2018/08/20/ntcp2-implementation-details/"
                                class="lang-option">Englisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../es/blog/2018/08/20/detalles-de-implementaci%C3%B3n-de-ntcp2/"
                                class="lang-option">Spanisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../ko/blog/2018/08/20/ntcp2-%EA%B5%AC%ED%98%84-%EC%84%B8%EB%B6%80-%EC%82%AC%ED%95%AD/"
                                class="lang-option">Koreanisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../zh/blog/2018/08/20/ntcp2-%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82/"
                                class="lang-option">Chinesisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../ru/blog/2018/08/20/%D0%BF%D0%BE%D0%B4%D1%80%D0%BE%D0%B1%D0%BD%D0%BE%D1%81%D1%82%D0%B8-%D1%80%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8-ntcp2/"
                                class="lang-option">Russisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../cs/blog/2018/08/20/podrobnosti-implementace-ntcp2/"
                                class="lang-option">Tschechisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../de/blog/2018/08/20/ntcp2-implementierungsdetails/"
                                class="lang-option active">Deutsch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../fr/blog/2018/08/20/d%C3%A9tails-de-limpl%C3%A9mentation-de-ntcp2/"
                                class="lang-option">Französisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../tr/blog/2018/08/20/ntcp2-uygulama-ayr%C4%B1nt%C4%B1lar%C4%B1/"
                                class="lang-option">Türkisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../vi/blog/2018/08/20/chi-ti%E1%BA%BFt-tri%E1%BB%83n-khai-ntcp2/"
                                class="lang-option">Vietnamesisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../hi/blog/2018/08/20/ntcp2-%E0%A4%95%E0%A4%BE%E0%A4%B0%E0%A5%8D%E0%A4%AF%E0%A4%BE%E0%A4%A8%E0%A5%8D%E0%A4%B5%E0%A4%AF%E0%A4%A8-%E0%A4%B5%E0%A4%BF%E0%A4%B5%E0%A4%B0%E0%A4%A3/"
                                class="lang-option">Hindi</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../ar/blog/2018/08/20/ntcp2-implementation-details/"
                                class="lang-option">Arabisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../../../pt/blog/2018/08/20/detalhes-de-implementa%C3%A7%C3%A3o-do-ntcp2/"
                                class="lang-option">Portugiesisch</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../../../../de/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../../../../de/downloads/" class="btn btn-primary">I2P Herunterladen</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        
<article class="blog-post">
    <div class="container">
        <div class="post-header">
            <div class="post-meta-row">
                
                <time class="post-date" datetime="2018-08-20">
                    August 20, 2018
                </time>
                

                
                <div class="post-categories">
                    
                    <span class="category-badge">development</span>
                    
                </div>
                
            </div>

            <h1 class="post-title">NTCP2-Implementierungsdetails</h1>

            
            <div class="post-author">By villain</div>
            
        </div>

        <div class="post-content">
            <p>Die Transportprotokolle von I2P wurden ursprünglich vor etwa 15 Jahren entwickelt. Damals bestand das Hauptziel darin, die übertragenen Daten zu verbergen, nicht die Tatsache, dass man das Protokoll selbst verwendete. Niemand dachte ernsthaft über Schutzmaßnahmen gegen DPI (Deep Packet Inspection) und Zensur von Protokollen nach. Die Zeiten ändern sich, und obwohl die ursprünglichen Transportprotokolle weiterhin starke Sicherheit bieten, gab es eine Nachfrage nach einem neuen Transportprotokoll. NTCP2 ist so konzipiert, dass es aktuellen Zensurbedrohungen standhält. Vor allem der DPI-Analyse von Paketlängen. Außerdem verwendet das neue Protokoll die modernsten Entwicklungen der Kryptografie. NTCP2 basiert auf dem <a href="https://noiseprotocol.org/noise.html">Noise Protocol Framework</a>
, mit SHA256 als Hashfunktion und x25519 für einen Diffie-Hellman-(DH)-Schlüsselaustausch über elliptische Kurven.</p>
<p>Die vollständige Spezifikation des NTCP2-Protokolls ist <a href="../../../../../../de/docs/specs/ntcp2/">hier zu finden</a>
.</p>
<h2 id="neue-kryptografie">Neue Kryptografie</h2>
<p>NTCP2 erfordert das Hinzufügen der folgenden kryptografischen Algorithmen zu einer I2P-Implementierung:</p>
<ul>
<li>x25519</li>
<li>HMAC-SHA256</li>
<li>Chacha20</li>
<li>Poly1305</li>
<li>AEAD</li>
<li>SipHash</li>
</ul>
<p>Im Vergleich zu unserem ursprünglichen Protokoll NTCP verwendet NTCP2 x25519 statt ElGamal für die DH-Funktion, AEAD/Chaha20/Poly1305 statt AES-256-CBC/Adler32 und verwendet SipHash zur Verschleierung der Längeninformation des Pakets. Die in NTCP2 verwendete Schlüsselableitungsfunktion ist komplexer und verwendet nun viele HMAC-SHA256-Aufrufe.</p>
<p><em>Hinweis zur i2pd-Implementierung (C++): Alle oben genannten Algorithmen, mit Ausnahme von SipHash, sind in OpenSSL 1.1.0 implementiert. SipHash wird in der kommenden Version OpenSSL 1.1.1 hinzugefügt. Zur Kompatibilität mit OpenSSL 1.0.2, das in den meisten aktuellen Systemen verwendet wird, hat der i2pd-Kernentwickler <a href="https://github.com/majestrate">Jeff Becker</a>
 eigenständige Implementierungen der fehlenden kryptografischen Algorithmen beigesteuert.</em></p>
<h2 id="routerinfo-änderungen">RouterInfo-Änderungen</h2>
<p>NTCP2 erfordert neben den beiden vorhandenen Schlüsseln (Verschlüsselungs- und Signaturschlüssel) einen dritten Schlüssel (x25519). Er wird statischer Schlüssel genannt und muss zu jeder RouterInfo-Adresse als &ldquo;s&rdquo;-Parameter hinzugefügt werden. Er ist sowohl für den NTCP2-Initiator (Alice) als auch den NTCP2-Responder (Bob) erforderlich. Wenn mehr als eine Adresse NTCP2 unterstützt, beispielsweise IPv4 und IPv6, muss &ldquo;s&rdquo; für alle identisch sein. Die Adresse von Alice darf ausschließlich den &ldquo;s&rdquo;-Parameter enthalten, ohne dass &ldquo;host&rdquo; und &ldquo;port&rdquo; gesetzt sind. Außerdem ist ein &ldquo;v&rdquo;-Parameter erforderlich, der derzeit immer auf &ldquo;2&rdquo; gesetzt ist.</p>
<p>Eine NTCP2-Adresse kann entweder als separate NTCP2-Adresse deklariert werden oder als NTCP-Adresse im alten Stil mit zusätzlichen Parametern, wobei sie in diesem Fall sowohl NTCP- als auch NTCP2-Verbindungen akzeptiert. Die Java-I2P-Implementierung verwendet den zweiten Ansatz, i2pd (C++-Implementierung) verwendet den ersten.</p>
<p>Wenn ein Knoten NTCP2-Verbindungen akzeptiert, muss er seine RouterInfo mit dem Parameter &ldquo;i&rdquo; veröffentlichen, der als Initialisierungsvektor (IV) für den öffentlichen Verschlüsselungsschlüssel verwendet wird, wenn dieser Knoten neue Verbindungen aufbaut.</p>
<h2 id="herstellen-einer-verbindung">Herstellen einer Verbindung</h2>
<p>Um eine Verbindung herzustellen, müssen beide Seiten ephemere x25519-Schlüsselpaare erzeugen. Basierend auf diesen Schlüsseln und auf &ldquo;statischen&rdquo; Schlüsseln leiten sie einen Satz von Schlüsseln für die Datenübertragung ab. Beide Parteien müssen prüfen, dass die Gegenseite tatsächlich über einen privaten Schlüssel zu diesem statischen Schlüssel verfügt und dass dieser statische Schlüssel derselbe ist wie in RouterInfo.</p>
<p>Es werden drei Nachrichten gesendet, um eine Verbindung herzustellen:</p>
<pre tabindex="0"><code>Alice                           Bob

SessionRequest -------------------&gt;
&lt;------------------- SessionCreated
SessionConfirmed -----------------&gt;
</code></pre><p>Ein gemeinsamer x25519-Schlüssel, genannt «input key material» (Eingabeschlüsselmaterial), wird für jede Nachricht berechnet, woraufhin der Schlüssel zur Nachrichtenverschlüsselung mithilfe der MixKey-Funktion erzeugt wird. Ein Wert ck (chaining key, Verkettungsschlüssel) wird während des Nachrichtenaustauschs beibehalten. Dieser Wert wird als abschließende Eingabe verwendet, wenn Schlüssel für die Datenübertragung erzeugt werden.</p>
<p>Die Funktion MixKey sieht in der C++-Implementierung von I2P ungefähr so aus:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> NTCP2Establisher<span style="color:#f92672">::</span>MixKey (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span> inputKeyMaterial, <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span> derived)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// temp_key = HMAC-SHA256(ck, input_key_material)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">uint8_t</span> tempKey[<span style="color:#ae81ff">32</span>]; <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> len;
</span></span><span style="display:flex;"><span>    HMAC(EVP_sha256(), m_CK, <span style="color:#ae81ff">32</span>, inputKeyMaterial, <span style="color:#ae81ff">32</span>, tempKey, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ck = HMAC-SHA256(temp_key, byte(0x01))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint8_t</span> one[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span>  { <span style="color:#ae81ff">1</span> };
</span></span><span style="display:flex;"><span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, one, <span style="color:#ae81ff">1</span>, m_CK, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// derived = HMAC-SHA256(temp_key, ck || byte(0x02))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    m_CK[<span style="color:#ae81ff">32</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, m_CK, <span style="color:#ae81ff">33</span>, derived, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Die <strong>SessionRequest</strong>-Nachricht besteht aus einem öffentlichen x25519-Schlüssel von Alice (32 Byte), einem mit AEAD/Chacha20/Poly1305 verschlüsselten Datenblock (16 Byte), einem Hash (16 Byte) sowie am Ende einigen Zufallsdaten (Padding). Die Länge des Paddings ist im verschlüsselten Datenblock definiert. Der verschlüsselte Block enthält außerdem die Länge des zweiten Teils der <strong>SessionConfirmed</strong>-Nachricht. Der Datenblock wird mit einem Schlüssel verschlüsselt und signiert, der aus Alices ephemerem Schlüssel und Bobs statischem Schlüssel abgeleitet wird. Der anfängliche ck-Wert für die MixKey-Funktion ist auf SHA256 gesetzt (Noise_XKaesobfse+hs2+hs3_25519_ChaChaPoly_SHA256).</p>
<p>Da die 32 Bytes des öffentlichen x25519-Schlüssels durch DPI erkannt werden können, wird er mit dem AES-256-CBC-Algorithmus verschlüsselt, wobei der Hash von Bobs Adresse als Schlüssel und der Parameter &ldquo;i&rdquo; aus der RouterInfo als Initialisierungsvektor (IV) verwendet wird.</p>
<p>Die <strong>SessionCreated</strong>-Nachricht hat die gleiche Struktur wie <strong>SessionRequest</strong>, außer dass der Schlüssel auf Grundlage der ephemeren Schlüssel beider Seiten berechnet wird. Die IV, die nach dem Ver- bzw. Entschlüsseln des öffentlichen Schlüssels aus der <strong>SessionRequest</strong>-Nachricht erzeugt wird, wird als IV zum Ver- bzw. Entschlüsseln des ephemeren öffentlichen Schlüssels verwendet.</p>
<p>Die Nachricht <strong>SessionConfirmed</strong> hat 2 Teile: einen öffentlichen statischen Schlüssel und die RouterInfo von Alice. Der Unterschied gegenüber den vorherigen Nachrichten ist, dass der ephemere öffentliche Schlüssel mit AEAD/Chaha20/Poly1305 unter Verwendung desselben Schlüssels wie bei <strong>SessionCreated</strong> verschlüsselt wird. Das führt dazu, dass der erste Teil der Nachricht von 32 auf 48 Bytes anwächst. Der zweite Teil wird ebenfalls mit AEAD/Chaha20/Poly1305 verschlüsselt, jedoch mit einem neuen Schlüssel, der aus Bobs ephemerem Schlüssel und Alices statischem Schlüssel berechnet wird. Der RouterInfo-Teil kann außerdem mit zufälligem Daten-Padding aufgefüllt werden, ist jedoch nicht erforderlich, da RouterInfo üblicherweise variable Länge hat.</p>
<h2 id="erzeugung-von-datenübertragungsschlüsseln">Erzeugung von Datenübertragungsschlüsseln</h2>
<p>Wenn jede Hash- und Schlüsselüberprüfung erfolgreich war, muss nach der letzten MixKey-Operation auf beiden Seiten ein gemeinsamer ck-Wert vorhanden sein. Dieser Wert wird verwendet, um für jede Seite einer Verbindung zwei Sätze von Schlüsseln &lt;k, sipk, sipiv&gt; zu erzeugen. &ldquo;k&rdquo; ist ein AEAD/Chaha20/Poly1305-Schlüssel, &ldquo;sipk&rdquo; ist ein SipHash-Schlüssel, &ldquo;sipiv&rdquo; ist ein Initialwert für den SipHash IV (Initialisierungsvektor), der nach jeder Verwendung geändert wird.</p>
<p>Der zur Generierung von Schlüsseln verwendete Code sieht in der C++-Implementierung von I2P so aus:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> NTCP2Session<span style="color:#f92672">::</span>KeyDerivationFunctionDataPhase ()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint8_t</span> tempKey[<span style="color:#ae81ff">32</span>]; <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> len;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// temp_key = HMAC-SHA256(ck, zerolen)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), m_Establisher<span style="color:#f92672">-&gt;</span>GetCK (), <span style="color:#ae81ff">32</span>, <span style="color:#66d9ef">nullptr</span>, <span style="color:#ae81ff">0</span>, tempKey, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint8_t</span> one[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span>  { <span style="color:#ae81ff">1</span> };
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// k_ab = HMAC-SHA256(temp_key, byte(0x01)).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, one, <span style="color:#ae81ff">1</span>, m_Kab, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    m_Kab[<span style="color:#ae81ff">32</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// k_ba = HMAC-SHA256(temp_key, k_ab || byte(0x02))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, m_Kab, <span style="color:#ae81ff">33</span>, m_Kba, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint8_t</span> ask[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> { <span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;s&#39;</span>, <span style="color:#e6db74">&#39;k&#39;</span>, <span style="color:#ae81ff">1</span> }, master[<span style="color:#ae81ff">32</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ask_master = HMAC-SHA256(temp_key, &#34;ask&#34; || byte(0x01))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, ask, <span style="color:#ae81ff">4</span>, master, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint8_t</span> h[<span style="color:#ae81ff">39</span>];
</span></span><span style="display:flex;"><span>    memcpy (h, m_Establisher<span style="color:#f92672">-&gt;</span>GetH (), <span style="color:#ae81ff">32</span>);
</span></span><span style="display:flex;"><span>    memcpy (h <span style="color:#f92672">+</span> <span style="color:#ae81ff">32</span>, <span style="color:#e6db74">&#34;siphash&#34;</span>, <span style="color:#ae81ff">7</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// temp_key = HMAC-SHA256(ask_master, h || &#34;siphash&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), master, <span style="color:#ae81ff">32</span>, h, <span style="color:#ae81ff">39</span>, tempKey, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sip_master = HMAC-SHA256(temp_key, byte(0x01))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, one, <span style="color:#ae81ff">1</span>, master, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// temp_key = HMAC-SHA256(sip_master, zerolen)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), master, <span style="color:#ae81ff">32</span>, <span style="color:#66d9ef">nullptr</span>, <span style="color:#ae81ff">0</span>, tempKey, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// sipkeys_ab = HMAC-SHA256(temp_key, byte(0x01)).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, one, <span style="color:#ae81ff">1</span>, m_Sipkeysab, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>    m_Sipkeysab[<span style="color:#ae81ff">32</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">// sipkeys_ba = HMAC-SHA256(temp_key, sipkeys_ab || byte(0x02))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HMAC(EVP_sha256(), tempKey, <span style="color:#ae81ff">32</span>, m_Sipkeysab, <span style="color:#ae81ff">33</span>, m_Sipkeysba, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><em>i2pd (C++) Implementierungshinweis: Die ersten 16 Bytes des Arrays &ldquo;sipkeys&rdquo; bilden einen SipHash-Schlüssel, die letzten 8 Bytes bilden den IV (Initialisierungsvektor). SipHash erfordert zwei 8-Byte-Schlüssel, aber i2pd behandelt sie als einen einzigen 16-Byte-Schlüssel.</em></p>
<h2 id="data-transferring">Data Transferring</h2>
<p>Daten werden in Frames übertragen, jedes davon besteht aus drei Teilen:</p>
<ul>
<li>2 bytes of frame length obfuscated with SipHash</li>
<li>data encrypted with Chacha20</li>
<li>16 bytes of Poly1305 hash value</li>
</ul>
<p>Die maximale Länge der in einem Frame übertragenen Daten beträgt 65519 Bytes.</p>
<p>Die Nachrichtenlänge wird verschleiert, indem die XOR-Funktion mit den ersten beiden Bytes des aktuellen SipHash-IVs angewendet wird.</p>
<p>Der verschlüsselte Datenabschnitt enthält Datenblöcke. Jedem Block wird ein 3-Byte-Header vorangestellt, der Blocktyp und Blocklänge definiert. In der Regel werden I2NP-Typ-Blöcke übertragen; dabei handelt es sich um I2NP-Nachrichten mit verändertem Header. Ein NTCP2-Frame kann mehrere I2NP-Blöcke übertragen.</p>
<p>Der andere wichtige Datenblocktyp ist ein zufälliger Datenblock. Es wird empfohlen, jedem NTCP2-Frame einen zufälligen Datenblock hinzuzufügen. Es kann nur ein zufälliger Datenblock hinzugefügt werden, und er muss der letzte Block sein.</p>
<p>Dies sind weitere Datenblöcke, die in der aktuellen NTCP2-Implementierung verwendet werden:</p>
<ul>
<li><strong>RouterInfo</strong> — usually contains Bob&rsquo;s RouterInfo after the connection has been established, but it can also contain RouterInfo of a random node for the purpose of speeding up floodfills (there is a flags field for that case).</li>
<li><strong>Termination</strong> — is used when a host explicitly terminates a connection and specifies a reason for that.</li>
<li><strong>DateTime</strong> — a current time in seconds.</li>
</ul>
<h2 id="zusammenfassung">Zusammenfassung</h2>
<p>Das neue I2P-Transportprotokoll NTCP2 bietet wirksamen Schutz vor DPI-Zensur. Es führt außerdem zu geringerer CPU-Last aufgrund der verwendeten schnelleren, modernen Kryptografie. Damit ist es wahrscheinlicher, dass I2P auf leistungsschwachen Geräten wie Smartphones und Heimroutern läuft. Beide großen I2P-Implementierungen unterstützen NTCP2 vollständig und stellen NTCP2 ab Version 0.9.36 (Java) bzw. 2.20 (i2pd, C++) zur Verfügung.</p>

        </div>

        <div class="post-navigation">
            <a href="../../../../../../de/blog" class="back-to-blog">← Back to Blog</a>
        </div>
    </div>
</article>

<style>
.blog-post {
    padding: var(--spacing-2xl) 0;
}

.post-header {
    margin-bottom: var(--spacing-2xl);
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    padding-bottom: var(--spacing-xl);
    border-bottom: 1px solid var(--color-border);
}

.post-meta-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

.post-date {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.post-categories {
    display: flex;
    gap: var(--spacing-xs);
}

.category-badge {
    padding: 0.25rem 0.625rem;
    background-color: var(--color-primary);
    color: white;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.post-title {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-sm);
    line-height: 1.2;
}

.post-author {
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
}

.post-content {
    max-width: 800px;
    margin: 0 auto var(--spacing-2xl);
    line-height: 1.8;
    font-size: 1.0625rem;
}

.post-content h2,
.post-content h3,
.post-content h4 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
}

.post-content h2 {
    font-size: 1.875rem;
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--color-border);
}

.post-content h3 {
    font-size: 1.5rem;
}

.post-content h4 {
    font-size: 1.25rem;
}

.post-content ul,
.post-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.post-content li {
    margin-bottom: var(--spacing-sm);
}

.post-content pre {
    background-color: var(--color-bg-secondary);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    overflow-x: auto;
    margin: var(--spacing-lg) 0;
    border: 1px solid var(--color-border);
}

.post-content code {
    font-family: var(--font-mono);
    font-size: 0.875em;
}

.post-content pre code {
    background-color: transparent;
    padding: 0;
}

.post-content :not(pre) > code {
    background-color: var(--color-bg-tertiary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
}

.post-navigation {
    max-width: 800px;
    margin: var(--spacing-2xl) auto 0;
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
}

.back-to-blog {
    color: var(--color-primary);
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    transition: gap var(--transition-fast);
}

.back-to-blog:hover {
    gap: var(--spacing-sm);
}

@media (max-width: 768px) {
    .post-meta-row {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-xs);
    }

    .post-title {
        font-size: 2rem;
    }

    .post-content {
        font-size: 1rem;
    }
}
</style>

    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">Bleiben Sie über I2P-Neuigkeiten informiert:</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="Geben Sie Ihre E-Mail ein" required>
                            <button type="submit">Abonnieren</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>Schnellzugriff</h3>
                <ul>
                    <li><a href="../../../../../../de/financial-support/">Spenden</a></li>
                    <li><a href="../../../../../../de/docs/overview/intro/">I2P Einführung</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Gemeinschaft</h3>
                <ul>
                    <li><a href="../../../../../../de/get-involved/">Mitmachen</a></li>
                    <li><a href="../../../../../../de/blog/">Blog</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">Offizielle Foren</a></li>
                    <li><a href="../../../../../../de/contact/">Kontakt</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Ressourcen</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">I2P Metriken</a></li>
                    <li><a href="../../../../../../de/papers/">Forschung</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">StormyCloud</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 Das Invisible Internet Project. Lizenziert unter Creative Commons.</p>
            <div class="footer-links">
                <a href="../../../../../../de/privacy/">Datenschutz</a>
                <a href="../../../../../../de/terms/">Bedingungen</a>
                <a href="../../../../../../de/about/media/">Presse</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="Schließen">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>Community-Umfrage</h2>
            <p class="modal-subtitle">Wir würden uns freuen, von Ihnen zu hören</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                Ihre Stimme hilft dabei, die Zukunft von I2P zu gestalten.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>
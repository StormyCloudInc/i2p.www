<!DOCTYPE html>
<html lang="de" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>NTCP2 Transport | I2P - Das unsichtbare Internet-Projekt</title>

    <meta name="description" content="Noise-basierter TCP-Transport für router-zu-router-Verbindungen">
    <meta name="keywords" content="i2p, privacy, anonymity, dark net, encryption, security">

    
    <meta property="og:title" content="NTCP2 Transport | I2P - Das unsichtbare Internet-Projekt">
    <meta property="og:description" content="Noise-basierter TCP-Transport für router-zu-router-Verbindungen">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/de/docs/specs/ntcp2/">

    
    <link rel="icon" type="image/svg+xml" href="../../../../images/favicon.svg">
    <link rel="icon" type="image/png" href="../../../../images/i2plogo.png" sizes="32x32">

    
    
    
    
    <link rel="stylesheet" href="../../../../css/main.min.be6880f32f5ff44e57579da7b11513b973319944ebe38748e3ac7f3268662d18.css" integrity="sha256-vmiA8y9f9E5XV52nsRUTuXMxmUTr44dI46x/MmhmLRg=">
    


    
</head>

<body>
    
    <input type="checkbox" id="theme-toggle-checkbox" class="theme-checkbox" aria-hidden="true">

    
<div class="site-banner" id="site-banner" data-banner-id="banner-3" role="alert" aria-live="polite">
    <div class="container">
        <div class="banner-content">
            <span class="banner-message">I2P Beta-Seite jetzt live E-Mail-Probleme an stormycloud@mail.i2p</span>
            
        </div>
        
        <form method="GET" action="../../../../api/banner/dismiss" style="display: inline;">
            <input type="hidden" name="id" value="banner-3">
            <button type="submit" class="banner-close" aria-label="Banner schließen" title="Banner schließen">
                <span aria-hidden="true">&times;</span>
            </button>
        </form>
        
    </div>
</div>


    <header class="site-header">
    <div class="container">
        <nav class="main-nav">
            <div class="nav-brand">
                <a href="../../../../de/" class="logo-link">
                    <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="logo logo-light">
                    <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="logo logo-dark">
                </a>
            </div>

            
            <input type="checkbox" id="mobile-menu-checkbox" class="mobile-menu-checkbox"
                aria-label="Toggle navigation menu">
            <label for="mobile-menu-checkbox" class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span class="hamburger"></span>
            </label>

            <div class="nav-menu">
                <ul class="nav-links">
                    <li class="nav-dropdown">
                        <a href="../../../../de/about/" class="">Über</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../de/about/">Übersicht</a></li>
                            <li><a href="../../../../de/papers/">Forschungspapiere</a></li>
                            <li><a href="../../../../de/about/media/">Presse</a></li>
                            <li><a href="../../../../de/contact/">Kontakt</a></li>
                        </ul>
                    </li>
                    <li><a href="../../../../de/docs/" class="active">Dokumente</a></li>
                    <li><a href="../../../../de/downloads/" class="">Downloads</a></li>
                    <li><a href="../../../../de/blog/" class="">Blog</a></li>
                    <li class="nav-dropdown">
                        <a href="../../../../de/get-involved/" class="">Mitmachen</a>
                        <ul class="dropdown-menu">
                            <li><a href="../../../../de/get-involved/">Übersicht</a></li>
                            <li><a href="../../../../de/feedback/">Funktionsvorschläge</a></li>
                        </ul>
                    </li>
                </ul>

                <div class="nav-actions">
                    
                    <div class="language-selector">
                        <button class="language-toggle" aria-label="Select language" title="Language">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                            <span class="current-lang">de</span>
                        </button>
                        <div class="language-dropdown">
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../en/docs/specs/ntcp2/"
                                class="lang-option">Englisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../es/docs/specs/ntcp2/"
                                class="lang-option">Spanisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ko/docs/specs/ntcp2/"
                                class="lang-option">Koreanisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../zh/docs/specs/ntcp2/"
                                class="lang-option">Chinesisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ru/docs/specs/ntcp2/"
                                class="lang-option">Russisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../cs/docs/specs/ntcp2/"
                                class="lang-option">Tschechisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../de/docs/specs/ntcp2/"
                                class="lang-option active">Deutsch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../fr/docs/specs/ntcp2/"
                                class="lang-option">Französisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../tr/docs/specs/ntcp2/"
                                class="lang-option">Türkisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../vi/docs/specs/ntcp2/"
                                class="lang-option">Vietnamesisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../hi/docs/specs/ntcp2/"
                                class="lang-option">Hindi</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../ar/docs/specs/ntcp2/"
                                class="lang-option">Arabisch</a>
                            
                            
                            
                            
                            
                            
                            
                            
                            <a href="../../../../pt/docs/specs/ntcp2/"
                                class="lang-option">Portugiesisch</a>
                            
                            
                        </div>
                    </div>

                    
                    <label for="theme-toggle-checkbox" class="theme-toggle" aria-label="Toggle dark mode"
                        title="Toggle theme">
                        <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                                stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                        </svg>
                    </label>

                    
                    <a href="../../../../de/financial-support/" class="btn btn-primary" id="donate-btn">Donate</a>

                    
                    <a href="../../../../de/downloads/" class="btn btn-primary">I2P Herunterladen</a>
                </div>
            </div>
        </nav>
    </div>
</header>

    <main id="main-content">
        




<div class="docs-page">
    <div class="container">
        
        <div class="docs-layout docs-layout--with-toc">
            
            
            <aside class="docs-toc-sidebar">
                <nav class="toc-nav">
                    <div class="toc-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        On This Page
                    </div>
                    <div class="toc-content">
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#übersicht">Übersicht</a></li>
    <li><a href="#noise-protocol-framework-kryptografisches-protokoll-framework-noise">Noise Protocol Framework (kryptografisches Protokoll-Framework „Noise“)</a>
      <ul>
        <li><a href="#i2p-spezifische-erweiterungen">I2P-spezifische Erweiterungen</a></li>
      </ul>
    </li>
    <li><a href="#ablauf-des-handshakes">Ablauf des Handshakes</a>
      <ul>
        <li><a href="#drei-nachrichten-handshake">Drei-Nachrichten-Handshake</a></li>
        <li><a href="#noise-nachrichtenmuster">Noise-Nachrichtenmuster</a></li>
      </ul>
    </li>
    <li><a href="#nachrichtenspezifikationen">Nachrichtenspezifikationen</a>
      <ul>
        <li><a href="#schlüsselnotation">Schlüsselnotation</a></li>
        <li><a href="#authentifizierte-verschlüsselung-chacha20-poly1305">Authentifizierte Verschlüsselung (ChaCha20-Poly1305)</a></li>
      </ul>
    </li>
    <li><a href="#nachricht-1-sessionrequest-sitzungsanfrage">Nachricht 1: SessionRequest (Sitzungsanfrage)</a>
      <ul>
        <li><a href="#rohformat">Rohformat</a></li>
        <li><a href="#entschlüsselter-inhalt">Entschlüsselter Inhalt</a></li>
        <li><a href="#optionsblock-16-byte-big-endian">Optionsblock (16 Byte, Big-Endian)</a></li>
        <li><a href="#schlüsselableitungsfunktion-kdf-1">Schlüsselableitungsfunktion (KDF-1)</a></li>
        <li><a href="#implementierungshinweise">Implementierungshinweise</a></li>
      </ul>
    </li>
    <li><a href="#nachricht-2-sessioncreated-sitzung-erstellt">Nachricht 2: SessionCreated (Sitzung erstellt)</a>
      <ul>
        <li><a href="#rohformat-1">Rohformat</a></li>
        <li><a href="#entschlüsselter-inhalt-1">Entschlüsselter Inhalt</a></li>
        <li><a href="#optionsblock-16-bytes-big-endian-höherwertiges-byte-zuerst">Optionsblock (16 Bytes, big-endian (höherwertiges Byte zuerst))</a></li>
        <li><a href="#schlüsselableitungsfunktion-kdf-2">Schlüsselableitungsfunktion (KDF-2)</a></li>
        <li><a href="#implementierungshinweise-1">Implementierungshinweise</a></li>
      </ul>
    </li>
    <li><a href="#nachricht-3-sessionconfirmed-sitzung-bestätigt">Nachricht 3: SessionConfirmed (Sitzung bestätigt)</a>
      <ul>
        <li><a href="#zweiteilige-struktur">Zweiteilige Struktur</a></li>
        <li><a href="#rohformat-2">Rohformat</a></li>
        <li><a href="#entschlüsselter-inhalt-2">Entschlüsselter Inhalt</a></li>
        <li><a href="#schlüsselableitungsfunktion-kdf-3">Schlüsselableitungsfunktion (KDF-3)</a></li>
        <li><a href="#hinweise-zur-implementierung">Hinweise zur Implementierung</a></li>
      </ul>
    </li>
    <li><a href="#datenphase">Datenphase</a>
      <ul>
        <li><a href="#schlüsselableitungsfunktion-datenphase">Schlüsselableitungsfunktion (Datenphase)</a></li>
        <li><a href="#rahmenstruktur">Rahmenstruktur</a></li>
        <li><a href="#siphash-längenverschleierung">SipHash-Längenverschleierung</a></li>
        <li><a href="#blockformat">Blockformat</a></li>
        <li><a href="#blocktypen">Blocktypen</a></li>
        <li><a href="#blocktyp-0-datumuhrzeit">Blocktyp 0: Datum/Uhrzeit</a></li>
        <li><a href="#blocktyp-1-optionen">Blocktyp 1: Optionen</a></li>
        <li><a href="#blocktyp-2-routerinfo">Blocktyp 2: RouterInfo</a></li>
        <li><a href="#blocktyp-3-i2np-nachricht">Blocktyp 3: I2NP-Nachricht</a></li>
        <li><a href="#blocktyp-4-beendigung">Blocktyp 4: Beendigung</a></li>
        <li><a href="#blocktyp-254-auffüllung">Blocktyp 254: Auffüllung</a></li>
      </ul>
    </li>
    <li><a href="#aead-fehlerbehandlung">AEAD-Fehlerbehandlung</a>
      <ul>
        <li><a href="#handshake-phase-nachrichten-1-3">Handshake-Phase (Nachrichten 1-3)</a></li>
        <li><a href="#datenphase-1">Datenphase</a></li>
      </ul>
    </li>
    <li><a href="#veröffentlichte-routerinfo">Veröffentlichte RouterInfo</a>
      <ul>
        <li><a href="#format-der-router-adresse">Format der Router-Adresse</a></li>
        <li><a href="#erforderliche-optionen">Erforderliche Optionen</a></li>
        <li><a href="#beispielhafte-routeraddress-einträge">Beispielhafte RouterAddress-Einträge</a></li>
        <li><a href="#unveröffentlichte-ntcp2-adresse">Unveröffentlichte NTCP2-Adresse</a></li>
        <li><a href="#rotation-von-öffentlichem-schlüssel-und-iv-initialisierungsvektor">Rotation von öffentlichem Schlüssel und IV (Initialisierungsvektor)</a></li>
      </ul>
    </li>
    <li><a href="#versionserkennung">Versionserkennung</a></li>
    <li><a href="#richtlinien-zur-uhrzeitabweichung">Richtlinien zur Uhrzeitabweichung</a>
      <ul>
        <li><a href="#bobs-verarbeitung-nachricht-1">Bobs Verarbeitung (Nachricht 1)</a></li>
        <li><a href="#alices-verarbeitung-nachricht-2">Alices Verarbeitung (Nachricht 2)</a></li>
        <li><a href="#bobs-verarbeitung-nachricht-3">Bobs Verarbeitung (Nachricht 3)</a></li>
        <li><a href="#zeitsynchronisierung">Zeitsynchronisierung</a></li>
      </ul>
    </li>
    <li><a href="#sicherheitseigenschaften">Sicherheitseigenschaften</a>
      <ul>
        <li><a href="#vorwärtsgeheimnis">Vorwärtsgeheimnis</a></li>
        <li><a href="#authentifizierung">Authentifizierung</a></li>
        <li><a href="#widerstand-gegen-verkehrsanalyse">Widerstand gegen Verkehrsanalyse</a></li>
        <li><a href="#abwehr-von-denial-of-service-angriffen">Abwehr von Denial-of-Service-Angriffen</a></li>
        <li><a href="#kryptografische-sicherheit">Kryptografische Sicherheit</a></li>
      </ul>
    </li>
    <li><a href="#referenzen">Referenzen</a>
      <ul>
        <li><a href="#primäre-spezifikationen">Primäre Spezifikationen</a></li>
        <li><a href="#kryptografische-standards">Kryptografische Standards</a></li>
        <li><a href="#verwandte-i2p-spezifikationen">Verwandte I2P-Spezifikationen</a></li>
        <li><a href="#referenzen-zur-implementierung">Referenzen zur Implementierung</a></li>
        <li><a href="#historischer-kontext">Historischer Kontext</a></li>
      </ul>
    </li>
    <li><a href="#implementierungsrichtlinien">Implementierungsrichtlinien</a>
      <ul>
        <li><a href="#verbindliche-anforderungen">Verbindliche Anforderungen</a></li>
        <li><a href="#empfohlene-vorgehensweisen">Empfohlene Vorgehensweisen</a></li>
        <li><a href="#häufige-fallstricke">Häufige Fallstricke</a></li>
        <li><a href="#testmethodik">Testmethodik</a></li>
        <li><a href="#migration-von-ntcp">Migration von NTCP</a></li>
      </ul>
    </li>
    <li><a href="#anhang-a-noise-xk-muster">Anhang A: Noise-XK-Muster</a></li>
    <li><a href="#anhang-b-base64-kodierung">Anhang B: Base64-Kodierung</a></li>
    <li><a href="#anhang-c-analyse-von-paketmitschnitten">Anhang C: Analyse von Paketmitschnitten</a></li>
    <li><a href="#anhang-d-versionsverlauf">Anhang D: Versionsverlauf</a></li>
  </ul>
</nav>
                    </div>
                </nav>
            </aside>
            

            
            <div class="docs-main">
                
                <nav class="breadcrumbs">
                    <a href="../../../../de/">Home</a>
                    <span class="separator">/</span>
                    <a href="../../../../de/docs/">Docs</a>
                    
                        
                            <span class="separator">/</span>
                            <a href="../../../../de/docs/specs/">Specifications</a>
                        
                    
                    <span class="separator">/</span>
                    <span class="current">NTCP2 Transport</span>
                </nav>

                
<div class="translation-disclaimer" role="note">
    <span class="disclaimer-message">Diese Übersetzung wurde mittels maschinellem Lernen erstellt und ist möglicherweise nicht 100% korrekt.</span>
    
    
    <a href="../../../../en/docs/specs/ntcp2/" class="disclaimer-link">Englische Version anzeigen</a>
    
</div>



                
                <header class="article-header">
                    <h1 class="article-title">NTCP2 Transport</h1>
                    
                        <p class="article-description">Noise-basierter TCP-Transport für router-zu-router-Verbindungen</p>
                    
                    <div class="article-meta">
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                Updated: 2025-10
                            </span>
                        
                        
                            <span class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Accurate for: 0.9.66
                            </span>
                        
                    </div>
                </header>

                
                <article class="article-content">
                    <h2 id="übersicht">Übersicht</h2>
<p>NTCP2 ersetzt den veralteten NTCP-Transport durch einen auf dem Noise-Protokoll basierenden Handshake, der gegen Traffic-Fingerprinting resistent ist, Längenfelder verschlüsselt und moderne Cipher-Suites unterstützt. Router können NTCP2 parallel zu SSU2 als die beiden obligatorischen Transportprotokolle im I2P-Netzwerk betreiben. NTCP (Version 1) wurde in 0.9.40 (Mai 2019) als veraltet markiert und in 0.9.50 (Mai 2021) vollständig entfernt.</p>
<h2 id="noise-protocol-framework-kryptografisches-protokoll-framework-noise">Noise Protocol Framework (kryptografisches Protokoll-Framework „Noise“)</h2>
<p>NTCP2 verwendet das Noise Protocol Framework <a href="https://noiseprotocol.org/noise.html">Revision 33, 2017-10-04</a>
 mit I2P-spezifischen Erweiterungen:</p>
<ul>
<li><strong>Muster</strong>: <code>Noise_XK_25519_ChaChaPoly_SHA256</code></li>
<li><strong>Erweiterter Bezeichner</strong>: <code>Noise_XKaesobfse+hs2+hs3_25519_ChaChaPoly_SHA256</code> (für KDF-Initialisierung)</li>
<li><strong>DH-Funktion</strong>: X25519 (RFC 7748) - 32-Byte-Schlüssel, Little-Endian-Codierung</li>
<li><strong>Chiffre</strong>: AEAD_CHACHA20_POLY1305 (RFC 7539/RFC 8439)
<ul>
<li>12-Byte-Nonce: erste 4 Bytes sind Null, die letzten 8 Bytes sind ein Zähler (Little-Endian)</li>
<li>Maximaler Nonce-Wert: 2^64 - 2 (die Verbindung muss beendet werden, bevor 2^64 - 1 erreicht wird)</li>
</ul>
</li>
<li><strong>Hash-Funktion</strong>: SHA-256 (32-Byte-Ausgabe)</li>
<li><strong>MAC</strong>: Poly1305 (16-Byte-Authentifizierungstag)</li>
</ul>
<h3 id="i2p-spezifische-erweiterungen">I2P-spezifische Erweiterungen</h3>
<ol>
<li><strong>AES-Verschleierung</strong>: Ephemere Schlüssel, mit AES-256-CBC unter Verwendung von Bobs Router-Hash und veröffentlichtem IV verschlüsselt</li>
<li><strong>Zufälliges Padding</strong>: Klartext-Padding in den Nachrichten 1–2 (authentifiziert), AEAD-Padding ab Nachricht 3 (verschlüsselt)</li>
<li><strong>SipHash-2-4-Längenverschleierung</strong>: Zweibyte-Frame-Längen werden mit der SipHash-Ausgabe XOR-verknüpft</li>
<li><strong>Frame-Struktur</strong>: Längenpräfixierte Frames für die Datenphase (TCP-Streaming-Kompatibilität)</li>
<li><strong>Blockbasierte Nutzlasten</strong>: Strukturiertes Datenformat mit typisierten Blöcken</li>
</ol>
<h2 id="ablauf-des-handshakes">Ablauf des Handshakes</h2>
<pre tabindex="0"><code>Alice (Initiator)             Bob (Responder)
SessionRequest  ──────────────────────►
                ◄────────────────────── SessionCreated
SessionConfirmed ──────────────────────►
</code></pre><h3 id="drei-nachrichten-handshake">Drei-Nachrichten-Handshake</h3>
<ol>
<li><strong>SessionRequest</strong> - Alices verschleierter ephemerer Schlüssel, Optionen, Padding-Hinweise</li>
<li><strong>SessionCreated</strong> - Bobs verschleierter ephemerer Schlüssel, verschlüsselte Optionen, Padding</li>
<li><strong>SessionConfirmed</strong> - Alices verschlüsselter statischer Schlüssel und RouterInfo (zwei AEAD-Frames)</li>
</ol>
<h3 id="noise-nachrichtenmuster">Noise-Nachrichtenmuster</h3>
<pre tabindex="0"><code>XK(s, rs):           Authentication   Confidentiality
  &lt;- s               (Bob&#39;s static key known in advance)
  -&gt; e, es                  0                2
  &lt;- e, ee                  2                1
  -&gt; s, se                  2                5
  &lt;-                        2                5
</code></pre><p><strong>Authentifizierungsstufen:</strong> - 0: Keine Authentifizierung (jede Partei könnte es gesendet haben) - 2: Absenderauthentifizierung, resistent gegen key-compromise impersonation (KCI, Identitätsanmaßung bei Schlüsselkompromittierung)</p>
<p><strong>Vertraulichkeitsstufen:</strong> - 1: Ephemerer Empfänger (Vorwärtsgeheimnis, keine Empfänger-Authentifizierung) - 2: Bekannter Empfänger, Vorwärtsgeheimnis nur bei Kompromittierung des Senders - 5: Starkes Vorwärtsgeheimnis (ephemeral-ephemeral + ephemeral-static DH (Diffie-Hellman))</p>
<h2 id="nachrichtenspezifikationen">Nachrichtenspezifikationen</h2>
<h3 id="schlüsselnotation">Schlüsselnotation</h3>
<ul>
<li><code>RH_A</code> = Router Hash für Alice (32 Byte, SHA-256)</li>
<li><code>RH_B</code> = Router Hash für Bob (32 Byte, SHA-256)</li>
<li><code>||</code> = Verkettungsoperator</li>
<li><code>byte(n)</code> = Einzelnes Byte mit dem Wert n</li>
<li>Alle Mehrbyte-Ganzzahlen sind <strong>big-endian</strong>, sofern nicht anders angegeben</li>
<li>X25519-Schlüssel sind <strong>little-endian</strong> (32 Byte)</li>
</ul>
<h3 id="authentifizierte-verschlüsselung-chacha20-poly1305">Authentifizierte Verschlüsselung (ChaCha20-Poly1305)</h3>
<p><strong>Verschlüsselungsfunktion:</strong></p>
<pre tabindex="0"><code>AEAD_ChaCha20_Poly1305(key, nonce, associatedData, plaintext)
  → (ciphertext || MAC)
</code></pre><p><strong>Parameter:</strong> - <code>key</code>: 32-Byte-Chiffrierschlüssel aus KDF (Schlüsselableitungsfunktion) - <code>nonce</code>: 12 Byte (4 Nullbytes + 8-Byte-Zähler, Little-Endian) - <code>associatedData</code>: 32-Byte-Hash in der Handshake-Phase; Länge 0 in der Datenphase - <code>plaintext</code>: Zu verschlüsselnde Daten (0+ Byte)</p>
<p><strong>Ausgabe:</strong> - Geheimtext: gleiche Länge wie der Klartext - MAC: 16 Bytes (Poly1305-Authentifizierungstag)</p>
<p><strong>Nonce-Verwaltung (einmalig verwendeter Wert):</strong> - Der Zähler beginnt bei 0 für jede Verschlüsselungsinstanz - Erhöht sich bei jeder AEAD-Operation in dieser Richtung - Separate Zähler für Alice→Bob und Bob→Alice in der Datenphase - Die Verbindung muss beendet werden, bevor der Zähler den Wert 2^64 - 1 erreicht</p>
<h2 id="nachricht-1-sessionrequest-sitzungsanfrage">Nachricht 1: SessionRequest (Sitzungsanfrage)</h2>
<p>Alice stellt eine Verbindung zu Bob her.</p>
<p><strong>Noise-Operationen</strong>: <code>e, es</code> (Erzeugung und Austausch ephemerer Schlüssel)</p>
<h3 id="rohformat">Rohformat</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+    AES-256-CBC Encrypted X (32B)      +
|    Key: RH_B, IV: Bob&#39;s published IV  |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+    ChaChaPoly Frame (48 bytes)        +
|    Plaintext: 32B (X + options)       |
+    k from KDF-1, n=0, ad=h            +
|                                       |
+----+----+----+----+----+----+----+----+
|    Cleartext Padding (optional)       |
+    Length specified in options         +
|    0 to 65535 - 80 bytes              |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Größenbeschränkungen:</strong> - Minimum: 80 Bytes (32 AES + 48 AEAD) - Maximum: 65535 Bytes insgesamt - <strong>Sonderfall</strong>: Max. 287 Bytes beim Verbindungsaufbau zu &ldquo;NTCP&rdquo;-Adressen (Versionserkennung)</p>
<h3 id="entschlüsselter-inhalt">Entschlüsselter Inhalt</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+    X (Alice ephemeral public key)     +
|    32 bytes, X25519, little-endian    |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|           Options Block               |
+             (16 bytes)                +
|                                       |
+----+----+----+----+----+----+----+----+
|    Cleartext Padding (optional)       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+
</code></pre><h3 id="optionsblock-16-byte-big-endian">Optionsblock (16 Byte, Big-Endian)</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| id | ver|  padLen | m3p2len | Rsvd(0) |
+----+----+----+----+----+----+----+----+
|        tsA        |   Reserved (0)    |
+----+----+----+----+----+----+----+----+

id      : 1 byte  - Network ID (2 for mainnet, 16-254 for testnets)
ver     : 1 byte  - Protocol version (currently 2)
padLen  : 2 bytes - Padding length in this message (0-65455)
m3p2len : 2 bytes - Length of SessionConfirmed part 2 frame
Rsvd    : 2 bytes - Reserved, set to 0
tsA     : 4 bytes - Unix timestamp (seconds since epoch)
Reserved: 4 bytes - Reserved, set to 0
</code></pre><p><strong>Kritische Felder:</strong> - <strong>Network ID</strong> (seit 0.9.42): Schnelle Zurückweisung netzwerkübergreifender Verbindungen - <strong>m3p2len</strong>: Exakte Größe von Nachricht 3, Teil 2 (muss beim Senden übereinstimmen)</p>
<h3 id="schlüsselableitungsfunktion-kdf-1">Schlüsselableitungsfunktion (KDF-1)</h3>
<p><strong>Protokoll initialisieren:</strong></p>
<pre tabindex="0"><code>protocol_name = &#34;Noise_XKaesobfse+hs2+hs3_25519_ChaChaPoly_SHA256&#34;
h = SHA256(protocol_name)
ck = h  // Chaining key initialized to hash
</code></pre><p><strong>MixHash-Operationen:</strong></p>
<pre tabindex="0"><code>h = SHA256(h)                    // Null prologue
h = SHA256(h || rs)              // Bob&#39;s static key (known)
h = SHA256(h || e.pubkey)        // Alice&#39;s ephemeral key X
// h is now the associated data for message 1 AEAD
</code></pre><p><strong>MixKey-Operation (es-Pattern):</strong></p>
<pre tabindex="0"><code>dh_result = X25519(Alice.ephemeral_private, Bob.static_public)
temp_key = HMAC-SHA256(ck, dh_result)
ck = HMAC-SHA256(temp_key, byte(0x01))
k = HMAC-SHA256(temp_key, ck || byte(0x02))
// k is the cipher key for message 1
// ck is retained for message 2 KDF
</code></pre><h3 id="implementierungshinweise">Implementierungshinweise</h3>
<ol>
<li><strong>AES-Verschleierung</strong>: Wird nur zur DPI-Resistenz verwendet (DPI: Deep Packet Inspection, Analyse von Datenpaketen); jeder, der Bobs Router-Hash und IV (Initialisierungsvektor) besitzt, kann X entschlüsseln</li>
<li><strong>Replay-Schutz (Schutz vor Wiederholungsangriffen)</strong>: Bob muss X-Werte (oder verschlüsselte Entsprechungen) für mindestens 2*D Sekunden zwischenspeichern (D = maximale Uhrenabweichung)</li>
<li><strong>Zeitstempel-Validierung</strong>: Bob muss Verbindungen mit |tsA - current_time| &gt; D ablehnen (typischerweise D = 60 Sekunden)</li>
<li><strong>Kurvenvalidierung</strong>: Bob muss prüfen, dass X ein gültiger Punkt auf X25519 (elliptische Kurve) ist</li>
<li><strong>Schnelle Ablehnung</strong>: Bob darf X[31] &amp; 0x80 == 0 vor der Entschlüsselung prüfen (gültige X25519-Schlüssel haben das MSB (Most Significant Bit, höchstwertiges Bit) nicht gesetzt)</li>
<li><strong>Fehlerbehandlung</strong>: Bei jedem Fehler schließt Bob mit TCP RST (TCP-Reset) nach einer zufälligen Wartezeit und dem Lesen einer zufälligen Anzahl von Bytes</li>
<li><strong>Pufferung</strong>: Alice muss die gesamte Nachricht (einschließlich Padding (Auffüllung)) aus Effizienzgründen in einem Stück übertragen</li>
</ol>
<h2 id="nachricht-2-sessioncreated-sitzung-erstellt">Nachricht 2: SessionCreated (Sitzung erstellt)</h2>
<p>Bob antwortet Alice.</p>
<p><strong>Noise-Operationen</strong>: <code>e, ee</code> (ephemeral-ephemeral DH, Diffie-Hellman zwischen zwei ephemeren (kurzlebigen) Schlüsseln)</p>
<h3 id="rohformat-1">Rohformat</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+    AES-256-CBC Encrypted Y (32B)      +
|    Key: RH_B, IV: AES state from msg1 |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+    ChaChaPoly Frame (48 bytes)        +
|    Plaintext: 32B (Y + options)       |
+    k from KDF-2, n=0, ad=h            +
|                                       |
+----+----+----+----+----+----+----+----+
|    Cleartext Padding (optional)       |
+    Length specified in options         +
|    0 to 65535 - 80 bytes              |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+
</code></pre><h3 id="entschlüsselter-inhalt-1">Entschlüsselter Inhalt</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+    Y (Bob ephemeral public key)       +
|    32 bytes, X25519, little-endian    |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|           Options Block               |
+             (16 bytes)                +
|                                       |
+----+----+----+----+----+----+----+----+
|    Cleartext Padding (optional)       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+
</code></pre><h3 id="optionsblock-16-bytes-big-endian-höherwertiges-byte-zuerst">Optionsblock (16 Bytes, big-endian (höherwertiges Byte zuerst))</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| Rsvd(0) | padLen  |   Reserved (0)    |
+----+----+----+----+----+----+----+----+
|        tsB        |   Reserved (0)    |
+----+----+----+----+----+----+----+----+

Rsvd    : 2 bytes - Reserved, set to 0
padLen  : 2 bytes - Padding length in this message
Reserved: 10 bytes - Reserved, set to 0
tsB     : 4 bytes - Unix timestamp (seconds since epoch)
</code></pre><h3 id="schlüsselableitungsfunktion-kdf-2">Schlüsselableitungsfunktion (KDF-2)</h3>
<p><strong>MixHash-Operationen:</strong></p>
<pre tabindex="0"><code>h = SHA256(h || encrypted_payload_msg1)  // 32-byte ciphertext
if (msg1_padding_length &gt; 0):
    h = SHA256(h || padding_from_msg1)
h = SHA256(h || e.pubkey)                // Bob&#39;s ephemeral key Y
// h is now the associated data for message 2 AEAD
</code></pre><p><strong>MixKey-Operation (ee pattern, ee-Muster):</strong></p>
<pre tabindex="0"><code>dh_result = X25519(Bob.ephemeral_private, Alice.ephemeral_public)
temp_key = HMAC-SHA256(ck, dh_result)
ck = HMAC-SHA256(temp_key, byte(0x01))
k = HMAC-SHA256(temp_key, ck || byte(0x02))
// k is the cipher key for message 2
// ck is retained for message 3 KDF
</code></pre><p><strong>Speicherbereinigung:</strong></p>
<pre tabindex="0"><code>// Overwrite ephemeral keys after ee DH
Alice.ephemeral_public = zeros(32)
Alice.ephemeral_private = zeros(32)  // Bob side
Bob.received_ephemeral = zeros(32)    // Bob side
</code></pre><h3 id="implementierungshinweise-1">Implementierungshinweise</h3>
<ol>
<li><strong>AES-Verkettung</strong>: Die Verschlüsselung von Y verwendet den AES-CBC-Zustand aus Nachricht 1 (nicht zurückgesetzt)</li>
<li><strong>Schutz vor Wiederholungsangriffen</strong>: Alice muss Y-Werte mindestens 2*D Sekunden zwischenspeichern</li>
<li><strong>Zeitstempelprüfung</strong>: Alice muss |tsB - current_time| &gt; D zurückweisen</li>
<li><strong>Kurvenvalidierung</strong>: Alice muss prüfen, dass Y ein gültiger X25519-Punkt ist</li>
<li><strong>Fehlerbehandlung</strong>: Alice schließt bei jedem Fehler mit TCP RST</li>
<li><strong>Pufferung</strong>: Bob muss die gesamte Nachricht auf einmal senden</li>
</ol>
<h2 id="nachricht-3-sessionconfirmed-sitzung-bestätigt">Nachricht 3: SessionConfirmed (Sitzung bestätigt)</h2>
<p>Alice bestätigt die Sitzung und sendet die RouterInfo.</p>
<p><strong>Noise-Operationen</strong>: <code>s, se</code> (Offenlegung des statischen Schlüssels und statisch-ephemerer Diffie-Hellman (DH))</p>
<h3 id="zweiteilige-struktur">Zweiteilige Struktur</h3>
<p>Nachricht 3 besteht aus <strong>zwei separaten AEAD frames</strong> (AEAD, authentifizierte Verschlüsselung mit zusätzlichen Daten):</p>
<ol>
<li><strong>Teil 1</strong>: Fester 48-Byte-Frame mit Alices verschlüsseltem statischen Schlüssel</li>
<li><strong>Teil 2</strong>: Frame variabler Länge mit RouterInfo, Optionen und Padding</li>
</ol>
<h3 id="rohformat-2">Rohformat</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|    ChaChaPoly Frame 1 (48 bytes)      |
+    Plaintext: Alice static key (32B)  +
|    k from KDF-2, n=1, ad=h            |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
|                                       |
+    ChaChaPoly Frame 2 (variable)      +
|    Length specified in msg1.m3p2len   |
+    k from KDF-3, n=0, ad=h            +
|    Plaintext: RouterInfo + padding    |
+                                       +
|                                       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Größenbeschränkungen:</strong> - Teil 1: Genau 48 Bytes (32 Klartext + 16 MAC) - Teil 2: Länge, in Nachricht 1 festgelegt (Feld m3p2len) - Maximalgröße insgesamt: 65535 Bytes (Teil 1 max 48, daher Teil 2 max 65487)</p>
<h3 id="entschlüsselter-inhalt-2">Entschlüsselter Inhalt</h3>
<p><strong>Teil 1:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|                                       |
+    S (Alice static public key)        +
|    32 bytes, X25519, little-endian    |
+                                       +
|                                       |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Teil 2:</strong></p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|    Block: RouterInfo (required)       |
+    Type=2, contains Alice&#39;s RI         +
|                                       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+
|    Block: Options (optional)          |
+    Type=1, padding parameters          +
|                                       |
+----+----+----+----+----+----+----+----+
|    Block: Padding (optional)          |
+    Type=254, random data               +
|    MUST be last block if present      |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+
</code></pre><h3 id="schlüsselableitungsfunktion-kdf-3">Schlüsselableitungsfunktion (KDF-3)</h3>
<p><strong>Teil 1 (s-Muster):</strong></p>
<pre tabindex="0"><code>h = SHA256(h || encrypted_payload_msg2)  // 32-byte ciphertext
if (msg2_padding_length &gt; 0):
    h = SHA256(h || padding_from_msg2)

// Encrypt static key with message 2 cipher key
ciphertext = AEAD_ChaCha20_Poly1305(k_msg2, n=1, h, Alice.static_public)
h = SHA256(h || ciphertext)  // 48 bytes (32 + 16)
// h is now the associated data for message 3 part 2
</code></pre><p><strong>Teil 2 (siehe Muster):</strong></p>
<pre tabindex="0"><code>dh_result = X25519(Alice.static_private, Bob.ephemeral_public)
temp_key = HMAC-SHA256(ck, dh_result)
ck = HMAC-SHA256(temp_key, byte(0x01))
k = HMAC-SHA256(temp_key, ck || byte(0x02))
// k is the cipher key for message 3 part 2
// ck is retained for data phase KDF

ciphertext = AEAD_ChaCha20_Poly1305(k, n=0, h, payload)
h = SHA256(h || ciphertext)
// h is retained for SipHash KDF
</code></pre><p><strong>Speicherbereinigung:</strong></p>
<pre tabindex="0"><code>// Overwrite Bob&#39;s ephemeral key after se DH
Alice.received_ephemeral = zeros(32)  // Alice side
Bob.ephemeral_public = zeros(32)       // Bob side
Bob.ephemeral_private = zeros(32)      // Bob side
</code></pre><h3 id="hinweise-zur-implementierung">Hinweise zur Implementierung</h3>
<ol>
<li><strong>RouterInfo-Validierung</strong>: Bob muss Signatur, Zeitstempel und Schlüsselkonsistenz prüfen</li>
<li><strong>Schlüsselabgleich</strong>: Bob muss prüfen, dass Alices statischer Schlüssel in Teil 1 mit dem Schlüssel in der RouterInfo übereinstimmt</li>
<li><strong>Position des statischen Schlüssels</strong>: In der NTCP oder NTCP2 RouterAddress nach einem passenden &ldquo;s&rdquo;-Parameter suchen</li>
<li><strong>Blockreihenfolge</strong>: RouterInfo muss zuerst kommen, Options als Zweites (falls vorhanden), Padding zuletzt (falls vorhanden)</li>
<li><strong>Längenplanung</strong>: Alice muss sicherstellen, dass m3p2len in Nachricht 1 exakt der Länge von Teil 2 entspricht</li>
<li><strong>Pufferung</strong>: Alice muss beide Teile zusammen als einen einzigen TCP-Sendevorgang absetzen</li>
<li><strong>Optionale Verkettung</strong>: Alice kann aus Effizienzgründen unmittelbar einen data phase frame (Frame der Datenphase) anhängen</li>
</ol>
<h2 id="datenphase">Datenphase</h2>
<p>Nach Abschluss des Handshakes verwenden alle Nachrichten AEAD-Frames variabler Länge mit verschleierten Längenfeldern.</p>
<h3 id="schlüsselableitungsfunktion-datenphase">Schlüsselableitungsfunktion (Datenphase)</h3>
<p><strong>Split-Funktion (Noise):</strong></p>
<pre tabindex="0"><code>// Generate transmit and receive keys
zerolen = &#34;&#34;  // Zero-length byte array
temp_key = HMAC-SHA256(ck, zerolen)

// Alice transmits to Bob
k_ab = HMAC-SHA256(temp_key, byte(0x01))

// Bob transmits to Alice  
k_ba = HMAC-SHA256(temp_key, k_ab || byte(0x02))

// Cleanup
ck = zeros(32)
temp_key = zeros(32)
</code></pre><p><strong>SipHash-Schlüsselableitung:</strong></p>
<pre tabindex="0"><code>// Generate additional symmetric key for SipHash
ask_master = HMAC-SHA256(temp_key, &#34;ask&#34; || byte(0x01))

// &#34;siphash&#34; is 7 bytes US-ASCII
temp_key2 = HMAC-SHA256(ask_master, h || &#34;siphash&#34;)
sip_master = HMAC-SHA256(temp_key2, byte(0x01))

// Alice to Bob SipHash keys
temp_key3 = HMAC-SHA256(sip_master, zerolen)
sipkeys_ab = HMAC-SHA256(temp_key3, byte(0x01))
sipk1_ab = sipkeys_ab[0:7]   // 8 bytes, little-endian
sipk2_ab = sipkeys_ab[8:15]  // 8 bytes, little-endian
sipiv_ab = sipkeys_ab[16:23] // 8 bytes, IV

// Bob to Alice SipHash keys
sipkeys_ba = HMAC-SHA256(temp_key3, sipkeys_ab || byte(0x02))
sipk1_ba = sipkeys_ba[0:7]   // 8 bytes, little-endian
sipk2_ba = sipkeys_ba[8:15]  // 8 bytes, little-endian
sipiv_ba = sipkeys_ba[16:23] // 8 bytes, IV
</code></pre><h3 id="rahmenstruktur">Rahmenstruktur</h3>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|Obfs Len |                             |
+----+----+    ChaChaPoly Frame         +
|    Encrypted Block Data               |
+    k_ab (Alice→Bob) or k_ba (Bob→Alice)|
|    Nonce starts at 0, increments      |
+    No associated data (empty string)  +
|                                       |
~           .   .   .                   ~
|                                       |
+----+----+----+----+----+----+----+----+
|    Poly1305 MAC (16 bytes)            |
+----+----+----+----+----+----+----+----+
</code></pre><p><strong>Frame-Beschränkungen:</strong> - Minimum: 18 Bytes (2 verschleierte Länge + 0 Klartext + 16 MAC) - Maximum: 65537 Bytes (2 verschleierte Länge + 65535 Frame) - Empfohlen: Wenige KB pro Frame (Empfängerlatenz minimieren)</p>
<h3 id="siphash-längenverschleierung">SipHash-Längenverschleierung</h3>
<p><strong>Zweck</strong>: Verhindern, dass DPI (tiefgehende Paketinspektion) die Frame-Grenzen erkennt</p>
<p><strong>Algorithmus:</strong></p>
<pre tabindex="0"><code>// Initialization (per direction)
IV[0] = sipiv  // From KDF

// For each frame:
IV[n] = SipHash-2-4(sipk1, sipk2, IV[n-1])
Mask[n] = IV[n][0:1]  // First 2 bytes of IV
ObfuscatedLength = ActualLength XOR Mask[n]

// Send 2-byte ObfuscatedLength, then ActualLength bytes
</code></pre><p><strong>Dekodierung:</strong></p>
<pre tabindex="0"><code>// Receiver maintains identical IV chain
IV[n] = SipHash-2-4(sipk1, sipk2, IV[n-1])
Mask[n] = IV[n][0:1]
ActualLength = ObfuscatedLength XOR Mask[n]
// Read ActualLength bytes (includes 16-byte MAC)
</code></pre><p><strong>Hinweise:</strong> - Getrennte IV-Ketten für jede Richtung (Alice→Bob und Bob→Alice) - Wenn SipHash uint64 zurückgibt, die beiden niederwertigsten Bytes als Maske verwenden - uint64 als Little-Endian-Bytes in den nächsten IV umwandeln</p>
<h3 id="blockformat">Blockformat</h3>
<p>Jeder Frame enthält null oder mehr Blöcke:</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|Type| Length  |       Data              |
+----+----+----+                        +
|                                       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+

Type  : 1 byte  - Block type identifier
Length: 2 bytes - Big-endian, data size (0-65516)
Data  : Variable length payload
</code></pre><p><strong>Größenlimits:</strong> - Maximaler Frame: 65535 Bytes (einschließlich MAC) - Maximaler Blockbereich: 65519 Bytes (Frame - 16-Byte-MAC) - Maximaler Einzelblock: 65519 Bytes (3-Byte-Header + 65516 Daten)</p>
<h3 id="blocktypen">Blocktypen</h3>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Name</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">0</td><td style="border:1px solid var(--color-border); padding:0.5rem;">DateTime</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Time synchronization (4-byte timestamp)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Options</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Padding parameters, dummy traffic</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2</td><td style="border:1px solid var(--color-border); padding:0.5rem;">RouterInfo</td><td style="border:1px solid var(--color-border); padding:0.5rem;">RouterInfo delivery/flooding</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3</td><td style="border:1px solid var(--color-border); padding:0.5rem;">I2NP</td><td style="border:1px solid var(--color-border); padding:0.5rem;">I2NP message with shortened header</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Termination</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Explicit connection close</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">224-253</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Experimental features</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">254</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Padding</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Random padding (must be last)</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">255</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Reserved</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Future extensions</td></tr>
  </tbody>
</table>
**Regeln zur Blockreihenfolge:** - **Nachricht 3, Teil 2**: RouterInfo, Optionen (optional), Padding (Auffüllung; optional) - KEINE anderen Typen - **Datenphase**: Beliebige Reihenfolge, außer:   - Padding MUSS der letzte Block sein, falls vorhanden   - Termination (Beendigung) MUSS der letzte Block sein (außer Padding), falls vorhanden - Mehrere I2NP-Blöcke pro Frame erlaubt - Mehrere Padding-Blöcke pro Frame NICHT erlaubt
<h3 id="blocktyp-0-datumuhrzeit">Blocktyp 0: Datum/Uhrzeit</h3>
<p>Zeitsynchronisierung zur Erkennung von Uhrzeitabweichungen.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+
| 0  |    4    |     timestamp     |
+----+----+----+----+----+----+----+

Type     : 0
Length   : 4 (big-endian)
Timestamp: 4 bytes, Unix seconds (big-endian)
</code></pre><p><strong>Implementierung</strong>: Zur nächstgelegenen Sekunde runden, um die Akkumulation von Uhrversatz zu verhindern.</p>
<h3 id="blocktyp-1-optionen">Blocktyp 1: Optionen</h3>
<p>Parameter für Padding (Auffüllung) und Traffic Shaping (Datenverkehrsformung).</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 1  |  size   |tmin|tmax|rmin|rmax|tdmy|
+----+----+----+----+----+----+----+----+
|tdmy|  rdmy   |  tdelay |  rdelay |    |
+----+----+----+----+----+----+----+    +
|         more_options (TBD)            |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+

Type  : 1
Length: 12+ bytes (big-endian)
</code></pre><p><strong>Padding-Verhältnisse</strong> (4.4-Festkommaformat, Wert/16.0): - <code>tmin</code>: Minimales Padding-Verhältnis beim Senden (0.0 - 15.9375) - <code>tmax</code>: Maximales Padding-Verhältnis beim Senden (0.0 - 15.9375) - <code>rmin</code>: Minimales Padding-Verhältnis beim Empfangen (0.0 - 15.9375) - <code>rmax</code>: Maximales Padding-Verhältnis beim Empfangen (0.0 - 15.9375)</p>
<p><strong>Beispiele:</strong> - 0x00 = 0% Padding - 0x01 = 6,25% Padding - 0x10 = 100% Padding (1:1-Verhältnis) - 0x80 = 800% Padding (8:1-Verhältnis)</p>
<p><strong>Dummy-Datenverkehr:</strong> - <code>tdmy</code>: Maximal bereit zu senden (2 Bytes, Durchschnitt in Bytes/Sekunde) - <code>rdmy</code>: Angeforderter Empfang (2 Bytes, Durchschnitt in Bytes/Sekunde)</p>
<p><strong>Einfügen von Verzögerungen:</strong> - <code>tdelay</code>: Maximal einzufügende Verzögerung (2 Bytes, Durchschnitt in Millisekunden) - <code>rdelay</code>: Angeforderte Verzögerung (2 Bytes, Durchschnitt in Millisekunden)</p>
<p><strong>Leitlinien:</strong> - Min-Werte geben die angestrebte Widerstandsfähigkeit gegen Traffic-Analyse an - Max-Werte geben Bandbreitenbeschränkungen an - Der Sender sollte das Maximum des Empfängers einhalten - Der Sender kann das Minimum des Empfängers innerhalb der Beschränkungen berücksichtigen - Kein Durchsetzungsmechanismus; Implementierungen können variieren</p>
<h3 id="blocktyp-2-routerinfo">Blocktyp 2: RouterInfo</h3>
<p>RouterInfo-Übermittlung zur netdb-Befüllung und zum Flooding (flutartige Verteilung).</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 2  |  size   |flg |    RouterInfo     |
+----+----+----+----+                   +
|                                       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+

Type : 2
Length: Flag (1 byte) + RouterInfo size
Flag : Bit 0 = flood request (1) or local store (0)
       Bits 1-7 = Reserved, set to 0
</code></pre><p><strong>Verwendung:</strong></p>
<p><strong>In Nachricht 3 Teil 2</strong> (Handshake): - Alice sendet ihre RouterInfo (Router-Informationsobjekt) an Bob - Flood bit (Steuerbit für Weiterverteilung) typischerweise 0 (lokale Speicherung) - RouterInfo NICHT gzip-komprimiert</p>
<p><strong>In der Datenphase:</strong> - Jede Seite darf ihre aktualisierte RouterInfo (Router-Informationen) senden - Flood bit = 1: Anforderung der floodfill-Verteilung (wenn der Empfänger floodfill ist) - Flood bit = 0: Nur lokale netdb-Speicherung</p>
<p><strong>Validierungsanforderungen:</strong> 1. Prüfen, ob der Signaturtyp unterstützt wird 2. RouterInfo-Signatur prüfen 3. Prüfen, ob der Zeitstempel innerhalb akzeptabler Grenzen liegt 4. Für den Handshake: Prüfen, ob der statische Schlüssel dem NTCP2-Adressparameter &ldquo;s&rdquo; entspricht 5. Für die Datenphase: Prüfen, ob der router-Hash zum Sitzungspartner passt 6. Nur RouterInfos mit veröffentlichten Adressen weiterverbreiten</p>
<p><strong>Hinweise:</strong> - Kein ACK-Mechanismus (verwenden Sie I2NP DatabaseStore mit reply token (Antwort-Token), falls nötig) - Kann RouterInfos Dritter enthalten (floodfill-Nutzung) - NICHT gzip-komprimiert (im Gegensatz zu I2NP DatabaseStore)</p>
<h3 id="blocktyp-3-i2np-nachricht">Blocktyp 3: I2NP-Nachricht</h3>
<p>I2NP-Nachricht mit verkürztem 9-Byte-Header.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 3  |  size   |type|    msg_id         |
+----+----+----+----+----+----+----+----+
|   expiration  |     I2NP payload      |
+----+----+----+                        +
|                                       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+

Type      : 3
Length    : 9 + payload_size (big-endian)
Type      : 1 byte, I2NP message type
Msg_ID    : 4 bytes, big-endian, I2NP message ID
Expiration: 4 bytes, big-endian, Unix timestamp (seconds)
Payload   : I2NP message body (length = size - 9)
</code></pre><p><strong>Unterschiede gegenüber NTCP1:</strong> - Ablaufzeit: 4 Bytes (Sekunden) vs 8 Bytes (Millisekunden) - Länge: weggelassen (aus der Blocklänge ableitbar) - Prüfsumme: weggelassen (AEAD bietet Integrität) - Header: 9 Bytes vs 16 Bytes (44% Reduktion)</p>
<p><strong>Fragmentierung:</strong> - I2NP-Nachrichten DÜRFEN NICHT über Blöcke hinweg fragmentiert werden - I2NP-Nachrichten DÜRFEN NICHT über Frames hinweg fragmentiert werden - Mehrere I2NP-Blöcke pro Frame sind zulässig</p>
<h3 id="blocktyp-4-beendigung">Blocktyp 4: Beendigung</h3>
<p>Explizites Schließen der Verbindung mit Beendigungsgrundcode.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
| 4  |  size   |  valid_frames_recv    |
+----+----+----+----+----+----+----+----+
| (continued) |rsn |   additional_data   |
+----+----+----+----+                   +
|                                       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+

Type            : 4
Length          : 9+ bytes (big-endian)
Valid_Frames_Recv: 8 bytes, big-endian (receive nonce value)
                  0 if error in handshake phase
Reason          : 1 byte (see table below)
Additional_Data : Optional (format unspecified, for debugging)
</code></pre><p><strong>Begründungscodes:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:center;">Code</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Reason</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Phase</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">0</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Normal close / unspecified</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Any</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">1</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Termination received</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">2</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Idle timeout</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">3</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Router shutdown</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">4</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data phase AEAD failure</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">5</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Incompatible options</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">6</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Incompatible signature type</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">7</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Clock skew</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">8</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Padding violation</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Any</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">9</td><td style="border:1px solid var(--color-border); padding:0.5rem;">AEAD framing error</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">10</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Payload format error</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">11</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Message 1 error</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">12</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Message 2 error</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">13</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Message 3 error</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">14</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Intra-frame read timeout</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Data</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">15</td><td style="border:1px solid var(--color-border); padding:0.5rem;">RouterInfo signature verification fail</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">16</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Static key parameter mismatch</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Handshake</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem; text-align:center;">17</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Banned</td><td style="border:1px solid var(--color-border); padding:0.5rem;">Any</td></tr>
  </tbody>
</table>
**Regeln:** - Die Terminierung MUSS der letzte Nicht-Padding-Block im Frame sein - Maximal ein Terminierungsblock pro Frame - Der Sender sollte die Verbindung nach dem Senden schließen - Der Empfänger sollte die Verbindung nach dem Empfangen schließen
<p><strong>Fehlerbehandlung:</strong> - Handshake-Fehler: In der Regel mit TCP RST schließen (kein Termination-Block) - AEAD-Fehler in der Datenphase: Zufälliges Timeout + zufälliges Lesen, dann Termination (Beendigung) senden - Siehe Abschnitt &ldquo;AEAD Error Handling&rdquo; für Sicherheitsverfahren</p>
<h3 id="blocktyp-254-auffüllung">Blocktyp 254: Auffüllung</h3>
<p>Zufälliges Padding zur Erhöhung der Widerstandsfähigkeit gegen Verkehrsanalyse.</p>
<pre tabindex="0"><code>+----+----+----+----+----+----+----+----+
|254 |  size   |     random_data       |
+----+----+----+                        +
|                                       |
~           .   .   .                   ~
+----+----+----+----+----+----+----+----+

Type: 254
Length: 0-65516 bytes (big-endian)
Data: Cryptographically random bytes
</code></pre><p><strong>Regeln:</strong> - Padding MUSS der letzte Block im Frame sein, falls vorhanden - Padding mit Länge Null ist zulässig - Pro Frame ist nur ein Padding-Block zulässig - Nur aus Padding bestehende Frames sind zulässig - Sollte den ausgehandelten Parametern aus dem Options-Block entsprechen</p>
<p><strong>Padding in den Nachrichten 1-2:</strong> - Außerhalb des AEAD (Authentifizierte Verschlüsselung mit zusätzlichen Daten)-Rahmens (Klartext) - In die Hash-Kette der nächsten Nachricht einbezogen (authentifiziert) - Manipulation wird erkannt, wenn die AEAD der nächsten Nachricht fehlschlägt</p>
<p><strong>Padding in Nachricht 3+ und Datenphase:</strong> - Innerhalb des AEAD-Frames (verschlüsselt und authentifiziert) - Wird für Traffic Shaping und Größenverschleierung verwendet</p>
<h2 id="aead-fehlerbehandlung">AEAD-Fehlerbehandlung</h2>
<p><strong>Kritische Sicherheitsanforderungen:</strong></p>
<h3 id="handshake-phase-nachrichten-1-3">Handshake-Phase (Nachrichten 1-3)</h3>
<p><strong>Bekannte Nachrichtengröße:</strong> - Nachrichtengrößen sind vorgegeben oder im Voraus spezifiziert - AEAD-Authentifizierungsfehler ist eindeutig</p>
<p><strong>Bobs Reaktion auf Fehler bei Nachricht 1:</strong> 1. Zufälliges Timeout setzen (Bereich implementierungsabhängig, Vorschlag: 100-500ms) 2. Zufällige Anzahl von Bytes lesen (Bereich implementierungsabhängig, Vorschlag: 1KB-64KB) 3. Verbindung mit TCP RST schließen (keine Antwort) 4. Quell-IP vorübergehend sperren 5. Wiederholte Fehlschläge nachverfolgen, um langfristige Sperren zu verhängen</p>
<p><strong>Alices Reaktion auf Fehler bei Nachricht 2:</strong> 1. Verbindung sofort mit TCP RST schließen 2. Keine Antwort an Bob</p>
<p><strong>Bobs Reaktion auf den Fehler bei Nachricht 3:</strong> 1. Verbindung sofort mit TCP RST schließen 2. Keine Antwort an Alice</p>
<h3 id="datenphase-1">Datenphase</h3>
<p><strong>Verschleierte Nachrichtengröße:</strong> - Das Längenfeld ist durch SipHash (Hash-Funktion) verschleiert - Ungültige Länge oder AEAD (authentifizierte Verschlüsselung mit assoziierten Daten)-Fehler könnte darauf hindeuten:   - Sondierung durch einen Angreifer   - Beschädigung im Netzwerk   - Desynchronisierter SipHash-IV (Initialisierungsvektor)   - Böswillige Gegenstelle</p>
<p><strong>Antwort auf AEAD- oder Längenfehler:</strong> 1. Zufälliges Timeout setzen (empfohlen 100-500ms) 2. Zufällige Anzahl von Bytes lesen (empfohlen 1KB-64KB) 3. Beendigungsblock mit Reason-Code 4 (AEAD-Fehler) oder 9 (Framing-Fehler) senden 4. Verbindung schließen</p>
<p><strong>Vermeidung von Entschlüsselungsorakeln:</strong> - Den Fehlertyp der Gegenstelle niemals vor Ablauf einer zufälligen Wartezeit offenlegen - Niemals auf die Längenvalidierung vor der AEAD-Prüfung verzichten - Ungültige Länge genauso behandeln wie einen AEAD-Fehler - Für beide Fehler denselben Fehlerbehandlungspfad verwenden</p>
<p><strong>Überlegungen zur Implementierung:</strong> - Einige Implementierungen können nach Fehlern bei AEAD (authentifizierte Verschlüsselung mit zugehörigen Daten) fortfahren, sofern sie selten auftreten - Nach wiederholten Fehlern beenden (empfohlener Schwellenwert: 3–5 Fehler pro Stunde) - Abwägung zwischen Fehlerwiederherstellung und Sicherheit</p>
<h2 id="veröffentlichte-routerinfo">Veröffentlichte RouterInfo</h2>
<h3 id="format-der-router-adresse">Format der Router-Adresse</h3>
<p>Die NTCP2-Unterstützung wird über veröffentlichte RouterAddress-Einträge mit bestimmten Optionen bekanntgegeben.</p>
<p><strong>Transportstil:</strong> - <code>&quot;NTCP2&quot;</code> - NTCP2 nur auf diesem Port - <code>&quot;NTCP&quot;</code> - Sowohl NTCP als auch NTCP2 auf diesem Port (automatische Erkennung)   - <strong>Hinweis</strong>: Unterstützung für NTCP (v1) wurde in 0.9.50 entfernt (Mai 2021)   - &ldquo;NTCP&rdquo;-Stil ist jetzt veraltet; verwenden Sie &ldquo;NTCP2&rdquo;</p>
<h3 id="erforderliche-optionen">Erforderliche Optionen</h3>
<p><strong>Alle veröffentlichten NTCP2-Adressen:</strong></p>
<ol>
<li>
<p><strong><code>host</code></strong> - IP-Adresse (IPv4 oder IPv6) oder Hostname</p>
<ul>
<li>Format: Standard-IP-Notation oder Domainname</li>
<li>Kann bei nur ausgehenden oder versteckten routers weggelassen werden</li>
</ul>
</li>
<li>
<p><strong><code>port</code></strong> - TCP-Portnummer</p>
<ul>
<li>Format: Ganzzahl, 1-65535</li>
<li>Kann bei nur ausgehenden oder versteckten router weggelassen werden</li>
</ul>
</li>
<li>
<p><strong><code>s</code></strong> - Statischer öffentlicher Schlüssel (X25519)</p>
<ul>
<li>Format: Base64-kodiert, 44 Zeichen</li>
<li>Kodierung: I2P-Base64-Alphabet</li>
<li>Quelle: öffentlicher X25519-Schlüssel (32 Byte), Little-Endian</li>
</ul>
</li>
<li>
<p><strong><code>i</code></strong> - Initialisierungsvektor für AES</p>
<ul>
<li>Format: Base64-kodiert, 24 Zeichen</li>
<li>Kodierung: I2P-Base64-Alphabet</li>
<li>Quelle: 16-Byte-IV, Big-Endian</li>
</ul>
</li>
<li>
<p><strong><code>v</code></strong> - Protokollversion</p>
<ul>
<li>Format: Ganzzahl oder durch Kommas getrennte Ganzzahlen</li>
<li>Aktuell: <code>&quot;2&quot;</code></li>
<li>Zukünftig: <code>&quot;2,3&quot;</code> (muss in numerischer Reihenfolge sein)</li>
</ul>
</li>
</ol>
<p><strong>Optionale Einstellungen:</strong></p>
<ol start="6">
<li>
<p><strong><code>caps</code></strong> - Fähigkeiten (seit 0.9.50)</p>
<ul>
<li>Format: Zeichenkette aus Fähigkeitszeichen</li>
<li>Werte:
<ul>
<li><code>&quot;4&quot;</code> - IPv4-Fähigkeit für ausgehende Verbindungen</li>
<li><code>&quot;6&quot;</code> - IPv6-Fähigkeit für ausgehende Verbindungen</li>
<li><code>&quot;46&quot;</code> - Sowohl IPv4 als auch IPv6 (empfohlene Reihenfolge)</li>
</ul>
</li>
<li>Nicht erforderlich, wenn <code>host</code> veröffentlicht ist</li>
<li>Nützlich für versteckte bzw. hinter einer Firewall befindliche routers</li>
</ul>
</li>
<li>
<p><strong><code>cost</code></strong> - Adresspriorität</p>
<ul>
<li>Format: Ganzzahl, 0-255</li>
<li>Niedrigere Werte = höhere Priorität</li>
<li>Empfohlen: 5-10 für normale Adressen</li>
<li>Empfohlen: 14 für unveröffentlichte Adressen</li>
</ul>
</li>
</ol>
<h3 id="beispielhafte-routeraddress-einträge">Beispielhafte RouterAddress-Einträge</h3>
<p><strong>Veröffentlichte IPv4-Adresse:</strong></p>
<pre tabindex="0"><code>&lt;Address cost=&#34;5&#34;&gt;
  &lt;transport_style&gt;NTCP2&lt;/transport_style&gt;
  &lt;options&gt;
    &lt;host&gt;192.0.2.1&lt;/host&gt;
    &lt;port&gt;8887&lt;/port&gt;
    &lt;s&gt;9EjeG7BZeznKbL9a2fXx8JBDPgLZbLmKbqY3QrNGJCo=&lt;/s&gt;
    &lt;i&gt;MDEyMzQ1Njc4OUFCQ0RFRg==&lt;/i&gt;
    &lt;v&gt;2&lt;/v&gt;
  &lt;/options&gt;
&lt;/Address&gt;
</code></pre><p><strong>Verborgener Router (nur ausgehend):</strong></p>
<pre tabindex="0"><code>&lt;Address cost=&#34;14&#34;&gt;
  &lt;transport_style&gt;NTCP2&lt;/transport_style&gt;
  &lt;options&gt;
    &lt;s&gt;9EjeG7BZeznKbL9a2fXx8JBDPgLZbLmKbqY3QrNGJCo=&lt;/s&gt;
    &lt;v&gt;2&lt;/v&gt;
    &lt;caps&gt;4&lt;/caps&gt;
  &lt;/options&gt;
&lt;/Address&gt;
</code></pre><p><strong>Dual-Stack-Router:</strong></p>
<pre tabindex="0"><code>&lt;!-- IPv4 Address --&gt;
&lt;Address cost=&#34;5&#34;&gt;
  &lt;transport_style&gt;NTCP2&lt;/transport_style&gt;
  &lt;options&gt;
    &lt;host&gt;192.0.2.1&lt;/host&gt;
    &lt;port&gt;8887&lt;/port&gt;
    &lt;s&gt;9EjeG7BZeznKbL9a2fXx8JBDPgLZbLmKbqY3QrNGJCo=&lt;/s&gt;
    &lt;i&gt;MDEyMzQ1Njc4OUFCQ0RFRg==&lt;/i&gt;
    &lt;v&gt;2&lt;/v&gt;
  &lt;/options&gt;
&lt;/Address&gt;

&lt;!-- IPv6 Address (same keys, same port) --&gt;
&lt;Address cost=&#34;5&#34;&gt;
  &lt;transport_style&gt;NTCP2&lt;/transport_style&gt;
  &lt;options&gt;
    &lt;host&gt;2001:db8::1&lt;/host&gt;
    &lt;port&gt;8887&lt;/port&gt;
    &lt;s&gt;9EjeG7BZeznKbL9a2fXx8JBDPgLZbLmKbqY3QrNGJCo=&lt;/s&gt;
    &lt;i&gt;MDEyMzQ1Njc4OUFCQ0RFRg==&lt;/i&gt;
    &lt;v&gt;2&lt;/v&gt;
  &lt;/options&gt;
&lt;/Address&gt;
</code></pre><p><strong>Wichtige Regeln:</strong> - Mehrere NTCP2-Adressen mit <strong>demselben Port</strong> MÜSSEN <strong>identische</strong> <code>s</code>-, <code>i</code>- und <code>v</code>-Werte verwenden - Verschiedene Ports dürfen unterschiedliche Schlüssel verwenden - Dual-Stack routers sollten getrennte IPv4- und IPv6-Adressen veröffentlichen</p>
<h3 id="unveröffentlichte-ntcp2-adresse">Unveröffentlichte NTCP2-Adresse</h3>
<p><strong>Für ausschließlich ausgehende Router:</strong></p>
<p>Wenn ein router keine eingehenden NTCP2-Verbindungen akzeptiert, aber ausgehende Verbindungen initiiert, MUSS er dennoch eine RouterAddress mit Folgendem veröffentlichen:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;Address</span> <span style="color:#a6e22e">cost=</span><span style="color:#e6db74">&#34;14&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;transport_style&gt;</span>NTCP2<span style="color:#f92672">&lt;/transport_style&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;options&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;s&gt;</span>9EjeG7BZeznKbL9a2fXx8JBDPgLZbLmKbqY3QrNGJCo=<span style="color:#f92672">&lt;/s&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;v&gt;</span>2<span style="color:#f92672">&lt;/v&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/options&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/Address&gt;</span>
</span></span></code></pre></div><p><strong>Zweck:</strong> - Ermöglicht es Bob, Alices statischen Schlüssel während des Handshakes zu verifizieren - Erforderlich für die Verifizierung der RouterInfo in Nachricht 3, Teil 2 - Keine <code>i</code>, <code>host</code> oder <code>port</code> erforderlich (nur ausgehend)</p>
<p><strong>Alternative:</strong> - Füge <code>s</code> und <code>v</code> zur bereits veröffentlichten &ldquo;NTCP&rdquo;- oder SSU-Adresse hinzu</p>
<h3 id="rotation-von-öffentlichem-schlüssel-und-iv-initialisierungsvektor">Rotation von öffentlichem Schlüssel und IV (Initialisierungsvektor)</h3>
<p><strong>Kritische Sicherheitsrichtlinie:</strong></p>
<p><strong>Allgemeine Regeln:</strong> 1. <strong>Niemals rotieren, während der router läuft</strong> 2. <strong>Schlüssel und IV (Initialisierungsvektor) dauerhaft speichern</strong> über Neustarts hinweg 3. <strong>Vorherige Ausfallzeit nachverfolgen</strong>, um festzustellen, ob eine Rotation in Frage kommt</p>
<p><strong>Mindest-Ausfallzeit vor der Rotation:</strong></p>
<table style="width:100%; border-collapse:collapse; margin-bottom:1.5rem;">
  <thead>
    <tr>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Router Type</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Min Downtime</th>
      <th style="border:1px solid var(--color-border); padding:0.5rem; background:var(--color-bg-secondary); text-align:left;">Reason</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Published NTCP2 address</td><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>1 month</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Many routers cache RouterInfo</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">Published SSU only (no NTCP2)</td><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>1 day</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Moderate caching</td></tr>
    <tr><td style="border:1px solid var(--color-border); padding:0.5rem;">No published addresses (hidden)</td><td style="border:1px solid var(--color-border); padding:0.5rem;"><strong>2 hours</strong></td><td style="border:1px solid var(--color-border); padding:0.5rem;">Minimal impact</td></tr>
  </tbody>
</table>
**Zusätzliche Auslöser:** - Änderung der lokalen IP-Adresse: Kann unabhängig von Ausfallzeiten rotieren - Router "rekey" (new Router Hash): Neue Schlüssel erzeugen
<p><strong>Begründung:</strong> - Verhindert das Offenlegen von Neustartzeiten durch Schlüsseländerungen - Ermöglicht, dass zwischengespeicherte RouterInfos natürlich ablaufen - Wahrung der Netzwerkstabilität - Verringert fehlgeschlagene Verbindungsversuche</p>
<p><strong>Implementierung:</strong> 1. Schlüssel, IV (Initialisierungsvektor) und Zeitstempel des letzten Herunterfahrens dauerhaft speichern 2. Beim Start die Ausfallzeit berechnen: downtime = current_time - last_shutdown 3. Wenn downtime &gt; Minimum für den router-Typ, kann rotiert werden 4. Wenn sich die IP geändert hat oder eine Schlüsselerneuerung stattfindet, kann rotiert werden 5. Andernfalls den vorherigen Schlüssel und die IV wiederverwenden</p>
<p><strong>IV Rotation:</strong> - Unterliegt denselben Regeln wie die Schlüsselrotation - Nur in veröffentlichten Adressen vorhanden (nicht in versteckten routers) - Es wird empfohlen, den IV zu ändern, sobald sich der Schlüssel ändert</p>
<h2 id="versionserkennung">Versionserkennung</h2>
<p><strong>Kontext:</strong> Wenn <code>transportStyle=&quot;NTCP&quot;</code> (veraltet) ist, unterstützt Bob sowohl NTCP v1 als auch v2 auf demselben Port und muss die Protokollversion automatisch erkennen.</p>
<p><strong>Erkennungsalgorithmus:</strong></p>
<pre tabindex="0"><code>1. Wait for at least 64 bytes (minimum NTCP2 message 1 size)

2. If received ≥ 288 bytes:
   → Connection is NTCP version 1 (NTCP1 message 1 is 288 bytes)

3. If received &lt; 288 bytes:
   
   Option A (conservative, pre-NTCP2 majority):
   a. Wait additional short time (e.g., 100-500ms)
   b. If total received ≥ 288 bytes → NTCP1
   c. Otherwise → Attempt NTCP2 decode
   
   Option B (aggressive, post-NTCP2 majority):
   a. Attempt NTCP2 decode immediately:
      - Decrypt first 32 bytes (X key) with AES-256-CBC
      - Verify valid X25519 point (X[31] &amp; 0x80 == 0)
      - Verify AEAD frame
   b. If decode succeeds → NTCP2
   c. If decode fails → Wait for more data or NTCP1
</code></pre><p><strong>Schnelle MSB-Prüfung (höchstwertiges Bit):</strong> - Vor der AES-Entschlüsselung prüfen: <code>encrypted_X[31] &amp; 0x80 == 0</code> - Gültige X25519-Schlüssel haben das höchstwertige Bit nicht gesetzt - Ein Fehlschlag weist wahrscheinlich auf NTCP1 (oder einen Angriff) hin - Bei Fehlschlag Sondierungsresistenz implementieren (zufälliges Timeout + read)</p>
<p><strong>Anforderungen an die Implementierung:</strong></p>
<ol>
<li>
<p><strong>Alices Verantwortung:</strong></p>
<ul>
<li>Begrenze Nachricht 1 beim Verbindungsaufbau zu einer &ldquo;NTCP&rdquo;-Adresse auf maximal 287 Bytes</li>
<li>Puffere die gesamte Nachricht 1 und sende sie anschließend auf einmal</li>
<li>Erhöht die Wahrscheinlichkeit der Zustellung in einem einzigen TCP-Paket</li>
</ul>
</li>
<li>
<p><strong>Bobs Verantwortung:</strong></p>
<ul>
<li>Empfangene Daten puffern, bevor die Version bestimmt wird</li>
<li>Ordnungsgemäße Timeout-Behandlung implementieren</li>
<li>TCP_NODELAY für eine schnelle Versionserkennung verwenden</li>
<li>Nach Erkennung der Version die gesamte Nachricht 2 auf einmal puffern und einen flush durchführen (Puffer leeren)</li>
</ul>
</li>
</ol>
<p><strong>Sicherheitsaspekte:</strong> - Segmentierungsangriffe: Bob sollte gegenüber TCP-Segmentierung robust sein - Sondierungsangriffe: Zufällige Verzögerungen und Byte-Lesevorgänge bei Fehlern implementieren - DoS-Prävention: Gleichzeitig ausstehende Verbindungen begrenzen - Lese-Timeouts: Sowohl pro Lesevorgang als auch insgesamt (&ldquo;slowloris&rdquo;-Schutz)</p>
<h2 id="richtlinien-zur-uhrzeitabweichung">Richtlinien zur Uhrzeitabweichung</h2>
<p><strong>Zeitstempel-Felder:</strong> - Nachricht 1: <code>tsA</code> (Zeitstempel von Alice) - Nachricht 2: <code>tsB</code> (Zeitstempel von Bob) - Nachricht 3+: Optionale DateTime-Blöcke (Datum/Uhrzeit)</p>
<p><strong>Maximale Zeitabweichung (D):</strong> - Typisch: <strong>±60 Sekunden</strong> - Pro Implementierung konfigurierbar - Zeitabweichung &gt; D ist in der Regel fatal</p>
<h3 id="bobs-verarbeitung-nachricht-1">Bobs Verarbeitung (Nachricht 1)</h3>
<pre tabindex="0"><code>1. Receive tsA from Alice
2. skew = tsA - current_time
3. If |skew| &gt; D:
   a. Still send message 2 (allows Alice to calculate skew)
   b. Include tsB in message 2
   c. Do NOT initiate handshake completion
   d. Optionally: Temporary ban Alice&#39;s IP
   e. After message 2 sent, close connection

4. If |skew| ≤ D:
   a. Continue handshake normally
</code></pre><p><strong>Begründung:</strong> Das Senden von Nachricht 2 selbst bei Zeitabweichung ermöglicht es Alice, Probleme mit der Systemuhr zu diagnostizieren.</p>
<h3 id="alices-verarbeitung-nachricht-2">Alices Verarbeitung (Nachricht 2)</h3>
<pre tabindex="0"><code>1. Receive tsB from Bob
2. RTT = (current_time_now - tsA_sent)
3. adjusted_skew = (tsB - current_time_now) - (RTT / 2)
4. If |adjusted_skew| &gt; D:
   a. Close connection immediately
   b. If local clock suspect: Adjust clock or use external time source
   c. If Bob&#39;s clock suspect: Temporary ban Bob
   d. Log for operator review
5. If |adjusted_skew| ≤ D:
   a. Continue handshake normally
   b. Optionally: Track skew for time synchronization
</code></pre><p><strong>RTT-Anpassung:</strong> - Ziehe die halbe RTT von der berechneten Uhrabweichung ab - Berücksichtigt die Ausbreitungsverzögerung im Netzwerk - Genauere Schätzung der Uhrabweichung</p>
<h3 id="bobs-verarbeitung-nachricht-3">Bobs Verarbeitung (Nachricht 3)</h3>
<pre tabindex="0"><code>1. If message 3 received (unlikely if skew exceeded in message 1)
2. Recalculate skew = tsA_received - current_time
3. If |adjusted_skew| &gt; D:
   a. Send termination block (reason code 7: clock skew)
   b. Close connection
   c. Ban Alice for period (e.g., 1-24 hours)
</code></pre><h3 id="zeitsynchronisierung">Zeitsynchronisierung</h3>
<p><strong>DateTime-Blöcke (Datenphase):</strong> - DateTime-Block (Typ 0) regelmäßig senden - Empfänger kann ihn zum Uhrabgleich verwenden - Zeitstempel auf die nächste ganze Sekunde runden (Verzerrungen vermeiden)</p>
<p><strong>Externe Zeitquellen:</strong> - NTP (Network Time Protocol) - Synchronisierung der Systemuhr - konsensbasierte Zeit des I2P-Netzwerks</p>
<p><strong>Strategien zur Uhrzeitkorrektur:</strong> - Wenn die lokale Systemuhr falsch ist: Systemzeit anpassen oder einen Offset verwenden - Wenn die Uhren der Peers dauerhaft falsch sind: Peer-Problem kennzeichnen - Abweichungsstatistiken für die Überwachung der Netzwerkgesundheit nachverfolgen</p>
<h2 id="sicherheitseigenschaften">Sicherheitseigenschaften</h2>
<h3 id="vorwärtsgeheimnis">Vorwärtsgeheimnis</h3>
<p><strong>Erreicht durch:</strong> - Ephemerer Diffie-Hellman-Schlüsselaustausch (X25519) - Drei DH-Operationen: es, ee, se (Noise-XK-Muster) - Ephemere Schlüssel werden nach Abschluss des Handshakes vernichtet</p>
<p><strong>Vertraulichkeitsfortschritt:</strong> - Nachricht 1: Stufe 2 (Vorwärtsgeheimnis bei Kompromittierung des Senders) - Nachricht 2: Stufe 1 (ephemerer Empfänger) - Nachricht 3+: Stufe 5 (starkes Vorwärtsgeheimnis)</p>
<p><strong>Perfect Forward Secrecy (Vorwärtsgeheimnis):</strong> - Kompromittierung langfristiger statischer Schlüssel offenbart NICHT frühere Sitzungsschlüssel - Jede Sitzung verwendet eindeutige ephemere Schlüssel - Ephemere private Schlüssel werden niemals wiederverwendet - Speicherbereinigung nach der Schlüsselaushandlung</p>
<p><strong>Einschränkungen:</strong> - Nachricht 1 ist verwundbar, wenn Bobs statischer Schlüssel kompromittiert ist (aber Vorwärtsgeheimnis bei einer Kompromittierung von Alice) - Wiederholungsangriffe auf Nachricht 1 sind möglich (abgemildert durch Zeitstempel und Replay-Cache)</p>
<h3 id="authentifizierung">Authentifizierung</h3>
<p><strong>Gegenseitige Authentifizierung:</strong> - Alice wird in Nachricht 3 mittels eines statischen Schlüssels authentifiziert - Bob wird durch Besitz des statischen privaten Schlüssels authentifiziert (implizit durch einen erfolgreichen Handshake)</p>
<p><strong>Key Compromise Impersonation (KCI) Resistance (Widerstand gegen Identitätsanmaßung bei kompromittiertem Schlüssel):</strong> - Authentifizierungsstufe 2 (resistent gegen KCI) - Ein Angreifer kann sich nicht als Alice ausgeben, selbst mit Alices statischem privaten Schlüssel (ohne Alices ephemeren Schlüssel) - Ein Angreifer kann sich nicht als Bob ausgeben, selbst mit Bobs statischem privaten Schlüssel (ohne Bobs ephemeren Schlüssel)</p>
<p><strong>Verifizierung statischer Schlüssel:</strong> - Alice kennt Bobs statischen Schlüssel im Voraus (aus der RouterInfo (Router-Informationen)) - Bob verifiziert in Nachricht 3, dass Alices statischer Schlüssel mit der RouterInfo übereinstimmt - Verhindert Man-in-the-Middle-Angriffe</p>
<h3 id="widerstand-gegen-verkehrsanalyse">Widerstand gegen Verkehrsanalyse</h3>
<p><strong>DPI (Deep Packet Inspection)-Gegenmaßnahmen:</strong> 1. <strong>AES-Verschleierung:</strong> Ephemere Schlüssel verschlüsselt, zufälliges Erscheinungsbild 2. <strong>SipHash-Längenverschleierung:</strong> Frame-Längen nicht im Klartext 3. <strong>Zufälliges Padding (Auffüllung):</strong> Variable Nachrichtengrößen, keine festen Muster 4. <strong>Verschlüsselte Frames:</strong> Gesamte Nutzlast mit ChaCha20 verschlüsselt</p>
<p><strong>Schutz vor Replay-Angriffen:</strong> - Zeitstempelvalidierung (±60 Sekunden) - Replay-Cache für ephemere Schlüssel (Lebensdauer 2*D) - Inkremente der Nonce (Einmalwert) verhindern das Wiederholen von Paketen innerhalb einer Sitzung</p>
<p><strong>Widerstandsfähigkeit gegen Sondierungen:</strong> - Zufällige Timeouts bei AEAD (Authentifizierte Verschlüsselung mit zusätzlichen Daten)-Fehlern - Zufälliges Lesen von Bytes vor dem Schließen der Verbindung - Keine Antworten bei Handshake-Fehlern - IP-Blockliste bei wiederholten Fehlern</p>
<p><strong>Richtlinien für Padding:</strong> - Nachrichten 1-2: Klartext-Padding (authentifiziert) - Ab Nachricht 3: Verschlüsseltes Padding innerhalb von AEAD frames (Authenticated Encryption with Associated Data; authentifizierte Verschlüsselung mit zugeordneten Daten) - Ausgehandelte Padding-Parameter (Options-Block) - Nur-Padding-Frames zulässig</p>
<h3 id="abwehr-von-denial-of-service-angriffen">Abwehr von Denial-of-Service-Angriffen</h3>
<p><strong>Verbindungsbeschränkungen:</strong> - Maximale Anzahl aktiver Verbindungen (implementierungsabhängig) - Maximale Anzahl ausstehender Handshakes (z. B. 100-1000) - Verbindungsbeschränkungen pro IP (z. B. 3-10 gleichzeitig)</p>
<p><strong>Ressourcenschutz:</strong> - DH-Operationen ratenbegrenzt (rechenaufwendig) - Lese-Timeouts pro Socket und insgesamt - &ldquo;Slowloris&rdquo;-Schutz (Gesamtzeitlimits) - IP-Blacklisting bei Missbrauch</p>
<p><strong>Schnelle Zurückweisung:</strong> - Netzwerk-ID stimmt nicht überein → sofortige Schließung - Ungültiger X25519-Punkt → schnelle MSB-Prüfung vor der Entschlüsselung - Zeitstempel außerhalb des zulässigen Bereichs → Schließen ohne Berechnung - AEAD-Fehler → keine Antwort, zufällige Verzögerung</p>
<p><strong>Sondierungsresistenz:</strong> - Zufälliges Timeout: 100-500ms (implementierungsabhängig) - Zufälliges Lesen: 1KB-64KB (implementierungsabhängig) - Keine Fehlerinformationen an den Angreifer - Mit TCP RST schließen (kein FIN-Handshake)</p>
<h3 id="kryptografische-sicherheit">Kryptografische Sicherheit</h3>
<p><strong>Algorithmen:</strong> - <strong>X25519</strong>: 128-Bit-Sicherheit, Diffie-Hellman über elliptische Kurven (Curve25519) - <strong>ChaCha20</strong>: Stromchiffre mit 256-Bit-Schlüssel - <strong>Poly1305</strong>: informationstheoretisch sichere MAC (Message Authentication Code) - <strong>SHA-256</strong>: 128-Bit-Kollisionsresistenz, 256-Bit-Urbildresistenz - <strong>HMAC-SHA256</strong>: PRF (pseudorandom function, pseudozufällige Funktion) für die Schlüsselableitung</p>
<p><strong>Schlüsselgrößen:</strong> - Statische Schlüssel: 32 Bytes (256 Bit) - Ephemere Schlüssel: 32 Bytes (256 Bit) - Chiffrierschlüssel: 32 Bytes (256 Bit) - MAC: 16 Bytes (128 Bit)</p>
<p><strong>Bekannte Probleme:</strong> - Wiederverwendung von ChaCha20-Nonces (einmalige Werte) ist katastrophal (verhindert durch Zählerinkrement) - X25519 hat Probleme mit kleinen Untergruppen (abgemildert durch Kurvenvalidierung) - SHA-256 ist theoretisch anfällig für Längenerweiterung (in HMAC nicht ausnutzbar)</p>
<p><strong>Keine bekannten Schwachstellen (Stand Oktober 2025):</strong> - Noise Protocol Framework (Kryptografie-Rahmenwerk für Handshake-Protokolle) umfassend analysiert - ChaCha20-Poly1305 (AEAD-Algorithmus) in TLS 1.3 eingesetzt - X25519 (Schlüsselaustausch auf Basis elliptischer Kurven) Standard in modernen Protokollen - Keine praktischen Angriffe auf die Konstruktion</p>
<h2 id="referenzen">Referenzen</h2>
<h3 id="primäre-spezifikationen">Primäre Spezifikationen</h3>
<ul>
<li><strong><a href="../../../../de/docs/specs/ntcp2/">NTCP2-Spezifikation</a>
</strong> - Offizielle I2P-Spezifikation</li>
<li><strong><a href="../../../../de/proposals/111-ntcp-2/">Vorschlag 111</a>
</strong> - Ursprüngliches Entwurfsdokument mit Begründung</li>
<li><strong><a href="https://noiseprotocol.org/noise.html">Noise Protocol Framework</a>
</strong> - Revision 33 (2017-10-04)</li>
</ul>
<h3 id="kryptografische-standards">Kryptografische Standards</h3>
<ul>
<li><strong><a href="https://www.rfc-editor.org/rfc/rfc7748">RFC 7748</a>
</strong> - Elliptische Kurven für Sicherheitszwecke (X25519)</li>
<li><strong><a href="https://www.rfc-editor.org/rfc/rfc7539">RFC 7539</a>
</strong> - ChaCha20 und Poly1305 für IETF-Protokolle</li>
<li><strong><a href="https://www.rfc-editor.org/rfc/rfc8439">RFC 8439</a>
</strong> - ChaCha20-Poly1305 (ersetzt RFC 7539)</li>
<li><strong><a href="https://www.rfc-editor.org/rfc/rfc2104">RFC 2104</a>
</strong> - HMAC: Schlüsselbasiertes Hashing zur Nachrichtenauthentifizierung</li>
<li><strong><a href="https://www.131002.net/siphash/">SipHash</a>
</strong> - SipHash-2-4 für Anwendungen von Hashfunktionen</li>
</ul>
<h3 id="verwandte-i2p-spezifikationen">Verwandte I2P-Spezifikationen</h3>
<ul>
<li><strong><a href="../../../../de/docs/specs/i2np/">I2NP-Spezifikation</a>
</strong> - Nachrichtenformat des I2P-Netzwerkprotokolls</li>
<li><strong><a href="../../../../de/docs/specs/common-structures/">Gemeinsame Strukturen</a>
</strong> - Formate von RouterInfo und RouterAddress</li>
<li><strong><a href="../../../../de/docs/legacy/ssu/">SSU-Transport</a>
</strong> - UDP-Transport (ursprünglich, jetzt SSU2)</li>
<li><strong><a href="../../../../de/proposals/147-transport-network-id-check/">Vorschlag 147</a>
</strong> - Prüfung der Transport-Netzwerk-ID (0.9.42)</li>
</ul>
<h3 id="referenzen-zur-implementierung">Referenzen zur Implementierung</h3>
<ul>
<li><strong><a href="https://github.com/i2p/i2p.i2p">I2P Java</a>
</strong> - Referenzimplementierung (Java)</li>
<li><strong><a href="https://github.com/PurpleI2P/i2pd">i2pd</a>
</strong> - C++-Implementierung</li>
<li><strong><a href="../../../../de/blog/">I2P Versionshinweise</a>
</strong> - Versionsverlauf und Aktualisierungen</li>
</ul>
<h3 id="historischer-kontext">Historischer Kontext</h3>
<ul>
<li><strong><a href="https://en.wikipedia.org/wiki/Station-to-Station_protocol">Station-To-Station Protocol (STS)</a>
</strong> - Inspiration für das Noise-Framework</li>
<li><strong><a href="https://gitlab.com/yawning/obfs4">obfs4</a>
</strong> - Pluggable transport (austauschbares Transportprotokoll; SipHash-Längenverschleierung als Präzedenzfall)</li>
</ul>
<h2 id="implementierungsrichtlinien">Implementierungsrichtlinien</h2>
<h3 id="verbindliche-anforderungen">Verbindliche Anforderungen</h3>
<p><strong>Zur Einhaltung:</strong></p>
<ol>
<li>
<p><strong>Vollständigen Handshake implementieren:</strong></p>
<ul>
<li>Alle drei Nachrichten mit korrekten KDF-Ketten (Schlüsselableitungsfunktionen) unterstützen</li>
<li>Alle AEAD-Tags (Authentifizierte Verschlüsselung mit zusätzlichen Daten) validieren</li>
<li>Überprüfen, dass X25519-Punkte gültig sind</li>
</ul>
</li>
<li>
<p><strong>Datenphase implementieren:</strong></p>
<ul>
<li>SipHash-Längenverschleierung (in beiden Richtungen)</li>
<li>Alle Blocktypen: 0 (DateTime), 1 (Options), 2 (RouterInfo), 3 (I2NP), 4 (Termination), 254 (Padding)</li>
<li>Korrektes Nonce (Einmalwert)-Management (separate Zähler)</li>
</ul>
</li>
<li>
<p><strong>Sicherheitsfunktionen:</strong></p>
<ul>
<li>Replay-Schutz (ephemere Schlüssel für 2*D zwischenspeichern)</li>
<li>Zeitstempel-Validierung (Standard: ±60 Sekunden)</li>
<li>Zufälliges Padding in Nachrichten 1-2</li>
<li>AEAD (authentifizierte Verschlüsselung mit zusätzlichen Daten)-Fehlerbehandlung mit zufälligen Timeouts</li>
</ul>
</li>
<li>
<p><strong>Veröffentlichung von RouterInfo:</strong></p>
<ul>
<li>Veröffentliche statischen Schlüssel (&ldquo;s&rdquo;), IV (&ldquo;i&rdquo;) und Version (&ldquo;v&rdquo;)</li>
<li>Rotiere Schlüssel gemäß Richtlinie</li>
<li>Unterstütze das Feld für Fähigkeiten (&ldquo;caps&rdquo;) für versteckte router</li>
</ul>
</li>
<li>
<p><strong>Netzwerkkompatibilität:</strong></p>
<ul>
<li>Unterstützung des Netzwerk-ID-Felds (derzeit 2 für mainnet (Hauptnetz))</li>
<li>Interoperabilität mit bestehenden Java- und i2pd-Implementierungen</li>
<li>Unterstützung von IPv4 und IPv6</li>
</ul>
</li>
</ol>
<h3 id="empfohlene-vorgehensweisen">Empfohlene Vorgehensweisen</h3>
<p><strong>Leistungsoptimierung:</strong></p>
<ol>
<li>
<p><strong>Pufferstrategie:</strong></p>
<ul>
<li>Gesamte Nachrichten auf einmal senden (Nachrichten 1, 2, 3)</li>
<li>TCP_NODELAY (TCP-Option, die den Nagle-Algorithmus deaktiviert) für Handshake-Nachrichten verwenden</li>
<li>Mehrere Datenblöcke zu einem einzelnen Frame puffern</li>
<li>Frame-Größe auf wenige KB begrenzen (Latenz beim Empfänger minimieren)</li>
</ul>
</li>
<li>
<p><strong>Verbindungsverwaltung:</strong></p>
<ul>
<li>Verbindungen nach Möglichkeit wiederverwenden</li>
<li>Verbindungspooling implementieren</li>
<li>Verbindungsgesundheit überwachen (DateTime blocks – zeitbezogene Blöcke)</li>
</ul>
</li>
<li>
<p><strong>Speicherverwaltung:</strong></p>
<ul>
<li>Sensible Daten nach der Verwendung auf Null setzen (ephemere Schlüssel, DH-Ergebnisse (Diffie-Hellman))</li>
<li>Gleichzeitige Handshakes begrenzen (DoS-Prävention)</li>
<li>Speicherpools für häufige Zuweisungen verwenden</li>
</ul>
</li>
</ol>
<p><strong>Sicherheitshärtung:</strong></p>
<ol>
<li>
<p><strong>Abwehr von Sondierungsversuchen:</strong></p>
<ul>
<li>Zufällige Timeouts: 100-500ms</li>
<li>Zufällige Byte-Lesevorgänge: 1KB-64KB</li>
<li>IP-Blacklisting bei wiederholten Fehlschlägen</li>
<li>Keine Fehlerdetails an Peers</li>
</ul>
</li>
<li>
<p><strong>Ressourcengrenzen:</strong></p>
<ul>
<li>Maximale Verbindungen pro IP: 3-10</li>
<li>Maximale ausstehende Handshakes: 100-1000</li>
<li>Lese-Timeouts: 30-60 Sekunden pro Vorgang</li>
<li>Gesamtes Verbindungs-Timeout: 5 Minuten für den Handshake</li>
</ul>
</li>
<li>
<p><strong>Schlüsselverwaltung:</strong></p>
<ul>
<li>Persistente Speicherung von statischem Schlüssel und IV (Initialisierungsvektor)</li>
<li>Sichere Zufallszahlengenerierung (kryptografischer RNG)</li>
<li>Rotationsrichtlinien strikt einhalten</li>
<li>Ephemere Schlüssel niemals wiederverwenden</li>
</ul>
</li>
</ol>
<p><strong>Überwachung und Diagnose:</strong></p>
<ol>
<li>
<p><strong>Metriken:</strong></p>
<ul>
<li>Erfolgs-/Fehlerraten beim Handshake</li>
<li>AEAD-Fehlerraten</li>
<li>Verteilung der Uhrenabweichungen</li>
<li>Statistiken zur Verbindungsdauer</li>
</ul>
</li>
<li>
<p><strong>Protokollierung:</strong></p>
<ul>
<li>Handshake-Fehler mit Reason-Codes (Begründungscodes) protokollieren</li>
<li>Clock-Skew-Ereignisse (Abweichungen der Systemuhren) protokollieren</li>
<li>Gesperrte IP-Adressen protokollieren</li>
<li>Niemals sensibles Schlüsselmaterial protokollieren</li>
</ul>
</li>
<li>
<p><strong>Tests:</strong></p>
<ul>
<li>Unit-Tests für KDF-Ketten</li>
<li>Integrationstests mit anderen Implementierungen</li>
<li>Fuzzing für Paketverarbeitung</li>
<li>Lasttests zur Widerstandsfähigkeit gegen DoS</li>
</ul>
</li>
</ol>
<h3 id="häufige-fallstricke">Häufige Fallstricke</h3>
<p><strong>Kritische Fehler, die zu vermeiden sind:</strong></p>
<ol>
<li>
<p><strong>Wiederverwendung von Nonces (Nonce = Einmalwert):</strong></p>
<ul>
<li>Den Nonce-Zähler niemals während einer Sitzung zurücksetzen</li>
<li>Für jede Richtung separate Zähler verwenden</li>
<li>Vor Erreichen von 2^64 - 1 beenden</li>
</ul>
</li>
<li>
<p><strong>Schlüsselrotation:</strong></p>
<ul>
<li>Niemals Schlüssel rotieren, während der router läuft</li>
<li>Ephemere Schlüssel niemals über Sitzungen hinweg wiederverwenden</li>
<li>Regeln für minimale Ausfallzeit befolgen</li>
</ul>
</li>
<li>
<p><strong>Zeitstempel-Verarbeitung:</strong></p>
<ul>
<li>Niemals abgelaufene Zeitstempel akzeptieren</li>
<li>Bei der Berechnung der Abweichung stets die RTT (Round-Trip Time) berücksichtigen</li>
<li>DateTime-Zeitstempel auf Sekunden runden</li>
</ul>
</li>
<li>
<p><strong>AEAD-Fehler:</strong></p>
<ul>
<li>Fehlertyp niemals gegenüber dem Angreifer offenlegen</li>
<li>Vor dem Schließen stets einen zufälligen Timeout verwenden</li>
<li>Ungültige Länge genauso behandeln wie einen AEAD-Fehler</li>
</ul>
</li>
<li>
<p><strong>Padding:</strong></p>
<ul>
<li>Niemals Padding außerhalb der vereinbarten Grenzen senden</li>
<li>Den Padding-Block immer zuletzt platzieren</li>
<li>Niemals mehrere Padding-Blöcke pro Frame</li>
</ul>
</li>
<li>
<p><strong>RouterInfo:</strong></p>
<ul>
<li>Immer überprüfen, dass der statische Schlüssel mit der RouterInfo übereinstimmt</li>
<li>Niemals RouterInfos ohne veröffentlichte Adressen flooden (über floodfill verbreiten)</li>
<li>Immer Signaturen verifizieren</li>
</ul>
</li>
</ol>
<h3 id="testmethodik">Testmethodik</h3>
<p><strong>Unit-Tests:</strong></p>
<ol>
<li>
<p><strong>Kryptographische Primitive:</strong></p>
<ul>
<li>Testvektoren für X25519, ChaCha20, Poly1305, SHA-256</li>
<li>Testvektoren für HMAC-SHA256</li>
<li>Testvektoren für SipHash-2-4</li>
</ul>
</li>
<li>
<p><strong>KDF-Ketten:</strong></p>
<ul>
<li>Known-Answer-Tests für alle drei Nachrichten</li>
<li>Weitergabe des Chaining Keys (Verkettungsschlüssel) überprüfen</li>
<li>SipHash-IV-Erzeugung testen</li>
</ul>
</li>
<li>
<p><strong>Nachrichten-Parsing:</strong></p>
<ul>
<li>Dekodierung gültiger Nachrichten</li>
<li>Ablehnung ungültiger Nachrichten</li>
<li>Randbedingungen (leer, maximale Größe)</li>
</ul>
</li>
</ol>
<p><strong>Integrationstests:</strong></p>
<ol>
<li>
<p><strong>Handshake:</strong></p>
<ul>
<li>Erfolgreicher Austausch von drei Nachrichten</li>
<li>Zurückweisung bei Uhrversatz</li>
<li>Erkennung von Replay-Angriffen</li>
<li>Zurückweisung ungültiger Schlüssel</li>
</ul>
</li>
<li>
<p><strong>Datenphase:</strong></p>
<ul>
<li>I2NP-Nachrichtenübertragung</li>
<li>RouterInfo-Austausch</li>
<li>Verarbeitung von Padding (Auffüllung)</li>
<li>Beendigungsnachrichten</li>
</ul>
</li>
<li>
<p><strong>Interoperabilität:</strong></p>
<ul>
<li>Gegen Java I2P testen</li>
<li>Gegen i2pd testen</li>
<li>IPv4 und IPv6 testen</li>
<li>Veröffentlichte und versteckte routers testen</li>
</ul>
</li>
</ol>
<p><strong>Sicherheitstests:</strong></p>
<ol>
<li>
<p><strong>Negativtests:</strong></p>
<ul>
<li>Ungültige AEAD-Tags</li>
<li>Erneut gesendete Nachrichten</li>
<li>Angriffe durch Zeitdrift (Clock Skew)</li>
<li>Fehlerhaft formatierte Frames</li>
</ul>
</li>
<li>
<p><strong>DoS-Tests:</strong></p>
<ul>
<li>Verbindungsflutung</li>
<li>Slowloris-Angriffe (Angriff durch langsame, unvollständige HTTP-Anfragen)</li>
<li>CPU-Erschöpfung (exzessives DH (Diffie-Hellman))</li>
<li>Speichererschöpfung</li>
</ul>
</li>
<li>
<p><strong>Fuzzing:</strong></p>
<ul>
<li>Zufällige Handshake-Nachrichten</li>
<li>Zufällige Frames der Datenphase</li>
<li>Zufällige Blocktypen und -größen</li>
<li>Ungültige kryptografische Werte</li>
</ul>
</li>
</ol>
<h3 id="migration-von-ntcp">Migration von NTCP</h3>
<p><strong>Für Legacy-NTCP-Unterstützung (inzwischen entfernt):</strong></p>
<p>NTCP (Version 1) wurde in I2P 0.9.50 (Mai 2021) entfernt. Alle aktuellen Implementierungen müssen NTCP2 unterstützen. Historische Anmerkungen:</p>
<ol>
<li>
<p><strong>Übergangsphase (2018-2021):</strong></p>
<ul>
<li>0.9.36: NTCP2 eingeführt (standardmäßig deaktiviert)</li>
<li>0.9.37: NTCP2 standardmäßig aktiviert</li>
<li>0.9.40: NTCP als veraltet markiert</li>
<li>0.9.50: NTCP entfernt</li>
</ul>
</li>
<li>
<p><strong>Versionserkennung:</strong></p>
<ul>
<li>&ldquo;NTCP&rdquo; transportStyle gab an, dass beide Versionen unterstützt werden</li>
<li>&ldquo;NTCP2&rdquo; transportStyle gab an, dass nur NTCP2 unterstützt wird</li>
<li>Automatische Erkennung anhand der Nachrichtengröße (287 vs 288 Bytes)</li>
</ul>
</li>
<li>
<p><strong>Aktueller Status:</strong></p>
<ul>
<li>Alle Router müssen NTCP2 unterstützen</li>
<li>&ldquo;NTCP&rdquo; transportStyle ist veraltet</li>
<li>Ausschließlich den &ldquo;NTCP2&rdquo; transportStyle verwenden</li>
</ul>
</li>
</ol>
<h2 id="anhang-a-noise-xk-muster">Anhang A: Noise-XK-Muster</h2>
<p><strong>Standard Noise XK Pattern (standardmäßiges XK-Muster des Noise-Protokolls):</strong></p>
<pre tabindex="0"><code>XK(s, rs):
  &lt;- s
  ...
  -&gt; e, es
  &lt;- e, ee
  -&gt; s, se
</code></pre><p><strong>Interpretation:</strong></p>
<ul>
<li><code>&lt;-</code> : Nachricht vom Responder (Bob) an den Initiator (Alice)</li>
<li><code>-&gt;</code> : Nachricht vom Initiator (Alice) an den Responder (Bob)</li>
<li><code>s</code> : Statischer Schlüssel (Langzeit-Identitätsschlüssel)</li>
<li><code>rs</code> : Entfernter statischer Schlüssel (statischer Schlüssel der Gegenstelle, vorab bekannt)</li>
<li><code>e</code> : Ephemerer Schlüssel (sitzungsspezifisch, bei Bedarf erzeugt)</li>
<li><code>es</code> : Ephemer-Statisch DH (Diffie-Hellman-Schlüsselaustausch; Alice ephemerer × Bob statischer)</li>
<li><code>ee</code> : Ephemer-Ephemer DH (Alice ephemerer × Bob ephemerer)</li>
<li><code>se</code> : Statisch-Ephemer DH (Alice statischer × Bob ephemerer)</li>
</ul>
<p><strong>Ablauf der Schlüsselvereinbarung:</strong></p>
<ol>
<li><strong>Vorabnachricht:</strong> Alice kennt Bobs statischen öffentlichen Schlüssel (aus RouterInfo)</li>
<li><strong>Nachricht 1:</strong> Alice sendet einen ephemeren Schlüssel, führt es DH aus</li>
<li><strong>Nachricht 2:</strong> Bob sendet einen ephemeren Schlüssel, führt ee DH aus</li>
<li><strong>Nachricht 3:</strong> Alice gibt den statischen Schlüssel preis, führt se DH aus</li>
</ol>
<p><strong>Sicherheitseigenschaften:</strong></p>
<ul>
<li>Alice authentifiziert: Ja (durch Nachricht 3)</li>
<li>Bob authentifiziert: Ja (durch Besitz des statischen privaten Schlüssels)</li>
<li>Vorwärtsgeheimnis: Ja (ephemere Schlüssel vernichtet)</li>
<li>KCI resistance (Widerstandsfähigkeit gegen Key-Compromise-Impersonation): Ja (Authentifizierungsstufe 2)</li>
</ul>
<h2 id="anhang-b-base64-kodierung">Anhang B: Base64-Kodierung</h2>
<p><strong>I2P-Base64-Alphabet:</strong></p>
<pre tabindex="0"><code>ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-~
</code></pre><p><strong>Unterschiede zu Standard-Base64:</strong> - Zeichen 62-63: <code>-~</code> statt <code>+/</code> - Padding: gleich (<code>=</code>) oder je nach Kontext weggelassen</p>
<p><strong>Verwendung in NTCP2:</strong> - Statischer Schlüssel (&ldquo;s&rdquo;): 32 Bytes → 44 Zeichen (kein Padding) - IV (&ldquo;i&rdquo;): 16 Bytes → 24 Zeichen (kein Padding)</p>
<p><strong>Kodierungsbeispiel:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 32-byte static key (hex): </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># f4489e1bb0597b39ca6cbf5ad9f5f1f09043e02d96cb9aa6a63742b3462429aa</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># I2P Base64 encoded:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 9EjeG7BZeznKbL9a2fXx8JBDPgLZbLmKbqY3QrNGJCo=</span>
</span></span></code></pre></div><h2 id="anhang-c-analyse-von-paketmitschnitten">Anhang C: Analyse von Paketmitschnitten</h2>
<p><strong>Erkennung von NTCP2-Verkehr:</strong></p>
<ol>
<li>
<p><strong>TCP-Handshake:</strong></p>
<ul>
<li>Standard-TCP SYN, SYN-ACK, ACK</li>
<li>Zielport typischerweise 8887 oder ähnlich</li>
</ul>
</li>
<li>
<p><strong>Nachricht 1 (SessionRequest – Sitzungsanforderung):</strong></p>
<ul>
<li>Erste Anwendungsdaten von Alice</li>
<li>80-65535 Bytes (typischerweise ein paar Hundert)</li>
<li>Erscheint zufällig (AES-verschlüsselter ephemerer Schlüssel)</li>
<li>Maximal 287 Bytes bei Verbindung zu einer &ldquo;NTCP&rdquo;-Adresse</li>
</ul>
</li>
<li>
<p><strong>Nachricht 2 (SessionCreated):</strong></p>
<ul>
<li>Antwort von Bob</li>
<li>80-65535 Bytes (typischerweise einige Hundert)</li>
<li>Erscheint ebenfalls zufällig</li>
</ul>
</li>
<li>
<p><strong>Nachricht 3 (SessionConfirmed, Sitzung bestätigt):</strong></p>
<ul>
<li>Von Alice</li>
<li>48 Byte + variabler Anteil (RouterInfo-Größe + Padding)</li>
<li>Typischerweise 1–4 KB</li>
</ul>
</li>
<li>
<p><strong>Datenphase:</strong></p>
<ul>
<li>Frames variabler Länge</li>
<li>Längenfeld verschleiert (erscheint zufällig)</li>
<li>Verschlüsselte Nutzlast</li>
<li>Padding macht die Größe unvorhersehbar</li>
</ul>
</li>
</ol>
<p><strong>DPI-Umgehung:</strong> - Keine Klartext-Header - Keine festen Muster - Längenfelder verschleiert - Zufälliges Padding durchbricht größenbasierte Heuristiken</p>
<p><strong>Vergleich mit NTCP:</strong> - NTCP Nachricht 1 ist immer 288 Byte groß (identifizierbar) - Bei NTCP2 variiert die Größe von Nachricht 1 (nicht identifizierbar) - NTCP hatte erkennbare Muster - NTCP2 wurde so entworfen, dass es DPI widersteht</p>
<h2 id="anhang-d-versionsverlauf">Anhang D: Versionsverlauf</h2>
<p><strong>Wichtige Meilensteine:</strong></p>
<ul>
<li><strong>0.9.36</strong> (23. August 2018): NTCP2 eingeführt, standardmäßig deaktiviert</li>
<li><strong>0.9.37</strong> (4. Oktober 2018): NTCP2 standardmäßig aktiviert</li>
<li><strong>0.9.40</strong> (20. Mai 2019): NTCP als veraltet markiert</li>
<li><strong>0.9.42</strong> (27. August 2019): Netzwerk-ID-Feld hinzugefügt (Proposal 147)</li>
<li><strong>0.9.50</strong> (17. Mai 2021): NTCP entfernt, Unterstützung für Fähigkeiten hinzugefügt</li>
<li><strong>2.10.0</strong> (9. September 2025): Neueste stabile Version</li>
</ul>
<p><strong>Protokollstabilität:</strong> - Keine inkompatiblen Änderungen seit 0.9.50 - Laufende Verbesserungen der Widerstandsfähigkeit gegen Sondierungsangriffe - Fokus auf Leistung und Zuverlässigkeit - Post-Quanten-Kryptografie in Entwicklung (standardmäßig nicht aktiviert)</p>
<p><strong>Aktueller Transportstatus:</strong> - NTCP2: Obligatorischer TCP-Transport - SSU2: Obligatorischer UDP-Transport - NTCP (v1): Entfernt - SSU (v1): Entfernt</p>

                </article>

                
                <nav class="page-nav">
                    
                        <a href="../../../../de/docs/specs/plugin/" class="page-nav-link prev">
                            <span class="nav-label">← Previous</span>
                            <span class="nav-title">Plugin-Paketformat</span>
                        </a>
                    
                    
                        <a href="../../../../de/docs/specs/implementation/" class="page-nav-link next">
                            <span class="nav-label">Next →</span>
                            <span class="nav-title">Leitfaden für den Tunnelbetrieb</span>
                        </a>
                    
                </nav>

                
                <div class="docs-feedback">
                    <p>Was this page helpful?</p>
                    <div class="feedback-buttons" id="feedback-buttons">
                        <button class="feedback-btn" id="feedback-yes">👍 Yes</button>
                        <button class="feedback-btn" id="feedback-no">👎 No</button>
                    </div>

                    
                    <div class="feedback-form-container" id="feedback-form-container" style="display: none;">
                        <p class="feedback-form-title">We're sorry to hear that. How can we improve this page?</p>
                        <form id="feedback-form">
                            <div class="form-group">
                                <label for="feedback-email">Email (optional - if you'd like a response)</label>
                                <input type="email" id="feedback-email" name="email" placeholder="your@email.com">
                            </div>
                            <div class="form-group">
                                <label for="feedback-message">Feedback *</label>
                                <textarea id="feedback-message" name="message" rows="4" required placeholder="Tell us what we can improve..."></textarea>
                            </div>
                            <button type="submit" class="btn-submit-feedback" id="feedback-submit-btn">
                                <span class="btn-text">Submit Feedback</span>
                                <span class="btn-loading" style="display: none;">Sending...</span>
                            </button>
                        </form>
                    </div>

                    
                    <div class="feedback-message" id="feedback-success" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/>
                        </svg>
                        <span id="feedback-success-text">Thanks for your feedback!</span>
                    </div>
                    <div class="feedback-message feedback-error" id="feedback-error" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path d="M12 8v4M12 16h.01" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span id="feedback-error-text">Something went wrong. Please try again.</span>
                    </div>

                    <p class="feedback-note">
                        Found an issue? <a href="https://gitlab.com/stormycloud-group/i-2-p-www-v-2/-/blob/main/hugo-site/content/de/docs/specs/ntcp2.md?ref_type=heads" target="_blank">Edit this page on GitLab</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.docs-page {
    min-height: 100vh;
    padding: var(--spacing-xl) 0;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
}

.breadcrumbs a:hover {
    color: var(--color-primary);
}

.separator {
    color: var(--color-border);
}

.current {
    color: var(--color-text);
}

 
.translation-disclaimer {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.dark .translation-disclaimer {
    background: #78350f;
    border-color: #d97706;
}

.disclaimer-message {
    color: #92400e;
    font-size: 0.875rem;
}

.dark .disclaimer-message {
    color: #fde047;
}

.disclaimer-link {
    color: #92400e;
    font-weight: 600;
    text-decoration: underline;
    white-space: nowrap;
}

.dark .disclaimer-link {
    color: #fde047;
}

 
.article-header {
    margin-bottom: var(--spacing-2xl);
}

.article-title {
    font-size: 2.5rem;
    margin: 0 0 var(--spacing-md) 0;
    color: var(--color-text);
}

.article-description {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-md);
}

.article-meta {
    display: flex;
    gap: var(--spacing-lg);
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.meta-item svg {
    color: var(--color-primary);
}

 
.docs-layout {
    display: block;
}

.docs-layout--with-toc {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

 
.docs-toc-sidebar {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.toc-nav {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
}

.toc-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-text);
    padding-bottom: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
}

.toc-content {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
}

.toc-content::-webkit-scrollbar {
    width: 4px;
}

.toc-content::-webkit-scrollbar-track {
    background: transparent;
}

.toc-content::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
}

.toc-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

.toc-nav ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc-nav li {
    margin-bottom: 0.25rem;
}

.toc-nav ul ul {
    padding-left: var(--spacing-md);
    margin-top: 0.25rem;
}

.toc-nav a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.8125rem;
    display: block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    line-height: 1.4;
}

.toc-nav a:hover {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
}

 
.docs-main {
    min-width: 0;
    max-width: 900px;
}

 
.article-content {
    line-height: 1.8;
    color: var(--color-text);
}

.article-content h2 {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.75rem;
    scroll-margin-top: 100px;
}

.article-content h3 {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.375rem;
    scroll-margin-top: 100px;
}

.article-content h4 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-xs);
    font-size: 1.125rem;
    scroll-margin-top: 100px;
}

.article-content p {
    margin-bottom: var(--spacing-md);
}

.article-content ul,
.article-content ol {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-xl);
}

.article-content li {
    margin-bottom: var(--spacing-xs);
}

.article-content code {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
}

.article-content pre {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: var(--spacing-md);
}

.article-content pre code {
    background: none;
    padding: 0;
}

.article-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin: var(--spacing-lg) 0;
    display: block;
}

.article-content a {
    color: var(--color-primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color var(--transition-fast);
}

.article-content a:hover {
    border-bottom-color: var(--color-primary);
}

 
.page-nav {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
}

.page-nav-link {
    display: flex;
    flex-direction: column;
    padding: var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.page-nav-link:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
}

.page-nav-link.next {
    text-align: right;
}

.nav-label {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xs);
}

.nav-title {
    font-weight: 600;
    color: var(--color-text);
}

 
.docs-feedback {
    margin-top: var(--spacing-2xl);
    padding: var(--spacing-lg);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    text-align: center;
}

.feedback-buttons {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    margin: var(--spacing-md) 0;
}

.feedback-btn {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.feedback-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-primary);
    color: white;
}

.feedback-note {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-top: var(--spacing-md);
}

.feedback-note a {
    color: var(--color-primary);
    text-decoration: none;
}

.feedback-note a:hover {
    text-decoration: underline;
}

 
.feedback-form-container {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-align: left;
}

.feedback-form-title {
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--color-text);
}

.form-group {
    margin-bottom: var(--spacing-md);
}

.form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
    color: var(--color-text);
}

.form-group input[type="email"],
.form-group textarea {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    color: var(--color-text);
    font-family: inherit;
    font-size: 0.9375rem;
    transition: border-color var(--transition-fast);
}

.form-group input[type="email"]:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.btn-submit-feedback {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-submit-feedback:hover:not(:disabled) {
    background: var(--color-primary-dark);
    transform: translateY(-1px);
}

.btn-submit-feedback:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

 
.feedback-message {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: #d1fae5;
    color: #065f46;
    border-radius: var(--radius-md);
    margin-top: var(--spacing-md);
}

.feedback-message.feedback-error {
    background: #fee2e2;
    color: #991b1b;
}

.feedback-message svg {
    flex-shrink: 0;
}

 
@media (max-width: 1024px) {
    .docs-layout--with-toc {
        grid-template-columns: 1fr;
    }

    .docs-toc-sidebar {
        position: static;
        max-height: none;
        margin-bottom: var(--spacing-xl);
    }

    .toc-content {
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .article-title {
        font-size: 1.75rem;
    }
}
</style>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = [];

    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const heading = document.getElementById(href.slice(1));
            if (heading) {
                headings.push({ element: heading, link: link });
            }
        }
    });

    function updateActiveLink() {
        const scrollPos = window.scrollY + 120;
        let activeIndex = 0;

        for (let i = 0; i < headings.length; i++) {
            if (headings[i].element.offsetTop <= scrollPos) {
                activeIndex = i;
            }
        }

        tocLinks.forEach(link => link.classList.remove('active'));
        if (headings[activeIndex]) {
            headings[activeIndex].link.classList.add('active');
        }
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});
</script>
<style>
.toc-nav a.active {
    color: var(--color-primary);
    background: var(--color-bg-tertiary);
    font-weight: 600;
}
</style>



<script>
(function() {
    'use strict';
    
    
    let baseUrl = window.feedbackBaseUrl;
    if (!baseUrl) {
        const hostname = window.location.hostname;
        
        if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
            baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
        } else if (hostname.endsWith('.onion')) {
            baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
        } else {
            baseUrl = 'https://feedback.i2p.net';
        }
    }
    
    const script = document.createElement('script');
    script.src = baseUrl + '/widgets/docs-feedback.js';
    script.async = true;
    script.onerror = function() {
        console.error('[Docs Feedback] Failed to load docs-feedback.js from:', baseUrl);
    };
    document.body.appendChild(script);
})();
</script>


    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col footer-brand">
                <img src="../../../../images/i2plogo_lightmode.svg" alt="I2P Logo" class="footer-logo logo-light" loading="lazy" decoding="async">
                <img src="../../../../images/i2plogo_darkmode.svg" alt="I2P Logo" class="footer-logo logo-dark" loading="lazy" decoding="async">
                <p class="footer-tagline">Privacy. Security. Freedom.</p>
                <p class="footer-description">The Invisible Internet Project - A privacy-focused, anonymous network layer</p>

                <div class="footer-social-newsletter">
                    <div class="social-links">
                        <a href="https://mastodon.social/@i2p" target="_blank" rel="noopener" aria-label="Mastodon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                            </svg>
                        </a>
                        <a href="https://twitter.com/GetI2P" target="_blank" rel="noopener" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="https://old.reddit.com/r/i2p" target="_blank" rel="noopener" aria-label="Reddit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                            </svg>
                        </a>
                        <a href="https://signal.group/#CjQKIOSUTtxlhbumAKcRsthPFkxkTUrkWcX39bbN6njLEgAIEhCTNsR0KDuiehAXZnkt42v5" target="_blank" rel="noopener" aria-label="Signal" class="signal-link">
                            <img src="../../../../images/Signal-Logo-Black.svg" alt="Signal" class="signal-logo signal-logo-light" loading="lazy" decoding="async">
                            <img src="../../../../images/Signal-Logo-White.svg" alt="Signal" class="signal-logo signal-logo-dark" loading="lazy" decoding="async">
                        </a>
                    </div>

                    
                    <div class="footer-newsletter-inline">
                        <p class="newsletter-description">Bleiben Sie über I2P-Neuigkeiten informiert:</p>
                        <form action="https://feedback.i2p.net/api/mailing-list/subscribe" method="POST" class="newsletter-form">
                            <input type="email" name="email" placeholder="Geben Sie Ihre E-Mail ein" required>
                            <button type="submit">Abonnieren</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h3>Schnellzugriff</h3>
                <ul>
                    <li><a href="../../../../de/financial-support/">Spenden</a></li>
                    <li><a href="../../../../de/docs/overview/intro/">I2P Einführung</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Gemeinschaft</h3>
                <ul>
                    <li><a href="../../../../de/get-involved/">Mitmachen</a></li>
                    <li><a href="../../../../de/blog/">Blog</a></li>
                    <li><a href="http://i2pforum.net/" target="_blank" rel="noopener">Offizielle Foren</a></li>
                    <li><a href="../../../../de/contact/">Kontakt</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Ressourcen</h3>
                <ul>
                    <li><a href="https://i2p-metrics.np-tokumei.net/" target="_blank" rel="noopener">I2P Metriken</a></li>
                    <li><a href="../../../../de/papers/">Forschung</a></li>
                    <li><a href="https://i2pgit.org/" target="_blank" rel="noopener">GitLab</a></li>
                    <li><a href="https://www.stormycloud.org/" target="_blank" rel="noopener">StormyCloud</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p class="copyright">&copy; 2025 Das Invisible Internet Project. Lizenziert unter Creative Commons.</p>
            <div class="footer-links">
                <a href="../../../../de/privacy/">Datenschutz</a>
                <a href="../../../../de/terms/">Bedingungen</a>
                <a href="../../../../de/about/media/">Presse</a>
            </div>
        </div>
    </div>
</footer>


    
    
<div class="modal-overlay" id="poll">
    <div class="modal-content poll-modal-content">
        <a href="#" class="modal-close" aria-label="Schließen">
            <span aria-hidden="true">&times;</span>
        </a>

        <div class="modal-header">
            <h2>Community-Umfrage</h2>
            <p class="modal-subtitle">Wir würden uns freuen, von Ihnen zu hören</p>
        </div>

        <div class="modal-body">
            
            <iframe 
                id="poll-iframe"
                data-poll-id="2"
                data-api-url="https://feedback.i2p.net"
                frameborder="0"
                scrolling="no"
                style="width: 100%; border: none; min-height: 400px;">
            </iframe>
        </div>

        <div class="modal-footer">
            <p class="modal-disclaimer">
                Ihre Stimme hilft dabei, die Zukunft von I2P zu gestalten.
            </p>
        </div>
    </div>
</div>


<script>
(function() {
    const iframe = document.getElementById('poll-iframe');
    if (!iframe) return;
    
    const hostname = window.location.hostname;
    let apiUrl = 'https://feedback.i2p.net';
    const pollId = iframe.getAttribute('data-poll-id') || '1';

    
    if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
        apiUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
    }
    
    else if (hostname.endsWith('.onion')) {
        apiUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
    }

    
    const pollUrl = apiUrl + '/widgets/poll.html?poll_id=' + encodeURIComponent(pollId) + '&api_url=' + encodeURIComponent(apiUrl);
    iframe.src = pollUrl;
})();
</script>



    
    



    
    <script>
        (function () {
            'use strict';
            var hostname = window.location.hostname;
            var baseUrl;

            
            if (hostname.endsWith('.b32.i2p') || hostname.endsWith('.i2p')) {
                baseUrl = 'http://5kwyynf3eetgqa2nors6ctwo7doi7yu73k7uvypy5eqmm326zkiq.b32.i2p';
            } else if (hostname.endsWith('.onion')) {
                baseUrl = 'http://gfonxmohvarpmocsvllscsuszdu5rikipm6innvcwq4vpng7zzqmmfyd.onion';
            } else {
                baseUrl = 'https://feedback.i2p.net';
            }

            window.feedbackBaseUrl = baseUrl;

            
            document.querySelectorAll('[data-api-url]').forEach(function (widget) {
                widget.setAttribute('data-api-url', baseUrl);
            });

            
            document.write('<link rel="stylesheet" href="' + baseUrl + '/widgets/styles.css">');
            
        })();
    </script>

    

    
    
    

    

</body>

</html>